<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>loader demo</title>
<link rel="stylesheet" href="demo.css" type="text/css" media="all"/>

<script src="../../../build/kissy.js"></script>
<script src="../../../build/template/template-pkg.js"></script>
<script src="../../../build/ajax/ajax-pkg.js"></script>
<script src="../base.js"></script>
<script src="../loader.js"></script>
</head>

<body>
<h1 style="margin: 50px auto;text-align: center;">动态加载瀑布图效果</h1>

<div id="wrapper">
    <div id="article">
        <div id="ColumnContainer"> </div>
        <a id="BackToTop" href="#">Scroll to Top</a>
        <div id="loadingPins"><img src="http://d3io1k5o0zdpqr.cloudfront.net/images/BouncingLoader.gif" alt="Pin Loader Image"/><span>Fetching pins&hellip;</span></div>
    </div>
</div>
<script type="tpl" id="tpl">
    <div class="pin ks-waterfall" data-id="{{id}}">
        <a href="#" class="image">
            <img height="{{height}}" alt="{{title}}" src="http://farm{{farm}}.static.flickr.com/{{server}}/{{id}}_{{secret}}_m.jpg" />
        </a>
        <p class="description">{{title}}</p>
    </div>
</script>
<script>
    KISSY.use("waterfall", function(S) {
        var tpl = S.Template(S.one('#tpl').html()),
            nextpage = 1,
            waterfall = new S.Waterfall.Loader({
            container:"#ColumnContainer",
            load:function(success, end) {
                S.one('#loadingPins').show();
                S.ajax({
                    data:{
                        'method': 'flickr.photos.search',
                        'api_key': '5d93c2e473e39e9307e86d4a01381266',
                        'tags': 'rose',
                        'page': nextpage,
                        'per_page': 20,
                        'format': 'json'
                    },
                    url: 'http://api.flickr.com/services/rest/',
                    dataType: "jsonp",
                    jsonp: "jsoncallback",
                    success: function(d) {
                        // 如果数据错误, 则立即结束
                        if (d.stat !== 'ok') {
                            alert('load data error!');
                            end();
                            return;
                        }
                        // 如果到最后一页了, 也结束加载
                        nextpage = d.photos.page + 1;
                        if (nextpage > d.photos.pages) {
                            end();
                            return;
                        }
                        // 拼装每页数据
                        var items = [];
                        S.each(d.photos.photo, function(item) {
                            item.height = Math.round(Math.random()*(300 - 180) + 180); // fake height
                            items.push(new S.Node(tpl.render(item)));
                        });
                        success(items);
                    },
                    complete: function() {
                        S.one('#loadingPins').hide();
                    }
                });
            },
            minColCount:2,
            colWidth:228
        });
    });
</script>
</body>
</html>