/**
 * non-refresh upload file with form by iframe
 * @author: yiminghe@gmail.com
 */
KISSY.add("ajax/iframe-upload", function(S, DOM, Event, io) {

    var doc = document;
    // iframe 内的内容就是 body.innerText
    io.setupConfig({
            converters:{
                // iframe 到其他类型的转化和 text 一样
                iframe:io.getConfig().converters.text,
                text:{
                    iframe:function(text) {
                        return text;
                    }
                }}});

    function createIframe(xhr) {
        var id = S.guid("ajax-iframe");
        xhr.iframe = DOM.create("<iframe " +
            " id='" + id + "'" +
            // need name for target of form
            " name='" + id + "'" +
            " style='position:absolute;left:-9999px;top:-9999px;'/>");
        xhr.iframeId = id;
        DOM.prepend(xhr.iframe, doc.body || doc.documentElement);
    }

    function addDataToForm(data, form, serializeArray) {
        data = S.unparam(data);
        var ret = [];
        for (var d in data) {
            var vs = S.makeArray(data[d]);
            // 数组和原生一样对待，创建多个同名输入域
            for (var i = 0; i < vs.length; i++) {
                var e = doc.createElement("input");
                e.type = 'hidden';
                e.name = d + (serializeArray ? "[]" : "");
                e.value = vs[i];
                DOM.append(e, form);
                ret.push(e);
            }
        }
        return ret;
    }


    function removeFieldsFromData(fields) {
        DOM.remove(fields);
    }

    function IframeTransport(xhr) {
        this.xhr = xhr;
    }

    S.augment(IframeTransport, {
            send:function() {
                //debugger
                var xhr = this.xhr,
                    c = xhr.config,
                    fields,
                    form = DOM.get(c.form);

                this.attrs = {
                    target:DOM.attr(form, "target") || "",
                    action:DOM.attr(form, "action") || ""
                };
                this.form = form;

                createIframe(xhr);

                // set target to iframe to avoid main page refresh
                DOM.attr(form, {"target": xhr.iframeId,"action": c.url});

                if (c.data) {
                    fields = addDataToForm(c.data, form, c.serializeArray);
                }

                this.fields = fields;

                var iframe = xhr.iframe;

                Event.on(iframe, "load error", this._callback, this);

                form.submit();

            },

            _callback:function(event, abort) {
                //debugger
                var form = this.form,
                    xhr = this.xhr,
                    eventType = event.type,
                    iframe = xhr.iframe;

                DOM.attr(form, this.attrs);

                if (eventType == "load") {
                    var iframeDoc = iframe.contentWindow.document;
                    xhr.responseXML = iframeDoc;
                    xhr.responseText = DOM.text(iframeDoc.body);
                    xhr.callback(200, "success");
                } else if (eventType == 'error') {
                    xhr.callback(500, "error");
                }

                removeFieldsFromData(this.fields);
                Event.detach(iframe);
                DOM.remove(iframe);

                // nullify to prevent memory leak?
                xhr.iframe = null;
            },

            abort:function() {
                this._callback(0, 1);
            }
        });

    io.setupTransport("iframe", IframeTransport);

    return io;

}, {
        requires:["dom","event","./base"]
    });