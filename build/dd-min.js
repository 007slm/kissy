/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("dd/ddm",function(h,k,e,i,g){function f(){f.superclass.constructor.apply(this,arguments);this._init()}function n(a,c,m){m=m||150;if(m===-1)return function(){a.apply(c,arguments)};var q=h.now();return function(){var p=h.now();if(p-q>m){q=p;a.apply(c,arguments)}}}function b(a){var c=a.offset();return{left:c.left,right:c.left+a[0].offsetWidth,top:c.top,bottom:c.top+a[0].offsetHeight}}function d(a){if(a.top>=a.bottom||a.left>=a.right)return 0;return(a.right-a.left)*(a.bottom-a.top)}function j(a,
c){return{left:Math.max(a.left,c.left),right:Math.min(a.right,c.right),top:Math.max(a.top,c.top),bottom:Math.min(a.bottom,c.bottom)}}var l=document,t=h.require("node/node");f.ATTRS={prefixCls:{value:"ks-dd-"},bufferTime:{value:200},activeDrag:{},activeDrop:{},drops:{value:[]}};h.extend(f,g,{_regDrop:function(a){this.get("drops").push(a)},_unregDrop:function(a){a=h.indexOf(a,this.get("drops"));a!=-1&&this.get("drops").splice(a,1)},_init:function(){this._showShimMove=n(this._move,this,30)},_move:function(a){var c=
this.get("activeDrag");if(c){a.preventDefault();c._move(a);this._notifyDropsMove(a)}},_notifyDropsMove:function(a){var c=this.get("activeDrag"),m=c.get("mode"),q=this.get("drops"),p,v=0,u=b(c.get("node")),w=d(u);h.each(q,function(r){var o;if(m=="point"){var s=r.get("node");o=c.mousePos;s=b(s);if(s.left<=o.left&&s.right>=o.left&&s.top<=o.top&&s.bottom>=o.top){p=r;return false}}else if(m=="intersect"){o=d(j(u,b(r.get("node"))));if(o>v){v=o;p=r}}else if(m=="strict"){o=d(j(u,b(r.get("node"))));if(o==
w){p=r;return false}}});(q=this.get("activeDrop"))&&q!=p&&q._handleOut(a);if(p)p._handleOver(a);else{c.get("node").removeClass(this.get("prefixCls")+"drag-over");this.set("activeDrop",null)}},_deactivateDrops:function(){var a=this.get("activeDrag"),c=this.get("activeDrop");a.get("node").removeClass(this.get("prefixCls")+"drag-over");if(c){c.get("node").removeClass(this.get("prefixCls")+"drop-over");c.fire("drophit",{drag:a,drop:c});a.fire("dragdrophit",{drag:a,drop:c})}else a.fire("dragdropmiss",
{drag:a})},_start:function(a){var c=this,m=c.get("bufferTime")||0;c._registerEvent();if(m)c._bufferTimer=setTimeout(function(){c._bufferStart(a)},m);else c._bufferStart(a)},_bufferStart:function(a){this.set("activeDrag",a);a.get("shim")&&this._activeShim();a._start()},_end:function(a){var c=this.get("activeDrag");this._unregisterEvent();if(this._bufferTimer){clearTimeout(this._bufferTimer);this._bufferTimer=null}this._shim&&this._shim.css({display:"none"});if(c){c._end(a);this._deactivateDrops(a);
this.set("activeDrag",null);this.set("activeDrop",null)}},_activeShim:function(){var a=document;this._shim=(new t("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;cursor:move;z-index:999999;'></div>")).appendTo(a.body);this._shim.css("opacity",0);this._activeShim=this._showShim;this._showShim()},_showShim:function(){this._shim.css({display:"",height:k.docHeight()})},_registerEvent:function(){e.on(l,"mouseup",this._end,this);e.on(l,"mousemove",this._showShimMove,this)},_unregisterEvent:function(){e.remove(l,
"mousemove",this._showShimMove,this);e.remove(l,"mouseup",this._end,this)}});return new f},{requires:["dom","event","node","base"]});
KISSY.add("dd/draggable",function(h,k,e,i,g){function f(){f.superclass.constructor.apply(this,arguments);this._init()}var n=h.require("node/node");f.POINT="pointer";f.INTERSECT="intersect";f.STRICT="strict";f.ATTRS={node:{setter:function(b){return n.one(b)}},shim:{value:true},handlers:{value:[],setter:function(b){if(b)for(var d=0;d<b.length;d++){b[d]=n.one(b[d]);b[d].unselectable()}}},mode:{value:"point"}};h.extend(f,i,{_init:function(){var b=this.get("node"),d=this.get("handlers");if(d.length==0)d[0]=
b;for(var j=0;j<d.length;j++){var l=d[j],t=l.css("cursor");if(l[0]!=b[0])if(!t||t==="auto")l.css("cursor","move")}b.on("mousedown",this._handleMouseDown,this)},destroy:function(){for(var b=this.get("node"),d=this.get("handlers"),j=0;j<d.length;j++){var l=d[j];l.css("cursor")=="move"&&l.css("cursor","auto")}b.detach("mousedown",this._handleMouseDown,this);this.detach()},_check:function(b){for(var d=this.get("handlers"),j=0;j<d.length;j++){var l=d[j];if(l.contains(b)||l[0]==b[0])return true}return false},
_handleMouseDown:function(b){if(this._check(new n(b.target))){b.preventDefault();g._start(this);var d=this.get("node"),j=b.pageX;b=b.pageY;d=d.offset();this.startMousePos=this.mousePos={left:j,top:b};this.startNodePos=d;this._diff={left:j-d.left,top:b-d.top};this.set("diff",this._diff)}},_move:function(b){var d=this.get("diff"),j=b.pageX-d.left;d=b.pageY-d.top;this.mousePos={left:b.pageX,top:b.pageY};this.fire("drag",{left:j,top:d})},_end:function(){this.fire("dragend")},_start:function(){this.fire("dragstart")}});
return f},{requires:["ua","node","base","dd/ddm"]});
KISSY.add("dd/droppable",function(h,k,e,i){function g(){g.superclass.constructor.apply(this,arguments);this._init()}g.ATTRS={node:{setter:function(f){f=k.one(f);f.addClass(i.get("prefixCls")+"drop");return f}}};h.extend(g,e,{_init:function(){i._regDrop(this)},_handleOut:function(){var f=i.get("activeDrag");this.get("node").removeClass(i.get("prefixCls")+"drop-over");this.fire("dropexit",{drop:this,drag:f});f.get("node").removeClass(i.get("prefixCls")+"drag-over");f.fire("dragexit",{drop:this,drag:f})},
_handleOver:function(){var f=i.get("activeDrop");i.set("activeDrop",this);var n=i.get("activeDrag");this.get("node").addClass(i.get("prefixCls")+"drop-over");var b={drag:n,drop:this};if(this!=f){n.get("node").addClass(i.get("prefixCls")+"drag-over");n.fire("dragenter",b);this.fire("dropenter",b)}else{n.fire("dragover",b);this.fire("dropover",b)}},destroy:function(){i._unregDrop(this)}});return g},{requires:["node","base","dd/ddm"]});
KISSY.add("dd/proxy",function(h){function k(){k.superclass.constructor.apply(this,arguments)}k.ATTRS={node:{value:function(e){e=h.one(e.get("node")[0].cloneNode(true));e.attr("id",h.guid("ks-dd-proxy"));return e}}};h.extend(k,h.Base,{attach:function(e){var i=this;e.on("dragstart",function(){var g=i.get("node"),f=e.get("node");if(h.isFunction(g)){g=g(e);g.css("position","absolute");i.set("node",g);f.parent().append(g)}g.show();g.offset(f.offset());e.set("dragNode",f);e.set("node",g)});e.on("dragend",
function(){var g=i.get("node");e.get("dragNode").offset(g.offset());g.hide();e.set("node",e.get("dragNode"))})},destroy:function(){var e=this.get("node");e&&!h.isFunction(e)&&e.remove()}});return k});KISSY.add("dd",function(h,k,e,i,g){k={Draggable:e,Droppable:i,DDM:k,Proxy:g};h.mix(h,k);return k},{requires:["dd/ddm","dd/draggable","dd/droppable","dd/proxy"]});
