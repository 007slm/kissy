/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("dd/ddm",function(h,m,n,g,p){function e(){e.superclass.constructor.apply(this,arguments);this._init()}function k(a,c,j){j=j||150;if(j===-1)return function(){a.apply(c,arguments)};var q=h.now();return function(){var o=h.now();if(o-q>j){q=o;a.apply(c,arguments)}}}function b(a){var c=a.offset();return{left:c.left,right:c.left+a[0].offsetWidth,top:c.top,bottom:c.top+a[0].offsetHeight}}function d(a){if(a.top>=a.bottom||a.left>=a.right)return 0;return(a.right-a.left)*(a.bottom-a.top)}function f(a,
c){return{left:Math.max(a.left,c.left),right:Math.min(a.right,c.right),top:Math.max(a.top,c.top),bottom:Math.min(a.bottom,c.bottom)}}var i=document,t=h.require("node/node");e.ATTRS={prefixCls:{value:"ks-dd-"},bufferTime:{value:200},activeDrag:{},activeDrop:{},drops:{value:[]}};h.extend(e,p,{_regDrop:function(a){this.get("drops").push(a)},_unregDrop:function(a){a=h.indexOf(a,this.get("drops"));a!=-1&&this.get("drops").splice(a,1)},_init:function(){this._showShimMove=k(this._move,this,30)},_move:function(a){var c=
this.get("activeDrag");if(c){a.preventDefault();c._move(a);this._notifyDropsMove(a)}},_notifyDropsMove:function(a){var c=this.get("activeDrag"),j=c.get("mode"),q=this.get("drops"),o,v=0,u=b(c.get("node")),w=d(u);h.each(q,function(r){var l;if(j=="point"){var s=r.get("node");l=c.mousePos;s=b(s);if(s.left<=l.left&&s.right>=l.left&&s.top<=l.top&&s.bottom>=l.top){o=r;return false}}else if(j=="intersect"){l=d(f(u,b(r.get("node"))));if(l>v){v=l;o=r}}else if(j=="strict"){l=d(f(u,b(r.get("node"))));if(l==
w){o=r;return false}}});(q=this.get("activeDrop"))&&q!=o&&q._handleOut(a);o?o._handleOver(a):this.set("activeDrop",null)},_deactivateDrops:function(){var a=this.get("activeDrag"),c=this.get("activeDrop");a.get("node").removeClass(this.get("prefixCls")+"drag-over");if(c){c.get("node").removeClass(this.get("prefixCls")+"drop-over");c.fire("drophit",{drag:a,drop:c});a.fire("dragdrophit",{drag:a,drop:c})}else a.fire("dragdropmiss",{drag:a})},_start:function(a){var c=this,j=c.get("bufferTime")||0;c._registerEvent();
if(j)c._bufferTimer=setTimeout(function(){c._bufferStart(a)},j);else c._bufferStart(a)},_bufferStart:function(a){this.set("activeDrag",a);a.get("shim")&&this._activeShim();a._start()},_end:function(a){var c=this.get("activeDrag");this._unregisterEvent();if(this._bufferTimer){clearTimeout(this._bufferTimer);this._bufferTimer=null}this._shim&&this._shim.css({display:"none"});if(c){c._end(a);this._deactivateDrops(a);this.set("activeDrag",null);this.set("activeDrop",null)}},_activeShim:function(){var a=
document;this._shim=(new t("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;cursor:move;z-index:999999;'></div>")).appendTo(a.body);this._shim.css("opacity",0);this._activeShim=this._showShim;this._showShim()},_showShim:function(){this._shim.css({display:"",height:m.docHeight()})},_registerEvent:function(){n.on(i,"mouseup",this._end,this);n.on(i,"mousemove",this._showShimMove,this)},_unregisterEvent:function(){n.remove(i,"mousemove",this._showShimMove,this);n.remove(i,"mouseup",
this._end,this)}});return new e},{requires:["dom","event","node","base"]});
KISSY.add("dd/draggable",function(h,m,n,g,p){function e(){e.superclass.constructor.apply(this,arguments);this._init()}var k=h.require("node/node");e.POINT="pointer";e.INTERSECT="intersect";e.STRICT="strict";e.ATTRS={node:{setter:function(b){return k.one(b)}},shim:{value:true},handlers:{value:[],setter:function(b){if(b)for(var d=0;d<b.length;d++){b[d]=k.one(b[d]);b[d].unselectable()}}},mode:{value:"point"}};h.extend(e,g,{_init:function(){var b=this.get("node"),d=this.get("handlers");if(d.length==0)d[0]=
b;for(var f=0;f<d.length;f++){var i=d[f],t=i.css("cursor");if(i[0]!=b[0])if(!t||t==="auto")i.css("cursor","move")}b.on("mousedown",this._handleMouseDown,this)},destroy:function(){for(var b=this.get("node"),d=this.get("handlers"),f=0;f<d.length;f++){var i=d[f];i.css("cursor")=="move"&&i.css("cursor","auto")}b.detach("mousedown",this._handleMouseDown,this);this.detach()},_check:function(b){for(var d=this.get("handlers"),f=0;f<d.length;f++){var i=d[f];if(i.contains(b)||i[0]==b[0])return true}return false},
_handleMouseDown:function(b){if(this._check(new k(b.target))){b.preventDefault();p._start(this);var d=this.get("node"),f=b.pageX;b=b.pageY;d=d.offset();this.startMousePos=this.mousePos={left:f,top:b};this.startNodePos=d;this._diff={left:f-d.left,top:b-d.top};this.set("diff",this._diff)}},_move:function(b){var d=this.get("diff"),f=b.pageX-d.left;d=b.pageY-d.top;this.mousePos={left:b.pageX,top:b.pageY};this.fire("drag",{left:f,top:d})},_end:function(){this.fire("dragend")},_start:function(){this.fire("dragstart")}});
return e},{requires:["ua","node","base","dd/ddm"]});
KISSY.add("dd/droppable",function(h,m,n,g){function p(){p.superclass.constructor.apply(this,arguments);this._init()}p.ATTRS={node:{setter:function(e){e=m.one(e);e.addClass(g.get("prefixCls")+"drop");return e}}};h.extend(p,n,{_init:function(){g._regDrop(this)},_handleOut:function(){var e=g.get("activeDrag");this.get("node").removeClass(g.get("prefixCls")+"drop-over");this.fire("dropexit",{drop:this,drag:e});e.get("node").removeClass(g.get("prefixCls")+"drag-over");e.fire("dragexit",{drop:this,drag:e})},
_handleOver:function(){var e=g.get("activeDrop");g.set("activeDrop",this);var k=g.get("activeDrag");this.get("node").addClass(g.get("prefixCls")+"drop-over");var b={drag:k,drop:this};if(this!=e){k.get("node").addClass(g.get("prefixCls")+"drag-over");k.fire("dragenter",b);this.fire("dropenter",b)}else{k.fire("dragover",b);this.fire("dropover",b)}},destroy:function(){g._unregDrop(this)}});return p},{requires:["node","base","dd/ddm"]});
KISSY.add("dd",function(h,m,n,g){m={Draggable:n,Droppable:g,DDM:m};h.mix(h,m);return m},{requires:["dd/ddm","dd/draggable","dd/droppable"]});
