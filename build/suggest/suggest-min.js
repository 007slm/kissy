/*
Copyright 2010, KISSY UI Library v1.1.1dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("suggest",function(h,m){function j(a,b,d){if(!(this instanceof j))return new j(a,b,d);this.textInput=h.get(a);b+=b.indexOf("?")===-1?"?":"&";this.dataSource=b+"code=utf-8&callback="+s;this.config=h.merge(z,d);this.queryParams=this.query=k;this._dataCache={};this._init()}function t(a){a.style.visibility=k}function u(a){a.style.visibility=v}function w(a,b){if(b.nodeType===1){c.html(a,k);a.appendChild(b)}else c.html(a,b)}var c=h.DOM,i=h.Event,p=window,n=document,o,x=h.get("head"),q=h.UA.ie,
s="g_ks_suggest_callback",k="",v="hidden",y=parseInt,A=/input|button|a/i,z={containerCls:k,resultFormat:"%result%",closeBtnText:"\u5173\u95ed",shim:q===6,submitOnSelect:true};h.augment(j,h.EventTarget,{_init:function(){o=n.body;this._initTextInput();this._initContainer();this.config.shim&&this._initShim();this._initStyle();this._initEvent()},_initTextInput:function(){var a=this,b=a.textInput,d=false,g=0;c.attr(b,"autocomplete","off");a.config.autoFocus&&b.focus();i.on(b,"keydown",function(f){f=f.keyCode;
if(f===27){a.hide();b.value=a.query}else if(f>32&&f<41)if(b.value){if(f===40||f===38)if(g++===0){a._isRunning&&a.stop();d=true;a._selectItem(f===40)}else if(g==3)g=0}else b.blur();else if(f===13){b.blur();if(d)if(b.value==a._getSelectedItemKey())if(a.fire("itemSelect")===false)return;a._submitForm()}else{a._isRunning||a.start();d=false}});i.on(b,"keyup",function(){g=0});i.on(b,"blur",function(){a.stop();h.later(function(){a._focusing||a.hide()},0)})},_initContainer:function(){var a=c.create("<div>",
{"class":"ks-suggest-container "+this.config.containerCls,style:"position:absolute;visibility:hidden"}),b=c.create("<div>",{"class":"ks-suggest-content"}),d=c.create("<div>",{"class":"ks-suggest-footer"});a.appendChild(b);a.appendChild(d);o.insertBefore(a,o.firstChild);this.container=a;this.content=b;this.footer=d;this._initContainerEvent()},_setContainerRegion:function(){var a=this.textInput,b=c.offset(a),d=this.container;c.offset(d,{left:b.left,top:b.top+a.offsetHeight-1});c.width(d,this.config.containerWidth||
a.offsetWidth-2)},_initContainerEvent:function(){var a=this,b=a.textInput,d=a.container,g=a.content,f=a.footer,l,r;i.on(g,"mousemove",function(e){e=e.target;if(e.nodeName!=="LI")e=c.parent(e,"li");if(c.contains(g,e))if(e!==a.selectedItem){a._removeSelectedItem();a._setSelectedItem(e)}});i.on(g,"mousedown",function(e){e=e.target;if(e.nodeName!=="LI")e=c.parent(e,"li");l=e});i.on(d,"mousedown",function(e){if(!A.test(e.target.nodeName)){b.onbeforedeactivate=function(){p.event.returnValue=false;b.onbeforedeactivate=
null};e.preventDefault()}});i.on(g,"mouseup",function(e){e=e.target;if(e.nodeName!=="LI")e=c.parent(e,"li");if(e==l)if(c.contains(g,e)){a._updateInputFromSelectItem(e);if(a.fire("itemSelect")!==false){b.blur();a._submitForm()}}});i.on(f,"focusin",function(){a._focusing=true;a._removeSelectedItem();r=false});i.on(f,"focusout",function(){a._focusing=false;h.later(function(){if(r)a.hide();else a._focusing||a.textInput.focus()},0)});i.on(a.container,"mouseleave",function(){r=true});i.on(f,"click",function(e){c.hasClass(e.target,
"ks-suggest-closebtn")&&a.hide()})},_submitForm:function(){if(this.config.submitOnSelect){var a=this.textInput.form;if(a)if(this.fire("beforeSubmit",{form:a})!==false){if(n.createEvent){var b=n.createEvent("MouseEvents");b.initEvent("submit",true,false);a.dispatchEvent(b)}else n.createEventObject&&a.fireEvent("onsubmit");a.submit()}}},_initShim:function(){var a=c.create("<iframe>",{src:"about:blank","class":"ks-suggest-shim",style:"position:absolute;visibility:hidden;border:none"});this.container.shim=
a;o.insertBefore(a,o.firstChild)},_setShimRegion:function(){var a=this.container,b=a.style,d=a.shim;d&&c.css(d,{left:y(b.left)-2,top:b.top,width:y(b.width)+2,height:c.height(a)-2})},_initStyle:function(){h.get("#ks-suggest-style")||c.addStyleSheet(".ks-suggest-container{background:white;border:1px solid #999;z-index:99999}.ks-suggest-shim{z-index:99998}.ks-suggest-container li{color:#404040;padding:1px 0 2px;font-size:12px;line-height:18px;float:left;width:100%}.ks-suggest-container .ks-selected{background-color:#39F;cursor:default}.ks-suggest-key{float:left;text-align:left;padding-left:5px}.ks-suggest-result{float:right;text-align:right;padding-right:5px;color:green}.ks-suggest-container .ks-selected span{color:#FFF;cursor:default}.ks-suggest-footer{padding:0 5px 5px}.ks-suggest-closebtn{float:right}.ks-suggest-container li,.ks-suggest-footer{overflow:hidden;zoom:1;clear:both}.ks-suggest-container{*margin-left:2px;_margin-left:-2px;_margin-top:-3px}",
"ks-suggest-style")},_initEvent:function(){var a=this;i.on(p,"resize",function(){a._setContainerRegion();a._setShimRegion()})},start:function(){var a=this;if(a.fire("beforeStart")!==false){j.focusInstance=a;a._timer=h.later(function(){a._updateContent();a._timer=h.later(arguments.callee,200)},200);a._isRunning=true}},stop:function(){j.focusInstance=m;this._timer&&this._timer.cancel();this._isRunning=false},show:function(){if(!this.isVisible()){var a=this.container,b=a.shim;this._setContainerRegion();
t(a);if(b){this._setShimRegion();t(b)}}},hide:function(){if(this.isVisible()){var a=this.container,b=a.shim;b&&u(b);u(a)}},isVisible:function(){return this.container.style.visibility!=v},_updateContent:function(){var a=this.textInput;if(a.value!=this.query){a=this.query=a.value;if(h.trim(a))if(this._dataCache[a]!==m){this._fillContainer(this._dataCache[a]);this._displayContainer()}else this._requestData();else{this._fillContainer();this.hide()}}},_requestData:function(){var a=this,b;if(!q)a.dataScript=
m;if(!a.dataScript){b=n.createElement("script");b.charset="utf-8";b.async=true;x.insertBefore(b,x.firstChild);a.dataScript=b;if(!q){var d=h.now();a._latestScriptTime=d;c.attr(b,"data-time",d);i.on(b,"load",function(){a._scriptDataIsOut=c.attr(b,"data-time")!=a._latestScriptTime})}}a.queryParams="q="+encodeURIComponent(a.query);if(a.fire("beforeDataRequest")!==false)a.dataScript.src=a.dataSource+"&"+a.queryParams},_handleResponse:function(a){var b=k,d,g,f,l;if(!this._scriptDataIsOut){this.returnedData=
a;if(this.fire("dataReturn",{data:a})!==false){a=this._formatData(this.returnedData);if((d=a.length)>0){g=c.create("<ol>");for(b=0;b<d;++b){f=a[b];f=this._formatItem(l=f.key,f.result);c.attr(f,"key",l);c.addClass(f,b%2?"ks-even":"ks-odd");g.appendChild(f)}b=g}this._fillContainer(b);if(this.fire("beforeShow")!==false){this._dataCache[this.query]=c.html(this.content);this._displayContainer()}}}},_formatData:function(a){var b=[],d,g,f,l=0;if(!a)return b;if(h.isArray(a.result))a=a.result;if(!(d=a.length))return b;
for(f=0;f<d;++f){g=a[f];if(h.isString(g))b[l++]={key:g};else if(h.isArray(g)&&g.length>1)b[l++]={key:g[0],result:g[1]}}return b},_formatItem:function(a,b){var d=c.create("<li>"),g=c.create("<span>",{"class":"ks-suggest-key"});c.html(g,a);d.appendChild(g);if(b){a=this.config.resultFormat.replace("%result%",b);if(h.trim(a)){b=c.create("<span>",{"class":"ks-suggest-result"});c.html(b,a);d.appendChild(b)}}return d},_fillContainer:function(a,b){this._fillContent(a||k);this._fillFooter(b||k)},_fillContent:function(a){w(this.content,
a);this.selectedItem=m},_fillFooter:function(a){var b=this.config,d=this.footer;w(d,a);if(b.closeBtn){a=c.create("<a>",{"class":"ks-suggest-closebtn",href:"javascript: void(0)",target:"_self"});c.html(a,b.closeBtnText);d.appendChild(a)}this.fire("updateFooter",{footer:d,query:this.query});c.css(d,"display",c.text(d)?k:"none")},_displayContainer:function(){h.trim(c.text(this.container))?this.show():this.hide()},_selectItem:function(a){var b=h.query("li",this.container);if(b.length!==0)if(this.isVisible()){if(this.selectedItem){a=
c[a?"next":"prev"](this.selectedItem);if(!a)this.textInput.value=this.query}else a=b[a?0:b.length-1];this._removeSelectedItem();if(a){this._setSelectedItem(a);this._updateInputFromSelectItem()}}else this.show()},_removeSelectedItem:function(){c.removeClass(this.selectedItem,"ks-selected");this.selectedItem=m},_setSelectedItem:function(a){c.addClass(a,"ks-selected");this.selectedItem=a;this.textInput.focus()},_getSelectedItemKey:function(){if(!this.selectedItem)return k;return c.attr(this.selectedItem,
"key")},_updateInputFromSelectItem:function(){this.textInput.value=this._getSelectedItemKey(this.selectedItem)||this.query}});p[s]=function(a){j.focusInstance&&h.later(function(){j.focusInstance._handleResponse(a)},0)};j.version=1.1;h.Suggest=j});
