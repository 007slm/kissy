/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 7 15:13
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(e,h,i){h=i.Controller.extend({initializer:function(){this.__commands={};this.__dialogs={};this.__controls={}},use:function(d,j){var b=this,c=b.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"];e.isString(d)&&(d=d.split(","));for(var a=d.length-1;0<=a;a--)d[a]||d.splice(a,1);for(a=0;a<c.length;a++){var g=c[a];e.inArray(g,d)||d.unshift(g)}e.each(d,function(c,a){d[a]&&(d[a]="editor/plugin/"+c+"/")});e.use(d,function(){var c=e.makeArray(arguments);
c.shift();for(var a=0;a<c.length;a++)c[a]&&c[a].init(b);j&&j.call(b);b.adjustHeight()});b.__CORE_PLUGINS=[];return b}},{Config:{},XHTML_DTD:h.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(d){return this._setData(d)}},formatData:{getter:function(){return this._getData(1)},setter:function(d){return this._setData(d)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});h.HTML_PARSER={textarea:function(d){return d.one(this.get("prefixCls")+".editor-textarea")}};e.mix(h,e.EventTarget);return KISSY.Editor=h},{requires:["htmlparser","component","core"]});
KISSY.add("editor/plugin/clipboard/index",function(e){function h(f){this.editor=f;this._init()}function i(f){if(b.ie&&"BackCompat"!=f.get("document")[0].compatMode){var c=f.getSelection(),a;if(c.getType()==q.SELECTION_ELEMENT&&(a=c.getSelectedElement())){var g=c.getRanges()[0],l=j(f.get("document")[0].createTextNode(""));l.insertBefore(a);g.setStartBefore(l);g.setEndAfter(a);c.selectRanges([g]);setTimeout(function(){a.parent()&&(l.remove(),c.selectElement(a))},0)}}}var d=e.Editor,j=e.all,b=e.UA,c=
d.Range,a=d.RANGE,g=e.Event;e.augment(h,{_init:function(){var f=this.editor;g.on(f.get("document")[0].body,b.webkit?"paste":b.gecko?"paste":"beforepaste",this._paste,this);g.on(f.get("document")[0].body,"contextmenu",function(){l=1;setTimeout(function(){l=0},10)});f.addCommand("copy",new o("copy"));f.addCommand("cut",new o("cut"));f.addCommand("paste",new o("paste"))},_paste:function(){if(!l){var f=this.editor,g=f.get("document")[0];if(!g.getElementById("ke_pastebin")){var d=f.getSelection(),s=new c(g),
r=j(b.webkit?"<body></body>":"<div></div>",null,g);r.attr("id","ke_pastebin");b.webkit&&r[0].appendChild(g.createTextNode("\u00a0"));g.body.appendChild(r[0]);r.css({position:"absolute",top:d.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});r.css("left","-1000px");var t=d.createBookmarks();s.setStartAt(r,a.POSITION_AFTER_START);s.setEndAt(r,a.POSITION_BEFORE_END);s.select(!0);setTimeout(function(){r.remove();var c;r=b.webkit&&(c=r.first())&&c.hasClass("Apple-style-span")?
c:r;d.selectBookmarks(t);c=r.html();if(c=e.trim(c.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var a=f.fire("paste",{html:c,holder:r});void 0!==a&&(c=a);a=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(c)&&(a=f.htmlDataProcessor.wordFilter);f.insertHtml(c,a)}},0)}}}});var k=function(f,c){var a=f.get("document")[0],g=j(a.body),l=!1,d=function(){l=!0};g.on(c,d);(7<b.ie?a:a.selection.createRange()).execCommand(c);g.detach(c,d);return l},m=b.ie?function(f,c){return k(f,
c)}:function(f,c){try{return f.get("document")[0].execCommand(c)}catch(a){return!1}},n={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},o=function(f){this.type=f};o.prototype={exec:function(f){"cut"==this.type&&i(f);(f=m(f,this.type))||alert(n[this.type]);return f}};var q=d.Selection,f={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},l;d.on("contextmenu",function(c){c=c.contextmenu;if(!c.__copy_fix){c.__copy_fix=
1;var a=c.get("editor"),g={copy:1,cut:1,paste:1},l;for(l in g)g.hasOwnProperty(l)&&c.addChild({xclass:"menuitem",content:f[l],value:l});c.on("click",function(f){var c=f.target.get("value");g[c]&&(this.hide(),setTimeout(function(){a.execCommand(c)},30))})}});return{init:function(f){f.docReady(function(){new h(f)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(e,h,i){function d(f,a){var b=f[a?"next":"prev"](j,1);if(b&&b[0].nodeType==c.ELEMENT_NODE){for(var d=[];b.attr("_ke_bookmark")||b._4e_isEmptyInlineRemovable(j);)if(d.push(b),b=a?b.next(j,1):b.prev(j,1),!b)return;if(f._4e_isIdentical(b,j)){for(var k=new g(a?f[0].lastChild:f[0].firstChild);d.length;)d.shift()._4e_move(f,!a,j);b._4e_moveChildren(f,!a,j);b.remove();k[0]&&k[0].nodeType==c.ELEMENT_NODE&&k._4e_mergeSiblings()}}}var j=j,b=h.XHTML_DTD,c=e.DOM,a=e.UA,g=e.Node,
k={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};h.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var m=h.POSITION,n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},o={hr:1},q=function(f){return f&&(f[0]||f)};i.injectDom({_4e_sameLevel:function(f,c){var c=q(c),a=f.parentNode;return a&&a==c.parentNode},_4e_isBlockBoundary:function(f,a){var g=e.merge(o,a);return!(!n[c.css(f,"display")]&&!g[c.nodeName(f)])},_4e_index:function(f,c){for(var a=f.parentNode.childNodes,g,b=-1,s=0;s<a.length;s++)if(g=a[s],!c||!(3==g.nodeType&&g.previousSibling&&3==g.previousSibling.nodeType))if(b++,g===f)return b;return-1},_4e_move:function(f,c,a){c=
q(c);a?c.insertBefore(f,c.firstChild):c.appendChild(f)},_4e_isIdentical:function(f,a){if(!a)return!1;a=q(a);if(c.nodeName(f)!=c.nodeName(a))return!1;var g=f.attributes,b=a.attributes,d=g.length,s=b.length;if(d!=s)return!1;for(var r=0;r<d;r++){var k=g[r],e=k.name;if(k.specified&&c.attr(f,e)!=c.attr(a,e))return!1}if(8>i.ieEngine)for(r=0;r<s;r++)if(k=b[r],e=k.name,k.specified&&c.attr(f,e)!=c.attr(a,e))return!1;return!0},_4e_isEmptyInlineRemovable:function(f){if(!b.$removeEmpty[c.nodeName(f)])return!1;
for(var f=f.childNodes,a=0,g=f.length;a<g;a++){var d=f[a],k=d.nodeType;if(!(k==c.ELEMENT_NODE&&d.getAttribute("_ke_bookmark"))&&(k==c.ELEMENT_NODE&&!c._4e_isEmptyInlineRemovable(d)||k==c.TEXT_NODE&&e.trim(d.nodeValue)))return!1}return!0},_4e_moveChildren:function(f,c,a){c=q(c);if(f!=c)if(a)for(;a=f.lastChild;)c.insertBefore(f.removeChild(a),c.firstChild);else for(;a=f.firstChild;)c.appendChild(f.removeChild(a))},_4e_mergeSiblings:function(f){f=new g(f);k[f.nodeName()]&&(d(f,!0),d(f))},_4e_splitText:function(f,
g){var b=f.ownerDocument;if(f.nodeType==c.TEXT_NODE){if(a.ie&&g==f.nodeValue.length){var d=b.createTextNode("");c.insertAfter(d,f);return d}d=f.splitText(g);b.documentMode&&(b=b.createTextNode(""),c.insertAfter(b,d),c.remove(b));return d}},_4e_parents:function(f,c){var a=[];a.__IS_NODELIST=1;do a[c?"push":"unshift"](f);while(f=f.parentNode);return a},_4e_nextSourceNode:function(f,a,g,b){if(b&&!b.call)var d=q(b),b=function(f){return f!==d};var a=!a&&f.firstChild,s=f;if(!a){if(f.nodeType==c.ELEMENT_NODE&&
b&&!1===b(f,!0))return null;a=f.nextSibling}for(;!a&&(s=s.parentNode);){if(b&&!1===b(s,!0))return null;a=s.nextSibling}return!a||b&&!1===b(a)?null:g&&g!=a.nodeType?c._4e_nextSourceNode(a,!1,g,b):a},_4e_previousSourceNode:function(f,a,g,b){if(b&&!b.call)var d=q(b),b=function(f){return f!==d};var a=!a&&f.lastChild,s=f;if(!a){if(f.nodeType==c.ELEMENT_NODE&&b&&!1===b(f,!0))return null;a=f.previousSibling}for(;!a&&(s=s.parentNode);){if(b&&!1===b(s,!0))return null;a=s.previousSibling}return!a||b&&!1===
b(a)?null:g&&a.nodeType!=g?c._4e_previousSourceNode(a,!1,g,b):a},_4e_commonAncestor:function(f,a){a=q(a);if(f===a)return f;if(c.contains(a,f))return a;var b=f;do if(c.contains(b,a))return b;while(b=b.parentNode);return null},_4e_hasAttributes:9>i.ieEngine?function(f){for(var a=f.attributes,c=0;c<a.length;c++){var b=a[c];switch(b.name){case "class":if(f.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(f){a.gecko&&f.removeAttribute("_moz_dirty");return f.hasAttributes()},
_4e_position:function(f,a){var b=q(a);if(f.compareDocumentPosition)return f.compareDocumentPosition(b);if(f==b)return m.POSITION_IDENTICAL;if(f.nodeType==c.ELEMENT_NODE&&b.nodeType==c.ELEMENT_NODE){if(c.contains(f,b))return m.POSITION_CONTAINS+m.POSITION_PRECEDING;if(c.contains(b,f))return m.POSITION_IS_CONTAINED+m.POSITION_FOLLOWING;if("sourceIndex"in f)return 0>f.sourceIndex||0>b.sourceIndex?m.POSITION_DISCONNECTED:f.sourceIndex<b.sourceIndex?m.POSITION_PRECEDING:m.POSITION_FOLLOWING}for(var g=
c._4e_address(f),b=c._4e_address(b),d=Math.min(g.length,b.length),s=0;s<=d-1;s++)if(g[s]!=b[s])return g[s]<b[s]?m.POSITION_PRECEDING:m.POSITION_FOLLOWING;return g.length<b.length?m.POSITION_CONTAINS+m.POSITION_PRECEDING:m.POSITION_IS_CONTAINED+m.POSITION_FOLLOWING},_4e_address:function(f,a){for(var b=[],g=f.ownerDocument.documentElement,d=f;d&&d!=g;)b.unshift(c._4e_index(d,a)),d=d.parentNode;return b},_4e_remove:function(f,a){var c=f.parentNode;if(c){if(a)for(var b;b=f.firstChild;)c.insertBefore(f.removeChild(b),
f);c.removeChild(f)}return f},_4e_trim:function(f){c._4e_ltrim(f);c._4e_rtrim(f)},_4e_ltrim:function(f){for(var a;a=f.firstChild;){if(a.nodeType==c.TEXT_NODE){var b=i.ltrim(a.nodeValue),g=a.nodeValue.length;if(b)b.length<g&&(c._4e_splitText(a,g-b.length),f.removeChild(f.firstChild));else{f.removeChild(a);continue}}break}},_4e_rtrim:function(f){for(var b;b=f.lastChild;){if(b.type==c.TEXT_NODE){var g=i.rtrim(b.nodeValue),d=b.nodeValue.length;if(g)g.length<d&&(c._4e_splitText(b,g.length),f.removeChild(f.lastChild));
else{f.removeChild(b);continue}}break}!a.ie&&!a.opera&&(b=f.lastChild)&&1==b.nodeType&&"br"==c.nodeName(b)&&f.removeChild(b)},_4e_appendBogus:function(f){for(var b=f.lastChild;b&&b.nodeType==c.TEXT_NODE&&!e.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==c.TEXT_NODE||"br"!==c.nodeName(b))b=a.opera?f.ownerDocument.createTextNode(""):f.ownerDocument.createElement("br"),a.gecko&&b.setAttribute("type","_moz"),f.appendChild(b)},_4e_outerHtml:function(f){if(f.outerHTML)return f.outerHTML.replace(/<\?[^>]*>/,
"");var a=f.ownerDocument.createElement("div");a.appendChild(f.cloneNode(!0));return a.innerHTML},_4e_setMarker:function(f,a,b,c){var f=new g(f),d=f.data("list_marker_id")||f.data("list_marker_id",e.guid()).data("list_marker_id"),s=f.data("list_marker_names")||f.data("list_marker_names",{}).data("list_marker_names");a[d]=f;s[b]=1;return f.data(b,c)},_4e_clearMarkers:function(f,a,b){var f=new g(f),c=f.data("list_marker_names"),d=f.data("list_marker_id"),s;for(s in c)c.hasOwnProperty(s)&&f.removeData(s);
f.removeData("list_marker_names");b&&(f.removeData("list_marker_id"),delete a[d])},_4e_copyAttributes:function(f,b,d){for(var b=new g(b),k=f.attributes,d=d||{},e=0;e<k.length;e++){var s=k[e],r=s.name.toLowerCase(),t;if(!(r in d))if("checked"==r&&(t=c.attr(f,r)))b.attr(r,t);else if(s.specified||a.ie&&s.value&&"value"==r)t=c.attr(f,r),null===t&&(t=s.nodeValue),b.attr(r,t)}""!==f.style.cssText&&(b[0].style.cssText=f.style.cssText)},_4e_isEditable:function(f){f=c.nodeName(f);return(f=!b.$nonEditable[f]&&
(b[f]||b.span))&&f["#"]},_4e_getByAddress:function(f,a,b){for(var f=f.documentElement,c=0;f&&c<a.length;c++){var g=a[c];if(b)for(var d=-1,r=0;r<f.childNodes.length;r++){var k=f.childNodes[r];if(!(!0===b&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(d++,d==g)){f=k;break}}else f=f.childNodes[g]}return f}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(e){function h(a){1>arguments.length||(this.range=a,this.forceBrBreak=d,this.enlargeBr=i,this.enforceRealBlocks=d,this._||(this._={}))}var i=!0,d=!1,j=e.Editor,b=e.UA,c=j.Walker,a=j.Range,g=j.RANGE,k=j.ElementPath,m=e.Node,n=e.DOM,o=/^[\r\n\t ]*$/;e.augment(h,{getNextParagraph:function(j){var f,l,p,h,y;if(!this._.lastNode){l=this.range.clone();l.shrink(g.SHRINK_ELEMENT,i);l.enlarge(this.forceBrBreak||!this.enlargeBr?g.ENLARGE_LIST_ITEM_CONTENTS:g.ENLARGE_BLOCK_CONTENTS);
var s=new c(l),r=c.bookmark(i,i);s.evaluator=r;this._.nextNode=s.next();s=new c(l);s.evaluator=r;s=s.previous();this._.lastNode=s._4e_nextSourceNode(i);this._.lastNode&&this._.lastNode[0].nodeType==n.TEXT_NODE&&!e.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(r=new a(l.document),r.moveToPosition(this._.lastNode,g.POSITION_AFTER_END),r.checkEndOfBlock()&&(r=new k(r.endContainer),this._.lastNode=(r.block||r.blockLimit)._4e_nextSourceNode(i)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new m(l.document.createTextNode("")),n.insertAfter(this._.lastNode[0],s[0]));l=null}r=this._.nextNode;s=this._.lastNode;for(this._.nextNode=null;r;){var t=d,z=r[0].nodeType!=n.ELEMENT_NODE,x=d;if(z)r[0].nodeType==n.TEXT_NODE&&o.test(r[0].nodeValue)&&(z=d);else{var v=r.nodeName();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==v)z=i;else if(!l&&!r[0].childNodes.length&&"hr"!=v){f=r;p=r.equals(s);break}l&&(l.setEndAt(r,g.POSITION_BEFORE_START),"br"!=
v&&(this._.nextNode=r));t=i}else{if(r[0].firstChild){l||(l=new a(this.range.document),l.setStartAt(r,g.POSITION_BEFORE_START));r=new m(r[0].firstChild);continue}z=i}}z&&!l&&(l=new a(this.range.document),l.setStartAt(r,g.POSITION_BEFORE_START));p=(!t||z)&&r.equals(s);if(l&&!t)for(;!r[0].nextSibling&&!p;){v=r.parent();if(v._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){t=i;p||v.equals(s);break}r=v;z=i;p=r.equals(s);x=i}z&&l.setEndAt(r,g.POSITION_AFTER_END);r=r._4e_nextSourceNode(x,null,s);if((p=!r)||
t&&l)break}if(!f){if(!l)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;f=new k(l.startContainer);r=f.blockLimit;t={div:1,th:1,td:1};f=f.block;if((!f||!f[0])&&!this.enforceRealBlocks&&t[r.nodeName()]&&l.checkStartOfBlock()&&l.checkEndOfBlock())f=r;else if(!f||this.enforceRealBlocks&&"li"==f.nodeName())f=new m(this.range.document.createElement(j||"p")),f[0].appendChild(l.extractContents()),f._4e_trim(),l.insertNode(f),h=y=i;else if("li"!=f.nodeName()){if(!l.checkStartOfBlock()||
!l.checkEndOfBlock())f=f.clone(d),f[0].appendChild(l.extractContents()),f._4e_trim(),y=l.splitBlock(),h=!y.wasStartOfBlock,y=!y.wasEndOfBlock,l.insertNode(f)}else p||(this._.nextNode=f.equals(s)?null:l.getBoundaryNodes().endNode._4e_nextSourceNode(i,null,s))}h&&(l=new m(f[0].previousSibling),l[0]&&l[0].nodeType==n.ELEMENT_NODE&&("br"==l.nodeName()?l._4e_remove():l[0].lastChild&&"br"==n.nodeName(l[0].lastChild)&&n._4e_remove(l[0].lastChild)));y&&(l=c.bookmark(d,i),h=new m(f[0].lastChild),h[0]&&h[0].nodeType==
n.ELEMENT_NODE&&"br"==h.nodeName()&&(b.ie||h.prev(l,1)||h.next(l,1))&&h.remove());this._.nextNode||(this._.nextNode=p||f.equals(s)?null:f._4e_nextSourceNode(i,null,s));return f}});a.prototype.createIterator=function(){return new h(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(e){function h(g){for(var k=b,e=b,n=[];g;){if(g[0].nodeType==d.ELEMENT_NODE){this.lastElement||(this.lastElement=g);var h=g.nodeName();if(!e&&(!k&&c[h]&&(k=g),a[h])){var i;if(i=!k)if(i="div"==h){a:{i=g[0].childNodes;for(var f=0,l=i.length;f<l;f++){var p=i[f];if(p.nodeType==d.ELEMENT_NODE&&j.$block[p.nodeName.toLowerCase()]){i=!0;break a}}i=!1}i=!i}i?k=g:e=g}n.push(g);if("body"==h)break}g=g.parent()}this.block=k;this.blockLimit=e;this.elements=n}var i=e.Editor,
d=e.DOM,j=i.XHTML_DTD,b=null,c={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},a={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};h.prototype={compare:function(a){var b=this.elements,a=a&&a.elements;if(!a||b.length!=a.length)return!1;for(var c=0;c<b.length;c++)if(!d.equals(b[c],a[c]))return!1;return!0},contains:function(a){for(var c=this.elements,d=0;d<c.length;d++)if(c[d].nodeName()in a)return c[d];return b},toString:function(){var a=this.elements,
b,c=[];for(b=0;b<a.length;b++)c.push(a[b].nodeName());return c.toString()}};return i.ElementPath=h},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(e){function h(g){var d;d=g.getSelection().getRanges();for(var h=d.length-1;0<h;h--)d[h].deleteContents();d=d[0];h=d.document;if(d.checkStartOfBlock()&&d.checkEndOfBlock()){var f=(new m(d.startContainer)).block;if(f&&("li"==f.nodeName()||"li"==f.parent().nodeName()))return g.hasCommand("outdent")?(g.execCommand("save"),g.execCommand("outdent"),g.execCommand("save"),!0):!1}var l=d.splitBlock("p");if(!l)return!0;var g=l.previousBlock,f=l.nextBlock,p=
l.wasStartOfBlock,i=l.wasEndOfBlock,y;if(f)y=f.parent(),"li"==y.nodeName()&&(f._4e_breakParent(y),f._4e_move(f.next(),!0));else if(g&&(y=g.parent())&&"li"==y.nodeName())g._4e_breakParent(y),d.moveToElementEditablePosition(g.next()),g._4e_move(g.prev());if(!p&&!i){if("li"==f.nodeName()&&(y=f.first(k.invisible(!0)))&&e.inArray(y.nodeName(),["ul","ol"]))(j.ie?new a(h.createTextNode("\u00a0")):new a(h.createElement("br"))).insertBefore(y);f&&d.moveToElementEditablePosition(f)}else{var s;if(g){if("li"==g.nodeName()||
!b.test(g.nodeName()))s=g.clone()}else f&&(s=f.clone());s||(s=new a("<p>",null,h));if(y=l.elementPath)for(var l=0,r=y.elements.length;l<r;l++){var t=y.elements[l];if(t.equals(y.block)||t.equals(y.blockLimit))break;c.$removeEmpty[t.nodeName()]&&(t=t.clone(),s._4e_moveChildren(t),s.append(t))}j.ie||s._4e_appendBogus();d.insertNode(s);if(j.ie&&p&&(!i||!g[0].childNodes.length))d.moveToElementEditablePosition(i?g:s),d.select();d.moveToElementEditablePosition(p&&!i?f:s)}j.ie||(f?(s=new a(h.createElement("span")),
s.html("&nbsp;"),d.insertNode(s),s.scrollIntoView(void 0,!1),d.deleteContents()):s.scrollIntoView(void 0,!1));d.select();return!0}function i(a){var b=a.get("document")[0];g.on(b,"keydown",function(b){if(13===b.keyCode&&!b.shiftKey&&!b.ctrlKey&&!b.metaKey){a.execCommand("save");var f=a.execCommand("enterBlock");a.execCommand("save");!1!==f&&b.preventDefault()}})}var d=e.Editor,j=e.UA,b=/^h[1-6]$/,c=d.XHTML_DTD,a=e.Node,g=e.Event,k=d.Walker,m=d.ElementPath;return{init:function(a){a.addCommand("enterBlock",
{exec:h});a.docReady(function(){i(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(e){function h(){var b=this;b.__iframeFocus=k;g=b;a&&clearTimeout(a);a=setTimeout(function(){b.fire("focus")},100)}function i(){var b=this;b.__iframeFocus=m;g=n;a&&clearTimeout(a);a=setTimeout(function(){b.fire("blur")},100)}var d=e.Editor,j=e.DOM,b=e.Event,c={},a,g,e={refreshAll:function(){for(var a in c)if(c.hasOwnProperty(a)){var b=c[a].get("document")[0];b.designMode="off";b.designMode="on"}},currentInstance:function(){return g},getInstance:function(a){return c[a]},
add:function(a){var c=j._getWin(a.get("document")[0]);b.on(c,"focus",h,a);b.on(c,"blur",i,a)},register:function(a){c[a._UUID]=a},remove:function(a){delete c[a._UUID];var g=j._getWin(a.get("document")[0]);b.remove(g,"focus",h,a);b.remove(g,"blur",i,a)}},k=!0,m=!1,n=null;e.refreshAll=e.refreshAll;d.focusManager=e;d.getInstances=function(){return c};return e},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(e){return{init:function(h){function i(a){return a.replace(q,function(a,b,c){return"<"+b+c.replace(f,function(a,b){return-1==c.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function d(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+l+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function j(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,b){return decodeURIComponent(b)})}
var b=b,c=e.Editor,a=e.Node,g=e.UA,k=e.require("htmlparser"),m=new k.Filter,n=new k.Filter,o=new k.Filter;(function(){var a=function(a,b){return function(f,c){var g=[];(""+f).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(f,d,C){d=d.toLowerCase();"font-family"==d&&(C=C.replace(/["']/g,""));for(var k,e,j,t=0;t<a.length;t++)if(a[t]&&(f=a[t][0],k=a[t][1],e=a[t][2],j=a[t][3],d.match(f)&&(!k||C.match(k)))){d=j||d;b&&(e=e||C);"function"==typeof e&&(e=e(C,c,d));e&&e.push&&
(d=e[0],e=e[1]);"string"==typeof e&&g.push([d,e]);return}!b&&g.push([d,C])});for(var d=0;d<g.length;d++)g[d]=g[d].join(":");return g.length?g.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],b),f={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var b=a.nodeName||"";if(-1!=b.indexOf(":")&&
!/^ke/.test(b))if("v:imagedata"==b){if(b=a.getAttribute("o:href"))a.setAttribute("src",b),a.removeAttribute("o:href");if(b=a.getAttribute("o:title"))a.setAttribute("title",b),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(b){b=a(b);return!b?!1:b}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},c={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],f,c=0;c<b.length;c++)f="_ke_saved_"+b[c],a.getAttribute(f)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var f=b.getAttribute("width"),b=b.getAttribute("height");f&&a.setAttribute("width",f);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!e.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,l.length)==l?(a="{C}"==a.substr(l.length,3)?a.substr(l.length+3):a.substr(l.length),new k.CData(decodeURIComponent(a))):a}};g.ie&&(c.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});m.addRules(c);n.addRules(f);o.addRules(f)})();(function(){function a(b){for(var b=b.childNodes,f=b.length,c=b[f-1];c&&3==c.nodeType&&!e.trim(c.nodeValue);)c=b[--f];return c}
function b(f,c){var d=a(f);d&&((c||!g.ie)&&1==d.nodeType&&"br"==d.nodeName?f.removeChild(d):3==d.nodeType&&j.test(d.nodeValue)&&f.removeChild(d))}function f(b){var c=a(b);return!c||1==c.nodeType&&"br"==c.nodeName||"form"==b.nodeName&&"input"==c.nodeName}function d(a){b(a,!0);f(a)&&(g.ie?a.appendChild(new k.Text("\u00a0")):(a.appendChild(new k.Text("&nbsp;")),a.appendChild(new k.Tag("br"))))}function r(a){b(a,!1);f(a)&&a.appendChild(new k.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,h=c.XHTML_DTD,l=e.merge(h.$block,
h.$listItem,h.$tableContent),i;for(i in l)l.hasOwnProperty(i)&&("br"in h[i]||delete l[i]);delete l.td;delete l.pre;var h={tags:{}},u={tags:{}};for(i in l)l.hasOwnProperty(i)&&(h.tags[i]=d,u.tags[i]=r);n.addRules(h);m.addRules(u);o.addRules(h)})();(function(){m.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var q=/<(a|area|img|input)\b([^>]*)>/gi,f=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,l="{ke_protected}";h.htmlDataProcessor={wordFilter:o,dataFilter:n,
htmlFilter:m,toHtml:function(a){var b=new k.BeautifyWriter;(new k.Parser(a)).parse().writeHtml(b,m);return b.getHtml()},toDataFormat:function(b,f,c){c=c||n;g.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=i(b);f=new a("<div>");f.html("a"+b);b=f.html().substr(1);b=j(b);f=new k.BeautifyWriter;(new k.Parser(b)).parse().writeHtml(f,c);b=f.getHtml();return b=d(b)},toServer:function(a){var b=new k.MinifyWriter;(new k.Parser(a)).parse().writeHtml(b,m);return b.getHtml()}}}}},
{requires:["editor"]});
KISSY.add("editor/core/meta",function(){var e={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../select/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubbleview/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubbleview/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["dd"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui","./cmd"],undo:["./btn",
"./cmd"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},h,i,d={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../select/"],"flashCommon/baseClass":["../contextmenu/","../bubbleview/","../dialogLoader/","./utils"],"font/ui":["../button/",
"../select/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../select/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],"link/dialog":["../overlay/","./utils"],"listUtils/btn":["../button/"],
"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../select/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../select/"],"xiamiMusic/dialog":["../flash/dialog","../select/"]},j={};for(h in e)i="editor/plugin/"+h+"/index",j[i]={requires:e[h]};for(h in d)i="editor/plugin/"+
h,j[i]={requires:d[h]};KISSY.add(j)});
KISSY.add("editor/core/range",function(e,h,i,d,j){function b(a){var b=a.nodeType!=p.TEXT_NODE&&p.nodeName(a)in y.$removeEmpty,f=a.nodeType==p.TEXT_NODE&&!e.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||f||a}function c(a){return!z(a)&&!x(a)}function a(a){var b=o;return function(f){if(x(f))return n;if(f.nodeType==p.TEXT_NODE){if(e.trim(f.nodeValue).length)return o}else if(f.nodeType==p.ELEMENT_NODE&&(f=p.nodeName(f),!B[f]))if(!a&&!w.ie&&"br"==f&&!b)b=n;else return o;return n}}
function g(a,b){var f=a.startContainer,c=a.endContainer,g=a.startOffset,d=a.endOffset,e,k=o,j=o,r=void 0,t=a.document,h;if(a.collapsed)return r;0<b&&(r=t.createDocumentFragment());a.optimizeBookmark();c[0].nodeType==p.TEXT_NODE?(j=n,c=c._4e_splitText(d)):0<c[0].childNodes.length&&(d>=c[0].childNodes.length?(c=new s(c[0].appendChild(t.createTextNode(""))),h=n):c=new s(c[0].childNodes[d]));f[0].nodeType==p.TEXT_NODE?(k=n,f._4e_splitText(g)):g?g>=f[0].childNodes.length?(f=new s(f[0].appendChild(t.createTextNode(""))),
e=n):f=new s(f[0].childNodes[g].previousSibling):(e=new s(t.createTextNode("")),f.prepend(e),f=e,e=n);var l=f._4e_parents(),m=c._4e_parents();l.each(function(a,b){l[b]=a});m.each(function(a,b){m[b]=a});for(var i,y,t=0;t<l.length&&!(i=l[t],y=m[t],!i.equals(y));t++);for(var g=r,u,z,B=t;B<l.length;B++){u=l[B];d=0<b&&!u.equals(f)?g.appendChild(u.clone()[0]):null;u=u[0].nextSibling;z=m[B];for(var x=c[0],q=z&&z[0];u&&!(q==u||x==u);)z=u.nextSibling,2==b?g.appendChild(u.cloneNode(n)):(p._4e_remove(u),1==
b&&g.appendChild(u)),u=z;d&&(g=d)}for(g=r;t<m.length;t++){u=m[t];d=0<b&&!u.equals(c)?g.appendChild(u.clone()[0]):null;if(!l[t]||!u._4e_sameLevel(l[t]))for(u=u[0].previousSibling;u;)z=u.previousSibling,2==b?g.insertBefore(u.cloneNode(n),g.firstChild):(p._4e_remove(u),1==b&&g.insertBefore(u,g.firstChild)),u=z;d&&(g=d)}if(2==b){if(k&&(i=f[0],i.nodeType==p.TEXT_NODE&&i.nextSibling&&i.nextSibling.nodeType==p.TEXT_NODE&&(i.data+=i.nextSibling.data,i.parentNode.removeChild(i.nextSibling))),j)j=c[0],j.nodeType==
p.TEXT_NODE&&j.previousSibling&&j.previousSibling.nodeType==p.TEXT_NODE&&(j.previousSibling.data+=j.data,j.parentNode.removeChild(j))}else{if(i&&y&&(!f._4e_sameLevel(i)||!c._4e_sameLevel(y)))j=i._4e_index(),e&&i._4e_sameLevel(f)&&j--,a.setStart(i.parent(),j+1);a.collapse(n)}e&&f.remove();h&&c.remove();return r}function k(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function m(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=q;this.collapsed=n;this.document=a}h.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,o=!1,q=null,f=h.RANGE,l=h.POSITION,p=e.DOM,w=e.UA,y=h.XHTML_DTD,s=e.Node,r=s.all,t={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},z=new d.whitespaces,x=new d.bookmark,v=d.whitespaces(n),u=d.bookmark(!1,
!0),B={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};e.augment(m,{toString:function(){var a=[],b=this.startContainer[0],f=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((f.id||f.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=p.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=p.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==p.ELEMENT_NODE&&t[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);k(this)},setEnd:function(a,b){a[0].nodeType==p.ELEMENT_NODE&&t[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);k(this)},setStartAt:function(a,b){switch(b){case f.POSITION_AFTER_START:this.setStart(a,0);break;case f.POSITION_BEFORE_END:a[0].nodeType==p.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setStartBefore(a);break;case f.POSITION_AFTER_END:this.setStartAfter(a)}k(this)},setEndAt:function(a,b){switch(b){case f.POSITION_AFTER_START:this.setEnd(a,0);break;
case f.POSITION_BEFORE_END:a[0].nodeType==p.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case f.POSITION_BEFORE_START:this.setEndBefore(a);break;case f.POSITION_AFTER_END:this.setEndAfter(a)}k(this)},cloneContents:function(){return g(this,2)},deleteContents:function(){return g(this,0)},extractContents:function(){return g(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new m(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=p.ELEMENT_NODE||a.endContainer[0].nodeType!=p.ELEMENT_NODE)return q;var b=new d(a);b.evaluator=function(a){return v(a)&&u(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:q},shrink:function(a,b){if(!this.collapsed){var a=a||f.SHRINK_TEXT,c=this.clone(),g=this.startContainer,e=this.endContainer,k=this.startOffset,j=this.endOffset,r=n,t,h,s=n;g&&g[0].nodeType==p.TEXT_NODE&&(k?k>=g[0].nodeValue.length?c.setStartAfter(g):(c.setStartBefore(g),r=o):c.setStartBefore(g));e&&e[0].nodeType==p.TEXT_NODE&&(j?j>=e[0].nodeValue.length?c.setEndAfter(e):(c.setEndAfter(e),s=o):c.setEndBefore(e));if(r||s)h=new d(c),h.evaluator=function(b){return b.nodeType==
(a==f.SHRINK_ELEMENT?p.ELEMENT_NODE:p.TEXT_NODE)},h.guard=function(b,c){if(a==f.SHRINK_ELEMENT&&b.nodeType==p.TEXT_NODE||c&&b==t)return o;!c&&b.nodeType==p.ELEMENT_NODE&&(t=b);return n};r&&(c=h[a==f.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(c,b?f.POSITION_AFTER_START:f.POSITION_BEFORE_START);s&&(h.reset(),(h=h[a==f.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(h,b?f.POSITION_BEFORE_END:f.POSITION_AFTER_END));return r||s}},createBookmark2:function(a){var b=this.startContainer,
f=this.endContainer,c=this.startOffset,g=this.endOffset,d,e;if(!b||!f)return{start:0,end:0};if(a){if(b[0].nodeType==p.ELEMENT_NODE&&(d=new s(b[0].childNodes[c]))&&d[0]&&d[0].nodeType==p.TEXT_NODE&&0<c&&d[0].previousSibling.nodeType==p.TEXT_NODE)b=d,c=0;for(;b[0].nodeType==p.TEXT_NODE&&(e=b.prev(void 0,1))&&e[0].nodeType==p.TEXT_NODE;)b=e,c+=e[0].nodeValue.length;if(!this.collapsed){if(f[0].nodeType==p.ELEMENT_NODE&&(d=new s(f[0].childNodes[g]))&&d[0]&&d[0].nodeType==p.TEXT_NODE&&0<g&&d[0].previousSibling.nodeType==
p.TEXT_NODE)f=d,g=0;for(;f[0].nodeType==p.TEXT_NODE&&(e=f.prev(void 0,1))&&e[0].nodeType==p.TEXT_NODE;)f=e,g+=e[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?q:f._4e_address(a),startOffset:c,endOffset:g,normalized:a,is2:n}},createBookmark:function(a){var b,c,g,d,k=this.collapsed;b=new s("<span>",q,this.document);b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");a&&(g=e.guid("ke_bm_"),b.attr("id",g+"S"));k||(c=b.clone(),c.html("&nbsp;"),a&&c.attr("id",g+"E"),
d=this.clone(),d.collapse(),d.insertNode(c));d=this.clone();d.collapse(n);d.insertNode(b);c?(this.setStartAfter(b),this.setEndBefore(c)):this.moveToPosition(b,f.POSITION_AFTER_END);return{startNode:a?g+"S":b,endNode:a?g+"E":c,serializable:a,collapsed:k}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,b){var f=this.startContainer,c=this.startOffset,g=this.collapsed;if((!a||g)&&f[0]&&f[0].nodeType==p.TEXT_NODE){if(c)if(c>=f[0].nodeValue.length)c=f._4e_index()+1,
f=f.parent();else{var d=f._4e_splitText(c),c=f._4e_index()+1,f=f.parent();p.equals(this.startContainer,this.endContainer)?this.setEnd(d,this.endOffset-this.startOffset):p.equals(f,this.endContainer)&&(this.endOffset+=1)}else c=f._4e_index(),f=f.parent();this.setStart(f,c);if(g){this.collapse(n);return}}f=this.endContainer;c=this.endOffset;!b&&!g&&f[0]&&f[0].nodeType==p.TEXT_NODE&&(c?(c>=f[0].nodeValue.length||f._4e_splitText(c),c=f._4e_index()+1):c=f._4e_index(),f=f.parent(),this.setEnd(f,c))},insertNode:function(a){this.optimizeBookmark();
this.trim(o,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=r(this.document);if(a.is2){var f=b._4e_getByAddress(a.start,a.normalized),c=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(f,c);b?this.setEnd(b,a):this.collapse(n)}else f=(c=a.serializable)?e.one("#"+a.startNode,b):a.startNode,a=c?e.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(f),f._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,b){var f=this.startContainer,c=this.endContainer,f=f[0]==c[0]?a&&f[0].nodeType==p.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new s(f[0].childNodes[this.startOffset]):f:f._4e_commonAncestor(c);return b&&f[0].nodeType==p.TEXT_NODE?f.parent():f},enlarge:function(){function a(b,f,c,g){var d=b[f?"startContainer":"endContainer"],e,k=f?0:1,j=0,t=f?"previousSibling":
"nextSibling";e=b[f?"startOffset":"endOffset"];if(d[0].nodeType==p.TEXT_NODE){if(f){if(e)return}else if(e<d[0].nodeValue.length)return;e=d[0][t];d=d[0].parentNode}else e=d[0].childNodes[e+(f?-1:1)]||null,d=d[0];for(;d;){for(;e;)if(z(e)||x(e))e=e[t];else break;if(e){if(!j)b[f?"setStartAfter":"setEndBefore"](r(e));break}d=r(d);if("body"==d.nodeName())break;if(j||d.equals(g))c[k]=d,j=1;else b[f?"setStartBefore":"setEndAfter"](d);e=d[0][t];d=d[0].parentNode}}return function(b){switch(b){case f.ENLARGE_ELEMENT:if(this.collapsed)break;
var b=this.getCommonAncestor(),c=[];a(this,1,c,b);a(this,0,c,b);c[0]&&c[1]&&(b=c[0].contains(c[1])?c[1]:c[0],this.setStartBefore(b),this.setEndAfter(b));break;case f.ENLARGE_BLOCK_CONTENTS:case f.ENLARGE_LIST_ITEM_CONTENTS:var g=new m(this.document),c=new s(this.document.body);g.setStartAt(c,f.POSITION_AFTER_START);g.setEnd(this.startContainer,this.startOffset);var g=new d(g),e,k,j=d.blockBoundary(b==f.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:q),t=function(a){var b=j(a);b||(e=r(a));return b},h=function(a){var b=
t(a);!b&&"br"==p.nodeName(a)&&(k=r(a));return b};g.guard=t;g=g.lastBackward();e=e||c;this.setStartAt(e,"br"!=e.nodeName()&&(!g&&this.checkStartOfBlock()||g&&e.contains(g))?f.POSITION_AFTER_START:f.POSITION_AFTER_END);g=this.clone();g.collapse();g.setEndAt(c,f.POSITION_BEFORE_END);g=new d(g);g.guard=b==f.ENLARGE_LIST_ITEM_CONTENTS?h:t;e=q;g=g.lastForward();e=e||c;this.setEndAt(e,!g&&this.checkEndOfBlock()||g&&e.contains(g)?f.POSITION_BEFORE_END:f.POSITION_BEFORE_START);k&&this.setEndAfter(k)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,c=this.startOffset;if(c&&b[0].nodeType==p.TEXT_NODE&&e.trim(b[0].nodeValue.substring(0,c)).length)return o;this.trim();b=new j(this.startContainer);c=this.clone();c.collapse(n);c.setStartAt(b.block||b.blockLimit,f.POSITION_AFTER_START);b=new d(c);b.evaluator=a(n);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,c=this.endOffset;if(b[0].nodeType==p.TEXT_NODE&&e.trim(b[0].nodeValue.substring(c)).length)return o;this.trim();
b=new j(this.endContainer);c=this.clone();c.collapse(o);c.setEndAt(b.block||b.blockLimit,f.POSITION_BEFORE_END);b=new d(c);b.evaluator=a(o);return b.checkForward()},checkBoundaryOfElement:function(a,c){var g=this.clone();g[c==f.START?"setStartAt":"setEndAt"](a,c==f.START?f.POSITION_AFTER_START:f.POSITION_BEFORE_END);g=new d(g);g.evaluator=b;return g[c==f.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,f=this.startOffset,c=this.endOffset,
g;if(a[0].nodeType==p.ELEMENT_NODE)if(g=a[0].childNodes.length,g>f)a=r(a[0].childNodes[f]);else if(0==g)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=r(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==p.ELEMENT_NODE)if(g=b[0].childNodes.length,g>c)b=r(b[0].childNodes[c])._4e_previousSourceNode(n);else if(0==g)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=r(b)}a._4e_position(b)&l.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,
b){var c=this.createBookmark(),g=r(this.document.createElement(b));this.collapse(a);this.enlarge(f.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();w.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(c);return g},splitBlock:function(a){var b=new j(this.startContainer),c=new j(this.endContainer),g=b.block,d=c.block,k=q;if(!b.blockLimit.equals(c.blockLimit))return q;"br"!=a&&(g||(g=this.fixBlock(n,a),d=(new j(this.endContainer)).block),d||(d=this.fixBlock(o,
a)));a=g&&this.checkStartOfBlock();b=d&&this.checkEndOfBlock();this.deleteContents();g&&g[0]==d[0]&&(b?(k=new j(this.startContainer),this.moveToPosition(d,f.POSITION_AFTER_END),d=q):a?(k=new j(this.startContainer),this.moveToPosition(g,f.POSITION_BEFORE_START),g=q):(d=this.splitElement(g),!w.ie&&!e.inArray(g.nodeName(),["ul","ol"])&&g._4e_appendBogus()));return{previousBlock:g,nextBlock:d,wasStartOfBlock:a,wasEndOfBlock:b,elementPath:k}},splitElement:function(a){if(!this.collapsed)return q;this.setEndAt(a,
f.POSITION_BEFORE_END);var b=this.extractContents(),c=a.clone(o);c[0].appendChild(b);c.insertAfter(a);this.moveToPosition(a,f.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(a,b){for(var g=0;a;){if(a[0].nodeType==p.TEXT_NODE){this.moveToPosition(a,b?f.POSITION_AFTER_END:f.POSITION_BEFORE_START);g=1;break}a[0].nodeType==p.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?f.POSITION_BEFORE_END:f.POSITION_AFTER_START),g=1);var d=a,e=g,k=void 0;d[0].nodeType==p.ELEMENT_NODE&&
d._4e_isEditable()&&(k=d[b?"last":"first"](c,1));!e&&!k&&(k=d[b?"prev":"next"](c,1));a=k}return!!g},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==p.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,c,f,g=a.nodeName();b=y.$block[g];this.deleteContents();if(b){for(b=this.getCommonAncestor(o,n);(c=y[b.nodeName()])&&(!c||!c[g]);){var d=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(n),
b.remove()):f=b;b=d}f&&this.splitElement(f)}this.insertNode(a)}});i.injectDom({_4e_breakParent:function(a,b){var b=r(b),a=r(a),c,f=new h.Range(a[0].ownerDocument);f.setStartAfter(a);f.setEndAfter(b);c=f.extractContents();f.insertNode(a.remove());a.after(c)}});h.Range=m},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(e){function h(a){this.document=a;this._={cache:{}};if(n){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=j}}function i(a){a=new h(a);return!a||a.isInvalid?b:a}var d=e.Editor;d.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var j=!0,b=null,c=e.UA,a=e.DOM,g=e.Node,k=d.SELECTION,m=d.RANGE,n=c.ie,o=d.Walker,q=d.Range,f={img:1,hr:1,li:1,table:1,
tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};e.augment(h,{getNative:!n?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=a._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var b=this._.cache;if(b.type)return b.type;var c=k.SELECTION_TEXT,g=this.getNative();if(g){if(1==g.rangeCount){var g=g.getRangeAt(0),d=g.startContainer;
d==g.endContainer&&d.nodeType==a.ELEMENT_NODE&&1==Number(g.endOffset-g.startOffset)&&f[d.childNodes[g.startOffset].nodeName.toLowerCase()]&&(c=k.SELECTION_ELEMENT)}}else c=k.SELECTION_NONE;return b.type=c}:function(){var a=this._.cache;if(a.type)return a.type;var b=k.SELECTION_NONE;try{var c=this.getNative(),f=c.type;"Text"==f&&(b=k.SELECTION_TEXT);"Control"==f&&(b=k.SELECTION_ELEMENT);c.createRange().parentElement&&(b=k.SELECTION_TEXT)}catch(g){}return a.type=b},getRanges:n?function(){var c=function(c,
f){c=c.duplicate();c.collapse(f);for(var g=c.parentElement(),d=g.childNodes,e,k=0;k<d.length;k++){var j=d[k];if(j.nodeType==a.ELEMENT_NODE){e=c.duplicate();e.moveToElementText(j);var j=e.compareEndPoints("StartToStart",c),h=e.compareEndPoints("EndToStart",c);e.collapse();if(0<j)break;else{if(!j||1==h&&-1==j)return{container:g,offset:k};if(!h)return{container:g,offset:k+1}}e=b}}e||(e=c.duplicate(),e.moveToElementText(g),e.collapse(!1));e.setEndPoint("StartToStart",c);e=(""+e.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<e;)e-=d[--k].nodeValue.length}catch(l){e=0}return 0===e?{container:g,offset:k}:{container:d[k],offset:-e}};return function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var f=this.getNative(),a=f&&f.createRange(),d=this.getType();if(!f)return[];if(d==k.SELECTION_TEXT)return f=new q(this.document),d=c(a,j),f.setStart(new g(d.container),d.offset),d=c(a),f.setEnd(new g(d.container),d.offset),b.ranges=[f];if(d==k.SELECTION_ELEMENT){b=b.ranges=[];for(d=0;d<a.length;d++){for(var e=
a.item(d),h=e.parentNode,l=0,f=new q(this.document);l<h.childNodes.length&&h.childNodes[l]!=e;l++);f.setStart(new g(h),l);f.setEnd(new g(h),l+1);b.push(f)}return b}return b.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var f=0;f<c.rangeCount;f++){var d=c.getRangeAt(f),e=new q(this.document);e.setStart(new g(d.startContainer),d.startOffset);e.setEnd(new g(d.endContainer),d.endOffset);a.push(e)}return b.ranges=a},getStartElement:function(){var b=
this._.cache;if(void 0!==b.startElement)return b.startElement;var c,f=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();case k.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();j;)if(c=d.startContainer,d.startOffset==(c[0].nodeType===a.ELEMENT_NODE?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())d.setStartAfter(c);else break;c=d.startContainer;if(c[0].nodeType!=a.ELEMENT_NODE)return c.parent();c=new g(c[0].childNodes[d.startOffset]);
if(!c[0]||c[0].nodeType!=a.ELEMENT_NODE)return d.startContainer;for(d=c[0].firstChild;d&&d.nodeType==a.ELEMENT_NODE;)c=new g(d),d=d.firstChild;return c}if(n)d=f.createRange(),d.collapse(j),c=new g(d.parentElement());else{if((c=f.anchorNode)&&c.nodeType!=a.ELEMENT_NODE)c=c.parentNode;c&&(c=new g(c))}}return b.startElement=c},getSelectedElement:function(){var b,c=this._.cache;if(void 0!==c.selectedElement)return c.selectedElement;n&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var d;if(b)d=
new g(b);else{b=this.getRanges()[0];for(var e,k=2;k&&(!(d=b.getEnclosedNode())||!(d[0].nodeType==a.ELEMENT_NODE&&f[d.nodeName()]&&(e=d)));k--)b.shrink(m.SHRINK_ELEMENT);d=e}return c.selectedElement=d},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(n)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(f){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),
a.addRange(b);this.reset()},selectRanges:function(b){if(n){if(1<b.length){var f=b[b.length-1];b[0].setEnd(f.endContainer,f.endOffset);b.length=1}b[0]&&b[0].select()}else{f=this.getNative();if(!f)return;f.removeAllRanges();for(var g=0;g<b.length;g++){var d=b[g],e=this.document.createRange(),k=d.startContainer;if(d.collapsed&&(c.gecko&&1.09>c.gecko||c.opera||c.webkit)&&k[0].nodeType==a.ELEMENT_NODE&&!k[0].childNodes.length)k[0].appendChild(this.document.createTextNode(c.webkit?"\u200b":"")),d.startOffset++,
d.endOffset++;e.setStart(k[0],d.startOffset);e.setEnd(d.endContainer[0],d.endOffset);f.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),f=0;f<c.length;f++)b.push(c[f].createBookmark2(a));return b},createBookmarks:function(b,c){for(var f=[],g=this.document,d,c=c||this.getRanges(),k=c.length,h=0;h<k;h++){f.push(d=c[h].createBookmark(b,j));var l=(b=d.serializable)?e.one("#"+d.startNode,g):d.startNode;d=b?e.one("#"+d.endNode,g):d.endNode;for(var i=h+1;i<k;i++){var m=
c[i],n=m.startContainer,p=m.endContainer;a.equals(n,l.parent())&&m.startOffset++;a.equals(n,d.parent())&&m.startOffset++;a.equals(p,l.parent())&&m.endOffset++;a.equals(p,d.parent())&&m.endOffset++}}return f},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var f=new q(this.document);f.moveToBookmark(a[c]);b.push(f)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=
this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var l={table:1,tbody:1,tr:1},p=o.whitespaces(j),w=/\ufeff|\u00a0/;q.prototype.select=q.prototype.select=!n?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==a.ELEMENT_NODE&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var c=this.document.createRange();c.setStart(b[0],this.startOffset);try{c.setEnd(this.endContainer[0],
this.endOffset)}catch(f){if(0<=f.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(j),c.setEnd(this.endContainer[0],this.endOffset);else throw f;}b=i(this.document).getNative();b.removeAllRanges();b.addRange(c)}:function(b){var c=this.collapsed,f,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==a.ELEMENT_NODE){(new h(this.document)).selectElement(new g(e));return}}(this.startContainer[0].nodeType==
a.ELEMENT_NODE&&this.startContainer.nodeName()in l||this.endContainer[0].nodeType==a.ELEMENT_NODE&&this.endContainer.nodeName()in l)&&this.shrink(m.SHRINK_ELEMENT,j);var k=this.createBookmark(),e=k.startNode,i;c||(i=k.endNode);k=this.document.body.createTextRange();k.moveToElementText(e[0]);k.moveStart("character",1);if(i)b=this.document.body.createTextRange(),b.moveToElementText(i[0]),k.setEndPoint("EndToEnd",b),k.moveEnd("character",-1);else{for(f=e[0].nextSibling;f&&!p(f);)f=f.nextSibling;f=!(f&&
f.nodeValue&&f.nodeValue.match(w))&&(b||!e[0].previousSibling||e[0].previousSibling&&"br"==a.nodeName(e[0].previousSibling));d=new g(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(e);f&&a.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(c){if(f?(k.moveStart("character",-1),k.select(),this.document.selection.clear()):k.select(),d)this.moveToPosition(d,m.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(i),i._4e_remove(),
k.select()};h.getSelection=i;return d.Selection=h},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(e,h){function i(a){function b(a,c){var f=j.body.createTextRange();try{f.moveToPoint(a,c)}catch(d){f=g}return f}function c(){var a=j.selection.createRange();h&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&h.select();m.remove(j,"mouseup",c);m.remove(j,"mousemove",d);h=e=0}function d(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",h)?a.setEndPoint("StartToStart",h):a.setEndPoint("EndToEnd",h),a.select()}else c()}var e,
k=a.get("window")[0],j=a.get("document")[0],h;m.on(j,"mousedown contextmenu",function(a){var f=j.documentElement;if(a.target===f&&(e&&c(),!(f.scrollHeight>f.clientHeight)&&(e=1,h=b(a.pageX,a.pageY))))m.on(j,"mouseup",c),m.on(j,"mousemove",d),k.focus(),h.select()})}function d(b){function d(a){if(m){var g=b.getSelection(),k=g&&g.getType(),j=g&&e.selection;if(a&&j&&k==q.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){d(c)},50);else{var h;if(!j||!j.type||!("Control"!=j.type&&
(h=j.createRange())&&(h=h.parentElement())&&(h=h.nodeName)&&h.toLowerCase()in{input:1,textarea:1}))i=j&&g.getRanges()[0],b.checkSelectionChange()}}}var e=b.get("document")[0],k=new o(e.body),j=new o(e.documentElement);if(8>h.Utils.ieEngine)j.on("click",function(a){"html"===(new o(a.target)).nodeName()&&b.getSelection().getNative().createRange().select()});var i,m,n=c;j.on("mousedown",function(){n=a});j.on("mouseup",function(){n=c});k.on("focusin",function(a){if("body"==(new o(a.target)).nodeName()&&
i){try{n&&i.select()}catch(b){}i=g}});k.on("focus",function(){m=c;d()});k.on("beforedeactivate",function(b){b.relatedTarget||(m=a,n=c)});k.on("mousedown",function(){m=a});k.on("mouseup",function(){m=c;setTimeout(function(){d(c)},0)});k.on("keydown",function(){m=a});k.on("keyup",function(){m=c;setTimeout(function(){d()},0)})}function j(a){var b=a.get("document")[0];m.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function b(b){function g(a){var b=h.XHTML_DTD;return a._4e_isBlockBoundary()&&
b.$empty[a.nodeName()]}function d(a){return i(a)&&m(a)}var e=b.get("document")[0],j=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,i=h.Walker.whitespaces(c),m=h.Walker.bookmark(a,c),t=function(a){return i(a)&&8!=a.nodeType};b.on("selectionChange",function(i){var m=i.path,r=new o(b.get("document")[0].body),i=(i=i.selection)&&i.getRanges()[0],u=m.blockLimit;if(k.gecko){var B=m.block||m.blockLimit,s=B&&B.last(d);B&&B._4e_isBlockBoundary()&&
(!s||!(1==s[0].nodeType&&s._4e_isBlockBoundary()))&&"pre"!=B.nodeName()&&!B._4e_getBogus()&&B._4e_appendBogus()}if(i&&i.collapsed&&!m.block){if("body"==u.nodeName()){if((m=i.fixBlock(c,"p"))&&m[0]!=r[0].lastChild&&m._4e_outerHtml().match(j))if((u=m.next(t,1))&&u[0].nodeType==n.ELEMENT_NODE&&!g[u])i.moveToElementEditablePosition(u),m._4e_remove();else if((u=m.prev(t,1))&&u[0].nodeType==n.ELEMENT_NODE&&!g[u])i.moveToElementEditablePosition(u,u._4e_outerHtml().match(j)?a:c),m._4e_remove();i.select();
b.notifySelectionChange()}m=new h.Range(e);m.moveToElementEditablePosition(r,c);"body"!==(new h.ElementPath(m.startContainer)).blockLimit.nodeName()&&(r=(new o(e.createElement("p"))).appendTo(r),k.ie||r._4e_appendBogus())}})}var c=!0,a=!1,g=null,k=e.UA,m=e.Event,n=e.DOM,o=e.Node,q=h.SELECTION;return{init:function(a){a.docReady(function(){k.ie?(i(a),d(a)):j(a)});b(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(e){function h(a){return!v.attr(a,"_ke_bookmark")}function i(a,b){for(var c in a)a.hasOwnProperty(c)&&(e.isString(a[c])?a[c]=a[c].replace(L,function(a,c){return b[c]}):i(a[c],b))}function d(a,b){b&&(a=e.clone(a),i(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||K[c]?u.STYLE_BLOCK:I[c]?u.STYLE_OBJECT:u.STYLE_INLINE;this._={definition:a}}function j(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var f=new C(a),g=f.getRanges(),d=0;d<g.length;d++)c.call(this,g[d]);f.selectRanges(g)}function b(a,b,c){var f=a.element;"*"==f&&(f="span");b=new D(b.createElement(f));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=d.getStyleText(c);if(a)for(var g in a)a.hasOwnProperty(g)&&b.attr(g,a[g]);c&&(b[0].style.cssText=c);return b}function c(c){var f=c.createBookmark(t),d=c.createIterator();d.enforceRealBlocks=t;d.enlargeBr=t;for(var e,j=c.document;e=d.getNextParagraph();){var h=b(this,j,
e),m=h,h="pre"==m.nodeName,i="pre"==e.nodeName,l=!h&&i;h&&!i?(i=e,l=i.html(),l=a(l,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),l=l.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),l=l.replace(/([ \t\n\r]+|&nbsp;)/g," "),l=l.replace(/<br\b[^>]*>/gi,"\n"),G.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(m[0]),m[0].outerHTML="<pre>"+l+"</pre>",m=new D(i.firstChild),m._4e_remove()):m.html(l)):l?m=k(g(e),m):e._4e_moveChildren(m);e[0].parentNode.replaceChild(m[0],e[0]);if(h&&(e=m,h=void 0,(h=e._4e_previousSourceNode(t,
v.ELEMENT_NODE))&&"pre"==h.nodeName()))m=a(h.html(),/\n$/,"")+"\n\n"+a(e.html(),/^\n/,""),G.ie?e[0].outerHTML="<pre>"+m+"</pre>":e.html(m),h._4e_remove()}c.moveToBookmark(f)}function a(a,b,c){var f="",g="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(f=b);c&&(g=c);return""});return f+a.replace(b,c)+g}function g(b){var c=[];a(b._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,b){c.push(b)});return c}function k(b,c){for(var f=c[0].ownerDocument.createDocumentFragment(),g=0;g<b.length;g++){var d=b[g],d=d.replace(/(\r\n|\r)/g,"\n"),d=a(d,/^[ \t]*\n/,""),d=a(d,/\n$/,""),d=a(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
e=c.clone();e.html(d);f.appendChild(e[0])}return f}function m(a){var c=a.document;if(a.collapsed)c=b(this,c,void 0),a.insertNode(c),a.moveToPosition(c,B.POSITION_BEFORE_END);else{var f=this.element,g=this._.definition,d,e=E[f];e||(d=t,e=E.span);var k=a.createBookmark();a.enlarge(B.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),m=j.startNode,j=j.endNode,i=m,l;i&&i[0];){var n=z;if(v.equals(i,j))i=x,n=t;else{var p=i[0].nodeType,r=p==v.ELEMENT_NODE?i.nodeName():x;if(r&&i.attr("_ke_bookmark")){i=
i._4e_nextSourceNode(t);continue}if(!r||e[r]&&(i._4e_position(j)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(i))){var u=i.parent();if(u&&"a"==f&&u.nodeName()==f)p=b(this,c,void 0),u._4e_moveChildren(p),u[0].parentNode.replaceChild(p[0],u[0]),p._4e_mergeSiblings();else if(u&&u[0]&&((E[u.nodeName()]||E.span)[f]||d)&&(!g.parentRule||g.parentRule(u))){if(!l&&(!r||!E.$removeEmpty[r]||(i._4e_position(j)|
A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))l=new F(c),l.setStartBefore(i);if(p==v.TEXT_NODE||p==v.ELEMENT_NODE&&!i[0].childNodes.length){u=i;for(p=null;(n=!u.next(h,1))&&(p=u.parent())&&e[p.nodeName()]&&(p._4e_position(m)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(p));)u=p;l.setEndAfter(u)}}else n=
t}else n=t;i=i._4e_nextSourceNode()}if(n&&l&&!l.collapsed){for(var n=b(this,c,void 0),u=l.getCommonAncestor(),p={},r={},o,s=null,q;n&&u&&n[0]&&u[0];){if(u.nodeName()==f){for(o in g.attributes)if(g.attributes.hasOwnProperty(o)&&!r[o]&&(q=u.attr(s)))n.attr(o)==q?n.removeAttr(o):r[o]=1;for(s in g.styles)if(g.styles.hasOwnProperty(s)&&!p[s]&&(q=u.style(s)))n.style(s)==q?n.style(s,""):p[s]=1;if(!n._4e_hasAttributes()){n=x;break}}u=u.parent()}n?(n[0].appendChild(l.extractContents()),w(this,n),l.insertNode(n),
n._4e_mergeSiblings(),G.ie||n[0].normalize()):(n=new D(c.createElement("span")),n[0].appendChild(l.extractContents()),l.insertNode(n),w(this,n),n._4e_remove(!0));l=x}}m._4e_remove();j._4e_remove();a.moveToBookmark(k);a.shrink(B.SHRINK_TEXT)}}function n(a){a.enlarge(B.ENLARGE_ELEMENT);var b=a.createBookmark(),c=b.startNode;if(a.collapsed){for(var g=new H(c.parent()),d,e=0,k;e<g.elements.length&&(k=g.elements[e])&&!(k==g.block||k==g.blockLimit);e++)if(this.checkElementRemovable(k)){var j=a.checkBoundaryOfElement(k,
B.END),h=!j&&a.checkBoundaryOfElement(k,B.START);h||j?(d=k,d.match=h?"start":"end"):(k._4e_mergeSiblings(),k.nodeName()!=this.element?(j=f(this),y(k,j[k.nodeName()]||j["*"])):l(this,k))}if(d){k=c;for(e=0;;e++){j=g.elements[e];if(v.equals(j,d))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(k[0]);k=j}k["start"==d.match?"insertBefore":"insertAfter"](d)}}else{var i=b.endNode,m=this,g=function(){for(var a=new H(c.parent()),b=new H(i.parent()),f=x,g=x,d=0;d<a.elements.length;d++){var e=
a.elements[d];if(e==a.block||e==a.blockLimit)break;m.checkElementRemovable(e)&&(f=e)}for(d=0;d<b.elements.length;d++){e=b.elements[d];if(e==b.block||e==b.blockLimit)break;m.checkElementRemovable(e)&&(g=e)}g&&i._4e_breakParent(g);f&&c._4e_breakParent(f)};g();for(d=new D(c[0].nextSibling);d[0]!==i[0];){e=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==v.ELEMENT_NODE&&this.checkElementRemovable(d)&&(d.nodeName()==this.element?l(this,d):(k=f(this),y(d,k[d.nodeName()]||k["*"])),e[0].nodeType==v.ELEMENT_NODE&&
e.contains(c)))g(),e=new D(c[0].nextSibling);d=e}}a.moveToBookmark(b)}function o(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,f){b[c]=f});return b}function q(a,b){var c="";b!==z?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function f(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){e.isArray(c)||(c=[c]);for(var f=0;f<c.length;f++){var g=c[f],d,k,j;"string"==typeof g?d=g.toLowerCase():(d=g.element?g.element.toLowerCase():a.element,k=g.attributes,j=g.styles);g=b[d]||(b[d]={});if(k){d=g.attributes=g.attributes||[];for(var h in k)k.hasOwnProperty(h)&&d.push([h.toLowerCase(),k[h]])}if(j){var g=g.styles=g.styles||[],i;for(i in j)j.hasOwnProperty(i)&&g.push([i.toLowerCase(),j[i]])}}}return b}function l(a,b){var c=a._.definition,g=f(a),d=e.merge(c.attributes,(g[b.nodeName()]||
g["*"]||{}).attributes),c=e.merge(c.styles,(g[b.nodeName()]||g["*"]||{}).styles),g=e.isEmptyObject(d)&&e.isEmptyObject(c),k;for(k in d)if(d.hasOwnProperty(k)&&!(("class"==k||a._.definition.fullMatch)&&b.attr(k)!=p(k,d[k])))g=g||!!b.hasAttr(k),b.removeAttr(k);for(var j in c)c.hasOwnProperty(j)&&!(a._.definition.fullMatch&&b.style(j)!=p(j,c[j],t))&&(g=g||!!b.style(j),b.style(j,""));s(b)}function p(a,b,c){var f=new D("<span>");f[c?"style":"attr"](a,b);return f[c?"style":"attr"](a)}function w(a,b){for(var c=
f(a),g=b.all(a.element),d=g.length;0<=--d;)l(a,new D(g[d]));for(var e in c)if(c.hasOwnProperty(e)&&e!=a.element){g=b.all(e);for(d=g.length-1;0<=d;d--){var k=new D(g[d]);y(k,c[e])}}}function y(a,b){var c,f=b&&b.attributes;if(f)for(c=0;c<f.length;c++){var g=f[c][0],d;if(d=a.attr(g)){var e=f[c][1];(e===x||e.test&&e.test(d)||"string"==typeof e&&d==e)&&a[0].removeAttribute(g)}}if(f=b&&b.styles)for(c=0;c<f.length;c++)if(g=f[c][0],e=a.css(g)){var k=f[c][1];(k===x||k.test&&k.test(d)||"string"==typeof k&&
e==k)&&a.css(g,"")}s(a)}function s(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(t);b&&(b.nodeType==v.ELEMENT_NODE&&v._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==v.ELEMENT_NODE&&v._4e_mergeSiblings(c))}}var r=e.Editor,t=!0,z=!1,x=null,v=e.DOM,u={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},B=r.RANGE,C=r.Selection,A=r.POSITION,F=r.Range,D=e.Node,G=e.UA,H=r.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},E=r.XHTML_DTD,I={embed:1,hr:1,img:1,li:1,
object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},J=/\s*(?:;\s*|$)/g,L=/#\((.+?)\)/g;r.STYLE=u;d.prototype={apply:function(a){j.call(this,a,z)},remove:function(a){j.call(this,a,t)},applyToRange:function(a){return(this.applyToRange=this.type==u.STYLE_INLINE?m:this.type==u.STYLE_BLOCK?c:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==u.STYLE_INLINE?n:x).call(this,a)},checkElementRemovable:function(a,b){if(!a)return z;var c=this._.definition,g;if(a.nodeName()==
this.element){if(!b&&!a._4e_hasAttributes())return t;var e=c._AC;if(e)c=e;else{var e={},k=0,j=c.attributes;if(j)for(var h in j)j.hasOwnProperty(h)&&(k++,e[h]=j[h]);if(j=d.getStyleText(c))e.style||k++,e.style=j;e._length=k;c=c._AC=e}if(c._length){for(var i in c)if("_length"!=i&&c.hasOwnProperty(i)){k=a.attr(i)||"";if("style"==i)a:{e=c[i];k=q(k,z);"string"==typeof e&&(e=o(e));"string"==typeof k&&(k=o(k));j=void 0;for(j in e)if(e.hasOwnProperty(j)&&!(j in k&&(k[j]==e[j]||"inherit"==e[j]||"inherit"==
k[j]))){e=z;break a}e=t}else e=c[i]==k;if(e){if(!b)return t}else if(b)return z}if(b)return t}else return t}i=f(this);if(i=i[a.nodeName()]||i["*"]){if(!(c=i.attributes)&&!(g=i.styles))return t;if(c)for(e=0;e<c.length;e++)if(i=c[e][0],i=a.attr(i))if(k=c[e][1],k===x||"string"==typeof k&&i==k||k.test&&k.test(i))return t;if(g)for(e=0;e<g.length;e++)if(i=a.css(g[e][0]))if(c=g[e][1],c===x||"string"==typeof c&&i==c||c.test&&c.test(i))return t}return z},checkActive:function(a){switch(this.type){case u.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,t);case u.STYLE_OBJECT:case u.STYLE_INLINE:for(var b=a.elements,c=0,f;c<b.length;c++)if(f=b[c],!(this.type==u.STYLE_INLINE&&(v.equals(f,a.block)||v.equals(f,a.blockLimit))))if((this.type!=u.STYLE_OBJECT||f.nodeName()in I)&&this.checkElementRemovable(f,t))return t}return z}};d.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",f="";c.length&&(c=c.replace(J,";"));for(var g in b)if(b.hasOwnProperty(g)){var d=b[g],e=(g+":"+d).replace(J,
";");"inherit"==d?f+=e:c+=e}c.length&&(c=q(c));return a._ST=c+f};r.Style=d},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(e){var h=e.Node,i=e.DOM,d=e.UA,j={debugUrl:function(b){var c=e.Config;c.debug||(b=b.replace(/\.(js|css)/i,"-min.$1"));-1==b.indexOf("?t")&&(b=-1!=b.indexOf("?")?b+"&":b+"?",b+="t="+encodeURIComponent(c.tag));return c.base+"editor/"+b},lazyRun:function(b,c,a){var g=b[c],d=b[a];b[c]=function(){g.apply(this,arguments);b[c]=b[a];return d.apply(this,arguments)}},getXY:function(b,c,a,g){a=a.defaultView||a.parentWindow;b-=i.scrollLeft(a);c-=i.scrollTop(a);g&&(g=g.defaultView||
g.parentWindow,a!=g&&a.frameElement&&(g=i.offset(a.frameElement,void 0,g),b+=g.left,c+=g.top));return{left:b,top:c}},tryThese:function(b){for(var c,a=0,g=arguments.length;a<g;a++){var d=arguments[a];try{c=d();break}catch(e){}}return c},arrayCompare:function(b,c){if(!b&&!c)return!0;if(!b||!c||b.length!=c.length)return!1;for(var a=0;a<b.length;a++)if(b[a]!==c[a])return!1;return!0},clearAllMarkers:function(b){for(var c in b)b.hasOwnProperty(c)&&b[c]._4e_clearMarkers(b,!0,void 0)},ltrim:function(b){return b.replace(/^\s+/,
"")},rtrim:function(b){return b.replace(/\s+$/,"")},isNumber:function(b){return/^\d+(.\d+)?$/.test(e.trim(b))},verifyInputs:function(b){for(var c=0;c<b.length;c++){var a=new h(b[c]),g=e.trim(j.valInput(a)),d=a.attr("data-verify"),a=a.attr("data-warning");if(d&&!RegExp(d).test(g))return alert(a),!1}return!0},sourceDisable:function(b,c){b.on("sourceMode",c.disable,c);b.on("wysiwygMode",c.enable,c)},resetInput:function(b){var c=b.attr("placeholder");c&&d.ie?(b.addClass("ks-editor-input-tip"),b.val(c)):
d.ie||b.val("")},valInput:function(b,c){if(void 0===c)return b.hasClass("ks-editor-input-tip")?"":b.val();b.removeClass("ks-editor-input-tip");b.val(c)},placeholder:function(b,c){b.attr("placeholder",c);d.ie&&(b.on("blur",function(){e.trim(b.val())||(b.addClass("ks-editor-input-tip"),b.val(c))}),b.on("focus",function(){b.removeClass("ks-editor-input-tip");e.trim(b.val())==c&&b.val("")}))},htmlEncode:function(b){return!b?b:(""+b).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(b){var b=e.clone(b),c;for(c in b)if(b.hasOwnProperty(c)){var a=b[c];e.isFunction(a)&&(b[c]=a())}return b},map:function(b,c){for(var a=0;a<b.length;a++)b[a]=c(b[a]);return b},ieEngine:document.documentMode||d.ie,preventFocus:function(b){d.ie?b.unselectable(void 0):b.attr("onmousedown","return false;")},injectDom:function(b){e.mix(i,b);for(var c in b)b.hasOwnProperty(c)&&function(a){h.prototype[a]=function(){var c=[].slice.call(arguments,0);c.unshift(this[0]);return(c=
b[a].apply(null,c))&&(c.nodeType||e.isWindow(c))?new h(c):e.isArray(c)&&(c.__IS_NODELIST||c[0]&&c[0].nodeType)?new h(c):c}}(c)},addRes:function(){var b=this.__res=this.__res||[];b.push.apply(b,e.makeArray(arguments))},destroyRes:function(){for(var b=this.__res||[],c=0;c<b.length;c++){var a=b[c];e.isFunction(a)?a():(a.destroy&&a.destroy(),a.remove&&a.remove())}this.__res=[]},getQueryCmd:function(b){return"query"+("-"+b).replace(/-(\w)/g,function(b,a){return a.toUpperCase()})+"Active"}};return e.Editor.Utils=
j},{requires:["./base"]});
KISSY.add("editor/core/walker",function(e,h){function i(f,g){if(this._.end)return a;var d,e=this.range,j,h=this.guard,i=this.type,m=f?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,e.trim(),e.collapsed))return this.end(),a;if(!f&&!this._.guardLTR){var l=e.endContainer[0],u=l.childNodes[e.endOffset];this._.guardLTR=function(a,b){return b&&(l==a||"body"==k.nodeName(a))?!1:a!=u}}if(f&&!this._.guardRTL){var o=e.startContainer[0],q=0<e.startOffset&&o.childNodes[e.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(o==a||"body"==k.nodeName(a))?!1:a!=q}}var A=f?this._.guardRTL:this._.guardLTR;j=h?function(a,b){return A(a,b)===c?c:h(a,b)}:A;this.current?d=this.current[m](c,i,j):f?(d=e.endContainer,0<e.endOffset?(d=new n(d[0].childNodes[e.endOffset-1]),j(d[0])===c&&(d=a)):d=j(d,b)===c?a:d._4e_previousSourceNode(b,i,j,void 0)):(d=e.startContainer,d=new n(d[0].childNodes[e.startOffset]),d.length?j(d[0])===c&&(d=a):d=j(e.startContainer,b)===c?a:e.startContainer._4e_nextSourceNode(b,
i,j,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==c){if(!g)return d}else if(g&&this.evaluator)return c;d=d[m](c,i,j)}this.end();return this.current=a}function d(b){for(var c,f=a;c=i.call(this,b);)f=c;return f}function j(b){this.range=b;this.guard=this.evaluator=a;this._={}}var b=!0,c=!1,a=null,g=e.UA,k=e.DOM,m=h.XHTML_DTD,n=e.Node;e.augment(j,{end:function(){this._.end=1},next:function(){return i.call(this)},previous:function(){return i.call(this,b)},checkForward:function(){return i.call(this,
c,b)!==c},checkBackward:function(){return i.call(this,b,b)!==c},lastForward:function(){return d.call(this)},lastBackward:function(){return d.call(this,b)},reset:function(){delete this.current;this._={}},_iterator:i});e.mix(j,{blockBoundary:function(a){return function(b){return!(b.nodeType==k.ELEMENT_NODE&&k._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==k.nodeName(a)&&k.attr(a,"_ke_bookmark")}return function(f){var d,g;d=f.nodeType==k.TEXT_NODE&&(g=f.parentNode)&&c(g);
d=a?d:d||c(f);return!!(b^d)}},whitespaces:function(a){return function(b){b=b.nodeType==k.TEXT_NODE&&!e.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=j.whitespaces();return function(c){c=b(c)||c.nodeType==k.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var o=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,q=j.whitespaces(),f=j.bookmark(),l=function(a){var b=k.nodeName(a);return f(a)||q(a)||1==a.nodeType&&b in m.$inline&&!(b in m.$empty)};h.Utils.injectDom({_4e_getBogus:function(a){a=new n(a);do a=
a._4e_previousSourceNode();while(a&&l(a[0]));return a&&(!g.ie?"br"==a.nodeName():3==a[0].nodeType&&o.test(a.text()))?a[0]:!1}});return h.Walker=j},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(e){var h=e.Editor;h.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};h.baseZIndex=function(e){return(h.Config.baseZIndex||1E4)+e}},{requires:["./base"]});
KISSY.add("editor",function(e,h,i,d){function j(a,b){var c=a.body;r(function(){a.designMode="on";setTimeout(function(){a.designMode="off";c.focus();arguments.callee.retry||(arguments.callee.retry=m)},50)},function(){a.designMode="off";w.attr(c,"contentEditable",q);w.attr(c,"contentEditable",m);!b&&j(a,1)})}function b(a){a.get("iframe");var b=a.get("textarea")[0],c=a.get("window")[0],f=a.get("document")[0];l.webkit&&(s.on(f,"click",function(a){var b=new y(a.target);e.inArray(b.nodeName(),["input",
"select"])&&a.preventDefault()}),s.on(f,"mouseup",function(a){var b=new y(a.target);e.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(l.gecko||p||l.opera){var g;g=(new y('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);g.on("focus",function(){a.focus()});a.activateGecko=function(){l.gecko&&a.__iframeFocus&&g[0].focus()};a.on("destroy",function(){g.detach();g.remove()})}s.on(c,"focus",function(){l.gecko?j(f,q):l.opera&&f.body.focus();
a.notifySelectionChange()});if(l.gecko)s.on(f,"mousedown",function(){a.__iframeFocus||j(f,q)});if(p&&(s.on(f,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),f=c.getSelectedElement();if(f){a.fire("save");var d=c.getRanges()[0].createBookmark();f.remove();c.selectBookmarks([d]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==f.compatMode)){var k={33:1,34:1};s.on(f,"keydown",function(b){b.keyCode in k&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(l.webkit)s.on(f,
"mousedown",function(b){b=new y(b.target);e.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(l.gecko)s.on(f,"dragstart",function(a){var b=new y(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});d.add(a)}function c(a,b,c,d){var g="",k,j=i.debugUrl("theme/editor-iframe.css");for(k=0;k<c.length;k++)g+=e.substitute('<link href="{href}" rel="stylesheet" />',{href:c[k]});return e.substitute(t,{doctype:8===f.documentMode?
'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:j,style:b,data:d||"&nbsp;",script:a?'<script id="ke_active_script">'+(w.isCustomDomain()?'document.domain="'+f.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function a(a,b){a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)}function g(a,b){function f(){j=k.document;a.__set("document",new y(j));a.__set("window",new y(k));
d.detach();j.open("text/html","replace");j.write(g);j.close()}var d=a.get("iframe"),g=c(a._UUID,a.get("customStyle"),a.get("customLink"),b),e=d[0],k=e.contentWindow,j;d.__loaded=1;try{j=k.document}catch(h){if(e.src=e.src,7>p){setTimeout(f,10);return}}f()}function k(a,b){var c=new y(x),f=a.get("textarea");f.hasAttr("tabindex")&&c.attr("tabIndex",l.webkit?-1:f.attr("tabIndex"));a.get("iframeWrapEl").prepend(c);a.set("iframe",c);a.__docReady=0;if(l.gecko&&!c.__loaded)c.on("load",function(){g(a,b)},a);
else g(a,b)}var m=!0,n=n,o=e.all,q=!1,f=document,l=e.UA,p=l.ie,w=e.DOM,y=e.Node,s=e.Event,r=i.tryThese,t="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",z=w.getEmptyIframeSrc(),x='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(z?' src="'+z+'"':"")+"</iframe>";e.mix(h,{SOURCE_MODE:0,WYSIWYG_MODE:1});
var v=h.WYSIWYG_MODE;e.augment(h,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=o("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');this._UUID=e.guid();this.set({iframeWrapEl:a=c.one(".ks-editor-textarea-wrap"),toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display",
"none");a.append(b);d.register(this)},_uiSetHeight:function(a){var b=this.get("toolBarEl"),c=this.get("statusBarEl"),a=parseInt(a,10),a=a-((b&&b.outerHeight()||0)+(c&&c.outerHeight()||0));this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},adjustHeight:function(){var a;(a=this.get("height"))&&this._uiSetHeight(a)},_uiSetMode:function(a){var b=this,c,f=b.get("iframe"),d=b.get("textarea");a==v?(b.execCommand("save"),b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",
c)}),b._setData(d.val()),b.fire("wysiwygMode")):(d.val(b._getData(1,v)),d[0].focus(),d.show(),f.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,f=b.get("prefixCls"),d=b.get("textarea");if(b.get("attachForm")&&(c=d[0].form))w.on(c,"submit",b.sync,b),b.on("destroy",function(){w.detach(c,"submit",b.sync,b)});b.on("docReady",
a);b.on("blur",function(){b.get("el").removeClass(f+"editor-focused")});b.on("focus",function(){b.get("el").addClass(f+"editor-focused")})},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();d.remove(this);s.remove([a,a.documentElement,a.body,b[0]]);e.each(this.__dialogs,function(a){a.destroy&&a.destroy()});e.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__dialogs={};this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},
getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var c=this.__dialogs[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},hasDialog:function(a){return!!this.__dialogs[a]},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=e.makeArray(arguments);c.shift();c.unshift(this);
if(b)return b.exec.apply(b,c)},_getData:function(a,b){var c=this.htmlDataProcessor,f;b==n&&(b=this.get("mode"));f=b==v?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());f=a?c.toHtml(f):c.toServer(f);f=e.trim(f);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(f)&&(f="");return f},_setData:function(a){var b,c=a;if(this.get("mode")!=v)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];
var f=this.get("document")[0];s.remove([f,f.documentElement,f.body,b]);a.remove()}k(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return c(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return h.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=w._getWin(a);l.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){w._getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);w.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){w.remove(w.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=
this.get("document")[0],b=w.query("link",b),c=0;c<b.length;c++)w.attr(b[c],"href")==a&&w.remove(b[c]);b=this.get("customLink")||[];a=e.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),f=new h.ElementPath(c);if(!a.__previousPath||
!a.__previousPath.compare(f))a.__previousPath=f,a.fire("selectionChange",{selection:b,path:f,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(b){if(this.get("mode")===v){this.focus();var c,f=b.nodeName(),d=h.XHTML_DTD,g=d.$block[f],e=h.RANGE,k=(f=this.getSelection())&&f.getRanges(),j,i,l;if(k&&0!=k.length){this.execCommand("save");for(i=k.length-1;0<=i;i--)j=k[i],c=!i&&b||b.clone(m),j.insertNodeByDtd(c),l||(l=c);if(l)return j.moveToPosition(l,
e.POSITION_AFTER_END),g&&(b=h.Walker.whitespaces(!0),(b=(l=l.next(b,1))&&l[0].nodeType==w.ELEMENT_NODE&&l.nodeName())&&d.$block[b]&&d[b]["#"]&&j.moveToElementEditablePosition(l)),f.selectRanges([j]),this.focus(),c&&c.scrollIntoView(n,!1),a(this),c}}},insertHtml:function(b,c){var f=this,d;if(f.get("mode")===v){if(d=f.htmlDataProcessor)b=d.toDataFormat(b,null,c);f.focus();f.execCommand("save");var g=f.get("document")[0];d=0;if(p){var e=g.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(b)}catch(k){}}else try{g.execCommand("inserthtml",
q,b)}catch(j){setTimeout(function(){if(0==f.getSelection().getRanges().length){var a=new h.Range(g),c=w.first(g.body,function(a){return 1==a.nodeType&&"br"!=w.nodeName(a)});c||(c=new y(g.createElement("p")),c._4e_appendBogus(n),g.body.appendChild(c[0]));a.setStartAt(c,h.RANGE.POSITION_AFTER_START);a.select()}g.execCommand("inserthtml",q,b)},d=100)}setTimeout(function(){f.getSelection().scrollIntoView()},d);a(f,d)}}});h._initIFrame=function(a){var c=d.getInstance(a),f=c.get("document")[0],a=f.getElementById("ke_active_script");
w.remove(a);b(c);var g=f.body;p?(g.hideFocus=m,g.disabled=m,g.contentEditable=m,g.removeAttribute("disabled")):setTimeout(function(){l.gecko||l.opera?g.contentEditable=m:l.webkit?g.parentNode.contentEditable=m:f.designMode="on"},0);if(l.gecko||l.opera){var e=f.documentElement;s.on(e,"mousedown",function(a){if(a.target==e){l.gecko&&j(f,q);c.activateGecko()}})}setTimeout(function(){p&&setTimeout(function(){if(f){g.runtimeStyle.marginBottom="0px";g.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=
1;c.fire("docReady");var a=c.get("disableObjectResizing"),b=c.get("disableInlineTableEditing");if(a||b)try{f.execCommand("enableObjectResizing",q,!a);f.execCommand("enableInlineTableEditing",q,!b)}catch(d){s.on(g,p?"resizestart":"resize",function(c){var f=new y(c.target);(a||f.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};return h},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
KISSY.add("editor/plugin/backColor/cmd",function(e,h){var i={element:"span",styles:{"background-color":"#(color)"},overrides:[{element:"*",styles:{"background-color":null}}],childRule:function(){return!1}};return{init:function(d){d.hasCommand("backColor")||d.addCommand("backColor",{exec:function(d,b){d.execCommand("save");h.applyColor(d,b,i);d.execCommand("save")}})}}},{requires:["../color/cmd"]});
KISSY.add("editor/plugin/backColor/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("backColor",{cmdType:"backColor",tooltip:"\u80cc\u666f\u989c\u8272"},void 0,i)}}},{requires:["editor","../color/btn","./cmd"]});KISSY.add("editor/plugin/bold/cmd",function(e,h,i){var d=new h.Style({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]});return{init:function(e){i.addButtonCmd(e,"bold",d)}}},{requires:["editor","../font/cmd"]});
KISSY.add("editor/plugin/bold/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("bold",{cmdType:"bold",tooltip:"\u7c97\u4f53 "},void 0,i.Button)}}},{requires:["editor","../font/ui","./cmd"]});
KISSY.add("editor/plugin/bubbleview/index",function(e,h,i){function d(a){var b=null,c=g[e.stamp(a.editor)];e.each(c,function(c){var d;if(d=c!==a)if(d=c.get("visible")){d=a.get("y");var f=d+a.get("el").outerHeight(),g=c.get("y"),e=g+c.get("el").outerHeight();d=d<=e&&f>=e||d<=g&&f>=g}d&&(b?b.get("y")<c.get("y")&&(b=c):b=c);return b})}var j=e.Event,b={}.a,c=e.DOM,a=h.extend({},{ATTRS:{zIndex:{value:i.baseZIndex(i.zIndexManager.BUBBLE_VIEW)},elCls:{value:"ks-editor-bubbleview-bubble"},prefixCls:{value:"ks-editor-"},
effect:{value:{effect:"fade",duration:0.3}}}}),g={};a.register=function(k){function h(){p&&(p.hide(),j.remove(s,"scroll",o))}function i(){var a;var f=p.selectedEl,g=p.editor;if(f){var e=g.get("window")[0],k=g.get("iframe").offset(),g=k.top,k=k.left,j=k+c.width(e),e=g+c.height(e),h=f.offset(b,window),l=h.top,h=h.left,m=h+f.width(),f=l+f.height(),n;f>e&&l<e?n=e-30:f>g&&f<e&&(n=f);m>k&&h<k?a=k:h>k&&h<j&&(a=h);a=a!==b&&n!==b?[a,n]:b}else a=b;if(a){p.set("xy",a);if(n=d(p))a[1]=n.get("y")+n.get("el").outerHeight(),
p.set("xy",a);p.get("visible")||p.show()}}function o(){p.selectedEl&&(p&&(p.get("el"),p.hide()),r())}function q(){j.on(s,"scroll",o);i()}var f=k.filter,l=k.editor,p=new a({editor:l}),w=e.stamp(l),y=g[w]=g[w]||[];p.init=k.init;if(p.init)p.on("afterRenderUI",function(){p.init()});y.push(p);p.editor=l;l.on("destroy",function(){delete g[w];p.destroy()});l.on("selectionChange",function(a){var a=a.path,b=a.elements;if(a&&b&&(a=a.lastElement))(a=f(a))?(p.selectedEl=a,p.hide(),e.later(q,10)):p&&h()});l.on("sourceMode",
h);var s=l.get("window")[0],r=e.buffer(i,350)};return a},{requires:["overlay","editor"]});
KISSY.add("editor/plugin/button/index",function(e,h,i){h.prototype.addButton=function(d,j,b,c){void 0===c&&(c=j.checkable?i.Toggle:i,delete j.checkable);var a=this,g=a.get("prefixCls")+"editor-",k=new c(e.mix({render:a.get("toolBarEl"),elAttrs:{hideFocus:"hideFocus"},autoRender:!0,content:'<span class="'+g+"toolbar-item "+g+"toolbar-"+d+'"></span>',elCls:g+"toolbar-button",prefixCls:g,editor:a},j)),m=k.get("el").one("span");k.get("el").unselectable();k.on("afterContentClsChange",function(a){m[0].className=
g+"toolbar-item "+g+"toolbar-"+a.newVal});e.mix(k,b);k.init&&k.init();if(k.selectionChange)a.on("selectionChange",function(b){a.get("mode")!=h.SOURCE_MODE&&k.selectionChange(b)});if(k.onClick||k.offClick)k.on("click",function(a){var b=k.get("checked"),b=b===true||b===void 0?"offClick":"onClick";if(k[b])k[b](a)});k.get("mode")==h.WYSIWYG_MODE&&(a.on("wysiwygMode",function(){k.set("disabled",false)}),a.on("sourceMode",function(){k.set("disabled",true)}));a.addControl(d,k);return k};return i},{requires:["editor",
"button"]});
KISSY.add("editor/plugin/checkboxSourcearea/index",function(e,h){function i(b){this.editor=b;this._init()}var d=e.Node,j=h.SOURCE_MODE,b=h.WYSIWYG_MODE;e.augment(i,{_init:function(){var b=this.editor,a=b.get("statusBarEl");this.holder=(new d("<span style='zoom:1;display:inline-block;height:22px;line-height:22px;'><input style='margin:0 5px;vertical-align:middle;' type='checkbox' /><span style='vertical-align:middle;'>\u7f16\u8f91\u6e90\u4ee3\u7801</span></span>")).appendTo(a);(this.el=this.holder.one("input")).on("click",this._check,
this);b.on("wysiwygMode",this._wysiwygmode,this);b.on("sourceMode",this._sourcemode,this)},_sourcemode:function(){this.el.attr("checked",!0)},_wysiwygmode:function(){this.el.attr("checked",!1)},_check:function(){var c=this.editor;this.el.attr("checked")?c.set("mode",j):c.set("mode",b)},destroy:function(){this.holder.remove()}});return{init:function(b){var a=new i(b);b.on("destroy",function(){a.destroy()})}}},{requires:["editor"]});
KISSY.add("editor/plugin/color/btn",function(e,h,i,d,j){var b=e.Node;e.DOM.addStyleSheet(window,".ks-editor-color-panel a {display: block;color:black;text-decoration: none;}.ks-editor-color-panel a:hover {color:black;text-decoration: none;}.ks-editor-color-panel a:active {color:black;}.ks-editor-color-palette {    margin: 5px 8px 8px;}.ks-editor-color-palette table {    border: 1px solid #666666;    border-collapse: collapse;}.ks-editor-color-palette td {    border-right: 1px solid #666666;    height: 18px;    width: 18px;}a.ks-editor-color-a {    height: 18px;    width: 18px;}a.ks-editor-color-a:hover {    border: 1px solid #ffffff;    height: 16px;    width: 16px;}a.ks-editor-color-remove {  padding:3px 8px;  margin:2px 0 3px 0;}a.ks-editor-color-remove:hover {    background-color: #D6E9F8;}",
"ks-editor-color-plugin");var c=["000,444,666,999,CCC,EEE,F3F3F3,FFF".split(","),"F00,F90,FF0,0F0,0FF,00F,90F,F0F".split(","),"F4CCCC,FCE5CD,FFF2CC,D9EAD3,D0E0E3,CFE2F3,D9D2E9,EAD1DC,EA9999,F9CB9C,FFE599,B6D7A8,A2C4C9,9FC5E8,B4A7D6,D5A6BD,E06666,F6B26B,FFD966,93C47D,76A5AF,6FA8DC,8E7CC3,C27BAD,CC0000,E69138,F1C232,6AA84F,45818E,3D85C6,674EA7,A64D79,990000,B45F06,BF9000,38761D,134F5C,0B5394,351C75,741B47,660000,783F04,7F6000,274E13,0C343D,073763,20124D,4C1130".split(",")],a;(function(){a="<div class='ks-editor-color-panel'><a class='ks-editor-color-remove' href=\"javascript:void('\u6e05\u9664');\">\u6e05\u9664</a>";
for(var b=0;3>b;b++){a+="<div class='ks-editor-color-palette'><table>";for(var d=c[b],e=d.length/8,j=0;j<e;j++){a+="<tr>";for(var h=0;8>h;h++){var i="#"+d[8*j+h];a+="<td>";a+="<a href='javascript:void(0);' class='ks-editor-color-a' style='background-color:"+i+"'></a>";a+="</td>"}a+="</tr>"}a+="</table></div>"}a+="<div><a class='ks-editor-button ks-editor-color-others ks-inline-block'>\u5176\u4ed6\u989c\u8272</a></div></div>"})();return i.Toggle.extend({init:function(){var a=this;a.on("blur",function(){setTimeout(function(){a.onClick()},
150)})},offClick:function(){this._prepare()},onClick:function(){this.colorWin&&this.colorWin.hide()},_prepare:function(){var b=this,c=b.get("editor"),e;b.colorWin=new d({elAttrs:{tabindex:0},elCls:"ks-editor-popup",content:a,autoRender:!0,width:170,zIndex:h.baseZIndex(h.zIndexManager.POPUP_MENU)});var i=b.colorWin;e=i.get("contentEl");e.on("click",b._selectColor,b);i.on("hide",function(){b.set("checked",!1)});e.one(".ks-editor-color-others").on("click",function(a){a.halt();i.hide();j.useDialog(c,
"color/colorPicker/dialog",b.get("cmdType"))});b._prepare=b._show;b._show()},_show:function(){var a=this.get("el"),b=this.colorWin;b.align(a,["bl","tl"],[0,2]);b.show()},_selectColor:function(a){a.halt();a=new b(a.target);a.hasClass("ks-editor-color-a")&&this.get("editor").execCommand(this.get("cmdType"),a.style("background-color"))},destroy:function(){this.colorWin&&this.colorWin.destroy()}},{ATTRS:{mode:{value:h.WYSIWYG_MODE}}})},{requires:["editor","../button/","../overlay/","../dialogLoader/"]});
KISSY.add("editor/plugin/color/cmd",function(e,h){return{applyColor:function(e,d,j){var b=e.get("document")[0];e.execCommand("save");d?(new h.Style(j,{color:d})).apply(b):(new h.Style(j,{color:"inherit"})).remove(b);e.execCommand("save")}}},{requires:["editor"]});
KISSY.add("editor/plugin/contextmenu/index",function(e,h,i,d){h.prototype.addContextMenu=function(j,b,c){c=c||{};c.prefixCls=this.get("prefixCls")+"editor-";c.editor=this;c.focusable=1;c.zIndex=h.baseZIndex(h.zIndexManager.POPUP_MENU);c.elAttrs={hideFocus:"hideFocus"};c.children&&e.each(c.children,function(a){a.xclass="menuitem"});var a=new i.PopupMenu(c);d.init(a);editor.docReady(function(){var c=editor.get("document");c.on("mousedown",function(b){1==b.button&&a.hide()});c.delegate("contextmenu",
b,function(b){var d=e.all(b.target);b.halt();var j=b.pageX,i=b.pageY,b=j?h.Utils.getXY(j,i,c[0],document):d.offset(document),j=b.left,i=b.top;setTimeout(function(){a.set("editorSelectedEl",d,{silent:1});a.set("xy",[j,i]);a.show();h.fire("contextmenu",{contextmenu:a});window.focus();document.body.focus();a.get("el")[0].focus()},30)})});editor.addControl(j,a);return a}},{requires:["editor","menu","../focusFix/"]});
KISSY.add("editor/plugin/dentUtils/cmd",function(e,h,i){function d(a){return a.nodeType==g.ELEMENT_NODE&&"li"==g.nodeName(a)}function j(a,b,f){for(var d=a.startContainer,e=a.endContainer;d&&!d.parent().equals(b);)d=d.parent();for(;e&&!e.parent().equals(b);)e=e.parent();if(d&&e){for(var j=d,d=[],o=!1;!o;)j.equals(e)&&(o=!0),d.push(j),j=j.next();if(!(1>d.length)){var q=b._4e_parents(!0,void 0);q.each(function(a,b){q[b]=a});for(e=0;e<q.length;e++)if(c[q[e].nodeName()]){b=q[e];break}for(var j="indent"==
f?1:-1,e=d[0],o=d[d.length-1],d={},v=i.listToArray(b,d),u=v[o.data("listarray_index")].indent,e=e.data("listarray_index");e<=o.data("listarray_index");e++){v[e].indent+=j;var B=v[e].parent;v[e].parent=new k(B[0].ownerDocument.createElement(B.nodeName()))}for(e=o.data("listarray_index")+1;e<v.length&&v[e].indent>u;e++)v[e].indent+=j;o=i.arrayToList(v,d,null,"p");j=[];if("outdent"==f){var C;if((C=b.parent())&&"li"==C.nodeName())for(var f=o.listNode.childNodes,A,e=f.length-1;0<=e;e--)(A=new k(f[e]))&&
"li"==A.nodeName()&&j.push(A)}o&&(g.insertBefore(o.listNode[0]||o.listNode,b[0]||b),b.remove());if(j&&j.length)for(e=0;e<j.length;e++){for(A=b=j[e];(A=A.next())&&A.nodeName()in c;)m.ie&&!b.first(function(a){return n(a)&&l(a)},1)&&b[0].appendChild(a.document.createTextNode("\u00a0")),b[0].appendChild(A[0]);g.insertAfter(b[0],C[0])}h.Utils.clearAllMarkers(d)}}}function b(a,b){var c=parseInt(a.style(o),10);isNaN(c)&&(c=0);c+=("indent"==b?1:-1)*q;if(0>c)return!1;c=Math.max(c,0);c=Math.ceil(c/q)*q;a.css(o,
c?c+f:"");""===a[0].style.cssText&&a.removeAttr("style");return!0}var c={ol:1,ul:1},a=h.Walker,g=e.DOM,k=e.Node,m=e.UA,n=a.whitespaces(!0),o="margin-left",q=40,f="px",l=a.bookmark(!1,!0);return{checkOutdentActive:function(a){var b=a.blockLimit;return a.contains(c)?!0:(a=a.block||b)&&a.style(o)},addCommand:function(f,e){f.hasCommand(e)||f.addCommand(e,{exec:function(f){f.execCommand("save");var k=f.getSelection(),h=k&&k.getRanges()[0];if(h){for(var i=h.startContainer,l=h.endContainer,m=h.getCommonAncestor();m&&
!(m[0].nodeType==g.ELEMENT_NODE&&c[m.nodeName()]);)m=m.parent();m&&i[0].nodeType==g.ELEMENT_NODE&&i.nodeName()in c&&(i=new a(h),i.evaluator=d,h.startContainer=i.next());m&&l[0].nodeType==g.ELEMENT_NODE&&l.nodeName()in c&&(i=new a(h),i.evaluator=d,h.endContainer=i.previous());l=k.createBookmarks(!0);if(m){for(i=m.first();i&&"li"!=i.nodeName();)i=i.next();var n=h.startContainer;(!(i[0]==n[0]||i.contains(n))||!b(m,e))&&j(h,m,e)}else{h=h.createIterator();h.enforceRealBlocks=!0;for(h.enlargeBr=!0;m=h.getNextParagraph();)b(m,
e)}k.selectBookmarks(l)}f.execCommand("save");f.notifySelectionChange()}})}}},{requires:["editor","../listUtils/"]});
KISSY.add("editor/plugin/dialogLoader/index",function(e,h,i){var d,j={loading:function(){d||(d=new h({x:0,width:6==e.UA.ie?e.DOM.docWidth():"100%",y:0,zIndex:i.baseZIndex(i.zIndexManager.LOADING),prefixCls:"ks-editor-",elCls:"ks-editor-global-loading"}));d.set("height",e.DOM.docHeight());d.show();d.loading()},unloading:function(){d.hide()}};return{useDialog:function(b,c,a){b.focus();b.hasDialog(c)?setTimeout(function(){b.showDialog(c,a)},0):(j.loading(),e.use("editor/plugin/"+c,function(d,e){j.unloading();
b.addDialog(c,new e(b));b.showDialog(c,a)}))}}},{requires:["overlay","editor"]});
KISSY.add("editor/plugin/draft/index",function(e,h,i,d,j){function b(a,b,c){for(a+="";a.length<b;)a=c+a;return a}function c(a){e.isNumber(a)&&(a=new Date(a));return a instanceof Date?[a.getFullYear(),"-",b(a.getMonth()+1,2,"0"),"-",b(a.getDate(),2,"0")," ",b(a.getHours(),2,"0"),":",b(a.getMinutes(),2,"0"),":",b(a.getSeconds(),2,"0")].join(""):a}function a(a){this.editor=a;this._init()}function g(b){var c=new a(b);b.on("destroy",function(){c.destroy()})}var k=e.Node,m=e.Event,n=e.JSON,o=h.Utils.addRes,
q=h.Utils.destroyRes;e.augment(a,{_getSaveKey:function(){var a=this.editor.get("pluginConfig");return a.draft&&a.draft.saveKey||"ks-editor-draft-save20110503"},_getDrafts:function(){if(!this.drafts){var a=i.getItem(this._getSaveKey()),b=[];a&&(b=i==window.localStorage?n.parse(decodeURIComponent(a)):a);this.drafts=b}return this.drafts},_init:function(){var a=this,b=a.editor,c=b.get("statusBarEl"),d=b.get("pluginConfig");d.draft=d.draft||{};a.draftInterval=d.draft.interval=d.draft.interval||5;a.draftLimit=
d.draft.limit=d.draft.limit||5;c=(new k("<div class='ks-editor-draft'><span class='ks-editor-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+d.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(c);a.timeTip=(new k("<span class='ks-editor-draft-time'/>")).appendTo(c);var g=(new k("<a href='#' onclick='return false;' class='ks-editor-button ks-editor-draft-save-btn ks-inline-block' style='vertical-align:middle;padding:1px 9px;'><span class='ks-editor-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).unselectable().appendTo(c),e=
new j({container:c,menuContainer:document.body,doc:b.get("document")[0],width:"85px",popUpWidth:"225px",align:["r","t"],emptyText:"&nbsp;&nbsp;&nbsp;\u5c1a\u65e0\u7f16\u8f91\u5668\u5386\u53f2\u5b58\u5728",tooltip:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"});a.versions=e;e.on("select",function(){e.detach("select",arguments.callee);a.sync()});g.on("click",function(b){a.save(!1);b.halt()});o.call(a,g);b.get("textarea")[0].form&&function(){function c(){a.save(!0)}var d=b.get("textarea")[0].form;m.on(d,"submit",c);o.call(a,function(){m.remove(d,"submit",c)})}();var i=setInterval(function(){a.save(!0)},
6E4*a.draftInterval);o.call(a,function(){clearInterval(i)});e.on("click",a.recover,a);o.call(a,e);a.holder=c;if(d.draft.helpHtml){var n=(new k('<a tabindex="0" hidefocus="hidefocus" class="ks-editor-draft-help" title="\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9" href="javascript:void(\'\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9 \')">\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9</a>')).unselectable().appendTo(c);n.on("click",function(){n[0].focus();a.helpPopup&&a.helpPopup.get("visible")?a.helpPopup.hide():a._prepareHelp()});n.on("blur",function(){a.helpPopup&&a.helpPopup.hide()});a.helpBtn=n;o.call(a,n);h.Utils.lazyRun(a,
"_prepareHelp","_realHelp")}o.call(a,c)},_prepareHelp:function(){var a=this.editor.get("pluginConfig").draft,a=new k(a.helpHtml||""),b=new k("<div style='height:0;position:absolute;fontSize:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;fontSize:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>");
a.append(b);a.css({border:"1px solid #ACB4BE","text-align":"left"});this.helpPopup=new d({content:a,prefixCls:"ks-editor-",autoRender:!0,width:a.width()+"px",zIndex:h.baseZIndex(h.zIndexManager.OVERLAY),mask:!1});this.helpPopup.get("el").css("border","none");this.helpPopup.arrow=b},_realHelp:function(){var a=this.helpPopup,b=this.helpBtn,c=a.arrow;a.show();b=b.offset();a.get("el").offset({left:b.left-a.get("el").width()+17,top:b.top-a.get("el").height()-7});c.offset({left:b.left-2,top:b.top-8})},
disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var a=this.draftLimit,b=this.timeTip,d=this.versions,g=this._getDrafts();g.length>a&&g.splice(0,g.length-a);for(var a=[],e,k=0;k<g.length;k++)e=g[k],e=(e.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+c(e.date),a.push({name:e,value:k});d.set("items",a.reverse());b.html(e);i.setItem(this._getSaveKey(),i==window.localStorage?encodeURIComponent(n.stringify(g)):g)},save:function(a){var b=this._getDrafts(),
c=this.editor.get("formatData");c&&(b[b.length-1]&&c==b[b.length-1].content&&(b.length-=1),this.drafts=b.concat({content:c,date:(new Date).getTime(),auto:a}),this.sync())},recover:function(a){var b=this.editor,d=this.versions,g=this._getDrafts(),e=a.newVal;d.reset("value");confirm("\u786e\u8ba4\u6062\u590d "+c(g[e].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")&&(b.execCommand("save"),b.set("data",g[e].content),b.execCommand("save"));a.halt()},destroy:function(){q.call(this)}});return{init:function(a){i.ready?i.ready(function(){g(a)}):g(a)}}},{requires:["editor",
"../localStorage/","overlay","../select/"]});
KISSY.add("editor/plugin/dragUpload/index",function(e,h){var i=e.Node,d=e.Event,j=h.Utils,b=e.DOM;return e.UA.ie?void 0:{init:function(c){function a(a){a=a.originalEvent.target;"img"==b.nodeName(a)&&a.src.match(/^file:\/\//)&&(p[a.src]=a)}function g(a,b){var c=new window.FileReader;c.onload=function(d){var f=a.name,d=d.target.result,g=new XMLHttpRequest;g.open("POST",q,!0);g.onreadystatechange=function(){if(4==g.readyState){if(200==g.status||304==g.status){if(""!=g.responseText){var a=window.JSON.parse(g.responseText);
b[0].src=a.imgUrl}}else alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01"),b.remove();g.onreadystatechange=null}};f="\r\n------kissy-editor-yiminghe\r\n"+('Content-Disposition: form-data; name="'+m+'"; filename="'+encodeURIComponent(f)+'"\r\n');f+="Content-Type: "+(a.type||"application/octet-stream")+"\r\n\r\n";f+=d+"\r\n";o=h.Utils.normParams(o);for(var e in o)o.hasOwnProperty(e)&&(f+="------kissy-editor-yiminghe\r\n",f+='Content-Disposition: form-data; name="'+e+'"\r\n\r\n',f+=o[e]+"\r\n");f+="------kissy-editor-yiminghe--";g.setRequestHeader("Content-Type",
"multipart/form-data, boundary=----kissy-editor-yiminghe");g.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-yiminghe\r\nContent-Length: "+f.length+"\r\n"+f+"\r\n");c.onload=null};c.readAsBinaryString(a)}var k=c.get("pluginConfig").dragUpload||{},m=k.fileInput||"Filedata",n=k.sizeLimit||Number.MAX_VALUE,o=k.serverParams||{},q=k.serverUrl||"",f=RegExp((k.suffix||"png,jpg,jpeg,gif").split(/,/).join("|")+"$","i"),l=c.get("document")[0],p={},w=!1;d.on(l,"dragenter",function(){w||
(d.on(l,"DOMNodeInserted",a),w=!0)});d.on(l,"drop",function(c){d.remove(l,"DOMNodeInserted",a);w=!1;c.halt();var c=c.originalEvent,k,h;e.isEmptyObject(p)?(h=l.elementFromPoint(c.clientX,c.clientY),k=h.lastChild):(e.each(p,function(a){"img"==b.nodeName(a)&&(k=a.nextSibling,h=a.parentNode,b.remove(a))}),p={});c=c.dataTransfer;c.dropEffect="copy";if(c=c.files)for(var m=0;m<c.length;m++){var o=c[m],q=o.size;if(o.name.match(f)&&!(q/1E3>n)){var q=new i("<img src='"+j.debugUrl("theme/tao-loading.gif")+"'/>"),
v=q[0];h.insertBefore(v,k);var u=b.nodeName(v.parentNode);("head"==u||"html"==u)&&b.insertBefore(v,l.body.firstChild);g(o,q)}}});window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary&&(XMLHttpRequest.prototype.sendAsBinary=function(a,b){for(var c=new (window.BlobBuilder||window.WebKitBlobBuilder),f=a.length,d=new window.Uint8Array(f),g=0;g<f;g++)d[g]=a.charCodeAt(g);c.append(d.buffer);this.send(c.getBlob(b))})}}},{requires:["editor"]});
KISSY.add("editor/plugin/elementPath/index",function(e,h){function i(d){this.cfg=d;this._cache=[];this._init()}var d=e.Node;e.augment(i,{_init:function(){var e=this.cfg.editor;this.holder=new d("<span>");this.holder.appendTo(e.get("statusBarEl"),void 0);e.on("selectionChange",this._selectionChange,this);h.Utils.sourceDisable(e,this)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},_selectionChange:function(e){var b=this.cfg.editor,c=this.holder,
e=e.path.elements,a,g;a=this._cache;for(g=0;g<a.length;g++)a[g].remove();this._cache=[];for(g=0;g<e.length;g++){a=e[g];var k=a.attr("_ke_real_element_type")||a.nodeName(),h=new d("<a href='javascript(\""+k+"\")' class='ks-editor-element-path'>"+k+"</a>");this._cache.push(h);(function(a){h.on("click",function(c){c.halt();b.focus();setTimeout(function(){b.getSelection().selectElement(a)},50)})})(a);c.prepend(h)}},destroy:function(){this.holder.remove()}});return{init:function(d){var b=new i({editor:d});
d.on("destroy",function(){b.destroy()})}}},{requires:["editor"]});
KISSY.add("editor/plugin/fakeObjects/index",function(e,h){var i=e.Node,d=e.DOM,j=h.Utils.debugUrl("theme/spacer.gif"),b=e.require("htmlparser");e.augment(h,{createFakeElement:function(a,b,c,d,h,o){var q=a.attr("style")||"";a.attr("width")&&(q="width:"+a.attr("width")+"px;"+q);a.attr("height")&&(q="height:"+a.attr("height")+"px;"+q);var f=e.trim(a.attr("class")),a={"class":b+" "+f,src:j,_ke_realelement:encodeURIComponent(h||a._4e_outerHtml(void 0)),_ke_real_node_type:a[0].nodeType,style:q};o&&delete o.width;
o&&delete o.height;o&&e.mix(a,o,!1);c&&(a._ke_real_element_type=c);d&&(a._ke_resizable=d);return new i("<img/>",a,this.get("document")[0])},restoreRealElement:function(a){if(a.attr("_ke_real_node_type")!=d.ELEMENT_NODE)return null;var a=decodeURIComponent(a.attr("_ke_realelement")),b=new i("<div>",null,this.get("document")[0]);b.html(a);return b.first().remove()}});var c={tags:{$:function(a){var c=a.getAttribute("_ke_realelement"),d;c&&(d=(new b.Parser(decodeURIComponent(c))).parse());if(c=d&&d.childNodes[0]){if(d=
a.getAttribute("style")){var e=/(?:^|\s)width\s*:\s*(\d+)/i.exec(d),a=e&&e[1];d=(e=/(?:^|\s)height\s*:\s*(\d+)/i.exec(d))&&e[1];a&&c.setAttribute("width",a);d&&c.setAttribute("height",d)}return c}}}};return{init:function(a){var d=(a=a.htmlDataProcessor)&&a.htmlFilter;a.createFakeParserElement||(d&&d.addRules(c),e.mix(a,{createFakeParserElement:function(a,c,d,g,h){var f;f=new b.BasicWriter;a.writeHtml(f);f=f.getHtml();var i=a.getAttribute("style")||"";a.getAttribute("width")&&(i="width:"+a.getAttribute("width")+
"px;"+i);a.getAttribute("height")&&(i="height:"+a.getAttribute("height")+"px;"+i);var p=e.trim(a.getAttribute("class")),a={"class":c+" "+p,src:j,_ke_realelement:encodeURIComponent(f),_ke_real_node_type:a.nodeType+"",style:i,align:a.getAttribute("align")||""};h&&delete h.width;h&&delete h.height;h&&e.mix(a,h,!1);d&&(a._ke_real_element_type=d);g&&(a._ke_resizable="_ke_resizable");return new b.Tag("img",a)}}))}}},{requires:["editor"]});
KISSY.add("editor/plugin/flashBridge/index",function(e,h,i){function d(a){this._init(a)}function j(a){var c=e.isString(a)?a.match(/(\d)+/g):a;e.isArray(c)&&(a=parseFloat(c[0]+"."+b(c[1],3)+b(c[2],5)));return a||0}function b(a,b){for(var c=(a+"").length;c++<b;)a="0"+a;return a}var c={};e.augment(d,e.EventTarget,{_init:function(a){var b=e.guid("flashbridge-");a.flashVars=a.flashVars||{};a.attrs=a.attrs||{};a.params=a.params||{};var d=a.flashVars,f=a.params;e.mix(a.attrs,{id:b,width:"100%",height:"100%"},
!1);e.mix(f,{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},!1);e.mix(d,{shareData:!1,useCompression:!1},!1);f={YUISwfId:b,YUIBridgeCallback:"KISSY.Editor.FlashBridge.EventHandler"};a.ajbridge&&(f={swfID:b,jsEntry:"KISSY.Editor.FlashBridge.EventHandler"});e.mix(d,f);c[b]=this;this.id=b;this.swf=i.createSWFRuntime(a.movie,a);this._expose(a.methods)},_expose:function(a){for(var b=this,c=0;c<a.length;c++)(function(a){b[a]=function(){return b._callSWF(a,e.makeArray(arguments))}})(a[c])},
_callSWF:function(a,b){b=b||[];try{if(this.swf[a])return this.swf[a].apply(this.swf,b)}catch(c){var d="";0!==b.length&&(d="'"+b.join("', '")+"'");return(new Function("self","return self.swf."+a+"("+d+");"))(this)}},_eventHandler:function(a){var b=a.type;"log"!==b&&b&&this.fire(b,a)},ready:function(a){if(this._ready)a.call(this);else this.on("contentReady",a)},destroy:function(){delete c[this.id]}});d.EventHandler=function(a,b){var d=c[a];d&&setTimeout(function(){d._eventHandler.call(d,b)},100)};h.FlashBridge=
d;var a=e.UA,g,k,m=!0;a.fpv=function(a){if(a||m){m=!1;var b;if(navigator.plugins&&navigator.mimeTypes.length)b=(navigator.plugins["Shockwave Flash"]||{}).description;else if(window.ActiveXObject)try{b=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(c){}g=!b?void 0:b.match(/(\d)+/g);k=j(g)}return g};a.fpvGEQ=function(b,c){m&&a.fpv(c);return!!k&&k>=j(b)};return d},{requires:["editor","../flashCommon/utils"]});
KISSY.add("editor/plugin/flashCommon/baseClass",function(e,h,i,d,j,b){function c(){c.superclass.constructor.apply(this,arguments);this._init()}var a=e.Node;c.ATTRS={cls:{},type:{},label:{value:"\u5728\u65b0\u7a97\u53e3\u67e5\u770b"},contextMenuId:{},contextMenuHandlers:{}};e.extend(c,e.Base,{_init:function(){var a=this,b=a.get("cls"),c=a.get("editor"),j=[],i=a.get("contextMenuId"),q=a.get("contextMenuHandlers");e.each(q,function(a,b){j.push({content:b})});c.addContextMenu(i,"."+b,{width:"120px",children:j,listeners:{click:{fn:function(a){a=
a.target.get("content");q[a]&&q[a].call(this)}}}});d.register({filter:function(a){return a.hasClass(b,void 0)&&a},editor:c,init:function(){var b=this,d=b.get("contentEl");d.html(e.substitute(' <a class="ks-editor-bubbleview-url" target="_blank" href="#">{label}</a>   |    <span class="ks-editor-bubbleview-link ks-editor-bubbleview-change">\u7f16\u8f91</span>   |    <span class="ks-editor-bubbleview-link ks-editor-bubbleview-remove">\u5220\u9664</span>',{label:a.get("label")}));var j=d.one(".ks-editor-bubbleview-url"),
k=d.one(".ks-editor-bubbleview-change"),i=d.one(".ks-editor-bubbleview-remove");h.Utils.preventFocus(d);k.on("click",function(c){a.show(b.selectedEl);c.halt()});i.on("click",function(a){if(e.UA.webkit){var d=c.getSelection().getRanges();if(d=d&&d[0])d.collapse(!0),d.select()}b.selectedEl.remove();b.hide();c.notifySelectionChange();a.halt()});b.on("show",function(){var c=b.selectedEl;c&&a._updateTip(j,c)})}});c.docReady(function(){c.get("document").on("dblclick",a._dbClick,a)})},_getFlashUrl:function(a){return b.getUrl(a)},
_updateTip:function(a,b){var c=this.get("editor").restoreRealElement(b);c&&(c=this._getFlashUrl(c),a.attr("href",c))},_dbClick:function(b){var c=new a(b.target);"img"===c.nodeName()&&c.hasClass(this.get("cls"),void 0)&&(this.show(c),b.halt())},show:function(a){var b=this.get("editor");j.useDialog(b,this.get("type")+"/dialog",a)}});return c},{requires:["editor","../contextmenu/","../bubbleview/","../dialogLoader/","./utils"]});
KISSY.add("editor/plugin/flashCommon/utils",function(e){var h=e.DOM,i=e.Node,d=e.UA,j={insertFlash:function(b,c,a,d,e){c=j.createSWF(c,{attrs:a},b.get("document")[0]);a=b.createFakeElement(c.el,d||"ke_flash",e||"flash",!0,c.html,a);b.insertElement(a);return a},isFlashEmbed:function(b){return"application/x-shockwave-flash"==b.getAttribute("type")||/\.swf(?:$|\?)/i.test(b.getAttribute("src")||"")},getUrl:function(b){var c="";if("object"==b.nodeName())for(var b=b[0].childNodes,a=0;a<b.length;a++)1==
b[a].nodeType&&("movie"==(h.attr(b[a],"name")||"").toLowerCase()?c=h.attr(b[a],"value"):"embed"==h.nodeName(b[a])?c=h.attr(b[a],"src"):"object"==h.nodeName(b[a])&&(c=h.attr(b[a],"data")));else"embed"==b.nodeName()&&(c=b.attr("src"));return c},createSWF:function(b,c,a){var d=c.attrs||{},j=c.flashVars,h="",n="",c=c.params||{},o="",a=a||document;e.mix(d,{wmode:"transparent"});for(var q in d)d.hasOwnProperty(q)&&(h+=q+"='"+d[q]+"' ");e.mix(c,{quality:"high",movie:b,wmode:"transparent"});for(var f in c)c.hasOwnProperty(f)&&
(n+="<param name='"+f+"' value='"+c[f]+"'/>");if(j){for(var l in j)j.hasOwnProperty(l)&&(o+="&"+l+"="+encodeURIComponent(j[l]));o=o.substring(1)}b="<object "+h+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+n+(o?'<param name="flashVars" value="'+o+'"/>':"")+"<embed "+h+" "+(o?'FlashVars="'+o+'"':"")+' pluginspage="http://www.macromedia.com/go/getflashplayer"  quality="high"  src="'+b+'"  type="application/x-shockwave-flash"/></object>';return{el:new i(b,null,a),html:b}},createSWFRuntime2:function(b,
c,a){var a=a||document,e=(new i("<div style='width:0;height:0;overflow:hidden;'>",null,a)).appendTo(a.body),e=j.createSWF.apply(this,arguments).el.appendTo(e);d.ie||(e=e.one("object"));return e[0]},createSWFRuntime:function(b,c,a){var g=c.attrs||{},j=c.flashVars||{},m=c.params||{},n="",o="",q="",a=a||document;g.id=g.id||e.guid("ks-editor-runtimeflash-");for(var f in g)g.hasOwnProperty(f)&&(n+=f+"='"+g[f]+"' ");for(var l in m)m.hasOwnProperty(l)&&(o+="<param name='"+l+"' value='"+m[l]+"'/>");for(var p in j)j.hasOwnProperty(p)&&
(q+="&"+p+"="+encodeURIComponent(j[p]));var q=q.substring(1),b=d.ie?"<object "+n+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+o+'<param name="movie" value="'+b+'" />'+(q?'<param name="flashVars" value="'+q+'" />':"")+"</object>":"<object type='application/x-shockwave-flash' data='"+b+"' "+n+">"+o+(q?'<param name="flashVars" value="'+q+'"/>':"")+"</object>",w=c.holder;w||(w=(new i("<div style='"+(c.style?c.style:"width:1px;height:1px;position:absolute;NaN")+"'>",null,a)).appendTo(a.body),
setTimeout(function(){w.offset({left:h.scrollLeft(),top:h.scrollTop()})},100));w.html(b);return a.getElementById(g.id)}};return j});
KISSY.add("editor/plugin/flash/index",function(e,h,i,d){return{init:function(e){var b=e.htmlDataProcessor;b.dataFilter.addRules({tags:{object:function(a){var c;if(!a.getAttribute("classid")){var e=a.childNodes;for(c=0;c<e.length;c++)if("embed"==e[c].nodeName)if(d.isFlashEmbed(e[c][c]))break;else return b.createFakeParserElement(a,"ke_flash","flash",!0);return null}return b.createFakeParserElement(a,"ke_flash","flash",!0)},embed:function(a){return d.isFlashEmbed(a)?b.createFakeParserElement(a,"ke_flash",
"flash",!0):null}}},5);var c=e.get("pluginConfig").flash||{},a=new i({editor:e,cls:"ke_flash",type:"flash",contextMenuId:"flash-contextmenu",contextMenuHandlers:{"Flash\u5c5e\u6027":function(){var b=this.get("editorSelectedEl");b&&a.show(b)}}});!1!==c.btn&&e.addButton("flash",{tooltip:"\u63d2\u5165Flash",mode:h.WYSIWYG_MODE},{offClick:function(){a.show()}})}}},{requires:["editor","../flashCommon/baseClass","../flashCommon/utils"]});
KISSY.add("editor/plugin/focusFix/index",function(e,h){function i(){var c=this._focusEditor=b.currentInstance();if(j.ie&&c){window.focus();document.body.focus();var a=c.get("document")[0].selection.createRange();a&&a.item&&a.item(0).ownerDocument==c.get("document")[0]&&(c=document.body.createTextRange(),c.moveToElementText(this.get("el").first()[0]),c.collapse(!0),c.select())}}function d(){var b=this._focusEditor;b&&b.focus()}var j=e.UA,b=h.focusManager;return{init:function(b){b.on("beforeVisibleChange",
function(a){a.newVal&&i.call(b)});b.on("hide",function(){d.call(b)})}}},{requires:["editor"]});KISSY.add("editor/plugin/fontFamily/cmd",function(e,h,i){var d={element:"span",styles:{"font-family":"#(value)"},overrides:[{element:"font",attributes:{face:null}}]};return{init:function(e){i.addSelectCmd(e,"fontFamily",d)}}},{requires:["editor","../font/cmd"]});
KISSY.add("editor/plugin/fontFamily/index",function(e,h,i,d){return{init:function(j){d.init(j);var b=j.get("pluginConfig").fontFamily,b=b||{};e.mix(b,{children:[{content:"\u5b8b\u4f53",value:"SimSun"},{content:"\u9ed1\u4f53",value:"SimHei"},{content:"\u96b6\u4e66",value:"LiSu"},{content:"\u6977\u4f53",value:"KaiTi_GB2312"},{content:"\u5fae\u8f6f\u96c5\u9ed1",value:"Microsoft YaHei"},{content:"Georgia",value:"Georgia"},{content:"Times New Roman",value:"Times New Roman"},{content:"Impact",value:"Impact"},{content:"Courier New",value:"Courier New"},{content:"Arial",
value:"Arial"},{content:"Verdana",value:"Verdana"},{content:"Tahoma",value:"Tahoma"}],width:"130px"},!1);e.each(b.children,function(b){var a=b.elAttrs||{},d=b.value;a.style=a.style||"";a.style+=";font-family:"+d;b.elAttrs=a});j.addSelect("fontFamily",{cmdType:"fontFamily",defaultCaption:"\u5b57\u4f53",width:130,mode:h.WYSIWYG_MODE,menu:{width:b.width,children:b.children}},void 0,i.Select)}}},{requires:["editor","../font/ui","./cmd"]});
KISSY.add("editor/plugin/fontSize/cmd",function(e,h,i){var d={element:"span",styles:{"font-size":"#(value)"},overrides:[{element:"font",attributes:{size:null}}]};return{init:function(e){i.addSelectCmd(e,"fontSize",d)}}},{requires:["editor","../font/cmd"]});
KISSY.add("editor/plugin/fontSize/index",function(e,h,i,d){return{init:function(j){d.init(j);var b=j.get("pluginConfig").fontSize,b=b||{};e.mix(b,{children:function(b){var a=[];e.each(b,function(b){a.push({content:b,value:b})});return a}("8px,10px,12px,14px,18px,24px,36px,48px,60px,72px,84px,96px".split(",")),width:"55px"},!1);j.addSelect("fontSize",{cmdType:"fontSize",defaultCaption:"\u5927\u5c0f",width:"55px",mode:h.WYSIWYG_MODE,menu:{width:b.width,children:b.children}},void 0,i.Select)}}},{requires:["editor",
"../font/ui","./cmd"]});
KISSY.add("editor/plugin/font/cmd",function(e,h){var i=h.Utils.getQueryCmd;return{addButtonCmd:function(d,e,b){var c=i(e);d.hasCommand(e)||(d.addCommand(e,{exec:function(a,c){var d=a.get("document")[0];a.execCommand("save");c||void 0===c?b.apply(d):b.remove(d);a.execCommand("save");a.notifySelectionChange()}}),d.addCommand(c,{exec:function(a,c){return b.checkActive(c)}}))},addSelectCmd:function(d,e,b){var c=i(e);d.hasCommand(e)||(d.addCommand(e,{exec:function(a,c,d){var c=new h.Style(b,{value:c}),
e=a.get("document")[0];a.execCommand("save");void 0===d||d?c.apply(e):c.remove(e);a.execCommand("save")}}),d.addCommand(c,{exec:function(a,c,d){return(new h.Style(b,{value:c})).checkElementRemovable(d,!0)}}))}}},{requires:["editor"]});
KISSY.add("editor/plugin/font/ui",function(e,h,i,d){var j=h.Utils.getQueryCmd,e=d.extend({click:function(b){var c=b.target.get("value"),a=this.get("cmdType"),b=b.prevTarget&&b.prevTarget.get("value"),d=this.get("editor");d.focus();c==b?d.execCommand(a,c,!1):d.execCommand(a,c)},selectionChange:function(b){var c=b.path,b=j(this.get("cmdType")),a=this.get("menu"),a=a.get&&a.get("children"),d=this.get("editor"),c=c.elements;if(a){for(var e=0,h;e<c.length;e++){h=c[e];for(var i=0;i<a.length;i++){var o=
a[i].get("value");if(d.execCommand(b,o,h)){this.set("value",o);return}}}this.set("value",null)}}});return{Button:i.Toggle.extend({offClick:function(){var b=this.get("cmdType"),c=this.get("editor");c.execCommand(b);c.focus()},onClick:function(){var b=this.get("cmdType"),c=this.get("editor");c.execCommand(b,!1);c.focus()},selectionChange:function(b){var c=this.get("editor"),a=j(this.get("cmdType"));c.execCommand(a,b.path)?this.set("checked",!0):this.set("checked",!1)}},{ATTRS:{mode:{value:h.WYSIWYG_MODE}}}),
Select:e}},{requires:["editor","../button/","../select/"]});KISSY.add("editor/plugin/foreColor/cmd",function(e,h){var i={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}],childRule:function(d){return!("a"==d.nodeName()||d.all("a").length)}};return{init:function(d){d.hasCommand("foreColor")||d.addCommand("foreColor",{exec:function(d,b){d.execCommand("save");h.applyColor(d,b,i);d.execCommand("save")}})}}},{requires:["../color/cmd"]});
KISSY.add("editor/plugin/foreColor/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("foreColor",{cmdType:"foreColor",tooltip:"\u6587\u672c\u989c\u8272"},void 0,i)}}},{requires:["editor","../color/btn","./cmd"]});
KISSY.add("editor/plugin/heading/cmd",function(e,h){return{init:function(e){if(!e.hasCommand("heading")){e.addCommand("heading",{exec:function(d,b){d.execCommand("save");(new h.Style({element:b})).apply(d.get("document")[0]);d.execCommand("save")}});var d=h.Utils.getQueryCmd("heading");e.addCommand(d,{exec:function(d,b,c){return(new h.Style({element:c})).checkActive(b)}})}}}},{requires:["editor"]});
KISSY.add("editor/plugin/heading/index",function(e,h,i){return{init:function(d){i.init(d);var e=[],b={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},c={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},a;for(a in b)b.hasOwnProperty(a)&&e.push({content:a,value:b[a],elAttrs:{style:"font-size:"+c[b[a]]}});d.addSelect("heading",{defaultCaption:"\u6807\u9898",width:"120px",menu:{width:"120px",children:e},mode:h.WYSIWYG_MODE},{click:function(a){var b=a.target.get("value"),
a=a.prevTarget&&a.prevTarget.get("value");b!=a?d.execCommand("heading",b):(d.execCommand("heading","p"),this.set("value","p"))},selectionChange:function(a){var a=a.path,b=h.Utils.getQueryCmd("heading"),e;for(e in c)if(c.hasOwnProperty(e)&&d.execCommand(b,a,e)){this.set("value",e);break}}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/image/index",function(e,h,i,d,j,b){var c=e.UA,a=e.Node,g=e.all,k=e.Event,m=function(a){a=g(a);return"img"===a.nodeName(a)&&!/(^|\s+)ke_/.test(a[0].className)&&a};return{init:function(j){function i(a){b.useDialog(j,"image/dialog",a)}j.addButton("image",{tooltip:"\u63d2\u5165\u56fe\u7247",mode:h.WYSIWYG_MODE},{offClick:function(){i(null)}});var q=[{content:"\u56fe\u7247\u5c5e\u6027",fn:function(){var a=m(this.get("editorSelectedEl"));a&&(this.hide(),i(g(a)))}},{content:"\u63d2\u5165\u65b0\u884c",fn:function(){this.hide();var b=j.get("document")[0],
d=new a(b.createElement("p"));c.ie||d._4e_appendBogus(void 0);b=new h.Range(b);b.setStartAfter(this.get("editorSelectedEl"));b.select();j.insertElement(d);b.moveToElementEditablePosition(d,1);b.select()}}],f=[];e.each(q,function(a){f.push({content:a.content})});j.addContextMenu("image-contextmenu",m,{width:120,children:f,listeners:{click:{fn:function(a){var b=this,c=a.target.get("content");e.each(q,function(a){a.content==c&&a.fn.call(b)})}}}});j.docReady(function(){k.on(j.get("document")[0],"dblclick",
function(a){a.halt();a=g(a.target);m(a)&&i(a)})});d.register({editor:j,filter:m,init:function(){var a=this,b=a.get("contentEl");b.html('<a class="ks-editor-bubbleview-url" target="_blank" href="#">\u5728\u65b0\u7a97\u53e3\u67e5\u770b</a>  |  <a class="ks-editor-bubbleview-link ks-editor-bubbleview-change" href="#">\u7f16\u8f91</a>  |  <a class="ks-editor-bubbleview-link ks-editor-bubbleview-remove" href="#">\u5220\u9664</a>');var d=b.one(".ks-editor-bubbleview-url"),f=b.one(".ks-editor-bubbleview-change"),e=b.one(".ks-editor-bubbleview-remove");
h.Utils.preventFocus(b);f.on("click",function(b){i(a.selectedEl);b.halt()});e.on("click",function(b){if(c.webkit){var d=j.getSelection().getRanges();d&&d[0]&&(d[0].collapse(),d[0].select())}a.selectedEl.remove();a.hide();j.notifySelectionChange();b.halt()});a.on("show",function(){var b=a.selectedEl;b&&(b=b.attr("_ke_saved_src")||b.attr("src"),d.attr("href",b))})}})}}},{requires:["editor","../button/","../bubbleview/","../contextmenu/","../dialogLoader/"]});
KISSY.add("editor/plugin/indent/cmd",function(e,h,i){var d=i.addCommand;return{init:function(e){d(e,"indent")}}},{requires:["editor","../dentUtils/cmd"]});KISSY.add("editor/plugin/indent/index",function(e,h,i){return{init:function(d){i.init(d);d.addButton("indent",{tooltip:"\u589e\u52a0\u7f29\u8fdb\u91cf ",mode:h.WYSIWYG_MODE},{offClick:function(){d.execCommand("indent");d.focus()}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/italic/cmd",function(e,h,i){var d=new h.Style({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]});return{init:function(e){i.addButtonCmd(e,"italic",d)}}},{requires:["editor","../font/cmd"]});KISSY.add("editor/plugin/italic/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("italic",{cmdType:"italic",tooltip:"\u659c\u4f53 "},void 0,i.Button)}}},{requires:["editor","../font/ui","./cmd"]});
KISSY.add("editor/plugin/justifyCenter/cmd",function(e,h){return{init:function(e){h.addCommand(e,"justifyCenter","center")}}},{requires:["../justifyUtils/cmd"]});
KISSY.add("editor/plugin/justifyCenter/index",function(e,h,i){function d(){var d=this.get("editor");d.execCommand("justifyCenter");d.focus()}return{init:function(e){i.init(e);e.addButton("justifyCenter",{tooltip:"\u5c45\u4e2d\u5bf9\u9f50",checkable:!0,mode:h.WYSIWYG_MODE},{onClick:d,offClick:d,selectionChange:function(b){var c=h.Utils.getQueryCmd("justifyCenter");e.execCommand(c,b.path)?this.set("checked",!0):this.set("checked",!1)}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/justifyLeft/cmd",function(e,h){return{init:function(e){h.addCommand(e,"justifyLeft","left")}}},{requires:["../justifyUtils/cmd"]});
KISSY.add("editor/plugin/justifyLeft/index",function(e,h,i){function d(){var d=this.get("editor");d.execCommand("justifyLeft");d.focus()}return{init:function(e){i.init(e);e.addButton("justifyLeft",{tooltip:"\u5de6\u5bf9\u9f50",checkable:!0,mode:h.WYSIWYG_MODE},{onClick:d,offClick:d,selectionChange:function(b){var c=h.Utils.getQueryCmd("justifyLeft");e.execCommand(c,b.path)?this.set("checked",!0):this.set("checked",!1)}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/justifyRight/cmd",function(e,h){return{init:function(e){h.addCommand(e,"justifyRight","right")}}},{requires:["../justifyUtils/cmd"]});
KISSY.add("editor/plugin/justifyRight/index",function(e,h,i){function d(){var d=this.get("editor");d.execCommand("justifyRight");d.focus()}return{init:function(e){i.init(e);e.addButton("justifyRight",{tooltip:"\u53f3\u5bf9\u9f50",checkable:!0,mode:h.WYSIWYG_MODE},{onClick:d,offClick:d,selectionChange:function(b){var c=h.Utils.getQueryCmd("justifyRight");e.execCommand(c,b.path)?this.set("checked",!0):this.set("checked",!1)}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/justifyUtils/cmd",function(e,h){var i=/(-moz-|-webkit-|start|auto)/gi;return{addCommand:function(d,e,b){d.hasCommand(e)||(d.addCommand(e,{exec:function(c){c.execCommand("save");for(var a=c.getSelection(),d=a.createBookmarks(),e=a.getRanges(),h,j,o=e.length-1;0<=o;o--){h=e[o].createIterator();for(h.enlargeBr=!0;j=h.getNextParagraph();)j.removeAttr("align"),(j.css("text-align").replace(i,"")||"left")==b?j.css("text-align",""):j.css("text-align",b)}a.selectBookmarks(d);c.execCommand("save");
c.notifySelectionChange()}}),d.addCommand(h.Utils.getQueryCmd(e),{exec:function(c,a){var d=a.block||a.blockLimit;return!d||"body"===d.nodeName()?!1:(d.css("text-align").replace(i,"")||"left")==b}}))}}},{requires:["editor"]});
KISSY.add("editor/plugin/link/index",function(e,h,i,d,j){function b(a){a=c(a);return a.closest("a",void 0)}var c=e.all;return{init:function(a){a.addButton("link",{tooltip:"\u63d2\u5165\u94fe\u63a5",mode:h.WYSIWYG_MODE},{offClick:function(){j.useDialog(a,"link/dialog",void 0)}});i.register({editor:a,filter:b,init:function(){var b=this,c=b.get("contentEl");c.html('<a href=""  target="_blank" class="ks-editor-bubbleview-url">\u5728\u65b0\u7a97\u53e3\u67e5\u770b</a>  \u2013   <span class="ks-editor-bubbleview-link ks-editor-bubbleview-change">\u7f16\u8f91</span>   |    <span class="ks-editor-bubbleview-link ks-editor-bubbleview-remove">\u53bb\u9664</span>');
var e=c.one(".ks-editor-bubbleview-url"),i=c.one(".ks-editor-bubbleview-change"),o=c.one(".ks-editor-bubbleview-remove");h.Utils.preventFocus(c);i.on("click",function(c){j.useDialog(a,"link/dialog",b.selectedEl);c.halt()});o.on("click",function(c){d.removeLink(a,b.selectedEl);c.halt()});b.on("show",function(){var a=b.selectedEl;a&&(a=a.attr(d._ke_saved_href)||a.attr("href"),e.html(a),e.attr("href",a))})}})}}},{requires:["editor","../bubbleview/","./utils","../dialogLoader/"]});
KISSY.add("editor/plugin/link/utils",function(e,h){var i=e.Node,d=h.Style,j={element:"a",attributes:{href:"#(href)",title:"#(title)",_ke_saved_href:"#(_ke_saved_href)",target:"#(target)"}};return{removeLink:function(b,c){b.execCommand("save");var a=b.getSelection(),e=a.getRanges()[0];if(e&&e.collapsed)e=a.createBookmarks(),c._4e_remove(!0),a.selectBookmarks(e);else if(e){for(var a=c[0],e=a.attributes,h={},i=0;i<e.length;i++){var n=e[i];n.specified&&(h[n.name]=n.value)}a.style.cssText&&(h.style=a.style.cssText);
(new d(j,h)).remove(b.get("document")[0])}b.execCommand("save");b.notifySelectionChange()},applyLink:function(b,c,a){c._ke_saved_href=c.href;a?(b.execCommand("save"),a.attr(c)):(a=(a=b.getSelection())&&a.getRanges()[0],!a||a.collapsed?(c=new i("<a>"+c.href+"</a>",c,b.get("document")[0]),b.insertElement(c)):(b.execCommand("save"),(new d(j,c)).apply(b.get("document")[0])));b.execCommand("save");b.notifySelectionChange()},_ke_saved_href:"_ke_saved_href"}},{requires:["editor"]});
KISSY.add("editor/plugin/listUtils/btn",function(e,h,i){function d(){var d=this.get("editor"),b=this.get("cmdType");d.execCommand(b);d.focus()}return i.Toggle.extend({offClick:d,onClick:d,selectionChange:function(d){var b=this.get("editor"),c=h.Utils.getQueryCmd(this.get("cmdType"));b.execCommand(c,d.path)?this.set("checked",!0):this.set("checked",!1)}},{ATTRS:{mode:{value:h.WYSIWYG_MODE}}})},{requires:["editor","../button/"]});
KISSY.add("editor/plugin/listUtils/cmd",function(e,h,i,d){function j(a){this.type=a}function b(a,b){var d,e,g=b.blockLimit,h=b.elements;if(!g)return!1;if(h)for(var i=0;i<h.length&&(d=h[i])&&d[0]!==g[0];i++)if(c[e=d.nodeName()]&&e==a)return!0;return!1}var c={ol:"insertOrderedList",ul:"insertUnorderedList"},a=h.RANGE,g=h.ElementPath,k=h.Walker,m=e.UA,n=e.Node,o=e.DOM,q=/^h[1-6]$/;j.prototype={changeListType:function(a,b,c,e){for(var g=i.listToArray(b.root,c,d,d,d),h=[],a=0;a<b.contents.length;a++){var j=
b.contents[a];if((j=j.closest("li",d))&&j[0]&&!j.data("list_item_processed"))h.push(j),j._4e_setMarker(c,"list_item_processed",!0,d)}j=new n(b.root[0].ownerDocument.createElement(this.type));for(a=0;a<h.length;a++){var k=h[a].data("listarray_index");g[k].parent=j}for(var c=i.arrayToList(g,c,null,"p"),m,g=c.listNode.childNodes.length,a=0;a<g&&(m=new n(c.listNode.childNodes[a]));a++)m.nodeName()==this.type&&e.push(m);b.root.before(c.listNode);b.root.remove()},createList:function(a,b,c){var e=b.contents,
a=b.root[0].ownerDocument,g=[];if(1==e.length&&e[0][0]===b.root[0]){var h=new n(a.createElement("div"));e[0][0].nodeType!=o.TEXT_NODE&&e[0]._4e_moveChildren(h,d,d);e[0][0].appendChild(h[0]);e[0]=h}b=b.contents[0].parent();for(h=0;h<e.length;h++)b=b._4e_commonAncestor(e[h].parent(),d);for(h=0;h<e.length;h++)for(var j=e[h],i;i=j.parent();){if(i[0]===b[0]){g.push(j);break}j=i}if(!(1>g.length)){e=new n(g[g.length-1][0].nextSibling);h=new n(a.createElement(this.type));for(c.push(h);g.length;)c=g.shift(),
j=new n(a.createElement("li")),q.test(c.nodeName())?j[0].appendChild(c[0]):(c._4e_copyAttributes(j,d,d),c._4e_moveChildren(j,d,d),c.remove()),h[0].appendChild(j[0]),m.ie||j._4e_appendBogus(d);e[0]?h.insertBefore(e,d):b.append(h)}},removeList:function(a,b,c){function e(c){if((x=new n(q[c?"firstChild":"lastChild"]))&&!(x[0].nodeType==o.ELEMENT_NODE&&x._4e_isBlockBoundary(d,d))&&(v=b.root[c?"prev":"next"](k.whitespaces(!0),1))&&!(x[0].nodeType==o.ELEMENT_NODE&&v._4e_isBlockBoundary({br:1},d)))x[c?"before":
"after"](a.get("document")[0].createElement("br"))}for(var g=i.listToArray(b.root,c,d,d,d),h=[],j=0;j<b.contents.length;j++){var m=b.contents[j];if((m=m.closest("li",d))&&!m.data("list_item_processed"))h.push(m),m._4e_setMarker(c,"list_item_processed",!0,d)}m=null;for(j=0;j<h.length;j++)m=h[j].data("listarray_index"),g[m].indent=-1;for(j=m+1;j<g.length;j++)if(g[j].indent>Math.max(g[j-1].indent,0)){h=g[j-1].indent+1-g[j].indent;for(m=g[j].indent;g[j]&&g[j].indent>=m;)g[j].indent+=h,j++;j--}var q=i.arrayToList(g,
c,null,"p").listNode,x,v;e(!0);e(d);b.root.before(q);b.root.remove()},exec:function(e){var j=e.getSelection(),i=j&&j.getRanges();if(i&&!(1>i.length)){for(var m=j.getStartElement(),m=new h.ElementPath(m),n=b(this.type,m),m=j.createBookmarks(!0),q=[],r={};0<i.length;){var t=i.shift(),z=t.getBoundaryNodes(),x=z.startNode,v=z.endNode;x[0].nodeType==o.ELEMENT_NODE&&"td"==x.nodeName()&&t.setStartAt(z.startNode,a.POSITION_AFTER_START);v[0].nodeType==o.ELEMENT_NODE&&"td"==v.nodeName()&&t.setEndAt(z.endNode,
a.POSITION_BEFORE_END);t=t.createIterator();for(t.forceBrBreak=!1;z=t.getNextParagraph();)if(!z.data("list_block")){z._4e_setMarker(r,"list_block",1,d);for(var v=new g(z),u=v.elements,B=null,C=!1,B=v.blockLimit,A,x=u.length-1;0<=x&&(A=u[x]);x--)if(c[A.nodeName()]&&B.contains(A)){B.removeData("list_group_object");(x=A.data("list_group_object"))?x.contents.push(z):(x={root:A,contents:[z]},q.push(x),A._4e_setMarker(r,"list_group_object",x,d));C=!0;break}C||(v=B||v.block,v.data("list_group_object")?v.data("list_group_object").contents.push(z):
(x={root:v,contents:[z]},v._4e_setMarker(r,"list_group_object",x,d),q.push(x)))}}for(i=[];0<q.length;)x=q.shift(),n?c[x.root.nodeName()]&&this.removeList(e,x,r):c[x.root.nodeName()]?this.changeListType(e,x,r,i):(h.Utils.clearAllMarkers(r),this.createList(e,x,i));for(var F=this,x=0;x<i.length;x++)B=i[x],e=function(a,b){var c=b[a?"prev":"next"](k.whitespaces(!0),1);c&&c[0]&&c.nodeName()==F.type&&(c.remove(),c._4e_moveChildren(b,a?!0:!1,d))},e(d,B),e(!0,B);h.Utils.clearAllMarkers(r);j.selectBookmarks(m)}}};
new j("ul");new j("ol");return{ListCommand:j,queryActive:b}},{requires:["editor","../listUtils/"]});
KISSY.add("editor/plugin/listUtils/index",function(e){var h={ol:1,ul:1},i=e.Node,d=e.DOM,j=e.UA,b={listToArray:function(c,a,e,j,m){if(!h[c.nodeName()])return[];j||(j=0);e||(e=[]);for(var n=0,o=c[0].childNodes.length;n<o;n++){var q=new i(c[0].childNodes[n]);if("li"==q.nodeName()){var f={parent:c,indent:j,element:q,contents:[]};m?f.grandparent=m:(f.grandparent=c.parent(),f.grandparent&&"li"==f.grandparent.nodeName()&&(f.grandparent=f.grandparent.parent()));a&&q._4e_setMarker(a,"listarray_index",e.length,
void 0);e.push(f);for(var l=0,p=q[0].childNodes.length,w;l<p;l++)w=new i(q[0].childNodes[l]),w[0].nodeType==d.ELEMENT_NODE&&h[w.nodeName()]?b.listToArray(w,a,e,j+1,f.grandparent):f.contents.push(w)}}return e},arrayToList:function(c,a,e,k){e||(e=0);if(!c||c.length<e+1)return null;for(var m=c[e].parent[0].ownerDocument,n=m.createDocumentFragment(),o=null,q=e,f=Math.max(c[e].indent,0),l=null;;){var p=c[q];if(p.indent==f){if(!o||c[q].parent.nodeName()!=o.nodeName())o=c[q].parent.clone(!1),n.appendChild(o[0]);
for(var l=o[0].appendChild(p.element.clone(!1)[0]),w=0;w<p.contents.length;w++)l.appendChild(p.contents[w].clone(!0)[0]);q++}else if(p.indent==Math.max(f,0)+1)q=b.arrayToList(c,null,q,k),l.appendChild(q.listNode),q=q.nextIndex;else if(-1==p.indent&&!e&&p.grandparent){h[p.grandparent.nodeName()]?l=p.element.clone(!1)[0]:"td"!=p.grandparent.nodeName()?(l=m.createElement(k),p.element._4e_copyAttributes(new i(l))):l=m.createDocumentFragment();for(w=0;w<p.contents.length;w++)o=p.contents[w].clone(!0),
l.nodeType==d.DOCUMENT_FRAGMENT_NODE&&p.element._4e_copyAttributes(new i(o)),l.appendChild(o[0]);l.nodeType==d.DOCUMENT_FRAGMENT_NODE&&q!=c.length-1&&(l.lastChild&&l.lastChild.nodeType==d.ELEMENT_NODE&&"_moz"==l.lastChild.getAttribute("type")&&d._4e_remove(l.lastChild),d._4e_appendBogus(l));l.nodeType==d.ELEMENT_NODE&&d.nodeName(l)==k&&l.firstChild&&(d._4e_trim(l),o=l.firstChild,o.nodeType==d.ELEMENT_NODE&&d._4e_isBlockBoundary(o)&&(o=m.createDocumentFragment(),d._4e_moveChildren(l,o),l=o));o=d.nodeName(l);
!j.ie&&("div"==o||"p"==o)&&d._4e_appendBogus(l);n.appendChild(l);o=null;q++}else return null;if(c.length<=q||Math.max(c[q].indent,0)<f)break}if(a)for(c=new i(n.firstChild);c&&c[0];)c[0].nodeType==d.ELEMENT_NODE&&c._4e_clearMarkers(a,!0),c=c._4e_nextSourceNode();return{listNode:n,nextIndex:q}}};return b},{requires:["editor"]});
KISSY.add("editor/plugin/localStorage/index",function(e,h,i,d){if(!e.UA.ie&&window.localStorage)return window.localStorage;var j=h.Utils.debugUrl("plugin/localStorage/swfstore.swf?t="+ +new Date),b=new d({movie:j,flashVars:{useCompression:!0},methods:["setItem","removeItem","getItem","setMinDiskSpace","getValueOf"]});b.swf.height=138;var c=new i({width:"0px",prefixCls:"ks-editor-",elStyle:{overflow:"hidden"},content:"<h1 style='border:1px solid black;border-bottom:none;background:white;text-align:center;'>\u8bf7\u70b9\u51fb\u5141\u8bb8</h1>",
zIndex:h.baseZIndex(h.zIndexManager.STORE_FLASH_SHOW)});c.render();c.get("contentEl").append(b.swf);c.center();c.show();b.on("pending",function(){c.set("width",215);c.center();c.show();setTimeout(function(){b.retrySave()},1E3)});b.on("save",function(){c.set("width",0)});var a=b.setItem;e.mix(b,{_ke:1,getItem:function(a){return this.getValueOf(a)},retrySave:function(){this.setItem(this.lastSave.k,this.lastSave.v)},setItem:function(b,c){this.lastSave={k:b,v:c};a.call(this,b,c)}});b.on("contentReady",
function(){b._ready=1});return b},{attach:!1,requires:["editor","overlay","../flashBridge/"]});
KISSY.add("editor/plugin/maximize/cmd",function(e,h){function i(a){this.editor=a}var d=e.UA,j=d.ie,b=document,c=e.Node,a=e.Event,g=e.DOM,k;e.augment(i,{restoreWindow:function(){var b=this,c=b.editor;!1!==c.fire("beforeRestoreWindow")&&b._resize&&(a.remove(window,"resize",b._resize),b._resize=0,b._saveEditorStatus(),b._restoreState(),setTimeout(function(){b._restoreEditorStatus();c.notifySelectionChange();c.fire("restoreWindow")},30))},_restoreState:function(){var a=this.editor,c=this._savedParents;
if(c){for(var d=0;d<c.length;d++){var e=c[d];e.el.css("position",e.position)}this._savedParents=null}a.get("iframeWrapEl").css({height:this.iframeHeight});a.get("textarea").css({height:this.iframeHeight});g.css(b.body,{width:"",height:"",overflow:""});b.documentElement.style.overflow="";a=a.get("el")[0].style;a.position="static";a.width=this.editorElWidth;k.css({left:"-99999px",top:"-99999px"});window.scrollTo(this.scrollLeft,this.scrollTop);8>j&&this.editor.get("toolBarEl").removeClass("ks-editor-toolbar-padding",
void 0)},_saveSate:function(){var a=this.editor,b=[],c=a.get("el");this.iframeHeight=a.get("iframeWrapEl").style("height");this.editorElWidth=c.style("width");this.scrollLeft=g.scrollLeft();this.scrollTop=g.scrollTop();window.scrollTo(0,0);for(a=c.parent();a;)c=a.css("position"),"static"!=c&&(b.push({el:a,position:c}),a.css("position","static")),a=a.parent();this._savedParents=b;8>j&&this.editor.get("toolBarEl").addClass("ks-editor-toolbar-padding",void 0)},_saveEditorStatus:function(){var a=this.editor;
this.savedRanges=null;d.gecko&&a.__iframeFocus&&(this.savedRanges=(a=a.getSelection())&&a.getRanges())},_restoreEditorStatus:function(){var a=this.editor,b=a.getSelection(),c=this.savedRanges;d.gecko&&a.activateGecko();c&&b&&b.selectRanges(c);a.__iframeFocus&&b&&(a=b.getStartElement())&&a.scrollIntoView(void 0,!1)},_maximize:function(a){var c=this.editor,d=c.get("el"),e=g.viewportHeight(),f=g.viewportWidth(),i=c.get("statusBarEl")?c.get("statusBarEl")[0].offsetHeight:0,p=c.get("toolBarEl")[0].offsetHeight;
j?b.body.style.overflow="hidden":g.css(b.body,{width:0,height:0,overflow:"hidden"});b.documentElement.style.overflow="hidden";d.css({position:"absolute",zIndex:h.baseZIndex(h.zIndexManager.MAXIMIZE),width:f+"px"});k.css({zIndex:h.baseZIndex(h.zIndexManager.MAXIMIZE-5),height:e+"px",width:f+"px"});d.offset({left:0,top:0});k.css({left:0,top:0});c.get("iframeWrapEl").css({height:e-i-p+"px"});c.get("textarea").css({height:e-i-p+"px"});!0!==a&&arguments.callee.call(this,!0)},_real:function(){var b=this,
c=b.editor;b._resize||(b._saveEditorStatus(),b._saveSate(),b._maximize(),b._resize||(b._resize=e.buffer(function(){b._maximize();c.fire("maximizeWindow")},100)),a.on(window,"resize",b._resize),setTimeout(function(){b._restoreEditorStatus();c.notifySelectionChange();c.fire("maximizeWindow")},30))},maximizeWindow:function(){!1!==this.editor.fire("beforeMaximizeWindow")&&(k||(k=(new c("<iframe  class='ks-editor-maximize-shim' style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'>")).prependTo(b.body,
void 0)),this._real())},destroy:function(){this._resize&&(a.remove(window,"resize",this._resize),this._resize=0)}});return{init:function(a){if(!a.hasCommand("maximizeWindow")){var b=new i(a);a.addCommand("maximizeWindow",{exec:function(){b.maximizeWindow()}});a.addCommand("restoreWindow",{exec:function(){b.restoreWindow()}})}}}},{requires:["editor"]});
KISSY.add("editor/plugin/maximize/index",function(e,h,i){return{init:function(d){i.init(d);d.addButton("maximize",{tooltip:"\u5168\u5c4f",checkable:!0},{onClick:function(){d.execCommand("restoreWindow");this.set("tooltip","\u5168\u5c4f");this.set("contentCls","maximize");d.focus()},offClick:function(){d.execCommand("maximizeWindow");this.set("tooltip","\u53d6\u6d88\u5168\u5c4f");this.set("contentCls","restore");d.focus()}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/multipleUpload/index",function(e,h,i){return{init:function(d){d.addButton("multipleUpload",{tooltip:"\u6279\u91cf\u63d2\u56fe",mode:h.WYSIWYG_MODE},{offClick:function(){i.useDialog(d,"multipleUpload/dialog")}})}}},{requires:["editor","../dialogLoader/"]});
KISSY.add("editor/plugin/orderedList/cmd",function(e,h,i){var d=i.queryActive,j=new i.ListCommand("ol");return{init:function(b){b.hasCommand("insertOrderedList")||b.addCommand("insertOrderedList",{exec:function(a){j.exec(a)}});var c=h.Utils.getQueryCmd("insertOrderedList");b.hasCommand(c)||b.addCommand(c,{exec:function(a,b){return d("ol",b)}})}}},{requires:["editor","../listUtils/cmd"]});
KISSY.add("editor/plugin/orderedList/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("orderedList",{cmdType:"insertOrderedList",mode:h.WYSIWYG_MODE},void 0,i)}}},{requires:["editor","../listUtils/btn","./cmd"]});KISSY.add("editor/plugin/outdent/cmd",function(e,h,i){var d=i.addCommand,j=i.checkOutdentActive;return{init:function(b){d(b,"outdent");var c=h.Utils.getQueryCmd("outdent");b.hasCommand(c)||b.addCommand(c,{exec:function(a,b){return j(b)}})}}},{requires:["editor","../dentUtils/cmd"]});
KISSY.add("editor/plugin/outdent/index",function(e,h,i){return{init:function(d){i.init(d);var e=h.Utils.getQueryCmd("outdent");d.addButton("outdent",{tooltip:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",mode:h.WYSIWYG_MODE},{offClick:function(){d.execCommand("outdent");d.focus()},selectionChange:function(b){d.execCommand(e,b.path)?this.set("disabled",!1):this.set("disabled",!0)}})}}},{requires:["editor","./cmd"]});
KISSY.add("editor/plugin/overlay/index",function(e,h,i,d){var j=i.extend({bindUI:function(){d.init(this)}},{ATTRS:{prefixCls:{value:"ks-editor-"},zIndex:{value:h.baseZIndex(h.zIndexManager.OVERLAY)}}});j.Dialog=i.Dialog.extend({bindUI:function(){d.init(this)},show:function(){this.center();var b=this.get("y");200<b-e.DOM.scrollTop()&&(b=e.DOM.scrollTop()+200,this.set("y",b));j.prototype.show.call(this)}},{ATTRS:{elAttrs:{value:{hideFocus:"hideFocus"}},prefixCls:{value:"ks-editor-"},zIndex:{value:h.baseZIndex(h.zIndexManager.OVERLAY)},
draggable:{value:!0},constrain:{value:!0},aria:{value:!0}}});return j},{requires:["editor","overlay","../focusFix/","dd"]});
KISSY.add("editor/plugin/pageBreak/index",function(e,h,i){var d=e.Node;return{init:function(e){i.init(e);var b=e.htmlDataProcessor;(b&&b.dataFilter).addRules({tags:{div:function(c){var a=c.getAttribute("style"),d;if(a)for(var e=c.childNodes,h=0;h<e.length;h++)1==e[h].nodeType&&(d=e[h]);if((d=d&&"span"==d.nodeName&&d.getAttribute("style"))&&/page-break-after\s*:\s*always/i.test(a)&&/display\s*:\s*none/i.test(d))return b.createFakeParserElement(c,"ke_pagebreak","div")}}});e.addButton("pageBreak",{tooltip:"\u5206\u9875",
mode:h.WYSIWYG_MODE},{offClick:function(){var b=this.get("editor"),a=new d('<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>',null,b.get("document")[0]),a=b.createFakeElement(a,"ke_pagebreak","div",!1,'<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>'),e=b.getSelection();if(e=e&&e.getRanges()[0]){b.execCommand("save");for(var h=e.startContainer,j=h;"body"!==h.nodeName();)j=h,h=h.parent();e.collapse(!0);e.splitElement(j);a.insertAfter(j);
b.execCommand("save")}}})}}},{requires:["editor","../fakeObjects/"]});
KISSY.add("editor/plugin/preview/index",function(){var e=window;return{init:function(h){h.addButton("preview",{tooltip:"\u9884\u89c8"},{offClick:function(){var h=this.get("editor");try{var d=e.screen,j=Math.round(0.8*d.width),b=Math.round(0.7*d.height),c=Math.round(0.1*d.width)}catch(a){j=640,b=420,c=80}h=h.getDocHtml().replace(/\${title}/,"\u9884\u89c8");j=e.open("","","toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+j+",height="+b+",left="+c);b=j.document;b.open();b.write(h);b.close();
j.focus()}})}}});
KISSY.add("editor/plugin/progressbar/index",function(e){function h(){h.superclass.constructor.apply(this,arguments);this._init()}var i=e.Node;h.ATTRS={container:{},width:{},height:{},progress:{value:0}};e.extend(h,e.Base,{destroy:function(){this.detach();this.el.remove()},_init:function(){var d=this.get("height"),e=new i("<div class='ks-editor-progressbar'  style='width:"+this.get("width")+";height:"+d+";'></div>"),b=this.get("container"),d=(new i("<div style='overflow:hidden;'><div class='ks-editor-progressbar-inner' style='height:"+(parseInt(d)-
4)+"px'><div class='ks-editor-progressbar-inner-bg'></div></div></div>")).appendTo(e),c=(new i("<span class='ks-editor-progressbar-title'></span>")).appendTo(e);b&&e.appendTo(b);this.el=e;this._title=c;this._p=d;this.on("afterProgressChange",this._progressChange,this);this._progressChange({newVal:this.get("progress")})},_progressChange:function(d){d=d.newVal;this._p.css("width",d+"%");this._title.html(d+"%")}});return h});
KISSY.add("editor/plugin/removeFormat/cmd",function(e,h){function i(a,b){for(var c=0;c<b.length;c++)a.removeAttr(b[c])}var d=h.RANGE,j=h.ElementPath,b=e.DOM,c="class,style,lang,width,height,align,hspace,valign".split(/,/),a=RegExp("^(?:"+"b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s".replace(/,/g,"|")+")$","i");return{init:function(e){e.hasCommand("removeFormat")||e.addCommand("removeFormat",{exec:function(){e.focus();a.lastIndex=0;var h=e.getSelection().getRanges();
e.execCommand("save");for(var m=0,n;n=h[m];m++)if(!n.collapsed){n.enlarge(d.ENLARGE_ELEMENT);var o=n.createBookmark(),q=o.startNode,f=o.endNode,l=function(b){for(var c=new j(b),d=c.elements,e=1,f;(f=d[e])&&!f.equals(c.block)&&!f.equals(c.blockLimit);e++)a.test(f.nodeName())&&b._4e_breakParent(f)};l(q);l(f);for(q=q._4e_nextSourceNode(!0,b.ELEMENT_NODE,void 0,void 0);q&&!q.equals(f);)l=q._4e_nextSourceNode(!1,b.ELEMENT_NODE,void 0,void 0),"img"==q.nodeName()&&q.attr("_ke_realelement")||(a.test(q.nodeName())?
q._4e_remove(!0):i(q,c)),q=l;n.moveToBookmark(o)}e.getSelection().selectRanges(h);e.execCommand("save")}})}}},{requires:["editor"]});KISSY.add("editor/plugin/removeFormat/index",function(e,h,i){return{init:function(d){i.init(d);d.addButton("removeFormat",{tooltip:"\u6e05\u9664\u683c\u5f0f",mode:h.WYSIWYG_MODE},{offClick:function(){d.execCommand("removeFormat")}})}}},{requires:["editor","./cmd","../button/"]});
KISSY.add("editor/plugin/resize/index",function(e,h,i){var d=e.Node;return{init:function(h){var b=i.Draggable,c=h.get("statusBarEl");h.get("textarea");var a=(h.get("pluginConfig").resize||{}).direction||["x","y"],g="se-resize";1==a.length&&(g="x"==a[0]?"e-resize":"s-resize");var k=(new d("<div class='ks-editor-resizer' style='cursor: "+g+"'></div>")).appendTo(c);h.on("maximizeWindow",function(){k.css("display","none")});h.on("restoreWindow",function(){k.css("display","")});var m=new b({node:k}),n=
0,o=0,q=h.get("el"),f=h.get("el");m.on("dragstart",function(){n=q.height();o=f.width();h.fire("resizeStart")});m.on("drag",function(b){var c=b.left-this.startNodePos.left,b=b.top-this.startNodePos.top;e.inArray("y",a)&&h.set("height",n+b);e.inArray("x",a)&&h.set("width",o+c);h.fire("resize")});h.on("destroy",function(){m.destroy();k.remove()})}}},{requires:["editor","dd"]});
KISSY.add("editor/plugin/select/index",function(e,h,i){h.prototype.addSelect=function(d,j,b,c){var c=c||i.Select,a=this,g=a.get("prefixCls")+"editor-";j&&(j.editor=a,j.menu&&(j.menu.zIndex=h.baseZIndex(h.zIndexManager.SELECT),j.menu.xclass="popupmenu",e.each(j.menu.children,function(a){a.xclass="option"})));var k=new c(e.mix({elAttrs:{hideFocus:"hideFocus"},render:a.get("toolBarEl"),prefixCls:g,autoRender:!0},j));k.get("el").unselectable();e.mix(k,b);if(k.selectionChange)a.on("selectionChange",function(){a.get("mode")!=
h.SOURCE_MODE&&k.selectionChange.apply(k,arguments)});if(k.click)k.on("click",function(a){k.click.apply(k,arguments);a.halt()});j.mode==h.WYSIWYG_MODE&&(a.on("wysiwygMode",function(){k.set("disabled",false)}),a.on("sourceMode",function(){k.set("disabled",true)}));k.init&&k.init();a.addControl(d,k);return k};return i.Select},{requires:["editor","menubutton"]});
KISSY.add("editor/plugin/separator/index",function(e){return{init:function(h){var i=(new e.Node('<span class="ks-editor-toolbar-separator">&nbsp;</span>')).appendTo(h.get("toolBarEl"));h.on("destroy",function(){i.remove()})}}},{requires:["editor"]});
KISSY.add("editor/plugin/smiley/index",function(e,h,i){for(var d="<div class='ks-editor-smiley-sprite'>",j=0;98>=j;j++)d+="<a href='javascript:void(0)' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+j+".gif'></a>";d+="</div>";return{init:function(b){b.addButton("smiley",{tooltip:"\u63d2\u5165\u8868\u60c5",checkable:!0,mode:h.WYSIWYG_MODE},{init:function(){var b=this;b.on("blur",function(){setTimeout(function(){b.onClick()},150)})},offClick:function(){var c=this,a;if(!(a=c.smiley))a=c.smiley=new i({content:d,
focus4e:!1,width:"297px",autoRender:!0,elCls:"ks-editor-popup",zIndex:h.baseZIndex(h.zIndexManager.POPUP_MENU),mask:!1}),a.get("el").on("click",function(a){var a=new e.Node(a.target),c;if("a"==a.nodeName()&&(c=a.attr("data-icon")))c=new e.Node("<img alt='' src='"+c+"'/>",null,b.get("document")[0]),b.insertElement(c)}),a.on("hide",function(){c.set("checked",!1)});a.set("align",{node:this.get("el"),points:["bl","tl"]});a.show()},onClick:function(){this.smiley&&this.smiley.hide()},destructor:function(){this.smiley&&
this.smiley.destroy()}})}}},{requires:["editor","../overlay/"]});KISSY.add("editor/plugin/sourceArea/index",function(e,h){var i=h.SOURCE_MODE,d=h.WYSIWYG_MODE;return{init:function(e){e.addButton("sourceArea",{tooltip:"\u6e90\u7801",checkable:!0},{init:function(){var b=this;e.on("wysiwygMode",function(){b.set("checked",!1)});e.on("sourceMode",function(){b.set("checked",!0)})},offClick:function(){e.set("mode",i)},onClick:function(){e.set("mode",d)}})}}},{requires:["editor","../button/"]});
KISSY.add("editor/plugin/strikeThrough/cmd",function(e,h,i){var d=new h.Style({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"},{element:"strike"}]});return{init:function(e){i.addButtonCmd(e,"strikeThrough",d)}}},{requires:["editor","../font/cmd"]});
KISSY.add("editor/plugin/strikeThrough/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("strikeThrough",{cmdType:"strikeThrough",tooltip:"\u5220\u9664\u7ebf "},void 0,i.Button)}}},{requires:["editor","../font/ui","./cmd"]});
KISSY.add("editor/plugin/table/index",function(e,h,i){function d(a){function b(a){!(0<e.length)&&a[0].nodeType==q.ELEMENT_NODE&&p.test(a.nodeName())&&!a.data("selected_cell")&&(a._4e_setMarker(f,"selected_cell",!0,void 0),e.push(a))}for(var c=a.createBookmarks(),d=a.getRanges(),e=[],f={},g=0;g<d.length;g++){var i=d[g];if(i.collapsed)i=i.getCommonAncestor(),(i=i.closest("td",void 0)||i.closest("th",void 0))&&e.push(i);else{var i=new Walker(i),j;for(i.guard=b;j=i.next();)if((j=j.parent())&&p.test(j.nodeName())&&
!j.data("selected_cell"))j._4e_setMarker(f,"selected_cell",!0,void 0),e.push(j)}}h.Utils.clearAllMarkers(f);a.selectBookmarks(c);return e}function j(a,b){var c=a.getStartElement().parent("tr");if(c){var d=c.clone(!0);d.insertBefore(c);c=(b?d[0]:c[0]).cells;for(d=0;d<c.length;d++)c[d].innerHTML="",o.ie||(new f(c[d]))._4e_appendBogus(void 0)}}function b(a){if(a instanceof h.Selection){for(var c=d(a),e=c.length,a=[],g,i,j=0;j<e;j++){var k=c[j].parent(),m=k[0].rowIndex;!j&&(g=m-1);a[m]=k;j==e-1&&(i=m+
1)}j=k.parent("table");g=new f(i<j[0].rows.length&&j[0].rows[i]||0<g&&j[0].rows[g]||j[0].parentNode);for(j=a.length;0<=j;j--)a[j]&&b(a[j]);return g}a instanceof f&&(j=a.parent("table"),1==j[0].rows.length?j.remove():a.remove());return 0}function c(a,b){var c=a.getStartElement();if(c=c.closest("td",void 0)||c.closest("th",void 0))for(var d=c.parent("table"),e=c[0].cellIndex,g=0;g<d[0].rows.length;g++){var h=d[0].rows[g];h.cells.length<e+1||(c=new f(h.cells[e].cloneNode(void 0)),o.ie||c._4e_appendBogus(void 0),
h=new f(h.cells[e]),b?c.insertBefore(h):c.insertAfter(h))}}function a(c){if(c instanceof h.Selection){var e=d(c),g,j=[],c=e[0]&&e[0].parent("table"),i,k,m;i=0;for(k=e.length;i<k;i++)j.push(e[i][0].cellIndex);j.sort();i=1;for(k=j.length;i<k;i++)if(1<j[i]-j[i-1]){m=j[i-1]+1;break}m||(m=0<j[0]?j[0]-1:j[j.length-1]+1);j=c[0].rows;i=0;for(k=j.length;i<k&&!(g=j[i].cells[m]);i++);g=g?new f(g):c.prev();for(m=e.length-1;0<=m;m--)e[m]&&a(e[m]);return g}if(c instanceof f){e=c.parent("table");if(!e)return null;
g=c[0].cellIndex;for(m=e[0].rows.length-1;0<=m;m--)c=new f(e[0].rows[m]),!g&&1==c[0].cells.length?b(c):c[0].cells[g]&&c[0].removeChild(c[0].cells[g])}return null}function g(a,b){var c=new h.Range(a[0].ownerDocument);if(!c.moveToElementEditablePosition(a,b?!0:void 0))c.selectNodeContents(a),c.collapse(b?!1:!0);c.select(!0)}function k(a){var b=(a=a.getSelection())&&a.getStartElement(),c=b&&b.closest("table",void 0);if(c)return a=b.closest(function(a){var b=q.nodeName(a);return c.contains(a)&&("td"==
b||"th"==b)},void 0),b=b.closest(function(a){var b=q.nodeName(a);return c.contains(a)&&"tr"==b},void 0),{table:c,td:a,tr:b}}function m(a){return(a=k(a))&&a.td}function n(a){return(a=k(a))&&a.tr}var o=e.UA,q=e.DOM,f=e.Node,l=["tr","th","td","tbody","table"],p=/^(?:td|th)$/,w={"\u8868\u683c\u5c5e\u6027":k,"\u5220\u9664\u8868\u683c":m,"\u5220\u9664\u5217":m,"\u5220\u9664\u884c":n,"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":n,"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":n,"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":m,"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":m},y=(6===o.ie?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:" table.%2,; table.%2 > tr > td,  table.%2 > tr > th,; table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,; table.%2 > thead > tr > td,  table.%2 > thead > tr > th,; table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th;{;border : #d3d3d3 1px dotted;}".split(";")).join("").replace(/%2/g,
"ke_show_border"),s={elements:{table:function(a){var a=a.attributes,b=a["class"],c=parseInt(a.border,10);if(!c||0>=c)a["class"]=(b||"")+" ke_show_border"}}},r={elements:{table:function(a){var a=a.attributes,b=a["class"];b&&(a["class"]=e.trim(b.replace("ke_show_border","")))}}};return{init:function(d){d.addCustomStyle(y);var f=d.htmlDataProcessor,m=f&&f.htmlFilter;(f&&f.dataFilter).addRules(s);m.addRules(r);var n={"\u8868\u683c\u5c5e\u6027":function(){this.hide();var a=k(d);a&&i.useDialog(d,"table/dialog",{selectedTable:a.table,
selectedTd:a.td})},"\u5220\u9664\u8868\u683c":function(){this.hide();var a=d.getSelection(),b=a&&a.getStartElement();if(b=b&&b.closest("table",void 0)){a.selectElement(b);var c=a.getRanges()[0];c.collapse();a.selectRanges([c]);a=b.parent();1==a[0].childNodes.length&&"body"!=a.nodeName()&&"td"!=a.nodeName()?a.remove():b.remove()}},"\u5220\u9664\u884c ":function(){this.hide();var a=d.getSelection();g(b(a),void 0)},"\u5220\u9664\u5217 ":function(){this.hide();var b=d.getSelection();(b=a(b))&&g(b,!0)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(){this.hide();var a=d.getSelection();
j(a,!0)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(){this.hide();var a=d.getSelection();j(a,void 0)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(){this.hide();var a=d.getSelection();c(a,!0)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(){this.hide();var a=d.getSelection();c(a,void 0)}},o=[];e.each(n,function(a,b){o.push({content:b})});d.addContextMenu("table-contextmenu",function(a){if(e.inArray(q.nodeName(a),l))return!0},{width:"120px",children:o,listeners:{click:{fn:function(a){a=a.target.get("content");n[a]&&n[a].apply(this)}},beforeVisibleChange:{fn:function(a){if(a.newVal){var b=
this,a=b.get("children"),c=b.get("editor");e.each(a,function(a){var d=a.get("content");!w[d]||w[d].call(b,c)?a.set("disabled",!1):a.set("disabled",!0)})}}}}});d.addButton("table",{mode:h.WYSIWYG_MODE,tooltip:"\u63d2\u5165\u8868\u683c"},{offClick:function(){i.useDialog(d,"table/dialog",{selectedTable:0,selectedTd:0})}})}}},{requires:["editor","../dialogLoader/","../contextmenu/"]});
KISSY.add("editor/plugin/underline/cmd",function(e,h,i){var d=new h.Style({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]});return{init:function(e){i.addButtonCmd(e,"underline",d)}}},{requires:["editor","../font/cmd"]});KISSY.add("editor/plugin/underline/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("underline",{cmdType:"underline",tooltip:"\u4e0b\u5212\u7ebf "},void 0,i.Button)}}},{requires:["editor","../font/ui","./cmd"]});
KISSY.add("editor/plugin/undo/btn",function(e,h,i){function d(d){d.get("editor").on("afterSave afterRestore",d._respond,d)}e=i.extend({bindUI:function(){d(this)},offClick:function(){this.get("editor").execCommand("undo")},_respond:function(d){0<d.index?this.set("disabled",!1):this.set("disabled",!0)}},{ATTRS:{mode:{value:h.WYSIWYG_MODE},disabled:{value:!0}}});return{RedoBtn:i.extend({bindUI:function(){d(this)},offClick:function(){this.get("editor").execCommand("redo")},_respond:function(d){d.index<
d.history.length-1?this.set("disabled",!1):this.set("disabled",!0)}},{mode:{value:h.WYSIWYG_MODE},ATTRS:{disabled:{value:!0}}}),UndoBtn:e}},{requires:["editor","../button/"]});
KISSY.add("editor/plugin/undo/cmd",function(e,h){function i(a){var b=a.get("document")[0].body.innerHTML,c;b&&(c=a.getSelection());this.contents=b;this.bookmarks=c&&c.createBookmarks2(!0)}function d(a){this.history=[];this.index=-1;this.editor=a;this.bufferRunner=e.buffer(this.save,500,this);this._init()}var j=h.Utils.arrayCompare,b=e.UA;e.augment(i,{equals:function(a){if(this.contents!=a.contents)return!1;var b=this.bookmarks,a=a.bookmarks;if(b||a){if(!b||!a||b.length!=a.length)return!1;for(var c=
0;c<b.length;c++){var d=b[c],e=a[c];if(d.startOffset!=e.startOffset||d.endOffset!=e.endOffset||!j(d.start,e.start)||!j(d.end,e.end))return!1}}return!0}});var c={16:1,17:1,18:1},a={37:1,38:1,39:1,40:1,33:1,34:1};e.augment(d,{_keyMonitor:function(){var b=this,d=b.editor;d.docReady(function(){d.get("document").on("keydown",function(e){var h=e.keyCode;h in a||h in c||(90===h&&(e.ctrlKey||e.metaKey)?(!1!==d.fire("restore",{direction:-1})&&b.restore(-1),e.halt()):89===h&&(e.ctrlKey||e.metaKey)?(!1!==d.fire("restore",
{direction:1})&&b.restore(1),e.halt()):!1!==d.fire("save",{buffer:1})&&b.save(1))})})},_init:function(){var a=this;a._keyMonitor();setTimeout(function(){a.save()},0)},save:function(a){if(this.editor.get("mode")==h.WYSIWYG_MODE)if(a)this.bufferRunner();else{var a=this.history,b=this.index;a.length>b+1&&a.splice(b+1,a.length-b-1);var c=this.editor,b=a[a.length-1],d=new i(c);if(!b||!b.equals(d))30===a.length&&a.shift(),a.push(d),this.index=b=a.length-1,c.fire("afterSave",{history:a,index:b})}},restore:function(a){if(this.editor.get("mode")==
h.WYSIWYG_MODE){var c=this.history,d=this.editor,e=d.get("document")[0].body,i=c[this.index+a];i&&(e.innerHTML=i.contents,i.bookmarks?d.getSelection().selectBookmarks(i.bookmarks):b.ie&&(e=e.createTextRange(),e.collapse(!0),e.select()),(e=d.getSelection())&&e.scrollIntoView(),this.index+=a,d.fire("afterRestore",{history:c,index:this.index}),d.notifySelectionChange());return i}}});return{init:function(a){if(!a.hasCommand("save")){var b=new d(a);a.addCommand("save",{exec:function(a,c){b.save(c)}});
a.addCommand("undo",{exec:function(){b.restore(-1)}});a.addCommand("redo",{exec:function(){b.restore(1)}})}}}},{requires:["editor"]});KISSY.add("editor/plugin/undo/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("undo",{mode:h.WYSIWYG_MODE,tooltip:"\u64a4\u9500",editor:e},void 0,i.UndoBtn);e.addButton("redo",{mode:h.WYSIWYG_MODE,tooltip:"\u91cd\u505a",editor:e},void 0,i.RedoBtn)}}},{requires:["editor","./btn","./cmd"]});
KISSY.add("editor/plugin/unorderedList/cmd",function(e,h,i){var d=i.queryActive,j=new i.ListCommand("ul");return{init:function(b){b.hasCommand("insertUnorderedList")||b.addCommand("insertUnorderedList",{exec:function(a){j.exec(a)}});var c=h.Utils.getQueryCmd("insertUnorderedList");b.hasCommand(c)||b.addCommand(c,{exec:function(a,b){return d("ul",b)}})}}},{requires:["editor","../listUtils/cmd"]});
KISSY.add("editor/plugin/unorderedList/index",function(e,h,i,d){return{init:function(e){d.init(e);e.addButton("unorderedList",{cmdType:"insertUnorderedList",mode:h.WYSIWYG_MODE},void 0,i)}}},{requires:["editor","../listUtils/btn","./cmd"]});
KISSY.add("editor/plugin/video/index",function(e,h,i,d){return{init:function(e){function b(a){for(var b=0;b<g.length;b++){var c=g[b];if(c.reg.test(a))return c}}var c=e.htmlDataProcessor,a=c&&c.dataFilter,g=[],k=e.get("pluginConfig");k.video=k.video||{};k=k.video;k.providers&&g.push.apply(g,k.providers);k.getProvider=b;a&&a.addRules({elements:{object:function(a){var d=a.getAttribute("classid"),e=a.childNodes;if(!d){for(d=0;d<e.length;d++)if("embed"==e[d].name){if(!i.isFlashEmbed(e[d]))break;if(b(e[d].getAttribute("src")))return c.createFakeParserElement(a,
"ke_video","video",!0)}return null}for(d=0;d<e.length;d++){var f=e[d];if("param"==f.nodeName&&"movie"==f.getAttribute("name").toLowerCase()&&b(f.getAttribute("value")))return c.createFakeParserElement(a,"ke_video","video",!0)}},embed:function(a){if(!i.isFlashEmbed(a))return null;if(b(a.getAttribute("src")))return c.createFakeParserElement(a,"ke_video","video",!0)}}},4);var m=new d({editor:e,cls:"ke_video",type:"video",contextMenuId:"video-contextmenu",contextMenuHandlers:{"\u89c6\u9891\u5c5e\u6027":function(){var a=
this.get("editorSelectedEl");a&&m.show(a)}}});e.addButton("video",{tooltip:"\u63d2\u5165\u89c6\u9891",mode:h.WYSIWYG_MODE},{offClick:function(){m.show()}})}}},{requires:["editor","../flashCommon/utils","../flashCommon/baseClass"]});
KISSY.add("editor/plugin/xiamiMusic/index",function(e,h,i,d){function j(){j.superclass.constructor.apply(this,arguments)}e.extend(j,i,{_updateTip:function(b,c){var a=this.get("editor").restoreRealElement(c);a&&(b.html(c.attr("title")),b.attr("href",this._getFlashUrl(a)))}});return{init:function(b){function c(a){return/xiami\.com/i.test(a)}var a=b.htmlDataProcessor,e=a&&a.dataFilter;e&&e.addRules({tags:{object:function(b){var e=b.getAttribute("title"),g,h;g=b.getAttribute("classid");var f=b.childNodes;
if(!g){for(g=0;g<f.length;g++)if(h=f[g],"embed"==h.nodeName){if(!d.isFlashEmbed(h))break;if(c(h.attributes.src))return a.createFakeParserElement(b,"ke_xiami","xiamiMusic",!0,{title:e})}return null}for(g=0;g<f.length;g++)if(h=f[g],"param"==h.nodeName&&"movie"==h.getAttribute("name")&&c(h.getAttribute("value")))return a.createFakeParserElement(b,"ke_xiami","xiamiMusic",!0,{title:e})},embed:function(b){if(d.isFlashEmbed(b)&&c(b.getAttribute("src")))return a.createFakeParserElement(b,"ke_xiami","xiamiMusic",
!0,{title:b.getAttribute("title")})}}},4);var i=new j({editor:b,cls:"ke_xiami",type:"xiamiMusic",contextMenuId:"xiami-contextmenu",contextMenuHandlers:{"\u867e\u7c73\u5c5e\u6027":function(){var a=this.get("editorSelectedEl");a&&i.show(a)}}});b.addButton("xiamiMusic",{tooltip:"\u63d2\u5165\u867e\u7c73\u97f3\u4e50",mode:h.WYSIWYG_MODE},{offClick:function(){i.show()}})}}},{requires:["editor","../flashCommon/baseClass","../flashCommon/utils"]});KISSY.add("editor/full",function(e,h){return h},{requires:["editor"]});
