/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Apr 16 12:15
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(a,k,t){k=t.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:k.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(a){var k=this._getData();return void 0===k?a:k}},formatData:{getter:function(){return this._getData(1)}},customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});k.HTML_PARSER=
{textarea:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea")},data:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea").val()}};a.mix(k,a.EventTarget);return KISSY.Editor=k},{requires:["htmlparser","component/base","core"]});
KISSY.add("editor/core/clipboard",function(a,k,t,p){function o(b){this.editor=b;this._init()}function g(b){if(j.ie&&"BackCompat"!=b.get("document")[0].compatMode){var d=b.getSelection(),e;if(d.getType()==p.SELECTION_ELEMENT&&(e=d.getSelectedElement())){var h=d.getRanges()[0],c=f(b.get("document")[0].createTextNode(""));c.insertBefore(e);h.setStartBefore(c);h.setEndAfter(e);d.selectRanges([h]);setTimeout(function(){e.parent()&&(c.remove(),d.selectElement(e))},0)}}}var f=a.all,j=a.UA,q=k.RANGE,m=a.Event;
a.augment(o,{_init:function(){var b=this.editor,a=b.get("document")[0].body;m.on(a,j.ie?"beforepaste":"paste",this._paste,this);m.on(a,"contextmenu",function(){d=1;setTimeout(function(){d=0},10)});b.addCommand("copy",new v("copy"));b.addCommand("cut",new v("cut"));b.addCommand("paste",new v("paste"))},_paste:function(){if(!d){var b=this.editor,u=b.get("document")[0];if(!u.getElementById("ke_pastebin")){var e=b.getSelection(),h=new t(u),c=f(j.webkit?"<body></body>":u.createElement("div"),null,u);c.attr("id",
"ke_pastebin");j.webkit&&c[0].appendChild(u.createTextNode("\u00a0"));u.body.appendChild(c[0]);c.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});c.css("left","-1000px");var l=e.createBookmarks();h.setStartAt(c,q.POSITION_AFTER_START);h.setEndAt(c,q.POSITION_BEFORE_END);h.select(!0);setTimeout(function(){var d;c=j.webkit&&(d=c.first())&&d.hasClass("Apple-style-span")?d:c;e.selectBookmarks(l);c.remove();var h=c.html();if(h=a.trim(h.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))d=b.fire("paste",{html:h,holder:c}),void 0!==d&&(h=d),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(h)?a.use("editor/plugin/word-filter",function(c,e){b.insertHtml(e.toDataFormat(h,b))}):b.insertHtml(h)},0)}}}});var w=function(b,d){var e=b.get("document")[0],h=f(e.body),c=!1,a=function(){c=!0};h.on(d,a);(7<j.ie?e:e.selection.createRange()).execCommand(d);h.detach(d,a);return c},n=j.ie?function(b,d){return w(b,d)}:function(b,d){try{return b.get("document")[0].execCommand(d)}catch(e){return!1}},
y={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},v=function(b){this.type=b};v.prototype={constructor:v,exec:function(b){"cut"==this.type&&g(b);(b=n(b,this.type))||alert(y[this.type]);return b}};var i={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},d;return{init:function(b){b.docReady(function(){new o(b)});var d={copy:1,cut:1,paste:1};b.on("contextmenu",function(e){e=e.contextmenu;if(!e.__copy_fix){e.__copy_fix=
1;for(var h in d)e.addChild({content:i[h],value:h});e.on("click",function(c){var e=c.target.get("value");d[e]&&(this.hide(),setTimeout(function(){b.execCommand(e)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core",function(a,k,t,p,o,g,f,j,q,m){function w(b,c){var r=b.body;E(function(){b.designMode="on";setTimeout(function(){b.designMode="off";r.focus();arguments.callee.retry||(arguments.callee.retry=d)},50)},function(){b.designMode="off";s.attr(r,"contentEditable",e);s.attr(r,"contentEditable",d);!c&&w(b,1)})}function n(b){b.get("iframe");var d=b.get("textarea")[0],r=b.get("window")[0],h=b.get("document")[0];c.webkit&&(z.on(h,"click",function(b){var c=new C(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),z.on(h,"mouseup",function(b){var c=new C(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(c.gecko||l||c.opera){var x;x=(new C('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(d);x.on("focus",function(){b.focus()});b.activateGecko=function(){c.gecko&&b.__iframeFocus&&x[0].focus()};b.on("destroy",function(){x.detach();x.remove()})}z.on(r,"focus",function(){c.gecko?w(h,e):c.opera&&
h.body.focus();b.notifySelectionChange()});if(c.gecko)z.on(h,"mousedown",function(){b.__iframeFocus||w(h,e)});if(l&&(z.on(h,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var d=b.getSelection(),e=d.getSelectedElement();if(e){b.execCommand("save");var r=d.getRanges()[0].createBookmark();e.remove();d.selectBookmarks([r]);b.execCommand("save");c.preventDefault()}}}),"CSS1Compat"==h.compatMode)){var D={33:1,34:1};z.on(h,"keydown",function(c){c.keyCode in D&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(c.webkit)z.on(h,"mousedown",function(c){c=new C(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(c.gecko)z.on(h,"dragstart",function(b){var c=new C(b.target);c.nodeName()==="img"&&/ke_/.test(c[0].className)&&b.preventDefault()});p.add(b)}function y(b,c,d,e){var l="",x,D=t.debugUrl("theme/editor-iframe.css");for(x=0;x<d.length;x++)l+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[x]});return a.substitute(r,{doctype:8===
h.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:D,style:c,data:e||"&nbsp;",script:b?'<script id="ke_active_script">'+(s.isCustomDomain()?'document.domain="'+h.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function v(b,c){function d(){x=a.document;b.setInternal("document",new C(x));b.setInternal("window",new C(a));e.detach();x.open("text/html","replace");x.write(r);x.close()}var e=b.get("iframe"),r=y(b._UUID,b.get("customStyle"),
b.get("customLink"),c),h=e[0],a=h.contentWindow,x;e.__loaded=1;try{x=a.document}catch(D){if(h.src=h.src,7>l){setTimeout(d,10);return}}d()}function i(b,d){var e=s.getEmptyIframeSrc()||"";e&&(e=' src="'+e+'" ');var e=new C(a.substitute(D,{iframeSrc:e})),r=b.get("textarea");r.hasAttr("tabindex")&&e.attr("tabindex",c.webkit?-1:r.attr("tabindex"));r.parent().prepend(e);b.set("iframe",e);b.__docReady=0;if(c.gecko&&!e.__loaded)e.on("load",function(){v(b,d)},b);else v(b,d)}var d=!0,b=b,u=a.all,e=!1,h=document,
c=a.UA,l=c.ie,s=a.DOM,A=s.NodeType,C=a.Node,z=a.Event,E=t.tryThese,r='<!doctype html><html><head>{doctype}<title>{title}</title><link href="{href}" rel="stylesheet" /><style>{style}</style>{links}</head><body class="ks-editor" >{data}{script}</body></html>',D='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',x=/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/i,O='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+
(c.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+'></div><div class="{prefixCls}editor-status"></div>';a.mix(k,{SOURCE_MODE:0,WYSIWYG_MODE:1});var G=k.WYSIWYG_MODE;a.augment(k,{createDom:function(){var b,c=this.get("prefixCls"),e=this.get("textarea"),d;e?(this.set("textarea",e=u(e)),e[0].parentNode&&e.remove()):(b=this.get("data"),this.set("textarea",e=u('<textarea class="'+c+'-editor-textarea"></textarea>')),e.val(b));d=this.get("el");d.html(a.substitute(O,{prefixCls:c}));
b=d.one(a.substitute(".{prefixCls}editor-textarea-wrap",{prefixCls:c}));this._UUID=a.guid();this.set({toolBarEl:d.one(a.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:d.one(a.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});e.css("width","100%");e.css("display","none");b.append(e);p.register(this)},renderUI:function(){f.init(this);j.init(this);q.init(this);m.init(this)},bindUI:function(){function b(){c.detach("docReady",b);if(c.get("focused"))c.focus();else{var e=
c.getSelection();e&&e.removeAllRanges()}}var c=this,e,d=c.get("prefixCls"),r=c.get("textarea");if(c.get("attachForm")&&(e=r[0].form))z.on(e,"submit",c.sync,c);c.on("docReady",b);c.on("blur",function(){c.get("el").removeClass(d+"editor-focused")});c.on("focus",function(){c.get("el").addClass(d+"editor-focused")})},syncUI:function(){this.get("rendered")&&this.get("textarea").val(this.get("data"))},_onSetHeight:function(b){var c=this.get("textarea"),e=this.get("toolBarEl"),d=this.get("statusBarEl"),
b=parseInt(b,10),b=b-((e&&e.outerHeight()||0)+(d&&d.outerHeight()||0));c.parent().css("height",b);c.css("height",b)},_onSetMode:function(b){this.get("rendered");var c=this.get("iframe"),e=this.get("textarea");b==G?(this._setData(e.val()),e.hide(),this.fire("wysiwygMode")):(c&&(e.val(this._getData(1,G)),c.hide()),e.show(),this.fire("sourceMode"))},_onSetFocused:function(b){b&&this.__docReady&&this.focus()},_onSetData:function(b){this.get("rendered")&&this._setData(b)},destructor:function(){var b,c=
this.get("textarea"),e=this.get("document")[0],d=this.get("window");this.get("attachForm")&&(b=c[0].form)&&z.detach(b,"submit",this.sync,this);p.remove(this);z.remove([e,e.documentElement,e.body,d[0]]);a.each(this.__controls,function(b){b.destroy&&b.destroy()});this.__commands={};this.__controls={}},getControl:function(b){return this.__controls[b]},getControls:function(){return this.__controls},addControl:function(b,c){this.__controls[b]=c},showDialog:function(b,c){var b=b+"/dialog",e=this.__controls[b];
e.show(c);this.fire("dialogShow",{dialog:e.dialog,pluginDialog:e,dialogName:b})},addCommand:function(b,c){this.__commands[b]=c},hasCommand:function(b){return this.__commands[b]},execCommand:function(c){var e=this.__commands[c],d=a.makeArray(arguments);d.shift();d.unshift(this);return e?e.exec.apply(e,d):b},queryCommandValue:function(b){return this.execCommand(t.getQueryCmd(b))},_getData:function(c,e){var d=this.htmlDataProcessor,r;if(!this.get("rendered"))return b;e==b&&(e=this.get("mode"));r=e==
G&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());r=c?d.toHtml(r):d.toServer(r);r=a.trim(r);x.test(r)&&(r="");return r},_setData:function(b){var c,e=b;if(this.get("mode")!=G)this.get("textarea").val(b);else{if(c=this.htmlDataProcessor)e=c.toDataFormat(b);if(this.get("iframe")){b=this.get("iframe");c=this.get("window")[0];var d=this.get("document")[0];z.remove([d,d.documentElement,d.body,c]);b.remove()}i(this,e)}},getDocHTML:function(){return y(0,
this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getDocHtml:function(){return this.getDocHTML()},getSelection:function(){return k.Selection.getSelection(this.get("document")[0])},getSelectedHTML:function(){var b=this.getSelection().getRanges()[0],c;b&&(b=b.cloneContents(),c=this.get("document")[0].createElement("div"),c.appendChild(b),c=c.innerHTML);return c},focus:function(){var b=this.get("window");if(b){var e=this.get("document")[0],b=b[0];c.ie||b&&b.parent&&b.parent.focus();
b&&b.focus();try{e.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(b,c){var e=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+b));e&&s.addStyleSheet(e,b,c)},removeCustomStyle:function(b){s.remove(s.get("#"+b,this.get("window")[0]))},addCustomLink:function(b){var c=this.get("customLink")||[],e=this.get("document")[0];c.push(b);this.set("customLink",c);c=e.createElement("link");
c.rel="stylesheet";e.getElementsByTagName("head")[0].appendChild(c);c.href=b},removeCustomLink:function(b){for(var c=this.get("document")[0],c=s.query("link",c),e=0;e<c.length;e++)s.attr(c[e],"href")==b&&s.remove(c[e]);c=this.get("customLink")||[];b=a.indexOf(b,c);-1!=b&&c.splice(b,1)},docReady:function(b){this.on("docReady",b);this.__docReady&&b.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var b=this;b.__checkSelectionChangeId&&clearTimeout(b.__checkSelectionChangeId);
b.__checkSelectionChangeId=setTimeout(function(){var c=b.getSelection();if(c&&!c.isInvalid){var e=c.getStartElement(),d=new k.ElementPath(e);if(!b.__previousPath||!b.__previousPath.compare(d))b.__previousPath=d,b.fire("selectionChange",{selection:c,path:d,element:e})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(c){if(this.get("mode")!==G)return b;this.focus();var e,r=c.nodeName(),h=k.XHTML_DTD,a=h.$block[r],l=k.RANGE,x=(r=this.getSelection())&&
r.getRanges(),D,u,s;if(!x||0==x.length)return b;this.execCommand("save");for(u=x.length-1;0<=u;u--)D=x[u],e=!u&&c||c.clone(d),D.insertNodeByDtd(e),s||(s=e);if(!s)return b;D.moveToPosition(s,l.POSITION_AFTER_END);a&&(c=k.Walker.whitespaces(!0),(c=(s=s.next(c,1))&&s[0].nodeType==A.ELEMENT_NODE&&s.nodeName())&&h.$block[c]&&h[c]["#text"]&&D.moveToElementEditablePosition(s));r.selectRanges([D]);this.focus();e&&1==e[0].nodeType&&e.scrollIntoView(b,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});
I.call(this);return e},insertHTML:function(c,d){var r=this,h,a=r.get("document")[0];if(r.get("mode")===G){if(h=r.htmlDataProcessor)c=h.toDataFormat(c,d);r.focus();r.execCommand("save");if(l){h=a.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(c)}catch(x){}}else try{a.execCommand("inserthtml",e,c)}catch(D){setTimeout(function(){if(0==r.getSelection().getRanges().length){var d=new k.Range(a),h=s.first(a.body,function(b){return 1==b.nodeType&&"br"!=s.nodeName(b)});h||(h=new C(a.createElement("p")),
h._4e_appendBogus(b),a.body.appendChild(h[0]));d.setStartAt(h,k.RANGE.POSITION_AFTER_START);d.select()}a.execCommand("inserthtml",e,c)},50)}setTimeout(function(){r.getSelection().scrollIntoView()},50);I.call(r)}},insertHtml:function(b,c){this.insertHTML(b,c)}});k._initIFrame=function(b){var r=p.getInstance(b),h=r.get("document")[0],b=h.getElementById("ke_active_script");s.remove(b);n(r);var a=h.body;l?(a.hideFocus=d,a.disabled=d,a.contentEditable=d,a.removeAttribute("disabled")):setTimeout(function(){c.gecko||
c.opera?a.contentEditable=d:c.webkit?a.parentNode.contentEditable=d:h.designMode="on"},0);if(c.gecko||c.opera){var x=h.documentElement;z.on(x,"mousedown",function(b){if(b.target==x){c.gecko&&w(h,e);r.activateGecko()}})}setTimeout(function(){l&&setTimeout(function(){if(h){a.runtimeStyle.marginBottom="0px";a.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){r.__docReady=1;r.fire("docReady");var b=r.get("disableObjectResizing"),c=r.get("disableInlineTableEditing");if(b||c)try{h.execCommand("enableObjectResizing",
e,!b);h.execCommand("enableInlineTableEditing",e,!c)}catch(d){z.on(a,l?"resizestart":"resize",function(e){var d=new C(e.target);(b||d.nodeName()==="table"&&c)&&e.preventDefault()})}},10)};var I=a.buffer(function(){this.execCommand("save")},50);return k},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
KISSY.add("editor/core/dom",function(a,k,t){function p(d,b){var a=d[b?"next":"prev"](o,1);if(a&&a[0].nodeType==j.ELEMENT_NODE){for(var e=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(o);)if(e.push(a),a=b?a.next(o,1):a.prev(o,1),!a)return;if(d._4e_isIdentical(a,o)){for(var h=new m(b?d[0].lastChild:d[0].firstChild);e.length;)e.shift()._4e_move(d,!b,o);a._4e_moveChildren(d,!b,o);a.remove();h[0]&&h[0].nodeType==j.ELEMENT_NODE&&h._4e_mergeSiblings()}}}var o=o,g=k.XHTML_DTD,f=a.DOM,j=f.NodeType,
q=a.UA,m=a.Node,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};k.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var n=k.POSITION,y={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},v={hr:1},i=function(d){return d&&(d[0]||d)};t.injectDom({_4e_sameLevel:function(d,b){var b=i(b),a=d.parentNode;return a&&a==b.parentNode},_4e_isBlockBoundary:function(d,b){var u=a.merge(v,b);return!(!y[f.css(d,"display")]&&!u[f.nodeName(d)])},_4e_index:function(d,b){for(var a=d.parentNode.childNodes,e,h=-1,c=0;c<a.length;c++)if(e=a[c],!b||!(3==e.nodeType&&e.previousSibling&&3==e.previousSibling.nodeType))if(h++,e===d)return h;return-1},_4e_move:function(d,
b,a){b=i(b);a?b.insertBefore(d,b.firstChild):b.appendChild(d)},_4e_isIdentical:function(d,b){if(!b)return!1;b=i(b);if(f.nodeName(d)!=f.nodeName(b))return!1;var a=d.attributes,e=b.attributes,h=a.length,c=e.length;if(h!=c)return!1;for(var l=0;l<h;l++){var s=a[l],g=s.name;if(s.specified&&f.attr(d,g)!=f.attr(b,g))return!1}if(8>t.ieEngine)for(l=0;l<c;l++)if(s=e[l],g=s.name,s.specified&&f.attr(d,g)!=f.attr(b,g))return!1;return!0},_4e_isEmptyInlineRemovable:function(d){if(!g.$removeEmpty[f.nodeName(d)])return!1;
for(var d=d.childNodes,b=0,u=d.length;b<u;b++){var e=d[b],h=e.nodeType;if(!(h==j.ELEMENT_NODE&&e.getAttribute("_ke_bookmark"))&&(h==j.ELEMENT_NODE&&!f._4e_isEmptyInlineRemovable(e)||h==f.NodeType.TEXT_NODE&&a.trim(e.nodeValue)))return!1}return!0},_4e_moveChildren:function(d,b,a){b=i(b);if(d!=b)if(a)for(;a=d.lastChild;)b.insertBefore(d.removeChild(a),b.firstChild);else for(;a=d.firstChild;)b.appendChild(d.removeChild(a))},_4e_mergeSiblings:function(d){d=new m(d);w[d.nodeName()]&&(p(d,!0),p(d))},_4e_splitText:function(d,
b){var a=d.ownerDocument;if(d.nodeType==f.NodeType.TEXT_NODE){if(q.ie&&b==d.nodeValue.length){var e=a.createTextNode("");f.insertAfter(e,d);return e}e=d.splitText(b);a.documentMode&&(a=a.createTextNode(""),f.insertAfter(a,e),f.remove(a));return e}},_4e_parents:function(d,b){var a=[];a.__IS_NODELIST=1;do a[b?"push":"unshift"](d);while(d=d.parentNode);return a},_4e_nextSourceNode:function(d,b,a,e){if(e&&!e.call)var h=i(e),e=function(b){return b!==h};var b=!b&&d.firstChild,c=d;if(!b){if(d.nodeType==
j.ELEMENT_NODE&&e&&!1===e(d,!0))return null;b=d.nextSibling}for(;!b&&(c=c.parentNode);){if(e&&!1===e(c,!0))return null;b=c.nextSibling}return!b||e&&!1===e(b)?null:a&&a!=b.nodeType?f._4e_nextSourceNode(b,!1,a,e):b},_4e_previousSourceNode:function(d,b,a,e){if(e&&!e.call)var h=i(e),e=function(b){return b!==h};var b=!b&&d.lastChild,c=d;if(!b){if(d.nodeType==j.ELEMENT_NODE&&e&&!1===e(d,!0))return null;b=d.previousSibling}for(;!b&&(c=c.parentNode);){if(e&&!1===e(c,!0))return null;b=c.previousSibling}return!b||
e&&!1===e(b)?null:a&&b.nodeType!=a?f._4e_previousSourceNode(b,!1,a,e):b},_4e_commonAncestor:function(d,b){b=i(b);if(d===b)return d;if(f.contains(b,d))return b;var a=d;do if(f.contains(a,b))return a;while(a=a.parentNode);return null},_4e_hasAttributes:9>t.ieEngine?function(d){for(var b=d.attributes,a=0;a<b.length;a++){var e=b[a];switch(e.name){case "class":if(d.getAttribute("class"))return!0;break;default:if(e.specified)return!0}}return!1}:function(d){q.gecko&&d.removeAttribute("_moz_dirty");return d.hasAttributes()},
_4e_position:function(d,b){var a=i(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(a);if(d==a)return n.POSITION_IDENTICAL;if(d.nodeType==j.ELEMENT_NODE&&a.nodeType==j.ELEMENT_NODE){if(f.contains(d,a))return n.POSITION_CONTAINS+n.POSITION_PRECEDING;if(f.contains(a,d))return n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING;if("sourceIndex"in d)return 0>d.sourceIndex||0>a.sourceIndex?n.POSITION_DISCONNECTED:d.sourceIndex<a.sourceIndex?n.POSITION_PRECEDING:n.POSITION_FOLLOWING}for(var e=
f._4e_address(d),a=f._4e_address(a),h=Math.min(e.length,a.length),c=0;c<=h-1;c++)if(e[c]!=a[c])return e[c]<a[c]?n.POSITION_PRECEDING:n.POSITION_FOLLOWING;return e.length<a.length?n.POSITION_CONTAINS+n.POSITION_PRECEDING:n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING},_4e_address:function(d,b){for(var a=[],e=d.ownerDocument.documentElement,h=d;h&&h!=e;)a.unshift(f._4e_index(h,b)),h=h.parentNode;return a},_4e_remove:function(a,b){var f=a.parentNode;if(f){if(b)for(var e;e=a.firstChild;)f.insertBefore(a.removeChild(e),
a);f.removeChild(a)}return a},_4e_trim:function(a){f._4e_ltrim(a);f._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==f.NodeType.TEXT_NODE){var i=t.ltrim(b.nodeValue),e=b.nodeValue.length;if(i)i.length<e&&(f._4e_splitText(b,e-i.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==f.NodeType.TEXT_NODE){var i=t.rtrim(b.nodeValue),e=b.nodeValue.length;if(i)i.length<e&&(f._4e_splitText(b,i.length),
a.removeChild(a.lastChild));else{a.removeChild(b);continue}}break}!q.ie&&!q.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==f.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(d){for(var b=d.lastChild;b&&b.nodeType==f.NodeType.TEXT_NODE&&!a.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==f.NodeType.TEXT_NODE||"br"!==f.nodeName(b))b=q.opera?d.ownerDocument.createTextNode(""):d.ownerDocument.createElement("br"),q.gecko&&b.setAttribute("type","_moz"),d.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(d,b,f,e){var d=new m(d),h=d.data("list_marker_id")||d.data("list_marker_id",a.guid()).data("list_marker_id"),c=d.data("list_marker_names")||d.data("list_marker_names",{}).data("list_marker_names");b[h]=d;c[f]=1;return d.data(f,e)},_4e_clearMarkers:function(a,b,f){var a=new m(a),e=a.data("list_marker_names"),h=a.data("list_marker_id"),c;for(c in e)a.removeData(c);a.removeData("list_marker_names");
f&&(a.removeData("list_marker_id"),delete b[h])},_4e_copyAttributes:function(a,b,i){for(var b=new m(b),e=a.attributes,i=i||{},h=0;h<e.length;h++){var c=e[h],l=c.name.toLowerCase(),s;if(!(l in i))if("checked"==l&&(s=f.attr(a,l)))b.attr(l,s);else if(c.specified||q.ie&&c.value&&"value"==l)s=f.attr(a,l),null===s&&(s=c.nodeValue),b.attr(l,s)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=f.nodeName(a);return(a=!g.$nonEditable[a]&&(g[a]||g.span))&&a["#text"]},_4e_getByAddress:function(a,
b,f){for(var a=a.documentElement,e=0;a&&e<b.length;e++){var h=b[e];if(f)for(var c=-1,l=0;l<a.childNodes.length;l++){var s=a.childNodes[l];if(!(!0===f&&3==s.nodeType&&s.previousSibling&&3==s.previousSibling.nodeType)&&(c++,c==h)){a=s;break}}else a=a.childNodes[h]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(a){function k(a){1>arguments.length||(this.range=a,this.forceBrBreak=p,this.enlargeBr=t,this.enforceRealBlocks=p,this._||(this._={}))}var t=!0,p=!1,o=a.Editor,g=a.UA,f=o.Walker,j=o.Range,q=o.RANGE,m=o.ElementPath,w=a.Node,n=a.DOM,y=/^[\r\n\t ]*$/;a.augment(k,{getNextParagraph:function(k){var i,d,b,u,e;if(!this._.lastNode){d=this.range.clone();d.shrink(q.SHRINK_ELEMENT,t);d.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);
var h=new f(d),c=f.bookmark(t,t);h.evaluator=c;this._.nextNode=h.next();h=new f(d);h.evaluator=c;h=h.previous();this._.lastNode=h._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==n.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(c=new j(d.document),c.moveToPosition(this._.lastNode,q.POSITION_AFTER_END),c.checkEndOfBlock()&&(c=new m(c.endContainer),this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(t)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new w(d.document.createTextNode("")),n.insertAfter(this._.lastNode[0],h[0]));d=null}c=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;c;){var l=p,s=c[0].nodeType!=n.NodeType.ELEMENT_NODE,A=p;if(s)c[0].nodeType==n.NodeType.TEXT_NODE&&y.test(c[0].nodeValue)&&(s=p);else{var C=c.nodeName();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==C)s=t;else if(!d&&!c[0].childNodes.length&&"hr"!=C){i=c;b=c.equals(h);break}d&&(d.setEndAt(c,q.POSITION_BEFORE_START),
"br"!=C&&(this._.nextNode=c));l=t}else{if(c[0].firstChild){d||(d=new j(this.range.document),d.setStartAt(c,q.POSITION_BEFORE_START));c=new w(c[0].firstChild);continue}s=t}}s&&!d&&(d=new j(this.range.document),d.setStartAt(c,q.POSITION_BEFORE_START));b=(!l||s)&&c.equals(h);if(d&&!l)for(;!c[0].nextSibling&&!b;){C=c.parent();if(C._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=t;b||C.equals(h);break}c=C;s=t;b=c.equals(h);A=t}s&&d.setEndAt(c,q.POSITION_AFTER_END);c=c._4e_nextSourceNode(A,null,h);if((b=
!c)||l&&d)break}if(!i){if(!d)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;i=new m(d.startContainer);c=i.blockLimit;l={div:1,th:1,td:1};i=i.block;if((!i||!i[0])&&!this.enforceRealBlocks&&l[c.nodeName()]&&d.checkStartOfBlock()&&d.checkEndOfBlock())i=c;else if(!i||this.enforceRealBlocks&&"li"==i.nodeName())i=new w(this.range.document.createElement(k||"p")),i[0].appendChild(d.extractContents()),i._4e_trim(),d.insertNode(i),u=e=t;else if("li"!=i.nodeName()){if(!d.checkStartOfBlock()||
!d.checkEndOfBlock())i=i.clone(p),i[0].appendChild(d.extractContents()),i._4e_trim(),e=d.splitBlock(),u=!e.wasStartOfBlock,e=!e.wasEndOfBlock,d.insertNode(i)}else b||(this._.nextNode=i.equals(h)?null:d.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,h))}u&&(d=new w(i[0].previousSibling),d[0]&&d[0].nodeType==n.NodeType.ELEMENT_NODE&&("br"==d.nodeName()?d._4e_remove():d[0].lastChild&&"br"==n.nodeName(d[0].lastChild)&&n._4e_remove(d[0].lastChild)));e&&(d=f.bookmark(p,t),u=new w(i[0].lastChild),
u[0]&&u[0].nodeType==n.NodeType.ELEMENT_NODE&&"br"==u.nodeName()&&(g.ie||u.prev(d,1)||u.next(d,1))&&u.remove());this._.nextNode||(this._.nextNode=b||i.equals(h)?null:i._4e_nextSourceNode(t,null,h));return i}});j.prototype.createIterator=function(){return new k(this)};return k},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(a){function k(a){for(var m=g,k=g,n=[];a;){if(a[0].nodeType==p.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var y=a.nodeName();if(!k&&(!m&&f[y]&&(m=a),j[y])){var v;if(v=!m)if(v="div"==y){a:{v=a[0].childNodes;for(var i=0,d=v.length;i<d;i++){var b=v[i];if(b.nodeType==p.NodeType.ELEMENT_NODE&&o.$block[b.nodeName.toLowerCase()]){v=!0;break a}}v=!1}v=!v}v?m=a:k=a}n.push(a);if("body"==y)break}a=a.parent()}this.block=m;this.blockLimit=k;this.elements=
n}var t=a.Editor,p=a.DOM,o=t.XHTML_DTD,g=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};k.prototype={constructor:k,compare:function(a){var f=this.elements,a=a&&a.elements;if(!a||f.length!=a.length)return!1;for(var g=0;g<f.length;g++)if(!p.equals(f[g],a[g]))return!1;return!0},contains:function(a){for(var f=this.elements,j=0;j<f.length;j++)if(f[j].nodeName()in a)return f[j];return g},toString:function(){var a=
this.elements,f,g=[];for(f=0;f<a.length;f++)g.push(a[f].nodeName());return g.toString()}};return t.ElementPath=k},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(a,k,t,p){function o(g){var k;k=g.getSelection().getRanges();for(var o=k.length-1;0<o;o--)k[o].deleteContents();k=k[0];o=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var i=(new p(k.startContainer)).block;if(i&&("li"==i.nodeName()||"li"==i.parent().nodeName()))return g.hasCommand("outdent")?(g.execCommand("save"),g.execCommand("outdent"),g.execCommand("save"),!0):!1}var d=k.splitBlock("p");if(!d)return!0;var g=d.previousBlock,i=d.nextBlock,b=d.wasStartOfBlock,
u=d.wasEndOfBlock,e;if(i)e=i.parent(),"li"==e.nodeName()&&(i._4e_breakParent(e),i._4e_move(i.next(),!0));else if(g&&(e=g.parent())&&"li"==e.nodeName())g._4e_breakParent(e),k.moveToElementEditablePosition(g.next()),g._4e_move(g.prev());if(!b&&!u){if("li"==i.nodeName()&&(e=i.first(t.invisible(!0)))&&a.inArray(e.nodeName(),["ul","ol"]))(f.ie?new m(o.createTextNode("\u00a0")):new m(o.createElement("br"))).insertBefore(e);i&&k.moveToElementEditablePosition(i)}else{var h;if(g){if("li"==g.nodeName()||!j.test(g.nodeName()))h=
g.clone()}else i&&(h=i.clone());h||(h=new m("<p>",null,o));if(e=d.elementPath)for(var d=0,c=e.elements.length;d<c;d++){var l=e.elements[d];if(l.equals(e.block)||l.equals(e.blockLimit))break;q.$removeEmpty[l.nodeName()]&&(l=l.clone(),h._4e_moveChildren(l),h.append(l))}f.ie||h._4e_appendBogus();k.insertNode(h);if(f.ie&&b&&(!u||!g[0].childNodes.length))k.moveToElementEditablePosition(u?g:h),k.select();k.moveToElementEditablePosition(b&&!u?i:h)}f.ie||(i?(h=new m(o.createElement("span")),h.html("&nbsp;"),
k.insertNode(h),h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),k.deleteContents()):h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));k.select();return!0}function g(a){var f=a.get("document")[0];w.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){a.execCommand("save");var g=a.execCommand("enterBlock");a.execCommand("save");!1!==g&&f.preventDefault()}})}var f=a.UA,j=/^h[1-6]$/,q=k.XHTML_DTD,
m=a.Node,w=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:o});a.docReady(function(){g(a)})}}},{requires:["./base","./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(a){function k(){var a=this;a.__iframeFocus=q;j=a;f&&clearTimeout(f);f=setTimeout(function(){a.fire("focus")},100)}function t(){var a=this;a.__iframeFocus=m;j=w;f&&clearTimeout(f);f=setTimeout(function(){a.fire("blur")},100)}var p=a.Editor,o=a.Event,g={},f,j,a={refreshAll:function(){for(var a in g){var f=g[a].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return j},getInstance:function(a){return g[a]},add:function(a){var f=
a.get("window")[0];o.on(f,"focus",k,a);o.on(f,"blur",t,a)},register:function(a){g[a._UUID]=a},remove:function(a){delete g[a._UUID];var f=a.get("window")[0];o.remove(f,"focus",k,a);o.remove(f,"blur",t,a)}},q=!0,m=!1,w=null;a.refreshAll=a.refreshAll;p.focusManager=a;p.getInstances=function(){return g};return a},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(a,k){return{init:function(t){function p(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function o(a){return a.replace(y,function(a,b,c){return"<"+b+c.replace(v,function(a,b){return-1==c.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function g(a){return a.replace(d,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function f(c){return c.replace(b,function(b,c){return a.urlDecode(c)})}var j=a.Node,q=a.UA,m=a.require("htmlparser"),w=new m.Filter,n=new m.Filter;(function(){function b(a){a=m.serialize(a);return new m.Comment(i+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var e={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:p}},h={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,e=0;e<b.length;e++)c="_ke_saved_"+b[e],a.getAttribute(c)&&a.removeAttribute(b[e]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:p},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],text:function(a){if(q.webkit)return a.replace(/\u200b/g,"")},comment:function(b){if(b.substr(0,i.length)==i)return b=a.trim(a.urlDecode(b.substr(i.length))),m.parse(b).childNodes[0]}};q.ie&&(h.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});w.addRules(h);n.addRules(e)})();(function(){function b(c){for(var c=c.childNodes,e=c.length,r=c[e-1];r&&3==r.nodeType&&!a.trim(r.nodeValue);)r=c[--e];return r}function e(a,r){var h=b(a);h&&
((r||!q.ie)&&1==h.nodeType&&"br"==h.nodeName?a.removeChild(h):3==h.nodeType&&g.test(h.nodeValue)&&a.removeChild(h))}function h(a){var e=b(a);return!e||1==e.nodeType&&"br"==e.nodeName||"form"==a.nodeName&&"input"==e.nodeName}function d(a){e(a,!0);h(a)&&(q.ie?a.appendChild(new m.Text("\u00a0")):(a.appendChild(new m.Text("&nbsp;")),a.appendChild(new m.Tag("br"))))}function f(a){e(a,!1);h(a)&&a.appendChild(new m.Text("\u00a0"))}var g=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=k.XHTML_DTD,r=a.merge(i.$block,i.$listItem,i.$tableContent),
D;for(D in r)"br"in i[D]||delete r[D];delete r.td;delete r.pre;var i={tags:{}},x={tags:{}};for(D in r)i.tags[D]=d,x.tags[D]=f;n.addRules(i);w.addRules(x)})();w.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var y=/<(a|area|img|input)\b([^>]*)>/gi,v=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,i="{ke_protected}",d=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,b=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
u=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,e=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,h=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;t.htmlDataProcessor={dataFilter:n,htmlFilter:w,toHtml:function(a){var b=new m.BeautifyWriter;(new m.Parser(a)).parse().writeHtml(b,w);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||n,a=g(a),a=o(a),a=a.replace(u,"$1ke:$2"),a=a.replace(h,"<ke:$1$2></ke:$1>"),d=new j("<div>");d.html("a"+
a);a=d.html().substr(1);a=a.replace(e,"$1$2");a=f(a);d=new m.BasicWriter;(new m.Parser(a)).parse().writeHtml(d,b);return a=d.getHtml()},toServer:function(a){var b=new m.MinifyWriter;(new m.Parser(a)).parse().writeHtml(b,w);return b.getHtml()}}}}},{requires:["./base"]});
(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor","button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor",
"editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor"]}});
a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor",
"editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});
a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});
a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-right":{requires:["editor"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor",
"editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor"]}});
a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn"]}});
a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});
a({"editor/plugin/resize":{requires:["editor","dd/base"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader",
"editor/plugin/contextmenu"]}});a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor",
"editor/plugin/list-utils/btn"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["htmlparser"]}});a({"editor/plugin/xiami-music":{requires:["editor",
"editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA);
KISSY.add("editor/core/range",function(a,k,t,p,o){function g(c){var h=c.nodeType!=b.NodeType.TEXT_NODE&&b.nodeName(c)in e.$removeEmpty,d=c.nodeType==b.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return h||d||c}function f(a){return!s(a)&&!A(a)}function j(e){var c=y;return function(h){if(A(h))return n;if(h.nodeType==b.NodeType.TEXT_NODE){if(a.trim(h.nodeValue).length)return y}else if(h.nodeType==b.NodeType.ELEMENT_NODE&&(h=b.nodeName(h),!E[h]))if(!e&&!u.ie&&
"br"==h&&!c)c=n;else return y;return n}}function q(a,e){var c=a.startContainer,d=a.endContainer,f=a.startOffset,l=a.endOffset,g,s=y,i=y,j=void 0,k=a.document,m;0<e&&(j=k.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();d[0].nodeType==b.NodeType.TEXT_NODE?(i=n,d=d._4e_splitText(l)):0<d[0].childNodes.length&&(l>=d[0].childNodes.length?(d=new h(d[0].appendChild(k.createTextNode(""))),m=n):d=new h(d[0].childNodes[l]));c[0].nodeType==b.NodeType.TEXT_NODE?(s=n,c._4e_splitText(f)):
f?f>=c[0].childNodes.length?(c=new h(c[0].appendChild(k.createTextNode(""))),g=n):c=new h(c[0].childNodes[f].previousSibling):(g=new h(k.createTextNode("")),c.prepend(g),c=g,g=n);var H=c._4e_parents(),K=d._4e_parents();H.each(function(a,b){H[b]=a});K.each(function(a,b){K[b]=a});for(var F,M,k=0;k<H.length&&!(F=H[k],M=K[k],!F.equals(M));k++);for(var f=j,B,J,A=k;A<H.length;A++){B=H[A];l=0<e&&!B.equals(c)?f.appendChild(B.clone()[0]):null;B=B[0].nextSibling;J=K[A];for(var q=d[0],u=J&&J[0];B&&!(u==B||q==
B);)J=B.nextSibling,2==e?f.appendChild(B.cloneNode(n)):(b._4e_remove(B),1==e&&f.appendChild(B)),B=J;l&&(f=l)}for(f=j;k<K.length;k++){B=K[k];l=0<e&&!B.equals(d)?f.appendChild(B.clone()[0]):null;if(!H[k]||!B._4e_sameLevel(H[k]))for(B=B[0].previousSibling;B;)J=B.previousSibling,2==e?f.insertBefore(B.cloneNode(n),f.firstChild):(b._4e_remove(B),1==e&&f.insertBefore(B,f.firstChild)),B=J;l&&(f=l)}if(2==e){if(s&&(F=c[0],F.nodeType==b.NodeType.TEXT_NODE&&F.nextSibling&&F.nextSibling.nodeType==b.NodeType.TEXT_NODE&&
(F.data+=F.nextSibling.data,F.parentNode.removeChild(F.nextSibling))),i)i=d[0],i.nodeType==b.NodeType.TEXT_NODE&&i.previousSibling&&i.previousSibling.nodeType==b.NodeType.TEXT_NODE&&(i.previousSibling.data+=i.data,i.parentNode.removeChild(i))}else{if(F&&M&&(!c._4e_sameLevel(F)||!d._4e_sameLevel(M)))i=F._4e_index(),g&&F._4e_sameLevel(c)&&i--,a.setStart(F.parent(),i+1);a.collapse(n)}g&&c.remove();m&&d.remove();return j}function m(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function w(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=v;this.collapsed=n;this.document=a}k.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,y=!1,v=null,i=k.RANGE,d=k.POSITION,b=a.DOM,u=a.UA,e=k.XHTML_DTD,h=a.Node,c=h.all,l={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},s=new p.whitespaces,A=new p.bookmark,C=p.whitespaces(n),z=p.bookmark(!1,!0),E={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(w,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=
this.startContainer,c=this.startOffset;a[0].nodeType!=b.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=b.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,c){a[0].nodeType==b.NodeType.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);m(this)},
setEnd:function(a,c){a[0].nodeType==b.NodeType.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+1);this.endContainer=a;this.endOffset=c;this.startContainer||(this.startContainer=a,this.startOffset=c);m(this)},setStartAt:function(a,c){switch(c){case i.POSITION_AFTER_START:this.setStart(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==b.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setStartBefore(a);
break;case i.POSITION_AFTER_END:this.setStartAfter(a)}m(this)},setEndAt:function(a,c){switch(c){case i.POSITION_AFTER_START:this.setEnd(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==b.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setEndBefore(a);break;case i.POSITION_AFTER_END:this.setEndAfter(a)}m(this)},cloneContents:function(){return q(this,2)},deleteContents:function(){return q(this,0)},extractContents:function(){return q(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new w(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=b.NodeType.ELEMENT_NODE||
a.endContainer[0].nodeType!=b.NodeType.ELEMENT_NODE)return v;var c=new p(a);c.evaluator=function(a){return C(a)&&z(a)};a=c.next();c.reset();c=c.previous();return a&&a.equals(c)?a:v},shrink:function(a,c){if(!this.collapsed){var a=a||i.SHRINK_TEXT,e=this.clone(),h=this.startContainer,d=this.endContainer,f=this.startOffset,l=this.endOffset,g=n,s,j,k=n;h&&h[0].nodeType==b.NodeType.TEXT_NODE&&(f?f>=h[0].nodeValue.length?e.setStartAfter(h):(e.setStartBefore(h),g=y):e.setStartBefore(h));d&&d[0].nodeType==
b.NodeType.TEXT_NODE&&(l?l>=d[0].nodeValue.length?e.setEndAfter(d):(e.setEndAfter(d),k=y):e.setEndBefore(d));if(g||k)j=new p(e),j.evaluator=function(c){return c.nodeType==(a==i.SHRINK_ELEMENT?b.NodeType.ELEMENT_NODE:b.NodeType.TEXT_NODE)},j.guard=function(c,e){if(a==i.SHRINK_ELEMENT&&c.nodeType==b.NodeType.TEXT_NODE||e&&c==s)return y;!e&&c.nodeType==b.NodeType.ELEMENT_NODE&&(s=c);return n};g&&(e=j[a==i.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,c?i.POSITION_AFTER_START:i.POSITION_BEFORE_START);
k&&(j.reset(),(j=j[a==i.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,c?i.POSITION_BEFORE_END:i.POSITION_AFTER_END));return g||k}},createBookmark2:function(a){var c=this.startContainer,e=this.endContainer,d=this.startOffset,f=this.endOffset,l,g;if(!c||!e)return{start:0,end:0};if(a){if(c[0].nodeType==b.NodeType.ELEMENT_NODE&&(l=new h(c[0].childNodes[d]))&&l[0]&&l[0].nodeType==b.NodeType.TEXT_NODE&&0<d&&l[0].previousSibling.nodeType==b.NodeType.TEXT_NODE)c=l,d=0;for(;c[0].nodeType==
b.NodeType.TEXT_NODE&&(g=c.prev(void 0,1))&&g[0].nodeType==b.NodeType.TEXT_NODE;)c=g,d+=g[0].nodeValue.length;if(!this.collapsed){if(e[0].nodeType==b.NodeType.ELEMENT_NODE&&(l=new h(e[0].childNodes[f]))&&l[0]&&l[0].nodeType==b.NodeType.TEXT_NODE&&0<f&&l[0].previousSibling.nodeType==b.NodeType.TEXT_NODE)e=l,f=0;for(;e[0].nodeType==b.NodeType.TEXT_NODE&&(g=e.prev(void 0,1))&&g[0].nodeType==b.NodeType.TEXT_NODE;)e=g,f+=g[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?v:e._4e_address(a),
startOffset:d,endOffset:f,normalized:a,is2:n}},createBookmark:function(b){var c,e,d,f,l=this.collapsed;c=new h("<span>",v,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(d=a.guid("ke_bm_"),c.attr("id",d+"S"));l||(e=c.clone(),e.html("&nbsp;"),b&&e.attr("id",d+"E"),f=this.clone(),f.collapse(),f.insertNode(e));f=this.clone();f.collapse(n);f.insertNode(c);e?(this.setStartAfter(c),this.setEndBefore(e)):this.moveToPosition(c,i.POSITION_AFTER_END);return{startNode:b?
d+"S":c,endNode:b?d+"E":e,serializable:b,collapsed:l}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,c){var e=this.startContainer,d=this.startOffset,h=this.collapsed;if((!a||h)&&e[0]&&e[0].nodeType==b.NodeType.TEXT_NODE){if(d)if(d>=e[0].nodeValue.length)d=e._4e_index()+1,e=e.parent();else{var f=e._4e_splitText(d),d=e._4e_index()+1,e=e.parent();b.equals(this.startContainer,this.endContainer)?this.setEnd(f,this.endOffset-this.startOffset):b.equals(e,this.endContainer)&&
(this.endOffset+=1)}else d=e._4e_index(),e=e.parent();this.setStart(e,d);if(h){this.collapse(n);return}}e=this.endContainer;d=this.endOffset;!c&&!h&&e[0]&&e[0].nodeType==b.NodeType.TEXT_NODE&&(d?(d>=e[0].nodeValue.length||e._4e_splitText(d),d=e._4e_index()+1):d=e._4e_index(),e=e.parent(),this.setEnd(e,d))},insertNode:function(a){this.optimizeBookmark();this.trim(y,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(b){var e=c(this.document);if(b.is2){var d=e._4e_getByAddress(b.start,b.normalized),h=b.startOffset,e=b.end&&e._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(d,h);e?this.setEnd(e,b):this.collapse(n)}else d=(h=b.serializable)?a.one("#"+b.startNode,e):b.startNode,b=h?a.one("#"+b.endNode,e):b.endNode,this.setStartBefore(d),d._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,e){var c=
this.startContainer,d=this.endContainer,c=c[0]==d[0]?a&&c[0].nodeType==b.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new h(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(d);return e&&c[0].nodeType==b.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(e,d,h,f){var l=e[d?"startContainer":"endContainer"],g,i=d?0:1,r=0,j=d?"previousSibling":"nextSibling";g=e[d?"startOffset":"endOffset"];if(l[0].nodeType==b.NodeType.TEXT_NODE){if(d){if(g)return}else if(g<l[0].nodeValue.length)return;
g=l[0][j];l=l[0].parentNode}else g=l[0].childNodes[g+(d?-1:1)]||null,l=l[0];for(;l;){for(;g;)if(s(g)||A(g))g=g[j];else break;if(g){if(!r)e[d?"setStartAfter":"setEndBefore"](c(g));break}l=c(l);if("body"==l.nodeName())break;if(r||l.equals(f))h[i]=l,r=1;else e[d?"setStartBefore":"setEndAfter"](l);g=l[0][j];l=l[0].parentNode}}return function(e){switch(e){case i.ENLARGE_ELEMENT:if(this.collapsed)break;var e=this.getCommonAncestor(),d=[];a(this,1,d,e);a(this,0,d,e);d[0]&&d[1]&&(e=d[0].contains(d[1])?d[1]:
d[0],this.setStartBefore(e),this.setEndAfter(e));break;case i.ENLARGE_BLOCK_CONTENTS:case i.ENLARGE_LIST_ITEM_CONTENTS:var l=new w(this.document),d=new h(this.document.body);l.setStartAt(d,i.POSITION_AFTER_START);l.setEnd(this.startContainer,this.startOffset);var l=new p(l),f,g,s=p.blockBoundary(e==i.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:v),j=function(a){var b=s(a);b||(f=c(a));return b},k=function(a){var e=j(a);!e&&"br"==b.nodeName(a)&&(g=c(a));return e};l.guard=j;l=l.lastBackward();f=f||d;this.setStartAt(f,
"br"!=f.nodeName()&&(!l&&this.checkStartOfBlock()||l&&f.contains(l))?i.POSITION_AFTER_START:i.POSITION_AFTER_END);l=this.clone();l.collapse();l.setEndAt(d,i.POSITION_BEFORE_END);l=new p(l);l.guard=e==i.ENLARGE_LIST_ITEM_CONTENTS?k:j;f=v;l=l.lastForward();f=f||d;this.setEndAt(f,!l&&this.checkEndOfBlock()||l&&f.contains(l)?i.POSITION_BEFORE_END:i.POSITION_BEFORE_START);g&&this.setEndAfter(g)}}}(),checkStartOfBlock:function(){var e=this.startContainer,c=this.startOffset;if(c&&e[0].nodeType==b.NodeType.TEXT_NODE&&
a.trim(e[0].nodeValue.substring(0,c)).length)return y;this.trim();e=new o(this.startContainer);c=this.clone();c.collapse(n);c.setStartAt(e.block||e.blockLimit,i.POSITION_AFTER_START);e=new p(c);e.evaluator=j(n);return e.checkBackward()},checkEndOfBlock:function(){var e=this.endContainer,c=this.endOffset;if(e[0].nodeType==b.NodeType.TEXT_NODE&&a.trim(e[0].nodeValue.substring(c)).length)return y;this.trim();e=new o(this.endContainer);c=this.clone();c.collapse(y);c.setEndAt(e.block||e.blockLimit,i.POSITION_BEFORE_END);
e=new p(c);e.evaluator=j(y);return e.checkForward()},checkBoundaryOfElement:function(a,b){var e=this.clone();e[b==i.START?"setStartAt":"setEndAt"](a,b==i.START?i.POSITION_AFTER_START:i.POSITION_BEFORE_END);e=new p(e);e.evaluator=g;return e[b==i.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,e=this.endContainer,h=this.startOffset,l=this.endOffset,f;if(a[0].nodeType==b.NodeType.ELEMENT_NODE)if(f=a[0].childNodes.length,f>h)a=c(a[0].childNodes[h]);else if(0==
f)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=c(a);a=a._4e_nextSourceNode()||a}if(e[0].nodeType==b.NodeType.ELEMENT_NODE)if(f=e[0].childNodes.length,f>l)e=c(e[0].childNodes[l])._4e_previousSourceNode(n);else if(0==f)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=c(e)}a._4e_position(e)&d.POSITION_FOLLOWING&&(a=e);return{startNode:a,endNode:e}},fixBlock:function(a,b){var e=this.createBookmark(),d=c(this.document.createElement(b));this.collapse(a);
this.enlarge(i.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();u.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(e);return d},splitBlock:function(b){var e=new o(this.startContainer),c=new o(this.endContainer),d=e.block,h=c.block,l=v;if(!e.blockLimit.equals(c.blockLimit))return v;"br"!=b&&(d||(d=this.fixBlock(n,b),h=(new o(this.endContainer)).block),h||(h=this.fixBlock(y,b)));b=d&&this.checkStartOfBlock();e=h&&this.checkEndOfBlock();this.deleteContents();
d&&d[0]==h[0]&&(e?(l=new o(this.startContainer),this.moveToPosition(h,i.POSITION_AFTER_END),h=v):b?(l=new o(this.startContainer),this.moveToPosition(d,i.POSITION_BEFORE_START),d=v):(h=this.splitElement(d),!u.ie&&!a.inArray(d.nodeName(),["ul","ol"])&&d._4e_appendBogus()));return{previousBlock:d,nextBlock:h,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:l}},splitElement:function(a){if(!this.collapsed)return v;this.setEndAt(a,i.POSITION_BEFORE_END);var b=this.extractContents(),e=a.clone(y);e[0].appendChild(b);
e.insertAfter(a);this.moveToPosition(a,i.POSITION_AFTER_END);return e},moveToElementEditablePosition:function(a,e){for(var c=0;a;){if(a[0].nodeType==b.NodeType.TEXT_NODE){this.moveToPosition(a,e?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);c=1;break}a[0].nodeType==b.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,e?i.POSITION_BEFORE_END:i.POSITION_AFTER_START),c=1);var d=a,h=c,l=void 0;d[0].nodeType==b.NodeType.ELEMENT_NODE&&d._4e_isEditable()&&(l=d[e?"last":"first"](f,1));!h&&
!l&&(l=d[e?"prev":"next"](f,1));a=l}return!!c},selectNodeContents:function(a){var e=a[0];this.setStart(a,0);this.setEnd(a,e.nodeType==b.NodeType.TEXT_NODE?e.nodeValue.length:e.childNodes.length)},insertNodeByDtd:function(a){var b,c,d,h=a.nodeName();b=e.$block[h];this.deleteContents();if(b){for(b=this.getCommonAncestor(y,n);(c=e[b.nodeName()])&&(!c||!c[h]);){var l=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(n),b.remove()):d=b;b=l}d&&this.splitElement(d)}this.insertNode(a)}});
t.injectDom({_4e_breakParent:function(a,b){var b=c(b),a=c(a),e,d=new k.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);e=d.extractContents();d.insertNode(a.remove());a.after(e)}});return k.Range=w},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(a){function k(a){this.document=a;this._={cache:{}};if(n)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=o}catch(c){this.isInvalid=o}}function t(a){a=new k(a);return!a||a.isInvalid?g:a}var p=a.Editor;p.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var o=!0,g=null,f=a.UA,j=a.DOM,q=a.Node,m=p.SELECTION,w=p.RANGE,n=f.ie,y=p.Walker,v=p.Range,
i={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(k,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=j.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var a=this._.cache;if(a.type)return a.type;var b=m.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=
c.getRangeAt(0),d=c.startContainer;d==c.endContainer&&d.nodeType==j.NodeType.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&i[d.childNodes[c.startOffset].nodeName.toLowerCase()]&&(b=m.SELECTION_ELEMENT)}}else b=m.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=m.SELECTION_NONE;try{var c=this.getNative(),d=c.type;"Text"==d&&(b=m.SELECTION_TEXT);"Control"==d&&(b=m.SELECTION_ELEMENT);c.createRange().parentElement&&(b=m.SELECTION_TEXT)}catch(f){}return a.type=
b},getRanges:n?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var e=a.parentElement(),d=e.childNodes,f,i=0;i<d.length;i++){var k=d[i];if(k.nodeType==j.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(k);var k=f.compareEndPoints("StartToStart",a),m=f.compareEndPoints("EndToStart",a);f.collapse();if(0<k)break;else{if(!k||1==m&&-1==k)return{container:e,offset:i};if(!m)return{container:e,offset:i+1}}f=g}}f||(f=a.duplicate(),f.moveToElementText(e),f.collapse(!1));f.setEndPoint("StartToStart",
a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=d[--i].nodeValue.length}catch(q){f=0}return 0===f?{container:e,offset:i}:{container:d[i],offset:-f}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var d=this.getNative(),b=d&&d.createRange(),f=this.getType();if(!d)return[];if(f==m.SELECTION_TEXT)return d=new v(this.document),f=a(b,o),d.setStart(new q(f.container),f.offset),f=a(b),d.setEnd(new q(f.container),f.offset),c.ranges=[d];if(f==m.SELECTION_ELEMENT){c=
c.ranges=[];for(f=0;f<b.length;f++){for(var g=b.item(f),i=g.parentNode,j=0,d=new v(this.document);j<i.childNodes.length&&i.childNodes[j]!=g;j++);d.setStart(new q(i),j);d.setEnd(new q(i),j+1);c.push(d)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var f=c.getRangeAt(d),g=new v(this.document);g.setStart(new q(f.startContainer),f.startOffset);g.setEnd(new q(f.endContainer),f.endOffset);
a.push(g)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case m.SELECTION_ELEMENT:return this.getSelectedElement();case m.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();o;)if(b=d.startContainer,d.startOffset==(b[0].nodeType===j.NodeType.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())d.setStartAfter(b);else break;b=d.startContainer;
if(b[0].nodeType!=j.NodeType.ELEMENT_NODE)return b.parent();b=new q(b[0].childNodes[d.startOffset]);if(!b[0]||b[0].nodeType!=j.NodeType.ELEMENT_NODE)return d.startContainer;for(d=b[0].firstChild;d&&d.nodeType==j.NodeType.ELEMENT_NODE;)b=new q(d),d=d.firstChild;return b}if(n)d=c.createRange(),d.collapse(o),b=new q(d.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=j.NodeType.ELEMENT_NODE)b=b.parentNode;b&&(b=new q(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;
if(void 0!==b.selectedElement)return b.selectedElement;n&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var c;if(a)c=new q(a);else{a=this.getRanges()[0];for(var d,f=2;f&&(!(c=a.getEnclosedNode())||!(c[0].nodeType==j.NodeType.ELEMENT_NODE&&i[c.nodeName()]&&(d=c)));f--)a.shrink(w.SHRINK_ELEMENT);c=d}return b.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(n)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(d){b=c.body.createTextRange(),
b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(n){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var d=a[c],g=this.document.createRange(),i=d.startContainer;if(d.collapsed&&(f.gecko&&1.09>f.gecko||f.opera||f.webkit)&&i[0].nodeType==
j.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),d.startOffset++,d.endOffset++;g.setStart(i[0],d.startOffset);g.setEnd(d.endContainer[0],d.endOffset);b.addRange(g)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(b,d){for(var c=[],f=this.document,g,d=d||this.getRanges(),i=d.length,k=0;k<i;k++){c.push(g=d[k].createBookmark(b,
o));var m=(b=g.serializable)?a.one("#"+g.startNode,f):g.startNode;g=b?a.one("#"+g.endNode,f):g.endNode;for(var q=k+1;q<i;q++){var n=d[q],u=n.startContainer,x=n.endContainer;j.equals(u,m.parent())&&n.startOffset++;j.equals(u,g.parent())&&n.startOffset++;j.equals(x,m.parent())&&n.endOffset++;j.equals(x,g.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var d=new v(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var d={table:1,tbody:1,tr:1},b=y.whitespaces(o),u=/\ufeff|\u00a0/;v.prototype.select=v.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
j.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(o),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var f=this.collapsed,c,g;if(this.startContainer[0]===this.endContainer[0]&&
1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==j.NodeType.ELEMENT_NODE){(new k(this.document)).selectElement(new q(i));return}}(this.startContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in d||this.endContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in d)&&this.shrink(w.SHRINK_ELEMENT,o);var m=this.createBookmark(),i=m.startNode,n;f||(n=m.endNode);m=this.document.body.createTextRange();
m.moveToElementText(i[0]);m.moveStart("character",1);if(n)a=this.document.body.createTextRange(),a.moveToElementText(n[0]),m.setEndPoint("EndToEnd",a),m.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!b(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(u))&&(a||!i[0].previousSibling||i[0].previousSibling&&"br"==j.nodeName(i[0].previousSibling));g=new q(this.document.createElement("span"));g.html("&#65279;");g.insertBefore(i);c&&j.insertBefore(this.document.createTextNode("\ufeff"),i[0]||
i)}this.setStartBefore(i);i._4e_remove();if(f){if(c?(m.moveStart("character",-1),m.select(),this.document.selection.clear()):m.select(),g)this.moveToPosition(g,w.POSITION_BEFORE_START),g._4e_remove()}else this.setEndBefore(n),n._4e_remove(),m.select()};k.getSelection=t;return p.Selection=k},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(a,k){function t(a){function d(a,b){var d=c.body.createTextRange();try{d.moveToPoint(a,b)}catch(e){d=q}return d}function b(){var a=c.selection.createRange();g&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&g.select();w.remove(c,"mouseup",b);w.remove(c,"mousemove",f);g=e=0}function f(a){if(a.button){if(a=d(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",g)?a.setEndPoint("StartToStart",g):a.setEndPoint("EndToEnd",g),a.select()}else b()}var e,h=a.get("window")[0],
c=a.get("document")[0],g;w.on(c,"mousedown contextmenu",function(a){var i=c.documentElement;if(a.target===i&&(e&&b(),!(i.scrollHeight>i.clientHeight)&&(e=1,g=d(a.pageX,a.pageY))))w.on(c,"mouseup",b),w.on(c,"mousemove",f),h.focus(),g.select()})}function p(a){function d(e){if(c){var g=a.getSelection(),l=g&&g.getType(),j=g&&b.selection;if(e&&j&&l==v.SELECTION_NONE&&!b.queryCommandEnabled("InsertImage"))setTimeout(function(){d(f)},50);else{var k;if(!j||!j.type||!("Control"!=j.type&&(k=j.createRange())&&
(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))h=j&&g.getRanges()[0],a.checkSelectionChange()}}}var b=a.get("document")[0],g=new y(b.body),e=new y(b.documentElement);if(8>k.Utils.ieEngine)e.on("click",function(b){"html"===(new y(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var h,c,l=f;e.on("mousedown",function(){l=j});e.on("mouseup",function(){l=f});g.on("focusin",function(a){if("body"==(new y(a.target)).nodeName()&&h){try{l&&h.select()}catch(b){}h=
q}});g.on("focus",function(){c=f;d()});g.on("beforedeactivate",function(a){a.relatedTarget||(c=j,l=f)});g.on("mousedown",function(){c=j});g.on("mouseup",function(){c=f;setTimeout(function(){d(f)},0)});g.on("keydown",function(){c=j});g.on("keyup",function(){c=f;setTimeout(function(){d()},0)})}function o(a){var d=a.get("document")[0];w.on(d,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function g(a){function d(a){var b=k.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function b(a){return e(a)&&h(a)}var g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,e=k.Walker.whitespaces(f),h=k.Walker.bookmark(j,f),c=function(a){return e(a)&&8!=a.nodeType};a.on("selectionChange",function(e){var h=e.path,q=new y(a.get("document")[0].body),e=(e=e.selection)&&e.getRanges()[0],o=h.blockLimit;if(m.gecko){var p=h.block||h.blockLimit,t=p&&p.last(b);p&&p._4e_isBlockBoundary()&&(!t||!(1==t[0].nodeType&&
t._4e_isBlockBoundary()))&&"pre"!=p.nodeName()&&!p._4e_getBogus()&&p._4e_appendBogus()}if(e&&e.collapsed&&!h.block){if("body"==o.nodeName()){if((h=e.fixBlock(f,"p"))&&h[0]!=q[0].lastChild&&h._4e_outerHtml().match(g))if((o=h.next(c,1))&&o[0].nodeType==n.NodeType.ELEMENT_NODE&&!d[o])e.moveToElementEditablePosition(o),h._4e_remove();else if((o=h.prev(c,1))&&o[0].nodeType==n.NodeType.ELEMENT_NODE&&!d[o])e.moveToElementEditablePosition(o,o._4e_outerHtml().match(g)?j:f),h._4e_remove();e.select();a.notifySelectionChange()}h=
a.get("document")[0];e=new k.Range(h);e.moveToElementEditablePosition(q,f);"body"!==(new k.ElementPath(e.startContainer)).blockLimit.nodeName()&&(q=(new y(h.createElement("p"))).appendTo(q),m.ie||q._4e_appendBogus())}})}var f=!0,j=!1,q=null,m=a.UA,w=a.Event,n=a.DOM,y=a.Node,v=k.SELECTION;return{init:function(a){a.docReady(function(){m.ie?(t(a),p(a)):o(a)});g(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(a,k){function t(a){return!z.attr(a,"_ke_bookmark")}function p(a,b){for(var c in a)"string"==typeof a[c]?a[c]=a[c].replace(S,function(a,c){return b[c]}):p(a[c],b)}function o(b,c){c&&(b=a.clone(b),p(b,c));var d=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#text"==d||R[d]?E.STYLE_BLOCK:P[d]?E.STYLE_OBJECT:E.STYLE_INLINE;this._={definition:b}}function g(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var d=
new D(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function f(a,b,c){var d=a.element;"*"==d&&(d="span");b=new G(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=o.getStyleText(c);if(a)for(var e in a)b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function j(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var d,e=a.document;d=c.getNextParagraph();){var g=f(this,e,d),h=g,g="pre"==h.nodeName,i="pre"==
d.nodeName,j=!g&&i;g&&!i?(i=d,j=i.html(),j=q(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),I.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(h[0]),h[0].outerHTML="<pre>"+j+"</pre>",h=new G(i.firstChild),h._4e_remove()):h.html(j)):j?h=w(m(d),h):d._4e_moveChildren(h);d[0].parentNode.replaceChild(h[0],d[0]);if(g&&(d=h,g=void 0,(g=d._4e_previousSourceNode(l,z.NodeType.ELEMENT_NODE))&&
"pre"==g.nodeName()))h=q(g.html(),/\n$/,"")+"\n\n"+q(d.html(),/^\n/,""),I.ie?d[0].outerHTML="<pre>"+h+"</pre>":d.html(h),g._4e_remove()}a.moveToBookmark(b)}function q(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function m(a){var b=[];q(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,c){b.push(c)});return b}function w(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=q(e,/^[ \t]*\n/,""),e=q(e,/\n$/,""),e=q(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),f=b.clone();f.html(e);c.appendChild(f[0])}return c}
function n(a){var b=a.document;if(a.collapsed)b=f(this,b,void 0),a.insertNode(b),a.moveToPosition(b,r.POSITION_BEFORE_END);else{var c=this.element,d=this._.definition,g,h=L[c];h||(g=l,h=L.span);var i=a.createBookmark();a.enlarge(r.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),k=j.startNode,j=j.endNode,m=k,q;m&&m[0];){var n=s;if(z.equals(m,j))m=A,n=l;else{var o=m[0].nodeType,u=o==z.NodeType.ELEMENT_NODE?m.nodeName():A;if(u&&m.attr("_ke_bookmark")){m=m._4e_nextSourceNode(l);continue}if(!u||
h[u]&&(m._4e_position(j)|x.POSITION_PRECEDING|x.POSITION_IDENTICAL|x.POSITION_IS_CONTAINED)==x.POSITION_PRECEDING+x.POSITION_IDENTICAL+x.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(m))){var p=m.parent();if(p&&"a"==c&&p.nodeName()==c)o=f(this,b,void 0),p._4e_moveChildren(o),p[0].parentNode.replaceChild(o[0],p[0]),o._4e_mergeSiblings();else if(p&&p[0]&&((L[p.nodeName()]||L.span)[c]||g)&&(!d.parentRule||d.parentRule(p))){if(!q&&(!u||!L.$removeEmpty[u]||(m._4e_position(j)|x.POSITION_PRECEDING|x.POSITION_IDENTICAL|
x.POSITION_IS_CONTAINED)==x.POSITION_PRECEDING+x.POSITION_IDENTICAL+x.POSITION_IS_CONTAINED))q=new O(b),q.setStartBefore(m);if(o==z.NodeType.TEXT_NODE||o==z.NodeType.ELEMENT_NODE&&!m[0].childNodes.length){p=m;for(o=null;(n=!p.next(t,1))&&(o=p.parent())&&h[o.nodeName()]&&(o._4e_position(k)|x.POSITION_FOLLOWING|x.POSITION_IDENTICAL|x.POSITION_IS_CONTAINED)==x.POSITION_FOLLOWING+x.POSITION_IDENTICAL+x.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(o));)p=o;q.setEndAfter(p)}}else n=l}else n=l;m=m._4e_nextSourceNode()}if(n&&
q&&!q.collapsed){for(var n=f(this,b,void 0),p=q.getCommonAncestor(),o={},u={},v,w=null,y;n&&p&&n[0]&&p[0];){if(p.nodeName()==c){for(v in d.attributes)if(!u[v]&&(y=p.attr(w)))n.attr(v)==y?n.removeAttr(v):u[v]=1;for(w in d.styles)if(!o[w]&&(y=p.style(w)))n.style(w)==y?n.style(w,""):o[w]=1;if(!n._4e_hasAttributes()){n=A;break}}p=p.parent()}n?(n[0].appendChild(q.extractContents()),e(this,n),q.insertNode(n),n._4e_mergeSiblings(),I.ie||n[0].normalize()):(n=new G(b.createElement("span")),n[0].appendChild(q.extractContents()),
q.insertNode(n),e(this,n),n._4e_remove(!0));q=A}}k._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(r.SHRINK_TEXT)}}function y(a){a.enlarge(r.ENLARGE_ELEMENT);var c=a.createBookmark(),e=c.startNode;if(a.collapsed){for(var f=new N(e.parent()),g,i=0,j;i<f.elements.length&&(j=f.elements[i])&&!(j==f.block||j==f.blockLimit);i++)if(this.checkElementRemovable(j)){var l=a.checkBoundaryOfElement(j,r.END),k=!l&&a.checkBoundaryOfElement(j,r.START);k||l?(g=j,g.match=k?"start":"end"):(j._4e_mergeSiblings(),
j.nodeName()!=this.element?(l=d(this),h(j,l[j.nodeName()]||l["*"])):b(this,j))}if(g){j=e;for(i=0;;i++){l=f.elements[i];if(l.equals(g))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(j[0]);j=l}j["start"==g.match?"insertBefore":"insertAfter"](g);f=g.html();!f||"\u200b"==f?g.remove():I.webkit&&C(a.document.createTextNode("\u200b")).insertBefore(j)}}else{var m=c.endNode,n=this;g=function(){for(var a=new N(e.parent()),b=new N(m.parent()),c=A,d=A,f=0;f<a.elements.length;f++){var g=a.elements[f];
if(g==a.block||g==a.blockLimit)break;n.checkElementRemovable(g)&&(c=g)}for(f=0;f<b.elements.length;f++){g=b.elements[f];if(g==b.block||g==b.blockLimit)break;n.checkElementRemovable(g)&&(d=g)}d&&m._4e_breakParent(d);c&&e._4e_breakParent(c)};g();for(f=new G(e[0].nextSibling);f[0]!==m[0];){i=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(f)&&(f.nodeName()==this.element?b(this,f):(j=d(this),h(f,j[f.nodeName()]||j["*"])),i[0].nodeType==z.NodeType.ELEMENT_NODE&&
i.contains(e)))g(),i=new G(e[0].nextSibling);f=i}}a.moveToBookmark(c)}function v(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function i(a,b){var c="";b!==s?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function d(b){if(b._.overrides)return b._.overrides;var c=b._.overrides={},d=b._.definition.overrides;
if(d){a.isArray(d)||(d=[d]);for(var e=0;e<d.length;e++){var f=d[e],g,h,i;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():b.element,h=f.attributes,i=f.styles);f=c[g]||(c[g]={});if(h){g=f.attributes=f.attributes||[];for(var j in h)g.push([j.toLowerCase(),h[j]])}if(i){var f=f.styles=f.styles||[],l;for(l in i)f.push([l.toLowerCase(),i[l]])}}}return c}function b(b,e){var f=b._.definition,g=d(b),h=a.merge(f.attributes,(g[e.nodeName()]||g["*"]||{}).attributes),f=a.merge(f.styles,
(g[e.nodeName()]||g["*"]||{}).styles),g=a.isEmptyObject(h)&&a.isEmptyObject(f),i;for(i in h)("class"==i||b._.definition.fullMatch)&&e.attr(i)!=u(i,h[i])||(g=g||!!e.hasAttr(i),e.removeAttr(i));for(var j in f)b._.definition.fullMatch&&e.style(j)!=u(j,f[j],l)||(g=g||!!e.style(j),e.style(j,""));c(e)}function u(a,b,c){var d=new G("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function e(a,c){for(var e=d(a),f=c.all(a.element),g=f.length;0<=--g;)b(a,new G(f[g]));for(var i in e)if(i!=a.element){f=
c.all(i);for(g=f.length-1;0<=g;g--){var j=new G(f[g]);h(j,e[i])}}}function h(a,b){var d,e=b&&b.attributes;if(e)for(d=0;d<e.length;d++){var f=e[d][0],g;if(g=a.attr(f)){var h=e[d][1];(h===A||h.test&&h.test(g)||"string"==typeof h&&g==h)&&a[0].removeAttribute(f)}}if(e=b&&b.styles)for(d=0;d<e.length;d++)if(f=e[d][0],h=a.css(f)){var i=e[d][1];(i===A||i.test&&i.test(g)||"string"==typeof i&&h==i)&&a.css(f,"")}c(a)}function c(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);
b&&(b.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(c))}}var l=!0,s=!1,A=null,C=a.all,z=a.DOM,E={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},r=k.RANGE,D=k.Selection,x=k.POSITION,O=k.Range,G=a.Node,I=a.UA,N=k.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=k.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;k.STYLE=
E;o.prototype={constructor:o,apply:function(a){g.call(this,a,s)},remove:function(a){g.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==E.STYLE_INLINE?n:this.type==E.STYLE_BLOCK?j:A).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==E.STYLE_INLINE?y:A).call(this,a)},checkElementRemovable:function(a,b){if(!a)return s;var c=this._.definition,e;if(a.nodeName()==this.element){if(!b&&!a._4e_hasAttributes())return l;var f=c._AC;if(f)c=f;else{var f=
{},g=0,h=c.attributes;if(h)for(var j in h)g++,f[j]=h[j];if(h=o.getStyleText(c))f.style||g++,f.style=h;f._length=g;c=c._AC=f}if(c._length){for(var k in c)if("_length"!=k){g=a.attr(k)||"";if("style"==k)a:{f=c[k];g=i(g,s);"string"==typeof f&&(f=v(f));"string"==typeof g&&(g=v(g));h=void 0;for(h in f)if(!(h in g&&(g[h]==f[h]||"inherit"==f[h]||"inherit"==g[h]))){f=s;break a}f=l}else f=c[k]==g;if(f){if(!b)return l}else if(b)return s}if(b)return l}else return l}k=d(this);if(k=k[a.nodeName()]||k["*"]){if(!(c=
k.attributes)&&!(e=k.styles))return l;if(c)for(f=0;f<c.length;f++)if(k=c[f][0],k=a.attr(k))if(g=c[f][1],g===A||"string"==typeof g&&k==g||g.test&&g.test(k))return l;if(e)for(f=0;f<e.length;f++)if(k=a.css(e[f][0]))if(c=e[f][1],c===A||"string"==typeof c&&k==c||c.test&&c.test(k))return l}return s},checkActive:function(a){switch(this.type){case E.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,l);case E.STYLE_OBJECT:case E.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=
b[c],!(this.type==E.STYLE_INLINE&&(z.equals(d,a.block)||z.equals(d,a.blockLimit))))if((this.type!=E.STYLE_OBJECT||d.nodeName()in P)&&this.checkElementRemovable(d,l))return l}return s}};o.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(Q,";"));for(var e in b){var f=b[e],g=(e+":"+f).replace(Q,";");"inherit"==f?d+=g:c+=g}c.length&&(c=i(c));return a._ST=c+d};return k.Style=o},{requires:["./base","./range","./selection",
"./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(a){var k=a.Node,t=a.DOM,p=a.UA,o={debugUrl:function(g){var f=a.Config;f.debug||(g=g.replace(/\.(js|css)/i,"-min.$1"));-1==g.indexOf("?t")&&(g=-1!=g.indexOf("?")?g+"&":g+"?",g+="t="+encodeURIComponent(f.tag));return f.base+"editor/"+g},lazyRun:function(a,f,j){var k=a[f],m=a[j];a[f]=function(){k.apply(this,arguments);a[f]=a[j];return m.apply(this,arguments)}},getXY:function(a,f){var j=a.left,k=a.top,m=f.get("window")[0],j=j-t.scrollLeft(m),k=k-t.scrollTop(m),m=
f.get("iframe").offset(),j=j+m.left,k=k+m.top;return{left:j,top:k}},tryThese:function(a){for(var f,j=0,k=arguments.length;j<k;j++){var m=arguments[j];try{f=m();break}catch(o){}}return f},arrayCompare:function(a,f){if(!a&&!f)return!0;if(!a||!f||a.length!=f.length)return!1;for(var j=0;j<a.length;j++)if(a[j]!==f[j])return!1;return!0},clearAllMarkers:function(a){for(var f in a)a[f]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,
"")},isNumber:function(g){return/^\d+(.\d+)?$/.test(a.trim(g))},verifyInputs:function(g){for(var f=0;f<g.length;f++){var j=new k(g[f]),q=a.trim(o.valInput(j)),m=j.attr("data-verify"),j=j.attr("data-warning");if(m&&!RegExp(m).test(q))return alert(j),!1}return!0},sourceDisable:function(a,f){a.on("sourceMode",f.disable,f);a.on("wysiwygMode",f.enable,f)},resetInput:function(a){var f=a.attr("placeholder");f&&p.ie?(a.addClass("ks-editor-input-tip"),a.val(f)):p.ie||a.val("")},valInput:function(a,f){if(void 0===
f)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(f)},placeholder:function(g,f){g.attr("placeholder",f);p.ie&&(g.on("blur",function(){a.trim(g.val())||(g.addClass("ks-editor-input-tip"),g.val(f))}),g.on("focus",function(){g.removeClass("ks-editor-input-tip");a.trim(g.val())==f&&g.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(g){var g=a.clone(g),
f;for(f in g){var j=g[f];a.isFunction(j)&&(g[f]=j())}return g},map:function(a,f){for(var j=0;j<a.length;j++)a[j]=f(a[j]);return a},ieEngine:document.documentMode||p.ie,preventFocus:function(a){p.ie?a.unselectable(void 0):a.attr("onmousedown","return false;")},injectDom:function(g){a.mix(t,g);for(var f in g)(function(f){k.prototype[f]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=g[f].apply(null,o))&&(o.nodeType||a.isWindow(o))?new k(o):a.isArray(o)&&(o.__IS_NODELIST||o[0]&&
o[0].nodeType)?new k(o):o}})(f)},addRes:function(){var g=this.__res=this.__res||[];g.push.apply(g,a.makeArray(arguments))},destroyRes:function(){for(var g=this.__res||[],f=0;f<g.length;f++){var j=g[f];a.isFunction(j)?j():j.destroy?j.destroy():j.remove&&j.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,g){return g.toUpperCase()})+"Value"}};return a.Editor.Utils=o},{requires:["./base"]});
KISSY.add("editor/core/walker",function(a,k){function t(a,d){if(this._.end)return j;var e,h=this.range,c,i=this.guard,k=this.type,o=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,h.trim(),h.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var p=h.endContainer[0],q=p.childNodes[h.endOffset];this._.guardLTR=function(a,b){return b&&(p==a||"body"==m.nodeName(a))?!1:a!=q}}if(a&&!this._.guardRTL){var t=h.startContainer[0],r=0<h.startOffset&&t.childNodes[h.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(t==a||"body"==m.nodeName(a))?!1:a!=r}}var v=a?this._.guardRTL:this._.guardLTR;c=i?function(a,b){return v(a,b)===f?f:i(a,b)}:v;this.current?e=this.current[o](f,k,c):a?(e=h.endContainer,0<h.endOffset?(e=new n(e[0].childNodes[h.endOffset-1]),c(e[0])===f&&(e=j)):e=c(e,g)===f?j:e._4e_previousSourceNode(g,k,c,void 0)):(e=h.startContainer,e=new n(e[0].childNodes[h.startOffset]),e.length?c(e[0])===f&&(e=j):e=c(h.startContainer,g)===f?j:h.startContainer._4e_nextSourceNode(g,
k,c,void 0));for(;e&&!this._.end;){this.current=e;if(!this.evaluator||this.evaluator(e[0])!==f){if(!d)return e}else if(d&&this.evaluator)return f;e=e[o](f,k,c)}this.end();return this.current=j}function p(a){for(var d,e=j;d=t.call(this,a);)e=d;return e}function o(a){this.range=a;this.guard=this.evaluator=j;this._={}}var g=!0,f=!1,j=null,q=a.UA,m=a.DOM,w=k.XHTML_DTD,n=a.Node;a.augment(o,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,g)},checkForward:function(){return t.call(this,
f,g)!==f},checkBackward:function(){return t.call(this,g,g)!==f},lastForward:function(){return p.call(this)},lastBackward:function(){return p.call(this,g)},reset:function(){delete this.current;this._={}},_iterator:t});a.mix(o,{blockBoundary:function(a){return function(d){return!(d.nodeType==m.NodeType.ELEMENT_NODE&&m._4e_isBlockBoundary(d,a))}},bookmark:function(a,d){function e(a){return"span"==m.nodeName(a)&&m.attr(a,"_ke_bookmark")}return function(f){var c,g;c=f.nodeType==m.NodeType.TEXT_NODE&&(g=
f.parentNode)&&e(g);c=a?c:c||e(f);return!!(d^c)}},whitespaces:function(b){return function(d){d=d.nodeType==m.NodeType.TEXT_NODE&&!a.trim(d.nodeValue);return!!(b^d)}},invisible:function(a){var d=o.whitespaces();return function(e){e=d(e)||e.nodeType==m.NodeType.ELEMENT_NODE&&!e.offsetHeight;return!!(a^e)}}});var y=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,v=o.whitespaces(),i=o.bookmark(),d=function(a){var d=m.nodeName(a);return i(a)||v(a)||1==a.nodeType&&d in w.$inline&&!(d in w.$empty)};k.Utils.injectDom({_4e_getBogus:function(a){a=
new n(a);do a=a._4e_previousSourceNode();while(a&&d(a[0]));return a&&(!q.ie?"br"==a.nodeName():3==a[0].nodeType&&y.test(a.text()))?a[0]:!1}});return k.Walker=o},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(a){var k=a.Editor,a=k.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};k.baseZIndex=function(a){return(k.Config.baseZIndex||1E4)+a};return a},{requires:["./base"]});
