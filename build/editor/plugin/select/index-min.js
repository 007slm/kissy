/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 30 20:27
*/
KISSY.add("editor/plugin/select/index",function(j,i,s,d){function h(a){h.superclass.constructor.call(this,a);this._init()}function m(a){return a&&-1==a.indexOf("<")?a:0}var q=j.Node,g=q.all,k=j.Event,n=j.DOM,r=i.XHTML_DTD;h.DISABLED=0;h.ENABLED=1;h.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},popUpWidth:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var a=this.el.parent();a;){var b=a.nodeName();if(r[b]&&r[b].div)return a;a=
a.parent()}return g(document.body)}},state:{value:1}};h.decorate=function(a){var b=a.width(),e=[];a.all("option").each(function(a){e.push({name:a.html(),value:a.val()})});return new h({width:b+"px",title:a.attr("title"),el:a,items:e,cls:"ke-combox",value:a.val()})};var o=i.Utils.addRes,t=i.Utils.destroyRes;j.extend(h,j.Base,{_init:function(){var a=this,b=a.get("container"),e=a.get("el"),c=g("<span class='ke-select-wrap'><a class='ke-select'  hidefocus='hidefocus' tabindex='0'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
f=c.one("a"),p=a.get("title")||"",j=a.get("cls"),h=c.one(".ke-select-text"),l=c.one(".ke-select-text-inner");c.one(".ke-select-drop");a.get("value")!==d?l.html(a._findNameByV(a.get("value"))):l.html(p);c.unselectable(d);h.css("width",a.get("width"));p&&c.attr("title",p);f.attr("href","javascript:void('"+m(p)+"')");j&&c.addClass(j,d);e?e[0].parentNode.replaceChild(c[0],e[0]):b&&c.appendTo(b,d);c.on("click",a._click,a);c.on("keydown",a._keydown,a);a.el=c;a.title=l;a._focusA=c.one("a.ke-select");a._focusA.on("blur",
function(){a.menu&&a.menu.hide()});i.Utils.lazyRun(this,"_prepare","_real");a.on("afterValueChange",a._valueChange,a);a.on("afterStateChange",a._stateChange,a)},_keydown:function(a){var b;switch(a.keyCode){case k.KeyCodes.DOWN:a.halt();if(!this._isShown()){this._click();this._findCurrent()||g(this.as[0]).addClass("ke-menu-selected",d);break}a=g(this._findCurrent());a.removeClass("ke-menu-selected",d);(b=a.next())?b.addClass("ke-menu-selected",d):g(this.as[0]).addClass("ke-menu-selected",d);break;
case k.KeyCodes.UP:a.halt();if(!this._isShown())break;a=g(this._findCurrent());a.removeClass("ke-menu-selected",d);(b=a.prev(d,d))?b.addClass("ke-menu-selected",d):g(this.as[this.as.length-1]).addClass("ke-menu-selected",d);break;case k.KeyCodes.ENTER:a.halt();if(!this._isShown()){this._click();this._findCurrent()||g(this.as[0]).addClass("ke-menu-selected",d);break}a=g(this._findCurrent());if(!a)break;this._select({target:a});break;case k.KeyCodes.ESC:a.halt();if(!this._isShown())break;this.menu.hide()}},
_findCurrent:function(){var a=d;this.as.each(function(b){if(b.hasClass("ke-menu-selected",d))return a=b,!1});return a},_isShown:function(){return this.menu&&this.menu.get("visible")},_findNameByV:function(a){var b=this.get("title")||"",e=this.get("items");if(this.get("showValue"))return a||b;j.each(e,function(c){if(c.value==a)return b=c.name,!1});return b},_valueChange:function(a){this.title.html(this._findNameByV(a.newVal))},_itemsChange:function(a){var b,a=a.newVal,e=this._selectList;e.html("");
if(a&&a.length)for(b=0;b<a.length;b++){var c=a[b];(new q(j.substitute("<a class='ke-select-menu-item' tabindex='-1' href='javascript:void(\"{tip}\")' data-value='{value}'>{name}</a>",{tip:m(c.name),value:c.value,name:c.name}),c.attrs)).unselectable(d).appendTo(e,d)}else(b=this.get("emptyText"))&&g(j.substitute("<a class='ke-select-menu-item' tabindex='-1' href='javascript:void(\"{tip}\")' data-value='{value}'>{name}</a>",{tip:m(b),value:"",name:b})).appendTo(e,d);this.as=e.all("a")},val:function(a){return a!==
d?(this.set("value",a),this):this.get("value")},_resize:function(){this.menu.get("visible")&&this._real()},_prepare:function(){var a=this,b=a.el,e=a._focusA,c=a.get("popUpWidth"),c=new s({autoRender:!0,render:a.get("menuContainer"),content:"<div>",elCls:"ke-menu",width:c?c:b.width(),zIndex:i.baseZIndex(i.zIndexManager.SELECT)}),f=a.get("items");c.on("hide",function(){e.removeClass("ke-select-active",d)});c.on("show",function(){e.addClass("ke-select-active",d)});o.call(a,c);b=c.get("contentEl").one("div");
a.menu=c;c.get("el").on("mousedown",function(a){a.halt()});k.on(window,"resize",a._resize,a);o.call(a,function(){k.remove(window,"resize",a._resize,a)});a.get("title")&&g("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+a.get("title")+"</div>").appendTo(b,d);a._selectList=g("<div>").appendTo(b,d);a._itemsChange({newVal:f});b.on("click",a._select,a);a.as=a._selectList.all("a");b.on("mouseenter",function(){a.as.removeClass("ke-menu-selected",d)});o.call(a,b);a.on("afterItemsChange",
a._itemsChange,a);a.menuNode=b},_stateChange:function(a){var b=this.el;1==a.newVal?b.removeClass("ke-select-disabled",d):b.addClass("ke-select-disabled",d)},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(a){a&&a.halt&&a.halt();var b=this.menu,e=this.menuNode;if((a=g(a.target).closest(function(a){return n.contains(e,a)&&"a"==n.nodeName(a)},d))&&a.attr("data-value")){var c=this.get("value"),f=a.attr("data-value");this.set("value",f);this.fire("click",
{newVal:f,prevVal:c,name:a.html()});b.hide()}},_real:function(){var a=this.el,b=a.offset(),e=j.clone(b),c=this.menu.get("el").height(),d=this.menu.get("el").width(),g=n.scrollTop(),h=n.scrollLeft(),i=n.viewportHeight(),l=n.viewportWidth(),l=h+l-60,i=g+i,k=b.top+(a.height()-2),a=b.left+a.width()-2,m=this.get("align"),o=m[0];"b"==m[1]?(b.top=k,b.top+c>i&&e.top-g>i-k&&(b.top=e.top-c)):(b.top=e.top-c,b.top<g&&e.top-g<i-k&&(b.top=k));"l"==o?b.left+d>l&&a-h>l-e.left&&(b.left=a-d):(b.left=a-d,b.left<h&&
a-h<l-e.left&&(b.left=e.left));this.menu.set("xy",[b.left,b.top]);this.menu.show()},_click:function(a){a&&a.halt();var a=this.el,b=this.menu,e=this.get("value");if(b&&b.get("visible"))b.hide();else{this._focusA[0].focus();if(a.hasClass("ke-select-disabled",d))return!1;this.fire("select");this._prepare();e&&b&&this.as.each(function(a){a.attr("data-value")==e?a.addClass("ke-menu-selected",d):a.removeClass("ke-menu-selected",d)})}},destroy:function(){t.call(this);this.el.remove()}});i.prototype.addSelect=
function(a,b,d){var d=d||h,c=this;a.editor=c;var f=new d(j.mix({container:c.get("toolBarEl"),doc:c.get("document")[0]},a));j.mix(f,b);c.on("selectionChange",function(){c.get("mode")!=i.SOURCE_MODE&&f.selectionChange&&f.selectionChange.apply(f,arguments)});c.on("destroy",function(){f.destroy()});f.on("click",function(a){var b=a.type;f[b]&&f[b].apply(f,arguments);a.halt()});a.mode==i.WYSIWYG_MODE&&(c.on("wysiwygMode",f.enable,f),c.on("sourceMode",f.disable,f));f.init&&f.init();return f};return h},{requires:["editor",
"overlay"]});
