/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 11 20:22
*/
KISSY.add("editor/plugin/table/index",function(j,l,s){function t(a){function d(a){!(0<f.length)&&a[0].nodeType==m.ELEMENT_NODE&&u.test(a.nodeName())&&!a.data("selected_cell")&&(a._4e_setMarker(b,"selected_cell",!0,void 0),f.push(a))}for(var c=a.createBookmarks(),e=a.getRanges(),f=[],b={},g=0;g<e.length;g++){var h=e[g];if(h.collapsed)h=h.getCommonAncestor(),(h=h.closest("td",void 0)||h.closest("th",void 0))&&f.push(h);else{var h=new Walker(h),k;for(h.guard=d;k=h.next();)if((k=k.parent())&&u.test(k.nodeName())&&
!k.data("selected_cell"))k._4e_setMarker(b,"selected_cell",!0,void 0),f.push(k)}}l.Utils.clearAllMarkers(b);a.selectBookmarks(c);return f}function v(a,d){var c=a.getStartElement().parent("tr");if(c){var e=c.clone(!0);e.insertBefore(c);c=(d?e[0]:c[0]).cells;for(e=0;e<c.length;e++)c[e].innerHTML="",p.ie||(new i(c[e]))._4e_appendBogus(void 0)}}function q(a){if(a instanceof l.Selection){for(var d=t(a),c=d.length,a=[],e,f,b=0;b<c;b++){var g=d[b].parent(),h=g[0].rowIndex;!b&&(e=h-1);a[h]=g;b==c-1&&(f=h+
1)}b=g.parent("table");e=new i(f<b[0].rows.length&&b[0].rows[f]||0<e&&b[0].rows[e]||b[0].parentNode);for(b=a.length;0<=b;b--)a[b]&&q(a[b]);return e}a instanceof i&&(b=a.parent("table"),1==b[0].rows.length?b.remove():a.remove());return 0}function w(a,d){var c=a.getStartElement();if(c=c.closest("td",void 0)||c.closest("th",void 0))for(var e=c.parent("table"),f=c[0].cellIndex,b=0;b<e[0].rows.length;b++){var g=e[0].rows[b];g.cells.length<f+1||(c=new i(g.cells[f].cloneNode(void 0)),p.ie||c._4e_appendBogus(void 0),
g=new i(g.cells[f]),d?c.insertBefore(g):c.insertAfter(g))}}function x(a){if(a instanceof l.Selection){var d=t(a),c,e=[],a=d[0]&&d[0].parent("table"),f,b,g;f=0;for(b=d.length;f<b;f++)e.push(d[f][0].cellIndex);e.sort();f=1;for(b=e.length;f<b;f++)if(1<e[f]-e[f-1]){g=e[f-1]+1;break}g||(g=0<e[0]?e[0]-1:e[e.length-1]+1);e=a[0].rows;f=0;for(b=e.length;f<b&&!(c=e[f].cells[g]);f++);c=c?new i(c):a.prev();for(g=d.length-1;0<=g;g--)d[g]&&x(d[g]);return c}if(a instanceof i){d=a.parent("table");if(!d)return null;
c=a[0].cellIndex;for(g=d[0].rows.length-1;0<=g;g--)a=new i(d[0].rows[g]),!c&&1==a[0].cells.length?q(a):a[0].cells[c]&&a[0].removeChild(a[0].cells[c])}return null}function y(a,d){var c=new l.Range(a[0].ownerDocument);if(!c.moveToElementEditablePosition(a,d?!0:void 0))c.selectNodeContents(a),c.collapse(d?!1:!0);c.select(!0)}function n(a){var d=(a=a.getSelection())&&a.getStartElement(),c=d&&d.closest("table",void 0);if(c)return a=d.closest(function(a){var d=m.nodeName(a);return c.contains(a)&&("td"==
d||"th"==d)},void 0),d=d.closest(function(a){var d=m.nodeName(a);return c.contains(a)&&"tr"==d},void 0),{table:c,td:a,tr:d}}function o(a){return(a=n(a))&&a.td}function r(a){return(a=n(a))&&a.tr}var p=j.UA,m=j.DOM,i=j.Node,A=["tr","th","td","tbody","table"],u=/^(?:td|th)$/,z={"表格属性":n,"删除表格":o,"删除列":o,"删除行":r,"在上方插入行":r,"在下方插入行":r,"在左侧插入列":o,"在右侧插入列":o},B=(6===p.ie?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:" table.%2,; table.%2 > tr > td,  table.%2 > tr > th,; table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,; table.%2 > thead > tr > td,  table.%2 > thead > tr > th,; table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th;{;border : #d3d3d3 1px dotted;}".split(";")).join("").replace(/%2/g,
"ke_show_border"),C={elements:{table:function(a){var a=a.attributes,d=a["class"],c=parseInt(a.border,10);if(!c||0>=c)a["class"]=(d||"")+" ke_show_border"}}},D={elements:{table:function(a){var a=a.attributes,d=a["class"];d&&(a["class"]=j.trim(d.replace("ke_show_border","")))}}};return{init:function(a){a.addCustomStyle(B);var d=a.htmlDataProcessor,c=d&&d.htmlFilter;(d&&d.dataFilter).addRules(C);c.addRules(D);var e={"表格属性":function(){this.hide();var b=n(a);b&&s.useDialog(a,"table",{selectedTable:b.table,
selectedTd:b.td})},"删除表格":function(){this.hide();var b=a.getSelection(),c=b&&b.getStartElement();if(c=c&&c.closest("table",void 0)){b.selectElement(c);var d=b.getRanges()[0];d.collapse();b.selectRanges([d]);b=c.parent();1==b[0].childNodes.length&&"body"!=b.nodeName()&&"td"!=b.nodeName()?b.remove():c.remove()}},"删除行 ":function(){this.hide();var b=a.getSelection();y(q(b),void 0)},"删除列 ":function(){this.hide();var b=a.getSelection();(b=x(b))&&y(b,!0)},"在上方插入行":function(){this.hide();var b=a.getSelection();
v(b,!0)},"在下方插入行":function(){this.hide();var b=a.getSelection();v(b,void 0)},"在左侧插入列":function(){this.hide();var b=a.getSelection();w(b,!0)},"在右侧插入列":function(){this.hide();var b=a.getSelection();w(b,void 0)}},f=[];j.each(e,function(a,c){f.push({content:c})});a.addContextMenu("table",function(a){if(j.inArray(m.nodeName(a),A))return!0},{width:"120px",children:f,listeners:{click:function(a){a=a.target.get("content");e[a]&&e[a].apply(this)},beforeVisibleChange:function(a){if(a.newVal){var c=this,a=c.get("children"),
d=c.get("editor");j.each(a,function(a){var b=a.get("content");!z[b]||z[b].call(c,d)?a.set("disabled",!1):a.set("disabled",!0)})}}}});a.addButton("table",{mode:l.WYSIWYG_MODE,listeners:{click:function(){s.useDialog(a,"table",{selectedTable:0,selectedTd:0})}},tooltip:"插入表格"})}}},{requires:["editor","../dialogLoader/","../contextmenu/"]});
