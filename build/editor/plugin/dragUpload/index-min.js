/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 11 20:22
*/
KISSY.add("editor/plugin/dragUpload/index",function(h,p){var s=h.Node,m=h.Event,t=p.Utils,k=h.DOM;return h.UA.ie?void 0:{init:function(q){function r(a){a=a.originalEvent.target;"img"==k.nodeName(a)&&a.src.match(/^file:\/\//)&&(n[a.src]=a)}function u(a,i){var d=new window.FileReader;d.onload=function(e){var b=a.name,e=e.target.result,c=new XMLHttpRequest;c.open("POST",v,!0);c.onreadystatechange=function(){if(4==c.readyState){if(200==c.status||304==c.status){if(""!=c.responseText){var a=window.JSON.parse(c.responseText);
i[0].src=a.imgUrl}}else alert("服务器端出错！"),i.remove();c.onreadystatechange=null}};b="\r\n------kissy-editor-yiminghe\r\n"+('Content-Disposition: form-data; name="'+w+'"; filename="'+encodeURIComponent(b)+'"\r\n');b+="Content-Type: "+(a.type||"application/octet-stream")+"\r\n\r\n";b+=e+"\r\n";f=p.Utils.normParams(f);for(var g in f)f.hasOwnProperty(g)&&(b+="------kissy-editor-yiminghe\r\n",b+='Content-Disposition: form-data; name="'+g+'"\r\n\r\n',b+=f[g]+"\r\n");b+="------kissy-editor-yiminghe--";c.setRequestHeader("Content-Type",
"multipart/form-data, boundary=----kissy-editor-yiminghe");c.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-yiminghe\r\nContent-Length: "+b.length+"\r\n"+b+"\r\n");d.onload=null};d.readAsBinaryString(a)}var l=q.get("pluginConfig").dragUpload||{},w=l.fileInput||"Filedata",x=l.sizeLimit||Number.MAX_VALUE,f=l.serverParams||{},v=l.serverUrl||"",y=RegExp((l.suffix||"png,jpg,jpeg,gif").split(/,/).join("|")+"$","i"),j=q.get("document")[0],n={},o=!1;m.on(j,"dragenter",function(){o||
(m.on(j,"DOMNodeInserted",r),o=!0)});m.on(j,"drop",function(a){m.remove(j,"DOMNodeInserted",r);o=!1;a.halt();var a=a.originalEvent,i,d;h.isEmptyObject(n)?(d=j.elementFromPoint(a.clientX,a.clientY),i=d.lastChild):(h.each(n,function(a){"img"==k.nodeName(a)&&(i=a.nextSibling,d=a.parentNode,k.remove(a))}),n={});a=a.dataTransfer;a.dropEffect="copy";if(a=a.files)for(var e=0;e<a.length;e++){var b=a[e],c=b.size;if(b.name.match(y)&&!(c/1E3>x)){var c=new s("<img src='"+t.debugUrl("theme/tao-loading.gif")+"'/>"),
g=c[0];d.insertBefore(g,i);var f=k.nodeName(g.parentNode);("head"==f||"html"==f)&&k.insertBefore(g,j.body.firstChild);u(b,c)}}});window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary&&(XMLHttpRequest.prototype.sendAsBinary=function(a,f){for(var d=new (window.BlobBuilder||window.WebKitBlobBuilder),e=a.length,b=new window.Uint8Array(e),c=0;c<e;c++)b[c]=a.charCodeAt(c);d.append(b.buffer);this.send(d.getBlob(f))})}}},{requires:["editor"]});
