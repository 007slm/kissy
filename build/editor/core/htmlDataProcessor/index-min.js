/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Jul 4 20:40
*/
KISSY.add("editor/plugin/htmlDataProcessor/index",function(f){return{init:function(t){function u(b){return b.replace(v,function(b,e,a){return"<"+e+a.replace(w,function(b,c){return-1==a.indexOf("_ke_saved_"+c)?" _ke_saved_"+b+" "+b:b})+">"})}function x(b){return b.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(b){return"<\!--"+j+"{C}"+encodeURIComponent(b).replace(/--/g,"%2D%2D")+"--\>"})}function y(b){return b.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(b,e){return decodeURIComponent(e)})}
var n=n,z=f.Editor,A=f.Node,o=f.UA,e=f.require("htmlparser"),l=new e.Filter,p=new e.Filter,q=new e.Filter;(function(){var b=function(a,b){return function(c,e){var g=[];(""+c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,h,m){h=h.toLowerCase();"font-family"==h&&(m=m.replace(/["']/g,""));for(var r,d,i,f=0;f<a.length;f++)if(a[f]&&(c=a[f][0],r=a[f][1],d=a[f][2],i=a[f][3],h.match(c)&&(!r||m.match(r)))){h=i||h;b&&(d=d||m);"function"==typeof d&&(d=d(m,e,h));d&&d.push&&
(h=d[0],d=d[1]);"string"==typeof d&&g.push([h,d]);return}!b&&g.push([h,m])});for(var d=0;d<g.length;d++)g[d]=g[d].join(":");return g.length?g.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],n),c={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var b=a.nodeName||"";if(-1!=b.indexOf(":")&&
!/^ke/.test(b))if("v:imagedata"==b){if(b=a.getAttribute("o:href"))a.setAttribute("src",b),a.removeAttribute("o:href");if(b=a.getAttribute("o:title"))a.setAttribute("title",b),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=b(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},i={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,e=0;e<b.length;e++)c="_ke_saved_"+b[e],a.getAttribute(c)&&a.removeAttribute(b[e]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!f.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,j.length)==j?(a="{C}"==a.substr(j.length,3)?a.substr(j.length+3):a.substr(j.length),new e.CData(decodeURIComponent(a))):a}};o.ie&&(i.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});l.addRules(i);p.addRules(c);q.addRules(c)})();(function(){function b(a){for(var a=a.childNodes,b=a.length,c=a[b-1];c&&3==c.nodeType&&!f.trim(c.nodeValue);)c=a[--b];return c}
function c(a,c){var d=b(a);d&&((c||!o.ie)&&1==d.nodeType&&"br"==d.nodeName?a.removeChild(d):3==d.nodeType&&n.test(d.nodeValue)&&a.removeChild(d))}function i(a){var c=b(a);return!c||1==c.nodeType&&"br"==c.nodeName||"form"==a.nodeName&&"input"==c.nodeName}function a(a){c(a,!0);i(a)&&(o.ie?a.appendChild(new e.Text(" ")):(a.appendChild(new e.Text("&nbsp;")),a.appendChild(new e.Tag("br"))))}function j(a){c(a,!1);i(a)&&a.appendChild(new e.Text(" "))}var n=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,k=z.XHTML_DTD,g=f.merge(k.$block,
k.$listItem,k.$tableContent),d;for(d in g)g.hasOwnProperty(d)&&("br"in k[d]||delete g[d]);delete g.td;delete g.pre;var k={tags:{}},s={tags:{}};for(d in g)g.hasOwnProperty(d)&&(k.tags[d]=a,s.tags[d]=j);p.addRules(k);l.addRules(s);q.addRules(k)})();(function(){l.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}})})();var v=/<(a|area|img|input)\b([^>]*)>/gi,w=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}";t.htmlDataProcessor={wordFilter:q,dataFilter:p,
htmlFilter:l,toHtml:function(b){var c=new e.BeautifyWriter;(new e.Parser(b)).parse().writeHtml(c,l);return c.getHtml()},toDataFormat:function(b,c,f){f=f||p;o.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=u(b);c=new A("<div>");c.html("a"+b);b=c.html().substr(1);b=y(b);c=new e.BeautifyWriter;(new e.Parser(b)).parse().writeHtml(c,f);b=c.getHtml();return b=x(b)},toServer:function(b){var c=new e.MinifyWriter;(new e.Parser(b)).parse().writeHtml(c,l);return c.getHtml()}}}}},
{requires:["editor"]});
