/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Oct 10 13:59
*/
KISSY.add("editor/core/styles",function(p,v){function S(a){return!r.attr(a,"_ke_bookmark")}function J(a,e){for(var b in a)p.isString(a[b])?a[b]=a[b].replace(T,function(b,a){return e[a]}):J(a[b],e)}function A(a,e){e&&(a=p.clone(a),J(a,e));var b=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==b||U[b]?n.STYLE_BLOCK:K[b]?n.STYLE_OBJECT:n.STYLE_INLINE;this._={definition:a}}function L(a,e){var b=e?this.removeFromRange:this.applyToRange;a.body.focus();for(var c=new V(a),
d=c.getRanges(),f=0;f<d.length;f++)b.call(this,d[f]);c.selectRanges(d)}function E(a,e,b){var c=a.element;"*"==c&&(c="span");e=new w(e.createElement(c));b&&b._4e_copyAttributes(e);b=a._.definition;a=b.attributes;b=A.getStyleText(b);if(a)for(var d in a)e.attr(d,a[d]);b&&(e[0].style.cssText=b);return e}function W(a){var e=a.createBookmark(j),b=a.createIterator();b.enforceRealBlocks=j;b.enlargeBr=j;for(var c,d=a.document;c=b.getNextParagraph();){var f=E(this,d,c),g=f,f="pre"==g.nodeName,h="pre"==c.nodeName,
i=!f&&h;f&&!h?(h=c,i=h.html(),i=x(i,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),i=i.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),i=i.replace(/([ \t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),F.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(g[0]),g[0].outerHTML="<pre>"+i+"</pre>",g=new w(h.firstChild),g._4e_remove()):g.html(i)):i?g=X(Y(c),g):c._4e_moveChildren(g);c[0].parentNode.replaceChild(g[0],c[0]);if(f&&(c=g,f=void 0,(f=c._4e_previousSourceNode(j,r.NodeType.ELEMENT_NODE))&&
"pre"==f.nodeName()))g=x(f.html(),/\n$/,"")+"\n\n"+x(c.html(),/^\n/,""),F.ie?c[0].outerHTML="<pre>"+g+"</pre>":c.html(g),f._4e_remove()}a.moveToBookmark(e)}function x(a,e,b){var c="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(b,a,e){a&&(c=a);e&&(d=e);return""});return c+a.replace(e,b)+d}function Y(a){var e=[];x(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,a,d){return a+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,c){e.push(c)});return e}function X(a,e){for(var b=e[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var d=a[c],d=d.replace(/(\r\n|\r)/g,"\n"),d=x(d,/^[ \t]*\n/,""),d=x(d,/\n$/,""),d=x(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),f=e.clone();f.html(d);b.appendChild(f[0])}return b}
function Z(a){var e=a.document;if(a.collapsed)e=E(this,e,void 0),a.insertNode(e),a.moveToPosition(e,z.POSITION_BEFORE_END);else{var b=this.element,c=this._.definition,d,f=B[b];f||(d=j,f=B.span);var g=a.createBookmark();a.enlarge(z.ENLARGE_ELEMENT);a.trim();for(var h=a.createBookmark(),i=h.startNode,h=h.endNode,l=i,s;l&&l[0];){var k=u;if(r.equals(l,h))l=t,k=j;else{var q=l[0].nodeType,n=q==r.NodeType.ELEMENT_NODE?l.nodeName():t;if(n&&l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(j);continue}if(!n||
f[n]&&(l._4e_position(h)|o.POSITION_PRECEDING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_PRECEDING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(l))){var m=l.parent();if(m&&"a"==b&&m.nodeName()==b)q=E(this,e,void 0),m._4e_moveChildren(q),m[0].parentNode.replaceChild(q[0],m[0]),q._4e_mergeSiblings();else if(m&&m[0]&&((B[m.nodeName()]||B.span)[b]||d)&&(!c.parentRule||c.parentRule(m))){if(!s&&(!n||!B.$removeEmpty[n]||(l._4e_position(h)|o.POSITION_PRECEDING|o.POSITION_IDENTICAL|
o.POSITION_IS_CONTAINED)==o.POSITION_PRECEDING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED))s=new $(e),s.setStartBefore(l);if(q==r.NodeType.TEXT_NODE||q==r.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){m=l;for(q=null;(k=!m.next(S,1))&&(q=m.parent())&&f[q.nodeName()]&&(q._4e_position(i)|o.POSITION_FOLLOWING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_FOLLOWING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(q));)m=q;s.setEndAfter(m)}}else k=j}else k=j;l=l._4e_nextSourceNode()}if(k&&
s&&!s.collapsed){for(var k=E(this,e,void 0),m=s.getCommonAncestor(),q={},n={},C,y=null,p;k&&m&&k[0]&&m[0];){if(m.nodeName()==b){for(C in c.attributes)if(!n[C]&&(p=m.attr(y)))k.attr(C)==p?k.removeAttr(C):n[C]=1;for(y in c.styles)if(!q[y]&&(p=m.style(y)))k.style(y)==p?k.style(y,""):q[y]=1;if(!k._4e_hasAttributes()){k=t;break}}m=m.parent()}k?(k[0].appendChild(s.extractContents()),M(this,k),s.insertNode(k),k._4e_mergeSiblings(),F.ie||k[0].normalize()):(k=new w(e.createElement("span")),k[0].appendChild(s.extractContents()),
s.insertNode(k),M(this,k),k._4e_remove(!0));s=t}}i._4e_remove();h._4e_remove();a.moveToBookmark(g);a.shrink(z.SHRINK_TEXT)}}function aa(a){a.enlarge(z.ENLARGE_ELEMENT);var e=a.createBookmark(),b=e.startNode;if(a.collapsed){for(var c=new G(b.parent()),d,f=0,g;f<c.elements.length&&(g=c.elements[f])&&!(g==c.block||g==c.blockLimit);f++)if(this.checkElementRemovable(g)){var h=a.checkBoundaryOfElement(g,z.END),i=!h&&a.checkBoundaryOfElement(g,z.START);i||h?(d=g,d.match=i?"start":"end"):(g._4e_mergeSiblings(),
g.nodeName()!=this.element?(h=D(this),H(g,h[g.nodeName()]||h["*"])):I(this,g))}if(d){g=b;for(f=0;;f++){h=c.elements[f];if(h.equals(d))break;else if(h.match)continue;else h=h.clone();h[0].appendChild(g[0]);g=h}g["start"==d.match?"insertBefore":"insertAfter"](d);c=d.html();!c||"​"==c?d.remove():F.webkit&&ba(a.document.createTextNode("​")).insertBefore(g)}}else{var l=e.endNode,j=this;d=function(){for(var a=new G(b.parent()),c=new G(l.parent()),d=t,e=t,f=0;f<a.elements.length;f++){var g=a.elements[f];
if(g==a.block||g==a.blockLimit)break;j.checkElementRemovable(g)&&(d=g)}for(f=0;f<c.elements.length;f++){g=c.elements[f];if(g==c.block||g==c.blockLimit)break;j.checkElementRemovable(g)&&(e=g)}e&&l._4e_breakParent(e);d&&b._4e_breakParent(d)};d();for(c=new w(b[0].nextSibling);c[0]!==l[0];){f=c._4e_nextSourceNode();if(c[0]&&c[0].nodeType==r.NodeType.ELEMENT_NODE&&this.checkElementRemovable(c)&&(c.nodeName()==this.element?I(this,c):(g=D(this),H(c,g[c.nodeName()]||g["*"])),f[0].nodeType==r.NodeType.ELEMENT_NODE&&
f.contains(b)))d(),f=new w(b[0].nextSibling);c=f}}a.moveToBookmark(e)}function N(a){var e={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){e[c]=d});return e}function O(a,e){var b="";e!==u?(b=document.createElement("span"),b.style.cssText=a,b=b.style.cssText||""):b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function D(a){if(a._.overrides)return a._.overrides;var e=a._.overrides={},b=a._.definition.overrides;
if(b){p.isArray(b)||(b=[b]);for(var c=0;c<b.length;c++){var d=b[c],f,g,h;"string"==typeof d?f=d.toLowerCase():(f=d.element?d.element.toLowerCase():a.element,g=d.attributes,h=d.styles);d=e[f]||(e[f]={});if(g){f=d.attributes=d.attributes||[];for(var i in g)f.push([i.toLowerCase(),g[i]])}if(h){var d=d.styles=d.styles||[],j;for(j in h)d.push([j.toLowerCase(),h[j]])}}}return e}function I(a,e){var b=a._.definition,c=D(a),d=p.merge(b.attributes,(c[e.nodeName()]||c["*"]||{}).attributes),b=p.merge(b.styles,
(c[e.nodeName()]||c["*"]||{}).styles),c=p.isEmptyObject(d)&&p.isEmptyObject(b),f;for(f in d)("class"==f||a._.definition.fullMatch)&&e.attr(f)!=P(f,d[f])||(c=c||!!e.hasAttr(f),e.removeAttr(f));for(var g in b)a._.definition.fullMatch&&e.style(g)!=P(g,b[g],j)||(c=c||!!e.style(g),e.style(g,""));Q(e)}function P(a,e,b){var c=new w("<span>");c[b?"style":"attr"](a,e);return c[b?"style":"attr"](a)}function M(a,e){for(var b=D(a),c=e.all(a.element),d=c.length;0<=--d;)I(a,new w(c[d]));for(var f in b)if(f!=a.element){c=
e.all(f);for(d=c.length-1;0<=d;d--){var g=new w(c[d]);H(g,b[f])}}}function H(a,e){var b,c=e&&e.attributes;if(c)for(b=0;b<c.length;b++){var d=c[b][0],f;if(f=a.attr(d)){var g=c[b][1];(g===t||g.test&&g.test(f)||"string"==typeof g&&f==g)&&a[0].removeAttribute(d)}}if(c=e&&e.styles)for(b=0;b<c.length;b++)if(d=c[b][0],g=a.css(d)){var h=c[b][1];(h===t||h.test&&h.test(f)||"string"==typeof h&&g==h)&&a.css(d,"")}Q(a)}function Q(a){if(!a._4e_hasAttributes()){var e=a[0].firstChild,b=a[0].lastChild;a._4e_remove(j);
e&&(e.nodeType==r.NodeType.ELEMENT_NODE&&r._4e_mergeSiblings(e),b&&e!=b&&b.nodeType==r.NodeType.ELEMENT_NODE&&r._4e_mergeSiblings(b))}}var j=!0,u=!1,t=null,ba=p.all,r=p.DOM,n={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},z=v.RANGE,V=v.Selection,o=v.POSITION,$=v.Range,w=p.Node,F=p.UA,G=v.ElementPath,U={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},B=v.XHTML_DTD,K={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;
v.STYLE=n;A.prototype={apply:function(a){L.call(this,a,u)},remove:function(a){L.call(this,a,j)},applyToRange:function(a){return(this.applyToRange=this.type==n.STYLE_INLINE?Z:this.type==n.STYLE_BLOCK?W:t).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==n.STYLE_INLINE?aa:t).call(this,a)},checkElementRemovable:function(a,e){if(!a)return u;var b=this._.definition,c;if(a.nodeName()==this.element){if(!e&&!a._4e_hasAttributes())return j;var d=b._AC;if(d)b=d;else{var d={},
f=0,g=b.attributes;if(g)for(var h in g)f++,d[h]=g[h];if(g=A.getStyleText(b))d.style||f++,d.style=g;d._length=f;b=b._AC=d}if(b._length){for(var i in b)if("_length"!=i){f=a.attr(i)||"";if("style"==i)a:{d=b[i];f=O(f,u);"string"==typeof d&&(d=N(d));"string"==typeof f&&(f=N(f));g=void 0;for(g in d)if(!(g in f&&(f[g]==d[g]||"inherit"==d[g]||"inherit"==f[g]))){d=u;break a}d=j}else d=b[i]==f;if(d){if(!e)return j}else if(e)return u}if(e)return j}else return j}i=D(this);if(i=i[a.nodeName()]||i["*"]){if(!(b=
i.attributes)&&!(c=i.styles))return j;if(b)for(d=0;d<b.length;d++)if(i=b[d][0],i=a.attr(i))if(f=b[d][1],f===t||"string"==typeof f&&i==f||f.test&&f.test(i))return j;if(c)for(d=0;d<c.length;d++)if(i=a.css(c[d][0]))if(b=c[d][1],b===t||"string"==typeof b&&i==b||b.test&&b.test(i))return j}return u},checkActive:function(a){switch(this.type){case n.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,j);case n.STYLE_OBJECT:case n.STYLE_INLINE:for(var e=a.elements,b=0,c;b<e.length;b++)if(c=
e[b],!(this.type==n.STYLE_INLINE&&(r.equals(c,a.block)||r.equals(c,a.blockLimit))))if((this.type!=n.STYLE_OBJECT||c.nodeName()in K)&&this.checkElementRemovable(c,j))return j}return u}};A.getStyleText=function(a){var e=a._ST;if(e)return e;var e=a.styles,b=a.attributes&&a.attributes.style||"",c="";b.length&&(b=b.replace(R,";"));for(var d in e){var f=e[d],g=(d+":"+f).replace(R,";");"inherit"==f?c+=g:b+=g}b.length&&(b=O(b));return a._ST=b+c};return v.Style=A},{requires:["./base","./range","./selection",
"./domIterator","./elementPath"]});
