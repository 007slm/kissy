/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jan 31 22:56
*/
KISSY.add("dd/base",function(f,h,d,c){f={Draggable:d,DDM:h,DraggableDelegate:c};return KISSY.DD=f},{requires:["./base/ddm","./base/draggable","./base/draggable-delegate"]});
KISSY.add("dd/base/ddm",function(f,h,d,c,t){function n(){n.superclass.constructor.apply(this,arguments)}function o(b){var a;if(b=k._normalEvent(b))if(b.preventDefault(),a=this.__activeToDrag)a._move(b);else if(a=this.get("activeDrag"))a._move(b),s(this,b,a)}function p(b){b.preventDefault();D.call(this,b)}function s(b,u,g){var m=g.get("mode"),e=b.get("validDrops"),c=0,d=0,i=l(g.get("node")),j=a(i);f.each(e,function(b){var e;if(e=b.getNodeFromTarget(u,g.get("dragNode")[0],g.get("node")[0]))if("point"==
m)v(l(e),g.mousePos)&&(e=a(l(e)),c?e<d&&(c=b,d=e):(c=b,d=e));else if("intersect"==m)e=a(w(i,l(e))),e>d&&(d=e,c=b);else if("strict"==m&&(e=a(w(i,l(e))),e==j))return c=b,!1});if((e=b.get("activeDrop"))&&e!=c)e._handleOut(u),g._handleOut(u);b.setInternal("activeDrop",c);c&&(e!=c?c._handleEnter(u):c._handleOver(u))}function m(b){b._shim=(new c('<div style="background-color:red;position:'+(x?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+k.get("dragCursor")+";z-index:"+E+';"></div>')).prependTo(q.body||
q.documentElement).css("opacity",0);m=i;if(x)d.on(y,"resize scroll",z,b);i(b)}function i(b){var a=b.get("activeDrag").get("activeHandler"),e="auto";a&&(e=a.css("cursor"));"auto"==e&&(e=b.get("dragCursor"));b._shim.css({cursor:e,display:"block"});x&&z.call(b)}function j(b){var a=b.get("drops");b.setInternal("validDrops",[]);f.each(a,function(b){b._active()})}function r(b){var a=b.get("drops");b.setInternal("validDrops",[]);f.each(a,function(b){b._deActive()})}function l(b){var a=b.offset();return{left:a.left,
right:a.left+(b.__dd_cached_width||b.outerWidth()),top:a.top,bottom:a.top+(b.__dd_cached_height||b.outerHeight())}}function v(b,a){return b.left<=a.left&&b.right>=a.left&&b.top<=a.top&&b.bottom>=a.top}function a(b){return b.top>=b.bottom||b.left>=b.right?0:(b.right-b.left)*(b.bottom-b.top)}function w(b,a){var e=Math.max(b.top,a.top),g=Math.min(b.right,a.right),w=Math.min(b.bottom,a.bottom);return{left:Math.max(b.left,a.left),right:g,top:e,bottom:w}}function g(b){b&&(b.__dd_cached_width=b.outerWidth(),
b.__dd_cached_height=b.outerHeight())}var e=f.UA,y=f.Env.host,q=y.document,x=6===e.ie,E=999999,A=d.Gesture,B=A.move,C=A.end;n.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var D=8>e.ie?f.throttle(o,30):o,z=f.throttle(function(){var b;(b=this.get("activeDrag"))&&b.get("shim")&&this._shim.css({width:h.docWidth(),height:h.docHeight()})},30);f.extend(n,t,{__activeToDrag:0,_regDrop:function(b){this.get("drops").push(b)},
_unRegDrop:function(b){b=f.indexOf(b,this.get("drops"));-1!=b&&this.get("drops").splice(b,1)},_regToDrag:function(b){this.__activeToDrag=b;d.on(q,C,this._end,this);d.on(q,B,p,this);6===e.ie&&q.body.setCapture()},_start:function(){this.get("drops");var b=this.__activeToDrag;this.setInternal("activeDrag",b);this.__activeToDrag=0;b.get("shim")&&m(this);g(b.get("node"));j(this)},_addValidDrop:function(b){this.get("validDrops").push(b)},_end:function(){var b=this.get("activeDrag"),a=this.get("activeDrop");
d.remove(q,B,p,this);d.remove(q,C,this._end,this);6===e.ie&&q.body.releaseCapture();this.__activeToDrag&&(this.__activeToDrag._end(),this.__activeToDrag=0);this._shim&&this._shim.hide();b&&(b._end(),r(this),a&&a._end(),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var k=new n;k.inRegion=v;k.region=l;k.area=a;k.cacheWH=g;k.PREFIX_CLS="ks-dd-";k._normalEvent=function(b){var a=b.touches;if(a){if(1!=a.length)return;a=a[0];b.target=b.target||a.target;b.currentTarget=b.currentTarget||
a.currentTarget;b.which=1;b.pageX=a.pageX;b.pageY=a.pageY}return b};return k},{requires:["dom","event","node","base"]});
KISSY.add("dd/base/draggable-delegate",function(f,h,d,c,t,n){var o=h.PREFIX_CLS,p=n.Gesture.start,s=function(c){if(c=h._normalEvent(c)){var d,f;if(this._checkDragStartValid(c)){d=this.get("handlers");var r=new t(c.target);(d=d.length?this._getHandler(r):r)&&(f=this._getNode(d));f&&(this.setInternal("activeHandler",d),this.setInternal("node",f),this.setInternal("dragNode",f),this._prepare(c))}}};return d.extend({_onSetNode:function(){},_onSetContainer:function(){this.bindDragEvent()},_onSetDisabledChange:function(c){this.get("container")[c?
"addClass":"removeClass"](o+"-disabled")},bindDragEvent:function(){this.get("container").on(p,s,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("container").detach(p,s,this).detach("dragstart",this._fixDragStart)},_getHandler:function(d){for(var i=void 0,j=this.get("container"),h=this.get("handlers");d&&d[0]!==j[0];){f.each(h,function(f){if(c.test(d[0],f))return i=d,!1});if(i)break;d=d.parent()}return i},_getNode:function(c){return c.closest(this.get("selector"),this.get("container"))}},
{ATTRS:{container:{setter:function(c){return t.one(c)}},selector:{},handlers:{value:[],getter:0}}})},{requires:["./ddm","./draggable","dom","node","event"]});
KISSY.add("dd/base/draggable",function(f,h,d,c,t){function n(){return!1}var o=h.all,p=f.each,s=t.Gesture.start,m=f.UA.ie,i=f.Features,j=c.PREFIX_CLS,r=f.Env.host.document,d=d.extend({initializer:function(){this.addTarget(c)},_onSetNode:function(a){this.setInternal("dragNode",a);this.bindDragEvent()},bindDragEvent:function(){this.get("node").on(s,v,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("node").detach(s,v,this).detach("dragstart",this._fixDragStart)},_bufferTimer:null,
_onSetDisabledChange:function(a){this.get("dragNode")[a?"addClass":"removeClass"](j+"-disabled")},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var c=this,g=c.get("handlers"),e=0;p(g,function(g){if(g.contains(a)||g[0]==a)return e=1,c.setInternal("activeHandler",g),!1});return e},_checkDragStartValid:function(a){return this.get("primaryButtonOnly")&&1!=a.which||this.get("disabled")?0:1},_prepare:function(a){if(a){var d=this;o(a.target);m&&(l=r.body.onselectstart,r.body.onselectstart=
n);d.get("halt")&&a.stopPropagation();i.isTouchSupported()||a.preventDefault();var g=d.get("node"),e=a.pageX,a=a.pageY,g=g.offset();d.setInternal("startMousePos",d.mousePos={left:e,top:a});d.setInternal("startNodePos",g);d.setInternal("deltaPos",{left:e-g.left,top:a-g.top});c._regToDrag(d);if(e=d.get("bufferTime"))d._bufferTimer=setTimeout(function(){d._start()},1E3*e)}},_clearBufferTimer:function(){this._bufferTimer&&(clearTimeout(this._bufferTimer),this._bufferTimer=0)},_move:function(a){var d;
d=a.pageX;a=a.pageY;if(this.get("dragging")){var c=this.get("deltaPos"),e=d-c.left,c=a-c.top;this.mousePos={left:d,top:a};d={left:e,top:c,pageX:d,pageY:a,drag:this};this.setInternal("actualPos",{left:e,top:c});this.fire("dragalign",d);a=1;!1===this.fire("drag",d)&&(a=0);a&&this.get("move")&&this.get("node").offset(this.get("actualPos"))}else e=this.get("startMousePos"),c=this.get("clickPixelThresh"),(Math.abs(d-e.left)>=c||Math.abs(a-e.top)>=c)&&this._start()},stopDrag:function(){c._end()},_end:function(){var a;
this._clearBufferTimer();m&&(r.body.onselectstart=l);this.get("dragging")&&(this.get("node").removeClass(j+"drag-over"),(a=c.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:a}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this}))},_handleOut:function(){this.get("node").removeClass(j+"drag-over");this.fire("dragexit",{drag:this,drop:c.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(j+"drag-over");this.fire("dragenter",
a)},_handleOver:function(a){this.fire("dragover",a)},_start:function(){this._clearBufferTimer();this.setInternal("dragging",1);c._start();this.fire("dragstart",{drag:this})},destructor:function(){this.detachDragEvent();this.detach()}},{ATTRS:{node:{setter:function(a){if(!(a instanceof h))return o(a)}},clickPixelThresh:{valueFn:function(){return c.get("clickPixelThresh")}},bufferTime:{valueFn:function(){return c.get("bufferTime")}},dragNode:{},shim:{value:!0},handlers:{value:[],getter:function(a){var d=
this;a.length||(a[0]=d.get("node"));p(a,function(c,e){f.isFunction(c)&&(c=c.call(d));"string"==typeof c&&(c=d.get("node").one(c));c.nodeType&&(c=o(c));a[e]=c});d.setInternal("handlers",a);return a}},activeHandler:{},dragging:{value:!1,setter:function(a){this.get("dragNode")[a?"addClass":"removeClass"](j+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:{}},startMousePos:{},startNodePos:{},deltaPos:{},actualPos:{}}});d.DropMode=
{POINT:"point",INTERSECT:"intersect",STRICT:"strict"};var l,v=function(a){if(a=c._normalEvent(a)){var d=a.target;this._checkDragStartValid(a)&&this._checkHandler(d)&&this._prepare(a)}};return d},{requires:["node","rich-base","./ddm","event"]});
