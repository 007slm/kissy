/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Nov 22 19:06
*/
KISSY.add("dd/base",function(f,g,m,l){f={Draggable:m,DDM:g,DraggableDelegate:l};return KISSY.DD=f},{requires:["./base/ddm","./base/draggable","./base/draggable-delegate"]});
KISSY.add("dd/base/ddm",function(f,g,m,l,i,s){function o(){o.superclass.constructor.apply(this,arguments)}function r(a,t,h){var e=h.get("mode"),d=a.get("validDrops"),c=0,g=0,i=j(h.get("node")),k=p(i);f.each(d,function(a){var d;if(d=a.getNodeFromTarget(t,h.get("dragNode")[0],h.get("node")[0]))if("point"==e)u(j(d),h.mousePos)&&(d=p(j(d)),c?d<g&&(c=a,g=d):(c=a,g=d));else if("intersect"==e)d=p(b(i,j(d))),d>g&&(g=d,c=a);else if("strict"==e&&(d=p(b(i,j(d))),d==k))return c=a,!1});if((d=a.get("activeDrop"))&&
d!=c)d._handleOut(t),h._handleOut(t);a.setInternal("activeDrop",c);c&&(d!=c?c._handleEnter(t):c._handleOver(t))}function q(a){a._shim=(new i('<div style="background-color:red;position:'+(v?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+n.get("dragCursor")+";z-index:"+C+';"></div>')).prependTo(d.body||d.documentElement).css("opacity",0);q=c;if(v)l.on(e,"resize scroll",x,a);c(a)}function c(a){var b=a.get("activeDrag").get("activeHandler"),d="auto";b&&(d=b.css("cursor"));"auto"==
d&&(d=a.get("dragCursor"));a._shim.css({cursor:d,display:"block"});v&&x.call(a)}function w(a){var b=a.get("drops");a.setInternal("validDrops",[]);f.each(b,function(a){a._active()})}function k(a){var b=a.get("drops");a.setInternal("validDrops",[]);f.each(b,function(a){a._deActive()})}function j(a){var b=a.offset();return{left:b.left,right:b.left+(a.__dd_cached_width||a.outerWidth()),top:b.top,bottom:b.top+(a.__dd_cached_height||a.outerHeight())}}function u(a,b){return a.left<=b.left&&a.right>=b.left&&
a.top<=b.top&&a.bottom>=b.top}function p(a){return a.top>=a.bottom||a.left>=a.right?0:(a.right-a.left)*(a.bottom-a.top)}function b(a,b){var d=Math.max(a.top,b.top),h=Math.min(a.right,b.right),c=Math.min(a.bottom,b.bottom);return{left:Math.max(a.left,b.left),right:h,top:d,bottom:c}}function h(a){a&&(a.__dd_cached_width=a.outerWidth(),a.__dd_cached_height=a.outerHeight())}var e=f.Env.host,d=e.document,v=6===g.ie,y=f.throttle(function(a){var b;if(a=n._normalEvent(a))if(a.preventDefault(),b=this.__activeToDrag)b._move(a);
else if(b=this.get("activeDrag"))b._move(a),r(this,a,b)},30),C=999999,z=l.Gesture,A=z.move,B=z.end;o.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var x=f.throttle(function(){var a;(a=this.get("activeDrag"))&&a.get("shim")&&this._shim.css({width:m.docWidth(),height:m.docHeight()})},30);f.extend(o,s,{__activeToDrag:0,_regDrop:function(a){this.get("drops").push(a)},_unRegDrop:function(a){a=f.indexOf(a,
this.get("drops"));-1!=a&&this.get("drops").splice(a,1)},_regToDrag:function(a){this.__activeToDrag=a;l.on(d,B,this._end,this);l.on(d,A,y,this);6===g.ie&&d.body.setCapture()},_start:function(){this.get("drops");var a=this.__activeToDrag;this.setInternal("activeDrag",a);this.__activeToDrag=0;a.get("shim")&&q(this);h(a.get("node"));w(this)},_addValidDrop:function(a){this.get("validDrops").push(a)},_end:function(){var a=this.get("activeDrag"),b=this.get("activeDrop");l.remove(d,A,y,this);l.remove(d,
B,this._end,this);6===g.ie&&d.body.releaseCapture();this.__activeToDrag&&(this.__activeToDrag._end(),this.__activeToDrag=0);this._shim&&this._shim.hide();a&&(a._end(),k(this),b&&b._end(),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var n=new o;n.inRegion=u;n.region=j;n.area=p;n.cacheWH=h;n.PREFIX_CLS="ks-dd-";n._normalEvent=function(a){var b=a.touches;if(b){if(1!=b.length)return;b=b[0];a.target=a.target||b.target;a.currentTarget=a.currentTarget||b.currentTarget;a.which=
1;a.pageX=b.pageX;a.pageY=b.pageY}return a};return n},{requires:["ua","dom","event","node","base"]});
KISSY.add("dd/base/draggable-delegate",function(f,g,m,l,i,s){var o=g.PREFIX_CLS,r=s.Gesture.start,q=function(c){if(c=g._normalEvent(c)){var f,k;if(this._checkDragStartValid(c)){f=this.get("handlers");var j=new i(c.target);(f=f.length?this._getHandler(j):j)&&(k=this._getNode(f));k&&(this.setInternal("activeHandler",f),this.setInternal("node",k),this.setInternal("dragNode",k),this._prepare(c))}}};return m.extend({_onSetDisabledChange:function(c){this.get("container")[c?"addClass":"removeClass"](o+"-disabled")},
bindDragEvent:function(){this.get("container").on(r,q,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("container").detach(r,q,this).detach("dragstart",this._fixDragStart)},_getHandler:function(c){for(var g=void 0,i=this.get("container"),j=this.get("handlers");c&&c[0]!==i[0];){f.each(j,function(f){if(l.test(c[0],f))return g=c,!1});if(g)break;c=c.parent()}return g},_getNode:function(c){return c.closest(this.get("selector"),this.get("container"))}},{ATTRS:{container:{setter:function(c){return i.one(c)}},
selector:{},handlers:{value:[],getter:0}}})},{requires:["./ddm","./draggable","dom","node","event"]});
KISSY.add("dd/base/draggable",function(f,g,m,l,i,s){function o(){return!1}var r=f.each,q=s.Gesture.start,c=g.ie,w=f.Features,k=i.PREFIX_CLS,j=f.Env.host.document,g=l.extend({initializer:function(){this.addTarget(i);this.setInternal("dragNode",this.get("node"));this.bindDragEvent()},bindDragEvent:function(){this.get("node").on(q,p,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("node").detach(q,p,this).detach("dragstart",this._fixDragStart)},_bufferTimer:null,_onSetDisabledChange:function(b){this.get("dragNode")[b?
"addClass":"removeClass"](k+"-disabled")},_fixDragStart:function(b){b.preventDefault()},_checkHandler:function(b){var h=this,c=h.get("handlers"),d=0;r(c,function(c){if(c.contains(b)||c[0]==b)return d=1,h.setInternal("activeHandler",c),!1});return d},_checkDragStartValid:function(b){return this.get("primaryButtonOnly")&&1!=b.which||this.get("disabled")?0:1},_prepare:function(b){if(b){var h=this;c&&(u=j.body.onselectstart,j.body.onselectstart=o);h.get("halt")&&b.stopPropagation();w.isTouchSupported()||
b.preventDefault();var e=h.get("node"),d=b.pageX,b=b.pageY,e=e.offset();h.setInternal("startMousePos",h.mousePos={left:d,top:b});h.setInternal("startNodePos",e);h.setInternal("deltaPos",{left:d-e.left,top:b-e.top});i._regToDrag(h);if(d=h.get("bufferTime"))h._bufferTimer=setTimeout(function(){h._start()},1E3*d)}},_clearBufferTimer:function(){this._bufferTimer&&(clearTimeout(this._bufferTimer),this._bufferTimer=0)},_move:function(b){var c;c=b.pageX;b=b.pageY;if(this.get("dragging")){var e=this.get("deltaPos"),
d=c-e.left,e=b-e.top;this.mousePos={left:c,top:b};c={left:d,top:e,pageX:c,pageY:b,drag:this};this.setInternal("actualPos",{left:d,top:e});this.fire("dragalign",c);b=1;!1===this.fire("drag",c)&&(b=0);b&&this.get("move")&&this.get("node").offset(this.get("actualPos"))}else d=this.get("startMousePos"),e=this.get("clickPixelThresh"),(Math.abs(c-d.left)>=e||Math.abs(b-d.top)>=e)&&this._start()},stopDrag:function(){i._end()},_end:function(){var b;this._clearBufferTimer();c&&(j.body.onselectstart=u);this.get("dragging")&&
(this.get("node").removeClass(k+"drag-over"),(b=i.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:b}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this}))},_handleOut:function(){this.get("node").removeClass(k+"drag-over");this.fire("dragexit",{drag:this,drop:i.get("activeDrop")})},_handleEnter:function(b){this.get("node").addClass(k+"drag-over");this.fire("dragenter",b)},_handleOver:function(b){this.fire("dragover",b)},_start:function(){this._clearBufferTimer();
this.setInternal("dragging",1);i._start();this.fire("dragstart",{drag:this})},destructor:function(){this.detachDragEvent();this.detach()}},{ATTRS:{node:{setter:function(b){if(!(b instanceof m))return m.one(b)}},clickPixelThresh:{valueFn:function(){return i.get("clickPixelThresh")}},bufferTime:{valueFn:function(){return i.get("bufferTime")}},dragNode:{},shim:{value:!0},handlers:{value:[],getter:function(b){var c=this;b.length||(b[0]=c.get("node"));r(b,function(e,d){f.isFunction(e)&&(e=e.call(c));if("string"==
typeof e||e.nodeType)e=m.one(e);b[d]=e});c.setInternal("handlers",b);return b}},activeHandler:{},dragging:{value:!1,setter:function(b){this.get("dragNode")[b?"addClass":"removeClass"](k+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:{}},startMousePos:{},startNodePos:{},deltaPos:{},actualPos:{}}});g.DropMode={POINT:"point",INTERSECT:"intersect",STRICT:"strict"};f.mix(g,g.DropMode);var u,p=function(b){if(b=i._normalEvent(b)){var c=
b.target;this._checkDragStartValid(b)&&this._checkHandler(c)&&this._prepare(b)}};return g},{requires:["ua","node","rich-base","./ddm","event"]});
