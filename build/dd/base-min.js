/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Nov 5 20:56
*/
KISSY.add("dd/base",function(e,k,l,j){e={Draggable:l,DDM:k,DraggableDelegate:j};return KISSY.DD=e},{requires:["./base/ddm","./base/draggable","./base/draggable-delegate"]});
KISSY.add("dd/base/ddm",function(e,k,l,j,g,t){function d(){d.superclass.constructor.apply(this,arguments)}function u(f,a,c){var o=c.get("mode"),b=f.get("validDrops"),h=0,d=0,g=m(c.get("node")),s=n(g);e.each(b,function(f){var b;if(b=f.getNodeFromTarget(a,c.get("dragNode")[0],c.get("node")[0]))if("point"==o)i(m(b),c.mousePos)&&(b=n(m(b)),h?b<d&&(h=f,d=b):(h=f,d=b));else if("intersect"==o)b=n(v(g,m(b))),b>d&&(d=b,h=f);else if("strict"==o&&(b=n(v(g,m(b))),b==s))return h=f,!1});if((b=f.get("activeDrop"))&&
b!=h)b._handleOut(a),c._handleOut(a);f.setInternal("activeDrop",h);h&&(b!=h?h._handleEnter(a):h._handleOver(a))}function p(f){f._shim=(new g('<div style="background-color:red;position:'+(o?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+q.get("dragCursor")+";z-index:"+B+';"></div>')).prependTo(c.body||c.documentElement).css("opacity",0);p=r;if(o)j.on(a,"resize scroll",x,f);r(f)}function r(f){var a=f.get("activeDrag").get("activeHandler"),c="auto";a&&(c=a.css("cursor"));"auto"==
c&&(c=f.get("dragCursor"));f._shim.css({cursor:c,display:"block"});o&&x.call(f)}function b(f){var a=f.get("drops");f.setInternal("validDrops",[]);e.each(a,function(f){f._active()})}function s(f){var a=f.get("drops");f.setInternal("validDrops",[]);e.each(a,function(f){f._deActive()})}function m(f){var a=f.offset();return{left:a.left,right:a.left+(f.__dd_cached_width||f.outerWidth()),top:a.top,bottom:a.top+(f.__dd_cached_height||f.outerHeight())}}function i(a,c){return a.left<=c.left&&a.right>=c.left&&
a.top<=c.top&&a.bottom>=c.top}function n(a){return a.top>=a.bottom||a.left>=a.right?0:(a.right-a.left)*(a.bottom-a.top)}function v(a,c){var b=Math.max(a.top,c.top),o=Math.min(a.right,c.right),h=Math.min(a.bottom,c.bottom);return{left:Math.max(a.left,c.left),right:o,top:b,bottom:h}}function w(a){a&&(a.__dd_cached_width=a.outerWidth(),a.__dd_cached_height=a.outerHeight())}var a=e.Env.host,c=a.document,o=6===k.ie,h=e.throttle(function(a){var c;a.preventDefault();if(c=this.__activeToDrag)c._move(a);else if(c=
this.get("activeDrag"))c._move(a),u(this,a,c)},30),B=999999,y=j.Gesture,z=y.move,A=y.end;d.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var x=e.throttle(function(){var a;(a=this.get("activeDrag"))&&a.get("shim")&&this._shim.css({width:l.docWidth(),height:l.docHeight()})},30);e.extend(d,t,{__activeToDrag:0,_regDrop:function(a){this.get("drops").push(a)},_unRegDrop:function(a){a=e.indexOf(a,this.get("drops"));
-1!=a&&this.get("drops").splice(a,1)},_regToDrag:function(a){this.__activeToDrag=a;j.on(c,A,this._end,this);j.on(c,z,h,this);6===k.ie&&c.body.setCapture()},_start:function(){this.get("drops");var a=this.__activeToDrag;this.setInternal("activeDrag",a);this.__activeToDrag=0;a.get("shim")&&p(this);w(a.get("node"));b(this)},_addValidDrop:function(a){this.get("validDrops").push(a)},_end:function(){var a=this.get("activeDrag"),b=this.get("activeDrop");j.remove(c,z,h,this);j.remove(c,A,this._end,this);6===
k.ie&&c.body.releaseCapture();this.__activeToDrag&&(this.__activeToDrag._end(),this.__activeToDrag=0);this._shim&&this._shim.hide();a&&(a._end(),s(this),b&&b._end(),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var q=new d;q.inRegion=i;q.region=m;q.area=n;q.cacheWH=w;q.PREFIX_CLS="ks-dd-";q._normalHandlePreDragStart=function(a){return function(c){var b;if(b=c.originalEvent.touches){if(1!=b.length)return;b=b[0];c.target=c.target||b.target;c.currentTarget=c.currentTarget||
b.currentTarget;c.button=c.button||0}a.call(this,c)}};return q},{requires:["ua","dom","event","node","base"]});
KISSY.add("dd/base/draggable-delegate",function(e,k,l,j,g,t){function d(){d.superclass.constructor.apply(this,arguments)}var u=k.PREFIX_CLS,p=t.Gesture.start,r=k._normalHandlePreDragStart(function(b){var d,e;if(this._checkDragStartValid(b)){d=this.get("handlers");var i=new g(b.target);(d=d.length?this._getHandler(i):i)&&(e=this._getNode(d));e&&(this.setInternal("activeHandler",d),this.setInternal("node",e),this.setInternal("dragNode",e),this._prepare(b))}});e.extend(d,l,{_uiSetDisabledChange:function(b){this.get("container")[b?
"addClass":"removeClass"](u+"-disabled")},_init:function(){this.get("container").on(p,r,this).on("dragstart",this._fixDragStart)},_getHandler:function(b){for(var d=void 0,g=this.get("container"),i=this.get("handlers");b&&b[0]!==g[0];){e.each(i,function(e){if(j.test(b[0],e))return d=b,!1});if(d)break;b=b.parent()}return d},_getNode:function(b){return b.closest(this.get("selector"),this.get("container"))},destroy:function(){this.get("container").detach(p,r,this).detach("dragstart",this._fixDragStart);
this.detach()}},{ATTRS:{container:{setter:function(b){return g.one(b)}},selector:{},handlers:{value:[],getter:0}}});return d},{requires:["./ddm","./draggable","dom","node","event"]});
KISSY.add("dd/base/draggable",function(e,k,l,j,g,t){function d(){d.superclass.constructor.apply(this,arguments);this.addTarget(g);this.setInternal("dragNode",this.get("node"));this.on("afterDisabledChange",this._uiSetDisabledChange,this);var a;(a=this.get("disabled"))&&this._uiSetDisabledChange(a);this._init()}function u(){return!1}function p(a){var c=a.type,b;if(!m.isTouchSupported){if(-1!=c.indexOf("mouse")&&1!=a.which)return;b=[a];c=!c.match(/up$/i);a.touches=c?b:[];a.targetTouches=c?b:[];a.changedTouches=
b}return a}var r=e.each,b=t.Gesture.start,s=k.ie,m=e.Features,i=g.PREFIX_CLS,n=e.Env.host.document;d.ATTRS={node:{setter:function(a){if(!(a instanceof l))return l.one(a)}},clickPixelThresh:{valueFn:function(){return g.get("clickPixelThresh")}},bufferTime:{valueFn:function(){return g.get("bufferTime")}},dragNode:{},shim:{value:!0},handlers:{value:[],getter:function(a){var c=this;a.length||(a[0]=c.get("node"));r(a,function(b,d){e.isFunction(b)&&(b=b.call(c));if("string"==typeof b||b.nodeType)b=l.one(b);
a[d]=b});c.setInternal("handlers",a);return a}},activeHandler:{},dragging:{value:!1,setter:function(a){this.get("dragNode")[a?"addClass":"removeClass"](i+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:{}},startMousePos:{},startNodePos:{},deltaPos:{},actualPos:{}};d.DropMode={POINT:"point",INTERSECT:"intersect",STRICT:"strict"};e.mix(d,d.DropMode);var v,w=g._normalHandlePreDragStart(function(a){var c=a.target;this._checkDragStartValid(a)&&
this._checkHandler(c)&&this._prepare(p(a))});e.extend(d,j,{_bufferTimer:null,_uiSetDisabledChange:function(a){this.get("dragNode")[a?"addClass":"removeClass"](i+"-disabled")},_init:function(){this.get("node").on(b,w,this).on("dragstart",this._fixDragStart)},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var c=this,b=c.get("handlers"),d=0;r(b,function(b){if(b.contains(a)||b[0]==a)return d=1,c.setInternal("activeHandler",b),!1});return d},_checkDragStartValid:function(a){if(-1!=
a.type.indexOf("mouse")){if(this.get("primaryButtonOnly")&&1!=a.which||this.get("disabled"))return 0}else if(m.isTouchSupported&&1<a.touches.length)return 0;return 1},_prepare:function(a){var c=this;s&&(v=n.body.onselectstart,n.body.onselectstart=u);a.originalEvent.preventManipulation&&a.originalEvent.preventManipulation();c.get("halt")&&a.stopPropagation();m.isTouchSupported||a.preventDefault();var b=c.get("node"),d=a.touches[0].pageX,a=a.touches[0].pageY,b=b.offset();c.setInternal("startMousePos",
c.mousePos={left:d,top:a});c.setInternal("startNodePos",b);c.setInternal("deltaPos",{left:d-b.left,top:a-b.top});g._regToDrag(c);if(d=c.get("bufferTime"))c._bufferTimer=setTimeout(function(){c._start()},1E3*d)},_clearBufferTimer:function(){this._bufferTimer&&(clearTimeout(this._bufferTimer),this._bufferTimer=0)},_move:function(a){var a=p(a),b;b=a.touches[0].pageX;a=a.touches[0].pageY;if(this.get("dragging")){var d=this.get("deltaPos"),e=b-d.left,d=a-d.top;this.mousePos={left:b,top:a};b={left:e,top:d,
pageX:b,pageY:a,drag:this};this.setInternal("actualPos",{left:e,top:d});this.fire("dragalign",b);a=1;!1===this.fire("drag",b)&&(a=0);a&&this.get("move")&&this.get("node").offset(this.get("actualPos"))}else e=this.get("startMousePos"),d=this.get("clickPixelThresh"),(Math.abs(b-e.left)>=d||Math.abs(a-e.top)>=d)&&this._start()},stopDrag:function(){g._end()},_end:function(){var a;this._clearBufferTimer();s&&(n.body.onselectstart=v);this.get("dragging")&&(this.get("node").removeClass(i+"drag-over"),(a=
g.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:a}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this}))},_handleOut:function(){this.get("node").removeClass(i+"drag-over");this.fire("dragexit",{drag:this,drop:g.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(i+"drag-over");this.fire("dragenter",a)},_handleOver:function(a){this.fire("dragover",a)},_start:function(){this._clearBufferTimer();this.setInternal("dragging",
1);g._start();this.fire("dragstart",{drag:this})},destroy:function(){this.get("dragNode").detach(b,w,this).detach("dragstart",this._fixDragStart);this.detach()}});return d},{requires:["ua","node","base","./ddm","event"]});
