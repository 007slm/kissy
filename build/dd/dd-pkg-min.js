/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("dd/ddm",function(j,k,f,g,h){function a(){a.superclass.constructor.apply(this,arguments);this._init()}function d(b,e,l){l=l||150;if(l===-1)return function(){b.apply(e,arguments)};var p=j.now();return function(){var o=j.now();if(o-p>l){p=o;b.apply(e,arguments)}}}function c(b){var e=b.offset();return{left:e.left,right:e.left+b[0].offsetWidth,top:e.top,bottom:e.top+b[0].offsetHeight}}function i(b){if(b.top>=b.bottom||b.left>=b.right)return 0;return(b.right-b.left)*(b.bottom-b.top)}function m(b,
e){return{left:Math.max(b.left,e.left),right:Math.min(b.right,e.right),top:Math.max(b.top,e.top),bottom:Math.min(b.bottom,e.bottom)}}var s=document,v=j.require("node/node");a.ATTRS={prefixCls:{value:"ks-dd-"},bufferTime:{value:200},activeDrag:{},activeDrop:{},drops:{value:[]}};j.extend(a,h,{_regDrop:function(b){this.get("drops").push(b)},_unregDrop:function(b){b=j.indexOf(b,this.get("drops"));b!=-1&&this.get("drops").splice(b,1)},_init:function(){this._showShimMove=d(this._move,this,30)},_move:function(b){var e=
this.get("activeDrag");if(e){b.preventDefault();e._move(b);this._notifyDropsMove(b)}},_notifyDropsMove:function(b){var e=this.get("activeDrag"),l=e.get("mode"),p=this.get("drops"),o,u=0,t=c(e.get("node")),w=i(t);j.each(p,function(q){if(q.get("node")[0]!=e.get("dragNode")[0]){var n;if(l=="point"){var r=q.get("node");n=e.mousePos;r=c(r);if(r.left<=n.left&&r.right>=n.left&&r.top<=n.top&&r.bottom>=n.top){o=q;return false}}else if(l=="intersect"){n=i(m(t,c(q.get("node"))));if(n>u){u=n;o=q}}else if(l==
"strict"){n=i(m(t,c(q.get("node"))));if(n==w){o=q;return false}}}});(p=this.get("activeDrop"))&&p!=o&&p._handleOut(b);if(o)o._handleOver(b);else{e.get("node").removeClass(this.get("prefixCls")+"drag-over");this.set("activeDrop",null)}},_deactivateDrops:function(){var b=this.get("activeDrag"),e=this.get("activeDrop");b.get("node").removeClass(this.get("prefixCls")+"drag-over");if(e){var l={drag:b,drop:e};e.get("node").removeClass(this.get("prefixCls")+"drop-over");e.fire("drophit",l);b.fire("dragdrophit",
l);this.fire("drophit",l);this.fire("dragdrophit",l)}else{b.fire("dragdropmiss",{drag:b});this.fire("dragdropmiss",{drag:b})}},_start:function(b){var e=this,l=e.get("bufferTime")||0;e._registerEvent();if(l)e._bufferTimer=setTimeout(function(){e._bufferStart(b)},l);else e._bufferStart(b)},_bufferStart:function(b){this.set("activeDrag",b);b.get("shim")&&this._activeShim();b._start()},_end:function(b){var e=this.get("activeDrag");this._unregisterEvent();if(this._bufferTimer){clearTimeout(this._bufferTimer);
this._bufferTimer=null}this._shim&&this._shim.css({display:"none"});if(e){e._end(b);this._deactivateDrops(b);this.set("activeDrag",null);this.set("activeDrop",null)}},_activeShim:function(){var b=document;this._shim=(new v("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;cursor:move;z-index:999999;'></div>")).appendTo(b.body);this._shim.css("opacity",0);this._activeShim=this._showShim;this._showShim()},_showShim:function(){this._shim.css({display:"",height:k.docHeight()})},
_registerEvent:function(){f.on(s,"mouseup",this._end,this);f.on(s,"mousemove",this._showShimMove,this)},_unregisterEvent:function(){f.remove(s,"mousemove",this._showShimMove,this);f.remove(s,"mouseup",this._end,this)}});return new a},{requires:["dom","event","node","base"]});
KISSY.add("dd/draggable",function(j,k,f,g,h){function a(){a.superclass.constructor.apply(this,arguments);this._init()}a.POINT="pointer";a.INTERSECT="intersect";a.STRICT="strict";a.ATTRS={node:{setter:function(d){return f.one(d)}},dragNode:{},shim:{value:true},handlers:{value:[]},cursor:{value:"move"},mode:{value:"point"}};j.extend(a,g,{_init:function(){var d=this.get("node"),c=this.get("handlers");this.set("dragNode",d);if(c.length==0)c[0]=d;for(var i=0;i<c.length;i++){var m=c[i];m=j.one(m);m.unselectable();
this.get("cursor")&&m.css("cursor","move")}d.on("mousedown",this._handleMouseDown,this)},destroy:function(){for(var d=this.get("node"),c=this.get("handlers"),i=0;i<c.length;i++){var m=c[i];m.css("cursor")=="move"&&m.css("cursor","auto")}d.detach("mousedown",this._handleMouseDown,this);this.detach()},_check:function(d){for(var c=this.get("handlers"),i=0;i<c.length;i++){var m=c[i];if(m.contains(d)||m[0]==d[0])return true}return false},_handleMouseDown:function(d){if(this._check(new f(d.target))){d.preventDefault();
h._start(this);var c=this.get("node"),i=d.pageX;d=d.pageY;c=c.offset();this.startMousePos=this.mousePos={left:i,top:d};this.startNodePos=c;this._diff={left:i-c.left,top:d-c.top};this.set("diff",this._diff)}},_move:function(d){var c=this.get("diff"),i=d.pageX-c.left;c=d.pageY-c.top;this.mousePos={left:d.pageX,top:d.pageY};this.fire("drag",{left:i,top:c});h.fire("drag",{left:i,top:c,drag:this})},_end:function(){this.fire("dragend");h.fire("dragend",{drag:this})},_start:function(){this.fire("dragstart");
h.fire("dragstart",{drag:this})}});return a},{requires:["ua","node","base","dd/ddm"]});
KISSY.add("dd/droppable",function(j,k,f,g){function h(){h.superclass.constructor.apply(this,arguments);this._init()}h.ATTRS={node:{setter:function(a){a=k.one(a);a.addClass(g.get("prefixCls")+"drop");return a}}};j.extend(h,f,{_init:function(){g._regDrop(this)},_handleOut:function(){var a=g.get("activeDrag");this.get("node").removeClass(g.get("prefixCls")+"drop-over");this.fire("dropexit",{drop:this,drag:a});g.fire("dropexit",{drop:this,drag:a});a.get("node").removeClass(g.get("prefixCls")+"drag-over");
a.fire("dragexit",{drop:this,drag:a});g.fire("dragexit",{drop:this,drag:a})},_handleOver:function(){var a=g.get("activeDrop");g.set("activeDrop",this);var d=g.get("activeDrag");this.get("node").addClass(g.get("prefixCls")+"drop-over");var c={drag:d,drop:this};if(this!=a){d.get("node").addClass(g.get("prefixCls")+"drag-over");d.fire("dragenter",c);this.fire("dropenter",c);g.fire("dragenter",c);g.fire("dropenter",c)}else{d.fire("dragover",c);this.fire("dropover",c);g.fire("dragover",c);g.fire("dropover",
c)}},destroy:function(){g._unregDrop(this)}});return h},{requires:["node","base","dd/ddm"]});
KISSY.add("dd/proxy",function(j){function k(){k.superclass.constructor.apply(this,arguments)}k.ATTRS={node:{value:function(f){f=j.one(f.get("node")[0].cloneNode(true));f.attr("id",j.guid("ks-dd-proxy"));return f}},destroyOnEnd:{value:false}};j.extend(k,j.Base,{attach:function(f){var g=this;f.on("dragstart",function(){var h=g.get("node"),a=f.get("node");if(!g.__proxy&&j.isFunction(h)){h=h(f);h.css("position","absolute");g.__proxy=h}a.parent().append(h);h.show();h.offset(a.offset());f.set("dragNode",
a);f.set("node",h)});f.on("dragend",function(){var h=g.__proxy;f.get("dragNode").offset(h.offset());h.hide();if(g.get("destroyOnEnd")){h.remove();g.__proxy=null}f.set("node",f.get("dragNode"))})},destroy:function(){var f=this.get("node");f&&!j.isFunction(f)&&f.remove()}});return k});
KISSY.add("dd/draggable-delegate",function(j,k,f,g){function h(){h.superclass.constructor.apply(this,arguments)}j.extend(h,f,{_init:function(){var a=this.get("handlers"),d=this.get("container");a.length==0&&a.push(this.get("selector"));d.on("mousedown",this._handleMouseDown,this)},_getHandler:function(a){for(var d=this.get("container"),c=this.get("handlers");a&&a[0]!==d[0];){for(var i=0;i<c.length;i++)if(g.test(a[0],c[i],d[0]))return a;a=a.parent()}},_getNode:function(a){for(var d=this.get("container"),
c=this.get("selector");a&&a[0]!=d[0];){if(g.test(a[0],c,d[0]))return a;a=a.parent()}},_handleMouseDown:function(a){var d=a.target;if(d=d&&this._getHandler(d)){var c=this._getNode(d);if(c){a.preventDefault();this.set("node",c);this.set("dragNode",c);k._start(this);d=a.pageX;a=a.pageY;c=c.offset();this.startMousePos=this.mousePos={left:d,top:a};this.startNodePos=c;this._diff={left:d-c.left,top:a-c.top};this.set("diff",this._diff)}}}},{ATTRS:{container:{setter:function(a){return j.one(a)}},selector:{}}});
return h},{requires:["./ddm","./draggable","dom"]});KISSY.add("dd",function(j,k,f,g,h,a){k={Draggable:f,Droppable:g,DDM:k,Proxy:h,DraggableDelegate:a};j.mix(j,k);return k},{requires:["dd/ddm","dd/draggable","dd/droppable","dd/proxy","dd/draggable-delegate"]});
