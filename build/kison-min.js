/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Oct 15 22:35
*/
KISSY.add("kison/grammar",function(b,m,h,a,g,f,d,o){function i(e){var q=0,c;for(c in e)q++;return q}function n(e,q){for(var c=0;c<q.length;c++)if(e.equals(q[c]))return c;return-1}function u(){u.superclass.constructor.apply(this,arguments)}function r(e){var q=this.lexer,c,a,l=this.table,d=l.gotos,l=l.action,g=this.productions,f=[null],j=[0];for(q.resetInput(e);;){e=j[j.length-1];c||(c=q.lex());if(!c)return!1;a=l[e]&&l[e][c];if(!a){var h=[];l[e]&&b.each(l[e],function(e,c){h.push(c)});return!1}switch(a[k.TYPE_INDEX]){case k.SHIFT_TYPE:j.push(c);
f.push(q.text);j.push(a[k.TO_INDEX]);c=null;break;case k.REDUCE_TYPE:var p=g[a[k.PRODUCTION_INDEX]],e=p.symbol||p[0];a=p.action||p[2];var i=(p.rhs||p[1]).length;this.$$=p=f[f.length-i];for(p=0;p<i;p++)this["$"+(i-p)]=f[f.length-1-p];var o;a&&(o=a.call(this));p=void 0!==o?o:this.$$;i&&(j=j.slice(0,-2*i),f=f.slice(0,-1*i));j.push(e);f.push(p);j.push(d[j[j.length-2]][j[j.length-1]]);break;case k.ACCEPT_TYPE:return p}}}var k={SHIFT_TYPE:1,REDUCE_TYPE:2,ACCEPT_TYPE:0,TYPE_INDEX:0,PRODUCTION_INDEX:1,TO_INDEX:2},
t=b.mix,s=d.STATIC.END_TAG;b.extend(u,m,{build:function(){var e=this,q=e.get("productions");q.unshift({symbol:"$START",rhs:[q[0].symbol]});b.each(q,function(c,a){c.symbol=e.mapSymbol(c.symbol);var l=c.rhs;b.each(l,function(c,a){l[a]=e.mapSymbol(c)});q[a]=new o(c)});e.buildTerminals();e.buildNonTerminals();e.buildNullAble();e.buildFirsts();e.buildItemSet();e.buildLalrItemSets();e.buildTable()},buildTerminals:function(){var e=this.get("lexer"),e=e&&e.rules,a=this.get("terminals");a[this.mapSymbol(s)]=
1;b.each(e,function(e){(e=e.token||e[0])&&(a[e]=1)})},buildNonTerminals:function(){var e=this.get("terminals"),a=this.get("nonTerminals"),c=this.get("productions");b.each(c,function(c){var l=c.get("symbol"),d=a[l];d||(d=a[l]=new f({symbol:l}));d.get("productions").push(c);b.each(c.get("handles"),function(c){!e[c]&&!a[c]&&(a[c]=new f({symbol:c}))})})},buildNullAble:function(){for(var e=this,a,c,d,l,f,g,i,j=e.get("nonTerminals"),h=!0;h;)for(l in h=!1,b.each(e.get("productions"),function(b){if(!b.get("nullAble")){c=
b.get("rhs");for(d=a=0;f=c[a];++a)e.isNullAble(f)&&d++;d===a&&b.set("nullAble",h=!0)}}),j)if(!j[l].get("nullAble")){i=j[l].get("productions");for(a=0;g=i[a];a++)if(g.get("nullAble")){j[l].set("nullAble",h=!0);break}}},isNullAble:function(e){var a=this.get("nonTerminals");if(e instanceof Array){for(var a=0,c;c=e[a];++a)if(!this.isNullAble(c))return!1;return!0}return a[e]?a[e].get("nullAble"):!1},findFirst:function(e){var a={},c,b,d=this.get("nonTerminals");if(e instanceof Array){for(b=0;(c=e[b])&&
!(d[c]?t(a,d[c].get("firsts")):a[c]=1,!this.isNullAble(c));++b);return a}return d[e]?d[e].get("firsts"):[e]},buildFirsts:function(){var e=this,a;e.get("productions");for(var c=e.get("nonTerminals"),d=!0,f,g;d;)for(f in d=!1,b.each(e.get("productions"),function(a){var c=e.findFirst(a.get("rhs"));i(c)!==i(a.get("firsts"))&&(a.set("firsts",c),d=!0)}),c)a=c[f],g={},b.each(a.get("productions"),function(a){t(g,a.get("firsts"))}),i(g)!==i(a.get("firsts"))&&(a.set("firsts",g),d=!0)},closure:function(e){for(var d=
this,c=e.get("items"),f=d.get("productions"),g=1;g;)g=!1,b.each(c,function(c){var h=c.get("dotPosition"),i=c.get("production").get("rhs"),j=i[h],c=c.get("lookAhead"),k={};b.each(c,function(a,e){var c=i.slice(h+1);c.push(e);b.mix(k,d.findFirst(c))});b.each(f,function(c){if(c.get("symbol")==j){var c=new a({production:c}),d=e.findItemIndex(c,!0);-1!=d?(c=e.getItemAt(d),g=g||!!c.addLookAhead(k)):(c.addLookAhead(k),e.addItem(c),g=!0)}})});return e},gotos:function(e,d){var c=new g,f=e.get("items");b.each(f,
function(e){var b=e.get("production"),g=e.get("dotPosition");b.get("rhs")[g]==d&&(b=new a({production:b,dotPosition:g+1}),g=c.findItemIndex(b,!0),-1!=g?(b=c.getItemAt(g),b.addLookAhead(e.get("lookAhead"))):(b.addLookAhead(e.get("lookAhead")),c.addItem(b)))});return this.closure(c)},findItemSetIndex:function(a){for(var b=this.get("itemSets"),c=0;c<b.length;c++)if(b[c].equals(a))return c;return-1},buildItemSet:function(){var e=this,d=e.get("itemSets"),c={},f=e.get("productions");c[e.mapSymbol(s)]=1;
c=e.closure(new g({items:[new a({production:f[0],lookAhead:c})]}));d.push(c);var l=!0,h=b.merge(e.get("terminals"),e.get("nonTerminals"));for(delete h[e.mapSymbol(s)];l;)l=!1,c=d.concat(),b.each(c,function(a){b.each(h,function(c,b){a.__cache||(a.__cache={});if(!a.__cache[b]){var g=e.gotos(a,b);a.__cache[b]=1;if(0!=g.size()){var f=e.findItemSetIndex(g);-1<f?g=d[f]:(d.push(g),l=!0);a.get("gotos")[b]=g;g.addReverseGoto(b,a)}}})})},buildLalrItemSets:function(){for(var a=this.get("itemSets"),d=0;d<a.length;d++)for(var c=
a[d],g=d+1;g<a.length;g++){var f=a[g];if(c.equals(f,!0)){for(var h=0;h<c.get("items").length;h++)c.get("items")[h].addLookAhead(f.get("items")[h].get("lookAhead"));var i=c.get("gotos");b.each(f.get("gotos"),function(a,e){i[e]=a;a.addReverseGoto(e,c)});b.each(f.get("reverseGotos"),function(a,e){b.each(a,function(a){a.get("gotos")[e]=c;c.addReverseGoto(e,a)})});a.splice(g--,1)}}},buildTable:function(){var a=this,d=a.get("table"),c=a.get("itemSets"),g=a.get("productions"),f={},h={},i;d.gotos=f;d.action=
h;for(var o=a.get("nonTerminals"),j=0;j<c.length;j++)d=c[j],b.each(d.get("gotos"),function(a,e){o[e]?(f[j]=f[j]||{},f[j][e]=n(a,c)):(h[j]=h[j]||{},i=h[j][e]=[],i[k.TYPE_INDEX]=k.SHIFT_TYPE,i[k.PRODUCTION_INDEX]=0,i[k.TO_INDEX]=n(a,c))}),b.each(d.get("items"),function(c){var d=c.get("production");c.get("dotPosition")==d.get("rhs").length&&(d.get("symbol")==a.mapSymbol("$START")?c.get("lookAhead")[a.mapSymbol(s)]&&(h[j]=h[j]||{},i=h[j][a.mapSymbol(s)]=[],i[k.TYPE_INDEX]=k.ACCEPT_TYPE,i[k.TO_INDEX]=
i[k.PRODUCTION_INDEX]=0):(h[j]=h[j]||{},b.each(c.get("lookAhead"),function(a,c){i=h[j][c]=[];i[k.TYPE_INDEX]=k.REDUCE_TYPE;i[k.TO_INDEX]=0;i[k.PRODUCTION_INDEX]=b.indexOf(d,g)})))})},visualizeTable:function(){var a=this.get("table"),d=a.gotos,a=a.action,c=this.get("productions"),g=[];b.each(this.get("itemSets"),function(a,c){g.push(Array(70).join("*")+" itemSet : "+c);g.push(a.toString());g.push("")});g.push("");g.push(Array(70).join("*")+" table : ");b.each(a,function(a,d){b.each(a,function(a,e){var b,
f=a[k.TYPE_INDEX];f==k.ACCEPT_TYPE?b="acc":f==k.REDUCE_TYPE?(b=c[a[k.PRODUCTION_INDEX]],b="r, "+b.get("symbol")+"="+b.get("rhs").join(" ")):f==k.SHIFT_TYPE&&(b="s, "+a[k.TO_INDEX]);g.push("action["+d+"]["+e+"] = "+b)})});g.push("");b.each(d,function(a,c){b.each(a,function(a,d){g.push("goto["+c+"]["+d+"] = "+a)})});return g},mapSymbol:function(a){var d=this.tokenMap,c=this.symbolMap;d&&d[a]?a=d[a]:c&&(a=c[a]||(c[a]=++this.symbolId));return a},genCode:function(a){arguments.length||(a=1);var d=this.get("table"),
c=this.get("lexer").genCode(a);a&&(this.symbolMap={},this.tokenMap=c.tokenMap,this.symbolId=c.tokenId+1);this.build();var g=[];b.each(this.get("productions"),function(a){var c=a.get("symbol"),d=a.get("rhs");g.push([c,d,a.get("action")||0])});var f=[];f.push("/* Generated by kison from KISSY */");f.push("var parser={},S=KISSY,GrammarConst="+h.serializeObject(k)+";");f.push(c.code);f.push("parser.lexer=lexer;");f.push("parser.productions="+h.serializeObject(g)+";");f.push("parser.table="+h.serializeObject(d)+
";");f.push("parser.parse="+r.toString()+";");f.push("return parser;");return f.join("\n")}},{ATTRS:{table:{value:{}},itemSets:{value:[]},productions:{value:[]},nonTerminals:{value:{}},lexer:{setter:function(a){if(!(a instanceof d))return new d(a)}},terminals:{value:{}}}});return u},{requires:"base,./utils,./item,./item-set,./non-terminal,./lexer,./production".split(",")});
KISSY.add("kison/item-set",function(b,m){function h(){h.superclass.constructor.apply(this,arguments)}b.extend(h,m,{addItem:function(a){for(var g=this.get("items"),b=0;b<g.length&&!(g[b].get("production").toString()>a.get("production").toString());b++);g.splice(b,0,a)},size:function(){return this.get("items").length},findItemIndex:function(a,b){for(var f=this.get("items"),d=0;d<f.length;d++)if(f[d].equals(a,b))return d;return-1},getItemAt:function(a){return this.get("items")[a]},equals:function(a,
b){var f=this.get("items"),d,h=a.get("items");if(f.length!=h.length)return!1;for(d=0;d<f.length;d++)if(!f[d].equals(h[d],b))return!1;return!0},toString:function(){var a=[];b.each(this.get("items"),function(b){a.push(b.toString())});return a.join("\n")},addReverseGoto:function(a,b){var f=this.get("reverseGotos");f[a]=f[a]||[];f[a].push(b)}},{ATTRS:{items:{value:[]},gotos:{value:{}},reverseGotos:{value:{}}}});return h},{requires:["base"]});
KISSY.add("kison/item",function(b,m){function h(){h.superclass.constructor.apply(this,arguments)}b.extend(h,m,{equals:function(a,g){return!a.get("production").equals(this.get("production"))||a.get("dotPosition")!=this.get("dotPosition")||!g&&!b.equals(this.get("lookAhead"),a.get("lookAhead"))?!1:!0},toString:function(a){return this.get("production").toString(this.get("dotPosition"))+(a?"":","+b.keys(this.get("lookAhead")).join("/"))},addLookAhead:function(a){var g=this.get("lookAhead"),f=0;b.each(a,
function(a,b){g[b]||(f=g[b]=1)});return f}},{ATTRS:{production:{},dotPosition:{value:0},lookAhead:{value:{}}}});return h},{requires:["base"]});KISSY.add("kison",function(b,m,h,a,g){b={};b.Grammar=m;b.Production=h;b.Lexer=a;b.Utils=g;return b},{requires:["kison/grammar","kison/production","kison/lexer","kison/utils"]});
KISSY.add("kison/lexer",function(b,m){var h=function(a){this.rules=[];b.mix(this,a);for(var a=0,g=this.rules.length;a<g;a++){var f=this.rules[a];!b.isArray(f)&&!("state"in f)&&(f.state=h.STATIC.INIT)}this.resetInput(this.input)};h.STATIC={INIT:b.guid("ks"+b.now()),DEBUG_CONTEXT_LIMIT:20,END_TAG:"$EOF"};h.prototype={resetInput:function(a){this.input=a;b.mix(this,{matched:"",stateStack:[h.STATIC.INIT],match:"",text:"",firstLine:1,lineNumber:1,lastLine:1,firstColumn:1,lastColumn:1})},genCode:function(a){arguments.length||
(a=1);var b=[],f=0,d={},o={},i=0;a&&(d[h.STATIC.INIT]=++f,o[h.STATIC.END_TAG]=++i);b.push("var Lexer = "+h.toString()+";");b.push("Lexer.prototype= "+m.serializeObject(h.prototype,/genCode/)+";");b.push("Lexer.STATIC= "+m.serializeObject(h.STATIC)+";");var n=m.serializeObject({rules:this.rules},a?function(a){if(a&&a.regexp){var b=a.state,g=a.token||0;g&&(g=o[g]||(o[g]=++i));b=d[b]||(d[b]=++f);return[g,a.regexp||0,a.action||0,b]}}:0);b.push("var lexer = new Lexer("+n+");");a&&(this.rules=eval("("+
n+")").rules,b.push("lexer.tokenMap = "+m.serializeObject(o)+";"),b.push("lexer.stateMap = "+m.serializeObject(d)+";"));return{code:b.join("\n"),tokenMap:o,stateMap:d,tokenId:i}},getCurrentRules:function(){var a=this.stateStack[this.stateStack.length-1],g=[],a=(this.stateMap||{})[a]||a;b.each(this.rules,function(b){(b.state||b[3])==a&&g.push(b)});return g},pushState:function(a){this.stateStack.push(a)},popState:function(){this.stateStack.pop()},showDebugInfo:function(){var a=h.STATIC.DEBUG_CONTEXT_LIMIT,
b=this.matched,f=this.match,d=this.input,b=b.slice(0,b.length-f.length),b=(b.length>a?"...":"")+b.slice(-a).replace(/\n/," "),f=f+d,f=f.slice(0,a)+(f.length>a?"...":"");return b+f+"\n"+Array(b.length+1).join("-")+"^"},lex:function(){var a=this.tokenMap||{},g=this.input,f,d,o=h.STATIC.END_TAG,i,n;n=this.getCurrentRules();this.match=this.text="";if(!b.trim(g))return a[o]||o;for(f=0;f<n.length;f++)if(d=n[f],o=d.token||d[0],i=d.action||d[2]||void 0,d=g.match(d.regexp||d[1])){if(n=d[0].match(/\n.*/g))this.lineNumber+=
n.length;b.mix(this,{firstLine:this.lastLine,lastLine:this.lineNumber+1,firstColumn:this.lastColumn,lastColumn:n?n[n.length-1].length-1:this.lastColumn+d[0].length});n=this.match=d[0];this.matches=d;this.text=n;this.matched+=n;i=i&&i.call(this);i=void 0==i?o:a[i]||i;this.input=g=g.slice(n.length);return i?i:this.lex()}}};return h},{requires:["./utils"]});
KISSY.add("kison/non-terminal",function(b,m){function h(){h.superclass.constructor.apply(this,arguments)}b.extend(h,m,{},{ATTRS:{productions:{value:[]},firsts:{value:{}},symbol:{},nullAble:{value:!1}}});return h},{requires:["base"]});
KISSY.add("kison/production",function(b,m){function h(){h.superclass.constructor.apply(this,arguments)}b.extend(h,m,{equals:function(a){return!b.equals(a.get("rhs"),this.get("rhs"))?!1:a.get("symbol")==this.get("symbol")},toString:function(a){var g="",f=this.get("rhs");b.each(f,function(b,f){f==a&&(g+=".");g+=b});a==f.length&&(g+=".");return this.get("symbol")+"=>"+g}},{ATTRS:{firsts:{value:{}},follows:{value:[]},symbol:{},rhs:{value:[]},nullAble:{value:!1},action:{}}});return h},{requires:["base"]});
KISSY.add("kison/utils",function(b){var m=/"/g,h=/'/g,a;return{escapeString:a=function(a,b){var d=h;'"'==b?d=m:b="'";return a.replace(/\\/g,"\\\\").replace(d,"\\"+b)},serializeObject:function f(d,h){var i;if(h&&b.isFunction(h)&&!1===(i=h(d)))return!1;void 0!==i&&(d=i);i=[];if("string"==typeof d)return"'"+a(d)+"'";if(b.isNumber(d))return d+"";if(b.isRegExp(d))return"/"+d.source+"/"+(d.global?"g":"")+(d.ignoreCase?"i":"")+(d.multiline?"m":"");if(b.isArray(d)){i.push("[");var n=[];b.each(d,function(a){a=
f(a,h);!1!==a&&n.push(a)});i.push(n.join(", "));i.push("]");return i.join("")}if(b.isObject(d)){i=["{"];var m=1,r;for(r in d){var k=d[r];if(!h||!b.isRegExp(h)||!r.match(h))if(k=f(k,h),!1!==k){var t="'"+a(r)+"'";i.push((m?"":",")+t+": "+k);m=0}}i.push("}");return i.join("\n")}return d+""}}});
