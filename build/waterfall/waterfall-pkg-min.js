/*
Copyright 2011, KISSY UI Library v1.1.8dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("waterfall",function(c,j){function k(){k.superclass.constructor.apply(this,arguments);this._init()}function n(a,b,d,e){var f=c.makeArray(a),o={},h;if(f.length>0)h=setTimeout(function(){var l=+new Date;do{var q=f.shift();b.call(d,q)}while(f.length>0&&+new Date-l<50);if(f.length>0)h=setTimeout(arguments.callee,25);else e&&e.call(d,a)},25);else e&&c.later(e,0,false,d,[a]);o.stop=function(){if(h){clearTimeout(h);f=[]}};return o}function i(){var a=this._containerRegion;a&&this.get("container").width()===
a.width||this.adjust()}function m(){var a=this.get("container").width(),b=this.get("curColHeights");b.length=Math.max(parseInt(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};c.each(b,function(d,e){b[e]=0})}function g(a){a=new c.Node(a);for(var b=this.get("curColHeights"),d=this.get("container"),e=b.length,f=0,o=this._containerRegion,h=Number.MAX_VALUE,l=0;l<e;l++)if(b[l]<h){h=b[l];f=l}e||(h=0);e=Math.max(o.width-e*this.get("colWidth"),0)/2;a.css({left:f*this.get("colWidth")+
e,top:h});d.contains(a)||d.append(a);b[f]+=a[0].offsetHeight+(parseInt(a.css("marginTop"))||0)+(parseInt(a.css("marginBottom"))||0);return a}var p=c.Base;c.mix(c,{buffer:function(a,b,d){function e(){e.stop();f=c.later(a,b,false,d||this)}b=b||150;if(b===-1)return function(){a.apply(d||this,arguments)};var f=0;e.stop=function(){if(f){f.cancel();f=0}};return e}});k.ATTRS={container:{setter:function(a){return c.one(a)}},curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},
colWidth:{}};c.extend(k,p,{isAdjusting:function(){return!!this._adjuster},_init:function(){i.call(this);this.__onResize=c.buffer(i,50,this);c.Event.on(window,"resize",this.__onResize)},adjust:function(a){var b=this,d=b.get("container").all(".ks-waterfall");b.isAdjusting()&&b._adjuster.stop();m.call(b);return b._adjuster=n(d,g,b,function(){b.get("container").height(Math.max.apply(Math,b.get("curColHeights")));b._adjuster=0;a&&a.call(b)})},addItems:function(a,b){var d=this;d._adder=n(a,d._addItem,d,
function(){d.get("container").height(Math.max.apply(Math,d.get("curColHeights")));d._adder=0;b&&b.call(d)});return d._adder},_addItem:function(a){this.get("curColHeights");this.get("container");a=g.call(this,a);var b=this.get("effect");b.effect&&a[b.effect](b.duration,j,b.easing)},destroy:function(){c.Event.remove(window,"resize",this.__onResize)}});c.Waterfall=k},{requires:["template"]});
KISSY.add("waterfall/loader",function(c){function j(){j.superclass.constructor.apply(this,arguments)}function k(){if(!(this.__loading||this.__pause))if(this.isAdjusting())this.__onScroll();else{var i=this.get("container").offset().top,m=this.get("diff"),g=this.get("curColHeights");if(g.length)i+=Math.min.apply(Math,g);m+c.DOM.scrollTop()+c.DOM.viewportHeight()>i&&n.call(this)}}function n(){function i(a){g.__loading=false;g.addItems(a)}function m(){g.end()}var g=this;this.get("container");g.__loading=
true;var p=g.get("load");p&&p(i,m)}j.ATTRS={diff:{getter:function(i){return i||0}}};c.extend(j,c.Waterfall,{_init:function(){j.superclass._init.apply(this,arguments);this.__onScroll=c.buffer(k,50,this);c.Event.on(window,"scroll",this.__onScroll);k.call(this)},end:function(){this.__loading=false;c.Event.remove(window,"scroll",this.__onScroll)},pause:function(){this.__pause=1},resume:function(){this.__pause=0},destroy:function(){j.superclass.destroy.apply(this,arguments);c.Event.remove(window,"scroll",
this.__onScroll)}});c.Waterfall.Loader=j},{host:"waterfall"});
