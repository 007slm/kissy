/*
Copyright 2011, KISSY UI Library v1.1.8dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("waterfall",function(c,j){function l(){l.superclass.constructor.apply(this,arguments);this._init()}function n(b,a,d,e){var g=c.makeArray(b),o={},i;if(g.length>0)i=setTimeout(function(){var m=+new Date;do{var q=g.shift();a.call(d,q)}while(g.length>0&&+new Date-m<50);if(g.length>0)i=setTimeout(arguments.callee,25);else e&&e.call(d,b)},25);else e&&c.later(e,0,false,d,[b]);o.stop=function(){if(i){clearTimeout(i);g=[]}};return o}function f(){var b=this._containerRegion;b&&this.get("container").width()===
b.width||this.adjust()}function k(){var b=this.get("container").width(),a=this.get("curColHeights");a.length=Math.max(parseInt(b/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:b};c.each(a,function(d,e){a[e]=0})}function h(b){b=new c.Node(b);for(var a=this.get("curColHeights"),d=this.get("container"),e=a.length,g=0,o=this._containerRegion,i=Number.MAX_VALUE,m=0;m<e;m++)if(a[m]<i){i=a[m];g=m}e||(i=0);e=Math.max(o.width-e*this.get("colWidth"),0)/2;b.css({left:g*this.get("colWidth")+
e,top:i});d.contains(b)||d.append(b);a[g]+=b.height();return b}var p=c.Base;c.mix(c,{buffer:function(b,a,d){function e(){e.stop();g=c.later(b,a,false,d||this)}a=a||150;if(a===-1)return function(){b.apply(d||this,arguments)};var g=0;e.stop=function(){if(g){g.cancel();g=0}};return e}});l.ATTRS={container:{setter:function(b){return c.one(b)}},curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{}};c.extend(l,p,{isAdjusting:function(){return!!this._adjuster},
_init:function(){f.call(this);this.__onResize=c.buffer(f,50,this);c.Event.on(window,"resize",this.__onResize)},adjust:function(b){var a=this,d=a.get("container").all(".ks-waterfall");a.isAdjusting()&&a._adjuster.stop();k.call(a);return a._adjuster=n(d,h,a,function(){a.get("container").height(Math.max.apply(Math,a.get("curColHeights")));a._adjuster=0;b&&b.call(a)})},addItems:function(b,a){var d=this;d._adder=n(b,d._addItem,d,function(){d.get("container").height(Math.max.apply(Math,d.get("curColHeights")));
d._adder=0;a&&a.call(d)});return d._adder},_addItem:function(b){this.get("curColHeights");this.get("container");b=h.call(this,b);var a=this.get("effect");a.effect&&b[a.effect](a.duration,j,a.easing)},destroy:function(){c.Event.remove(window,"resize",this.__onResize)}});c.Waterfall=l},{requires:["template"]});
KISSY.add("waterfall/async",function(c){function j(){j.superclass.constructor.apply(this,arguments)}function l(){if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var f=this.get("container").offset().top,k=this.get("diff"),h=this.get("curColHeights");if(h.length)f+=Math.min.apply(Math,h);k+c.DOM.scrollTop()+c.DOM.viewportHeight()>f&&n.call(this)}}function n(){var f=this;this.get("container");f.__loading=true;var k=f.get("remote");if(c.isFunction(k))k=k();f.fire("loadStart");c.ajax(c.mix({success:function(h){h.end&&
c.Event.remove(window,"scroll",f.__onScroll);f.__loading=false;h=h.data;var p=c.Template(f.get("itemTpl")),b=[];c.each(h,function(a){a=p.render(a);b.push(new c.Node(a))});f.addItems(b)},complete:function(){f.fire("loadEnd")}},k))}j.ATTRS={remote:{},diff:{getter:function(f){return f||0}},itemTpl:{}};c.extend(j,c.Waterfall,{_init:function(){j.superclass._init.apply(this,arguments);this.__onScroll=c.buffer(l,50,this);c.Event.on(window,"scroll",this.__onScroll);l.call(this)},destroy:function(){j.superclass.destroy.apply(this,
arguments);c.Event.remove(window,"scroll",this.__onScroll)}});c.Waterfall.Async=j},{host:"waterfall"});
