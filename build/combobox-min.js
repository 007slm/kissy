/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 15 17:19
*/
KISSY.add("combobox/base",function(f,h,a,e,i,k,m){function c(b,g){var d=b.get("menu");if(d&&d.xclass)if(g)d=a.create(d,b),b.__set("menu",d);else return null;return d}function j(b){if(b.get("multiple")&&b.get("alignWithCursor")){var g=b._getInputDesc(),d=g.tokens,a=b.get("menu"),c=g.cursorPosition,g=g.tokenIndex,b=b.get("input"),d=d.slice(0,g).join("").length;0<d&&++d;b.prop("selectionStart",d);b.prop("selectionEnd",d);d=b.prop("KsCursorOffset");b.prop("selectionStart",c);b.prop("selectionEnd",c);
a.set("xy",[d.left,d.top])}else a=b.get("menu"),c=f.clone(a.get("align")),c.node=b.get("el"),f.mix(c,q,!1),a.set("align",c)}function p(){var b=this.get("input"),g=c(this);g&&g.get("visible")?this.set("collapsed",!0):(b[0].focus(),this.sendRequest(""))}function n(b){b.preventDefault()}var o,l=h.KeyCodes,q={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};return o=a.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("input").on("valuechange",this._onValueChange,this)},
_uiSetHasTrigger:function(b){var g=this.get("trigger");b?(g.on("click",p,this),g.on("mousedown",n)):(g.detach("click",p,this),g.detach("mousedown",n))},sendRequest:function(b){this.get("dataSource").fetchData(b,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var b=this._getValue();b===m?this.set("collapsed",!0):(this._savedInputValue=b,this.sendRequest(b))}},_uiSetCollapsed:function(b){var g=c(this);g&&(b?g.hide():(g.show(),this.get("matchElWidth")&&g.set("width",this.get("el").innerWidth()),
this.get("ariaOwns")||this.set("ariaOwns",g.get("el")[0].id)))},handleBlur:function(){o.superclass.handleBlur.apply(this,arguments);var b=c(this);b&&b._hideForComboBox()},_renderData:function(b){var g,d,a,e=c(this,1);e.removeChildren(!0);if(b&&b.length){b=b.slice(0,this.get("maxItemCount"));d=this.get("format")?this.get("format").call(this,this._getValue(),b):[];for(a=0;a<b.length;a++)g=b[a],e.addChild(f.mix({xclass:"menuitem",content:g,textContent:g,value:g},d[a]));a:{a=this.get("menu");a._clearDismissTimer();
j(this);this.set("collapsed",!1);b=a.get("children");g=this._getValue();for(d=0;d<b.length;d++)if(b[d].get("textContent")==g){a.set("highlightedItem",b[d]);break a}if(this.get("autoHighlightFirst"))for(d=0;d<b.length;d++)if(!b[d].get("disabled")){a.set("highlightedItem",b[d]);break}}}else this.set("collapsed",!0)},_onWindowResize:function(){j(this)},handleKeyEventInternal:function(b){this.get("input");var a=c(this);if(a){var d=this.get("updateInputOnDownUp");d&&(this._stopNotify=f.inArray(b.keyCode,
[l.UP,l.DOWN,l.ESC])?1:0);var e;if(a.get("visible")){var k=a.handleKeydown(b);d&&f.inArray(b.keyCode,[l.DOWN,l.UP])&&this._setValue(a.get("activeItem").get("textContent"));if(b.keyCode==l.ESC)return this.set("collapsed",!0),d&&this._setValue(this._savedInputValue),!0;if(b.keyCode==l.TAB&&(e=a.get("activeItem")))if(e.performActionInternal(),this.get("multiple"))return!0;return k}if(b.keyCode==l.DOWN||b.keyCode==l.UP)return this.sendRequest(this._getValue()),!0}},_uiSetSelectedItem:function(b){if(b){var a=
b.get("textContent");this._setValue(a+this.get("strAppendedOnComplete"));this._savedInputValue=a;this.fire("click",{target:b})}},_getValue:function(){var b=this.get("input").val();if(this.get("multiple")){var a=this._getInputDesc(),b=a.tokens,a=a.tokenIndex,d=this.get("separator");return(b=b[a]||"")&&-1!=d.indexOf(b.charAt(0))?b.substring(1):this.get("queryAtStart")&&(0==a||-1==a)?b:m}return b},_setValue:function(b){var a=this.get("input");if(this.get("multiple")){var d=this._getInputDesc(),c=d.tokens,
d=Math.max(0,d.tokenIndex),e=this.get("separator"),k=this.get("appendSeparatorOnComplete"),i=c[d];c[d]=i&&-1!=e.indexOf(i.charAt(0))?i.charAt(0):"";c[d]+=b;b=c[d+1];if(k&&(!b||-1==e.indexOf(b.charAt(0))))c[d]+=e.charAt(0);b=c.slice(0,d+1).join("").length;a.val(c.join(""));a.prop("selectionStart",b);a.prop("selectionEnd",b)}else a.val(b)},_getInputDesc:function(){for(var b=this.get("input"),a=b.val(),d=[],c=[],e=this.get("literal"),k=this.get("separator"),i=!1,f=this.get("whitespace"),b=b.prop("selectionStart"),
m=-1,j=0;j<a.length;j++){var h=a.charAt(j);j==b&&(m=d.length);if(!i&&(!f&&/\s|\xa0/.test(h)&&(d.push(c.join("")),c=[]),-1!=k.indexOf(h)))d.push(c.join("")),c=[];e&&h==e&&(i=!i);c.push(h)}c.length&&d.push(c.join(""));-1==m&&(m=d.length-1);return{tokens:d,cursorPosition:b,tokenIndex:m}}},{ATTRS:{input:{view:1},trigger:{view:1},hasTrigger:{view:1},menu:{value:{xclass:"combobox-menu"},setter:function(b){b instanceof e&&b.__set("parent",this)}},ariaOwns:{view:1},collapsed:{view:1},dataSource:{setter:function(b){return a.create(b)}},
maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},queryAtStart:{value:!0},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""},xrender:{value:i}}},{xclass:"combobox",priority:10})},{requires:["event","component","./menu","./baseRender","input-selection"]});
KISSY.add("combobox/baseRender",function(f,h){return h.Render.extend({createDom:function(){var a,e;a=this.get("el");var i=this.get("trigger");this.get("srcNode")||(a.append('<div class="ks-combobox-input-wrap"></div>'),a=a.one(".ks-combobox-input-wrap"),e=this.get("input")||f.all('<input aria-haspopup="true" aria-combobox="list" aria-haspopup="true" role="combobox" combobox="off" class="ks-combobox-input" />'),a.append(e),this.__set("input",e));i||this.__set("trigger",f.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable()},_uiSetAriaOwns:function(a){this.get("input").attr("aria-owns",a)},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(a){this.get("input").attr("aria-expanded",a)},_uiSetHasTrigger:function(a){var e=this.get("trigger");a?this.get("el").prepend(e):e.remove()}},{ATTRS:{ariaOwns:{},collapsed:{},hasTrigger:{value:!0},input:{},trigger:{}},HTML_PARSER:{input:function(a){return a.one(".ks-combobox-input")},trigger:function(a){return a.one(".ks-combobox-trigger")}}})},
{requires:["component"]});KISSY.add("combobox",function(f,h,a,e,i){a.Menu=h;a.LocalDataSource=e;a.RemoteDataSource=i;return a},{requires:["combobox/menu","combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/LocalDataSource",function(f,h){function a(){a.superclass.constructor.apply(this,arguments)}a.ATTRS={data:{value:[]},parse:{value:function(a,i){var k=[],m=0;if(!a)return i;f.each(i,function(c){-1!=c.indexOf(a)&&k.push(c);m++});return k}}};f.extend(a,f.Base,{fetchData:function(a,i,k){var f=this.get("parse"),c=this.get("data"),c=f(a,c);i.call(k,c)}});h.Manager.setConstructorByXClass("combobox-LocalDataSource",a);return a},{requires:["component"]});
KISSY.add("combobox/menu",function(f,h,a,e){var i=f.Env.host;return a.PopupMenu.extend({bindUI:function(){var a=this;a.on("click",function(c){var c=c.target,e=a.get("parent");e._stopNotify=1;e.set("selectedItem",c);e.set("collapsed",!0);setTimeout(function(){e._stopNotify=0},50)});var e=f.buffer(function(){this.get("visible")&&this.get("parent")._onWindowResize()},50);a.__reAlign=e;h.on(i,"resize",e,a);var e=a.get("el"),c=a.get("contentEl");e.on("focusin",function(){a._clearDismissTimer()});e.on("focusout",
function(){a._hideForComboBox()});c.on("mouseover",function(){a.get("parent").get("input")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForComboBox:function(){var a=this;a._dismissTimer=setTimeout(function(){a.get("parent").set("collapsed",!0)},30)},destructor:function(){h.remove(i,"resize",this.__reAlign,this)}},{ATTRS:{head:{view:1},foot:{view:1},xrender:{value:e}}},{xclass:"combobox-menu",
priority:40})},{requires:["event","menu","./menuRender"]});KISSY.add("combobox/menuRender",function(f,h){var a=f.all;return h.PopupMenu.Render.extend({createDom:function(){var e=this.get("el"),i=a("<div class='ks-combobox-menu-header'></div>"),f=a("<div class='ks-combobox-menu-footer'></div>");e.prepend(i);e.append(f);this.__set("head",i);this.__set("foot",f)}},{ATTRS:{head:{view:1},foot:{view:1}}})},{requires:["menu"]});
KISSY.add("combobox/RemoteDataSource",function(f,h,a){function e(){e.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}e.ATTRS={paramName:{},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};f.extend(e,f.Base,{fetchData:function(a,e,f){var c=this,j,p=c.get("paramName"),n=c.get("parse"),o=c.get("cache"),l=c.get("allowEmpty");c.io&&(c.io.abort(),c.io=null);if(!a&&!0!==l)return e.call(f,[]);if(o&&(j=c.caches[a]))return e.call(f,j);j=c.get("xhrCfg");j.data=j.data||{};j.data[p]=
a;j.success=function(h){n&&(h=n(a,h));c.__set("data",h);o&&(c.caches[a]=h);e.call(f,h)};c.io=h(j)}});a.Manager.setConstructorByXClass("combobox-RemoteDataSource",e);return e},{requires:["ajax","component"]});
