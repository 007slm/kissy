/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 13 22:52
*/
KISSY.add("combobox/LocalDataSource",function(e,i){function a(c){a.superclass.constructor.apply(this,arguments)}a.ATTRS={data:{value:[]},parse:{value:function(a,h){var f=[],l=0;if(!a)return h;e.each(h,function(g){-1!=g.indexOf(a)&&f.push(g);l++});return f}}};e.extend(a,e.Base,{fetchData:function(a,h,f){var e=this.get("parse"),g=this.get("data"),g=e(a,g);h.call(f,g)}});i.Manager.setConstructorByXClass("combobox-LocalDataSource",a);return a},{requires:["component"]});
KISSY.add("combobox/RemoteDataSource",function(e,i,a){function c(a){c.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}c.ATTRS={paramName:{},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};e.extend(c,e.Base,{fetchData:function(a,f,e){var g=this,c,m=g.get("paramName"),o=g.get("parse"),p=g.get("cache"),j=g.get("allowEmpty");g.io&&(g.io.abort(),g.io=null);if(!a&&!0!==j)return f.call(e,[]);if(p&&(c=g.caches[a]))return f.call(e,c);c=g.get("xhrCfg");c.data=c.data||{};c.data[m]=
a;c.success=function(c){o&&(c=o(a,c));g.__set("data",c);p&&(g.caches[a]=c);f.call(e,c)};g.io=i(c)}});a.Manager.setConstructorByXClass("combobox-RemoteDataSource",c);return c},{requires:["ajax","component"]});
KISSY.add("combobox/base",function(e,i,a,c,h,f,l){function g(b,n){var d=b.get("menu");if(d&&d.xclass)if(n)d=a.create(d,b),b.__set("menu",d);else return null;return d}function q(b){if(b.get("multiple")&&b.get("alignWithCursor")){var n=b._getInputDesc(),d=n.tokens,a=b.get("menu"),c=n.cursorPosition,n=n.tokenIndex,b=b.get("input"),d=d.slice(0,n).join("").length;0<d&&++d;b.prop("selectionStart",d);b.prop("selectionEnd",d);d=b.prop("KsCursorOffset");b.prop("selectionStart",c);b.prop("selectionEnd",c);
a.set("xy",[d.left,d.top])}else a=b.get("menu"),c=b.get("menuCfg")||{},a.set("align",e.merge({node:b.get("el")},r,c.align))}function m(){var b=this.get("input"),a=g(this);a&&a.get("visible")?this.set("collapsed",!0):(b[0].focus(),this.sendRequest(""))}function o(b){b.preventDefault()}var p,j=i.KeyCodes,r={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};return p=a.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("input").on("valuechange",this._onValueChange,this)},
_uiSetHasTrigger:function(b){var a=this.get("trigger");b?(a.on("click",m,this),a.on("mousedown",o)):(a.detach("click",m,this),a.detach("mousedown",o))},sendRequest:function(b){this.get("dataSource").fetchData(b,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var b=this._getValue();b===l?this.set("collapsed",!0):(this._savedInputValue=b,this.sendRequest(b))}},_uiSetCollapsed:function(b){var a=this.get("menuCfg"),d=g(this);d&&(b?d.hide():(d.show(),null==a.width&&d.set("width",
this.get("el").width()),this.get("ariaOwns")||this.set("ariaOwns",d.get("el")[0].id)))},handleBlur:function(){p.superclass.handleBlur.apply(this,arguments);var b=g(this);b&&b._hideForComboBox()},_renderData:function(b){var a,d,k;if(!(a=g(this,1)))this.get("menuCfg"),a=new c(e.mix({prefixCls:this.get("prefixCls")},this.get("menuCfg"))),this.__set("menu",a);var f=a;f.removeChildren(!0);if(b&&b.length){b=b.slice(0,this.get("maxItemCount"));d=this.get("format")?this.get("format").call(this,this._getValue(),
b):[];for(k=0;k<b.length;k++)a=b[k],f.addChild(e.mix({xclass:"menuitem",content:a,textContent:a,value:a},d[k]));a:{k=this.get("menu");k._clearDismissTimer();q(this);this.set("collapsed",!1);b=k.get("children");a=this._getValue();for(d=0;d<b.length;d++)if(b[d].get("textContent")==a){k.set("highlightedItem",b[d]);break a}if(this.get("autoHighlightFirst"))for(d=0;d<b.length;d++)if(!b[d].get("disabled")){k.set("highlightedItem",b[d]);break}}}else this.set("collapsed",!0)},_onWindowResize:function(){q(this)},
handleKeyEventInternal:function(b){this.get("input");var a=g(this);if(a){var d=this.get("updateInputOnDownUp");d&&(this._stopNotify=e.inArray(b.keyCode,[j.UP,j.DOWN,j.ESC])?1:0);var c;if(a.get("visible")){var f=a.handleKeydown(b);d&&e.inArray(b.keyCode,[j.DOWN,j.UP])&&this._setValue(a.get("activeItem").get("textContent"));if(b.keyCode==j.ESC)return this.set("collapsed",!0),d&&this._setValue(this._savedInputValue),!0;if(b.keyCode==j.TAB&&(c=a.get("activeItem")))if(c.performActionInternal(),this.get("multiple"))return!0;
return f}if(b.keyCode==j.DOWN||b.keyCode==j.UP)return this.sendRequest(this._getValue()),!0}},_uiSetSelectedItem:function(b){if(b){var a=b.get("textContent");this._setValue(a+this.get("strAppendedOnComplete"));this._savedInputValue=a;this.fire("click",{target:b})}},_getValue:function(){var b=this.get("input").val();if(this.get("multiple")){var a=this._getInputDesc(),b=a.tokens,a=a.tokenIndex,d=this.get("separator");return(b=b[a]||"")&&-1!=d.indexOf(b.charAt(0))?b.substring(1):this.get("queryAtStart")&&
(0==a||-1==a)?b:l}return b},_setValue:function(a){var c=this.get("input");if(this.get("multiple")){var d=this._getInputDesc(),f=d.tokens,d=Math.max(0,d.tokenIndex),e=this.get("separator"),g=this.get("appendSeparatorOnComplete"),h=f[d];f[d]=h&&-1!=e.indexOf(h.charAt(0))?h.charAt(0):"";f[d]+=a;a=f[d+1];if(g&&(!a||-1==e.indexOf(a.charAt(0))))f[d]+=e.charAt(0);a=f.slice(0,d+1).join("").length;c.val(f.join(""));c.prop("selectionStart",a);c.prop("selectionEnd",a)}else c.val(a)},_getInputDesc:function(){for(var a=
this.get("input"),c=a.val(),d=[],f=[],e=this.get("literal"),g=this.get("separator"),h=!1,i=this.get("whitespace"),a=a.prop("selectionStart"),j=-1,l=0;l<c.length;l++){var m=c.charAt(l);l==a&&(j=d.length);if(!h&&(!i&&/\s|\xa0/.test(m)&&(d.push(f.join("")),f=[]),-1!=g.indexOf(m)))d.push(f.join("")),f=[];e&&m==e&&(h=!h);f.push(m)}f.length&&d.push(f.join(""));-1==j&&(j=d.length-1);return{tokens:d,cursorPosition:a,tokenIndex:j}}},{ATTRS:{input:{view:!0},trigger:{view:!0},hasTrigger:{value:!0,view:!0},menu:{setter:function(a){a instanceof
c&&a.__set("parent",this)}},ariaOwns:{view:!0},collapsed:{view:!0},dataSource:{setter:function(b){return a.create(b)}},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},queryAtStart:{value:!0},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""},xrender:{value:h}}},{xclass:"combobox",priority:10})},{requires:["event",
"component","./menu","./baseRender","input-selection"]});
KISSY.add("combobox/baseRender",function(e,i){return i.Render.extend({createDom:function(){var a,c;a=this.get("el");var h=this.get("trigger");this.get("srcNode")||(a.append('<div class="ks-combobox-input-wrap"></div>'),a=a.one(".ks-combobox-input-wrap"),c=this.get("input")||e.all('<input aria-haspopup="true" aria-combobox="list" aria-haspopup="true" role="combobox" combobox="off" class="ks-combobox-input" />'),a.append(c),this.__set("input",c));h||this.__set("trigger",e.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable()},_uiSetAriaOwns:function(a){this.get("input").attr("aria-owns",a)},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(a){this.get("input").attr("aria-expanded",a)},_uiSetHasTrigger:function(a){var c=this.get("trigger");a?this.get("el").prepend(c):c.remove()}},{ATTRS:{ariaOwns:{},collapsed:{},hasTrigger:{},input:{},trigger:{}},HTML_PARSER:{input:function(a){return a.one(".ks-combobox-input")},trigger:function(a){return a.one(".ks-combobox-trigger")}}})},
{requires:["component"]});KISSY.add("combobox",function(e,i,a,c,h){a.Menu=i;a.LocalDataSource=c;a.RemoteDataSource=h;return a},{requires:["combobox/menu","combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/menu",function(e,i,a,c){var h=e.Env.host;return a.PopupMenu.extend({bindUI:function(){var a=this;a.on("click",function(c){var c=c.target,e=a.get("parent");e._stopNotify=1;e.set("selectedItem",c);e.set("collapsed",!0);setTimeout(function(){e._stopNotify=0},50)});var c=e.buffer(function(){this.get("visible")&&this.get("parent")._onWindowResize()},50);a.__reAlign=c;i.on(h,"resize",c,a);var c=a.get("el"),g=a.get("contentEl");c.on("focusin",function(){a._clearDismissTimer()});c.on("focusout",
function(){a._hideForComboBox()});g.on("mouseover",function(){a.get("parent").get("input")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForComboBox:function(){var a=this;a._dismissTimer=setTimeout(function(){a.get("parent").set("collapsed",!0)},30)},destructor:function(){i.remove(h,"resize",this.__reAlign,this)}},{ATTRS:{head:{view:!0},foot:{view:!0},xrender:{value:c}}},{xclass:"combobox-menu",
priority:40})},{requires:["event","menu","./menuRender"]});KISSY.add("combobox/menuRender",function(e,i){var a=e.all;return i.PopupMenu.Render.extend({createDom:function(){var c=this.get("el"),e=a("<div class='ks-combobox-menu-header'></div>"),f=a("<div class='ks-combobox-menu-footer'></div>");c.prepend(e);c.append(f);this.__set("head",e);this.__set("foot",f)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["menu"]});
