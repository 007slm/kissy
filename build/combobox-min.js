/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 13 00:25
*/
KISSY.add("combobox/LocalDataSource",function(f,h){function a(d){a.superclass.constructor.apply(this,arguments)}a.ATTRS={data:{value:[]},parse:{value:function(a,k){var i=[],l=0;if(!a)return k;f.each(k,function(e){-1!=e.indexOf(a)&&i.push(e);l++});return i}}};f.extend(a,f.Base,{fetchData:function(a,k,i){var f=this.get("parse"),e=this.get("data"),e=f(a,e);k.call(i,e)}});h.Manager.setConstructorByXClass("combobox-LocalDataSource",a);return a},{requires:["component"]});
KISSY.add("combobox/RemoteDataSource",function(f,h,a){function d(a){d.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}d.ATTRS={paramName:{},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};f.extend(d,f.Base,{fetchData:function(a,i,f){var e=this,d,m=e.get("paramName"),j=e.get("parse"),n=e.get("cache"),b=e.get("allowEmpty");e.io&&(e.io.abort(),e.io=null);if(!a&&!0!==b)return i.call(f,[]);if(n&&(d=e.caches[a]))return i.call(f,d);d=e.get("xhrCfg");d.data=d.data||{};d.data[m]=
a;d.success=function(b){j&&(b=j(a,b));e.__set("data",b);n&&(e.caches[a]=b);i.call(f,b)};e.io=h(d)}});a.Manager.setConstructorByXClass("combobox-RemoteDataSource",d);return d},{requires:["ajax","component"]});
KISSY.add("combobox/base",function(f,h,a,d,k,i,l){function e(b,p){var c=b.get("menu");if(c&&c.xclass)if(p)c=a.create(c,b),b.__set("menu",c);else return null;return c}function o(b){if(b.get("multiple")&&b.get("alignWithCursor")){var a=b._getInputDesc(),c=a.tokens,g=b.get("menu"),d=a.cursorPosition,a=a.tokenIndex,b=b.get("input"),c=c.slice(0,a).join("").length;0<c&&++c;b.prop("selectionStart",c);b.prop("selectionEnd",c);c=b.prop("KsCursorOffset");b.prop("selectionStart",d);b.prop("selectionEnd",d);
g.set("xy",[c.left,c.top])}else g=b.get("menu"),d=b.get("menuCfg")||{},g.set("align",f.merge({node:b.get("el")},n,d.align))}var m,j=h.KeyCodes,n={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};return m=a.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){var b=this,a=b.get("trigger"),c=b.get("input");c.on("valuechange",b._onValueChange,b);a.on("click",function(){var a=e(b);a&&a.get("visible")?b.set("collapsed",!0):(c[0].focus(),b.sendRequest(""))});a.on("mousedown",function(b){b.preventDefault()})},
sendRequest:function(b){this.get("dataSource").fetchData(b,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var b=this._getValue();b===l?this.set("collapsed",!0):(this._savedInputValue=b,this.sendRequest(b))}},_uiSetCollapsed:function(b){var a=this.get("menuCfg"),c=e(this);c&&(b?c.hide():(c.show(),null==a.width&&c.set("width",this.get("el").width()),this.get("ariaOwns")||this.set("ariaOwns",c.get("el")[0].id)))},handleBlur:function(){m.superclass.handleBlur.apply(this,arguments);
var b=e(this);b&&b._hideForComboBox()},_renderData:function(b){var a,c,g;if(!(a=e(this,1)))this.get("menuCfg"),a=new d(f.mix({prefixCls:this.get("prefixCls")},this.get("menuCfg"))),this.__set("menu",a);var i=a;i.removeChildren(!0);if(b&&b.length){b=b.slice(0,this.get("maxItemCount"));c=this.get("format")?this.get("format").call(this,this._getValue(),b):[];for(g=0;g<b.length;g++)a=b[g],i.addChild(f.mix({xclass:"menuitem",content:a,textContent:a,value:a},c[g]));a:{g=this.get("menu");g._clearDismissTimer();
o(this);this.set("collapsed",!1);b=g.get("children");a=this._getValue();for(c=0;c<b.length;c++)if(b[c].get("textContent")==a){g.set("highlightedItem",b[c]);break a}if(this.get("autoHighlightFirst"))for(c=0;c<b.length;c++)if(!b[c].get("disabled")){g.set("highlightedItem",b[c]);break}}}else this.set("collapsed",!0)},_onWindowResize:function(){o(this)},handleKeyEventInternal:function(b){this.get("input");var a=e(this);if(a){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=f.inArray(b.keyCode,
[j.UP,j.DOWN,j.ESC])?1:0);var g;if(a.get("visible")){var d=a.handleKeydown(b);c&&f.inArray(b.keyCode,[j.DOWN,j.UP])&&this._setValue(a.get("activeItem").get("textContent"));if(b.keyCode==j.ESC)return this.set("collapsed",!0),c&&this._setValue(this._savedInputValue),!0;if(b.keyCode==j.TAB&&(g=a.get("activeItem")))if(g.performActionInternal(),this.get("multiple"))return!0;return d}if(b.keyCode==j.DOWN||b.keyCode==j.UP)return this.sendRequest(this._getValue()),!0}},_uiSetSelectedItem:function(b){if(b){var a=
b.get("textContent");this._setValue(a+this.get("strAppendedOnComplete"));this._savedInputValue=a;this.fire("click",{target:b})}},_getValue:function(){var b=this.get("input").val();if(this.get("multiple")){var a=this._getInputDesc(),b=a.tokens,a=a.tokenIndex,c=this.get("separator");return(b=b[a]||"")&&-1!=c.indexOf(b.charAt(0))?b.substring(1):this.get("queryAtStart")&&(0==a||-1==a)?b:l}return b},_setValue:function(b){var a=this.get("input");if(this.get("multiple")){var c=this._getInputDesc(),g=c.tokens,
c=Math.max(0,c.tokenIndex),d=this.get("separator"),i=this.get("appendSeparatorOnComplete"),e=g[c];g[c]=e&&-1!=d.indexOf(e.charAt(0))?e.charAt(0):"";g[c]+=b;b=g[c+1];if(i&&(!b||-1==d.indexOf(b.charAt(0))))g[c]+=d.charAt(0);b=g.slice(0,c+1).join("").length;a.val(g.join(""));a.prop("selectionStart",b);a.prop("selectionEnd",b)}else a.val(b)},_getInputDesc:function(){for(var b=this.get("input"),a=b.val(),c=[],d=[],i=this.get("literal"),e=this.get("separator"),f=!1,k=this.get("whitespace"),b=b.prop("selectionStart"),
h=-1,j=0;j<a.length;j++){var l=a.charAt(j);j==b&&(h=c.length);if(!f&&(!k&&/\s|\xa0/.test(l)&&(c.push(d.join("")),d=[]),-1!=e.indexOf(l)))c.push(d.join("")),d=[];i&&l==i&&(f=!f);d.push(l)}d.length&&c.push(d.join(""));-1==h&&(h=c.length-1);return{tokens:c,cursorPosition:b,tokenIndex:h}}},{ATTRS:{input:{view:!0},trigger:{view:!0},hasTrigger:{value:!0,view:!0},menu:{setter:function(b){b instanceof d&&b.__set("parent",this)}},ariaOwns:{view:!0},collapsed:{view:!0},dataSource:{setter:function(b){return a.create(b)}},
maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},queryAtStart:{value:!0},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""},xrender:{value:k}}},{xclass:"combobox",priority:10})},{requires:["event","component","./menu","./baseRender","input-selection"]});
KISSY.add("combobox/baseRender",function(f,h){return h.Render.extend({createDom:function(){var a=this.get("el");if(!this.get("srcNode")){a.append('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div><div class="ks-combobox-input-wrap"></div>');var d=a.one(".ks-combobox-input-wrap"),h=this.get("input")||f.all('<input aria-haspopup="true" aria-combobox="list" aria-haspopup="true" role="combobox" combobox="off" class="ks-combobox-input" />');d.append(h);this.__set("input",
h);this.__set("trigger",a.one(".ks-combobox-trigger"))}this.get("trigger").unselectable()},_uiSetAriaOwns:function(a){this.get("input").attr("aria-owns",a)},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(a){this.get("input").attr("aria-expanded",a)},_uiSetHasTrigger:function(a){this.get("trigger")[a?"show":"hide"]()}},{ATTRS:{ariaOwns:{},collapsed:{},hasTrigger:{},input:{},trigger:{}},HTML_PARSER:{input:function(a){return a.one(".ks-combobox-input")},trigger:function(a){return a.one(".ks-combobox-trigger")}}})},
{requires:["component"]});KISSY.add("combobox",function(f,h,a,d,k){a.Menu=h;a.LocalDataSource=d;a.RemoteDataSource=k;return a},{requires:["combobox/menu","combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/menu",function(f,h,a,d){var k=f.Env.host;return a.PopupMenu.extend({bindUI:function(){var a=this;a.on("click",function(d){var d=d.target,e=a.get("parent");e._stopNotify=1;e.set("selectedItem",d);e.set("collapsed",!0);setTimeout(function(){e._stopNotify=0},50)});var d=f.buffer(function(){this.get("visible")&&this.get("parent")._onWindowResize()},50);a.__reAlign=d;h.on(k,"resize",d,a);var d=a.get("el"),e=a.get("contentEl");d.on("focusin",function(){a._clearDismissTimer()});d.on("focusout",
function(){a._hideForComboBox()});e.on("mouseover",function(){a.get("parent").get("input")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForComboBox:function(){var a=this;a._dismissTimer=setTimeout(function(){a.get("parent").set("collapsed",!0)},30)},destructor:function(){h.remove(k,"resize",this.__reAlign,this)}},{ATTRS:{head:{view:!0},foot:{view:!0},xrender:{value:d}}},{xclass:"combobox-menu",
priority:40})},{requires:["event","menu","./menuRender"]});KISSY.add("combobox/menuRender",function(f,h){var a=f.all;return h.PopupMenu.Render.extend({createDom:function(){var d=this.get("el"),f=a("<div class='ks-combobox-menu-header'></div>"),h=a("<div class='ks-combobox-menu-footer'></div>");d.prepend(f);d.append(h);this.__set("head",f);this.__set("foot",h)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["menu"]});
