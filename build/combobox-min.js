/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Dec 18 20:39
*/
KISSY.add("combobox/base",function(e,h,k,m,c,l,f){function j(a,g){if(g){var d=g.get("textContent"),i=a.get("separatorType");r(a,d+(i==s?"":" "));a._savedInputValue=d}}function b(a,g){var d=a.get("el"),i=a.get("prefixCls")+"combobox-invalid",n=a.get("invalidEl");g?(d.addClass(i),n.attr("title",g),n.show()):(d.removeClass(i),n.hide())}function p(a,g){var d=a.get("menu");if(d&&!d.isController)if(g)d=m.create(d,a),a.setInternal("menu",d);else return null;return d}function t(){var a=p(this);if(a&&a.get("visible"))if(this.get("multiple")&&
this.get("alignWithCursor")){var g=w(this),d=g.tokens,a=this.get("menu"),i=g.cursorPosition,n=g.tokenIndex,g=this.get("input"),d=d.slice(0,n).join("").length;0<d&&++d;g.prop("selectionStart",d);g.prop("selectionEnd",d);d=h(g);g.prop("selectionStart",i);g.prop("selectionEnd",i);a.set("xy",[d.left,d.top])}else a=this.get("menu"),i=e.clone(a.get("align")),i.node=this.get("el"),e.mix(i,z,!1),a.set("align",i)}function u(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",!0)},
30)}function o(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function r(a,g){var d=a.get("input");if(a.get("multiple")){var i=w(a),n=i.tokens,i=Math.max(0,i.tokenIndex),b=a.get("separator"),f=a.get("separatorType"),c=n[i];n[i]=c&&-1!=b.indexOf(c.charAt(0))?c.charAt(0):"";n[i]+=g;c=n[i+1];if(f==s&&(!c||-1==b.indexOf(c.charAt(0))))n[i]+=b.charAt(0);i=n.slice(0,i+1).join("").length;d.val(n.join(""));d.prop("selectionStart",i);d.prop("selectionEnd",i)}else d.val(g)}
function v(a){var g=a.get("input").val();if(a.get("multiple")){var d=w(a),g=d.tokens,d=d.tokenIndex,i=a.get("separator"),a=a.get("separatorType");return(g=g[d]||"")&&-1!=i.indexOf(g.charAt(0))?g.substring(1):a==s&&(0==d||-1==d)?g:f}return g}function A(){if(!this._stopNotify){var a=v(this);a===f?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function B(a){var g,d=[],i,b,c=p(this,1),a=this.normalizeData(a);c.removeChildren(!0);if(a&&a.length){for(b=0;b<a.length;b++)g=a[b],d.push(c.addChild(g));
a=v(this);for(b=0;b<d.length;b++)if(d[b].get("textContent")==a){c.set("highlightedItem",d[b]);i=!0;break}if(!i&&this.get("autoHighlightFirst"))for(b=0;b<d.length;b++)if(!d[b].get("disabled")){c.set("highlightedItem",d[b]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function w(a){for(var g=a.get("input"),d=g.val(),b=[],c=[],f=a.get("literal"),h=a.get("separator"),p=!1,a=a.get("whitespace"),g=g.prop("selectionStart"),e=-1,j=0;j<d.length;j++){var l=d.charAt(j);j==g&&(e=b.length);if(!p&&
(!a&&/\s|\xa0/.test(l)&&(b.push(c.join("")),c=[]),-1!=h.indexOf(l)))b.push(c.join("")),c=[];f&&l==f&&(p=!p);c.push(l)}c.length&&b.push(c.join(""));-1==e&&(e=b.length-1);return{tokens:b,cursorPosition:g,tokenIndex:e}}var x,l=k.all,q=k.KeyCodes,z={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},y=l(e.Env.host),s="suffix";return x=m.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(a){var g,d,b;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));g=this.get("format")?
this.get("format").call(this,v(this),a):[];for(b=0;b<a.length;b++)d=a[b],g[b]=e.mix({content:d,textContent:d,value:d},g[b])}return g},bindUI:function(){this.get("input").on("valuechange",A,this)},handleFocus:function(){var a;b(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this;x.superclass.handleBlur.apply(a,arguments);u.call(a);var g,d=a.get("input");a.validate(function(g,c){g?!a.get("focused")&&c==d.val()&&b(a,g):b(a,!1)});(g=a.get("placeholderEl"))&&!d.val()&&g.show()},
handleMouseDown:function(a){x.superclass.handleMouseDown.apply(this,arguments);var g;g=a.target;var b=this.get("trigger");if(this.get("hasTrigger")&&(b[0]==g||b.contains(g)))g=this.get("input"),this.get("collapsed")?(g[0].focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){this.get("input");var b=p(this);if(b){var d=this.get("updateInputOnDownUp");d&&(this._stopNotify=e.inArray(a.keyCode,[q.UP,q.DOWN,q.ESC])?1:0);var c;if(b.get("visible")){var f=
b.handleKeydown(a);d&&e.inArray(a.keyCode,[q.DOWN,q.UP])&&r(this,b.get("activeItem").get("textContent"));if(a.keyCode==q.ESC)return this.set("collapsed",!0),d&&r(this,this._savedInputValue),!0;if(a.keyCode==q.TAB&&(c=b.get("activeItem")))if(c.performActionInternal(),this.get("multiple"))return!0;return f}if(a.keyCode==q.DOWN||a.keyCode==q.UP)return this.sendRequest(v(this)),!0}},syncUI:function(){if(this.get("placeholder")){var a=this.get("input"),b=this.get("inputValue");b!=f&&a.val(b);a.val()||
this.get("placeholderEl").show()}},validate:function(a){var b=this.get("validator"),d=this.get("input").val();b?b(d,function(b){a(b,d)}):a(!1,d)},bindMenu:function(){var a=this,b,d;d=a.get("menu");d.on("click",function(b){b=b.target;a._stopNotify=1;j(a,b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});a.__repositionBuffer=e.buffer(t,50);y.on("resize",a.__repositionBuffer,a);b=d.get("el");d=d.get("contentEl");b.on("focusout",u,a);b.on("focusin",o,a);d.on("mouseover",function(){a.get("input")[0].focus();
o.call(a)});a.bindMenu=e.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,B,this)},_onSetCollapsed:function(a){if(a)(a=p(this))&&a.hide();else{var a=this.get("el"),b=p(this,1);o.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),t.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},destructor:function(){y.detach("resize",this.__repositionBuffer,this);this.__repositionBuffer.stop()}},{ATTRS:{input:{view:1},
trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildXClass:{value:"popupmenu"},collapsed:{view:1},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:s},whitespace:{valueFn:function(){return this.get("separatorType")==s}},updateInputOnDownUp:{value:!0},
literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:c}}},{xclass:"combobox",priority:10})},{requires:["./cursor","node","component/base","./render","menu"]});KISSY.add("combobox",function(e,h,k,m,c){h.LocalDataSource=m;h.RemoteDataSource=c;h.FilterSelect=k;return h},{requires:["combobox/base","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(e,h){function k(b){var f=c,j;f||(f=h.create(m));"textarea"==b.type?h.css(f,"width",h.css(b,"width")):h.css(f,"width",9999);e.each(l,function(c){h.css(f,c,h.css(b,c))});c||(j=b.ownerDocument.body,j.insertBefore(f,j.firstChild));return c=f}var m="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",c,l="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(","),
f,j;j=function(){var b=document,c=h.create("<input>");h.css(c,{width:1,position:"absolute",left:-9999,top:-9999});c.value="123456789";b.body.appendChild(c);c.focus();f=!!(0<c.scrollLeft);h.remove(c);j=e.noop};return function(b){var c=b.ownerDocument,l=b.scrollTop,m=b.scrollLeft;if(c.selection)return c=c.selection.createRange(),{left:c.boundingLeft+m+h.scrollLeft(),top:c.boundingTop+l+c.boundingHeight+h.scrollTop()};j();var o=h.offset(b);if(!f&&"textarea"!=b.type)return o.top+=b.offsetHeight,o;var r=
k(b),c=b.selectionStart;r.innerHTML=e.escapeHTML(b.value.substring(0,c-1))+"<span>x</span>";h.offset(r,o);o=r.lastChild;b=h.offset(o);b.top+=h.height(o);0<c&&(b.left+=h.width(o));b.top-=l;b.left-=m;return b}},{requires:["dom"]});
KISSY.add("combobox/filter-select",function(e,h){var k=h.extend({validate:function(h){var c=this;k.superclass.validate.call(c,function(e,f){e?h(e,f):c.get("dataSource").fetchData(f,function(e){a:{if(e=c.normalizeData(e))for(var b=0;b<e.length;b++)if(e[b].textContent==f){e=e[b];break a}e=!1}h(e?"":c.get("invalidMessage"),f,e)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return k},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(e){function h(){h.superclass.constructor.apply(this,arguments)}h.ATTRS={data:{value:[]},parse:{value:function(h,m){var c=[],l=0;if(!h)return m;e.each(m,function(f){-1!=f.indexOf(h)&&c.push(f);l++});return c}}};e.extend(h,e.Base,{fetchData:function(e,h,c){var l=this.get("parse"),f=this.get("data"),f=l(e,f);h.call(c,f)}});return h},{requires:["component/base"]});
KISSY.add("combobox/RemoteDataSource",function(e,h){function k(){k.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}k.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};e.extend(k,e.Base,{fetchData:function(e,c,l){var f=this,j,b=f.get("paramName"),k=f.get("parse"),t=f.get("cache"),u=f.get("allowEmpty");f.io&&(f.io.abort(),f.io=null);if(!e&&!0!==u)return c.call(l,[]);if(t&&(j=f.caches[e]))return c.call(l,j);j=f.get("xhrCfg");j.data=j.data||{};j.data[b]=
e;j.success=function(b){k&&(b=k(e,b));f.setInternal("data",b);t&&(f.caches[e]=b);c.call(l,b)};f.io=h(j)}});return k},{requires:["ajax"]});
KISSY.add("combobox/render",function(e,h){var k=e.all,m=h.Render.extend({createDom:function(){var c,h=this.get("input"),f=this.get("prefixCls"),j=this.get("el"),b=this.get("trigger");this.get("srcNode")||(j.append(e.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:f})),c=j.one("."+f+"combobox-input-wrap"),h=h||e.all(e.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',{prefixCls:f})),
c.append(h),this.setInternal("input",h));b||this.setInternal("trigger",e.all(e.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:f})));this.get("trigger").unselectable();this.setInternal("invalidEl",k("<div class='"+f+"combobox-invalid-el'><div class='"+f+"combobox-invalid-inner'></div></div>").insertBefore(h.parent()));if(b=this.get("placeholder")){if(!(c=h.attr("id")))h.attr("id",c=e.guid("ks-combobox-input"));this.setInternal("placeholderEl",
k('<label for="'+c+'" class="'+f+'combobox-placeholder">'+b+"</label>").appendTo(j))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var e=this.get("trigger");c?this.get("el").prepend(e):e.remove()},_onSetDisabled:function(c){m.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},input:{},trigger:{},placeholder:{},
placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return m},{requires:["component/base"]});
