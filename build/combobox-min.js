/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 20 23:34
*/
KISSY.add("combobox/base",function(g,k,i,h,f,l,t){function j(a,b){var c=a.get("menu");if(c&&c.xclass)if(b)c=i.create(c,a),a.__set("menu",c);else return null;return c}function q(){var a=j(this);if(a&&a.get("visible"))if(this.get("multiple")&&this.get("alignWithCursor")){var b=u(this),c=b.tokens,a=this.get("menu"),d=b.cursorPosition,e=b.tokenIndex,b=this.get("input"),c=c.slice(0,e).join("").length;0<c&&++c;b.prop("selectionStart",c);b.prop("selectionEnd",c);c=b.prop("KsCursorOffset");b.prop("selectionStart",
d);b.prop("selectionEnd",d);a.set("xy",[c.left,c.top])}else a=this.get("menu"),d=g.clone(a.get("align")),d.node=this.get("el"),g.mix(d,B,!1),a.set("align",d)}function s(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",!0)},30)}function n(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function o(a,b){var c=a.get("input");if(a.get("multiple")){var d=u(a),e=d.tokens,d=Math.max(0,d.tokenIndex),f=a.get("separator"),j=a.get("separatorType"),
g=e[d];e[d]=g&&-1!=f.indexOf(g.charAt(0))?g.charAt(0):"";e[d]+=b;g=e[d+1];if(j==r&&(!g||-1==f.indexOf(g.charAt(0))))e[d]+=f.charAt(0);d=e.slice(0,d+1).join("").length;c.val(e.join(""));c.prop("selectionStart",d);c.prop("selectionEnd",d)}else c.val(b)}function p(a){var b=a.get("input").val();if(a.get("multiple")){var c=u(a),b=c.tokens,c=c.tokenIndex,d=a.get("separator"),a=a.get("separatorType");return(b=b[c]||"")&&-1!=d.indexOf(b.charAt(0))?b.substring(1):a==r&&(0==c||-1==c)?b:t}return b}function C(){if(!this._stopNotify){var a=
p(this);a===t?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function v(a,b){var c,d,e;if(a&&a.length){a=a.slice(0,b.get("maxItemCount"));c=b.get("format")?b.get("format").call(b,p(b),a):[];for(e=0;e<a.length;e++)d=a[e],c[e]=g.mix({content:d,textContent:d,value:d},c[e])}return c}function D(a){var b,c=[],d,e,f=j(this,1),a=v(a,this);f.removeChildren(!0);if(a&&a.length){for(e=0;e<a.length;e++)b=a[e],c.push(f.addChild(g.mix({xclass:"menuitem"},b)));a=p(this);for(e=0;e<c.length;e++)if(c[e].get("textContent")==
a){f.set("highlightedItem",c[e]);d=!0;break}if(!d&&this.get("autoHighlightFirst"))for(e=0;e<c.length;e++)if(!c[e].get("disabled")){f.set("highlightedItem",c[e]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function w(){if(!this.get("disabled")){var a=this.get("input");this.get("collapsed")?(a[0].focus(),this.sendRequest("")):this.set("collapsed",!0)}}function x(a){a.preventDefault()}function u(a){for(var b=a.get("input"),c=b.val(),d=[],e=[],f=a.get("literal"),j=a.get("separator"),
g=!1,a=a.get("whitespace"),b=b.prop("selectionStart"),l=-1,i=0;i<c.length;i++){var h=c.charAt(i);i==b&&(l=d.length);if(!g&&(!a&&/\s|\xa0/.test(h)&&(d.push(e.join("")),e=[]),-1!=j.indexOf(h)))d.push(e.join("")),e=[];f&&h==f&&(g=!g);e.push(h)}e.length&&d.push(e.join(""));-1==l&&(l=d.length-1);return{tokens:d,cursorPosition:b,tokenIndex:l}}var y,f=k.all,m=k.KeyCodes,B={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},z=f(g.Env.host),r="suffix",A=g.buffer(q,50);return y=i.Controller.extend({_savedInputValue:null,
_stopNotify:0,bindUI:function(){var a=this,b,c=a.get("input");c.on("valuechange",C,a);a.get("invalidEl")&&(c.on("blur",function(){a.get("disabled")||a.checkValid(function(b,e){e==c.val()&&c[0].ownerDocument.activeElement!=c[0]&&a._setInvalid(!b)})}),c.on("focus",function(){a.get("disabled")||a._setInvalid(!1)}));if(b=a.get("placeholderEl"))c.on("focus",function(){a.get("disabled")||b.hide()}),c.on("blur",function(){a.get("disabled")||c.val()||b.show()})},syncUI:function(){if(this.get("placeholder")){var a=
this.get("input"),b=this.get("inputValue");b!=t&&a.val(b);a.val()||this.get("placeholderEl").show()}},checkValid:function(a){var b=this,c=b.get("input").val();b.get("dataSource").fetchData(c,function(d){a:{if(d=v(d,b))for(var e=0;e<d.length;e++)if(d[e].textContent==c){d=d[e];break a}d=!1}a(d,c)})},bindMenu:function(){var a=this,b,c;c=a.get("menu");c.on("click",function(b){b=b.target;a._stopNotify=1;a._selectItem(b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});z.on("resize",A,
a);b=c.get("el");c=c.get("contentEl");b.on("focusout",s,a);b.on("focusin",n,a);c.on("mouseover",function(){a.get("input")[0].focus();n.call(a)});a.bindMenu=g.noop},_uiSetHasTrigger:function(a){var b=this.get("trigger");a?(b.on("click",w,this),b.on("mousedown",x)):(b.detach("click",w,this),b.detach("mousedown",x))},_setInvalid:function(a){var b=this.get("el"),c=this.get("prefixCls")+"combobox-invalid",d=this.get("invalidEl");a?(b.addClass(c),d.show()):(b.removeClass(c),d.hide())},sendRequest:function(a){this.get("dataSource").fetchData(a,
D,this)},_uiSetCollapsed:function(a){if(a)(a=j(this))&&a.hide();else{var a=this.get("el"),b=j(this,1);n.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),q.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},handleBlur:function(){y.superclass.handleBlur.apply(this,arguments);s.call(this)},handleKeyEventInternal:function(a){this.get("input");var b=j(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=
g.inArray(a.keyCode,[m.UP,m.DOWN,m.ESC])?1:0);var d;if(b.get("visible")){var e=b.handleKeydown(a);c&&g.inArray(a.keyCode,[m.DOWN,m.UP])&&o(this,b.get("activeItem").get("textContent"));if(a.keyCode==m.ESC)return this.set("collapsed",!0),c&&o(this,this._savedInputValue),!0;if(a.keyCode==m.TAB&&(d=b.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return e}if(a.keyCode==m.DOWN||a.keyCode==m.UP)return this.sendRequest(p(this)),!0}},_selectItem:function(a){if(a){var a=a.get("textContent"),
b=this.get("separatorType");o(this,a+(b==r?"":" "));this._savedInputValue=a}},getInputValue:function(){return this.get("input").val()},destructor:function(){z.detach("resize",A,this)}},{ATTRS:{input:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},invalidMessage:{view:1},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{xclass:"popupmenu"},setter:function(a){a instanceof i.Controller&&a.__set("parent",this)}},collapsed:{view:1},dataSource:{setter:function(a){return i.create(a)}},
maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:r},whitespace:{valueFn:function(){return this.get("separatorType")==r}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:h}}},{xclass:"combobox",priority:10})},{requires:["node","component","./baseRender","input-selection","menu"]});
KISSY.add("combobox/baseRender",function(g,k){var i=g.all,h=k.Render.extend({createDom:function(){var f,l=this.get("input"),h=this.get("el"),j=this.get("trigger");this.get("srcNode")||(h.append('<div class="ks-combobox-input-wrap"></div>'),f=h.one(".ks-combobox-input-wrap"),l=l||g.all('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="ks-combobox-input" />'),f.append(l),this.__set("input",l));j||this.__set("trigger",g.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable();var q;(q=this.get("invalidMessage"))&&this.__set("invalidEl",i("<div title='"+q+"' class='ks-combobox-invalid-el'><div class='ks-combobox-invalid-inner'></div></div>").insertBefore(l.parent()));if(j=this.get("placeholder")){if(!(f=l.attr("id")))l.attr("id",f=g.guid("ks-combobox-input"));this.__set("placeholderEl",i('<label for="'+f+'" class="ks-combobox-placeholder">'+j+"</label>").appendTo(h))}},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(f){this.get("input").attr("aria-expanded",
f)},_uiSetHasTrigger:function(f){var g=this.get("trigger");f?this.get("el").prepend(g):g.remove()},_uiSetDisabled:function(f){h.superclass._uiSetDisabled.apply(this,arguments);this.get("input").attr("disabled",f)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},input:{},trigger:{},placeholder:{},placeholderEl:{},invalidMessage:{},invalidEl:{}},HTML_PARSER:{input:function(f){return f.one(".ks-combobox-input")},trigger:function(f){return f.one(".ks-combobox-trigger")}}});return h},{requires:["component"]});
KISSY.add("combobox",function(g,k,i,h){k.LocalDataSource=i;k.RemoteDataSource=h;return k},{requires:["combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/LocalDataSource",function(g,k){function i(){i.superclass.constructor.apply(this,arguments)}i.ATTRS={data:{value:[]},parse:{value:function(h,f){var i=[],k=0;if(!h)return f;g.each(f,function(f){-1!=f.indexOf(h)&&i.push(f);k++});return i}}};g.extend(i,g.Base,{fetchData:function(g,f,i){var k=this.get("parse"),j=this.get("data"),j=k(g,j);f.call(i,j)}});k.Manager.setConstructorByXClass("combobox-LocalDataSource",i);return i},{requires:["component"]});
KISSY.add("combobox/RemoteDataSource",function(g,k,i){function h(){h.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}h.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};g.extend(h,g.Base,{fetchData:function(f,g,i){var j=this,h,s=j.get("paramName"),n=j.get("parse"),o=j.get("cache"),p=j.get("allowEmpty");j.io&&(j.io.abort(),j.io=null);if(!f&&!0!==p)return g.call(i,[]);if(o&&(h=j.caches[f]))return g.call(i,h);h=j.get("xhrCfg");h.data=h.data||{};
h.data[s]=f;h.success=function(h){n&&(h=n(f,h));j.__set("data",h);o&&(j.caches[f]=h);g.call(i,h)};j.io=k(h)}});i.Manager.setConstructorByXClass("combobox-RemoteDataSource",h);return h},{requires:["ajax","component"]});
