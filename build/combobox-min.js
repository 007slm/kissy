/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Dec 6 01:07
*/
KISSY.add("combobox/base",function(g,e,l,k,c,m,i){function d(a,h){if(h){var f=h.get("textContent"),j=a.get("separatorType");q(a,f+(j==r?"":" "));a._savedInputValue=f}}function b(a,h){var f=a.get("el"),j=a.get("prefixCls")+"combobox-invalid",b=a.get("invalidEl");h?(f.addClass(j),b.attr("title",h),b.show()):(f.removeClass(j),b.hide())}function n(a,h){var f=a.get("menu");if(f&&f.xclass)if(h)f=k.create(f,a),a.setInternal("menu",f);else return null;return f}function w(){var a=n(this);if(a&&a.get("visible"))if(this.get("multiple")&&
this.get("alignWithCursor")){var h=u(this),f=h.tokens,a=this.get("menu"),j=h.cursorPosition,b=h.tokenIndex,h=this.get("input"),f=f.slice(0,b).join("").length;0<f&&++f;h.prop("selectionStart",f);h.prop("selectionEnd",f);f=e(h);h.prop("selectionStart",j);h.prop("selectionEnd",j);a.set("xy",[f.left,f.top])}else a=this.get("menu"),j=g.clone(a.get("align")),j.node=this.get("el"),g.mix(j,y,!1),a.set("align",j)}function s(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",!0)},
30)}function o(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function q(a,h){var f=a.get("input");if(a.get("multiple")){var j=u(a),b=j.tokens,j=Math.max(0,j.tokenIndex),c=a.get("separator"),d=a.get("separatorType"),n=b[j];b[j]=n&&-1!=c.indexOf(n.charAt(0))?n.charAt(0):"";b[j]+=h;n=b[j+1];if(d==r&&(!n||-1==c.indexOf(n.charAt(0))))b[j]+=c.charAt(0);j=b.slice(0,j+1).join("").length;f.val(b.join(""));f.prop("selectionStart",j);f.prop("selectionEnd",j)}else f.val(h)}
function t(a){var h=a.get("input").val();if(a.get("multiple")){var f=u(a),h=f.tokens,f=f.tokenIndex,b=a.get("separator"),a=a.get("separatorType");return(h=h[f]||"")&&-1!=b.indexOf(h.charAt(0))?h.substring(1):a==r&&(0==f||-1==f)?h:i}return h}function z(){if(!this._stopNotify){var a=t(this);a===i?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function A(a){var h,f=[],b,c,d=n(this,1),a=this.normalizeData(a);d.removeChildren(!0);if(a&&a.length){for(c=0;c<a.length;c++)h=a[c],f.push(d.addChild(g.mix({xclass:"menuitem"},
h)));a=t(this);for(c=0;c<f.length;c++)if(f[c].get("textContent")==a){d.set("highlightedItem",f[c]);b=!0;break}if(!b&&this.get("autoHighlightFirst"))for(c=0;c<f.length;c++)if(!f[c].get("disabled")){d.set("highlightedItem",f[c]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function u(a){for(var h=a.get("input"),f=h.val(),b=[],c=[],d=a.get("literal"),n=a.get("separator"),e=!1,a=a.get("whitespace"),h=h.prop("selectionStart"),g=-1,m=0;m<f.length;m++){var i=f.charAt(m);m==h&&(g=b.length);
if(!e&&(!a&&/\s|\xa0/.test(i)&&(b.push(c.join("")),c=[]),-1!=n.indexOf(i)))b.push(c.join("")),c=[];d&&i==d&&(e=!e);c.push(i)}c.length&&b.push(c.join(""));-1==g&&(g=b.length-1);return{tokens:b,cursorPosition:h,tokenIndex:g}}var v,m=l.all,p=l.KeyCodes,y={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},x=m(g.Env.host),r="suffix";return v=k.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(a){var b,f,c;if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?
this.get("format").call(this,t(this),a):[];for(c=0;c<a.length;c++)f=a[c],b[c]=g.mix({content:f,textContent:f,value:f},b[c])}return b},bindUI:function(){this.get("input").on("valuechange",z,this)},handleFocus:function(){var a;b(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this;v.superclass.handleBlur.apply(a,arguments);s.call(a);var c,f=a.get("input");a.validate(function(c,h){c?!a.get("focused")&&h==f.val()&&b(a,c):b(a,!1)});(c=a.get("placeholderEl"))&&!f.val()&&c.show()},
handleMouseDown:function(a){v.superclass.handleMouseDown.apply(this,arguments);var b;b=a.target;var c=this.get("trigger");if(this.get("hasTrigger")&&(c[0]==b||c.contains(b)))b=this.get("input"),this.get("collapsed")?(b[0].focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){this.get("input");var b=n(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=g.inArray(a.keyCode,[p.UP,p.DOWN,p.ESC])?1:0);var d;if(b.get("visible")){var e=
b.handleKeydown(a);c&&g.inArray(a.keyCode,[p.DOWN,p.UP])&&q(this,b.get("activeItem").get("textContent"));if(a.keyCode==p.ESC)return this.set("collapsed",!0),c&&q(this,this._savedInputValue),!0;if(a.keyCode==p.TAB&&(d=b.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return e}if(a.keyCode==p.DOWN||a.keyCode==p.UP)return this.sendRequest(t(this)),!0}},syncUI:function(){if(this.get("placeholder")){var a=this.get("input"),b=this.get("inputValue");b!=i&&a.val(b);a.val()||
this.get("placeholderEl").show()}},validate:function(a){var b=this.get("validator"),c=this.get("input").val();b?b(c,function(b){a(b,c)}):a(!1,c)},bindMenu:function(){var a=this,b,c;c=a.get("menu");c.on("click",function(b){b=b.target;a._stopNotify=1;d(a,b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});a.__repositionBuffer=g.buffer(w,50);x.on("resize",a.__repositionBuffer,a);b=c.get("el");c=c.get("contentEl");b.on("focusout",s,a);b.on("focusin",o,a);c.on("mouseover",function(){a.get("input")[0].focus();
o.call(a)});a.bindMenu=g.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,A,this)},_onSetCollapsed:function(a){if(a)(a=n(this))&&a.hide();else{var a=this.get("el"),b=n(this,1);o.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),w.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},destructor:function(){x.detach("resize",this.__repositionBuffer,this);this.__repositionBuffer.stop()}},{ATTRS:{input:{view:1},
trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{xclass:"popupmenu"},setter:function(a){a instanceof k.Controller&&a.setInternal("parent",this)}},collapsed:{view:1},dataSource:{setter:function(a){return k.create(a)}},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:r},whitespace:{valueFn:function(){return this.get("separatorType")==
r}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:c}}},{xclass:"combobox",priority:10})},{requires:["./cursor","node","component/base","./render","menu"]});KISSY.add("combobox",function(g,e,l,k,c){e.LocalDataSource=k;e.RemoteDataSource=c;e.FilterSelect=l;return e},{requires:["combobox/base","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(g,e){function l(b){var d=c,i;d||(d=e.create(k));"textarea"==b.type?e.css(d,"width",e.css(b,"width")):e.css(d,"width",9999);g.each(m,function(c){e.css(d,c,e.css(b,c))});c||(i=b.ownerDocument.body,i.insertBefore(d,i.firstChild));return c=d}var k="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",c,m="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(","),
i,d;d=function(){var b=document,c=e.create("<input>");e.css(c,{width:1,position:"absolute",left:-9999,top:-9999});c.value="123456789";b.body.appendChild(c);c.focus();i=!!(0<c.scrollLeft);e.remove(c);d=g.noop};return function(b){var c=b.ownerDocument,m=b.scrollTop,k=b.scrollLeft;if(c.selection)return c=c.selection.createRange(),{left:c.boundingLeft+k+e.scrollLeft(),top:c.boundingTop+m+c.boundingHeight+e.scrollTop()};d();var o=e.offset(b);if(!i&&"textarea"!=b.type)return o.top+=b.offsetHeight,o;var q=
l(b),c=b.selectionStart;q.innerHTML=g.escapeHTML(b.value.substring(0,c-1))+"<span>x</span>";e.offset(q,o);o=q.lastChild;b=e.offset(o);b.top+=e.height(o);0<c&&(b.left+=e.width(o));b.top-=m;b.left-=k;return b}},{requires:["dom"]});
KISSY.add("combobox/filter-select",function(g,e){var l=e.extend({validate:function(e){var c=this;l.superclass.validate.call(c,function(g,i){g?e(g,i):c.get("dataSource").fetchData(i,function(d){a:{if(d=c.normalizeData(d))for(var b=0;b<d.length;b++)if(d[b].textContent==i){d=d[b];break a}d=!1}e(d?"":c.get("invalidMessage"),i,d)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return l},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(g,e){function l(){l.superclass.constructor.apply(this,arguments)}l.ATTRS={data:{value:[]},parse:{value:function(e,c){var m=[],i=0;if(!e)return c;g.each(c,function(c){-1!=c.indexOf(e)&&m.push(c);i++});return m}}};g.extend(l,g.Base,{fetchData:function(e,c,g){var i=this.get("parse"),d=this.get("data"),d=i(e,d);c.call(g,d)}});e.Manager.setConstructorByXClass("combobox-LocalDataSource",l);return l},{requires:["component/base"]});
KISSY.add("combobox/RemoteDataSource",function(g,e,l){function k(){k.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}k.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};g.extend(k,g.Base,{fetchData:function(c,g,i){var d=this,b,l=d.get("paramName"),k=d.get("parse"),s=d.get("cache"),o=d.get("allowEmpty");d.io&&(d.io.abort(),d.io=null);if(!c&&!0!==o)return g.call(i,[]);if(s&&(b=d.caches[c]))return g.call(i,b);b=d.get("xhrCfg");b.data=b.data||{};
b.data[l]=c;b.success=function(b){k&&(b=k(c,b));d.setInternal("data",b);s&&(d.caches[c]=b);g.call(i,b)};d.io=e(b)}});l.Manager.setConstructorByXClass("combobox-RemoteDataSource",k);return k},{requires:["ajax","component/base"]});
KISSY.add("combobox/render",function(g,e){var l=g.all,k=e.Render.extend({createDom:function(){var c,e=this.get("input"),i=this.get("prefixCls"),d=this.get("el"),b=this.get("trigger");this.get("srcNode")||(d.append(g.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:i})),c=d.one("."+i+"combobox-input-wrap"),e=e||g.all(g.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',
{prefixCls:i})),c.append(e),this.setInternal("input",e));b||this.setInternal("trigger",g.all(g.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:i})));this.get("trigger").unselectable();this.setInternal("invalidEl",l("<div class='"+i+"combobox-invalid-el'><div class='"+i+"combobox-invalid-inner'></div></div>").insertBefore(e.parent()));if(b=this.get("placeholder")){if(!(c=e.attr("id")))e.attr("id",c=g.guid("ks-combobox-input"));
this.setInternal("placeholderEl",l('<label for="'+c+'" class="'+i+'combobox-placeholder">'+b+"</label>").appendTo(d))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var e=this.get("trigger");c?this.get("el").prepend(e):e.remove()},_onSetDisabled:function(c){k.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return k},{requires:["component/base"]});
