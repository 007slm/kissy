/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 20 23:52
*/
KISSY.add("combobox/base",function(h,k,i,g,f,m,n){function j(a,b){var c=a.get("menu");if(c&&c.xclass)if(b)c=i.create(c,a),a.__set("menu",c);else return null;return c}function r(){var a=j(this);if(a&&a.get("visible"))if(this.get("multiple")&&this.get("alignWithCursor")){var b=u(this),c=b.tokens,a=this.get("menu"),d=b.cursorPosition,e=b.tokenIndex,b=this.get("input"),c=c.slice(0,e).join("").length;0<c&&++c;b.prop("selectionStart",c);b.prop("selectionEnd",c);c=b.prop("KsCursorOffset");b.prop("selectionStart",
d);b.prop("selectionEnd",d);a.set("xy",[c.left,c.top])}else a=this.get("menu"),d=h.clone(a.get("align")),d.node=this.get("el"),h.mix(d,B,!1),a.set("align",d)}function t(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",!0)},30)}function o(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function p(a,b){var c=a.get("input");if(a.get("multiple")){var d=u(a),e=d.tokens,d=Math.max(0,d.tokenIndex),f=a.get("separator"),j=a.get("separatorType"),
h=e[d];e[d]=h&&-1!=f.indexOf(h.charAt(0))?h.charAt(0):"";e[d]+=b;h=e[d+1];if(j==s&&(!h||-1==f.indexOf(h.charAt(0))))e[d]+=f.charAt(0);d=e.slice(0,d+1).join("").length;c.val(e.join(""));c.prop("selectionStart",d);c.prop("selectionEnd",d)}else c.val(b)}function q(a){var b=a.get("input").val();if(a.get("multiple")){var c=u(a),b=c.tokens,c=c.tokenIndex,d=a.get("separator"),a=a.get("separatorType");return(b=b[c]||"")&&-1!=d.indexOf(b.charAt(0))?b.substring(1):a==s&&(0==c||-1==c)?b:n}return b}function C(){if(!this._stopNotify){var a=
q(this);a===n?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function v(a,b){var c,d,e;if(a&&a.length){a=a.slice(0,b.get("maxItemCount"));c=b.get("format")?b.get("format").call(b,q(b),a):[];for(e=0;e<a.length;e++)d=a[e],c[e]=h.mix({content:d,textContent:d,value:d},c[e])}return c}function D(a){var b,c=[],d,e,f=j(this,1),a=v(a,this);f.removeChildren(!0);if(a&&a.length){for(e=0;e<a.length;e++)b=a[e],c.push(f.addChild(h.mix({xclass:"menuitem"},b)));a=q(this);for(e=0;e<c.length;e++)if(c[e].get("textContent")==
a){f.set("highlightedItem",c[e]);d=!0;break}if(!d&&this.get("autoHighlightFirst"))for(e=0;e<c.length;e++)if(!c[e].get("disabled")){f.set("highlightedItem",c[e]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function w(){if(!this.get("disabled")){var a=this.get("input");this.get("collapsed")?(a[0].focus(),this.sendRequest("")):this.set("collapsed",!0)}}function x(a){a.preventDefault()}function u(a){for(var b=a.get("input"),c=b.val(),d=[],e=[],f=a.get("literal"),j=a.get("separator"),
h=!1,a=a.get("whitespace"),b=b.prop("selectionStart"),m=-1,i=0;i<c.length;i++){var g=c.charAt(i);i==b&&(m=d.length);if(!h&&(!a&&/\s|\xa0/.test(g)&&(d.push(e.join("")),e=[]),-1!=j.indexOf(g)))d.push(e.join("")),e=[];f&&g==f&&(h=!h);e.push(g)}e.length&&d.push(e.join(""));-1==m&&(m=d.length-1);return{tokens:d,cursorPosition:b,tokenIndex:m}}var y,f=k.all,l=k.KeyCodes,B={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},z=f(h.Env.host),s="suffix",A=h.buffer(r,50);return y=i.Controller.extend({_savedInputValue:null,
_stopNotify:0,bindUI:function(){var a=this,b,c=a.get("input");c.on("valuechange",C,a);a.get("invalidEl")&&(c.on("blur",function(){a.get("disabled")||a.checkValid(function(b,e){e==c.val()&&c[0].ownerDocument.activeElement!=c[0]&&a._setInvalid(!b)})}),c.on("focus",function(){a.get("disabled")||a._setInvalid(!1)}));if(b=a.get("placeholderEl"))c.on("focus",function(){a.get("disabled")||b.hide()}),c.on("blur",function(){a.get("disabled")||c.val()||b.show()})},syncUI:function(){if(this.get("placeholder")){var a=
this.get("input"),b=this.get("inputValue");b!=n&&a.val(b);a.val()||this.get("placeholderEl").show()}},checkValid:function(a){var b=this,c=b.get("input").val();b.get("dataSource").fetchData(c,function(d){a:{if(d=v(d,b))for(var e=0;e<d.length;e++)if(d[e].textContent==c){d=d[e];break a}d=!1}a(d,c)})},bindMenu:function(){var a=this,b,c;c=a.get("menu");c.on("click",function(b){b=b.target;a._stopNotify=1;a._selectItem(b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});z.on("resize",A,
a);b=c.get("el");c=c.get("contentEl");b.on("focusout",t,a);b.on("focusin",o,a);c.on("mouseover",function(){a.get("input")[0].focus();o.call(a)});a.bindMenu=h.noop},_uiSetHasTrigger:function(a){var b=this.get("trigger");a?(b.on("click",w,this),b.on("mousedown",x)):(b.detach("click",w,this),b.detach("mousedown",x))},_setInvalid:function(a){var b=this.get("el"),c=this.get("prefixCls")+"combobox-invalid",d=this.get("invalidEl");a?(b.addClass(c),d.show()):(b.removeClass(c),d.hide())},sendRequest:function(a){this.get("dataSource").fetchData(a,
D,this)},_uiSetCollapsed:function(a){if(a)(a=j(this))&&a.hide();else{var a=this.get("el"),b=j(this,1);o.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),r.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},handleBlur:function(){y.superclass.handleBlur.apply(this,arguments);t.call(this)},handleKeyEventInternal:function(a){this.get("input");var b=j(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=
h.inArray(a.keyCode,[l.UP,l.DOWN,l.ESC])?1:0);var d;if(b.get("visible")){var e=b.handleKeydown(a);c&&h.inArray(a.keyCode,[l.DOWN,l.UP])&&p(this,b.get("activeItem").get("textContent"));if(a.keyCode==l.ESC)return this.set("collapsed",!0),c&&p(this,this._savedInputValue),!0;if(a.keyCode==l.TAB&&(d=b.get("activeItem")))if(d.performActionInternal(),this.get("multiple"))return!0;return e}if(a.keyCode==l.DOWN||a.keyCode==l.UP)return this.sendRequest(q(this)),!0}},_selectItem:function(a){if(a){var a=a.get("textContent"),
b=this.get("separatorType");p(this,a+(b==s?"":" "));this._savedInputValue=a}},getInputValue:function(){return this.get("input").val()},destructor:function(){z.detach("resize",A,this)}},{ATTRS:{input:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},invalidMessage:{view:1},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{xclass:"popupmenu"},setter:function(a){a instanceof i.Controller&&a.__set("parent",this)}},collapsed:{view:1},dataSource:{setter:function(a){return i.create(a)}},
maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:s},whitespace:{valueFn:function(){return this.get("separatorType")==s}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:g}}},{xclass:"combobox",priority:10})},{requires:["node","component","./render","input-selection","menu"]});
KISSY.add("combobox",function(h,k,i,g){k.LocalDataSource=i;k.RemoteDataSource=g;return k},{requires:["combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/LocalDataSource",function(h,k){function i(){i.superclass.constructor.apply(this,arguments)}i.ATTRS={data:{value:[]},parse:{value:function(i,f){var m=[],n=0;if(!i)return f;h.each(f,function(f){-1!=f.indexOf(i)&&m.push(f);n++});return m}}};h.extend(i,h.Base,{fetchData:function(h,f,i){var n=this.get("parse"),j=this.get("data"),j=n(h,j);f.call(i,j)}});k.Manager.setConstructorByXClass("combobox-LocalDataSource",i);return i},{requires:["component"]});
KISSY.add("combobox/RemoteDataSource",function(h,k,i){function g(){g.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}g.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};h.extend(g,h.Base,{fetchData:function(f,h,i){var j=this,g,t=j.get("paramName"),o=j.get("parse"),p=j.get("cache"),q=j.get("allowEmpty");j.io&&(j.io.abort(),j.io=null);if(!f&&!0!==q)return h.call(i,[]);if(p&&(g=j.caches[f]))return h.call(i,g);g=j.get("xhrCfg");g.data=g.data||{};
g.data[t]=f;g.success=function(g){o&&(g=o(f,g));j.__set("data",g);p&&(j.caches[f]=g);h.call(i,g)};j.io=k(g)}});i.Manager.setConstructorByXClass("combobox-RemoteDataSource",g);return g},{requires:["ajax","component"]});
KISSY.add("combobox/render",function(h,k){var i=h.all,g=k.Render.extend({createDom:function(){var f,g=this.get("input"),k=this.get("el"),j=this.get("trigger");this.get("srcNode")||(k.append('<div class="ks-combobox-input-wrap"></div>'),f=k.one(".ks-combobox-input-wrap"),g=g||h.all('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="ks-combobox-input" />'),f.append(g),this.__set("input",g));j||this.__set("trigger",h.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable();var r;(r=this.get("invalidMessage"))&&this.__set("invalidEl",i("<div title='"+r+"' class='ks-combobox-invalid-el'><div class='ks-combobox-invalid-inner'></div></div>").insertBefore(g.parent()));if(j=this.get("placeholder")){if(!(f=g.attr("id")))g.attr("id",f=h.guid("ks-combobox-input"));this.__set("placeholderEl",i('<label for="'+f+'" class="ks-combobox-placeholder">'+j+"</label>").appendTo(k))}},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(f){this.get("input").attr("aria-expanded",
f)},_uiSetHasTrigger:function(f){var g=this.get("trigger");f?this.get("el").prepend(g):g.remove()},_uiSetDisabled:function(f){g.superclass._uiSetDisabled.apply(this,arguments);this.get("input").attr("disabled",f)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},input:{},trigger:{},placeholder:{},placeholderEl:{},invalidMessage:{},invalidEl:{}},HTML_PARSER:{input:function(f){return f.one(".ks-combobox-input")},trigger:function(f){return f.one(".ks-combobox-trigger")}}});return g},{requires:["component"]});
