/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 14 18:11
*/
KISSY.add("combobox/base",function(e,i,a,c,f,j,m){function g(b,h){var d=b.get("menu");if(d&&d.xclass)if(h)d=a.create(d,b),b.__set("menu",d);else return null;return d}function k(b){if(b.get("multiple")&&b.get("alignWithCursor")){var h=b._getInputDesc(),d=h.tokens,a=b.get("menu"),c=h.cursorPosition,h=h.tokenIndex,b=b.get("input"),d=d.slice(0,h).join("").length;0<d&&++d;b.prop("selectionStart",d);b.prop("selectionEnd",d);d=b.prop("KsCursorOffset");b.prop("selectionStart",c);b.prop("selectionEnd",c);
a.set("xy",[d.left,d.top])}else a=b.get("menu"),c=b.get("menuCfg")||{},a.set("align",e.merge({node:b.get("el")},q,c.align))}function p(){var b=this.get("input"),h=g(this);h&&h.get("visible")?this.set("collapsed",!0):(b[0].focus(),this.sendRequest(""))}function n(b){b.preventDefault()}var o,l=i.KeyCodes,q={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};return o=a.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("input").on("valuechange",this._onValueChange,this)},
_uiSetHasTrigger:function(b){var h=this.get("trigger");b?(h.on("click",p,this),h.on("mousedown",n)):(h.detach("click",p,this),h.detach("mousedown",n))},sendRequest:function(b){this.get("dataSource").fetchData(b,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var b=this._getValue();b===m?this.set("collapsed",!0):(this._savedInputValue=b,this.sendRequest(b))}},_uiSetCollapsed:function(b){var h=this.get("menuCfg"),d=g(this);d&&(b?d.hide():(d.show(),null==h.width&&d.set("width",
this.get("el").innerWidth()),this.get("ariaOwns")||this.set("ariaOwns",d.get("el")[0].id)))},handleBlur:function(){o.superclass.handleBlur.apply(this,arguments);var b=g(this);b&&b._hideForComboBox()},_renderData:function(b){var h,d,a;if(!(h=g(this,1)))this.get("menuCfg"),h=new c(e.mix({prefixCls:this.get("prefixCls")},this.get("menuCfg"))),this.__set("menu",h);var j=h;j.removeChildren(!0);if(b&&b.length){b=b.slice(0,this.get("maxItemCount"));d=this.get("format")?this.get("format").call(this,this._getValue(),
b):[];for(a=0;a<b.length;a++)h=b[a],j.addChild(e.mix({xclass:"menuitem",content:h,textContent:h,value:h},d[a]));a:{a=this.get("menu");a._clearDismissTimer();k(this);this.set("collapsed",!1);b=a.get("children");h=this._getValue();for(d=0;d<b.length;d++)if(b[d].get("textContent")==h){a.set("highlightedItem",b[d]);break a}if(this.get("autoHighlightFirst"))for(d=0;d<b.length;d++)if(!b[d].get("disabled")){a.set("highlightedItem",b[d]);break}}}else this.set("collapsed",!0)},_onWindowResize:function(){k(this)},
handleKeyEventInternal:function(b){this.get("input");var a=g(this);if(a){var d=this.get("updateInputOnDownUp");d&&(this._stopNotify=e.inArray(b.keyCode,[l.UP,l.DOWN,l.ESC])?1:0);var c;if(a.get("visible")){var j=a.handleKeydown(b);d&&e.inArray(b.keyCode,[l.DOWN,l.UP])&&this._setValue(a.get("activeItem").get("textContent"));if(b.keyCode==l.ESC)return this.set("collapsed",!0),d&&this._setValue(this._savedInputValue),!0;if(b.keyCode==l.TAB&&(c=a.get("activeItem")))if(c.performActionInternal(),this.get("multiple"))return!0;
return j}if(b.keyCode==l.DOWN||b.keyCode==l.UP)return this.sendRequest(this._getValue()),!0}},_uiSetSelectedItem:function(b){if(b){var a=b.get("textContent");this._setValue(a+this.get("strAppendedOnComplete"));this._savedInputValue=a;this.fire("click",{target:b})}},_getValue:function(){var b=this.get("input").val();if(this.get("multiple")){var a=this._getInputDesc(),b=a.tokens,a=a.tokenIndex,d=this.get("separator");return(b=b[a]||"")&&-1!=d.indexOf(b.charAt(0))?b.substring(1):this.get("queryAtStart")&&
(0==a||-1==a)?b:m}return b},_setValue:function(b){var a=this.get("input");if(this.get("multiple")){var d=this._getInputDesc(),c=d.tokens,d=Math.max(0,d.tokenIndex),j=this.get("separator"),g=this.get("appendSeparatorOnComplete"),f=c[d];c[d]=f&&-1!=j.indexOf(f.charAt(0))?f.charAt(0):"";c[d]+=b;b=c[d+1];if(g&&(!b||-1==j.indexOf(b.charAt(0))))c[d]+=j.charAt(0);b=c.slice(0,d+1).join("").length;a.val(c.join(""));a.prop("selectionStart",b);a.prop("selectionEnd",b)}else a.val(b)},_getInputDesc:function(){for(var b=
this.get("input"),a=b.val(),d=[],c=[],j=this.get("literal"),g=this.get("separator"),f=!1,e=this.get("whitespace"),b=b.prop("selectionStart"),m=-1,k=0;k<a.length;k++){var i=a.charAt(k);k==b&&(m=d.length);if(!f&&(!e&&/\s|\xa0/.test(i)&&(d.push(c.join("")),c=[]),-1!=g.indexOf(i)))d.push(c.join("")),c=[];j&&i==j&&(f=!f);c.push(i)}c.length&&d.push(c.join(""));-1==m&&(m=d.length-1);return{tokens:d,cursorPosition:b,tokenIndex:m}}},{ATTRS:{input:{view:!0},trigger:{view:!0},hasTrigger:{value:!0,view:!0},menu:{setter:function(b){b instanceof
c&&b.__set("parent",this)}},ariaOwns:{view:!0},collapsed:{view:!0},dataSource:{setter:function(b){return a.create(b)}},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},queryAtStart:{value:!0},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""},xrender:{value:f}}},{xclass:"combobox",priority:10})},{requires:["event",
"component","./menu","./baseRender","input-selection"]});
KISSY.add("combobox/baseRender",function(e,i){return i.Render.extend({createDom:function(){var a,c;a=this.get("el");var f=this.get("trigger");this.get("srcNode")||(a.append('<div class="ks-combobox-input-wrap"></div>'),a=a.one(".ks-combobox-input-wrap"),c=this.get("input")||e.all('<input aria-haspopup="true" aria-combobox="list" aria-haspopup="true" role="combobox" combobox="off" class="ks-combobox-input" />'),a.append(c),this.__set("input",c));f||this.__set("trigger",e.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable()},_uiSetAriaOwns:function(a){this.get("input").attr("aria-owns",a)},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(a){this.get("input").attr("aria-expanded",a)},_uiSetHasTrigger:function(a){var c=this.get("trigger");a?this.get("el").prepend(c):c.remove()}},{ATTRS:{ariaOwns:{},collapsed:{},hasTrigger:{},input:{},trigger:{}},HTML_PARSER:{input:function(a){return a.one(".ks-combobox-input")},trigger:function(a){return a.one(".ks-combobox-trigger")}}})},
{requires:["component"]});KISSY.add("combobox",function(e,i,a,c,f){a.Menu=i;a.LocalDataSource=c;a.RemoteDataSource=f;return a},{requires:["combobox/menu","combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/LocalDataSource",function(e,i){function a(c){a.superclass.constructor.apply(this,arguments)}a.ATTRS={data:{value:[]},parse:{value:function(a,f){var j=[],m=0;if(!a)return f;e.each(f,function(f){-1!=f.indexOf(a)&&j.push(f);m++});return j}}};e.extend(a,e.Base,{fetchData:function(a,f,j){var e=this.get("parse"),g=this.get("data"),g=e(a,g);f.call(j,g)}});i.Manager.setConstructorByXClass("combobox-LocalDataSource",a);return a},{requires:["component"]});
KISSY.add("combobox/menu",function(e,i,a,c){var f=e.Env.host;return a.PopupMenu.extend({bindUI:function(){var a=this;a.on("click",function(c){var c=c.target,f=a.get("parent");f._stopNotify=1;f.set("selectedItem",c);f.set("collapsed",!0);setTimeout(function(){f._stopNotify=0},50)});var c=e.buffer(function(){this.get("visible")&&this.get("parent")._onWindowResize()},50);a.__reAlign=c;i.on(f,"resize",c,a);var c=a.get("el"),g=a.get("contentEl");c.on("focusin",function(){a._clearDismissTimer()});c.on("focusout",
function(){a._hideForComboBox()});g.on("mouseover",function(){a.get("parent").get("input")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForComboBox:function(){var a=this;a._dismissTimer=setTimeout(function(){a.get("parent").set("collapsed",!0)},30)},destructor:function(){i.remove(f,"resize",this.__reAlign,this)}},{ATTRS:{head:{view:!0},foot:{view:!0},xrender:{value:c}}},{xclass:"combobox-menu",
priority:40})},{requires:["event","menu","./menuRender"]});KISSY.add("combobox/menuRender",function(e,i){var a=e.all;return i.PopupMenu.Render.extend({createDom:function(){var c=this.get("el"),f=a("<div class='ks-combobox-menu-header'></div>"),e=a("<div class='ks-combobox-menu-footer'></div>");c.prepend(f);c.append(e);this.__set("head",f);this.__set("foot",e)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["menu"]});
KISSY.add("combobox/RemoteDataSource",function(e,i,a){function c(a){c.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}c.ATTRS={paramName:{},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};e.extend(c,e.Base,{fetchData:function(a,c,e){var g=this,k,p=g.get("paramName"),n=g.get("parse"),o=g.get("cache"),l=g.get("allowEmpty");g.io&&(g.io.abort(),g.io=null);if(!a&&!0!==l)return c.call(e,[]);if(o&&(k=g.caches[a]))return c.call(e,k);k=g.get("xhrCfg");k.data=k.data||{};k.data[p]=
a;k.success=function(i){n&&(i=n(a,i));g.__set("data",i);o&&(g.caches[a]=i);c.call(e,i)};g.io=i(k)}});a.Manager.setConstructorByXClass("combobox-RemoteDataSource",c);return c},{requires:["ajax","component"]});
