/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 25 11:48
*/
KISSY.add("autocomplete/BasicComboBox",function(f,h,c,b){function j(b){var a=this.get("menu"),g=this.get("el")[0];a.get("visible")?a.hide():(g.focus(),this.sendRequest(""));b&&b.halt()}return h.create(c,{bindUI:function(){this.get("el");var b=this.get("container");this.get("button");b.on("click",j,this);var a=this.get("menuCfg");a.width||(a.width=b.width())}},{ATTRS:{container:{view:!0},button:{view:!0}},DefaultRender:b})},{requires:["uibase","./basic","./BasicComboBoxRender"]});
KISSY.add("autocomplete/BasicComboBoxRender",function(f,h,c,b){var j=b.all,i;return i=h.create(c,{createDom:function(){var a=j("<span class='"+this.get("prefixCls")+"combobox'></span>"),b=j("<a tabindex='-1' href='javascript:void(\"open\")'  onmousedown='return false;' class='"+this.get("prefixCls")+"combobox-button'>&#x25BC;</a>").unselectable();this.__set("container",a);this.__set("button",b)},renderUI:function(){var a=this.get("container"),b=this.get("button"),c=this.get("el").parent();a.appendTo(c).append(this.get("el")).append(b)},
_uiSetFocused:function(a){i.superclass._uiSetFocused.apply(this,arguments);this.get("container")[a?"addClass":"removeClass"](this.get("prefixCls")+"combobox-focused")},destructor:function(){this.get("container").remove()}},{ATTRS:{container:{},button:{}}})},{requires:["uibase","./inputRender","node"]});KISSY.add("autocomplete",function(f,h,c,b,j,i,a){c.Menu=h;c.LocalDataSource=b;c.RemoteDataSource=j;c.Basic=i;c.BasicComboBox=a;return c},{requires:"autocomplete/menu,autocomplete/input,autocomplete/localDataSource,autocomplete/remoteDataSource,autocomplete/basic,autocomplete/BasicComboBox".split(",")});
KISSY.add("autocomplete/basic",function(f,h,c,b,j,i){return h.create(c,[],{initializer:function(){var a,c;this.get("dataSource")||(a=(c=this.get("data"))?new j({data:c,dataSourceCfg:this.get("dataSourceCfg")}):new i({xhrCfg:this.get("xhrCfg"),dataSourceCfg:this.get("dataSourceCfg")}),this.__set("dataSource",a));this.get("menu")||(a=new b({prefixCls:this.get("prefixCls")}),this.__set("menu",a))}},{ATTRS:{destroyMenu:{value:!0},data:{},xhrCfg:{value:{}},dataSourceCfg:{value:{}}}},"AutoComplete_Basic")},
{requires:["uibase","./input","./menu","./localDataSource","./remoteDataSource"]});
KISSY.add("autocomplete/input",function(f,h,c,b,j,i,a,g){function k(d){if(d.get("multiple")&&d.get("alignWithCursor")){var a=d._getInputDesc(),b=a.tokens,m=d.get("menu"),c=a.cursorPosition,a=a.tokenIndex,d=d.get("el"),b=b.slice(0,a).join("").length;0<b&&++b;d.prop("selectionStart",b);d.prop("selectionEnd",b);b=d.prop("KsCursorOffset");d.prop("selectionStart",c);d.prop("selectionEnd",c);m.set("xy",[b.left,b.top])}else m=d.get("menu"),c=d.get("menuCfg")||{},m.set("align",f.merge({node:d.get("el")},
n,c.align))}var e,l=h.KeyCodes,n={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};e=c.create(b.Controller,[],{_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("el").on("valuechange",this._onValueChange,this)},sendRequest:function(d){this.get("dataSource").fetchData(d,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var d=this._getValue();d===g?(d=this.get("menu"))&&d.hide():(this._savedInputValue=d,this.sendRequest(d))}},handleBlur:function(){e.superclass.handleBlur.apply(this,
arguments);var d=this.get("menu");d&&d._hideForAutoComplete()},_renderData:function(d){var a=this.get("menu");a.removeChildren(!0);if(d&&d.length){var d=d.slice(0,this.get("maxItemCount")),b=this.get("menuCfg")||{};a.set("width",b.width===g?this.get("el").css("width"):b.width);var c;c=this.get("format")?this.get("format").call(this,this._getValue(),d):[];for(var e=0;e<d.length;e++)b=d[e],a.addChild(new j.Item(f.mix({prefixCls:this.get("prefixCls")+"autocomplete-",content:b,textContent:b,value:b},
c[e])));this._showMenu()}else a.hide()},_showMenu:function(){var d=this.get("menu");d._input=this;d._clearDismissTimer();k(this);d.show();for(var a=d.get("children"),b=this._getValue(),c=0;c<a.length;c++)if(a[c].get("textContent")==b){d.set("highlightedItem",a[c]);return}if(this.get("autoHighlightFirst"))for(c=0;c<a.length;c++)if(!a[c].get("disabled")){d.set("highlightedItem",a[c]);break}},_onWindowResize:function(){k(this)},handleKeyEventInternal:function(a){this.get("el");var b=this.get("menu");
if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=f.inArray(a.keyCode,[l.UP,l.DOWN,l.ESC])?1:0);var e;if(b.get("visible")){var g=b.handleKeydown(a);c&&f.inArray(a.keyCode,[l.DOWN,l.UP])&&this._setValue(b.get("activeItem").get("textContent"));if(a.keyCode==l.ESC)return b.hide(),c&&this._setValue(this._savedInputValue),!0;if(a.keyCode==l.TAB&&(e=b.get("activeItem")))if(e.performActionInternal(),this.get("multiple"))return!0;return g}if((a.keyCode==l.DOWN||a.keyCode==l.UP)&&this.get("reFetchOnDownUp"))return this.sendRequest(this._getValue()),
!0}},_uiSetSelectedItem:function(a){if(a){var b=a.get("textContent");this._setValue(b+this.get("strAppendedOnComplete"));this._savedInputValue=b;this.fire("select",{target:a})}},_getValue:function(){var a=this.get("el").val();if(this.get("multiple")){var b=this._getInputDesc(),a=b.tokens,b=b.tokenIndex,c=this.get("separator");return(a=a[b]||"")&&-1!=c.indexOf(a.charAt(0))?a.substring(1):this.get("autoCompleteOnInitial")&&(0==b||-1==b)?a:g}return a},_setValue:function(a){var b=this.get("el");if(this.get("multiple")){var c=
this._getInputDesc(),e=c.tokens,c=c.tokenIndex,g=this.get("separator"),j=this.get("appendSeparatorOnComplete"),f=e[c];e[c]=-1!=g.indexOf(f.charAt(0))?f.charAt(0):"";e[c]+=a;a=e[c+1];if(j&&(!a||-1==g.indexOf(a.charAt(0))))e[c]+=g.charAt(0);a=e.slice(0,c+1).join("").length;b.val(e.join(""));b.prop("selectionStart",a);b.prop("selectionEnd",a)}else b.val(a)},_getInputDesc:function(){for(var a=this.get("el"),b=a.val(),c=[],e=[],g=this.get("literal"),f=this.get("separator"),j=!1,h=this.get("whitespace"),
a=a.prop("selectionStart"),i=-1,k=0;k<b.length;k++){var l=b.charAt(k);k==a&&(i=c.length);if(!j&&(!h&&/\s|\xa0/.test(l)&&(c.push(e.join("")),e=[]),-1!=f.indexOf(l)))c.push(e.join("")),e=[];g&&l==g&&(j=!j);e.push(l)}e.length&&c.push(e.join(""));-1==i&&(i=c.length-1);return{tokens:c,cursorPosition:a,tokenIndex:i}},destructor:function(){this.get("menu").detachInput(this,this.get("destroyMenu"));this.__set("menu",null)}},{ATTRS:{handleMouseEvents:{value:!1},destroyMenu:{value:!1},menu:{setter:function(a){a&&
a.attachInput(this)}},ariaOwns:{view:!0},ariaExpanded:{view:!0},dataSource:{},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},updateInputOnDownUp:{value:!0},reFetchOnDownUp:{value:!0},literal:{value:'"'},autoCompleteOnInitial:{value:!0},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""}},DefaultRender:i},"AutoComplete");b.UIStore.setUIConstructorByCssClass("autocomplete-input",
{priority:b.UIStore.PRIORITY.LEVEL1,ui:e});return e},{requires:"event,uibase,component,menu,./inputRender,input-selection".split(",")});
KISSY.add("autocomplete/inputRender",function(f,h,c){return h.create(c.Render,[],{renderUI:function(){this.get("el").attr({"aria-haspopup":!0,"aria-autocomplete":"list",autocomplete:"off",role:"combobox"})},_uiSetAriaOwns:function(b){this.get("el").attr("aria-owns",b)},_uiSetAriaExpanded:function(b){this.get("el").attr("aria-expanded",b)}},{ATTRS:{ariaOwns:{},ariaExpanded:{},elTagName:{value:"input"}}})},{requires:["uibase","component"]});
KISSY.add("autocomplete/localDataSource",function(f){function h(b){h.superclass.constructor.apply(this,arguments)}function c(b,c){var i=[],a=0;if(!b)return c;f.each(c,function(c){-1!=c.indexOf(b)&&i.push(c);a++});return i}h.ATTRS={data:{value:[]},dataSourceCfg:{value:{}}};f.extend(h,f.Base,{fetchData:function(b,f,i){var a=this.get("dataSourceCfg").parse||c,g=this.get("data"),g=a(b,g);f.call(i,g)}});return h});
KISSY.add("autocomplete/menu",function(f,h,c,b,j,i){c=c.create(j.PopupMenu,{_input:null,_inputs:null,attachInput:function(a){this._inputs=this._inputs||[];f.inArray(a,this._inputs)||this._inputs.push(a)},detachInput:function(a,b){var c=this._inputs,e=f.indexOf(a,c||[]);-1!=e&&c.splice(e,1);b&&(!c||0==c.length)&&this.destroy()},bindUI:function(){var a=this;a.on("show",function(){var b=a._input;b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!0)});a.on("hide",function(){var b=a._input;
b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!1)});a.on("click",function(b){var b=b.target,c=a._input;c._stopNotify=1;c.set("selectedItem",b);a.hide();setTimeout(function(){c._stopNotify=0},50)});var b=f.buffer(function(){var a=this._input;a&&this.get("visible")&&a._onWindowResize()},50);a.__reAlign=b;h.on(window,"resize",b,a);var b=a.get("el"),c=a.get("contentEl");b.on("focusin",function(){a._clearDismissTimer()});b.on("focusout",function(){a._hideForAutoComplete()});c.on("mouseover",
function(){a._input.get("el")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForAutoComplete:function(){var a=this;a._dismissTimer=setTimeout(function(){a._immediateHideForAutoComplete()},30)},_immediateHideForAutoComplete:function(){this.removeChildren(!0);this.hide()},destructor:function(){h.remove(window,"resize",this.__reAlign,this);f.each(this._inputs,function(a){a.__set("menu",null)});this._inputs=
null}},{DefaultRender:i,ATTRS:{head:{view:!0},foot:{view:!0}}},"AutoComplete_Menu");b.UIStore.setUIConstructorByCssClass("autocomplete-menu",{priority:b.UIStore.PRIORITY.LEVEL1,ui:c});return c},{requires:["event","uibase","component","menu","./menuRender"]});
KISSY.add("autocomplete/menuRender",function(f,h,c){var b=f.all;return h.create(c.PopupMenu.Render,[],{createDom:function(){var c=this.get("el"),f=b("<div class='"+this.get("prefixCls")+"autocomplete-menu-header'></div>"),a=b("<div class='"+this.get("prefixCls")+"autocomplete-menu-footer'></div>");c.prepend(f);c.append(a);this.__set("head",f);this.__set("foot",a)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["uibase","menu"]});
KISSY.add("autocomplete/remoteDataSource",function(f,h){function c(b){c.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}c.ATTRS={dataSourceCfg:{value:{}},xhrCfg:{value:{}}};f.extend(c,f.Base,{fetchData:function(b,c,f){var a=this,g,k=a.get("dataSourceCfg");a.io&&(a.io.abort(),a.io=null);if(!b&&!0!==k.allowEmpty)return c.call(f,[]);if(k.cache&&(g=a.caches[b]))return c.call(f,g);g=a.get("xhrCfg");g.data=g.data||{};g.data[k.paramName]=b;g.success=function(e){k.parse&&(e=k.parse(b,
e));a.__set("data",e);k.cache&&(a.caches[b]=e);c.call(f,e)};a.io=h(g)}});return c},{requires:["ajax"]});
