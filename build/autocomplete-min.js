/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 30 20:24
*/
KISSY.add("autocomplete/BasicComboBox",function(f,h,e){function j(a){var d=this.get("menu"),b=this.get("el")[0];d.get("visible")?d.hide():(b.focus(),this.sendRequest(""));a&&a.halt()}return h.extend({bindUI:function(){this.get("el");var a=this.get("container");this.get("button");a.on("click",j,this);var d=this.get("menuCfg");d.width||(d.width=a.width())}},{ATTRS:{container:{view:!0},button:{view:!0}},DefaultRender:e},{xclass:"autocomplete-combobox",priority:30})},{requires:["./basic","./BasicComboBoxRender"]});
KISSY.add("autocomplete/BasicComboBoxRender",function(f,h,e){var j=e.all,a;return a=h.extend({createDom:function(){var a=j("<span class='"+this.get("prefixCls")+"combobox'></span>"),b=j("<span class='ks-combobox-button'><span class='ks-combo-button-inner'>&#x25BC;</span></span>").unselectable();b.on("mousedown",function(a){a.preventDefault()});this.__set("container",a);this.__set("button",b)},renderUI:function(){var a=this.get("container"),b=this.get("button"),c=this.get("el").parent();a.appendTo(c).append(this.get("el")).append(b)},
_uiSetFocused:function(d){a.superclass._uiSetFocused.apply(this,arguments);this.get("container")[d?"addClass":"removeClass"]("ks-combobox-focused")},destructor:function(){this.get("container").remove()}},{ATTRS:{container:{},button:{}}})},{requires:["./inputRender","node"]});KISSY.add("autocomplete",function(f,h,e,j,a,d,b){e.Menu=h;e.LocalDataSource=j;e.RemoteDataSource=a;e.Basic=d;e.BasicComboBox=b;return e},{requires:"autocomplete/menu,autocomplete/input,autocomplete/localDataSource,autocomplete/remoteDataSource,autocomplete/basic,autocomplete/BasicComboBox".split(",")});
KISSY.add("autocomplete/basic",function(f,h,e,j,a){return h.extend({initializer:function(){var d,b;this.get("dataSource")||(d=(b=this.get("data"))?new j({data:b,dataSourceCfg:this.get("dataSourceCfg")}):new a({xhrCfg:this.get("xhrCfg"),dataSourceCfg:this.get("dataSourceCfg")}),this.__set("dataSource",d));this.get("menu")||(d=new e({prefixCls:this.get("prefixCls")}),this.__set("menu",d))}},{ATTRS:{destroyMenu:{value:!0},data:{},xhrCfg:{value:{}},dataSourceCfg:{value:{}}}},{xclass:"autocomplete-basic",
priority:30})},{requires:["./input","./menu","./localDataSource","./remoteDataSource"]});
KISSY.add("autocomplete/input",function(f,h,e,j,a,d,b){function c(g){if(g.get("multiple")&&g.get("alignWithCursor")){var a=g._getInputDesc(),i=a.tokens,m=g.get("menu"),b=a.cursorPosition,a=a.tokenIndex,g=g.get("el"),i=i.slice(0,a).join("").length;0<i&&++i;g.prop("selectionStart",i);g.prop("selectionEnd",i);i=g.prop("KsCursorOffset");g.prop("selectionStart",b);g.prop("selectionEnd",b);m.set("xy",[i.left,i.top])}else m=g.get("menu"),b=g.get("menuCfg")||{},m.set("align",f.merge({node:g.get("el")},o,
b.align))}var l,k=h.KeyCodes,o={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};return l=e.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("el").on("valuechange",this._onValueChange,this)},sendRequest:function(g){this.get("dataSource").fetchData(g,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var g=this._getValue();g===b?(g=this.get("menu"))&&g.hide():(this._savedInputValue=g,this.sendRequest(g))}},handleBlur:function(){l.superclass.handleBlur.apply(this,
arguments);var g=this.get("menu");g&&g._hideForAutoComplete()},_renderData:function(g){var a=this.get("menu");a.removeChildren(!0);if(g&&g.length){var g=g.slice(0,this.get("maxItemCount")),i=this.get("menuCfg")||{};a.set("width",i.width===b?this.get("el").css("width"):i.width);var m;m=this.get("format")?this.get("format").call(this,this._getValue(),g):[];for(var c=0;c<g.length;c++)i=g[c],a.addChild(new j.Item(f.mix({prefixCls:this.get("prefixCls"),content:i,textContent:i,value:i},m[c])));this._showMenu()}else a.hide()},
_showMenu:function(){var g=this.get("menu");g._input=this;g._clearDismissTimer();c(this);g.show();for(var a=g.get("children"),i=this._getValue(),b=0;b<a.length;b++)if(a[b].get("textContent")==i){g.set("highlightedItem",a[b]);return}if(this.get("autoHighlightFirst"))for(b=0;b<a.length;b++)if(!a[b].get("disabled")){g.set("highlightedItem",a[b]);break}},_onWindowResize:function(){c(this)},handleKeyEventInternal:function(a){this.get("el");var b=this.get("menu");if(b){var i=this.get("updateInputOnDownUp");
i&&(this._stopNotify=f.inArray(a.keyCode,[k.UP,k.DOWN,k.ESC])?1:0);var c;if(b.get("visible")){var d=b.handleKeydown(a);i&&f.inArray(a.keyCode,[k.DOWN,k.UP])&&this._setValue(b.get("activeItem").get("textContent"));if(a.keyCode==k.ESC)return b.hide(),i&&this._setValue(this._savedInputValue),!0;if(a.keyCode==k.TAB&&(c=b.get("activeItem")))if(c.performActionInternal(),this.get("multiple"))return!0;return d}if((a.keyCode==k.DOWN||a.keyCode==k.UP)&&this.get("reFetchOnDownUp"))return this.sendRequest(this._getValue()),
!0}},_uiSetSelectedItem:function(a){if(a){var b=a.get("textContent");this._setValue(b+this.get("strAppendedOnComplete"));this._savedInputValue=b;this.fire("select",{target:a})}},_getValue:function(){var a=this.get("el").val();if(this.get("multiple")){var c=this._getInputDesc(),a=c.tokens,c=c.tokenIndex,i=this.get("separator");return(a=a[c]||"")&&-1!=i.indexOf(a.charAt(0))?a.substring(1):this.get("autoCompleteOnInitial")&&(0==c||-1==c)?a:b}return a},_setValue:function(a){var b=this.get("el");if(this.get("multiple")){var c=
this._getInputDesc(),d=c.tokens,c=c.tokenIndex,e=this.get("separator"),j=this.get("appendSeparatorOnComplete"),f=d[c];d[c]=-1!=e.indexOf(f.charAt(0))?f.charAt(0):"";d[c]+=a;a=d[c+1];if(j&&(!a||-1==e.indexOf(a.charAt(0))))d[c]+=e.charAt(0);a=d.slice(0,c+1).join("").length;b.val(d.join(""));b.prop("selectionStart",a);b.prop("selectionEnd",a)}else b.val(a)},_getInputDesc:function(){for(var a=this.get("el"),b=a.val(),c=[],d=[],e=this.get("literal"),j=this.get("separator"),f=!1,h=this.get("whitespace"),
a=a.prop("selectionStart"),k=-1,l=0;l<b.length;l++){var n=b.charAt(l);l==a&&(k=c.length);if(!f&&(!h&&/\s|\xa0/.test(n)&&(c.push(d.join("")),d=[]),-1!=j.indexOf(n)))c.push(d.join("")),d=[];e&&n==e&&(f=!f);d.push(n)}d.length&&c.push(d.join(""));-1==k&&(k=c.length-1);return{tokens:c,cursorPosition:a,tokenIndex:k}},destructor:function(){this.get("menu").detachInput(this,this.get("destroyMenu"));this.__set("menu",null)}},{ATTRS:{handleMouseEvents:{value:!1},destroyMenu:{value:!1},menu:{setter:function(a){a&&
a.attachInput(this)}},ariaOwns:{view:!0},ariaExpanded:{view:!0},dataSource:{},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:!0},appendSeparatorOnComplete:{value:!0},updateInputOnDownUp:{value:!0},reFetchOnDownUp:{value:!0},literal:{value:'"'},autoCompleteOnInitial:{value:!0},alignWithCursor:{},autoHighlightFirst:{},strAppendedOnComplete:{value:""}},DefaultRender:a},{xclass:"autocomplete-input",priority:10})},{requires:["event",
"component","menu","./inputRender","input-selection"]});KISSY.add("autocomplete/inputRender",function(f,h){return h.Render.extend({renderUI:function(){this.get("el").attr({"aria-haspopup":!0,"aria-autocomplete":"list",autocomplete:"off",role:"combobox"})},_uiSetAriaOwns:function(e){this.get("el").attr("aria-owns",e)},_uiSetAriaExpanded:function(e){this.get("el").attr("aria-expanded",e)}},{ATTRS:{ariaOwns:{},ariaExpanded:{},elTagName:{value:"input"}}})},{requires:["component"]});
KISSY.add("autocomplete/localDataSource",function(f){function h(e){h.superclass.constructor.apply(this,arguments)}function e(e,a){var d=[],b=0;if(!e)return a;f.each(a,function(a){-1!=a.indexOf(e)&&d.push(a);b++});return d}h.ATTRS={data:{value:[]},dataSourceCfg:{value:{}}};f.extend(h,f.Base,{fetchData:function(f,a,d){var b=this.get("dataSourceCfg").parse||e,c=this.get("data"),c=b(f,c);a.call(d,c)}});return h});
KISSY.add("autocomplete/menu",function(f,h,e,j){return e.PopupMenu.extend({_input:null,_inputs:null,attachInput:function(a){this._inputs=this._inputs||[];f.inArray(a,this._inputs)||this._inputs.push(a)},detachInput:function(a,d){var b=this._inputs,c=f.indexOf(a,b||[]);-1!=c&&b.splice(c,1);d&&(!b||0==b.length)&&this.destroy()},bindUI:function(){var a=this;a.on("show",function(){var b=a._input;b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!0)});a.on("hide",function(){var b=a._input;
b.set("ariaOwns",a.get("el").attr("id"));b.set("ariaExpanded",!1)});a.on("click",function(b){var b=b.target,d=a._input;d._stopNotify=1;d.set("selectedItem",b);a.hide();setTimeout(function(){d._stopNotify=0},50)});var d=f.buffer(function(){var a=this._input;a&&this.get("visible")&&a._onWindowResize()},50);a.__reAlign=d;h.on(window,"resize",d,a);var d=a.get("el"),b=a.get("contentEl");d.on("focusin",function(){a._clearDismissTimer()});d.on("focusout",function(){a._hideForAutoComplete()});b.on("mouseover",
function(){a._input.get("el")[0].focus();a._clearDismissTimer()})},_clearDismissTimer:function(){this._dismissTimer&&(clearTimeout(this._dismissTimer),this._dismissTimer=null)},_hideForAutoComplete:function(){var a=this;a._dismissTimer=setTimeout(function(){a._immediateHideForAutoComplete()},30)},_immediateHideForAutoComplete:function(){this.removeChildren(!0);this.hide()},destructor:function(){h.remove(window,"resize",this.__reAlign,this);f.each(this._inputs,function(a){a.__set("menu",null)});this._inputs=
null}},{DefaultRender:j,ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["event","menu","./menuRender"]});KISSY.add("autocomplete/menuRender",function(f,h){var e=f.all;return h.PopupMenu.Render.extend({createDom:function(){var f=this.get("el"),a=e("<div class='ks-autocomplete-menu-header'></div>"),d=e("<div class='ks-autocomplete-menu-footer'></div>");f.prepend(a);f.append(d);this.__set("head",a);this.__set("foot",d)}},{ATTRS:{head:{view:!0},foot:{view:!0}}})},{requires:["menu"]});
KISSY.add("autocomplete/remoteDataSource",function(f,h){function e(f){e.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}e.ATTRS={dataSourceCfg:{value:{}},xhrCfg:{value:{}}};f.extend(e,f.Base,{fetchData:function(e,a,d){var b=this,c,f=b.get("dataSourceCfg");b.io&&(b.io.abort(),b.io=null);if(!e&&!0!==f.allowEmpty)return a.call(d,[]);if(f.cache&&(c=b.caches[e]))return a.call(d,c);c=b.get("xhrCfg");c.data=c.data||{};c.data[f.paramName]=e;c.success=function(c){f.parse&&(c=f.parse(e,
c));b.__set("data",c);f.cache&&(b.caches[e]=c);a.call(d,c)};b.io=h(c)}});return e},{requires:["ajax"]});
