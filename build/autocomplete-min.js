/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Apr 11 20:59
*/
KISSY.add("autocomplete/BasicComboBox",function(l,m,g,f){function k(i){var b=this.get("menu"),e=this.get("el")[0];if(b.get("visible"))b.hide();else{e.focus();this.sendRequest("")}i&&i.halt()}return m.create(g,{bindUI:function(){this.get("el");var i=this.get("container");this.get("button");i.on("click",k,this);var b=this.get("menuCfg");if(!b.width)b.width=i.width()}},{ATTRS:{container:{view:true},button:{view:true}},DefaultRender:f})},{requires:["uibase","./basic","./BasicComboBoxRender"]});
KISSY.add("autocomplete/BasicComboBoxRender",function(l,m,g,f){var k=f.all,i;return i=m.create(g,{createDom:function(){var b=k("<span class='"+this.get("prefixCls")+"combobox'></span>"),e=k("<a tabindex='-1' href='javascript:void(\"open\")'  onmousedown='return false;' class='"+this.get("prefixCls")+"combobox-button'>&#x25BC;</a>").unselectable();this.__set("container",b);this.__set("button",e)},renderUI:function(){var b=this.get("container"),e=this.get("button"),n=this.get("el").parent();b.appendTo(n).append(this.get("el")).append(e)},
_setFocused:function(b){i.superclass._setFocused.apply(this,arguments);this.get("container")[b?"addClass":"removeClass"](this.get("prefixCls")+"combobox-focused")},destructor:function(){this.get("container").remove()}},{ATTRS:{container:{},button:{}}})},{requires:["uibase","./inputRender","node"]});
KISSY.add("autocomplete",function(l,m,g,f,k,i,b){g.Menu=m;g.LocalDataSource=f;g.RemoteDataSource=k;g.Basic=i;g.BasicComboBox=b;return g},{requires:["autocomplete/menu","autocomplete/input","autocomplete/localDataSource","autocomplete/remoteDataSource","autocomplete/basic","autocomplete/BasicComboBox"]});
KISSY.add("autocomplete/basic",function(l,m,g,f,k,i){return m.create(g,[],{__CLASS:"AutoComplete.Basic",initializer:function(){var b,e;if(!this.get("dataSource")){b=(e=this.get("data"))?new k({data:e,dataSourceCfg:this.get("dataSourceCfg")}):new i({xhrCfg:this.get("xhrCfg"),dataSourceCfg:this.get("dataSourceCfg")});this.__set("dataSource",b)}if(!this.get("menu")){b=new f({prefixCls:this.get("prefixCls")});this.__set("menu",b)}}},{ATTRS:{destroyMenu:{value:true},data:{},xhrCfg:{value:{}},dataSourceCfg:{value:{}}}})},
{requires:["uibase","./input","./menu","./localDataSource","./remoteDataSource"]});
KISSY.add("autocomplete/input",function(l,m,g,f,k,i,b,e){function n(a){if(a.get("multiple")&&a.get("alignWithCursor")){var c=a._getInputDesc(),d=c.tokens,h=a.get("menu"),o=c.cursorPosition;c=c.tokenIndex;a=a.get("el");d=d.slice(0,c).join("").length;d>0&&++d;a.prop("selectionStart",d);a.prop("selectionEnd",d);d=a.prop("KsCursorOffset");a.prop("selectionStart",o);a.prop("selectionEnd",o);h.set("xy",[d.left,d.top])}else{h=a.get("menu");o=a.get("menuCfg")||{};h.set("align",l.merge({node:a.get("el")},
v,o.align))}}var j,p=m.KeyCodes,v={points:["bl","tl"],overflow:{failX:1,failY:1,adjustX:1,adjustY:1}};j=g.create(f.Controller,[],{__CLASS:"AutoComplete",_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("el").on("valuechange",this._onValueChange,this)},sendRequest:function(a){this.get("dataSource").fetchData(a,this._renderData,this)},_onValueChange:function(){if(!this._stopNotify){var a=this._getValue();if(a===e)(a=this.get("menu"))&&a.hide();else{this._savedInputValue=a;this.sendRequest(a)}}},
_handleBlur:function(){j.superclass._handleBlur.apply(this,arguments);var a=this.get("menu");a&&a._hideForAutoComplete()},_renderData:function(a){var c=this.get("menu");c.removeChildren(true);if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));var d=this.get("menuCfg")||{};c.set("width",d.width===e?this.get("el").css("width"):d.width);var h;h=this.get("format")?this.get("format").call(this,this._getValue(),a):[];for(var o=0;o<a.length;o++){d=a[o];c.addChild(new k.Item(l.mix({prefixCls:this.get("prefixCls")+
"autocomplete-",content:d,textContent:d,value:d},h[o])))}this._showMenu()}else c.hide()},_showMenu:function(){var a=this.get("menu");a._input=this;a._clearDismissTimer();n(this);a.show();for(var c=a.get("children"),d=this._getValue(),h=0;h<c.length;h++)if(c[h].get("textContent")==d){a.set("highlightedItem",c[h]);return}this.get("autoHighlight")&&c.length&&a.set("highlightedItem",c[0])},_onWindowResize:function(){n(this)},_handleKeyEventInternal:function(a){this.get("el");var c=this.get("menu");if(c){var d=
this.get("updateInputOnDownUp");if(d)this._stopNotify=l.inArray(a.keyCode,[p.UP,p.DOWN,p.ESC])?1:0;if(c.get("visible")){var h=c._handleKeydown(a);d&&l.inArray(a.keyCode,[p.DOWN,p.UP])&&this._setValue(c.get("activeItem").get("textContent"));if(a.keyCode==p.ESC){c.hide();d&&this._setValue(this._savedInputValue);return true}if(a.keyCode==p.TAB)if(a=c.get("activeItem")){a._performInternal();if(this.get("multiple"))return true}return h}else if((a.keyCode==p.DOWN||a.keyCode==p.UP)&&this.get("reFetchOnDownUp")){this.sendRequest(this._getValue());
return true}}},_uiSetSelectedItem:function(a){if(a){var c=a.get("textContent");this._setValue(c);this._savedInputValue=c;this.fire("select",{value:a.get("value"),content:a.get("content"),textContent:c})}},_getValue:function(){var a=this.get("el").val();if(this.get("multiple")){var c=this._getInputDesc();a=c.tokens;c=c.tokenIndex;var d=this.get("separator");if((a=a[c]||"")&&d.indexOf(a.charAt(0))!=-1)return a.substring(1);if(this.get("autoCompleteOnInitial")&&(c==0||c==-1))return a;return e}else return a},
_setValue:function(a){var c=this.get("el");if(this.get("multiple")){var d=this._getInputDesc(),h=d.tokens;d=d.tokenIndex;var o=this.get("separator"),u=this.get("appendSeparatorOnComplete"),q=h[d];h[d]=o.indexOf(q.charAt(0))!=-1?q.charAt(0):"";h[d]+=a;a=h[d+1];if(u&&(!a||o.indexOf(a.charAt(0))==-1))h[d]+=o.charAt(0);a=h.slice(0,d+1).join("").length;c.val(h.join(""));c.prop("selectionStart",a);c.prop("selectionEnd",a)}else c.val(a)},_getInputDesc:function(){var a=this.get("el"),c=a.val(),d=[],h=[],
o=this.get("literal"),u=this.get("separator"),q=false,w=this.get("whitespace");a=a.prop("selectionStart");for(var r=-1,s=0;s<c.length;s++){var t=c.charAt(s);if(s==a)r=d.length;if(!q){if(!w&&/\s|\xa0/.test(t)){d.push(h.join(""));h=[]}if(u.indexOf(t)!=-1){d.push(h.join(""));h=[]}}if(o)if(t==o)q=!q;h.push(t)}h.length&&d.push(h.join(""));if(r==-1)r=d.length-1;return{tokens:d,cursorPosition:a,tokenIndex:r}},destructor:function(){this.get("menu").detachInput(this,this.get("destroyMenu"));this.__set("menu",
null)}},{ATTRS:{focusable:{value:true},handleMouseEvents:{value:false},allowTextSelection_:{value:true},destroyMenu:{value:false},menu:{setter:function(a){a&&a.attachInput(this)}},ariaOwns:{view:true},ariaExpanded:{view:true},dataSource:{},maxItemCount:{value:99999},menuCfg:{value:{}},format:{},selectedItem:{},multiple:{},separator:{value:",;"},whitespace:{value:true},appendSeparatorOnComplete:{value:true},updateInputOnDownUp:{value:true},reFetchOnDownUp:{value:true},literal:{value:'"'},autoCompleteOnInitial:{value:true},
alignWithCursor:{},autoHighlight:{}},DefaultRender:i});f.UIStore.setUIByClass("autocomplete-input",{priority:f.UIStore.PRIORITY.LEVEL1,ui:j});return j},{requires:["event","uibase","component","menu","./inputRender","input-selection"]});
KISSY.add("autocomplete/inputRender",function(l,m,g){return m.create(g.Render,[],{renderUI:function(){this.get("el").attr({"aria-haspopup":true,"aria-autocomplete":"list",autocomplete:"off",role:"combobox"})},_uiSetAriaOwns:function(f){this.get("el").attr("aria-owns",f)},_uiSetAriaExpanded:function(f){this.get("el").attr("aria-expanded",f)}},{ATTRS:{ariaOwns:{},ariaExpanded:{},elTagName:{value:"input"}}})},{requires:["uibase","component"]});
KISSY.add("autocomplete/localDataSource",function(l){function m(){m.superclass.constructor.apply(this,arguments)}function g(f,k){var i=[],b=0;if(!f)return k;l.each(k,function(e){e.indexOf(f)!=-1&&i.push(e);b++});return i}m.ATTRS={data:{value:[]},dataSourceCfg:{value:{}}};l.extend(m,l.Base,{fetchData:function(f,k,i){var b=this.get("dataSourceCfg").parse||g,e=this.get("data");e=b(f,e);k.call(i,e)}});return m});
KISSY.add("autocomplete/menu",function(l,m,g,f,k,i){g=g.create(k.PopupMenu,{__CLASS:"AutoComplete.Menu",_input:null,_inputs:null,attachInput:function(b){this._inputs=this._inputs||[];l.inArray(b,this._inputs)||this._inputs.push(b)},detachInput:function(b,e){var n=this._inputs,j=l.indexOf(b,n||[]);j!=-1&&n.splice(j,1);if(e&&(!n||n.length==0))this.destroy()},bindUI:function(){var b=this;b.on("show",function(){var j=b._input;j.set("ariaOwns",b.get("el").attr("id"));j.set("ariaExpanded",true)});b.on("hide",
function(){var j=b._input;j.set("ariaOwns",b.get("el").attr("id"));j.set("ariaExpanded",false)});b.on("click",function(j){j=j.target;var p=b._input;p._stopNotify=1;p.set("selectedItem",j);b.hide();setTimeout(function(){p._stopNotify=0},50)});var e=l.buffer(function(){var j=this._input;j&&this.get("visible")&&j._onWindowResize()},50);b.__reAlign=e;m.on(window,"resize",e,b);e=b.get("el");var n=b.get("contentEl");e.on("focusin",function(){b._clearDismissTimer()});e.on("focusout",function(){b._hideForAutoComplete()});
n.on("mouseover",function(){b._input.get("el")[0].focus();b._clearDismissTimer()})},_clearDismissTimer:function(){if(this._dismissTimer){clearTimeout(this._dismissTimer);this._dismissTimer=null}},_hideForAutoComplete:function(){var b=this;b._dismissTimer=setTimeout(function(){b._immediateHideForAutoComplete()},30)},_immediateHideForAutoComplete:function(){this.removeChildren(true);this.hide()},destructor:function(){m.remove(window,"resize",this.__reAlign,this);l.each(this._inputs,function(b){b.__set("menu",
null)});this._inputs=null}},{DefaultRender:i,ATTRS:{head:{view:true},foot:{view:true}}});f.UIStore.setUIByClass("autocomplete-menu",{priority:f.UIStore.PRIORITY.LEVEL1,ui:g});return g},{requires:["event","uibase","component","menu","./menuRender"]});
KISSY.add("autocomplete/menuRender",function(l,m,g){var f=l.all;return m.create(g.PopupMenu.Render,[],{createDom:function(){var k=this.get("el"),i=f("<div class='"+this.get("prefixCls")+"autocomplete-menu-header'></div>"),b=f("<div class='"+this.get("prefixCls")+"autocomplete-menu-footer'></div>");k.prepend(i);k.append(b);this.__set("head",i);this.__set("foot",b)}},{ATTRS:{head:{view:true},foot:{view:true}}})},{requires:["uibase","menu"]});
KISSY.add("autocomplete/remoteDataSource",function(l,m){function g(){g.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}g.ATTRS={dataSourceCfg:{value:{}},xhrCfg:{value:{}}};l.extend(g,l.Base,{fetchData:function(f,k,i){var b=this,e,n=b.get("dataSourceCfg");if(b.io){b.io.abort();b.io=null}if(!f&&n.allowEmpty!==true)return k.call(i,[]);if(n.cache)if(e=b.caches[f])return k.call(i,e);e=b.get("xhrCfg");e.data=e.data||{};e.data[n.paramName]=f;e.success=function(j){if(n.parse)j=n.parse(f,
j);b.__set("data",j);if(n.cache)b.caches[f]=j;k.call(i,j)};b.io=m(e)}});return g},{requires:["ajax"]});
