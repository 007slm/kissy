/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("imagezoom/zoomer",function(i,l,f){function j(){var a;if((a=this.get("bigImageSrc"))&&this.get("preload"))(new Image).src=a;this._isInner=this.get("type")===m;o=new l(document.body)}function r(a){a&&a.show()}function s(a){a&&a.hide()}function k(a,b){var c=a[0];c&&c.complete&&c.clientWidth?b():a.on("load",b)}var m="inner",p=/^.+\.(?:jpg|png|gif)$/i,d=Math.round,t=Math.min,o;j.ATTRS={width:{valueFn:function(){return this.get("imageWidth")}},height:{valueFn:function(){return this.get("imageHeight")}},
elCls:{value:"ks-imagezoom-viewer"},elStyle:{value:{overflow:"hidden",position:"absolute"}},type:{value:"standard"},preload:{value:true},bigImageSrc:{setter:function(a){if(a&&p.test(a))return a;return this.get("bigImageSrc")},valueFn:function(){var a=this.get("imageNode");if(a)if((a=a.attr("data-ks-imagezoom"))&&p.test(a))return a;return f}},bigImageWidth:{valueFn:function(){var a=this.bigImage;return(a=a&&a.width())||800}},bigImageHeight:{valueFn:function(){var a=this.bigImage;return(a=a&&a.height())||
800}},currentMouse:{value:f},lensClass:{value:"ks-imagezoom-lens"},lensHeight:{value:f},lensWidth:{value:f},lensTop:{value:f},lensLeft:{value:f}};j.HTML_PARSER={};i.augment(j,{__renderUI:function(){var a=this,b;a.viewer=a.get("contentEl");b=a.bigImage=(new l('<img src="'+a.get("bigImageSrc")+'" />')).css("position","absolute").appendTo(a.viewer);a._setLensSize();a._setLensOffset();if(a._isInner){a.set("align",{node:a.image,points:["cc","cc"]});a._bigImageCopy=(new l('<img src="'+a.image.attr("src")+
'"  />')).css("position","absolute").width(a.get("bigImageWidth")).height(a.get("bigImageHeight")).prependTo(a.viewer)}else a.lens=(new l('<div class="'+a.get("lensClass")+'"></div>')).css("position","absolute").appendTo(o).hide();a.viewer.appendTo(a.get("el"));a.loading();k(b,function(){a.unloading();a._setLensSize();a.set("bigImageWidth",b.width());a.set("bigImageHeight",b.height())})},__bindUI:function(){var a=this;a.on("afterVisibleChange",function(b){if(b.newVal){a._isInner&&a._anim(0.4,42);
o.on("mousemove",a._mouseMove,a)}else{s(a.lens);o.detach("mousemove",a._mouseMove,a)}})},__syncUI:function(){},__destructor:function(){this.viewer.remove();this.lens.remove()},_setLensSize:function(){var a=this.get("imageWidth"),b=this.get("imageHeight"),c=this.get("bigImageWidth"),g=this.get("bigImageHeight"),e=this.get("width"),q=this.get("height");this.set("lensWidth",t(d(e*a/c),a));this.set("lensHeight",t(d(q*b/g),b))},_setLensOffset:function(a){a=a||this.get("currentMouse");var b=this.get("imageLeft"),
c=this.get("imageTop"),g=this.get("imageWidth"),e=this.get("imageHeight");this.get("width");this.get("height");var q=this.get("lensWidth"),n=this.get("lensHeight"),h=a.pageX-q/2;a=a.pageY-n/2;if(h<=b)h=b;else if(h>=g+b-q)h=g+b-q;if(a<=c)a=c;else if(a>=e+c-n)a=e+c-n;this.set("lensLeft",h);this.set("lensTop",a)},_mouseMove:function(a){var b=this.get("imageLeft"),c=this.get("imageTop"),g=this.get("imageWidth"),e=this.get("imageHeight");a.pageX>b&&a.pageX<b+g&&a.pageY>c&&a.pageY<c+e?this.set("currentMouse",
a):this.hide()},_anim:function(a,b){var c=this,g,e=1;g=c.get("imageLeft");var q=c.get("imageTop"),n=c.get("imageWidth"),h=c.get("imageHeight"),x=c.get("bigImageWidth"),y=c.get("bigImageHeight"),z=-d((c.get("lensLeft")-g)*x/n),A=-d((c.get("lensTop")-q)*y/h),u,v,w;c._animTimer&&c._animTimer.cancel();c.bigImage.width(n).height(h);c._bigImageCopy.width(n).height(h);c._animTimer=i.later(g=function(){u=n+(x-n)/b*e;v=h+(y-h)/b*e;w={left:z/b*e,top:A/b*e};c.bigImage.width(u).height(v).css(w);c._bigImageCopy.width(u).height(v).css(w);
if(++e>b){c._animTimer.cancel();c._animTimer=f}},a*1E3/b,true);g()},_uiSetCurrentMouse:function(a){if(!(!this.bigImage||this._animTimer)){r(this.lens);this._setLensOffset(a);a={left:-d((this.get("lensLeft")-this.get("imageLeft"))*this.get("bigImageWidth")/this.get("imageWidth")),top:-d((this.get("lensTop")-this.get("imageTop"))*this.get("bigImageHeight")/this.get("imageHeight"))};this._bigImageCopy&&this._bigImageCopy.css(a);this.bigImage.css(a)}},_uiSetLensWidth:function(a){this.lens&&this.lens.width(a)},
_uiSetLensHeight:function(a){this.lens&&this.lens.height(a)},_uiSetLensTop:function(a){this.lens&&this.lens.offset({top:a})},_uiSetLensLeft:function(a){this.lens&&this.lens.offset({left:a})},_uiSetBigImageWidth:function(a){a&&this.bigImage&&this.bigImage.width(a);a&&this._bigImageCopy&&this._bigImageCopy.width(a)},_uiSetBigImageHeight:function(a){a&&this.bigImage&&this.bigImage.height(a);a&&this._bigImageCopy&&this._bigImageCopy.height(a)},_uiSetBigImageSrc:function(a){a&&this.bigImage&&this.bigImage.attr("src",
a);a&&this._bigImageCopy&&this._bigImageCopy.attr("src",a)},changeImageSrc:function(a){this.image.attr("src",a);this.loading()},refreshRegion:function(){this._fresh=this.get("align");this.set("align",f)}});j.__imgOnLoad=k;return j},{requires:["node"]});
KISSY.add("imagezoom/base",function(i,l,f,j,r,s,k,m,p){function d(a){return i.require("uibase/"+a)}function t(a){a&&a.show()}function o(a){a&&a.hide()}return s.create([d("boxrender"),d("contentboxrender"),d("positionrender"),d("loadingrender"),j.ie==6?d("shimrender"):null,d("align"),d("maskrender"),m],{initializer:function(){var a=this,b;(b=a.image=a.get("imageNode"))&&m.__imgOnLoad(b,function(){if(!a.imageWrap){a._render();a._bind()}})},destructor:function(){this.image.detach()},_render:function(){var a=
this.image,b=a.parent();if(b.css("display")!=="inline")b=a;(this.imageWrap=(new k(i.substitute("<div class='{wrapClass}'></div>",{wrapClass:this.get("wrapClass")}))).insertBefore(b)).prepend(b);if(this.get("showIcon")){this.icon=new k(i.substitute("<span class='{iconClass}'></span>",{iconClass:this.get("iconClass")}));this.imageWrap.append(this.icon)}},_bind:function(){var a=this,b;a.image.on("mouseenter",function(c){if(a.get("hasZoom"))b=i.later(function(){a.set("currentMouse",c);if(a._fresh){a.set("align",
a._fresh);a._fresh=p}a.show();b=p},50)}).on("mouseleave",function(){if(b){b.cancel();b=p}});a.on("afterVisibleChange",function(c){c.newVal?o(a.icon):t(a.icon)})},_uiSetHasZoom:function(a){a?t(this.icon):o(this.icon)}},{ATTRS:{imageNode:{setter:function(a){return k.one(a)}},wrapClass:{value:"ks-imagezoom-wrap"},imageWidth:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.width())||400}},imageHeight:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.height())||400}},imageLeft:{valueFn:function(){var a=
this.get("imageNode");return(a=a&&a.offset().left)||400}},imageTop:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.offset().top)||400}},hasZoom:{value:true,setter:function(a){return!!a}},showIcon:{value:true},iconClass:{value:"ks-imagezoom-icon"}}})},{requires:["dom","event","ua","anim","uibase","node","imagezoom/zoomer"]});
KISSY.add("imagezoom/autorender",function(i,l,f,j){j.autoRender=function(r,s){r="."+(r||"KS_Widget");l.query(r,s).each(function(k){var m;if(k.getAttribute("data-widget-type")==="ImageZoom")try{if(m=k.getAttribute("data-widget-config"))m=m.replace(/'/g,'"');new j(k,f.parse(m))}catch(p){}})}},{requires:["dom","json","imagezoom/base"]});KISSY.add("imagezoom",function(i,l){return i.ImageZoom=l},{requires:["imagezoom/base","imagezoom/autorender"]});
