/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 4 13:50
*/
KISSY.add("imagezoom/autorender",function(d,g,h,e){e.autoRender=function(j,k){d.each(g.query("."+(j||"KS_Widget"),k),function(f){var d;if("ImageZoom"===f.getAttribute("data-widget-type"))try{(d=f.getAttribute("data-widget-config"))&&(d=d.replace(/'/g,'"')),new e(f,h.parse(d))}catch(a){}})}},{requires:["dom","json","imagezoom/base"]});
KISSY.add("imagezoom/base",function(d,g,h,e,j,k,f,l,a){function b(a){return d.require("uibase/"+a)}return k.create([b("boxrender"),b("contentboxrender"),b("positionrender"),b("loadingrender"),6==e.ie?b("shimrender"):null,b("align"),b("maskrender"),l],{initializer:function(){var a=this,b;(b=a.image=a.get("imageNode"))&&l.__imgOnLoad(b,function(){a.imageWrap||(a._render(),a._bind())})},destructor:function(){this.image.detach()},show:function(){this.render();this.set("visible",!0)},hide:function(){this.set("visible",
!1)},_render:function(){var a=this.image,b=a.parent();"inline"!==b.css("display")&&(b=a);this.imageWrap=(new f(d.substitute("<div class='{wrapClass}'></div>",{wrapClass:this.get("wrapClass")}))).insertBefore(b);this.imageWrap.prepend(b);this.get("showIcon")&&(this.icon=new f(d.substitute("<span class='{iconClass}'></span>",{iconClass:this.get("iconClass")})),this.imageWrap.append(this.icon))},_bind:function(){var c=this,b;c.image.on("mouseenter",function(i){!b&&c.get("hasZoom")&&(b=d.later(function(){c.set("currentMouse",
i);c._fresh&&(c.set("align",c._fresh),c._fresh=a);c.show();b=a},50))}).on("mouseleave",function(){b&&(b.cancel(),b=a)});c.on("afterVisibleChange",function(a){a.newVal?(a=c.icon)&&a.hide():(a=c.icon)&&a.show()})},_uiSetHasZoom:function(a){a?(a=this.icon)&&a.show():(a=this.icon)&&a.hide()}},{ATTRS:{imageNode:{setter:function(a){return f.one(a)}},wrapClass:{value:"ks-imagezoom-wrap"},width:{valueFn:function(){return this.get("imageWidth")}},height:{valueFn:function(){return this.get("imageHeight")}},
imageWidth:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.width())||400}},imageHeight:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.height())||400}},imageLeft:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.offset().left)||400}},imageTop:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.offset().top)||400}},hasZoom:{value:!0,setter:function(a){return!!a}},showIcon:{value:!0},iconClass:{value:"ks-imagezoom-icon"},prefixCls:{value:"ks-"}}})},
{requires:"dom,event,ua,anim,uibase,node,./zoomer".split(",")});KISSY.add("imagezoom",function(d,g){return g},{requires:["imagezoom/base","imagezoom/autorender"]});
KISSY.add("imagezoom/zoomer",function(d,g,h){function e(){var a;!this.get("bigImageWidth")||this.get("bigImageHeight");if((a=this.get("bigImageSrc"))&&this.get("preload"))(new Image).src=a;this._isInner=this.get("type")===k}function j(a,b){var c=a[0];c&&c.complete&&c.clientWidth?b():c.onload=function(){setTimeout(b,100)}}var k="inner",f=Math.round,l=Math.min;e.ATTRS={elCls:{value:"ks-imagezoom-viewer"},elStyle:{value:{overflow:"hidden",position:"absolute"}},type:{value:"standard"},preload:{value:!0},
bigImageSrc:{valueFn:function(){var a=this.get("imageNode");if(a)return a.attr("data-ks-imagezoom")}},bigImageWidth:{},bigImageHeight:{},currentMouse:{value:h},lensClass:{value:"ks-imagezoom-lens"},lensHeight:{},lensWidth:{},lensTop:{},lensLeft:{}};e.HTML_PARSER={};d.augment(e,{__renderUI:function(){var a=this,b;a.viewer=a.get("contentEl");b=a.bigImage=(new g('<img src="'+a.get("bigImageSrc")+'" />')).css("position","absolute").appendTo(a.viewer,h);a._setLensSize();a._setLensOffset();a._isInner?(a.set("align",
{node:a.image,points:["cc","cc"]}),a._bigImageCopy=(new g('<img src="'+a.image.attr("src")+'" width="'+a.get("bigImageWidth")+'" height="'+a.get("bigImageHeight")+'"/>')).css("position","absolute").prependTo(a.viewer,h)):a.lens=(new g('<div class="'+a.get("lensClass")+'"></div>')).css("position","absolute").appendTo(d.one("body"),h).hide();a.loading();j(b,function(){a.unloading();if(a._bigImageCopy){a._bigImageCopy.remove();a._bigImageCopy=null}})},__bindUI:function(){var a=this,b=d.one("body");a.on("afterVisibleChange",
function(c){c.newVal?(a._isInner&&a._anim(0.4),b.on("mousemove",a._mouseMove,a)):((c=a.lens)&&c.hide(),b.detach("mousemove",a._mouseMove,a))})},__syncUI:function(){},__destructor:function(){this.lens.remove()},_setLensSize:function(){var a=this.get("imageWidth"),b=this.get("imageHeight"),c=this.get("bigImageWidth"),d=this.get("bigImageHeight"),i=this.get("imageWidth"),e=this.get("imageHeight");this.set("lensWidth",l(f(i*a/c),a));this.set("lensHeight",l(f(e*b/d),b))},_setLensOffset:function(a){var a=
a||this.get("currentMouse"),b=this.get("imageLeft"),c=this.get("imageTop"),d=this.get("imageWidth"),i=this.get("imageHeight"),f=this.get("lensWidth"),e=this.get("lensHeight"),g=a.pageX-f/2,a=a.pageY-e/2;g<=b?g=b:g>=d+b-f&&(g=d+b-f);a<=c?a=c:a>=i+c-e&&(a=i+c-e);this.set("lensLeft",g);this.set("lensTop",a)},_mouseMove:function(a){var b=this.get("imageLeft"),c=this.get("imageTop"),d=this.get("imageWidth"),f=this.get("imageHeight");a.pageX>b&&a.pageX<b+d&&a.pageY>c&&a.pageY<c+f?this.set("currentMouse",
a):this.hide()},_anim:function(a){var b=this.get("imageLeft"),c=this.get("imageTop"),d=this.get("imageWidth"),e=this.get("imageHeight"),g=this.get("bigImageWidth"),h=this.get("bigImageHeight"),b=-f((this.get("lensLeft")-b)*g/d),c=-f((this.get("lensTop")-c)*h/e);this.bigImage.stop();this.bigImage.css({width:d,height:e,left:0,top:0});this._bigImageCopy&&this._bigImageCopy.css({width:d,height:e,left:0,top:0});d+=g-d;e+=h-e;this.bigImage.animate({width:d,height:e,left:b,top:c},a);this._bigImageCopy&&
this._bigImageCopy.animate({width:d,height:e,left:b,top:c},a)},_uiSetCurrentMouse:function(a){if(this.bigImage&&!this.bigImage.isRunning()){var b=this.lens;b&&b.show();this._setLensOffset(a);a={left:Math.max(-f((this.get("lensLeft")-this.get("imageLeft"))*this.get("bigImageWidth")/this.get("imageWidth")),this.get("width")-this.get("bigImageWidth")),top:Math.max(-f((this.get("lensTop")-this.get("imageTop"))*this.get("bigImageHeight")/this.get("imageHeight")),this.get("height")-this.get("bigImageHeight"))};
this._bigImageCopy&&this._bigImageCopy.css(a);this.bigImage.css(a)}},_uiSetLensWidth:function(a){this.lens&&this.lens.width(a)},_uiSetLensHeight:function(a){this.lens&&this.lens.height(a)},_uiSetLensTop:function(a){this.lens&&this.lens.offset({top:a})},_uiSetLensLeft:function(a){this.lens&&this.lens.offset({left:a})},_uiSetBigImageWidth:function(a){a&&this.bigImage&&this.bigImage.width(a);a&&this._bigImageCopy&&this._bigImageCopy.width(a)},_uiSetBigImageHeight:function(a){a&&this.bigImage&&this.bigImage.height(a);
a&&this._bigImageCopy&&this._bigImageCopy.height(a)},_uiSetBigImageSrc:function(a){a&&this.bigImage&&this.bigImage.attr("src",a)},changeImageSrc:function(a){this.image.attr("src",a);this.loading()},refreshRegion:function(){this._fresh=this.get("align");this.set("align",h)}});e.__imgOnLoad=j;return e},{requires:["node"]});
