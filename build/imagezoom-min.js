/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 2 10:12
*/
KISSY.add("imagezoom/autorender",function(e,h,f,i){i.autoRender=function(m,n){e.each(h.query("."+(m||"KS_Widget"),n),function(e){var g;if("ImageZoom"===e.getAttribute("data-widget-type"))try{(g=e.getAttribute("data-widget-config"))&&(g=g.replace(/'/g,'"')),new i(e,f.parse(g))}catch(h){}})}},{requires:["dom","json","imagezoom/base"]});
KISSY.add("imagezoom/base",function(e,h,f,i,m,n,j,g,l){function d(a){return e.require("uibase/"+a)}return n.create([d("boxrender"),d("contentboxrender"),d("positionrender"),d("loadingrender"),6==i.ie?d("shimrender"):null,d("align"),d("maskrender"),g],{initializer:function(){var a=this,b;(b=a.image=a.get("imageNode"))&&g.__imgOnLoad(b,function(){a.imageWrap||(a._render(),a._bind())})},destructor:function(){this.image.detach()},_render:function(){var a=this.image,b=a.parent();"inline"!==b.css("display")&&
(b=a);this.imageWrap=(new j(e.substitute("<div class='{wrapClass}'></div>",{wrapClass:this.get("wrapClass")}))).insertBefore(b);this.imageWrap.prepend(b);this.get("showIcon")&&(this.icon=new j(e.substitute("<span class='{iconClass}'></span>",{iconClass:this.get("iconClass")})),this.imageWrap.append(this.icon))},_bind:function(){var a=this,b;a.image.on("mouseenter",function(c){a.get("hasZoom")&&(b=e.later(function(){a.set("currentMouse",c);a._fresh&&(a.set("align",a._fresh),a._fresh=l);a.show();b=
l},50))}).on("mouseleave",function(){b&&(b.cancel(),b=l)});a.on("afterVisibleChange",function(b){b.newVal?(b=a.icon)&&b.hide():(b=a.icon)&&b.show()})},_uiSetHasZoom:function(a){a?(a=this.icon)&&a.show():(a=this.icon)&&a.hide()}},{ATTRS:{imageNode:{setter:function(a){return j.one(a)}},wrapClass:{value:"ks-imagezoom-wrap"},imageWidth:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.width())||400}},imageHeight:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.height())||400}},
imageLeft:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.offset().left)||400}},imageTop:{valueFn:function(){var a=this.get("imageNode");return(a=a&&a.offset().top)||400}},hasZoom:{value:!0,setter:function(a){return!!a}},showIcon:{value:!0},iconClass:{value:"ks-imagezoom-icon"},prefixCls:{value:"ks-"}}})},{requires:"dom,event,ua,anim,uibase,node,imagezoom/zoomer".split(",")});KISSY.add("imagezoom",function(e,h){return h},{requires:["imagezoom/base","imagezoom/autorender"]});
KISSY.add("imagezoom/zoomer",function(e,h,f){function i(){var a;if((a=this.get("bigImageSrc"))&&this.get("preload"))(new Image).src=a;this._isInner=this.get("type")===n;d=new h(e.Env.host.document.body)}function m(a,b){var c=a[0];c&&c.complete&&c.clientWidth?b():c.onLoad=function(){setTimeout(b,100)}}var n="inner",j=/^.+\.(?:jpg|png|gif)$/i,g=Math.round,l=Math.min,d;i.ATTRS={width:{valueFn:function(){return this.get("imageWidth")}},height:{valueFn:function(){return this.get("imageHeight")}},elCls:{value:"ks-imagezoom-viewer"},
elStyle:{value:{overflow:"hidden",position:"absolute"}},type:{value:"standard"},preload:{value:!0},bigImageSrc:{setter:function(a){return a&&j.test(a)?a:this.get("bigImageSrc")},valueFn:function(){var a=this.get("imageNode");return a&&(a=a.attr("data-ks-imagezoom"))&&j.test(a)?a:f}},bigImageWidth:{valueFn:function(){var a=this.bigImage;return(a=a&&a.width())||800}},bigImageHeight:{valueFn:function(){var a=this.bigImage;return(a=a&&a.height())||800}},currentMouse:{value:f},lensClass:{value:"ks-imagezoom-lens"},
lensHeight:{value:f},lensWidth:{value:f},lensTop:{value:f},lensLeft:{value:f}};i.HTML_PARSER={};e.augment(i,{__renderUI:function(){var a=this,b;a.viewer=a.get("contentEl");b=a.bigImage=(new h('<img src="'+a.get("bigImageSrc")+'" />')).css("position","absolute").appendTo(a.viewer);a._setLensSize();a._setLensOffset();a._isInner?(a.set("align",{node:a.image,points:["cc","cc"]}),a._bigImageCopy=(new h('<img src="'+a.image.attr("src")+'"  />')).css("position","absolute").width(a.get("bigImageWidth")).height(a.get("bigImageHeight")).prependTo(a.viewer)):
a.lens=(new h('<div class="'+a.get("lensClass")+'"></div>')).css("position","absolute").appendTo(d).hide();a.viewer.appendTo(a.get("el"));a.loading();m(b,function(){a.unloading();a._setLensSize();a.set("bigImageWidth",b.width());a.set("bigImageHeight",b.height())})},__bindUI:function(){var a=this;a.on("afterVisibleChange",function(b){b.newVal?(a._isInner&&a._anim(0.4,42),d.on("mousemove",a._mouseMove,a)):((b=a.lens)&&b.hide(),d.detach("mousemove",a._mouseMove,a))})},__syncUI:function(){},__destructor:function(){this.viewer.remove();
this.lens.remove()},_setLensSize:function(){var a=this.get("imageWidth"),b=this.get("imageHeight"),c=this.get("bigImageWidth"),e=this.get("bigImageHeight"),d=this.get("width"),f=this.get("height");this.set("lensWidth",l(g(d*a/c),a));this.set("lensHeight",l(g(f*b/e),b))},_setLensOffset:function(a){var a=a||this.get("currentMouse"),b=this.get("imageLeft"),c=this.get("imageTop"),e=this.get("imageWidth"),g=this.get("imageHeight");this.get("width");this.get("height");var d=this.get("lensWidth"),f=this.get("lensHeight"),
k=a.pageX-d/2,a=a.pageY-f/2;k<=b?k=b:k>=e+b-d&&(k=e+b-d);a<=c?a=c:a>=g+c-f&&(a=g+c-f);this.set("lensLeft",k);this.set("lensTop",a)},_mouseMove:function(a){var b=this.get("imageLeft"),c=this.get("imageTop"),e=this.get("imageWidth"),d=this.get("imageHeight");a.pageX>b&&a.pageX<b+e&&a.pageY>c&&a.pageY<c+d?this.set("currentMouse",a):this.hide()},_anim:function(a,b){var c=this,d,h=1;d=c.get("imageLeft");var i=c.get("imageTop"),j=c.get("imageWidth"),k=c.get("imageHeight"),l=c.get("bigImageWidth"),m=c.get("bigImageHeight"),
n=-g((c.get("lensLeft")-d)*l/j),r=-g((c.get("lensTop")-i)*m/k),o,p,q;c._animTimer&&c._animTimer.cancel();c.bigImage.width(j).height(k);c._bigImageCopy.width(j).height(k);c._animTimer=e.later(d=function(){o=j+(l-j)/b*h;p=k+(m-k)/b*h;q={left:n/b*h,top:r/b*h};c.bigImage.width(o).height(p).css(q);c._bigImageCopy.width(o).height(p).css(q);++h>b&&(c._animTimer.cancel(),c._animTimer=f)},1E3*a/b,!0);d()},_uiSetCurrentMouse:function(a){if(this.bigImage&&!this._animTimer){var b=this.lens;b&&b.show();this._setLensOffset(a);
a={left:-g((this.get("lensLeft")-this.get("imageLeft"))*this.get("bigImageWidth")/this.get("imageWidth")),top:-g((this.get("lensTop")-this.get("imageTop"))*this.get("bigImageHeight")/this.get("imageHeight"))};this._bigImageCopy&&this._bigImageCopy.css(a);this.bigImage.css(a)}},_uiSetLensWidth:function(a){this.lens&&this.lens.width(a)},_uiSetLensHeight:function(a){this.lens&&this.lens.height(a)},_uiSetLensTop:function(a){this.lens&&this.lens.offset({top:a})},_uiSetLensLeft:function(a){this.lens&&this.lens.offset({left:a})},
_uiSetBigImageWidth:function(a){a&&this.bigImage&&this.bigImage.width(a);a&&this._bigImageCopy&&this._bigImageCopy.width(a)},_uiSetBigImageHeight:function(a){a&&this.bigImage&&this.bigImage.height(a);a&&this._bigImageCopy&&this._bigImageCopy.height(a)},_uiSetBigImageSrc:function(a){a&&this.bigImage&&this.bigImage.attr("src",a);a&&this._bigImageCopy&&this._bigImageCopy.attr("src",a)},changeImageSrc:function(a){this.image.attr("src",a);this.loading()},refreshRegion:function(){this._fresh=this.get("align");
this.set("align",f)}});i.__imgOnLoad=m;return i},{requires:["node"]});
