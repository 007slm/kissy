/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Oct 27 14:29
*/
KISSY.add("mvc/base",function(f,l){return{sync:l}},{requires:["./sync"]});
KISSY.add("mvc/collection",function(f,l,m,i,j){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={model:{value:m},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:f.noop()},comparator:{},sync:{value:function(){i.sync.apply(this,arguments)}},parse:{value:function(a){return a}}};f.extend(c,j,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,d){return a(b)-a(d)})},
toJSON:function(){return f.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var d=this,e=true;if(f.isArray(a)){var h=[].concat(a);f.each(h,function(o){e=e&&d._add(o,b)})}else e=d._add(a,b);return e},remove:function(a,b){var d=this;if(f.isArray(a)){var e=[].concat(a);f.each(e,function(h){d._remove(h,b)})}else a&&d._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=true;if(!(a instanceof m)){b=a;a=new (this.get("model"));b=a.set(b,{silent:1})}return b&&
a},load:function(a){var b=this;a=a||{};var d=a.success;a.success=function(e){e&&b.set("models",b.get("parse").call(b,e),a);d&&d.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},create:function(a,b){var d=this;b=b||{};if(a=this._normModel(a)){a.addToCollection(d);var e=b.success;b.success=function(){d.add(a,b);e&&e()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){b=b||{};var d;d=this.get("models");var e=this.get("comparator"),h=d.length;if(e){var o=e(a);for(h=0;h<
d.length;h++){var s=e(d[h]);if(o<s)break}}d=h;this.get("models").splice(d,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){b=b||{};var d=f.indexOf(a,this.get("models"));if(d!=-1){this.get("models").splice(d,1);a.removeFromCollection(this)}b.silent||this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var e=b[d];if(e.getId()===a)return e}return null},getByCid:function(a){for(var b=this.get("models"),d=0;d<
b.length;d++){var e=b[d];if(e.get("clientId")===a)return e}return null}});return c},{requires:["event","./model","./base","base"]});
KISSY.add("mvc/model",function(f,l,m){function i(){i.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var j=["idAttribute","clientId","urlRoot","url","parse","sync"];f.extend(i,l,{addToCollection:function(c){this.collections[f.stamp(c)]=c;this.addTarget(c)},removeFromCollection:function(c){delete this.collections[f.stamp(c)];this.removeTarget(c)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(c){return this.set(this.get("idAttribute"),
c)},__set:function(){this.__isModified=1;return i.superclass.__set.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!!(this.isNew()||this.__isModified)},destroy:function(c){var a=this;c=c||{};var b=c.success;c.success=function(d){var e=a.collections;d&&a.set(d,c);for(var h in e){e[h].remove(a,c);a.removeFromCollection(e[h])}a.fire("destroy");b&&b.apply(this,arguments)};if(!a.isNew()&&c["delete"])a.get("sync").call(a,a,"delete",c);else{c.success();c.complete&&
c.complete()}return a},load:function(c){var a=this;c=c||{};var b=c.success;c.success=function(d){d&&a.set(a.get("parse").call(a,d),c);a.__isModified=0;b&&b.apply(this,arguments)};a.get("sync").call(a,a,"read",c);return a},save:function(c){var a=this;c=c||{};var b=c.success;c.success=function(d){d&&a.set(a.get("parse").call(a,d),c);a.__isModified=0;b&&b.apply(this,arguments)};a.get("sync").call(a,a,a.isNew()?"create":"update",c);return a},toJSON:function(){var c=this.getAttrVals();f.each(j,function(a){delete c[a]});
return c}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return f.guid("mvc-client")}},url:{value:function(){var c,a,b=this.collections;for(c in b)if(b.hasOwnProperty(c)){a=b[c];break}c=a;var d;c=c&&(d=c.get("url"))?f.isString(d)?d:d.call(c):d;d=c||this.get("urlRoot");if(this.isNew())return d;d+=d.charAt(d.length-1)=="/"?"":"/";return d+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){m.sync.apply(this,arguments)}},parse:{value:function(c){return c}}}});
return i},{requires:["base","./base"]});
KISSY.add("mvc/router",function(f,l,m){function i(g){if(g=g.match(e)){g=f.unEscapeHTML(g[1]);return f.unparam(g)}return{}}function j(g,k,q){var p=k;k=p.replace(e,"");f.each(q,function(n){var v=n.paramNames,t=n.name,u=n.callback;if(n=k.match(n.reg)){n.shift();var r={};f.each(n,function(w,x){r[v[x]]=w});n=i(p);u.apply(g,[r,n]);u={name:t,paths:r,query:n};g.fire("route:"+t,u);g.fire("route",u);return false}})}function c(g,k){var q=g,p=[];g=f.escapeRegExp(g);g=g.replace(h,function(n,v,t,u,r){p.push(t||
r);if(t)return"([^/]+)";else if(r)return"(.*)"});return{name:q,paramNames:p,reg:RegExp("^"+g+"$"),callback:k}}function a(g){this.addRoutes(g.newVal)}function b(){b.superclass.constructor.apply(this,arguments);this.__routerMap={};this.on("afterRoutesChange",a,this);this.addRoutes({newVal:this.get("routes")}.newVal)}function d(){j(this,s.hash.replace(o,""),this.__routerMap)}var e=/\?(.*)/,h=/(:([\w\d]+))|(\\\*([\w\d]+))/g,o=/^#/,s=location;b.ATTRS={routes:{}};f.extend(b,m,{addRoutes:function(g){var k=
this;f.each(g,function(q,p){k.__routerMap[p]=c(p,f.isFunction(q)?q:k[q])})},navigate:function(g,k){s.hash=g;k=k||{};k.triggerRoute&&s.hash.replace(o,"")==g&&d.call(this)},start:function(g){var k=this;g=g||{};setTimeout(function(){l.on(window,"hashchange",d,k);g.triggerRoute&&d.call(k);g.success&&g.success()},100)}});return b},{requires:["event","base"]});
KISSY.add("mvc/sync",function(f,l){var m={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(i,j,c){c=f.merge({type:m[j],dataType:"json"},c);var a=c.data=c.data||{};a._method=j;if(!c.url)c.url=f.isString(i.get("url"))?i.get("url"):i.get("url").call(i);if(j=="create"||j=="update")a.model=i.toJSON();return l(c)}},{requires:["ajax"]});
KISSY.add("mvc/view",function(f,l,m){function i(a,b){if(f.isString(b))return a[b];return b}function j(){j.superclass.constructor.apply(this,arguments);var a;if(a=this.get("events"))this._afterEventsChange({newVal:a})}var c=l.all;j.ATTRS={el:{value:"<div />",getter:function(a){if(f.isString(a)){a=c(a);this.__set("el",a)}return a}},events:{}};f.extend(j,m,{_afterEventsChange:function(a){var b=a.prevVal;b&&this._removeEvents(b);this._addEvents(a.newVal)},_removeEvents:function(a){var b=this.get("el"),
d;for(d in a){var e=a[d],h;for(h in e){var o=i(this,e[h]);b.undelegate(h,d,o,this)}}},_addEvents:function(a){var b=this.get("el"),d;for(d in a){var e=a[d],h;for(h in e){var o=i(this,e[h]);b.delegate(h,d,o,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return j},{requires:["node","base"]});KISSY.add("mvc",function(f,l,m,i,j,c){return f.mix(l,{Model:m,View:j,Collection:i,Router:c})},{requires:["mvc/base","mvc/model","mvc/collection","mvc/view","mvc/router"]});
