/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Oct 27 13:08
*/
KISSY.add("mvc/base",function(e,l){return{sync:l}},{requires:["./sync"]});
KISSY.add("mvc/collection",function(e,l,m,i,k){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={model:{value:m},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:e.noop()},comparator:{},sync:{value:function(){i.sync.apply(this,arguments)}},parse:{value:function(a){return a}}};e.extend(c,k,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,d){return a(b)-a(d)})},
toJSON:function(){return e.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var d=this,f=true;if(e.isArray(a)){var h=[].concat(a);e.each(h,function(n){f=f&&d._add(n,b)})}else f=d._add(a,b);return f},remove:function(a,b){var d=this;if(e.isArray(a)){var f=[].concat(a);e.each(f,function(h){d._remove(h,b)})}else a&&d._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=true;if(!(a instanceof m)){b=a;a=new (this.get("model"));b=a.set(b,{silent:1})}return b&&
a},load:function(a){var b=this;a=a||{};var d=a.success;a.success=function(f){f&&b.set("models",b.get("parse").call(b,f),a);d&&d.apply(this,arguments)};b.get("sync").call(b,"read",a);return b},create:function(a,b){var d=this;b=b||{};if(a=this._normModel(a)){a.addToCollection(d);var f=b.success;b.success=function(){d.add(a,b);f&&f()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){b=b||{};var d;d=this.get("models");var f=this.get("comparator"),h=d.length;if(f){var n=f(a);for(h=0;h<d.length;h++){var g=
f(d[h]);if(n<g)break}}d=h;this.get("models").splice(d,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){b=b||{};var d=e.indexOf(a,this.get("models"));if(d!=-1){this.get("models").splice(d,1);a.removeFromCollection(this)}b.silent||this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var f=b[d];if(f.getId()===a)return f}return null},getByCid:function(a){for(var b=this.get("models"),d=0;d<b.length;d++){var f=
b[d];if(f.get("clientId")===a)return f}return null}});return c},{requires:["event","./model","./base","base"]});
KISSY.add("mvc/model",function(e,l,m){function i(){i.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var k=["idAttribute","clientId","urlRoot","url","parse","sync"];e.extend(i,l,{addToCollection:function(c){this.collections[e.stamp(c)]=c;this.addTarget(c)},removeFromCollection:function(c){delete this.collections[e.stamp(c)];this.removeTarget(c)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(c){return this.set(this.get("idAttribute"),
c)},__set:function(){this.__isModified=1;return i.superclass.__set.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!!(this.isNew()||this.__isModified)},destroy:function(c){var a=this;c=c||{};var b=c.success;c.success=function(d){var f=a.collections;d&&a.set(d,c);for(var h in f){f[h].remove(a,c);a.removeFromCollection(f[h])}a.fire("destroy");b&&b.apply(this,arguments)};if(!a.isNew()&&c["delete"])a.get("sync").call(a,"delete",c);else{c.success();c.complete&&
c.complete()}return a},load:function(c){var a=this;c=c||{};var b=c.success;c.success=function(d){d&&a.set(a.get("parse").call(a,d),c);a.__isModified=0;b&&b.apply(this,arguments)};a.get("sync").call(a,"read",c);return a},save:function(c){var a=this;c=c||{};var b=c.success;c.success=function(d){d&&a.set(a.get("parse").call(a,d),c);a.__isModified=0;b&&b.apply(this,arguments)};a.get("sync").call(a,a.isNew()?"create":"update",c);return a},toJSON:function(){var c=this.getAttrVals();e.each(k,function(a){delete c[a]});
return c}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return e.guid("mvc-client")}},url:{value:function(){var c,a,b=this.collections;for(c in b)if(b.hasOwnProperty(c)){a=b[c];break}c=a;var d;c=c&&(d=c.get("url"))?e.isString(d)?d:d.call(c):d;d=c||this.get("urlRoot");if(this.isNew())return d;d+=d.charAt(d.length-1)=="/"?"":"/";return d+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){m.sync.apply(this,arguments)}},parse:{value:function(c){return c}}}});
return i},{requires:["base","./base"]});
KISSY.add("mvc/router",function(e,l,m){function i(g){if(g=g.match(d)){g=e.unEscapeHTML(g[1]);return e.unparam(g)}return{}}function k(g,j,q){var p=j;j=p.replace(d,"");e.each(q,function(o){var u=o.paramNames,s=o.name,t=o.callback;if(o=j.match(o.reg)){o.shift();var r={};e.each(o,function(v,w){r[u[w]]=v});o=i(p);t.apply(g,[r,o]);t={name:s,paths:r,query:o};g.fire("route:"+s,t);g.fire("route",t);return false}})}function c(g,j){var q=g,p=[];g=e.escapeRegExp(g);g=g.replace(f,function(o,u,s,t,r){p.push(s||
r);if(s)return"([^/]+)";else if(r)return"(.*)"});return{name:q,paramNames:p,reg:RegExp("^"+g+"$"),callback:j}}function a(){a.superclass.constructor.apply(this,arguments)}function b(){k(this,n.hash.replace(h,""),this.__routerMap)}var d=/\?(.*)/,f=/(:([\w\d]+))|(\\\*([\w\d]+))/g,h=/^#/,n=location;a.ATTRS={routes:{setter:function(g){this.__routerMap={};this.addRoutes(g)}}};e.extend(a,m,{addRoutes:function(g){var j=this;e.each(g,function(q,p){j.__routerMap[p]=c(p,e.isFunction(q)?q:j[q])})},navigate:function(g,
j){n.hash=g;j=j||{};j.triggerRoute&&n.hash.replace(h,"")==g&&b.call(this)},start:function(g){var j=this;g=g||{};setTimeout(function(){l.on(window,"hashchange",b,j);g.triggerRoute&&b.call(j);g.success&&g.success()},100)}});return a},{requires:["event","base"]});
KISSY.add("mvc/sync",function(e,l){var m={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(i,k){var c=e.merge({type:m[i],dataType:"json"},k),a=c.data=c.data||{};a._method=i;if(!c.url)c.url=e.isString(this.get("url"))?this.get("url"):this.get("url").call(this);if(i=="create"||i=="update")a.model=this.toJSON();return l(c)}},{requires:["ajax"]});
KISSY.add("mvc/view",function(e,l,m){function i(a,b){if(e.isString(b))return a[b];return b}function k(){k.superclass.constructor.apply(this,arguments);var a;if(a=this.get("events"))this._afterEventsChange({newVal:a})}var c=l.all;k.ATTRS={el:{value:"<div />",getter:function(a){if(e.isString(a)){a=c(a);this.__set("el",a)}return a}},events:{}};e.extend(k,m,{_afterEventsChange:function(a){var b=a.prevVal;b&&this._removeEvents(b);this._addEvents(a.newVal)},_removeEvents:function(a){var b=this.get("el"),
d;for(d in a){var f=a[d],h;for(h in f){var n=i(this,f[h]);b.undelegate(h,d,n,this)}}},_addEvents:function(a){var b=this.get("el"),d;for(d in a){var f=a[d],h;for(h in f){var n=i(this,f[h]);b.delegate(h,d,n,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return k},{requires:["node","base"]});KISSY.add("mvc",function(e,l,m,i,k,c){return e.mix(l,{Model:m,View:k,Collection:i,Router:c})},{requires:["mvc/base","mvc/model","mvc/collection","mvc/view","mvc/router"]});
