/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Oct 22 18:37
*/
KISSY.add("mvc/base",function(e,j){return{sync:j}},{requires:["./sync"]});
KISSY.add("mvc/collection",function(e,j,k,g,l){function b(){b.superclass.constructor.apply(this,arguments)}b.ATTRS={model:{value:k},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:e.noop()},comparator:{}};e.extend(b,l,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(c,d){return a(c)-a(d)})},toJSON:function(){return e.map(this.get("models"),function(a){return a.toJSON()})},
pluck:function(a){return e.map(this.get("models"),function(c){return c.get(a)})},sync:function(){g.sync.apply(this,arguments)},parse:function(a){return a},add:function(a,c){var d=this,f=true;if(e.isArray(a))e.each(a,function(m){f=f&&d._add(m,c)});else f=d._add(a,c);return f},remove:function(a,c){var d=this;e.isArray(a)?e.each(a,function(f){d._remove(f,c)}):d._remove(a,c)},_normModel:function(a){var c=true;if(!(a instanceof k)){c=a;a=new (this.get("model"));c=a.set(c,{silent:1})}return c&&a},load:function(a){var c=
this;a=a||{};var d=a.success;a.success=function(f){f&&c.set("models",c.parse(f),a);d&&d.apply(this,arguments)};c.sync("read",a);return c},create:function(a,c){var d=this;c=c||{};if(a=this._normModel(a)){a.addToCollection(d);var f=c.success;c.success=function(){d.add(a,c);f&&f()};a.save(c)}return a},_add:function(a,c){if(a=this._normModel(a)){c=c||{};var d;d=this.get("models");var f=this.get("comparator"),m=d.length;if(f){var t=f(a);for(m=0;m<d.length;m++){var r=f(d[m]);if(t<r)break}}d=m;this.get("models").splice(d,
0,a);a.addToCollection(this);c.silent||this.fire("add",{model:a})}return a},_remove:function(a,c){c=c||{};var d=e.indexOf(a,this.get("models"));d!=-1&&this.get("models").splice(d,1);a.removeFromCollection(this);c.silent||this.fire("remove",{model:a})},getById:function(a){for(var c=0;c<this.get("models").length;c++){var d=this.get("models")[c];if(d.getId()===a)return d}return null},getByCid:function(a){for(var c=0;c<this.get("models").length;c++){var d=this.get("models")[c];if(d.get("clientId")===
a)return d}return null}});return b},{requires:["event","./model","./base","base"]});
KISSY.add("mvc/model",function(e,j,k){function g(){g.superclass.constructor.apply(this,arguments);this.publish("beforeChange",{bubbles:1});this.publish("afterChange",{bubbles:1});this.collections={}}var l=["idAttribute","clientId","urlRoot","url"];e.extend(g,j,{addToCollection:function(b){this.collections[e.stamp(b)]=b;this.addTarget(b)},removeFromCollection:function(b){delete this.collections[e.stamp(b)];this.removeTarget(b)},getId:function(){return this.get(this.get("idAttribute"))},__set:function(){this.__isModified=
1;return g.superclass.__set.apply(this,arguments)},__fireAttrChange:function(b,a,c,d,f){this.fire(b+"Change",{attrName:a,subAttrName:f,prevVal:c,newVal:d});return g.superclass.__fireAttrChange.apply(this,arguments)},sync:function(){k.sync.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!!(this.isNew()||this.__isModified)},destroy:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){var f=a.collections;d&&a.set(d,b);for(var m in f){f[m].remove(a,
b);a.removeFromCollection(f[m])}c&&c.apply(this,arguments)};b["delete"]?a.sync("delete",b):b.success();return a},load:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){d&&a.set(a.parse(d),b);a.__isModified=0;c&&c.apply(this,arguments)};a.sync("read",b);return a},parse:function(b){return b},save:function(b){var a=this,c=b.success;b.success=function(d){d&&a.set(a.parse(d),b);a.__isModified=0;c&&c.apply(this,arguments)};a.sync(a.isNew()?"create":"update",b);return a},toJSON:function(){var b=
this.getAttrVals();e.each(l,function(a){delete b[a]});return b}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return e.guid("mvc-client")}},url:{value:function(){var b,a,c=this.collections;for(b in c)if(c.hasOwnProperty(b)){a=c[b];break}b=a;var d;b=b&&(d=b.get("url"))?e.isString(d)?d:d.call(b):d;d=b||this.get("urlRoot");if(this.isNew())return d;d+=d.charAt(d.length-1)=="/"?"":"/";return d+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""}}});return g},{requires:["base","./base"]});
KISSY.add("mvc/router",function(e,j,k){function g(h){if(h=h.match(d)){h=e.unEscapeHTML(h[1]);return e.unparam(h)}return{}}function l(h,n,p){var o=n;n=o.replace(d,"");e.each(p,function(i){var u=i.paramNames,s=i.name,v=i.callback;if(i=n.match(i.reg)){i.shift();var q={};e.each(i,function(w,x){q[u[x]]=w});i=g(o);v.apply(h,[q,i]);h.fire(s,{params:q,query:i});return false}})}function b(h,n){var p=h,o=[];h=h.replace(f,function(i){return"\\"+i}).replace(m,function(i,u,s,v,q){o.push(s||q);if(s)return"([^/]+)";
else if(q)return"(.*)"});return{name:p,paramNames:o,reg:RegExp("^"+h+"$"),callback:n}}function a(){a.superclass.constructor.apply(this,arguments);this.__routerMap={};this.on("afterRoutesChange",this._afterRoutesChange,this);this._afterRoutesChange({newVal:this.get("routes")})}function c(){l(this,r.hash.replace(t,""),this.__routerMap)}var d=/\?(.*)/,f=/[-[\]{}()+?.,\\^$|#\s]/g,m=/(:([\w\d]+))|(\*([\w\d]+))/g,t=/^#/,r=location;a.ATTRS={routes:{}};e.extend(a,k,{_afterRoutesChange:function(h){this.__routerMap=
{};this.addRoutes(h.newVal)},addRoutes:function(h){var n=this;e.each(h,function(p,o){n.__routerMap[o]=b(o,e.isFunction(p)?p:n[p])})},navigate:function(h){r.hash=h},start:function(){j.on(window,"hashchange",c,this)}});return a},{requires:["event","base"]});
KISSY.add("mvc/sync",function(e,j){var k={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(g,l){var b=e.merge({type:k[g],dataType:"json"},l),a=b.data=b.data||{};a._method=g;if(!b.url)b.url=e.isString(this.get("url"))?this.get("url"):this.get("url").call(this);if(g=="create"||g=="update"){b.contentType="application/x-www-form-urlencoded";a.model=this.toJSON()}return j(b)}},{requires:["ajax"]});
KISSY.add("mvc/view",function(e,j,k){function g(){g.superclass.constructor.apply(this,arguments);var b;if(b=this.get("events"))this._afterEventsChange({newVal:b})}var l=j.all;g.ATTRS={container:{valueFn:function(){return l("<div />")},setter:function(b){if(e.isString(b))b=l(b);return b}},events:{}};e.extend(g,k,{_afterEventsChange:function(b){var a=b.prevVal;a&&this._removeEvents(a);this._addEvents(b.newVal)},_removeEvents:function(b){var a=this.get("container"),c;for(c in b){var d=b[c],f;for(f in d)a.undelegate(f,
c,d[f],this)}},_addEvents:function(b){var a=this.get("container"),c;for(c in b){var d=b[c],f;for(f in d)a.delegate(f,c,d[f],this)}},render:function(){return this},remove:function(){this.get("container").remove()}});return g},{requires:["node","base"]});KISSY.add("mvc",function(e,j,k,g,l,b){return e.mix(j,{Model:k,View:l,Collection:g,Router:b})},{requires:["mvc/base","mvc/model","mvc/collection","mvc/view","mvc/router"]});
