/*
Copyright 2011, KISSY UI Library v1.1.7dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("event/base",function(m,c,g,l){function i(e,h,k,o,r){if(m.isString(h))h=m.query(h);if(m.isArray(h)){m.each(h,function(t){p[e](t,k,o,r)});return true}if((k=m.trim(k))&&k.indexOf(u)>0){m.each(k.split(u),function(t){p[e](h,t,o,r)});return true}return l}function a(e){return e&&e.nodeType!==3&&e.nodeType!==8?c.data(e,s):-1}function f(e,h){e&&e.nodeType!==3&&e.nodeType!==8&&c.data(e,s,h)}var b=document,d=b.addEventListener?function(e,h,k,o){e.addEventListener&&e.addEventListener(h,k,!!o)}:function(e,
h,k){e.attachEvent&&e.attachEvent("on"+h,k)},j=b.removeEventListener?function(e,h,k,o){e.removeEventListener&&e.removeEventListener(h,k,!!o)}:function(e,h,k){e.detachEvent&&e.detachEvent("on"+h,k)},s="ksEventTargetId",u=" ",n=m.now(),q={},p={EVENT_GUID:s,special:{},add:function(e,h,k,o){if(!i("add",e,h,k,o)){var r=a(e),t,w,x,z,y;if(!(r===-1||!h||!m.isFunction(k))){if(!r){f(e,r=n++);q[r]={target:e,events:{}}}w=q[r].events;if(!w[h]){t=((r=!e.isCustomEventTarget)||e._supportSpecialEvent)&&p.special[h]||
{};x=function(v,A){if(!v||!v.fixed)v=new g(e,v,h);if(m.isPlainObject(A)){var B=v.type;m.mix(v,A);v.type=B}t.setup&&t.setup(v);return(t.handle||p._handle)(e,v)};w[h]={handle:x,listeners:[]};z=t.fix||h;y=t.capture;t.init&&t.init.apply(null,m.makeArray(arguments));r&&t.fix!==false&&d(e,z,x,y)}w[h].listeners.push({fn:k,scope:o||e})}}},__getListeners:function(e,h){var k,o=[];if(k=(p.__getEvents(e)||{})[h])o=k.listeners;return o},__getEvents:function(e){var h=a(e),k;if(h!==-1)if(h&&(k=q[h]))if(k.target===
e)return k.events||{}},remove:function(e,h,k,o){if(!i("remove",e,h,k,o)){var r=p.__getEvents(e),t=a(e),w,x,z,y,v,A,B=(!e.isCustomEventTarget||e._supportSpecialEvent)&&p.special[h]||{};if(r!==l){o=o||e;if(w=r[h]){x=w.listeners;z=x.length;if(m.isFunction(k)&&z){v=y=0;for(A=[];y<z;++y)if(k!==x[y].fn||o!==x[y].scope)A[v++]=x[y];w.listeners=A;z=A.length}if(k===l||z===0){if(!e.isCustomEventTarget){B=p.special[h]||{};if(B.fix!==false)j(e,B.fix||h,w.handle)}delete r[h]}}B.destroy&&B.destroy.apply(null,m.makeArray(arguments));
if(h===l||m.isEmptyObject(r)){for(h in r)p.remove(e,h);delete q[t];c.removeData(e,s)}}}},_handle:function(e,h){var k=p.__getListeners(e,h.type);k=k.slice(0);for(var o,r=0,t=k.length;r<t;++r){o=k[r];o=o.fn.call(o.scope,h);if(o!==l){h.result=o;o===false&&h.halt()}if(h.isImmediatePropagationStopped)break}return o},_getCache:function(e){return q[e]},__getID:a,_simpleAdd:d,_simpleRemove:j};p.on=p.add;return p},{requires:["dom","event/object"]});
KISSY.add("event/focusin",function(m,c){document.addEventListener&&m.each([{name:"focusin",fix:"focus"},{name:"focusout",fix:"blur"}],function(g){c.special[g.name]={fix:g.fix,capture:true,setup:function(l){l.type=g.name}}})},{requires:["event/base"]});
KISSY.add("event/hashchange",function(m,c,g,l){l=document.documentMode||l.ie;if(!("onhashchange"in window)||l<8){var i,a=[],f=u();c.special.hashchange={fix:false,init:function(n){-1===m.indexOf(n,a)&&a.push(n);i||b()},destroy:function(n,q){if(!c.__getEvents(n)[q]){var p=m.indexOf(n,a);p>=0&&a.splice(p,1)}if(a.length===0){i&&clearTimeout(i);i=null}}};var b=function(){d()},d=function(){var n=u();if(n!==f){j(n);f=n}i=setTimeout(d,50)},j=function(n){s(n)};8>l&&function(){var n;b=function(){if(!n){n=g.create('<iframe style="display: none" height="0" width="0" tabindex="-1" title="empty"/>');
g.prepend(n,document.documentElement);c.add(n,"load",function(){c.remove(n,"load");j(u());c.add(n,"load",q);d()});var q=function(){var p=m.trim(n.contentWindow.document.body.innerHTML),e=u();if(p!=e)f=location.hash=p;s(p)}}};j=function(q){q="<html><body>"+q+"</body></html>";var p=n.contentWindow.document;try{p.open();p.write(q);p.close();return true}catch(e){return false}}}();var s=function(){for(var n=0;n<a.length;n++)c._handle(a[n],{type:"hashchange"})},u=function(){return"#"+location.href.replace(/^[^#]*#?(.*)$/,
"$1")}}},{requires:["event/base","dom","ua"]});KISSY.add("event/mouseenter",function(m,c,g,l){l.ie||m.each([{name:"mouseenter",fix:"mouseover"},{name:"mouseleave",fix:"mouseout"}],function(i){c.special[i.name]={fix:i.fix,setup:function(a){a.type=i.name},handle:function(a,f){if(g._isKSNode(a))a=a[0];var b=f.relatedTarget;try{for(;b&&b!==a;)b=b.parentNode;b!==a&&c._handle(a,f)}catch(d){}}}})},{requires:["event/base","dom","ua"]});
KISSY.add("event/object",function(m,c){function g(a,f,b){this.currentTarget=a;this.originalEvent=f||{};if(f){this.type=f.type;this._fix()}else{this.type=b;this.target=a}this.currentTarget=a;this.fixed=true}var l=document,i="altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" ");
m.augment(g,{_fix:function(){var a=this.originalEvent,f=i.length,b,d=this.currentTarget;for(d=d.nodeType===9?d:d.ownerDocument||l;f;){b=i[--f];this[b]=a[b]}if(!this.target)this.target=this.srcElement||l;if(this.target.nodeType===3)this.target=this.target.parentNode;if(!this.relatedTarget&&this.fromElement)this.relatedTarget=this.fromElement===this.target?this.toElement:this.fromElement;if(this.pageX===c&&this.clientX!==c){a=d.documentElement;f=d.body;this.pageX=this.clientX+(a&&a.scrollLeft||f&&f.scrollLeft||
0)-(a&&a.clientLeft||f&&f.clientLeft||0);this.pageY=this.clientY+(a&&a.scrollTop||f&&f.scrollTop||0)-(a&&a.clientTop||f&&f.clientTop||0)}if(this.which===c)this.which=this.charCode!==c?this.charCode:this.keyCode;if(this.metaKey===c)this.metaKey=this.ctrlKey;if(!this.which&&this.button!==c)this.which=this.button&1?1:this.button&2?3:this.button&4?2:0},preventDefault:function(){var a=this.originalEvent;if(a.preventDefault)a.preventDefault();else a.returnValue=false;this.isDefaultPrevented=true},stopPropagation:function(){var a=
this.originalEvent;if(a.stopPropagation)a.stopPropagation();else a.cancelBubble=true;this.isPropagationStopped=true},stopImmediatePropagation:function(){var a=this.originalEvent;a.stopImmediatePropagation?a.stopImmediatePropagation():this.stopPropagation();this.isImmediatePropagationStopped=true},halt:function(a){a?this.stopImmediatePropagation():this.stopPropagation();this.preventDefault()}});return g});
KISSY.add("event/target",function(m,c,g,l){return{isCustomEventTarget:true,fire:function(i,a){var f=g.data(this,c.EVENT_GUID)||-1;if((f=((c._getCache(f)||{}).events||{})[i])&&m.isFunction(f.handle))return f.handle(l,a)},on:function(i,a,f){c.add(this,i,a,f);return this},detach:function(i,a,f){c.remove(this,i,a,f);return this}}},{requires:["event/base","dom/data"]});
describe("event",function(){var m=document,c=KISSY,g=c.Event,l="happened",i="2",a,f=function(b,d,j){if(typeof b==="string")b=c.get(b);jasmine.simulate(b,d,{relatedTarget:j})};describe("add event",function(){it("should support batch adding.",function(){var b=c.query("#bar li"),d=b.length,j=0;g.on(b,"click",function(){j++});c.each(b,function(s){f(s,"click")});waits(0);runs(function(){expect(j).toEqual(d)})});it("should execute in order.",function(){var b=c.get("#link-a");g.on(b,"click",function(){a.push("1")});
g.on(b,"click",function(){a.push(i)});a=[];f(b,"click");waits(0);runs(function(){expect(a.join("-")).toEqual(["1",i].join("-"))})});it('should prevent default behavior (do nothing if using "return false;").',function(){var b=c.get("#checkbox-1"),d=c.get("#checkbox-2");b.checked=false;d.checked=false;g.on(b,"click",function(j){j.preventDefault()});g.on(d,"click",function(){return false});b.click();d.click();waits(0);runs(function(){expect(b.checked).toBeFalsy();expect(d.checked).toBeFalsy()})});it("should stop event's propagation.",
function(){var b=c.get("#li-c"),d=c.get("#link-c1"),j=c.get("#link-c2");g.on(j,"click",function(s){s.stopPropagation()});g.on(b,"click",function(){a=l});runs(function(){a=null;f(d,"click")});waits(0);runs(function(){expect(a).toEqual(l)});runs(function(){a=null;f(j,"click")});waits(0);runs(function(){expect(a).toBeNull()})});it("should stop event's propagation immediately.",function(){var b=c.get("#li-d"),d=c.get("#link-d1"),j=c.get("#link-d2");g.on(d,"click",function(){a.push("1")});g.on(d,"click",
function(){a.push(i)});g.on(j,"click",function(s){a.push("1");s.stopImmediatePropagation()});g.on(j,"click",function(){a.push(i)});g.on(b,"click",function(){a.push(l)});runs(function(){a=[];f(d,"click")});waits(0);runs(function(){expect(a.join("-")).toEqual(["1",i,l].join("-"))});runs(function(){a=[];f(j,"click")});waits(0);runs(function(){expect(a.join("-")).toEqual("1")})});it('should do nothing else to event\'s propagation if using "return false;".',function(){var b=c.get("#li-e"),d=c.get("#link-e1"),
j=c.get("#link-e2");g.on(d,"click",function(){a.push("1")});g.on(d,"click",function(){a.push(i)});g.on(j,"click",function(){a.push("1");return false});g.on(j,"click",function(){a.push(i)});g.on(b,"click",function(){a.push(l)});runs(function(){a=[];f(d,"click")});waits(0);runs(function(){expect(a.join("-")).toEqual(["1",i,l].join("-"))});runs(function(){a=[];f(j,"click")});waits(0);runs(function(){expect(a.join("-")).toEqual(["1",i].join("-"))})});it("should set this properly",function(){var b;runs(function(){c.one("#link-test-this").on("click",
function(){b=this});f("#link-test-this","click")});waits(0);runs(function(){expect(b.nodeType).toBe(c.Node.TYPE)});runs(function(){c.all("#link-test-this-all span").on("click",function(){b=this});f("#link-test-this-all-span","click")});waits(0);runs(function(){expect(b.text()).toBe("link for test this")});runs(function(){c.Event.on("#link-test-this-dom","click",function(){b=this});f("#link-test-this-dom","click")});waits(0);runs(function(){expect(b.nodeType).toBe(1)})})});describe("remove event",
function(){it("should remove the specified event handler function.",function(){function b(){a=l}var d=c.get("#link-f");g.on(d,"click",b);g.on(d,"click",b);g.remove(d,"click",b);a=null;f(d,"click");waits(0);runs(function(){expect(a).toBeNull()})});it("should remove all the event handlers of the specified event type.",function(){var b=c.get("#link-g");g.on(b,"click",function(){a.push("1")});g.on(b,"click",function(){a.push(i)});g.remove(b,"click");a=[];f(b,"click");waits(0);runs(function(){expect(a.join("-")).toEqual("")})});
it("should reomve all the event handler of the specified element",function(){var b=c.get("#link-h");g.on(b,"click",function(){a.push("1")});g.on(b,"click",function(){a.push(i)});g.remove(b);a=[];f(b,"click");waits(0);runs(function(){expect(a.join("-")).toEqual("")})})});describe("mouseenter and mouseleave",function(){var b=c.UA.ie,d=c.get("#outer"),j=c.get("#inner"),s=d.parentNode;it("should trigger the mouseenter event on the proper element.",function(){var u=0,n=0,q=b?"mouseenter":"mouseover";g.on(d,
"mouseenter",function(){u++});g.on(j,"mouseenter",function(){n++});f(d,q,s);f(j,q,d);f(j,q,d);waits(100);runs(function(){if(!b){expect(u).toEqual(1);expect(n).toEqual(2)}})});it("should trigger the mouseleave event on the proper element.",function(){var u=0,n=0,q=b?"mouseleave":"mouseout";g.on(d,"mouseleave",function(){u++});g.on(j,"mouseleave",function(){n++});f(j,q,d);f(d,q,s);f(d,q,d.parentNode);waits(0);runs(function(){if(!b){expect(u).toEqual(2);expect(n).toEqual(1)}})})});describe("focusin and focusout",
function(){it("should trigger the focusin/focusout event on the proper element, and support bubbling.",function(){var b=c.get("#test-focusin"),d=c.get("input",b);g.on(b,"focusin focusout",function(){a.push(l)});g.on(d,"focusin focusout",function(){a.push(l)});runs(function(){a=[];d.focus()});waits(0);runs(function(){expect(a.join("-")).toEqual([l,l].join("-"))});runs(function(){a=[];d.blur()});waits(0);runs(function(){expect(a.join("-")).toEqual([l,l].join("-"))})});it("should trigger the focusin/focusout event and focus event in order.",
function(){var b=c.get("#test-focusin-input");g.on(b,"focusin focusout",function(){a.push("1")});g.on(b,"focus blur",function(){a.push(i)});runs(function(){a=[];b.focus()});waits(0);runs(function(){expect(a.join("-")).toEqual(["1",i].join("-"))});runs(function(){a=[];b.blur()});waits(0);runs(function(){expect(a.join("-")).toEqual(["1",i].join("-"))})})});describe("event handler scope",function(){it("should treat the element itself as the scope.",function(){var b=c.get("#foo");g.on(b,"click",function(){expect(this).toBe(b)});
f(b,"click")});it("should support using custom object as the scope.",function(){var b=c.get("#bar"),d={foo:"only for tesing"};g.on(b,"click",function(){expect(this).toBe(d)},d)});it("should guarantee separate event adding function keeps separate scope.",function(){function b(){a.push(this.id)}g.on(m,"click",b,{id:"1"});g.on(m,"click",b,{id:i});f(m,"click");f(m,"click");waits(0);runs(function(){expect(a[1]).not.toEqual(a[2])})})});describe("custom event target",function(){it("should support custom event target.",
function(){function b(s){this.name=s}function d(){a.push(i)}var j;c.augment(b,c.EventTarget,{run:function(){this.fire("running",{speed:"70 km/h"})}});j=new b("Lady Gogo");j.on("running",function(s){a.push(this.name);a.push(s.speed)});j.on("running",function(){a.push("1");return false});j.on("running",d);a=[];j.run();waits(0);runs(function(){expect(a.join("-")).toEqual(["Lady Gogo-70 km/h-1",i].join("-"))});runs(function(){a=[];j.detach("running",d);j.run();waits(0);runs(function(){expect(a.join("-")).toEqual("Lady Gogo-70 km/h-1")})})})});
it("should detach properly",function(){var b;runs(function(){function d(){b=1}c.one("#link-detach").on("click",d);c.one("#link-detach").detach("click",d);f("#link-detach","click")});waits(10);runs(function(){expect(b).toBeUndefined()})})});KISSY.add("event",function(m,c){return c},{requires:["event/base","event/target","event/object","event/focusin","event/hashchange","event/mouseenter"]});
