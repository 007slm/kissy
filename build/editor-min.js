/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Sep 5 10:33
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(i,m,v){m=v.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:m.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(i){return this._setData(i)}},formatData:{getter:function(){return this._getData(1)},setter:function(i){return this._setData(i)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});m.HTML_PARSER={textarea:function(i){return i.one(".ks-editor-textarea")}};i.mix(m,i.EventTarget);return KISSY.Editor=m},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(i,m,v,t){function r(a){this.editor=a;this._init()}function f(a){if(l.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),c;if(b.getType()==t.SELECTION_ELEMENT&&(c=b.getSelectedElement())){var g=b.getRanges()[0],e=d(a.get("document")[0].createTextNode(""));e.insertBefore(c);g.setStartBefore(e);g.setEndAfter(c);b.selectRanges([g]);setTimeout(function(){c.parent()&&(e.remove(),b.selectElement(c))},0)}}}var d=i.all,l=i.UA,o=m.RANGE,n=i.Event;
i.augment(r,{_init:function(){var a=this.editor,h=a.get("document")[0].body;n.on(h,l.ie?"beforepaste":"paste",this._paste,this);n.on(h,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new w("copy"));a.addCommand("cut",new w("cut"));a.addCommand("paste",new w("paste"))},_paste:function(){if(!b){var a=this.editor,h=a.get("document")[0];if(!h.getElementById("ke_pastebin")){var c=a.getSelection(),g=new v(h),e=d(l.webkit?"<body></body>":"<div></div>",null,h);e.attr("id",
"ke_pastebin");l.webkit&&e[0].appendChild(h.createTextNode("\u00a0"));h.body.appendChild(e[0]);e.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var k=c.createBookmarks();g.setStartAt(e,o.POSITION_AFTER_START);g.setEndAt(e,o.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){var b;e=l.webkit&&(b=e.first())&&b.hasClass("Apple-style-span")?b:e;c.selectBookmarks(k);e.remove();var g=e.html();if(g=i.trim(g.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))b=a.fire("paste",{html:g,holder:e}),void 0!==b&&(g=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?i.use("editor/plugin/word-filter/dynamic/",function(e,c){a.insertHtml(c.toDataFormat(g,a))}):a.insertHtml(g)},0)}}}});var x=function(a,b){var c=a.get("document")[0],g=d(c.body),e=!1,k=function(){e=!0};g.on(b,k);(7<l.ie?c:c.selection.createRange()).execCommand(b);g.detach(b,k);return e},p=l.ie?function(a,b){return x(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(c){return!1}},
y={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},w=function(a){this.type=a};w.prototype={exec:function(a){"cut"==this.type&&f(a);(a=p(a,this.type))||alert(y[this.type]);return a}};var j={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;return{init:function(a){a.docReady(function(){new r(a)});var b={copy:1,cut:1,paste:1};a.on("contextmenu",function(c){c=c.contextmenu;if(!c.__copy_fix){c.__copy_fix=
1;for(var g in b)b.hasOwnProperty(g)&&c.addChild({xclass:"menuitem",content:j[g],value:g});c.on("click",function(c){var g=c.target.get("value");b[g]&&(this.hide(),setTimeout(function(){a.execCommand(g)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.Loader&&KISSY.config("modules",{"editor/plugin/heading/cmd":{requires:["editor"]},"editor/plugin/page-break/index":{requires:["editor","editor/plugin/fake-objects/"]},"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/image/dialog":{requires:["ajax","editor","editor/plugin/overlay/","switchable","editor/plugin/menubutton/"]},"editor/plugin/underline/index":{requires:["editor","editor/plugin/font/ui",
"editor/plugin/underline/cmd"]},"editor/plugin/maximize/cmd":{requires:["editor"]},"editor/plugin/contextmenu/index":{requires:["editor","menu","editor/plugin/focus-fix/"]},"editor/plugin/heading/index":{requires:["editor","editor/plugin/heading/cmd"]},"editor/plugin/drag-upload/index":{requires:["editor"]},"editor/plugin/color/cmd":{requires:["editor"]},"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/strike-through/cmd":{requires:["editor",
"editor/plugin/font/cmd"]},"editor/plugin/unordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]},"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/italic/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]},"editor/plugin/remove-format/cmd":{requires:["editor"]},"editor/plugin/font-size/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-size/cmd"]},"editor/plugin/indent/cmd":{requires:["editor",
"editor/plugin/dent-utils/cmd"]},"editor/plugin/table/index":{requires:["editor","editor/plugin/dialog-loader/","editor/plugin/contextmenu/"]},"editor/plugin/word-filter/dynamic/index":{requires:["htmlparser"]},"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/resize/index":{requires:["editor","dd"]},"editor/plugin/focus-fix/index":{requires:["editor"]},"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},
"editor/plugin/xiami-music/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/maximize/index":{requires:["editor","editor/plugin/maximize/cmd"]},"editor/plugin/color/color-picker/dialog":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/smiley/index":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/separator/index":{requires:["editor"]},"editor/plugin/video/index":{requires:["editor",
"editor/plugin/flash-common/utils","editor/plugin/flash-common/baseClass","editor/plugin/fake-objects/"]},"editor/plugin/multiple-upload/index":{requires:["editor","editor/plugin/dialog-loader/"]},"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/menubutton/index":{requires:["editor","menubutton"]},"editor/plugin/flash/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/overlay/index":{requires:["editor",
"overlay","editor/plugin/focus-fix/","dd"]},"editor/plugin/link/utils":{requires:["editor"]},"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/button/index":{requires:["editor","button"]},"editor/plugin/checkbox-source-area/index":{requires:["editor"]},"editor/plugin/strike-through/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]},
"editor/plugin/fore-color/index":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]},"editor/plugin/flash-bridge/index":{requires:["editor","editor/plugin/flash-common/utils"]},"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/table/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/justify-utils/cmd":{requires:["editor"]},"editor/plugin/undo/index":{requires:["editor","editor/plugin/undo/btn",
"editor/plugin/undo/cmd"]},"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/image/index":{requires:["editor","editor/plugin/button/","editor/plugin/bubble/","editor/plugin/contextmenu/","editor/plugin/dialog-loader/"]},"editor/plugin/dent-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]},"editor/plugin/list-utils/index":{requires:["editor"]},"editor/plugin/dialog-loader/index":{requires:["overlay",
"editor"]},"editor/plugin/font-family/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]},"editor/plugin/undo/cmd":{requires:["editor"]},"editor/plugin/indent/index":{requires:["editor","editor/plugin/indent/cmd"]},"editor/plugin/font/cmd":{requires:["editor"]},"editor/plugin/ordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]},"editor/plugin/color/btn":{requires:["editor","editor/plugin/button/","editor/plugin/overlay/",
"editor/plugin/dialog-loader/"]},"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/local-storage/index":{requires:["editor","overlay","editor/plugin/flash-bridge/"]},"editor/plugin/bubble/index":{requires:["overlay","editor"]},"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/bold/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]},"editor/plugin/back-color/index":{requires:["editor","editor/plugin/color/btn",
"editor/plugin/back-color/cmd"]},"editor/plugin/draft/index":{requires:["editor","editor/plugin/local-storage/","overlay","editor/plugin/menubutton/"]},"editor/plugin/link/index":{requires:["editor","editor/plugin/bubble/","editor/plugin/link/utils","editor/plugin/dialog-loader/","editor/plugin/button/"]},"editor/plugin/remove-format/index":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button/"]},"editor/plugin/element-path/index":{requires:["editor"]},"editor/plugin/font/ui":{requires:["editor",
"editor/plugin/button/","editor/plugin/menubutton/"]},"editor/plugin/source-area/index":{requires:["editor","editor/plugin/button/"]},"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/justify-right/index":{requires:["editor","editor/plugin/justify-right/cmd"]},"editor/plugin/justify-left/index":{requires:["editor","editor/plugin/justify-left/cmd"]},"editor/plugin/outdent/index":{requires:["editor","editor/plugin/outdent/cmd"]},"editor/plugin/fake-objects/index":{requires:["editor"]},
"editor/plugin/link/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/link/utils"]},"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/multiple-upload/dialog":{requires:["editor","editor/plugin/progressbar/","editor/plugin/overlay/","editor/plugin/flash-bridge/","editor/plugin/local-storage/"]},"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-utils/cmd"]},
"editor/plugin/flash-common/baseClass":{requires:["editor","editor/plugin/contextmenu/","editor/plugin/bubble/","editor/plugin/dialog-loader/","editor/plugin/flash-common/utils"]},"editor/plugin/justify-center/index":{requires:["editor","editor/plugin/justify-center/cmd"]},"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});
KISSY.add("editor/core/dom",function(i,m,v){function t(b,a){var h=b[a?"next":"prev"](r,1);if(h&&h[0].nodeType==l.ELEMENT_NODE){for(var c=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemovable(r);)if(c.push(h),h=a?h.next(r,1):h.prev(r,1),!h)return;if(b._4e_isIdentical(h,r)){for(var g=new n(a?b[0].lastChild:b[0].firstChild);c.length;)c.shift()._4e_move(b,!a,r);h._4e_moveChildren(b,!a,r);h.remove();g[0]&&g[0].nodeType==l.ELEMENT_NODE&&g._4e_mergeSiblings()}}}var r=r,f=m.XHTML_DTD,d=i.DOM,l=d.NodeType,
o=i.UA,n=i.Node,x={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};m.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var p=m.POSITION,y={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},w={hr:1},j=function(b){return b&&(b[0]||b)};v.injectDom({_4e_sameLevel:function(b,a){var a=j(a),h=b.parentNode;return h&&h==a.parentNode},_4e_isBlockBoundary:function(b,a){var h=i.merge(w,a);return!(!y[d.css(b,"display")]&&!h[d.nodeName(b)])},_4e_index:function(b,a){for(var h=b.parentNode.childNodes,c,g=-1,e=0;e<h.length;e++)if(c=h[e],!a||!(3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType))if(g++,c===b)return g;return-1},_4e_move:function(b,
a,h){a=j(a);h?a.insertBefore(b,a.firstChild):a.appendChild(b)},_4e_isIdentical:function(b,a){if(!a)return!1;a=j(a);if(d.nodeName(b)!=d.nodeName(a))return!1;var h=b.attributes,c=a.attributes,g=h.length,e=c.length;if(g!=e)return!1;for(var k=0;k<g;k++){var s=h[k],f=s.name;if(s.specified&&d.attr(b,f)!=d.attr(a,f))return!1}if(8>v.ieEngine)for(k=0;k<e;k++)if(s=c[k],f=s.name,s.specified&&d.attr(b,f)!=d.attr(a,f))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){if(!f.$removeEmpty[d.nodeName(b)])return!1;
for(var b=b.childNodes,a=0,h=b.length;a<h;a++){var c=b[a],g=c.nodeType;if(!(g==l.ELEMENT_NODE&&c.getAttribute("_ke_bookmark"))&&(g==l.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(c)||g==d.NodeType.TEXT_NODE&&i.trim(c.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,a,h){a=j(a);if(b!=a)if(h)for(;h=b.lastChild;)a.insertBefore(b.removeChild(h),a.firstChild);else for(;h=b.firstChild;)a.appendChild(b.removeChild(h))},_4e_mergeSiblings:function(b){b=new n(b);x[b.nodeName()]&&(t(b,!0),t(b))},_4e_splitText:function(b,
a){var h=b.ownerDocument;if(b.nodeType==d.NodeType.TEXT_NODE){if(o.ie&&a==b.nodeValue.length){var c=h.createTextNode("");d.insertAfter(c,b);return c}c=b.splitText(a);h.documentMode&&(h=h.createTextNode(""),d.insertAfter(h,c),d.remove(h));return c}},_4e_parents:function(b,a){var h=[];h.__IS_NODELIST=1;do h[a?"push":"unshift"](b);while(b=b.parentNode);return h},_4e_nextSourceNode:function(b,a,h,c){if(c&&!c.call)var g=j(c),c=function(a){return a!==g};var a=!a&&b.firstChild,e=b;if(!a){if(b.nodeType==
l.ELEMENT_NODE&&c&&!1===c(b,!0))return null;a=b.nextSibling}for(;!a&&(e=e.parentNode);){if(c&&!1===c(e,!0))return null;a=e.nextSibling}return!a||c&&!1===c(a)?null:h&&h!=a.nodeType?d._4e_nextSourceNode(a,!1,h,c):a},_4e_previousSourceNode:function(b,a,h,c){if(c&&!c.call)var g=j(c),c=function(a){return a!==g};var a=!a&&b.lastChild,e=b;if(!a){if(b.nodeType==l.ELEMENT_NODE&&c&&!1===c(b,!0))return null;a=b.previousSibling}for(;!a&&(e=e.parentNode);){if(c&&!1===c(e,!0))return null;a=e.previousSibling}return!a||
c&&!1===c(a)?null:h&&a.nodeType!=h?d._4e_previousSourceNode(a,!1,h,c):a},_4e_commonAncestor:function(b,a){a=j(a);if(b===a)return b;if(d.contains(a,b))return a;var h=b;do if(d.contains(h,a))return h;while(h=h.parentNode);return null},_4e_hasAttributes:9>v.ieEngine?function(b){for(var a=b.attributes,h=0;h<a.length;h++){var c=a[h];switch(c.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(c.specified)return!0}}return!1}:function(b){o.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},
_4e_position:function(b,a){var h=j(a);if(b.compareDocumentPosition)return b.compareDocumentPosition(h);if(b==h)return p.POSITION_IDENTICAL;if(b.nodeType==l.ELEMENT_NODE&&h.nodeType==l.ELEMENT_NODE){if(d.contains(b,h))return p.POSITION_CONTAINS+p.POSITION_PRECEDING;if(d.contains(h,b))return p.POSITION_IS_CONTAINED+p.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>h.sourceIndex?p.POSITION_DISCONNECTED:b.sourceIndex<h.sourceIndex?p.POSITION_PRECEDING:p.POSITION_FOLLOWING}for(var c=
d._4e_address(b),h=d._4e_address(h),g=Math.min(c.length,h.length),e=0;e<=g-1;e++)if(c[e]!=h[e])return c[e]<h[e]?p.POSITION_PRECEDING:p.POSITION_FOLLOWING;return c.length<h.length?p.POSITION_CONTAINS+p.POSITION_PRECEDING:p.POSITION_IS_CONTAINED+p.POSITION_FOLLOWING},_4e_address:function(b,a){for(var h=[],c=b.ownerDocument.documentElement,g=b;g&&g!=c;)h.unshift(d._4e_index(g,a)),g=g.parentNode;return h},_4e_remove:function(b,a){var h=b.parentNode;if(h){if(a)for(var c;c=b.firstChild;)h.insertBefore(b.removeChild(c),
b);h.removeChild(b)}return b},_4e_trim:function(b){d._4e_ltrim(b);d._4e_rtrim(b)},_4e_ltrim:function(b){for(var a;a=b.firstChild;){if(a.nodeType==d.NodeType.TEXT_NODE){var h=v.ltrim(a.nodeValue),c=a.nodeValue.length;if(h)h.length<c&&(d._4e_splitText(a,c-h.length),b.removeChild(b.firstChild));else{b.removeChild(a);continue}}break}},_4e_rtrim:function(b){for(var a;a=b.lastChild;){if(a.type==d.NodeType.TEXT_NODE){var h=v.rtrim(a.nodeValue),c=a.nodeValue.length;if(h)h.length<c&&(d._4e_splitText(a,h.length),
b.removeChild(b.lastChild));else{b.removeChild(a);continue}}break}!o.ie&&!o.opera&&(a=b.lastChild)&&1==a.nodeType&&"br"==d.nodeName(a)&&b.removeChild(a)},_4e_appendBogus:function(b){for(var a=b.lastChild;a&&a.nodeType==d.NodeType.TEXT_NODE&&!i.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==d.NodeType.TEXT_NODE||"br"!==d.nodeName(a))a=o.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),o.gecko&&a.setAttribute("type","_moz"),b.appendChild(a)},_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,
"");var a=b.ownerDocument.createElement("div");a.appendChild(b.cloneNode(!0));return a.innerHTML},_4e_setMarker:function(b,a,h,c){var b=new n(b),g=b.data("list_marker_id")||b.data("list_marker_id",i.guid()).data("list_marker_id"),e=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");a[g]=b;e[h]=1;return b.data(h,c)},_4e_clearMarkers:function(b,a,h){var b=new n(b),c=b.data("list_marker_names"),g=b.data("list_marker_id"),e;for(e in c)c.hasOwnProperty(e)&&b.removeData(e);
b.removeData("list_marker_names");h&&(b.removeData("list_marker_id"),delete a[g])},_4e_copyAttributes:function(b,a,h){for(var a=new n(a),c=b.attributes,h=h||{},g=0;g<c.length;g++){var e=c[g],k=e.name.toLowerCase(),s;if(!(k in h))if("checked"==k&&(s=d.attr(b,k)))a.attr(k,s);else if(e.specified||o.ie&&e.value&&"value"==k)s=d.attr(b,k),null===s&&(s=e.nodeValue),a.attr(k,s)}""!==b.style.cssText&&(a[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){b=d.nodeName(b);return(b=!f.$nonEditable[b]&&
(f[b]||f.span))&&b["#text"]},_4e_getByAddress:function(b,a,h){for(var b=b.documentElement,c=0;b&&c<a.length;c++){var g=a[c];if(h)for(var e=-1,k=0;k<b.childNodes.length;k++){var s=b.childNodes[k];if(!(!0===h&&3==s.nodeType&&s.previousSibling&&3==s.previousSibling.nodeType)&&(e++,e==g)){b=s;break}}else b=b.childNodes[g]}return b}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(i){function m(d){1>arguments.length||(this.range=d,this.forceBrBreak=t,this.enlargeBr=v,this.enforceRealBlocks=t,this._||(this._={}))}var v=!0,t=!1,r=i.Editor,f=i.UA,d=r.Walker,l=r.Range,o=r.RANGE,n=r.ElementPath,x=i.Node,p=i.DOM,y=/^[\r\n\t ]*$/;i.augment(m,{getNextParagraph:function(m){var j,b,a,h,c;if(!this._.lastNode){b=this.range.clone();b.shrink(o.SHRINK_ELEMENT,v);b.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var g=new d(b),e=d.bookmark(v,v);g.evaluator=e;this._.nextNode=g.next();g=new d(b);g.evaluator=e;g=g.previous();this._.lastNode=g._4e_nextSourceNode(v);this._.lastNode&&this._.lastNode[0].nodeType==p.NodeType.TEXT_NODE&&!i.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(e=new l(b.document),e.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),e.checkEndOfBlock()&&(e=new n(e.endContainer),this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(v)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(b.document.createTextNode("")),p.insertAfter(this._.lastNode[0],g[0]));b=null}e=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;e;){var k=t,s=e[0].nodeType!=p.NodeType.ELEMENT_NODE,C=t;if(s)e[0].nodeType==p.NodeType.TEXT_NODE&&y.test(e[0].nodeValue)&&(s=t);else{var z=e.nodeName();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==z)s=v;else if(!b&&!e[0].childNodes.length&&"hr"!=z){j=e;a=e.equals(g);break}b&&(b.setEndAt(e,o.POSITION_BEFORE_START),
"br"!=z&&(this._.nextNode=e));k=v}else{if(e[0].firstChild){b||(b=new l(this.range.document),b.setStartAt(e,o.POSITION_BEFORE_START));e=new x(e[0].firstChild);continue}s=v}}s&&!b&&(b=new l(this.range.document),b.setStartAt(e,o.POSITION_BEFORE_START));a=(!k||s)&&e.equals(g);if(b&&!k)for(;!e[0].nextSibling&&!a;){z=e.parent();if(z._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=v;a||z.equals(g);break}e=z;s=v;a=e.equals(g);C=v}s&&b.setEndAt(e,o.POSITION_AFTER_END);e=e._4e_nextSourceNode(C,null,g);if((a=
!e)||k&&b)break}if(!j){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;j=new n(b.startContainer);e=j.blockLimit;k={div:1,th:1,td:1};j=j.block;if((!j||!j[0])&&!this.enforceRealBlocks&&k[e.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())j=e;else if(!j||this.enforceRealBlocks&&"li"==j.nodeName())j=new x(this.range.document.createElement(m||"p")),j[0].appendChild(b.extractContents()),j._4e_trim(),b.insertNode(j),h=c=v;else if("li"!=j.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())j=j.clone(t),j[0].appendChild(b.extractContents()),j._4e_trim(),c=b.splitBlock(),h=!c.wasStartOfBlock,c=!c.wasEndOfBlock,b.insertNode(j)}else a||(this._.nextNode=j.equals(g)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(v,null,g))}h&&(b=new x(j[0].previousSibling),b[0]&&b[0].nodeType==p.NodeType.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==p.nodeName(b[0].lastChild)&&p._4e_remove(b[0].lastChild)));c&&(b=d.bookmark(t,v),h=new x(j[0].lastChild),
h[0]&&h[0].nodeType==p.NodeType.ELEMENT_NODE&&"br"==h.nodeName()&&(f.ie||h.prev(b,1)||h.next(b,1))&&h.remove());this._.nextNode||(this._.nextNode=a||j.equals(g)?null:j._4e_nextSourceNode(v,null,g));return j}});l.prototype.createIterator=function(){return new m(this)};return m},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor",function(i,m,v,t,r,f,d,l,o,n){function x(a,e){var q=a.body;G(function(){a.designMode="on";setTimeout(function(){a.designMode="off";q.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";s.attr(q,"contentEditable",c);s.attr(q,"contentEditable",b);!e&&x(a,1)})}function p(a){a.get("iframe");var b=a.get("textarea")[0],q=a.get("window")[0],g=a.get("document")[0];e.webkit&&(A.on(g,"click",function(a){var c=new z(a.target);i.inArray(c.nodeName(),
["input","select"])&&a.preventDefault()}),A.on(g,"mouseup",function(a){var c=new z(a.target);i.inArray(c.nodeName(),["input","textarea"])&&a.preventDefault()}));if(e.gecko||k||e.opera){var u;u=(new z('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);u.on("focus",function(){a.focus()});a.activateGecko=function(){e.gecko&&a.__iframeFocus&&u[0].focus()};a.on("destroy",function(){u.detach();u.remove()})}A.on(q,"focus",function(){e.gecko?x(g,c):e.opera&&
g.body.focus();a.notifySelectionChange()});if(e.gecko)A.on(g,"mousedown",function(){a.__iframeFocus||x(g,c)});if(k&&(A.on(g,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var b=a.getSelection(),e=b.getSelectedElement();if(e){a.execCommand("save");var q=b.getRanges()[0].createBookmark();e.remove();b.selectBookmarks([q]);a.execCommand("save");c.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var h={33:1,34:1};A.on(g,"keydown",function(c){c.keyCode in h&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(e.webkit)A.on(g,"mousedown",function(c){c=new z(c.target);i.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(c)});if(e.gecko)A.on(g,"dragstart",function(a){var c=new z(a.target);c.nodeName()==="img"&&/ke_/.test(c[0].className)&&a.preventDefault()});t.add(a)}function y(a,c,b,e){var k="",u,h=v.debugUrl("theme/editor-iframe.css");for(u=0;u<b.length;u++)k+=i.substitute('<link href="{href}" rel="stylesheet" />',{href:b[u]});return i.substitute(q,{doctype:8===
g.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:h,style:c,data:e||"&nbsp;",script:a?'<script id="ke_active_script">'+(s.isCustomDomain()?'document.domain="'+g.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function w(a,c){function b(){h=u.document;a.setInternal("document",new z(h));a.setInternal("window",new z(u));e.detach();h.open("text/html","replace");h.write(q);h.close()}var e=a.get("iframe"),q=y(a._UUID,a.get("customStyle"),
a.get("customLink"),c),g=e[0],u=g.contentWindow,h;e.__loaded=1;try{h=u.document}catch(s){if(g.src=g.src,7>k){setTimeout(b,10);return}}b()}function j(a,c){var b=s.getEmptyIframeSrc()||"";b&&(b=' src="'+b+'" ');var b=new z(i.substitute(u,{iframeSrc:b})),q=a.get("textarea");q.hasAttr("tabindex")&&b.attr("tabIndex",e.webkit?-1:q.attr("tabIndex"));q.parent().prepend(b);a.set("iframe",b);a.__docReady=0;if(e.gecko&&!b.__loaded)b.on("load",function(){w(a,c)},a);else w(a,c)}var b=!0,a=a,h=i.all,c=!1,g=document,
e=i.UA,k=e.ie,s=i.DOM,C=s.NodeType,z=i.Node,A=i.Event,G=v.tryThese,q="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor' >{data}{script}</body></html>",u='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',F='<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap" '+(e.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':
"")+"></div><div class='ks-editor-status'></div>";i.mix(m,{SOURCE_MODE:0,WYSIWYG_MODE:1});var E=m.WYSIWYG_MODE;i.augment(m,{createDom:function(){var a,c=this.get("textarea"),b;c?c[0].parentNode.removeChild(c[0]):this.set("textarea",c=h("<textarea class='ks-editor-textarea'></textarea>"));b=this.get("el");b.html(F);a=b.one(".ks-editor-textarea-wrap");this._UUID=i.guid();this.set({toolBarEl:b.one(".ks-editor-tools"),statusBarEl:b.one(".ks-editor-status")},{silent:1});c.css("width","100%");c.css("display",
"none");a.append(c);t.register(this)},renderUI:function(){d.init(this);l.init(this);o.init(this);n.init(this)},bindUI:function(){function a(){c.detach("docReady",a);if(c.get("focused"))c.focus();else{var b=c.getSelection();b&&b.removeAllRanges()}}var c=this,b,e=c.get("prefixCls"),q=c.get("textarea");if(c.get("attachForm")&&(b=q[0].form))A.on(b,"submit",c.sync,c),c.on("destroy",function(){A.detach(b,"submit",c.sync,c)});c.on("docReady",a);c.on("blur",function(){c.get("el").removeClass(e+"editor-focused")});
c.on("focus",function(){c.get("el").addClass(e+"editor-focused")})},_uiSetHeight:function(a){var c=this.get("textarea"),b=this.get("toolBarEl"),e=this.get("statusBarEl"),a=parseInt(a,10),a=a-((b&&b.outerHeight()||0)+(e&&e.outerHeight()||0));c.parent().css("height",a);c.css("height",a)},_uiSetMode:function(a){var c=this,b,e=c.get("rendered"),q=c.get("iframe"),g=c.get("textarea");a==E?(e&&c.execCommand("save"),c.on("docReady",b=function(){e&&c.execCommand("save");c.detach("docReady",b)}),c._setData(g.val()),
c.fire("wysiwygMode")):(q&&(g.val(c._getData(1,E)),q.hide()),g.show(),c.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],c=this.get("window");this.sync();t.remove(this);A.remove([a,a.documentElement,a.body,c[0]]);i.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,
c){this.__controls[a]=c},showDialog:function(a,c){var a=a+"/dialog",b=this.__controls[a];b.show(c);this.fire("dialogShow",{dialog:b.dialog,pluginDialog:b,dialogName:a})},addCommand:function(a,c){this.__commands[a]=c},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var c=this.__commands[a],b=i.makeArray(arguments);b.shift();b.unshift(this);if(c)return c.exec.apply(c,b)},queryCommandValue:function(a){return this.execCommand(v.getQueryCmd(a))},_getData:function(c,b){var e=this.htmlDataProcessor,
q;b==a&&(b=this.get("mode"));q=b==E?this.get("document")[0].body.innerHTML:e.toDataFormat(this.get("textarea").val());q=c?e.toHtml(q):e.toServer(q);q=i.trim(q);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(q)&&(q="");return q},_setData:function(a){var c,b=a;if(this.get("mode")!=E)this.get("textarea").val(a);else{if(c=this.htmlDataProcessor)b=c.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");c=this.get("window")[0];var e=this.get("document")[0];A.remove([e,e.documentElement,e.body,c]);
a.remove()}j(this,b)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return y(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return m.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("window");if(a){var c=this.get("document")[0],a=a[0];e.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{c.body.focus()}catch(b){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,c){var b=this.get("customStyle")||"",b=b+("\n"+a);this.set("customStyle",b);s.addStyleSheet(this.get("window"),b,c)},removeCustomStyle:function(a){s.remove(s.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var c=this.get("customLink")||[],b=this.get("document")[0];c.push(a);this.set("customLink",c);c=b.createElement("link");c.rel="stylesheet";b.getElementsByTagName("head")[0].appendChild(c);c.href=a},removeCustomLink:function(a){for(var c=
this.get("document")[0],c=s.query("link",c),b=0;b<c.length;b++)s.attr(c[b],"href")==a&&s.remove(c[b]);c=this.get("customLink")||[];a=i.indexOf(a,c);-1!=a&&c.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var c=a.getSelection();if(c&&!c.isInvalid){var b=c.getStartElement(),e=new m.ElementPath(b);if(!a.__previousPath||
!a.__previousPath.compare(e))a.__previousPath=e,a.fire("selectionChange",{selection:c,path:e,element:b})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(c){if(this.get("mode")===E){this.focus();var e,q=c.nodeName(),g=m.XHTML_DTD,u=g.$block[q],k=m.RANGE,h=(q=this.getSelection())&&q.getRanges(),s,F,d;if(h&&0!=h.length){this.execCommand("save");for(F=h.length-1;0<=F;F--)s=h[F],e=!F&&c||c.clone(b),s.insertNodeByDtd(e),d||(d=e);if(d)return s.moveToPosition(d,
k.POSITION_AFTER_END),u&&(c=m.Walker.whitespaces(!0),(c=(d=d.next(c,1))&&d[0].nodeType==C.ELEMENT_NODE&&d.nodeName())&&g.$block[c]&&g[c]["#text"]&&s.moveToElementEditablePosition(d)),q.selectRanges([s]),this.focus(),e&&1==e[0].nodeType&&e.scrollIntoView(a,!1),J.call(this),e}}},insertHtml:function(b,e){var q=this,g,u=q.get("document")[0];if(q.get("mode")===E){if(g=q.htmlDataProcessor)b=g.toDataFormat(b,e);q.focus();q.execCommand("save");if(k){g=u.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(b)}catch(h){}}else try{u.execCommand("inserthtml",
c,b)}catch(F){setTimeout(function(){if(0==q.getSelection().getRanges().length){var e=new m.Range(u),g=s.first(u.body,function(a){return 1==a.nodeType&&"br"!=s.nodeName(a)});g||(g=new z(u.createElement("p")),g._4e_appendBogus(a),u.body.appendChild(g[0]));e.setStartAt(g,m.RANGE.POSITION_AFTER_START);e.select()}u.execCommand("inserthtml",c,b)},50)}setTimeout(function(){q.getSelection().scrollIntoView()},50);J.call(q)}}});m._initIFrame=function(a){var q=t.getInstance(a),g=q.get("document")[0],a=g.getElementById("ke_active_script");
s.remove(a);p(q);var u=g.body;k?(u.hideFocus=b,u.disabled=b,u.contentEditable=b,u.removeAttribute("disabled")):setTimeout(function(){e.gecko||e.opera?u.contentEditable=b:e.webkit?u.parentNode.contentEditable=b:g.designMode="on"},0);if(e.gecko||e.opera){var h=g.documentElement;A.on(h,"mousedown",function(a){if(a.target==h){e.gecko&&x(g,c);q.activateGecko()}})}setTimeout(function(){k&&setTimeout(function(){if(g){u.runtimeStyle.marginBottom="0px";u.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){q.__docReady=
1;q.fire("docReady");var a=q.get("disableObjectResizing"),b=q.get("disableInlineTableEditing");if(a||b)try{g.execCommand("enableObjectResizing",c,!a);g.execCommand("enableInlineTableEditing",c,!b)}catch(e){A.on(u,k?"resizestart":"resize",function(c){var e=new z(c.target);(a||e.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var J=i.buffer(function(){this.execCommand("save")},50);return m},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
KISSY.add("editor/core/elementPath",function(i){function m(i){for(var n=f,m=f,p=[];i;){if(i[0].nodeType==t.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=i);var y=i.nodeName();if(!m&&(!n&&d[y]&&(n=i),l[y])){var w;if(w=!n)if(w="div"==y){a:{w=i[0].childNodes;for(var j=0,b=w.length;j<b;j++){var a=w[j];if(a.nodeType==t.NodeType.ELEMENT_NODE&&r.$block[a.nodeName.toLowerCase()]){w=!0;break a}}w=!1}w=!w}w?n=i:m=i}p.push(i);if("body"==y)break}i=i.parent()}this.block=n;this.blockLimit=m;this.elements=
p}var v=i.Editor,t=i.DOM,r=v.XHTML_DTD,f=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},l={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};m.prototype={compare:function(d){var i=this.elements,d=d&&d.elements;if(!d||i.length!=d.length)return!1;for(var f=0;f<i.length;f++)if(!t.equals(i[f],d[f]))return!1;return!0},contains:function(d){for(var i=this.elements,l=0;l<i.length;l++)if(i[l].nodeName()in d)return i[l];return f},toString:function(){var d=
this.elements,i,f=[];for(i=0;i<d.length;i++)f.push(d[i].nodeName());return f.toString()}};return v.ElementPath=m},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(i,m,v,t){function r(f){var m;m=f.getSelection().getRanges();for(var r=m.length-1;0<r;r--)m[r].deleteContents();m=m[0];r=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var j=(new t(m.startContainer)).block;if(j&&("li"==j.nodeName()||"li"==j.parent().nodeName()))return f.hasCommand("outdent")?(f.execCommand("save"),f.execCommand("outdent"),f.execCommand("save"),!0):!1}var b=m.splitBlock("p");if(!b)return!0;var f=b.previousBlock,j=b.nextBlock,a=b.wasStartOfBlock,
h=b.wasEndOfBlock,c;if(j)c=j.parent(),"li"==c.nodeName()&&(j._4e_breakParent(c),j._4e_move(j.next(),!0));else if(f&&(c=f.parent())&&"li"==c.nodeName())f._4e_breakParent(c),m.moveToElementEditablePosition(f.next()),f._4e_move(f.prev());if(!a&&!h){if("li"==j.nodeName()&&(c=j.first(v.invisible(!0)))&&i.inArray(c.nodeName(),["ul","ol"]))(d.ie?new n(r.createTextNode("\u00a0")):new n(r.createElement("br"))).insertBefore(c);j&&m.moveToElementEditablePosition(j)}else{var g;if(f){if("li"==f.nodeName()||!l.test(f.nodeName()))g=
f.clone()}else j&&(g=j.clone());g||(g=new n("<p>",null,r));if(c=b.elementPath)for(var b=0,e=c.elements.length;b<e;b++){var k=c.elements[b];if(k.equals(c.block)||k.equals(c.blockLimit))break;o.$removeEmpty[k.nodeName()]&&(k=k.clone(),g._4e_moveChildren(k),g.append(k))}d.ie||g._4e_appendBogus();m.insertNode(g);if(d.ie&&a&&(!h||!f[0].childNodes.length))m.moveToElementEditablePosition(h?f:g),m.select();m.moveToElementEditablePosition(a&&!h?j:g)}d.ie||(j?(g=new n(r.createElement("span")),g.html("&nbsp;"),
m.insertNode(g),g.scrollIntoView(void 0,!1),m.deleteContents()):g.scrollIntoView(void 0,!1));m.select();return!0}function f(d){var f=d.get("document")[0];x.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){d.execCommand("save");var i=d.execCommand("enterBlock");d.execCommand("save");!1!==i&&f.preventDefault()}})}var d=i.UA,l=/^h[1-6]$/,o=m.XHTML_DTD,n=i.Node,x=i.Event;return{init:function(d){d.addCommand("enterBlock",{exec:r});d.docReady(function(){f(d)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(i){function m(){var f=this;f.__iframeFocus=o;l=f;d&&clearTimeout(d);d=setTimeout(function(){f.fire("focus")},100)}function v(){var f=this;f.__iframeFocus=n;l=x;d&&clearTimeout(d);d=setTimeout(function(){f.fire("blur")},100)}var t=i.Editor,r=i.Event,f={},d,l,i={refreshAll:function(){for(var d in f)if(f.hasOwnProperty(d)){var i=f[d].get("document")[0];i.designMode="off";i.designMode="on"}},currentInstance:function(){return l},getInstance:function(d){return f[d]},
add:function(d){var f=d.get("window")[0];r.on(f,"focus",m,d);r.on(f,"blur",v,d)},register:function(d){f[d._UUID]=d},remove:function(d){delete f[d._UUID];var i=d.get("window")[0];r.remove(i,"focus",m,d);r.remove(i,"blur",v,d)}},o=!0,n=!1,x=null;i.refreshAll=i.refreshAll;t.focusManager=i;t.getInstances=function(){return f};return i},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(i,m){return{init:function(v){function t(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function r(a){return a.replace(y,function(a,c,b){return"<"+c+b.replace(w,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function f(a){return a.replace(b,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function d(c){return c.replace(a,function(a,c){return decodeURIComponent(c)})}var l=i.Node,o=i.UA,n=i.require("htmlparser"),x=new n.Filter,p=new n.Filter;(function(){function a(c){c=n.serialize(c);return new n.Comment(j+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,noscript:a,span:t}},b={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=
["name","href","src"],b,e=0;e<c.length;e++)b="_ke_saved_"+c[e],a.getAttribute(b)&&a.removeAttribute(c[e]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:t},attributes:{style:function(a){if(!i.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,j.length)==j)return a=i.trim(decodeURIComponent(a.substr(j.length))),n.parse(a).childNodes[0]}};o.ie&&(b.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(b);p.addRules(c)})();(function(){function a(c){for(var c=c.childNodes,b=c.length,e=c[b-1];e&&3==e.nodeType&&!i.trim(e.nodeValue);)e=c[--b];return e}function c(b,q){var g=a(b);g&&((q||!o.ie)&&1==g.nodeType&&"br"==g.nodeName?b.removeChild(g):
3==g.nodeType&&h.test(g.nodeValue)&&b.removeChild(g))}function b(c){var q=a(c);return!q||1==q.nodeType&&"br"==q.nodeName||"form"==c.nodeName&&"input"==q.nodeName}function g(a){c(a,!0);b(a)&&(o.ie?a.appendChild(new n.Text("\u00a0")):(a.appendChild(new n.Text("&nbsp;")),a.appendChild(new n.Tag("br"))))}function d(a){c(a,!1);b(a)&&a.appendChild(new n.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,f=m.XHTML_DTD,q=i.merge(f.$block,f.$listItem,f.$tableContent),u;for(u in q)q.hasOwnProperty(u)&&("br"in f[u]||
delete q[u]);delete q.td;delete q.pre;var f={tags:{}},F={tags:{}};for(u in q)q.hasOwnProperty(u)&&(f.tags[u]=g,F.tags[u]=d);p.addRules(f);x.addRules(F)})();x.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var y=/<(a|area|img|input)\b([^>]*)>/gi,w=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}",b=/(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,a=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,h=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
c=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,g=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;v.htmlDataProcessor={dataFilter:p,htmlFilter:x,toHtml:function(a){var c=new n.BeautifyWriter;(new n.Parser(a)).parse().writeHtml(c,x);return a=c.getHtml()},toDataFormat:function(a,b){var b=b||p,a=r(a),a=f(a),a=a.replace(h,"$1ke:$2"),a=a.replace(g,"<ke:$1$2></ke:$1>"),i=new l("<div>");i.html("a"+a);a=i.html().substr(1);a=a.replace(c,"$1$2");a=d(a);i=new n.BasicWriter;
(new n.Parser(a)).parse().writeHtml(i,b);return a=i.getHtml()},toServer:function(a){var c=new n.MinifyWriter;(new n.Parser(a)).parse().writeHtml(c,x);return c.getHtml()}}}}},{requires:["./base"]});
KISSY.add("editor/core/range",function(i,m,v,t,r){function f(b){var g=b.nodeType!=a.NodeType.TEXT_NODE&&a.nodeName(b)in c.$removeEmpty,e=b.nodeType==a.NodeType.TEXT_NODE&&!i.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return g||e||b}function d(a){return!s(a)&&!C(a)}function l(c){var b=y;return function(g){if(C(g))return p;if(g.nodeType==a.NodeType.TEXT_NODE){if(i.trim(g.nodeValue).length)return y}else if(g.nodeType==a.NodeType.ELEMENT_NODE&&(g=a.nodeName(g),!G[g]))if(!c&&!h.ie&&
"br"==g&&!b)b=p;else return y;return p}}function o(c,b){var e=c.startContainer,d=c.endContainer,f=c.startOffset,k=c.endOffset,h,i=y,s=y,j=void 0,l=c.document,O;0<b&&(j=l.createDocumentFragment());if(c.collapsed)return j;c.optimizeBookmark();d[0].nodeType==a.NodeType.TEXT_NODE?(s=p,d=d._4e_splitText(k)):0<d[0].childNodes.length&&(k>=d[0].childNodes.length?(d=new g(d[0].appendChild(l.createTextNode(""))),O=p):d=new g(d[0].childNodes[k]));e[0].nodeType==a.NodeType.TEXT_NODE?(i=p,e._4e_splitText(f)):
f?f>=e[0].childNodes.length?(e=new g(e[0].appendChild(l.createTextNode(""))),h=p):e=new g(e[0].childNodes[f].previousSibling):(h=new g(l.createTextNode("")),e.prepend(h),e=h,h=p);var m=e._4e_parents(),I=d._4e_parents();m.each(function(a,c){m[c]=a});I.each(function(a,c){I[c]=a});for(var D,L,l=0;l<m.length&&!(D=m[l],L=I[l],!D.equals(L));l++);for(var f=j,B,H,n=l;n<m.length;n++){B=m[n];k=0<b&&!B.equals(e)?f.appendChild(B.clone()[0]):null;B=B[0].nextSibling;H=I[n];for(var C=d[0],o=H&&H[0];B&&!(o==B||C==
B);)H=B.nextSibling,2==b?f.appendChild(B.cloneNode(p)):(a._4e_remove(B),1==b&&f.appendChild(B)),B=H;k&&(f=k)}for(f=j;l<I.length;l++){B=I[l];k=0<b&&!B.equals(d)?f.appendChild(B.clone()[0]):null;if(!m[l]||!B._4e_sameLevel(m[l]))for(B=B[0].previousSibling;B;)H=B.previousSibling,2==b?f.insertBefore(B.cloneNode(p),f.firstChild):(a._4e_remove(B),1==b&&f.insertBefore(B,f.firstChild)),B=H;k&&(f=k)}if(2==b){if(i&&(D=e[0],D.nodeType==a.NodeType.TEXT_NODE&&D.nextSibling&&D.nextSibling.nodeType==a.NodeType.TEXT_NODE&&
(D.data+=D.nextSibling.data,D.parentNode.removeChild(D.nextSibling))),s)s=d[0],s.nodeType==a.NodeType.TEXT_NODE&&s.previousSibling&&s.previousSibling.nodeType==a.NodeType.TEXT_NODE&&(s.previousSibling.data+=s.data,s.parentNode.removeChild(s))}else{if(D&&L&&(!e._4e_sameLevel(D)||!d._4e_sameLevel(L)))s=D._4e_index(),h&&D._4e_sameLevel(e)&&s--,c.setStart(D.parent(),s+1);c.collapse(p)}h&&e.remove();O&&d.remove();return j}function n(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=w;this.collapsed=p;this.document=a}m.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var p=!0,y=!1,w=null,j=m.RANGE,b=m.POSITION,a=i.DOM,h=i.UA,c=m.XHTML_DTD,g=i.Node,e=g.all,k={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},s=new t.whitespaces,C=new t.bookmark,z=t.whitespaces(p),A=t.bookmark(!1,!0),G={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};i.augment(x,{toString:function(){var a=[],c=this.startContainer[0],b=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var c=
this.startContainer,b=this.startOffset;c[0].nodeType!=a.NodeType.ELEMENT_NODE&&(b?b>=c[0].nodeValue.length&&this.setStartAfter(c):this.setStartBefore(c));c=this.endContainer;b=this.endOffset;c[0].nodeType!=a.NodeType.ELEMENT_NODE&&(b?b>=c[0].nodeValue.length&&this.setEndAfter(c):this.setEndBefore(c))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,c=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);c&&"span"==c.nodeName()&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(c,b){c[0].nodeType==a.NodeType.ELEMENT_NODE&&k[c.nodeName()]&&(c=c.parent(),b=c._4e_index());this.startContainer=c;this.startOffset=b;this.endContainer||(this.endContainer=c,this.endOffset=b);n(this)},
setEnd:function(c,b){c[0].nodeType==a.NodeType.ELEMENT_NODE&&k[c.nodeName()]&&(c=c.parent(),b=c._4e_index()+1);this.endContainer=c;this.endOffset=b;this.startContainer||(this.startContainer=c,this.startOffset=b);n(this)},setStartAt:function(c,b){switch(b){case j.POSITION_AFTER_START:this.setStart(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==a.NodeType.TEXT_NODE?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(c);
break;case j.POSITION_AFTER_END:this.setStartAfter(c)}n(this)},setEndAt:function(c,b){switch(b){case j.POSITION_AFTER_START:this.setEnd(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==a.NodeType.TEXT_NODE?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(c);break;case j.POSITION_AFTER_END:this.setEndAfter(c)}n(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=p},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=a.NodeType.ELEMENT_NODE||
c.endContainer[0].nodeType!=a.NodeType.ELEMENT_NODE)return w;var b=new t(c);b.evaluator=function(a){return z(a)&&A(a)};c=b.next();b.reset();b=b.previous();return c&&c.equals(b)?c:w},shrink:function(c,b){if(!this.collapsed){var c=c||j.SHRINK_TEXT,e=this.clone(),g=this.startContainer,d=this.endContainer,f=this.startOffset,k=this.endOffset,h=p,i,s,l=p;g&&g[0].nodeType==a.NodeType.TEXT_NODE&&(f?f>=g[0].nodeValue.length?e.setStartAfter(g):(e.setStartBefore(g),h=y):e.setStartBefore(g));d&&d[0].nodeType==
a.NodeType.TEXT_NODE&&(k?k>=d[0].nodeValue.length?e.setEndAfter(d):(e.setEndAfter(d),l=y):e.setEndBefore(d));if(h||l)s=new t(e),s.evaluator=function(b){return b.nodeType==(c==j.SHRINK_ELEMENT?a.NodeType.ELEMENT_NODE:a.NodeType.TEXT_NODE)},s.guard=function(b,e){if(c==j.SHRINK_ELEMENT&&b.nodeType==a.NodeType.TEXT_NODE||e&&b==i)return y;!e&&b.nodeType==a.NodeType.ELEMENT_NODE&&(i=b);return p};h&&(e=s[c==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,b?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);
l&&(s.reset(),(s=s[c==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(s,b?j.POSITION_BEFORE_END:j.POSITION_AFTER_END));return h||l}},createBookmark2:function(c){var b=this.startContainer,e=this.endContainer,d=this.startOffset,f=this.endOffset,k,h;if(!b||!e)return{start:0,end:0};if(c){if(b[0].nodeType==a.NodeType.ELEMENT_NODE&&(k=new g(b[0].childNodes[d]))&&k[0]&&k[0].nodeType==a.NodeType.TEXT_NODE&&0<d&&k[0].previousSibling.nodeType==a.NodeType.TEXT_NODE)b=k,d=0;for(;b[0].nodeType==
a.NodeType.TEXT_NODE&&(h=b.prev(void 0,1))&&h[0].nodeType==a.NodeType.TEXT_NODE;)b=h,d+=h[0].nodeValue.length;if(!this.collapsed){if(e[0].nodeType==a.NodeType.ELEMENT_NODE&&(k=new g(e[0].childNodes[f]))&&k[0]&&k[0].nodeType==a.NodeType.TEXT_NODE&&0<f&&k[0].previousSibling.nodeType==a.NodeType.TEXT_NODE)e=k,f=0;for(;e[0].nodeType==a.NodeType.TEXT_NODE&&(h=e.prev(void 0,1))&&h[0].nodeType==a.NodeType.TEXT_NODE;)e=h,f+=h[0].nodeValue.length}}return{start:b._4e_address(c),end:this.collapsed?w:e._4e_address(c),
startOffset:d,endOffset:f,normalized:c,is2:p}},createBookmark:function(a){var c,b,e,d,f=this.collapsed;c=new g("<span>",w,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");a&&(e=i.guid("ke_bm_"),c.attr("id",e+"S"));f||(b=c.clone(),b.html("&nbsp;"),a&&b.attr("id",e+"E"),d=this.clone(),d.collapse(),d.insertNode(b));d=this.clone();d.collapse(p);d.insertNode(c);b?(this.setStartAfter(c),this.setEndBefore(b)):this.moveToPosition(c,j.POSITION_AFTER_END);return{startNode:a?
e+"S":c,endNode:a?e+"E":b,serializable:a,collapsed:f}},moveToPosition:function(a,c){this.setStartAt(a,c);this.collapse(p)},trim:function(c,b){var e=this.startContainer,g=this.startOffset,d=this.collapsed;if((!c||d)&&e[0]&&e[0].nodeType==a.NodeType.TEXT_NODE){if(g)if(g>=e[0].nodeValue.length)g=e._4e_index()+1,e=e.parent();else{var f=e._4e_splitText(g),g=e._4e_index()+1,e=e.parent();a.equals(this.startContainer,this.endContainer)?this.setEnd(f,this.endOffset-this.startOffset):a.equals(e,this.endContainer)&&
(this.endOffset+=1)}else g=e._4e_index(),e=e.parent();this.setStart(e,g);if(d){this.collapse(p);return}}e=this.endContainer;g=this.endOffset;!b&&!d&&e[0]&&e[0].nodeType==a.NodeType.TEXT_NODE&&(g?(g>=e[0].nodeValue.length||e._4e_splitText(g),g=e._4e_index()+1):g=e._4e_index(),e=e.parent(),this.setEnd(e,g))},insertNode:function(a){this.optimizeBookmark();this.trim(y,p);var c=this.startContainer;c[0].insertBefore(a[0],c[0].childNodes[this.startOffset]||null);c[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(a){var c=e(this.document);if(a.is2){var b=c._4e_getByAddress(a.start,a.normalized),g=a.startOffset,c=a.end&&c._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(b,g);c?this.setEnd(c,a):this.collapse(p)}else b=(g=a.serializable)?i.one("#"+a.startNode,c):a.startNode,a=g?i.one("#"+a.endNode,c):a.endNode,this.setStartBefore(b),b._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(p)},getCommonAncestor:function(c,b){var e=
this.startContainer,d=this.endContainer,e=e[0]==d[0]?c&&e[0].nodeType==a.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new g(e[0].childNodes[this.startOffset]):e:e._4e_commonAncestor(d);return b&&e[0].nodeType==a.NodeType.TEXT_NODE?e.parent():e},enlarge:function(){function c(b,g,d,f){var k=b[g?"startContainer":"endContainer"],h,i=g?0:1,q=0,j=g?"previousSibling":"nextSibling";h=b[g?"startOffset":"endOffset"];if(k[0].nodeType==a.NodeType.TEXT_NODE){if(g){if(h)return}else if(h<k[0].nodeValue.length)return;
h=k[0][j];k=k[0].parentNode}else h=k[0].childNodes[h+(g?-1:1)]||null,k=k[0];for(;k;){for(;h;)if(s(h)||C(h))h=h[j];else break;if(h){if(!q)b[g?"setStartAfter":"setEndBefore"](e(h));break}k=e(k);if("body"==k.nodeName())break;if(q||k.equals(f))d[i]=k,q=1;else b[g?"setStartBefore":"setEndAfter"](k);h=k[0][j];k=k[0].parentNode}}return function(b){switch(b){case j.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),d=[];c(this,1,d,b);c(this,0,d,b);d[0]&&d[1]&&(b=d[0].contains(d[1])?d[1]:
d[0],this.setStartBefore(b),this.setEndAfter(b));break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:var k=new x(this.document),d=new g(this.document.body);k.setStartAt(d,j.POSITION_AFTER_START);k.setEnd(this.startContainer,this.startOffset);var k=new t(k),f,h,s=t.blockBoundary(b==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),i=function(a){var c=s(a);c||(f=e(a));return c},l=function(c){var b=i(c);!b&&"br"==a.nodeName(c)&&(h=e(c));return b};k.guard=i;k=k.lastBackward();f=f||d;this.setStartAt(f,
"br"!=f.nodeName()&&(!k&&this.checkStartOfBlock()||k&&f.contains(k))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);k=this.clone();k.collapse();k.setEndAt(d,j.POSITION_BEFORE_END);k=new t(k);k.guard=b==j.ENLARGE_LIST_ITEM_CONTENTS?l:i;f=w;k=k.lastForward();f=f||d;this.setEndAt(f,!k&&this.checkEndOfBlock()||k&&f.contains(k)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);h&&this.setEndAfter(h)}}}(),checkStartOfBlock:function(){var c=this.startContainer,b=this.startOffset;if(b&&c[0].nodeType==a.NodeType.TEXT_NODE&&
i.trim(c[0].nodeValue.substring(0,b)).length)return y;this.trim();c=new r(this.startContainer);b=this.clone();b.collapse(p);b.setStartAt(c.block||c.blockLimit,j.POSITION_AFTER_START);c=new t(b);c.evaluator=l(p);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,b=this.endOffset;if(c[0].nodeType==a.NodeType.TEXT_NODE&&i.trim(c[0].nodeValue.substring(b)).length)return y;this.trim();c=new r(this.endContainer);b=this.clone();b.collapse(y);b.setEndAt(c.block||c.blockLimit,j.POSITION_BEFORE_END);
c=new t(b);c.evaluator=l(y);return c.checkForward()},checkBoundaryOfElement:function(a,c){var b=this.clone();b[c==j.START?"setStartAt":"setEndAt"](a,c==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);b=new t(b);b.evaluator=f;return b[c==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,g=this.endContainer,d=this.startOffset,k=this.endOffset,f;if(c[0].nodeType==a.NodeType.ELEMENT_NODE)if(f=c[0].childNodes.length,f>d)c=e(c[0].childNodes[d]);else if(0==
f)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=e(c);c=c._4e_nextSourceNode()||c}if(g[0].nodeType==a.NodeType.ELEMENT_NODE)if(f=g[0].childNodes.length,f>k)g=e(g[0].childNodes[k])._4e_previousSourceNode(p);else if(0==f)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=e(g)}c._4e_position(g)&b.POSITION_FOLLOWING&&(c=g);return{startNode:c,endNode:g}},fixBlock:function(c,a){var b=this.createBookmark(),g=e(this.document.createElement(a));this.collapse(c);
this.enlarge(j.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();h.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(b);return g},splitBlock:function(c){var a=new r(this.startContainer),b=new r(this.endContainer),e=a.block,g=b.block,d=w;if(!a.blockLimit.equals(b.blockLimit))return w;"br"!=c&&(e||(e=this.fixBlock(p,c),g=(new r(this.endContainer)).block),g||(g=this.fixBlock(y,c)));c=e&&this.checkStartOfBlock();a=g&&this.checkEndOfBlock();this.deleteContents();
e&&e[0]==g[0]&&(a?(d=new r(this.startContainer),this.moveToPosition(g,j.POSITION_AFTER_END),g=w):c?(d=new r(this.startContainer),this.moveToPosition(e,j.POSITION_BEFORE_START),e=w):(g=this.splitElement(e),!h.ie&&!i.inArray(e.nodeName(),["ul","ol"])&&e._4e_appendBogus()));return{previousBlock:e,nextBlock:g,wasStartOfBlock:c,wasEndOfBlock:a,elementPath:d}},splitElement:function(c){if(!this.collapsed)return w;this.setEndAt(c,j.POSITION_BEFORE_END);var a=this.extractContents(),b=c.clone(y);b[0].appendChild(a);
b.insertAfter(c);this.moveToPosition(c,j.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(c,b){for(var e=0;c;){if(c[0].nodeType==a.NodeType.TEXT_NODE){this.moveToPosition(c,b?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);e=1;break}c[0].nodeType==a.NodeType.ELEMENT_NODE&&c._4e_isEditable()&&(this.moveToPosition(c,b?j.POSITION_BEFORE_END:j.POSITION_AFTER_START),e=1);var g=c,k=e,f=void 0;g[0].nodeType==a.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(f=g[b?"last":"first"](d,1));!k&&
!f&&(f=g[b?"prev":"next"](d,1));c=f}return!!e},selectNodeContents:function(c){var b=c[0];this.setStart(c,0);this.setEnd(c,b.nodeType==a.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,e,g,d=a.nodeName();b=c.$block[d];this.deleteContents();if(b){for(b=this.getCommonAncestor(y,p);(e=c[b.nodeName()])&&(!e||!e[d]);){var k=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(p),b.remove()):g=b;b=k}g&&this.splitElement(g)}this.insertNode(a)}});
v.injectDom({_4e_breakParent:function(c,a){var a=e(a),c=e(c),b,g=new m.Range(c[0].ownerDocument);g.setStartAfter(c);g.setEndAfter(a);b=g.extractContents();g.insertNode(c.remove());c.after(b)}});return m.Range=x},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(i){function m(c){this.document=c;this._={cache:{}};if(p)try{var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=c||a.parentElement&&a.parentElement().ownerDocument!=c)this.isInvalid=r}catch(b){this.isInvalid=r}}function v(c){c=new m(c);return!c||c.isInvalid?f:c}var t=i.Editor;t.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var r=!0,f=null,d=i.UA,l=i.DOM,o=i.Node,n=t.SELECTION,x=t.RANGE,p=d.ie,y=t.Walker,w=t.Range,
j={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};i.augment(m,{getNative:!p?function(){var c=this._.cache;return c.nativeSel||(c.nativeSel=l._getWin(this.document).getSelection())}:function(){var c=this._.cache;return c.nativeSel||(c.nativeSel=this.document.selection)},getType:!p?function(){var c=this._.cache;if(c.type)return c.type;var a=n.SELECTION_TEXT,b=this.getNative();if(b){if(1==b.rangeCount){var b=
b.getRangeAt(0),d=b.startContainer;d==b.endContainer&&d.nodeType==l.NodeType.ELEMENT_NODE&&1==Number(b.endOffset-b.startOffset)&&j[d.childNodes[b.startOffset].nodeName.toLowerCase()]&&(a=n.SELECTION_ELEMENT)}}else a=n.SELECTION_NONE;return c.type=a}:function(){var c=this._.cache;if(c.type)return c.type;var a=n.SELECTION_NONE;try{var b=this.getNative(),d=b.type;"Text"==d&&(a=n.SELECTION_TEXT);"Control"==d&&(a=n.SELECTION_ELEMENT);b.createRange().parentElement&&(a=n.SELECTION_TEXT)}catch(f){}return c.type=
a},getRanges:p?function(){var c=function(c,a){c=c.duplicate();c.collapse(a);for(var b=c.parentElement(),d=b.childNodes,h,i=0;i<d.length;i++){var j=d[i];if(j.nodeType==l.NodeType.ELEMENT_NODE){h=c.duplicate();h.moveToElementText(j);var j=h.compareEndPoints("StartToStart",c),m=h.compareEndPoints("EndToStart",c);h.collapse();if(0<j)break;else{if(!j||1==m&&-1==j)return{container:b,offset:i};if(!m)return{container:b,offset:i+1}}h=f}}h||(h=c.duplicate(),h.moveToElementText(b),h.collapse(!1));h.setEndPoint("StartToStart",
c);h=(""+h.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<h;)h-=d[--i].nodeValue.length}catch(n){h=0}return 0===h?{container:b,offset:i}:{container:d[i],offset:-h}};return function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var d=this.getNative(),a=d&&d.createRange(),f=this.getType();if(!d)return[];if(f==n.SELECTION_TEXT)return d=new w(this.document),f=c(a,r),d.setStart(new o(f.container),f.offset),f=c(a),d.setEnd(new o(f.container),f.offset),b.ranges=[d];if(f==n.SELECTION_ELEMENT){b=
b.ranges=[];for(f=0;f<a.length;f++){for(var h=a.item(f),i=h.parentNode,j=0,d=new w(this.document);j<i.childNodes.length&&i.childNodes[j]!=h;j++);d.setStart(new o(i),j);d.setEnd(new o(i),j+1);b.push(d)}return b}return b.ranges=[]}}():function(c){var a=this._.cache;if(a.ranges&&!c)return a.ranges;var c=[],b=this.getNative();if(!b)return[];for(var d=0;d<b.rangeCount;d++){var f=b.getRangeAt(d),h=new w(this.document);h.setStart(new o(f.startContainer),f.startOffset);h.setEnd(new o(f.endContainer),f.endOffset);
c.push(h)}return a.ranges=c},getStartElement:function(){var c=this._.cache;if(void 0!==c.startElement)return c.startElement;var a,b=this.getNative();switch(this.getType()){case n.SELECTION_ELEMENT:return this.getSelectedElement();case n.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();r;)if(a=d.startContainer,d.startOffset==(a[0].nodeType===l.NodeType.ELEMENT_NODE?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break;a=d.startContainer;
if(a[0].nodeType!=l.NodeType.ELEMENT_NODE)return a.parent();a=new o(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=l.NodeType.ELEMENT_NODE)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==l.NodeType.ELEMENT_NODE;)a=new o(d),d=d.firstChild;return a}if(p)d=b.createRange(),d.collapse(r),a=new o(d.parentElement());else{if((a=b.anchorNode)&&a.nodeType!=l.NodeType.ELEMENT_NODE)a=a.parentNode;a&&(a=new o(a))}}return c.startElement=a},getSelectedElement:function(){var a,b=this._.cache;
if(void 0!==b.selectedElement)return b.selectedElement;p&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(a)a=new o(a);else{a=this.getRanges()[0];for(var e,d,f=2;f&&(!(e=a.getEnclosedNode())||!(e[0].nodeType==l.NodeType.ELEMENT_NODE&&j[e.nodeName()]&&(d=e)));f--)a.shrink(x.SHRINK_ELEMENT);a=d}return b.selectedElement=a},reset:function(){this._.cache={}},selectElement:function(a){var b,e=this.document;if(p)try{b=e.body.createControlRange(),b.addElement(a[0]),b.select()}catch(d){b=e.body.createTextRange(),
b.moveToElementText(a[0]),b.select()}finally{}else b=e.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(p){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select();this.reset()}else if(b=this.getNative()){b.removeAllRanges();for(var e=0;e<a.length;e++){var f=a[e],h=this.document.createRange(),i=f.startContainer;if(f.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&
i[0].nodeType==l.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(d.webkit?"\u200b":"")),f.startOffset++,f.endOffset++;h.setStart(i[0],f.startOffset);h.setEnd(f.endContainer[0],f.endOffset);b.addRange(h)}this.reset()}},createBookmarks2:function(a){for(var b=[],e=this.getRanges(),d=0;d<e.length;d++)b.push(e[d].createBookmark2(a));return b},createBookmarks:function(a,b){for(var e=[],d=this.document,f,b=b||this.getRanges(),h=b.length,j=0;j<h;j++){e.push(f=b[j].createBookmark(a,
r));var m=(a=f.serializable)?i.one("#"+f.startNode,d):f.startNode;f=a?i.one("#"+f.endNode,d):f.endNode;for(var n=j+1;n<h;n++){var o=b[n],p=o.startContainer,t=o.endContainer;l.equals(p,m.parent())&&o.startOffset++;l.equals(p,f.parent())&&o.startOffset++;l.equals(t,m.parent())&&o.endOffset++;l.equals(t,f.parent())&&o.endOffset++}}return e},selectBookmarks:function(a){for(var b=[],e=0;e<a.length;e++){var d=new w(this.document);d.moveToBookmark(a[e]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();p?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},a=y.whitespaces(r),h=/\ufeff|\u00a0/;w.prototype.select=w.prototype.select=!p?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==l.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));
var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(e){if(0<=e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(r),b.setEnd(this.endContainer[0],this.endOffset);else throw e;}a=v(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(c){var d=this.collapsed,e,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];
if(i.nodeType==l.NodeType.ELEMENT_NODE){(new m(this.document)).selectElement(new o(i));return}}(this.startContainer[0].nodeType==l.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==l.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(x.SHRINK_ELEMENT,r);var j=this.createBookmark(),i=j.startNode,n;d||(n=j.endNode);j=this.document.body.createTextRange();j.moveToElementText(i[0]);j.moveStart("character",1);if(n)c=this.document.body.createTextRange(),
c.moveToElementText(n[0]),j.setEndPoint("EndToEnd",c),j.moveEnd("character",-1);else{for(e=i[0].nextSibling;e&&!a(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(h))&&(c||!i[0].previousSibling||i[0].previousSibling&&"br"==l.nodeName(i[0].previousSibling));f=new o(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(i);e&&l.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(d){if(e?(j.moveStart("character",-1),j.select(),this.document.selection.clear()):
j.select(),f)this.moveToPosition(f,x.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(n),n._4e_remove(),j.select()};m.getSelection=v;return t.Selection=m},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(i,m){function v(d){function b(a,b){var c=e.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=o}return c}function a(){var b=e.selection.createRange();i&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&i.select();x.remove(e,"mouseup",a);x.remove(e,"mousemove",f);i=c=0}function f(c){if(c.button){if(c=b(c.pageX,c.pageY))0<c.compareEndPoints("StartToStart",i)?c.setEndPoint("StartToStart",i):c.setEndPoint("EndToEnd",i),c.select()}else a()}var c,g=d.get("window")[0],
e=d.get("document")[0],i;x.on(e,"mousedown contextmenu",function(d){var j=e.documentElement;if(d.target===j&&(c&&a(),!(j.scrollHeight>j.clientHeight)&&(c=1,i=b(d.pageX,d.pageY))))x.on(e,"mouseup",a),x.on(e,"mousemove",f),g.focus(),i.select()})}function t(f){function b(c){if(e){var h=f.getSelection(),i=h&&h.getType(),k=h&&a.selection;if(c&&k&&i==w.SELECTION_NONE&&!a.queryCommandEnabled("InsertImage"))setTimeout(function(){b(d)},50);else{var l;if(!k||!k.type||!("Control"!=k.type&&(l=k.createRange())&&
(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))g=k&&h.getRanges()[0],f.checkSelectionChange()}}}var a=f.get("document")[0],h=new y(a.body),c=new y(a.documentElement);if(8>m.Utils.ieEngine)c.on("click",function(a){"html"===(new y(a.target)).nodeName()&&f.getSelection().getNative().createRange().select()});var g,e,i=d;c.on("mousedown",function(){i=l});c.on("mouseup",function(){i=d});h.on("focusin",function(a){if("body"==(new y(a.target)).nodeName()&&g){try{i&&g.select()}catch(b){}g=
o}});h.on("focus",function(){e=d;b()});h.on("beforedeactivate",function(a){a.relatedTarget||(e=l,i=d)});h.on("mousedown",function(){e=l});h.on("mouseup",function(){e=d;setTimeout(function(){b(d)},0)});h.on("keydown",function(){e=l});h.on("keyup",function(){e=d;setTimeout(function(){b()},0)})}function r(d){var b=d.get("document")[0];x.on(b,"mouseup keyup selectionchange",function(){d.checkSelectionChange()})}function f(f){function b(a){var b=m.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function a(a){return c(a)&&g(a)}var h=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,c=m.Walker.whitespaces(d),g=m.Walker.bookmark(l,d),e=function(a){return c(a)&&8!=a.nodeType};f.on("selectionChange",function(c){var g=c.path,i=new y(f.get("document")[0].body),c=(c=c.selection)&&c.getRanges()[0],o=g.blockLimit;if(n.gecko){var r=g.block||g.blockLimit,t=r&&r.last(a);r&&r._4e_isBlockBoundary()&&(!t||!(1==t[0].nodeType&&
t._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(c&&c.collapsed&&!g.block){if("body"==o.nodeName()){if((g=c.fixBlock(d,"p"))&&g[0]!=i[0].lastChild&&g._4e_outerHtml().match(h))if((o=g.next(e,1))&&o[0].nodeType==p.NodeType.ELEMENT_NODE&&!b[o])c.moveToElementEditablePosition(o),g._4e_remove();else if((o=g.prev(e,1))&&o[0].nodeType==p.NodeType.ELEMENT_NODE&&!b[o])c.moveToElementEditablePosition(o,o._4e_outerHtml().match(h)?l:d),g._4e_remove();c.select();f.notifySelectionChange()}g=
f.get("document")[0];c=new m.Range(g);c.moveToElementEditablePosition(i,d);"body"!==(new m.ElementPath(c.startContainer)).blockLimit.nodeName()&&(i=(new y(g.createElement("p"))).appendTo(i),n.ie||i._4e_appendBogus())}})}var d=!0,l=!1,o=null,n=i.UA,x=i.Event,p=i.DOM,y=i.Node,w=m.SELECTION;return{init:function(d){d.docReady(function(){n.ie?(v(d),t(d)):r(d)});f(d)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(i,m){function v(a){return!z.attr(a,"_ke_bookmark")}function t(a,c){for(var b in a)a.hasOwnProperty(b)&&(i.isString(a[b])?a[b]=a[b].replace(R,function(a,b){return c[b]}):t(a[b],c))}function r(a,c){c&&(a=i.clone(a),t(a,c));var b=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==b||Q[b]?A.STYLE_BLOCK:N[b]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function f(a,c){var b=c?this.removeFromRange:this.applyToRange;a.body.focus();
for(var e=new q(a),d=e.getRanges(),f=0;f<d.length;f++)b.call(this,d[f]);e.selectRanges(d)}function d(a,c,b){var e=a.element;"*"==e&&(e="span");c=new E(c.createElement(e));b&&b._4e_copyAttributes(c);b=a._.definition;a=b.attributes;b=r.getStyleText(b);if(a)for(var d in a)a.hasOwnProperty(d)&&c.attr(d,a[d]);b&&(c[0].style.cssText=b);return c}function l(a){var c=a.createBookmark(k),b=a.createIterator();b.enforceRealBlocks=k;b.enlargeBr=k;for(var e,f=a.document;e=b.getNextParagraph();){var g=d(this,f,
e),h=g,g="pre"==h.nodeName,i="pre"==e.nodeName,j=!g&&i;g&&!i?(i=e,j=i.html(),j=o(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),J.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(h[0]),h[0].outerHTML="<pre>"+j+"</pre>",h=new E(i.firstChild),h._4e_remove()):h.html(j)):j?h=x(n(e),h):e._4e_moveChildren(h);e[0].parentNode.replaceChild(h[0],e[0]);if(g&&(e=h,g=void 0,(g=e._4e_previousSourceNode(k,
z.NodeType.ELEMENT_NODE))&&"pre"==g.nodeName()))h=o(g.html(),/\n$/,"")+"\n\n"+o(e.html(),/^\n/,""),J.ie?e[0].outerHTML="<pre>"+h+"</pre>":e.html(h),g._4e_remove()}a.moveToBookmark(c)}function o(a,b,c){var e="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(e=b);c&&(d=c);return""});return e+a.replace(b,c)+d}function n(a){var b=[];o(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+
"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function x(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var d=a[e],d=d.replace(/(\r\n|\r)/g,"\n"),d=o(d,/^[ \t]*\n/,""),d=o(d,/\n$/,""),d=o(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),f=b.clone();f.html(d);c.appendChild(f[0])}return c}function p(a){var b=a.document;if(a.collapsed)b=d(this,b,void 0),a.insertNode(b),a.moveToPosition(b,G.POSITION_BEFORE_END);else{var e=this.element,f=this._.definition,g,h=K[e];h||(g=k,h=K.span);var i=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),l=j.startNode,j=j.endNode,m=l,o;m&&m[0];){var n=s;if(z.equals(m,j))m=C,n=k;else{var p=m[0].nodeType,r=p==z.NodeType.ELEMENT_NODE?m.nodeName():C;if(r&&m.attr("_ke_bookmark")){m=
m._4e_nextSourceNode(k);continue}if(!r||h[r]&&(m._4e_position(j)|u.POSITION_PRECEDING|u.POSITION_IDENTICAL|u.POSITION_IS_CONTAINED)==u.POSITION_PRECEDING+u.POSITION_IDENTICAL+u.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(m))){var q=m.parent();if(q&&"a"==e&&q.nodeName()==e)p=d(this,b,void 0),q._4e_moveChildren(p),q[0].parentNode.replaceChild(p[0],q[0]),p._4e_mergeSiblings();else if(q&&q[0]&&((K[q.nodeName()]||K.span)[e]||g)&&(!f.parentRule||f.parentRule(q))){if(!o&&(!r||!K.$removeEmpty[r]||(m._4e_position(j)|
u.POSITION_PRECEDING|u.POSITION_IDENTICAL|u.POSITION_IS_CONTAINED)==u.POSITION_PRECEDING+u.POSITION_IDENTICAL+u.POSITION_IS_CONTAINED))o=new F(b),o.setStartBefore(m);if(p==z.NodeType.TEXT_NODE||p==z.NodeType.ELEMENT_NODE&&!m[0].childNodes.length){q=m;for(p=null;(n=!q.next(v,1))&&(p=q.parent())&&h[p.nodeName()]&&(p._4e_position(l)|u.POSITION_FOLLOWING|u.POSITION_IDENTICAL|u.POSITION_IS_CONTAINED)==u.POSITION_FOLLOWING+u.POSITION_IDENTICAL+u.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(p));)q=
p;o.setEndAfter(q)}}else n=k}else n=k;m=m._4e_nextSourceNode()}if(n&&o&&!o.collapsed){for(var n=d(this,b,void 0),q=o.getCommonAncestor(),p={},r={},t,w=null,x;n&&q&&n[0]&&q[0];){if(q.nodeName()==e){for(t in f.attributes)if(f.attributes.hasOwnProperty(t)&&!r[t]&&(x=q.attr(w)))n.attr(t)==x?n.removeAttr(t):r[t]=1;for(w in f.styles)if(f.styles.hasOwnProperty(w)&&!p[w]&&(x=q.style(w)))n.style(w)==x?n.style(w,""):p[w]=1;if(!n._4e_hasAttributes()){n=C;break}}q=q.parent()}n?(n[0].appendChild(o.extractContents()),
c(this,n),o.insertNode(n),n._4e_mergeSiblings(),J.ie||n[0].normalize()):(n=new E(b.createElement("span")),n[0].appendChild(o.extractContents()),o.insertNode(n),c(this,n),n._4e_remove(!0));o=C}}l._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(G.SHRINK_TEXT)}}function y(c){c.enlarge(G.ENLARGE_ELEMENT);var e=c.createBookmark(),d=e.startNode;if(c.collapsed){for(var f=new M(d.parent()),h,i=0,j;i<f.elements.length&&(j=f.elements[i])&&!(j==f.block||j==f.blockLimit);i++)if(this.checkElementRemovable(j)){var k=
c.checkBoundaryOfElement(j,G.END),l=!k&&c.checkBoundaryOfElement(j,G.START);l||k?(h=j,h.match=l?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(k=b(this),g(j,k[j.nodeName()]||k["*"])):a(this,j))}if(h){j=d;for(i=0;;i++){k=f.elements[i];if(z.equals(k,h))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(j[0]);j=k}j["start"==h.match?"insertBefore":"insertAfter"](h)}}else{var m=e.endNode,n=this,f=function(){for(var a=new M(d.parent()),b=new M(m.parent()),c=C,e=C,f=0;f<
a.elements.length;f++){var g=a.elements[f];if(g==a.block||g==a.blockLimit)break;n.checkElementRemovable(g)&&(c=g)}for(f=0;f<b.elements.length;f++){g=b.elements[f];if(g==b.block||g==b.blockLimit)break;n.checkElementRemovable(g)&&(e=g)}e&&m._4e_breakParent(e);c&&d._4e_breakParent(c)};f();for(h=new E(d[0].nextSibling);h[0]!==m[0];){i=h._4e_nextSourceNode();if(h[0]&&h[0].nodeType==z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(h)&&(h.nodeName()==this.element?a(this,h):(j=b(this),g(h,j[h.nodeName()]||
j["*"])),i[0].nodeType==z.NodeType.ELEMENT_NODE&&i.contains(d)))f(),i=new E(d[0].nextSibling);h=i}}c.moveToBookmark(e)}function w(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,e){b[c]=e});return b}function j(a,b){var c="";b!==s?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;
var b=a._.overrides={},c=a._.definition.overrides;if(c){i.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var d=c[e],f,g,h;"string"==typeof d?f=d.toLowerCase():(f=d.element?d.element.toLowerCase():a.element,g=d.attributes,h=d.styles);d=b[f]||(b[f]={});if(g){f=d.attributes=d.attributes||[];for(var j in g)g.hasOwnProperty(j)&&f.push([j.toLowerCase(),g[j]])}if(h){var d=d.styles=d.styles||[],k;for(k in h)h.hasOwnProperty(k)&&d.push([k.toLowerCase(),h[k]])}}}return b}function a(a,c){var d=a._.definition,
f=b(a),g=i.merge(d.attributes,(f[c.nodeName()]||f["*"]||{}).attributes),d=i.merge(d.styles,(f[c.nodeName()]||f["*"]||{}).styles),f=i.isEmptyObject(g)&&i.isEmptyObject(d),j;for(j in g)if(g.hasOwnProperty(j)&&!(("class"==j||a._.definition.fullMatch)&&c.attr(j)!=h(j,g[j])))f=f||!!c.hasAttr(j),c.removeAttr(j);for(var l in d)d.hasOwnProperty(l)&&!(a._.definition.fullMatch&&c.style(l)!=h(l,d[l],k))&&(f=f||!!c.style(l),c.style(l,""));e(c)}function h(a,c,b){var d=new E("<span>");d[b?"style":"attr"](a,c);
return d[b?"style":"attr"](a)}function c(c,d){for(var e=b(c),f=d.all(c.element),h=f.length;0<=--h;)a(c,new E(f[h]));for(var i in e)if(e.hasOwnProperty(i)&&i!=c.element){f=d.all(i);for(h=f.length-1;0<=h;h--){var j=new E(f[h]);g(j,e[i])}}}function g(a,c){var b,d=c&&c.attributes;if(d)for(b=0;b<d.length;b++){var f=d[b][0],g;if(g=a.attr(f)){var h=d[b][1];(h===C||h.test&&h.test(g)||"string"==typeof h&&g==h)&&a[0].removeAttribute(f)}}if(d=c&&c.styles)for(b=0;b<d.length;b++)if(f=d[b][0],h=a.css(f)){var i=
d[b][1];(i===C||i.test&&i.test(g)||"string"==typeof i&&h==i)&&a.css(f,"")}e(a)}function e(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(k);c&&(c.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(b))}}var k=!0,s=!1,C=null,z=i.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=m.RANGE,q=m.Selection,u=m.POSITION,F=m.Range,E=i.Node,J=i.UA,M=m.ElementPath,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,
h5:1,h6:1,p:1,pre:1},K=m.XHTML_DTD,N={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;m.STYLE=A;r.prototype={apply:function(a){f.call(this,a,s)},remove:function(a){f.call(this,a,k)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?p:this.type==A.STYLE_BLOCK?l:C).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?y:C).call(this,a)},checkElementRemovable:function(a,
c){if(!a)return s;var d=this._.definition,e;if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return k;var f=d._AC;if(f)d=f;else{var f={},g=0,h=d.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(g++,f[i]=h[i]);if(h=r.getStyleText(d))f.style||g++,f.style=h;f._length=g;d=d._AC=f}if(d._length){for(var l in d)if("_length"!=l&&d.hasOwnProperty(l)){g=a.attr(l)||"";if("style"==l)a:{f=d[l];g=j(g,s);"string"==typeof f&&(f=w(f));"string"==typeof g&&(g=w(g));h=void 0;for(h in f)if(f.hasOwnProperty(h)&&
!(h in g&&(g[h]==f[h]||"inherit"==f[h]||"inherit"==g[h]))){f=s;break a}f=k}else f=d[l]==g;if(f){if(!c)return k}else if(c)return s}if(c)return k}else return k}l=b(this);if(l=l[a.nodeName()]||l["*"]){if(!(d=l.attributes)&&!(e=l.styles))return k;if(d)for(f=0;f<d.length;f++)if(l=d[f][0],l=a.attr(l))if(g=d[f][1],g===C||"string"==typeof g&&l==g||g.test&&g.test(l))return k;if(e)for(f=0;f<e.length;f++)if(l=a.css(e[f][0]))if(d=e[f][1],d===C||"string"==typeof d&&l==d||d.test&&d.test(l))return k}return s},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,k);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var c=a.elements,b=0,d;b<c.length;b++)if(d=c[b],!(this.type==A.STYLE_INLINE&&(z.equals(d,a.block)||z.equals(d,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||d.nodeName()in N)&&this.checkElementRemovable(d,k))return k}return s}};r.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,b=a.attributes&&a.attributes.style||"",d="";b.length&&(b=b.replace(P,";"));for(var e in c)if(c.hasOwnProperty(e)){var f=c[e],g=(e+":"+f).replace(P,
";");"inherit"==f?d+=g:b+=g}b.length&&(b=j(b));return a._ST=b+d};return m.Style=r},{requires:["./base","./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(i){var m=i.Node,v=i.DOM,t=i.UA,r={debugUrl:function(f){var d=i.Config;d.debug||(f=f.replace(/\.(js|css)/i,"-min.$1"));-1==f.indexOf("?t")&&(f=-1!=f.indexOf("?")?f+"&":f+"?",f+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+f},lazyRun:function(f,d,i){var m=f[d],n=f[i];f[d]=function(){m.apply(this,arguments);f[d]=f[i];return n.apply(this,arguments)}},getXY:function(f,d){var i=f.left,m=f.top,n=d.get("window")[0],i=i-v.scrollLeft(n),m=m-v.scrollTop(n),n=
d.get("iframe").offset(),i=i+n.left,m=m+n.top;return{left:i,top:m}},tryThese:function(f){for(var d,i=0,m=arguments.length;i<m;i++){var n=arguments[i];try{d=n();break}catch(r){}}return d},arrayCompare:function(f,d){if(!f&&!d)return!0;if(!f||!d||f.length!=d.length)return!1;for(var i=0;i<f.length;i++)if(f[i]!==d[i])return!1;return!0},clearAllMarkers:function(f){for(var d in f)f.hasOwnProperty(d)&&f[d]._4e_clearMarkers(f,!0,void 0)},ltrim:function(f){return f.replace(/^\s+/,"")},rtrim:function(f){return f.replace(/\s+$/,
"")},isNumber:function(f){return/^\d+(.\d+)?$/.test(i.trim(f))},verifyInputs:function(f){for(var d=0;d<f.length;d++){var l=new m(f[d]),o=i.trim(r.valInput(l)),n=l.attr("data-verify"),l=l.attr("data-warning");if(n&&!RegExp(n).test(o))return alert(l),!1}return!0},sourceDisable:function(f,d){f.on("sourceMode",d.disable,d);f.on("wysiwygMode",d.enable,d)},resetInput:function(f){var d=f.attr("placeholder");d&&t.ie?(f.addClass("ks-editor-input-tip"),f.val(d)):t.ie||f.val("")},valInput:function(f,d){if(void 0===
d)return f.hasClass("ks-editor-input-tip")?"":f.val();f.removeClass("ks-editor-input-tip");f.val(d)},placeholder:function(f,d){f.attr("placeholder",d);t.ie&&(f.on("blur",function(){i.trim(f.val())||(f.addClass("ks-editor-input-tip"),f.val(d))}),f.on("focus",function(){f.removeClass("ks-editor-input-tip");i.trim(f.val())==d&&f.val("")}))},htmlEncode:function(f){return!f?f:(""+f).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(f){var f=i.clone(f),
d;for(d in f)if(f.hasOwnProperty(d)){var l=f[d];i.isFunction(l)&&(f[d]=l())}return f},map:function(f,d){for(var i=0;i<f.length;i++)f[i]=d(f[i]);return f},ieEngine:document.documentMode||t.ie,preventFocus:function(f){t.ie?f.unselectable(void 0):f.attr("onmousedown","return false;")},injectDom:function(f){i.mix(v,f);for(var d in f)f.hasOwnProperty(d)&&function(d){m.prototype[d]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=f[d].apply(null,o))&&(o.nodeType||i.isWindow(o))?new m(o):
i.isArray(o)&&(o.__IS_NODELIST||o[0]&&o[0].nodeType)?new m(o):o}}(d)},addRes:function(){var f=this.__res=this.__res||[];f.push.apply(f,i.makeArray(arguments))},destroyRes:function(){for(var f=this.__res||[],d=0;d<f.length;d++){var l=f[d];i.isFunction(l)?l():l.destroy?l.destroy():l.remove&&l.remove()}this.__res=[]},getQueryCmd:function(f){return"query"+("-"+f).replace(/-(\w)/g,function(d,f){return f.toUpperCase()})+"Value"}};return i.Editor.Utils=r},{requires:["./base"]});
KISSY.add("editor/core/walker",function(i,m){function v(a,b){if(this._.end)return l;var c,g=this.range,e,i=this.guard,j=this.type,m=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,g.trim(),g.collapsed))return this.end(),l;if(!a&&!this._.guardLTR){var o=g.endContainer[0],r=o.childNodes[g.endOffset];this._.guardLTR=function(a,c){return c&&(o==a||"body"==n.nodeName(a))?!1:a!=r}}if(a&&!this._.guardRTL){var t=g.startContainer[0],q=0<g.startOffset&&t.childNodes[g.startOffset-
1]||null;this._.guardRTL=function(a,c){return c&&(t==a||"body"==n.nodeName(a))?!1:a!=q}}var u=a?this._.guardRTL:this._.guardLTR;e=i?function(a,c){return u(a,c)===d?d:i(a,c)}:u;this.current?c=this.current[m](d,j,e):a?(c=g.endContainer,0<g.endOffset?(c=new p(c[0].childNodes[g.endOffset-1]),e(c[0])===d&&(c=l)):c=e(c,f)===d?l:c._4e_previousSourceNode(f,j,e,void 0)):(c=g.startContainer,c=new p(c[0].childNodes[g.startOffset]),c.length?e(c[0])===d&&(c=l):c=e(g.startContainer,f)===d?l:g.startContainer._4e_nextSourceNode(f,
j,e,void 0));for(;c&&!this._.end;){this.current=c;if(!this.evaluator||this.evaluator(c[0])!==d){if(!b)return c}else if(b&&this.evaluator)return d;c=c[m](d,j,e)}this.end();return this.current=l}function t(a){for(var b,c=l;b=v.call(this,a);)c=b;return c}function r(a){this.range=a;this.guard=this.evaluator=l;this._={}}var f=!0,d=!1,l=null,o=i.UA,n=i.DOM,x=m.XHTML_DTD,p=i.Node;i.augment(r,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,f)},checkForward:function(){return v.call(this,
d,f)!==d},checkBackward:function(){return v.call(this,f,f)!==d},lastForward:function(){return t.call(this)},lastBackward:function(){return t.call(this,f)},reset:function(){delete this.current;this._={}},_iterator:v});i.mix(r,{blockBoundary:function(a){return function(b){return!(b.nodeType==n.NodeType.ELEMENT_NODE&&n._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==n.nodeName(a)&&n.attr(a,"_ke_bookmark")}return function(d){var e,f;e=d.nodeType==n.NodeType.TEXT_NODE&&(f=
d.parentNode)&&c(f);e=a?e:e||c(d);return!!(b^e)}},whitespaces:function(a){return function(b){b=b.nodeType==n.NodeType.TEXT_NODE&&!i.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=r.whitespaces();return function(c){c=b(c)||c.nodeType==n.NodeType.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var y=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=r.whitespaces(),j=r.bookmark(),b=function(a){var b=n.nodeName(a);return j(a)||w(a)||1==a.nodeType&&b in x.$inline&&!(b in x.$empty)};m.Utils.injectDom({_4e_getBogus:function(a){a=
new p(a);do a=a._4e_previousSourceNode();while(a&&b(a[0]));a=a&&(!o.ie?"br"==a.nodeName():3==a[0].nodeType&&y.test(a.text()))?a[0]:!1;return a}});return m.Walker=r},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(i){var m=i.Editor,i=m.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};m.baseZIndex=function(i){return(m.Config.baseZIndex||1E4)+i};return i},{requires:["./base"]});
