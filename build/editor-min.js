/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 19 16:41
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(f,o,q){o=q.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:o.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(f){return this._setData(f)}},formatData:{getter:function(){return this._getData(1)},setter:function(f){return this._setData(f)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});o.HTML_PARSER={textarea:function(f){return f.one(".ks-editor-textarea")}};f.mix(o,f.EventTarget);return KISSY.Editor=o},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(f,o,q,s){function v(a){this.editor=a;this._init()}function c(a){if(k.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),d;if(b.getType()==s.SELECTION_ELEMENT&&(d=b.getSelectedElement())){var h=b.getRanges()[0],i=e(a.get("document")[0].createTextNode(""));i.insertBefore(d);h.setStartBefore(i);h.setEndAfter(d);b.selectRanges([h]);setTimeout(function(){d.parent()&&(i.remove(),b.selectElement(d))},0)}}}var e=f.all,k=f.UA,m=o.RANGE,p=f.Event;
f.augment(v,{_init:function(){var a=this.editor;p.on(a.get("document")[0].body,k.webkit?"paste":k.gecko?"paste":"beforepaste",this._paste,this);p.on(a.get("document")[0].body,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new w("copy"));a.addCommand("cut",new w("cut"));a.addCommand("paste",new w("paste"))},_paste:function(){if(!b){var a=this.editor,j=a.get("document")[0];if(!j.getElementById("ke_pastebin")){var d=a.getSelection(),h=new q(j),i=e(k.webkit?"<body></body>":
"<div></div>",null,j);i.attr("id","ke_pastebin");k.webkit&&i[0].appendChild(j.createTextNode("\u00a0"));j.body.appendChild(i[0]);i.css({position:"absolute",top:d.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});i.css("left","-1000px");var l=d.createBookmarks();h.setStartAt(i,m.POSITION_AFTER_START);h.setEndAt(i,m.POSITION_BEFORE_END);h.select(!0);setTimeout(function(){i.remove();var h;i=k.webkit&&(h=i.first())&&h.hasClass("Apple-style-span")?h:i;d.selectBookmarks(l);h=i.html();
if(h=f.trim(h.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var b=a.fire("paste",{html:h,holder:i});void 0!==b&&(h=b);b=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(h)&&(b=a.htmlDataProcessor.wordFilter);a.insertHtml(h,b)}},0)}}}});var x=function(a,b){var d=a.get("document")[0],h=e(d.body),i=!1,l=function(){i=!0};h.on(b,l);(7<k.ie?d:d.selection.createRange()).execCommand(b);h.detach(b,l);return i},n=k.ie?function(a,b){return x(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(d){return!1}},
t={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},w=function(a){this.type=a};w.prototype={exec:function(a){"cut"==this.type&&c(a);(a=n(a,this.type))||alert(t[this.type]);return a}};var a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;return{init:function(g){g.docReady(function(){new v(g)});var b={copy:1,cut:1,paste:1};g.on("contextmenu",function(d){d=d.contextmenu;if(!d.__copy_fix){d.__copy_fix=
1;for(var h in b)b.hasOwnProperty(h)&&d.addChild({xclass:"menuitem",content:a[h],value:h});d.on("click",function(a){var h=a.target.get("value");b[h]&&(this.hide(),setTimeout(function(){g.execCommand(h)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core/dom",function(f,o,q){function s(a,b){var g=a[b?"next":"prev"](v,1);if(g&&g[0].nodeType==e.ELEMENT_NODE){for(var j=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemovable(v);)if(j.push(g),g=b?g.next(v,1):g.prev(v,1),!g)return;if(a._4e_isIdentical(g,v)){for(var d=new m(b?a[0].lastChild:a[0].firstChild);j.length;)j.shift()._4e_move(a,!b,v);g._4e_moveChildren(a,!b,v);g.remove();d[0]&&d[0].nodeType==e.ELEMENT_NODE&&d._4e_mergeSiblings()}}}var v=v,c=o.XHTML_DTD,e=f.DOM,k=f.UA,m=f.Node,
p={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};o.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var x=o.POSITION,n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},t={hr:1},w=function(a){return a&&(a[0]||a)};q.injectDom({_4e_sameLevel:function(a,b){var b=w(b),g=a.parentNode;return g&&g==b.parentNode},_4e_isBlockBoundary:function(a,b){var g=f.merge(t,b);return!(!n[e.css(a,"display")]&&!g[e.nodeName(a)])},_4e_index:function(a,b){for(var g=a.parentNode.childNodes,j,d=-1,h=0;h<g.length;h++)if(j=g[h],!b||!(3==j.nodeType&&j.previousSibling&&3==j.previousSibling.nodeType))if(d++,j===a)return d;return-1},_4e_move:function(a,b,g){b=
w(b);g?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_isIdentical:function(a,b){if(!b)return!1;b=w(b);if(e.nodeName(a)!=e.nodeName(b))return!1;var g=a.attributes,j=b.attributes,d=g.length,h=j.length;if(d!=h)return!1;for(var i=0;i<d;i++){var l=g[i],r=l.name;if(l.specified&&e.attr(a,r)!=e.attr(b,r))return!1}if(8>q.ieEngine)for(i=0;i<h;i++)if(l=j[i],r=l.name,l.specified&&e.attr(a,r)!=e.attr(b,r))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!c.$removeEmpty[e.nodeName(a)])return!1;
for(var a=a.childNodes,b=0,g=a.length;b<g;b++){var j=a[b],d=j.nodeType;if(!(d==e.ELEMENT_NODE&&j.getAttribute("_ke_bookmark"))&&(d==e.ELEMENT_NODE&&!e._4e_isEmptyInlineRemovable(j)||d==e.TEXT_NODE&&f.trim(j.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,b,g){b=w(b);if(a!=b)if(g)for(;g=a.lastChild;)b.insertBefore(a.removeChild(g),b.firstChild);else for(;g=a.firstChild;)b.appendChild(a.removeChild(g))},_4e_mergeSiblings:function(a){a=new m(a);p[a.nodeName()]&&(s(a,!0),s(a))},_4e_splitText:function(a,
b){var g=a.ownerDocument;if(a.nodeType==e.TEXT_NODE){if(k.ie&&b==a.nodeValue.length){var j=g.createTextNode("");e.insertAfter(j,a);return j}j=a.splitText(b);g.documentMode&&(g=g.createTextNode(""),e.insertAfter(g,j),e.remove(g));return j}},_4e_parents:function(a,b){var g=[];g.__IS_NODELIST=1;do g[b?"push":"unshift"](a);while(a=a.parentNode);return g},_4e_nextSourceNode:function(a,b,g,j){if(j&&!j.call)var d=w(j),j=function(a){return a!==d};var b=!b&&a.firstChild,h=a;if(!b){if(a.nodeType==e.ELEMENT_NODE&&
j&&!1===j(a,!0))return null;b=a.nextSibling}for(;!b&&(h=h.parentNode);){if(j&&!1===j(h,!0))return null;b=h.nextSibling}return!b||j&&!1===j(b)?null:g&&g!=b.nodeType?e._4e_nextSourceNode(b,!1,g,j):b},_4e_previousSourceNode:function(a,b,g,j){if(j&&!j.call)var d=w(j),j=function(a){return a!==d};var b=!b&&a.lastChild,h=a;if(!b){if(a.nodeType==e.ELEMENT_NODE&&j&&!1===j(a,!0))return null;b=a.previousSibling}for(;!b&&(h=h.parentNode);){if(j&&!1===j(h,!0))return null;b=h.previousSibling}return!b||j&&!1===
j(b)?null:g&&b.nodeType!=g?e._4e_previousSourceNode(b,!1,g,j):b},_4e_commonAncestor:function(a,b){b=w(b);if(a===b)return a;if(e.contains(b,a))return b;var g=a;do if(e.contains(g,b))return g;while(g=g.parentNode);return null},_4e_hasAttributes:9>q.ieEngine?function(a){for(var b=a.attributes,g=0;g<b.length;g++){var j=b[g];switch(j.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(j.specified)return!0}}return!1}:function(a){k.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,b){var g=w(b);if(a.compareDocumentPosition)return a.compareDocumentPosition(g);if(a==g)return x.POSITION_IDENTICAL;if(a.nodeType==e.ELEMENT_NODE&&g.nodeType==e.ELEMENT_NODE){if(e.contains(a,g))return x.POSITION_CONTAINS+x.POSITION_PRECEDING;if(e.contains(g,a))return x.POSITION_IS_CONTAINED+x.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>g.sourceIndex?x.POSITION_DISCONNECTED:a.sourceIndex<g.sourceIndex?x.POSITION_PRECEDING:x.POSITION_FOLLOWING}for(var j=
e._4e_address(a),g=e._4e_address(g),d=Math.min(j.length,g.length),h=0;h<=d-1;h++)if(j[h]!=g[h])return j[h]<g[h]?x.POSITION_PRECEDING:x.POSITION_FOLLOWING;return j.length<g.length?x.POSITION_CONTAINS+x.POSITION_PRECEDING:x.POSITION_IS_CONTAINED+x.POSITION_FOLLOWING},_4e_address:function(a,b){for(var g=[],j=a.ownerDocument.documentElement,d=a;d&&d!=j;)g.unshift(e._4e_index(d,b)),d=d.parentNode;return g},_4e_remove:function(a,b){var g=a.parentNode;if(g){if(b)for(var j;j=a.firstChild;)g.insertBefore(a.removeChild(j),
a);g.removeChild(a)}return a},_4e_trim:function(a){e._4e_ltrim(a);e._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==e.TEXT_NODE){var g=q.ltrim(b.nodeValue),j=b.nodeValue.length;if(g)g.length<j&&(e._4e_splitText(b,j-g.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==e.TEXT_NODE){var g=q.rtrim(b.nodeValue),j=b.nodeValue.length;if(g)g.length<j&&(e._4e_splitText(b,g.length),a.removeChild(a.lastChild));
else{a.removeChild(b);continue}}break}!k.ie&&!k.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==e.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(a){for(var b=a.lastChild;b&&b.nodeType==e.TEXT_NODE&&!f.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==e.TEXT_NODE||"br"!==e.nodeName(b))b=k.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),k.gecko&&b.setAttribute("type","_moz"),a.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(a,b,g,j){var a=new m(a),d=a.data("list_marker_id")||a.data("list_marker_id",f.guid()).data("list_marker_id"),h=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[d]=a;h[g]=1;return a.data(g,j)},_4e_clearMarkers:function(a,b,g){var a=new m(a),j=a.data("list_marker_names"),d=a.data("list_marker_id"),h;for(h in j)j.hasOwnProperty(h)&&a.removeData(h);
a.removeData("list_marker_names");g&&(a.removeData("list_marker_id"),delete b[d])},_4e_copyAttributes:function(a,b,g){for(var b=new m(b),j=a.attributes,g=g||{},d=0;d<j.length;d++){var h=j[d],i=h.name.toLowerCase(),l;if(!(i in g))if("checked"==i&&(l=e.attr(a,i)))b.attr(i,l);else if(h.specified||k.ie&&h.value&&"value"==i)l=e.attr(a,i),null===l&&(l=h.nodeValue),b.attr(i,l)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=e.nodeName(a);return(a=!c.$nonEditable[a]&&
(c[a]||c.span))&&a["#"]},_4e_getByAddress:function(a,b,g){for(var a=a.documentElement,j=0;a&&j<b.length;j++){var d=b[j];if(g)for(var h=-1,i=0;i<a.childNodes.length;i++){var l=a.childNodes[i];if(!(!0===g&&3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType)&&(h++,h==d)){a=l;break}}else a=a.childNodes[d]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(f){function o(e){1>arguments.length||(this.range=e,this.forceBrBreak=s,this.enlargeBr=q,this.enforceRealBlocks=s,this._||(this._={}))}var q=!0,s=!1,v=f.Editor,c=f.UA,e=v.Walker,k=v.Range,m=v.RANGE,p=v.ElementPath,x=f.Node,n=f.DOM,t=/^[\r\n\t ]*$/;f.augment(o,{getNextParagraph:function(w){var a,b,g,j,d;if(!this._.lastNode){b=this.range.clone();b.shrink(m.SHRINK_ELEMENT,q);b.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:m.ENLARGE_BLOCK_CONTENTS);
var h=new e(b),i=e.bookmark(q,q);h.evaluator=i;this._.nextNode=h.next();h=new e(b);h.evaluator=i;h=h.previous();this._.lastNode=h._4e_nextSourceNode(q);this._.lastNode&&this._.lastNode[0].nodeType==n.TEXT_NODE&&!f.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(i=new k(b.document),i.moveToPosition(this._.lastNode,m.POSITION_AFTER_END),i.checkEndOfBlock()&&(i=new p(i.endContainer),this._.lastNode=(i.block||i.blockLimit)._4e_nextSourceNode(q)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(b.document.createTextNode("")),n.insertAfter(this._.lastNode[0],h[0]));b=null}i=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;i;){var l=s,r=i[0].nodeType!=n.ELEMENT_NODE,z=s;if(r)i[0].nodeType==n.TEXT_NODE&&t.test(i[0].nodeValue)&&(r=s);else{var u=i.nodeName();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==u)r=q;else if(!b&&!i[0].childNodes.length&&"hr"!=u){a=i;g=i.equals(h);break}b&&(b.setEndAt(i,m.POSITION_BEFORE_START),"br"!=
u&&(this._.nextNode=i));l=q}else{if(i[0].firstChild){b||(b=new k(this.range.document),b.setStartAt(i,m.POSITION_BEFORE_START));i=new x(i[0].firstChild);continue}r=q}}r&&!b&&(b=new k(this.range.document),b.setStartAt(i,m.POSITION_BEFORE_START));g=(!l||r)&&i.equals(h);if(b&&!l)for(;!i[0].nextSibling&&!g;){u=i.parent();if(u._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=q;g||u.equals(h);break}i=u;r=q;g=i.equals(h);z=q}r&&b.setEndAt(i,m.POSITION_AFTER_END);i=i._4e_nextSourceNode(z,null,h);if((g=!i)||
l&&b)break}if(!a){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new p(b.startContainer);i=a.blockLimit;l={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&l[i.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=i;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new x(this.range.document.createElement(w||"p")),a[0].appendChild(b.extractContents()),a._4e_trim(),b.insertNode(a),j=d=q;else if("li"!=a.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())a=a.clone(s),a[0].appendChild(b.extractContents()),a._4e_trim(),d=b.splitBlock(),j=!d.wasStartOfBlock,d=!d.wasEndOfBlock,b.insertNode(a)}else g||(this._.nextNode=a.equals(h)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(q,null,h))}j&&(b=new x(a[0].previousSibling),b[0]&&b[0].nodeType==n.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==n.nodeName(b[0].lastChild)&&n._4e_remove(b[0].lastChild)));d&&(b=e.bookmark(s,q),j=new x(a[0].lastChild),j[0]&&j[0].nodeType==
n.ELEMENT_NODE&&"br"==j.nodeName()&&(c.ie||j.prev(b,1)||j.next(b,1))&&j.remove());this._.nextNode||(this._.nextNode=g||a.equals(h)?null:a._4e_nextSourceNode(q,null,h));return a}});k.prototype.createIterator=function(){return new o(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(f){function o(f){for(var p=c,o=c,n=[];f;){if(f[0].nodeType==s.ELEMENT_NODE){this.lastElement||(this.lastElement=f);var t=f.nodeName();if(!o&&(!p&&e[t]&&(p=f),k[t])){var w;if(w=!p)if(w="div"==t){a:{w=f[0].childNodes;for(var a=0,b=w.length;a<b;a++){var g=w[a];if(g.nodeType==s.ELEMENT_NODE&&v.$block[g.nodeName.toLowerCase()]){w=!0;break a}}w=!1}w=!w}w?p=f:o=f}n.push(f);if("body"==t)break}f=f.parent()}this.block=p;this.blockLimit=o;this.elements=n}var q=f.Editor,
s=f.DOM,v=q.XHTML_DTD,c=null,e={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};o.prototype={compare:function(e){var f=this.elements,e=e&&e.elements;if(!e||f.length!=e.length)return!1;for(var c=0;c<f.length;c++)if(!s.equals(f[c],e[c]))return!1;return!0},contains:function(e){for(var f=this.elements,k=0;k<f.length;k++)if(f[k].nodeName()in e)return f[k];return c},toString:function(){var e=this.elements,
f,c=[];for(f=0;f<e.length;f++)c.push(e[f].nodeName());return c.toString()}};return q.ElementPath=o},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(f,o,q,s){function v(c){var t;t=c.getSelection().getRanges();for(var o=t.length-1;0<o;o--)t[o].deleteContents();t=t[0];o=t.document;if(t.checkStartOfBlock()&&t.checkEndOfBlock()){var a=(new s(t.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return c.hasCommand("outdent")?(c.execCommand("save"),c.execCommand("outdent"),c.execCommand("save"),!0):!1}var b=t.splitBlock("p");if(!b)return!0;var c=b.previousBlock,a=b.nextBlock,g=b.wasStartOfBlock,
j=b.wasEndOfBlock,d;if(a)d=a.parent(),"li"==d.nodeName()&&(a._4e_breakParent(d),a._4e_move(a.next(),!0));else if(c&&(d=c.parent())&&"li"==d.nodeName())c._4e_breakParent(d),t.moveToElementEditablePosition(c.next()),c._4e_move(c.prev());if(!g&&!j){if("li"==a.nodeName()&&(d=a.first(q.invisible(!0)))&&f.inArray(d.nodeName(),["ul","ol"]))(e.ie?new p(o.createTextNode("\u00a0")):new p(o.createElement("br"))).insertBefore(d);a&&t.moveToElementEditablePosition(a)}else{var h;if(c){if("li"==c.nodeName()||!k.test(c.nodeName()))h=
c.clone()}else a&&(h=a.clone());h||(h=new p("<p>",null,o));if(d=b.elementPath)for(var b=0,i=d.elements.length;b<i;b++){var l=d.elements[b];if(l.equals(d.block)||l.equals(d.blockLimit))break;m.$removeEmpty[l.nodeName()]&&(l=l.clone(),h._4e_moveChildren(l),h.append(l))}e.ie||h._4e_appendBogus();t.insertNode(h);if(e.ie&&g&&(!j||!c[0].childNodes.length))t.moveToElementEditablePosition(j?c:h),t.select();t.moveToElementEditablePosition(g&&!j?a:h)}e.ie||(a?(h=new p(o.createElement("span")),h.html("&nbsp;"),
t.insertNode(h),h.scrollIntoView(void 0,!1),t.deleteContents()):h.scrollIntoView(void 0,!1));t.select();return!0}function c(e){var c=e.get("document")[0];x.on(c,"keydown",function(c){if(13===c.keyCode&&!c.shiftKey&&!c.ctrlKey&&!c.metaKey){e.execCommand("save");var a=e.execCommand("enterBlock");e.execCommand("save");!1!==a&&c.preventDefault()}})}var e=f.UA,k=/^h[1-6]$/,m=o.XHTML_DTD,p=f.Node,x=f.Event;return{init:function(e){e.addCommand("enterBlock",{exec:v});e.docReady(function(){c(e)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(f){function o(){var e=this;e.__iframeFocus=p;m=e;k&&clearTimeout(k);k=setTimeout(function(){e.fire("focus")},100)}function q(){var e=this;e.__iframeFocus=x;m=n;k&&clearTimeout(k);k=setTimeout(function(){e.fire("blur")},100)}var s=f.Editor,v=f.DOM,c=f.Event,e={},k,m,f={refreshAll:function(){for(var c in e)if(e.hasOwnProperty(c)){var f=e[c].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return m},getInstance:function(c){return e[c]},
add:function(e){var f=v._getWin(e.get("document")[0]);c.on(f,"focus",o,e);c.on(f,"blur",q,e)},register:function(c){e[c._UUID]=c},remove:function(f){delete e[f._UUID];var k=v._getWin(f.get("document")[0]);c.remove(k,"focus",o,f);c.remove(k,"blur",q,f)}},p=!0,x=!1,n=null;f.refreshAll=f.refreshAll;s.focusManager=f;s.getInstances=function(){return e};return f},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(f,o){return{init:function(q){function s(g){return g.replace(w,function(g,d,h){return"<"+d+h.replace(a,function(a,g){return-1==h.indexOf("_ke_saved_"+g)?" _ke_saved_"+a+" "+a:a})+">"})}function v(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+b+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function c(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,g){return decodeURIComponent(g)})}
var e=e,k=f.Node,m=f.UA,p=f.require("htmlparser"),x=new p.Filter,n=new p.Filter,t=new p.Filter;(function(){var a=function(a,g){return function(d,b){var e=[];(""+d).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(d,l,F){l=l.toLowerCase();"font-family"==l&&(F=F.replace(/["']/g,""));for(var C,c,f,y=0;y<a.length;y++)if(a[y]&&(d=a[y][0],C=a[y][1],c=a[y][2],f=a[y][3],l.match(d)&&(!C||F.match(C)))){l=f||l;g&&(c=c||F);"function"==typeof c&&(c=c(F,b,l));c&&c.push&&(l=c[0],c=
c[1]);"string"==typeof c&&e.push([l,c]);return}!g&&e.push([l,F])});for(var c=0;c<e.length;c++)e[c]=e[c].join(":");return e.length?e.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],e),c={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var g=a.nodeName||"";if(-1!=g.indexOf(":")&&!/^ke/.test(g))if("v:imagedata"==
g){if(g=a.getAttribute("o:href"))a.setAttribute("src",g),a.removeAttribute("o:href");if(g=a.getAttribute("o:title"))a.setAttribute("title",g),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(h){h=a(h);return!h?!1:h}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var g=["name","href","src"],d,
b=0;b<g.length;b++)d="_ke_saved_"+g[b],a.getAttribute(d)&&a.removeAttribute(g[b]);return a},embed:function(a){var g=a.parentNode;if(g&&"object"==g.nodeName){var d=g.getAttribute("width"),g=g.getAttribute("height");d&&a.setAttribute("width",d);g&&a.setAttribute("width",g)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!f.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,b.length)==b?(a="{C}"==a.substr(b.length,3)?a.substr(b.length+3):a.substr(b.length),new p.CData(decodeURIComponent(a))):a}};m.ie&&(d.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(d);n.addRules(c);t.addRules(c)})();(function(){function a(g){for(var g=g.childNodes,F=g.length,h=g[F-1];h&&3==h.nodeType&&!f.trim(h.nodeValue);)h=g[--F];return h}
function b(h,F){var d=a(h);d&&((F||!m.ie)&&1==d.nodeType&&"br"==d.nodeName?h.removeChild(d):3==d.nodeType&&e.test(d.nodeValue)&&h.removeChild(d))}function d(h){var F=a(h);return!F||1==F.nodeType&&"br"==F.nodeName||"form"==h.nodeName&&"input"==F.nodeName}function h(a){b(a,!0);d(a)&&(m.ie?a.appendChild(new p.Text("\u00a0")):(a.appendChild(new p.Text("&nbsp;")),a.appendChild(new p.Tag("br"))))}function i(a){b(a,!1);d(a)&&a.appendChild(new p.Text("\u00a0"))}var e=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,c=o.XHTML_DTD,k=f.merge(c.$block,
c.$listItem,c.$tableContent),u;for(u in k)k.hasOwnProperty(u)&&("br"in c[u]||delete k[u]);delete k.td;delete k.pre;var c={tags:{}},q={tags:{}};for(u in k)k.hasOwnProperty(u)&&(c.tags[u]=h,q.tags[u]=i);n.addRules(c);x.addRules(q);t.addRules(c)})();(function(){x.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var w=/<(a|area|img|input)\b([^>]*)>/gi,a=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,b="{ke_protected}";q.htmlDataProcessor={wordFilter:t,dataFilter:n,
htmlFilter:x,toHtml:function(a){var b=new p.BeautifyWriter;(new p.Parser(a)).parse().writeHtml(b,x);return b.getHtml()},toDataFormat:function(a,b,d){d=d||n;m.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=s(a);b=new k("<div>");b.html("a"+a);a=b.html().substr(1);a=c(a);b=new p.BeautifyWriter;(new p.Parser(a)).parse().writeHtml(b,d);a=b.getHtml();return a=v(a)},toServer:function(a){var b=new p.MinifyWriter;(new p.Parser(a)).parse().writeHtml(b,x);return b.getHtml()}}}}},
{requires:["./base"]});
KISSY.add("editor/core/meta",function(){var f={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../menubutton/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubble/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubble/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["dd","../focusFix/"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],menubutton:["menubutton"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui",
"./cmd"],undo:["./btn","./cmd"],contextmenu:["menu","../focusFix/"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},o,q,s={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../menubutton/"],"flashCommon/baseClass":["../contextmenu/",
"../bubble/","../dialogLoader/","./utils"],"font/ui":["../button/","../menubutton/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../menubutton/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],
"link/dialog":["../overlay/","./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../menubutton/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../menubutton/"],"xiamiMusic/dialog":["../flash/dialog","../menubutton/"]},v={};for(o in f)q=
"editor/plugin/"+o+"/index",v[q]={requires:f[o]};for(o in s)q="editor/plugin/"+o,v[q]={requires:s[o]};KISSY.add(v)});
KISSY.add("editor/core/range",function(f,o,q,s,v){function c(a){var h=a.nodeType!=g.TEXT_NODE&&g.nodeName(a)in d.$removeEmpty,b=a.nodeType==g.TEXT_NODE&&!f.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return h||b||a}function e(a){return!r(a)&&!z(a)}function k(a){var h=t;return function(b){if(z(b))return n;if(b.nodeType==g.TEXT_NODE){if(f.trim(b.nodeValue).length)return t}else if(b.nodeType==g.ELEMENT_NODE&&(b=g.nodeName(b),!E[b]))if(!a&&!j.ie&&"br"==b&&!h)h=n;else return t;return n}}
function m(a,b){var d=a.startContainer,i=a.endContainer,y=a.startOffset,c=a.endOffset,e,l=t,f=t,j=void 0,r=a.document,P;0<b&&(j=r.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();i[0].nodeType==g.TEXT_NODE?(f=n,i=i._4e_splitText(c)):0<i[0].childNodes.length&&(c>=i[0].childNodes.length?(i=new h(i[0].appendChild(r.createTextNode(""))),P=n):i=new h(i[0].childNodes[c]));d[0].nodeType==g.TEXT_NODE?(l=n,d._4e_splitText(y)):y?y>=d[0].childNodes.length?(d=new h(d[0].appendChild(r.createTextNode(""))),
e=n):d=new h(d[0].childNodes[y].previousSibling):(e=new h(r.createTextNode("")),d.prepend(e),d=e,e=n);var k=d._4e_parents(),J=i._4e_parents();k.each(function(a,b){k[b]=a});J.each(function(a,b){J[b]=a});for(var H,L,r=0;r<k.length&&!(H=k[r],L=J[r],!H.equals(L));r++);for(var y=j,B,u,z=r;z<k.length;z++){B=k[z];c=0<b&&!B.equals(d)?y.appendChild(B.clone()[0]):null;B=B[0].nextSibling;u=J[z];for(var o=i[0],m=u&&u[0];B&&!(m==B||o==B);)u=B.nextSibling,2==b?y.appendChild(B.cloneNode(n)):(g._4e_remove(B),1==
b&&y.appendChild(B)),B=u;c&&(y=c)}for(y=j;r<J.length;r++){B=J[r];c=0<b&&!B.equals(i)?y.appendChild(B.clone()[0]):null;if(!k[r]||!B._4e_sameLevel(k[r]))for(B=B[0].previousSibling;B;)u=B.previousSibling,2==b?y.insertBefore(B.cloneNode(n),y.firstChild):(g._4e_remove(B),1==b&&y.insertBefore(B,y.firstChild)),B=u;c&&(y=c)}if(2==b){if(l&&(H=d[0],H.nodeType==g.TEXT_NODE&&H.nextSibling&&H.nextSibling.nodeType==g.TEXT_NODE&&(H.data+=H.nextSibling.data,H.parentNode.removeChild(H.nextSibling))),f)f=i[0],f.nodeType==
g.TEXT_NODE&&f.previousSibling&&f.previousSibling.nodeType==g.TEXT_NODE&&(f.previousSibling.data+=f.data,f.parentNode.removeChild(f))}else{if(H&&L&&(!d._4e_sameLevel(H)||!i._4e_sameLevel(L)))f=H._4e_index(),e&&H._4e_sameLevel(d)&&f--,a.setStart(H.parent(),f+1);a.collapse(n)}e&&d.remove();P&&i.remove();return j}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=w;this.collapsed=n;this.document=a}o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,t=!1,w=null,a=o.RANGE,b=o.POSITION,g=f.DOM,j=f.UA,d=o.XHTML_DTD,h=f.Node,i=h.all,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},r=new s.whitespaces,z=new s.bookmark,u=s.whitespaces(n),A=s.bookmark(!1,
!0),E={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};f.augment(x,{toString:function(){var a=[],b=this.startContainer[0],d=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((d.id||d.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=g.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=g.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==g.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);p(this)},setEnd:function(a,b){a[0].nodeType==g.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);p(this)},setStartAt:function(b,d){switch(d){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==g.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}p(this)},setEndAt:function(b,d){switch(d){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==g.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}p(this)},cloneContents:function(){return m(this,2)},deleteContents:function(){return m(this,0)},extractContents:function(){return m(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=g.ELEMENT_NODE||a.endContainer[0].nodeType!=g.ELEMENT_NODE)return w;var b=new s(a);b.evaluator=function(a){return u(a)&&A(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:w},shrink:function(b,d){if(!this.collapsed){var b=b||a.SHRINK_TEXT,h=this.clone(),i=this.startContainer,y=this.endContainer,c=this.startOffset,e=this.endOffset,l=n,f,r,j=n;i&&i[0].nodeType==g.TEXT_NODE&&(c?c>=i[0].nodeValue.length?h.setStartAfter(i):(h.setStartBefore(i),l=t):h.setStartBefore(i));y&&y[0].nodeType==g.TEXT_NODE&&(e?e>=y[0].nodeValue.length?h.setEndAfter(y):(h.setEndAfter(y),j=t):h.setEndBefore(y));if(l||j)r=new s(h),r.evaluator=function(d){return d.nodeType==
(b==a.SHRINK_ELEMENT?g.ELEMENT_NODE:g.TEXT_NODE)},r.guard=function(d,h){if(b==a.SHRINK_ELEMENT&&d.nodeType==g.TEXT_NODE||h&&d==f)return t;!h&&d.nodeType==g.ELEMENT_NODE&&(f=d);return n};l&&(h=r[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(h,d?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);j&&(r.reset(),(r=r[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(r,d?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return l||j}},createBookmark2:function(a){var b=this.startContainer,
d=this.endContainer,i=this.startOffset,c=this.endOffset,e,l;if(!b||!d)return{start:0,end:0};if(a){if(b[0].nodeType==g.ELEMENT_NODE&&(e=new h(b[0].childNodes[i]))&&e[0]&&e[0].nodeType==g.TEXT_NODE&&0<i&&e[0].previousSibling.nodeType==g.TEXT_NODE)b=e,i=0;for(;b[0].nodeType==g.TEXT_NODE&&(l=b.prev(void 0,1))&&l[0].nodeType==g.TEXT_NODE;)b=l,i+=l[0].nodeValue.length;if(!this.collapsed){if(d[0].nodeType==g.ELEMENT_NODE&&(e=new h(d[0].childNodes[c]))&&e[0]&&e[0].nodeType==g.TEXT_NODE&&0<c&&e[0].previousSibling.nodeType==
g.TEXT_NODE)d=e,c=0;for(;d[0].nodeType==g.TEXT_NODE&&(l=d.prev(void 0,1))&&l[0].nodeType==g.TEXT_NODE;)d=l,c+=l[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?w:d._4e_address(a),startOffset:i,endOffset:c,normalized:a,is2:n}},createBookmark:function(b){var d,g,i,c,e=this.collapsed;d=new h("<span>",w,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");b&&(i=f.guid("ke_bm_"),d.attr("id",i+"S"));e||(g=d.clone(),g.html("&nbsp;"),b&&g.attr("id",i+"E"),
c=this.clone(),c.collapse(),c.insertNode(g));c=this.clone();c.collapse(n);c.insertNode(d);g?(this.setStartAfter(d),this.setEndBefore(g)):this.moveToPosition(d,a.POSITION_AFTER_END);return{startNode:b?i+"S":d,endNode:b?i+"E":g,serializable:b,collapsed:e}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,b){var d=this.startContainer,h=this.startOffset,i=this.collapsed;if((!a||i)&&d[0]&&d[0].nodeType==g.TEXT_NODE){if(h)if(h>=d[0].nodeValue.length)h=d._4e_index()+1,
d=d.parent();else{var c=d._4e_splitText(h),h=d._4e_index()+1,d=d.parent();g.equals(this.startContainer,this.endContainer)?this.setEnd(c,this.endOffset-this.startOffset):g.equals(d,this.endContainer)&&(this.endOffset+=1)}else h=d._4e_index(),d=d.parent();this.setStart(d,h);if(i){this.collapse(n);return}}d=this.endContainer;h=this.endOffset;!b&&!i&&d[0]&&d[0].nodeType==g.TEXT_NODE&&(h?(h>=d[0].nodeValue.length||d._4e_splitText(h),h=d._4e_index()+1):h=d._4e_index(),d=d.parent(),this.setEnd(d,h))},insertNode:function(a){this.optimizeBookmark();
this.trim(t,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=i(this.document);if(a.is2){var d=b._4e_getByAddress(a.start,a.normalized),h=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(d,h);b?this.setEnd(b,a):this.collapse(n)}else d=(h=a.serializable)?f.one("#"+a.startNode,b):a.startNode,a=h?f.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(d),d._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,b){var d=this.startContainer,i=this.endContainer,d=d[0]==i[0]?a&&d[0].nodeType==g.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new h(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(i);return b&&d[0].nodeType==g.TEXT_NODE?d.parent():d},enlarge:function(){function b(a,d,h,c){var e=a[d?"startContainer":"endContainer"],l,f=d?0:1,j=0,k=d?"previousSibling":
"nextSibling";l=a[d?"startOffset":"endOffset"];if(e[0].nodeType==g.TEXT_NODE){if(d){if(l)return}else if(l<e[0].nodeValue.length)return;l=e[0][k];e=e[0].parentNode}else l=e[0].childNodes[l+(d?-1:1)]||null,e=e[0];for(;e;){for(;l;)if(r(l)||z(l))l=l[k];else break;if(l){if(!j)a[d?"setStartAfter":"setEndBefore"](i(l));break}e=i(e);if("body"==e.nodeName())break;if(j||e.equals(c))h[f]=e,j=1;else a[d?"setStartBefore":"setEndAfter"](e);l=e[0][k];e=e[0].parentNode}}return function(d){switch(d){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var d=this.getCommonAncestor(),e=[];b(this,1,e,d);b(this,0,e,d);e[0]&&e[1]&&(d=e[0].contains(e[1])?e[1]:e[0],this.setStartBefore(d),this.setEndAfter(d));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var c=new x(this.document),e=new h(this.document.body);c.setStartAt(e,a.POSITION_AFTER_START);c.setEnd(this.startContainer,this.startOffset);var c=new s(c),l,f,r=s.blockBoundary(d==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),j=function(a){var b=r(a);b||(l=i(a));return b},k=function(a){var b=
j(a);!b&&"br"==g.nodeName(a)&&(f=i(a));return b};c.guard=j;c=c.lastBackward();l=l||e;this.setStartAt(l,"br"!=l.nodeName()&&(!c&&this.checkStartOfBlock()||c&&l.contains(c))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(e,a.POSITION_BEFORE_END);c=new s(c);c.guard=d==a.ENLARGE_LIST_ITEM_CONTENTS?k:j;l=w;c=c.lastForward();l=l||e;this.setEndAt(l,!c&&this.checkEndOfBlock()||c&&l.contains(c)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);f&&this.setEndAfter(f)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==g.TEXT_NODE&&f.trim(b[0].nodeValue.substring(0,d)).length)return t;this.trim();b=new v(this.startContainer);d=this.clone();d.collapse(n);d.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new s(d);b.evaluator=k(n);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==g.TEXT_NODE&&f.trim(b[0].nodeValue.substring(d)).length)return t;this.trim();
b=new v(this.endContainer);d=this.clone();d.collapse(t);d.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new s(d);b.evaluator=k(t);return b.checkForward()},checkBoundaryOfElement:function(b,d){var h=this.clone();h[d==a.START?"setStartAt":"setEndAt"](b,d==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);h=new s(h);h.evaluator=c;return h[d==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,h=this.startOffset,e=this.endOffset,
c;if(a[0].nodeType==g.ELEMENT_NODE)if(c=a[0].childNodes.length,c>h)a=i(a[0].childNodes[h]);else if(0==c)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=i(a);a=a._4e_nextSourceNode()||a}if(d[0].nodeType==g.ELEMENT_NODE)if(c=d[0].childNodes.length,c>e)d=i(d[0].childNodes[e])._4e_previousSourceNode(n);else if(0==c)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=i(d)}a._4e_position(d)&b.POSITION_FOLLOWING&&(a=d);return{startNode:a,endNode:d}},fixBlock:function(d,
b){var h=this.createBookmark(),c=i(this.document.createElement(b));this.collapse(d);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);c[0].appendChild(this.extractContents());c._4e_trim();j.ie||c._4e_appendBogus();this.insertNode(c);this.moveToBookmark(h);return c},splitBlock:function(d){var b=new v(this.startContainer),h=new v(this.endContainer),c=b.block,e=h.block,g=w;if(!b.blockLimit.equals(h.blockLimit))return w;"br"!=d&&(c||(c=this.fixBlock(n,d),e=(new v(this.endContainer)).block),e||(e=this.fixBlock(t,
d)));d=c&&this.checkStartOfBlock();b=e&&this.checkEndOfBlock();this.deleteContents();c&&c[0]==e[0]&&(b?(g=new v(this.startContainer),this.moveToPosition(e,a.POSITION_AFTER_END),e=w):d?(g=new v(this.startContainer),this.moveToPosition(c,a.POSITION_BEFORE_START),c=w):(e=this.splitElement(c),!j.ie&&!f.inArray(c.nodeName(),["ul","ol"])&&c._4e_appendBogus()));return{previousBlock:c,nextBlock:e,wasStartOfBlock:d,wasEndOfBlock:b,elementPath:g}},splitElement:function(d){if(!this.collapsed)return w;this.setEndAt(d,
a.POSITION_BEFORE_END);var b=this.extractContents(),h=d.clone(t);h[0].appendChild(b);h.insertAfter(d);this.moveToPosition(d,a.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(d,b){for(var h=0;d;){if(d[0].nodeType==g.TEXT_NODE){this.moveToPosition(d,b?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);h=1;break}d[0].nodeType==g.ELEMENT_NODE&&d._4e_isEditable()&&(this.moveToPosition(d,b?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),h=1);var c=d,i=h,l=void 0;c[0].nodeType==g.ELEMENT_NODE&&
c._4e_isEditable()&&(l=c[b?"last":"first"](e,1));!i&&!l&&(l=c[b?"prev":"next"](e,1));d=l}return!!h},selectNodeContents:function(a){var d=a[0];this.setStart(a,0);this.setEnd(a,d.nodeType==g.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(a){var b,h,c,e=a.nodeName();b=d.$block[e];this.deleteContents();if(b){for(b=this.getCommonAncestor(t,n);(h=d[b.nodeName()])&&(!h||!h[e]);){var g=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(n),
b.remove()):c=b;b=g}c&&this.splitElement(c)}this.insertNode(a)}});q.injectDom({_4e_breakParent:function(a,d){var d=i(d),a=i(a),b,h=new o.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(d);b=h.extractContents();h.insertNode(a.remove());a.after(b)}});o.Range=x},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(f){function o(a){this.document=a;this._={cache:{}};if(n)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=v}catch(c){this.isInvalid=v}}function q(a){a=new o(a);return!a||a.isInvalid?c:a}var s=f.Editor;s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var v=!0,c=null,e=f.UA,k=f.DOM,m=f.Node,p=s.SELECTION,x=s.RANGE,n=e.ie,t=s.Walker,w=s.Range,
a={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};f.augment(o,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=k._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var b=this._.cache;if(b.type)return b.type;var h=p.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=
c.getRangeAt(0),e=c.startContainer;e==c.endContainer&&e.nodeType==k.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&a[e.childNodes[c.startOffset].nodeName.toLowerCase()]&&(h=p.SELECTION_ELEMENT)}}else h=p.SELECTION_NONE;return b.type=h}:function(){var a=this._.cache;if(a.type)return a.type;var b=p.SELECTION_NONE;try{var c=this.getNative(),e=c.type;"Text"==e&&(b=p.SELECTION_TEXT);"Control"==e&&(b=p.SELECTION_ELEMENT);c.createRange().parentElement&&(b=p.SELECTION_TEXT)}catch(g){}return a.type=b},
getRanges:n?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var d=a.parentElement(),e=d.childNodes,g,f=0;f<e.length;f++){var j=e[f];if(j.nodeType==k.ELEMENT_NODE){g=a.duplicate();g.moveToElementText(j);var j=g.compareEndPoints("StartToStart",a),o=g.compareEndPoints("EndToStart",a);g.collapse();if(0<j)break;else{if(!j||1==o&&-1==j)return{container:d,offset:f};if(!o)return{container:d,offset:f+1}}g=c}}g||(g=a.duplicate(),g.moveToElementText(d),g.collapse(!1));g.setEndPoint("StartToStart",
a);g=(""+g.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<g;)g-=e[--f].nodeValue.length}catch(m){g=0}return 0===g?{container:d,offset:f}:{container:e[f],offset:-g}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var g=this.getNative(),b=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==p.SELECTION_TEXT)return g=new w(this.document),e=a(b,v),g.setStart(new m(e.container),e.offset),e=a(b),g.setEnd(new m(e.container),e.offset),c.ranges=[g];if(e==p.SELECTION_ELEMENT){c=
c.ranges=[];for(e=0;e<b.length;e++){for(var f=b.item(e),j=f.parentNode,k=0,g=new w(this.document);k<j.childNodes.length&&j.childNodes[k]!=f;k++);g.setStart(new m(j),k);g.setEnd(new m(j),k+1);c.push(g)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var g=0;g<c.rangeCount;g++){var e=c.getRangeAt(g),f=new w(this.document);f.setStart(new m(e.startContainer),e.startOffset);f.setEnd(new m(e.endContainer),e.endOffset);
a.push(f)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();v;)if(b=e.startContainer,e.startOffset==(b[0].nodeType===k.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())e.setStartAfter(b);else break;b=e.startContainer;
if(b[0].nodeType!=k.ELEMENT_NODE)return b.parent();b=new m(b[0].childNodes[e.startOffset]);if(!b[0]||b[0].nodeType!=k.ELEMENT_NODE)return e.startContainer;for(e=b[0].firstChild;e&&e.nodeType==k.ELEMENT_NODE;)b=new m(e),e=e.firstChild;return b}if(n)e=c.createRange(),e.collapse(v),b=new m(e.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=k.ELEMENT_NODE)b=b.parentNode;b&&(b=new m(b))}}return a.startElement=b},getSelectedElement:function(){var b,e=this._.cache;if(void 0!==e.selectedElement)return e.selectedElement;
n&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var c;if(b)c=new m(b);else{b=this.getRanges()[0];for(var g,f=2;f&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==k.ELEMENT_NODE&&a[c.nodeName()]&&(g=c)));f--)b.shrink(x.SHRINK_ELEMENT);c=g}return e.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(n)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=
c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(n){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var g=a[c],f=this.document.createRange(),j=g.startContainer;if(g.collapsed&&(e.gecko&&1.09>e.gecko||e.opera||e.webkit)&&j[0].nodeType==k.ELEMENT_NODE&&!j[0].childNodes.length)j[0].appendChild(this.document.createTextNode(e.webkit?
"\u200b":"")),g.startOffset++,g.endOffset++;f.setStart(j[0],g.startOffset);f.setEnd(g.endContainer[0],g.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),e=0;e<c.length;e++)b.push(c[e].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],e=this.document,g,b=b||this.getRanges(),j=b.length,o=0;o<j;o++){c.push(g=b[o].createBookmark(a,v));var m=(a=g.serializable)?f.one("#"+g.startNode,e):g.startNode;g=a?f.one("#"+g.endNode,e):g.endNode;
for(var p=o+1;p<j;p++){var n=b[p],q=n.startContainer,s=n.endContainer;k.equals(q,m.parent())&&n.startOffset++;k.equals(q,g.parent())&&n.startOffset++;k.equals(s,m.parent())&&n.endOffset++;k.equals(s,g.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var e=new w(this.document);e.moveToBookmark(a[c]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-
1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},g=t.whitespaces(v),j=/\ufeff|\u00a0/;w.prototype.select=w.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==k.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],
this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(v),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=q(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var c=this.collapsed,e,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var r=this.startContainer[0].childNodes[this.startOffset];if(r.nodeType==k.ELEMENT_NODE){(new o(this.document)).selectElement(new m(r));
return}}(this.startContainer[0].nodeType==k.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==k.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(x.SHRINK_ELEMENT,v);var n=this.createBookmark(),r=n.startNode,u;c||(u=n.endNode);n=this.document.body.createTextRange();n.moveToElementText(r[0]);n.moveStart("character",1);if(u)a=this.document.body.createTextRange(),a.moveToElementText(u[0]),n.setEndPoint("EndToEnd",a),n.moveEnd("character",-1);else{for(e=r[0].nextSibling;e&&
!g(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(j))&&(a||!r[0].previousSibling||r[0].previousSibling&&"br"==k.nodeName(r[0].previousSibling));f=new m(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(r);e&&k.insertBefore(this.document.createTextNode("\ufeff"),r[0]||r)}this.setStartBefore(r);r._4e_remove();if(c){if(e?(n.moveStart("character",-1),n.select(),this.document.selection.clear()):n.select(),f)this.moveToPosition(f,x.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(u),
u._4e_remove(),n.select()};o.getSelection=q;return s.Selection=o},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(f,o){function q(a){function b(a,b){var c=f.body.createTextRange();try{c.moveToPoint(a,b)}catch(e){c=m}return c}function c(){var a=f.selection.createRange();l&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&l.select();x.remove(f,"mouseup",c);x.remove(f,"mousemove",e);l=d=0}function e(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",l)?a.setEndPoint("StartToStart",l):a.setEndPoint("EndToEnd",l),a.select()}else c()}var d,h=a.get("window")[0],
f=a.get("document")[0],l;x.on(f,"mousedown contextmenu",function(a){var k=f.documentElement;if(a.target===k&&(d&&c(),!(k.scrollHeight>k.clientHeight)&&(d=1,l=b(a.pageX,a.pageY))))x.on(f,"mouseup",c),x.on(f,"mousemove",e),h.focus(),l.select()})}function s(a){function b(d){if(i){var f=a.getSelection(),j=f&&f.getType(),k=f&&c.selection;if(d&&k&&j==w.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(e)},50);else{var l;if(!k||!k.type||!("Control"!=k.type&&(l=k.createRange())&&
(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))h=k&&f.getRanges()[0],a.checkSelectionChange()}}}var c=a.get("document")[0],f=new t(c.body),d=new t(c.documentElement);if(8>o.Utils.ieEngine)d.on("click",function(b){"html"===(new t(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var h,i,l=e;d.on("mousedown",function(){l=k});d.on("mouseup",function(){l=e});f.on("focusin",function(a){if("body"==(new t(a.target)).nodeName()&&h){try{l&&h.select()}catch(b){}h=
m}});f.on("focus",function(){i=e;b()});f.on("beforedeactivate",function(a){a.relatedTarget||(i=k,l=e)});f.on("mousedown",function(){i=k});f.on("mouseup",function(){i=e;setTimeout(function(){b(e)},0)});f.on("keydown",function(){i=k});f.on("keyup",function(){i=e;setTimeout(function(){b()},0)})}function v(a){var b=a.get("document")[0];x.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function c(a){function b(a){var b=o.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}function c(a){return d(a)&&
h(a)}var f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,d=o.Walker.whitespaces(e),h=o.Walker.bookmark(k,e),i=function(a){return d(a)&&8!=a.nodeType};a.on("selectionChange",function(d){var h=d.path,m=new t(a.get("document")[0].body),d=(d=d.selection)&&d.getRanges()[0],u=h.blockLimit;if(p.gecko){var q=h.block||h.blockLimit,s=q&&q.last(c);q&&q._4e_isBlockBoundary()&&(!s||!(1==s[0].nodeType&&s._4e_isBlockBoundary()))&&
"pre"!=q.nodeName()&&!q._4e_getBogus()&&q._4e_appendBogus()}if(d&&d.collapsed&&!h.block){if("body"==u.nodeName()){if((h=d.fixBlock(e,"p"))&&h[0]!=m[0].lastChild&&h._4e_outerHtml().match(f))if((u=h.next(i,1))&&u[0].nodeType==n.ELEMENT_NODE&&!b[u])d.moveToElementEditablePosition(u),h._4e_remove();else if((u=h.prev(i,1))&&u[0].nodeType==n.ELEMENT_NODE&&!b[u])d.moveToElementEditablePosition(u,u._4e_outerHtml().match(f)?k:e),h._4e_remove();d.select();a.notifySelectionChange()}h=a.get("document")[0];d=
new o.Range(h);d.moveToElementEditablePosition(m,e);"body"!==(new o.ElementPath(d.startContainer)).blockLimit.nodeName()&&(m=(new t(h.createElement("p"))).appendTo(m),p.ie||m._4e_appendBogus())}})}var e=!0,k=!1,m=null,p=f.UA,x=f.Event,n=f.DOM,t=f.Node,w=o.SELECTION;return{init:function(a){a.docReady(function(){p.ie?(q(a),s(a)):v(a)});c(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(f){function o(a){return!u.attr(a,"_ke_bookmark")}function q(a,b){for(var c in a)a.hasOwnProperty(c)&&(f.isString(a[c])?a[c]=a[c].replace(Q,function(a,c){return b[c]}):q(a[c],b))}function s(a,b){b&&(a=f.clone(a),q(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||G[c]?A.STYLE_BLOCK:N[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function v(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new F(a),e=d.getRanges(),g=0;g<e.length;g++)c.call(this,e[g]);d.selectRanges(e)}function c(a,b,c){var d=a.element;"*"==d&&(d="span");b=new I(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=s.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function e(a){var b=a.createBookmark(l),d=a.createIterator();d.enforceRealBlocks=l;d.enlargeBr=l;for(var e,g=a.document;e=d.getNextParagraph();){var h=c(this,g,
e),f=h,h="pre"==f.nodeName,i="pre"==e.nodeName,j=!h&&i;h&&!i?(i=e,j=i.html(),j=k(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),y.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(f[0]),f[0].outerHTML="<pre>"+j+"</pre>",f=new I(i.firstChild),f._4e_remove()):f.html(j)):j?f=p(m(e),f):e._4e_moveChildren(f);e[0].parentNode.replaceChild(f[0],e[0]);if(h&&(e=f,h=void 0,(h=e._4e_previousSourceNode(l,
u.ELEMENT_NODE))&&"pre"==h.nodeName()))f=k(h.html(),/\n$/,"")+"\n\n"+k(e.html(),/^\n/,""),y.ie?e[0].outerHTML="<pre>"+f+"</pre>":e.html(f),h._4e_remove()}a.moveToBookmark(b)}function k(a,b,c){var e="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(e=b);c&&(d=c);return""});return e+a.replace(b,c)+d}function m(a){var b=[];k(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function p(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var d=a[e],d=d.replace(/(\r\n|\r)/g,"\n"),d=k(d,/^[ \t]*\n/,""),d=k(d,/\n$/,""),d=k(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
g=b.clone();g.html(d);c.appendChild(g[0])}return c}function x(a){var b=a.document;if(a.collapsed)b=c(this,b,void 0),a.insertNode(b),a.moveToPosition(b,E.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,g,h=K[d];h||(g=l,h=K.span);var f=a.createBookmark();a.enlarge(E.ENLARGE_ELEMENT);a.trim();for(var i=a.createBookmark(),k=i.startNode,i=i.endNode,D=k,n;D&&D[0];){var m=r;if(u.equals(D,i))D=z,m=l;else{var G=D[0].nodeType,q=G==u.ELEMENT_NODE?D.nodeName():z;if(q&&D.attr("_ke_bookmark")){D=
D._4e_nextSourceNode(l);continue}if(!q||h[q]&&(D._4e_position(i)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(D))){var p=D.parent();if(p&&"a"==d&&p.nodeName()==d)G=c(this,b,void 0),p._4e_moveChildren(G),p[0].parentNode.replaceChild(G[0],p[0]),G._4e_mergeSiblings();else if(p&&p[0]&&((K[p.nodeName()]||K.span)[d]||g)&&(!e.parentRule||e.parentRule(p))){if(!n&&(!q||!K.$removeEmpty[q]||(D._4e_position(i)|
C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))n=new M(b),n.setStartBefore(D);if(G==u.TEXT_NODE||G==u.ELEMENT_NODE&&!D[0].childNodes.length){p=D;for(G=null;(m=!p.next(o,1))&&(G=p.parent())&&h[G.nodeName()]&&(G._4e_position(k)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(G));)p=G;n.setEndAfter(p)}}else m=
l}else m=l;D=D._4e_nextSourceNode()}if(m&&n&&!n.collapsed){for(var m=c(this,b,void 0),p=n.getCommonAncestor(),G={},q={},s,t=null,v;m&&p&&m[0]&&p[0];){if(p.nodeName()==d){for(s in e.attributes)if(e.attributes.hasOwnProperty(s)&&!q[s]&&(v=p.attr(t)))m.attr(s)==v?m.removeAttr(s):q[s]=1;for(t in e.styles)if(e.styles.hasOwnProperty(t)&&!G[t]&&(v=p.style(t)))m.style(t)==v?m.style(t,""):G[t]=1;if(!m._4e_hasAttributes()){m=z;break}}p=p.parent()}m?(m[0].appendChild(n.extractContents()),j(this,m),n.insertNode(m),
m._4e_mergeSiblings(),y.ie||m[0].normalize()):(m=new I(b.createElement("span")),m[0].appendChild(n.extractContents()),n.insertNode(m),j(this,m),m._4e_remove(!0));n=z}}k._4e_remove();i._4e_remove();a.moveToBookmark(f);a.shrink(E.SHRINK_TEXT)}}function n(c){c.enlarge(E.ENLARGE_ELEMENT);var e=c.createBookmark(),g=e.startNode;if(c.collapsed){for(var h=new D(g.parent()),f,i=0,j;i<h.elements.length&&(j=h.elements[i])&&!(j==h.block||j==h.blockLimit);i++)if(this.checkElementRemovable(j)){var k=c.checkBoundaryOfElement(j,
E.END),y=!k&&c.checkBoundaryOfElement(j,E.START);y||k?(f=j,f.match=y?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(k=a(this),d(j,k[j.nodeName()]||k["*"])):b(this,j))}if(f){j=g;for(i=0;;i++){k=h.elements[i];if(u.equals(k,f))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(j[0]);j=k}j["start"==f.match?"insertBefore":"insertAfter"](f)}}else{var l=e.endNode,m=this,h=function(){for(var a=new D(g.parent()),b=new D(l.parent()),c=z,e=z,d=0;d<a.elements.length;d++){var f=
a.elements[d];if(f==a.block||f==a.blockLimit)break;m.checkElementRemovable(f)&&(c=f)}for(d=0;d<b.elements.length;d++){f=b.elements[d];if(f==b.block||f==b.blockLimit)break;m.checkElementRemovable(f)&&(e=f)}e&&l._4e_breakParent(e);c&&g._4e_breakParent(c)};h();for(f=new I(g[0].nextSibling);f[0]!==l[0];){i=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==u.ELEMENT_NODE&&this.checkElementRemovable(f)&&(f.nodeName()==this.element?b(this,f):(j=a(this),d(f,j[f.nodeName()]||j["*"])),i[0].nodeType==u.ELEMENT_NODE&&
i.contains(g)))h(),i=new I(g[0].nextSibling);f=i}}c.moveToBookmark(e)}function t(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,e){b[c]=e});return b}function w(a,b){var c="";b!==r?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function a(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){f.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var d=c[e],g,h,i;"string"==typeof d?g=d.toLowerCase():(g=d.element?d.element.toLowerCase():a.element,h=d.attributes,i=d.styles);d=b[g]||(b[g]={});if(h){g=d.attributes=d.attributes||[];for(var j in h)h.hasOwnProperty(j)&&g.push([j.toLowerCase(),h[j]])}if(i){var d=d.styles=d.styles||[],k;for(k in i)i.hasOwnProperty(k)&&d.push([k.toLowerCase(),i[k]])}}}return b}function b(b,c){var d=b._.definition,e=a(b),i=f.merge(d.attributes,(e[c.nodeName()]||
e["*"]||{}).attributes),d=f.merge(d.styles,(e[c.nodeName()]||e["*"]||{}).styles),e=f.isEmptyObject(i)&&f.isEmptyObject(d),j;for(j in i)if(i.hasOwnProperty(j)&&!(("class"==j||b._.definition.fullMatch)&&c.attr(j)!=g(j,i[j])))e=e||!!c.hasAttr(j),c.removeAttr(j);for(var k in d)d.hasOwnProperty(k)&&!(b._.definition.fullMatch&&c.style(k)!=g(k,d[k],l))&&(e=e||!!c.style(k),c.style(k,""));h(c)}function g(a,b,c){var d=new I("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function j(c,e){for(var g=
a(c),f=e.all(c.element),h=f.length;0<=--h;)b(c,new I(f[h]));for(var i in g)if(g.hasOwnProperty(i)&&i!=c.element){f=e.all(i);for(h=f.length-1;0<=h;h--){var j=new I(f[h]);d(j,g[i])}}}function d(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],g;if(g=a.attr(e)){var f=d[c][1];(f===z||f.test&&f.test(g)||"string"==typeof f&&g==f)&&a[0].removeAttribute(e)}}if(d=b&&b.styles)for(c=0;c<d.length;c++)if(e=d[c][0],f=a.css(e)){var i=d[c][1];(i===z||i.test&&i.test(g)||"string"==typeof i&&
f==i)&&a.css(e,"")}h(a)}function h(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);b&&(b.nodeType==u.ELEMENT_NODE&&u._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==u.ELEMENT_NODE&&u._4e_mergeSiblings(c))}}var i=f.Editor,l=!0,r=!1,z=null,u=f.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},E=i.RANGE,F=i.Selection,C=i.POSITION,M=i.Range,I=f.Node,y=f.UA,D=i.ElementPath,G={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},K=i.XHTML_DTD,N={embed:1,hr:1,img:1,li:1,
object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;i.STYLE=A;s.prototype={apply:function(a){v.call(this,a,r)},remove:function(a){v.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?x:this.type==A.STYLE_BLOCK?e:z).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?n:z).call(this,a)},checkElementRemovable:function(b,c){if(!b)return r;var d=this._.definition,e;if(b.nodeName()==
this.element){if(!c&&!b._4e_hasAttributes())return l;var g=d._AC;if(g)d=g;else{var g={},f=0,h=d.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(f++,g[i]=h[i]);if(h=s.getStyleText(d))g.style||f++,g.style=h;g._length=f;d=d._AC=g}if(d._length){for(var j in d)if("_length"!=j&&d.hasOwnProperty(j)){f=b.attr(j)||"";if("style"==j)a:{g=d[j];f=w(f,r);"string"==typeof g&&(g=t(g));"string"==typeof f&&(f=t(f));h=void 0;for(h in g)if(g.hasOwnProperty(h)&&!(h in f&&(f[h]==g[h]||"inherit"==g[h]||"inherit"==
f[h]))){g=r;break a}g=l}else g=d[j]==f;if(g){if(!c)return l}else if(c)return r}if(c)return l}else return l}j=a(this);if(j=j[b.nodeName()]||j["*"]){if(!(d=j.attributes)&&!(e=j.styles))return l;if(d)for(g=0;g<d.length;g++)if(j=d[g][0],j=b.attr(j))if(f=d[g][1],f===z||"string"==typeof f&&j==f||f.test&&f.test(j))return l;if(e)for(g=0;g<e.length;g++)if(j=b.css(e[g][0]))if(d=e[g][1],d===z||"string"==typeof d&&j==d||d.test&&d.test(j))return l}return r},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,l);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==A.STYLE_INLINE&&(u.equals(d,a.block)||u.equals(d,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||d.nodeName()in N)&&this.checkElementRemovable(d,l))return l}return r}};s.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",d="";c.length&&(c=c.replace(O,";"));for(var e in b)if(b.hasOwnProperty(e)){var g=b[e],f=(e+":"+g).replace(O,
";");"inherit"==g?d+=f:c+=f}c.length&&(c=w(c));return a._ST=c+d};i.Style=s},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(f){var o=f.Node,q=f.DOM,s=f.UA,v={debugUrl:function(c){var e=f.Config;e.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));-1==c.indexOf("?t")&&(c=-1!=c.indexOf("?")?c+"&":c+"?",c+="t="+encodeURIComponent(e.tag));return e.base+"editor/"+c},lazyRun:function(c,e,f){var m=c[e],p=c[f];c[e]=function(){m.apply(this,arguments);c[e]=c[f];return p.apply(this,arguments)}},getXY:function(c,e,f,m){f=f.defaultView||f.parentWindow;c-=q.scrollLeft(f);e-=q.scrollTop(f);m&&(m=m.defaultView||
m.parentWindow,f!=m&&f.frameElement&&(m=q.offset(f.frameElement,void 0,m),c+=m.left,e+=m.top));return{left:c,top:e}},tryThese:function(c){for(var e,f=0,m=arguments.length;f<m;f++){var p=arguments[f];try{e=p();break}catch(o){}}return e},arrayCompare:function(c,e){if(!c&&!e)return!0;if(!c||!e||c.length!=e.length)return!1;for(var f=0;f<c.length;f++)if(c[f]!==e[f])return!1;return!0},clearAllMarkers:function(c){for(var e in c)c.hasOwnProperty(e)&&c[e]._4e_clearMarkers(c,!0,void 0)},ltrim:function(c){return c.replace(/^\s+/,
"")},rtrim:function(c){return c.replace(/\s+$/,"")},isNumber:function(c){return/^\d+(.\d+)?$/.test(f.trim(c))},verifyInputs:function(c){for(var e=0;e<c.length;e++){var k=new o(c[e]),m=f.trim(v.valInput(k)),p=k.attr("data-verify"),k=k.attr("data-warning");if(p&&!RegExp(p).test(m))return alert(k),!1}return!0},sourceDisable:function(c,e){c.on("sourceMode",e.disable,e);c.on("wysiwygMode",e.enable,e)},resetInput:function(c){var e=c.attr("placeholder");e&&s.ie?(c.addClass("ks-editor-input-tip"),c.val(e)):
s.ie||c.val("")},valInput:function(c,e){if(void 0===e)return c.hasClass("ks-editor-input-tip")?"":c.val();c.removeClass("ks-editor-input-tip");c.val(e)},placeholder:function(c,e){c.attr("placeholder",e);s.ie&&(c.on("blur",function(){f.trim(c.val())||(c.addClass("ks-editor-input-tip"),c.val(e))}),c.on("focus",function(){c.removeClass("ks-editor-input-tip");f.trim(c.val())==e&&c.val("")}))},htmlEncode:function(c){return!c?c:(""+c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(c){var c=f.clone(c),e;for(e in c)if(c.hasOwnProperty(e)){var k=c[e];f.isFunction(k)&&(c[e]=k())}return c},map:function(c,e){for(var f=0;f<c.length;f++)c[f]=e(c[f]);return c},ieEngine:document.documentMode||s.ie,preventFocus:function(c){s.ie?c.unselectable(void 0):c.attr("onmousedown","return false;")},injectDom:function(c){f.mix(q,c);for(var e in c)c.hasOwnProperty(e)&&function(e){o.prototype[e]=function(){var m=[].slice.call(arguments,0);m.unshift(this[0]);return(m=
c[e].apply(null,m))&&(m.nodeType||f.isWindow(m))?new o(m):f.isArray(m)&&(m.__IS_NODELIST||m[0]&&m[0].nodeType)?new o(m):m}}(e)},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,f.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],e=0;e<c.length;e++){var k=c[e];f.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(c){return"query"+("-"+c).replace(/-(\w)/g,function(c,f){return f.toUpperCase()})+"Active"}};return f.Editor.Utils=
v},{requires:["./base"]});
KISSY.add("editor/core/walker",function(f,o){function q(a,b){if(this._.end)return k;var d,f=this.range,i,l=this.guard,m=this.type,o=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),k;if(!a&&!this._.guardLTR){var q=f.endContainer[0],s=q.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(q==a||"body"==p.nodeName(a))?!1:a!=s}}if(a&&!this._.guardRTL){var t=f.startContainer[0],v=0<f.startOffset&&t.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(t==a||"body"==p.nodeName(a))?!1:a!=v}}var w=a?this._.guardRTL:this._.guardLTR;i=l?function(a,b){return w(a,b)===e?e:l(a,b)}:w;this.current?d=this.current[o](e,m,i):a?(d=f.endContainer,0<f.endOffset?(d=new n(d[0].childNodes[f.endOffset-1]),i(d[0])===e&&(d=k)):d=i(d,c)===e?k:d._4e_previousSourceNode(c,m,i,void 0)):(d=f.startContainer,d=new n(d[0].childNodes[f.startOffset]),d.length?i(d[0])===e&&(d=k):d=i(f.startContainer,c)===e?k:f.startContainer._4e_nextSourceNode(c,
m,i,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==e){if(!b)return d}else if(b&&this.evaluator)return e;d=d[o](e,m,i)}this.end();return this.current=k}function s(a){for(var b,c=k;b=q.call(this,a);)c=b;return c}function v(a){this.range=a;this.guard=this.evaluator=k;this._={}}var c=!0,e=!1,k=null,m=f.UA,p=f.DOM,x=o.XHTML_DTD,n=f.Node;f.augment(v,{end:function(){this._.end=1},next:function(){return q.call(this)},previous:function(){return q.call(this,c)},checkForward:function(){return q.call(this,
e,c)!==e},checkBackward:function(){return q.call(this,c,c)!==e},lastForward:function(){return s.call(this)},lastBackward:function(){return s.call(this,c)},reset:function(){delete this.current;this._={}},_iterator:q});f.mix(v,{blockBoundary:function(a){return function(b){return!(b.nodeType==p.ELEMENT_NODE&&p._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(e){var f,k;f=e.nodeType==p.TEXT_NODE&&(k=e.parentNode)&&c(k);
f=a?f:f||c(e);return!!(b^f)}},whitespaces:function(a){return function(b){b=b.nodeType==p.TEXT_NODE&&!f.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=v.whitespaces();return function(c){c=b(c)||c.nodeType==p.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var t=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=v.whitespaces(),a=v.bookmark(),b=function(b){var c=p.nodeName(b);return a(b)||w(b)||1==b.nodeType&&c in x.$inline&&!(c in x.$empty)};o.Utils.injectDom({_4e_getBogus:function(a){a=new n(a);do a=
a._4e_previousSourceNode();while(a&&b(a[0]));return a&&(!m.ie?"br"==a.nodeName():3==a[0].nodeType&&t.test(a.text()))?a[0]:!1}});return o.Walker=v},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(f){var o=f.Editor;o.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};o.baseZIndex=function(f){return(o.Config.baseZIndex||1E4)+f}},{requires:["./base"]});
KISSY.add("editor",function(f,o,q,s,v,c,e,k,m,p,x){function n(a,b){var c=a.body;F(function(){a.designMode="on";setTimeout(function(){a.designMode="off";c.focus();arguments.callee.retry||(arguments.callee.retry=j)},50)},function(){a.designMode="off";u.attr(c,"contentEditable",i);u.attr(c,"contentEditable",j);!b&&n(a,1)})}function t(a){a.get("iframe");var b=a.get("textarea")[0],c=a.get("window")[0],d=a.get("document")[0];r.webkit&&(E.on(d,"click",function(a){var b=new A(a.target);f.inArray(b.nodeName(),
["input","select"])&&a.preventDefault()}),E.on(d,"mouseup",function(a){var b=new A(a.target);f.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(r.gecko||z||r.opera){var e;e=(new A('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);e.on("focus",function(){a.focus()});a.activateGecko=function(){r.gecko&&a.__iframeFocus&&e[0].focus()};a.on("destroy",function(){e.detach();e.remove()})}E.on(c,"focus",function(){r.gecko?n(d,i):r.opera&&
d.body.focus();a.notifySelectionChange()});if(r.gecko)E.on(d,"mousedown",function(){a.__iframeFocus||n(d,i)});if(z&&(E.on(d,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var g={33:1,34:1};E.on(d,"keydown",function(b){b.keyCode in g&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(r.webkit)E.on(d,"mousedown",function(b){b=new A(b.target);f.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(r.gecko)E.on(d,"dragstart",function(a){var b=new A(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});s.add(a)}function w(a,b,c,d){var e="",g,h=q.debugUrl("theme/editor-iframe.css");for(g=0;g<c.length;g++)e+=f.substitute('<link href="{href}" rel="stylesheet" />',{href:c[g]});return f.substitute(C,{doctype:8===
l.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:h,style:b,data:d||"&nbsp;",script:a?'<script id="ke_active_script">'+(u.isCustomDomain()?'document.domain="'+l.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function a(a,b){a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)}function b(a,b){function c(){h=g.document;a.__set("document",new A(h));a.__set("window",
new A(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=w(a._UUID,a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(i){if(f.src=f.src,7>z){setTimeout(c,10);return}}c()}function g(a,c){var d=new A(M),e=a.get("textarea");e.hasAttr("tabindex")&&d.attr("tabIndex",r.webkit?-1:e.attr("tabIndex"));e.parent().prepend(d);a.set("iframe",d);a.__docReady=0;if(r.gecko&&!d.__loaded)d.on("load",function(){b(a,c)},a);
else b(a,c)}var j=!0,d=d,h=f.all,i=!1,l=document,r=f.UA,z=r.ie,u=f.DOM,A=f.Node,E=f.Event,F=q.tryThese,C="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",v=u.getEmptyIframeSrc(),M='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(v?' src="'+v+'"':"")+"</iframe>";f.mix(o,{SOURCE_MODE:0,WYSIWYG_MODE:1});
var I=o.WYSIWYG_MODE;f.augment(o,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=h("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');a=c.one(".ks-editor-textarea-wrap");this._UUID=f.guid();this.set({toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display",
"none");a.append(b);s.register(this)},renderUI:function(){k.init(this);m.init(this);p.init(this);x.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))u.on(c,"submit",b.sync,b),b.on("destroy",function(){u.detach(c,"submit",b.sync,b)});b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});
b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){var a=this.get("height");a&&this._uiSetHeight(a)},_uiSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("render"),e=b.get("iframe"),f=b.get("textarea");a==I?(d&&b.execCommand("save"),b.on("docReady",c=function(){d&&
b.execCommand("save");b.detach("docReady",c)}),b._setData(f.val()),b.fire("wysiwygMode")):(f.val(b._getData(1,I)),f[0].focus(),f.show(),e.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();s.remove(this);E.remove([a,a.documentElement,a.body,b[0]]);f.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},
getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=f.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_getData:function(a,b){var c=this.htmlDataProcessor,
e;b==d&&(b=this.get("mode"));e=b==I?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());e=a?c.toHtml(e):c.toServer(e);e=f.trim(e);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(e)&&(e="");return e},_setData:function(a){var b,c=a;if(this.get("mode")!=I)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var d=this.get("document")[0];E.remove([d,d.documentElement,d.body,
b]);a.remove()}g(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return w(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=u._getWin(a);r.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){u._getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},
addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);u.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){u.remove(u.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],
b=u.query("link",b),c=0;c<b.length;c++)u.attr(b[c],"href")==a&&u.remove(b[c]);b=this.get("customLink")||[];a=f.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new o.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=
d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(b){if(this.get("mode")===I){this.focus();var c,e=b.nodeName(),f=o.XHTML_DTD,g=f.$block[e],h=o.RANGE,i=(e=this.getSelection())&&e.getRanges(),k,l,m;if(i&&0!=i.length){this.execCommand("save");for(l=i.length-1;0<=l;l--)k=i[l],c=!l&&b||b.clone(j),k.insertNodeByDtd(c),m||(m=c);if(m)return k.moveToPosition(m,h.POSITION_AFTER_END),
g&&(b=o.Walker.whitespaces(!0),(b=(m=m.next(b,1))&&m[0].nodeType==u.ELEMENT_NODE&&m.nodeName())&&f.$block[b]&&f[b]["#"]&&k.moveToElementEditablePosition(m)),e.selectRanges([k]),this.focus(),c&&c.scrollIntoView(d,!1),a(this),c}}},insertHtml:function(b,c){var e=this,f;if(e.get("mode")===I){if(f=e.htmlDataProcessor)b=f.toDataFormat(b,null,c);e.focus();e.execCommand("save");var g=e.get("document")[0];f=0;if(z){var h=g.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(b)}catch(j){}}else try{g.execCommand("inserthtml",
i,b)}catch(k){setTimeout(function(){if(0==e.getSelection().getRanges().length){var a=new o.Range(g),c=u.first(g.body,function(a){return 1==a.nodeType&&"br"!=u.nodeName(a)});c||(c=new A(g.createElement("p")),c._4e_appendBogus(d),g.body.appendChild(c[0]));a.setStartAt(c,o.RANGE.POSITION_AFTER_START);a.select()}g.execCommand("inserthtml",i,b)},f=100)}setTimeout(function(){e.getSelection().scrollIntoView()},f);a(e,f)}}});o._initIFrame=function(a){var b=s.getInstance(a),c=b.get("document")[0],a=c.getElementById("ke_active_script");
u.remove(a);t(b);var d=c.body;z?(d.hideFocus=j,d.disabled=j,d.contentEditable=j,d.removeAttribute("disabled")):setTimeout(function(){r.gecko||r.opera?d.contentEditable=j:r.webkit?d.parentNode.contentEditable=j:c.designMode="on"},0);if(r.gecko||r.opera){var e=c.documentElement;E.on(e,"mousedown",function(a){if(a.target==e){r.gecko&&n(c,i);b.activateGecko()}})}setTimeout(function(){z&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=
1;b.fire("docReady");var a=b.get("disableObjectResizing"),e=b.get("disableInlineTableEditing");if(a||e)try{c.execCommand("enableObjectResizing",i,!a);c.execCommand("enableInlineTableEditing",i,!e)}catch(f){E.on(d,z?"resizestart":"resize",function(b){var c=new A(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};return o},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/meta,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
