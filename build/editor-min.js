/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 24 18:37
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(g,t,s,r){t=r.create(s.Controller,[r.Box],{initializer:function(){var g;this.__commands={};this.__dialogs={};if(g=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var e=g.next();e?this.__set("elBefore",e):this.__set("render",g.parent())}}else this.__editor_created_new=1},use:function(m,e){for(var j=this,i=j.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],m=m.split(","),o=m.length-1;0<=o;o--)m[o]||m.splice(o,1);for(o=
0;o<i.length;o++){var n=i[o];g.inArray(n,m)||m.unshift(n)}g.each(m,function(e,j){m[j]&&(m[j]="editor/plugin/"+e+"/")});g.use(m.join(","),function(){var i,m=g.makeArray(arguments);m.shift();for(var n=0;n<m.length;n++)m[n].init(j);e&&e.call(j);(i=j.get("height"))&&j._uiSetHeight(i)});j.__CORE_PLUGINS=[];return j}},{Config:{},XHTML_DTD:t.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},
data:{getter:function(){return this._getData()},setter:function(g){return this._setData(g)}},formatData:{getter:function(){return this._getData(1)},setter:function(g){return this._setData(g)}},prefixCls:{value:"ke-"}}},"Editor");g.mix(t,g.EventTarget);return KISSY.Editor=t},{requires:["htmlparser","component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(g){function t(b){this.editor=b;this._init()}function s(b){if(e.ie&&"BackCompat"!=b.get("document")[0].compatMode){var f=b.getSelection(),c;if(f.getType()==d.SELECTION_ELEMENT&&(c=f.getSelectedElement())){var a=f.getRanges()[0],h=new m(b.get("document")[0].createTextNode(""));h.insertBefore(c);a.setStartBefore(h);a.setEndAfter(c);f.selectRanges([a]);setTimeout(function(){c.parent()&&(h.remove(),f.selectElement(c))},0)}}}var r=g.Editor,m=g.Node,e=g.UA,
j=r.Range,i=r.RANGE,o=g.Event;g.augment(t,{_init:function(){var b=this.editor;o.on(b.get("document")[0].body,e.webkit?"paste":e.gecko?"paste":"beforepaste",this._paste,this);o.on(b.get("document")[0].body,"contextmenu",function(){f=1;setTimeout(function(){f=0},10)});b.addCommand("copy",new q("copy"));b.addCommand("cut",new q("cut"));b.addCommand("paste",new q("paste"))},_paste:function(){if(!f){var b=this.editor,d=b.get("document")[0];if(!d.getElementById("ke_pastebin")){var c=b.getSelection(),a=
new j(d),h=new m(e.webkit?"<body></body>":"<div></div>",null,d);h.attr("id","ke_pastebin");e.webkit&&h[0].appendChild(d.createTextNode("\u00a0"));d.body.appendChild(h[0]);h.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});h.css("left","-1000px");var l=c.createBookmarks();a.setStartAt(h,i.POSITION_AFTER_START);a.setEndAt(h,i.POSITION_BEFORE_END);a.select(!0);setTimeout(function(){h.remove();var a;h=e.webkit&&(a=h.first())&&a.hasClass("Apple-style-span")?
a:h;c.selectBookmarks(l);a=h.html();if(a=g.trim(a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var d=b.fire("paste",{html:a,holder:h});void 0!==d&&(a=d);d=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(a)&&(d=b.htmlDataProcessor.wordFilter);b.insertHtml(a,d)}},0)}}}});var n=function(b,d){var c=b.get("document")[0],a=new m(c.body),h=!1,l=function(){h=!0};a.on(d,l);(7<e.ie?c:c.selection.createRange()).execCommand(d);a.detach(d,l);return h},u=e.ie?function(b,d){return n(b,
d)}:function(b,d){try{return b.get("document")[0].execCommand(d)}catch(c){return!1}},p={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},q=function(b){this.type=b};q.prototype={exec:function(b){"cut"==this.type&&s(b);(b=u(b,this.type))||alert(p[this.type]);return b}};var d=r.Selection,b={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},f;r.on("contextmenu",function(d){var f=d.contextmenu,c=f.get("editor"),
a=f.menu.get("contentEl"),h={copy:0,cut:0,paste:0},l;for(l in h)h.hasOwnProperty(l)&&(h[l]=a.one(".ke-paste-"+l),h[l]||function(d){var l=(new m("<a href='#'class='ke-paste-"+d+"'>"+b[d]+"</a>")).appendTo(a);l.on("click",function(a){a.halt();f.hide();setTimeout(function(){c.execCommand(d)},30)});h[d]=l}(l))});return{init:function(b){b.docReady(function(){new t(b)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(g){function t(d,b){var f=d[b?"next":"prev"]();if(f&&f[0].nodeType==m.ELEMENT_NODE){for(var k=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemovable(s);)if(k.push(f),f=b?f.next():f.prev(),!f)return;if(d._4e_isIdentical(f,s)){for(var e=new j(b?d[0].lastChild:d[0].firstChild);k.length;)k.shift()._4e_move(d,!b,s);f._4e_moveChildren(d,!b,s);f.remove();e[0]&&e[0].nodeType==m.ELEMENT_NODE&&e._4e_mergeSiblings()}}}var s=s,r=g.Editor,m=g.DOM,e=g.UA,j=g.Node,i=r.Utils,
o={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var n=r.POSITION,u={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},p={hr:1},q=function(d){return d&&(d[0]||d)};i.injectDom({_4e_sameLevel:function(d,b){var b=q(b),f=d.parentNode;return f&&f==b.parentNode},_4e_isBlockBoundary:function(d,b){var f=g.merge(p,b);return!(!u[m.css(d,"display")]&&!f[m.nodeName(d)])},_4e_getWin:m._getWin,_4e_index:function(d,b){for(var f=d.parentNode.childNodes,k,e=-1,c=0;c<f.length;c++)if(k=f[c],!b||!(3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType))if(e++,k===d)return e;return-1},_4e_move:function(d,
b,f){b=q(b);f?b.insertBefore(d,b.firstChild):b.appendChild(d)},_4e_isIdentical:function(d,b){if(!b)return!1;b=q(b);if(m.nodeName(d)!=m.nodeName(b))return!1;var f=d.attributes,k=b.attributes,e=f.length,c=k.length;if(e!=c)return!1;for(var a=0;a<e;a++){var h=f[a],l=h.name;if(h.specified&&m.attr(d,l)!=m.attr(b,l))return!1}if(8>i.ieEngine)for(a=0;a<c;a++)if(h=k[a],l=h.name,h.specified&&m.attr(d,l)!=m.attr(b,l))return!1;return!0},_4e_isEmptyInlineRemovable:function(d){for(var d=d.childNodes,b=0,f=d.length;b<
f;b++){var k=d[b],e=k.nodeType;if(!(e==m.ELEMENT_NODE&&k.getAttribute("_ke_bookmark"))&&(e==m.ELEMENT_NODE&&!m._4e_isEmptyInlineRemovable(k)||e==m.TEXT_NODE&&g.trim(k.nodeValue)))return!1}return!0},_4e_moveChildren:function(d,b,f){b=q(b);if(d!=b)if(f)for(;f=d.lastChild;)b.insertBefore(d.removeChild(f),b.firstChild);else for(;f=d.firstChild;)b.appendChild(d.removeChild(f))},_4e_mergeSiblings:function(d){d=new j(d);o[d.nodeName()]&&(t(d,!0),t(d))},_4e_splitText:function(d,b){var f=d.ownerDocument;if(d.nodeType==
m.TEXT_NODE){if(e.ie&&b==d.nodeValue.length){var k=f.createTextNode("");m.insertAfter(k,d);return k}k=d.splitText(b);f.documentMode&&(f=f.createTextNode(""),m.insertAfter(f,k),m.remove(f));return k}},_4e_parents:function(d,b){var f=[];f.__IS_NODELIST=1;do f[b?"push":"unshift"](d);while(d=d.parentNode);return f},_4e_nextSourceNode:function(d,b,f,k){if(k&&!k.call)var e=q(k),k=function(a){return a!==e};var b=!b&&d.firstChild,c=d;if(!b){if(d.nodeType==m.ELEMENT_NODE&&k&&!1===k(d,!0))return null;b=d.nextSibling}for(;!b&&
(c=c.parentNode);){if(k&&!1===k(c,!0))return null;b=c.nextSibling}return!b||k&&!1===k(b)?null:f&&f!=b.nodeType?m._4e_nextSourceNode(b,!1,f,k):b},_4e_previousSourceNode:function(d,b,f,k){if(k&&!k.call)var e=q(k),k=function(a){return a!==e};var b=!b&&d.lastChild,c=d;if(!b){if(d.nodeType==m.ELEMENT_NODE&&k&&!1===k(d,!0))return null;b=d.previousSibling}for(;!b&&(c=c.parentNode);){if(k&&!1===k(c,!0))return null;b=c.previousSibling}return!b||k&&!1===k(b)?null:f&&b.nodeType!=f?m._4e_previousSourceNode(b,
!1,f,k):b},_4e_commonAncestor:function(d,b){b=q(b);if(d===b)return d;if(m.contains(b,d))return b;var f=d;do if(m.contains(f,b))return f;while(f=f.parentNode);return null},_4e_hasAttributes:9>i.ieEngine?function(d){for(var b=d.attributes,f=0;f<b.length;f++){var k=b[f];switch(k.name){case "class":if(d.getAttribute("class"))return!0;break;default:if(k.specified)return!0}}return!1}:function(d){e.gecko&&d.removeAttribute("_moz_dirty");return d.hasAttributes()},_4e_position:function(d,b){var f=q(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(f);
if(d==f)return n.POSITION_IDENTICAL;if(d.nodeType==m.ELEMENT_NODE&&f.nodeType==m.ELEMENT_NODE){if(m.contains(d,f))return n.POSITION_CONTAINS+n.POSITION_PRECEDING;if(m.contains(f,d))return n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING;if("sourceIndex"in d)return 0>d.sourceIndex||0>f.sourceIndex?n.POSITION_DISCONNECTED:d.sourceIndex<f.sourceIndex?n.POSITION_PRECEDING:n.POSITION_FOLLOWING}for(var k=m._4e_address(d),f=m._4e_address(f),e=Math.min(k.length,f.length),c=0;c<=e-1;c++)if(k[c]!=f[c])return k[c]<
f[c]?n.POSITION_PRECEDING:n.POSITION_FOLLOWING;return k.length<f.length?n.POSITION_CONTAINS+n.POSITION_PRECEDING:n.POSITION_IS_CONTAINED+n.POSITION_FOLLOWING},_4e_address:function(d,b){for(var f=[],k=d.ownerDocument.documentElement,e=d;e&&e!=k;)f.unshift(m._4e_index(e,b)),e=e.parentNode;return f},_4e_remove:function(d,b){var f=d.parentNode;if(f){if(b)for(var k;k=d.firstChild;)f.insertBefore(d.removeChild(k),d);f.removeChild(d)}return d},_4e_trim:function(d){m._4e_ltrim(d);m._4e_rtrim(d)},_4e_ltrim:function(d){for(var b;b=
d.firstChild;){if(b.nodeType==m.TEXT_NODE){var f=i.ltrim(b.nodeValue),k=b.nodeValue.length;if(f)f.length<k&&(m._4e_splitText(b,k-f.length),d.removeChild(d.firstChild));else{d.removeChild(b);continue}}break}},_4e_rtrim:function(d){for(var b;b=d.lastChild;){if(b.type==m.TEXT_NODE){var f=i.rtrim(b.nodeValue),k=b.nodeValue.length;if(f)f.length<k&&(m._4e_splitText(b,f.length),d.removeChild(d.lastChild));else{d.removeChild(b);continue}}break}!e.ie&&!e.opera&&(b=d.lastChild)&&1==b.nodeType&&"br"==m.nodeName(b)&&
d.removeChild(b)},_4e_appendBogus:function(d){for(var b=d.lastChild;b&&b.nodeType==m.TEXT_NODE&&!g.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==m.TEXT_NODE||"br"!==m.nodeName(b))b=e.opera?d.ownerDocument.createTextNode(""):d.ownerDocument.createElement("br"),e.gecko&&b.setAttribute("type","_moz"),d.appendChild(b)},_4e_outerHtml:function(d){if(d.outerHTML)return d.outerHTML.replace(/<\?[^>]*>/,"");var b=d.ownerDocument.createElement("div");b.appendChild(d.cloneNode(!0));return b.innerHTML},
_4e_setMarker:function(d,b,f,k){var d=new j(d),e=d.data("list_marker_id")||d.data("list_marker_id",g.guid()).data("list_marker_id"),c=d.data("list_marker_names")||d.data("list_marker_names",{}).data("list_marker_names");b[e]=d;c[f]=1;return d.data(f,k)},_4e_clearMarkers:function(d,b,e){var d=new j(d),k=d.data("list_marker_names"),i=d.data("list_marker_id"),c;for(c in k)k.hasOwnProperty(c)&&d.removeData(c);d.removeData("list_marker_names");e&&(d.removeData("list_marker_id"),delete b[i])},_4e_copyAttributes:function(d,
b,f){for(var b=new j(b),k=d.attributes,f=f||{},i=0;i<k.length;i++){var c=k[i],a=c.name.toLowerCase(),h;if(!(a in f))if("checked"==a&&(h=m.attr(d,a)))b.attr(a,h);else if(c.specified||e.ie&&c.value&&"value"==a)h=m.attr(d,a),null===h&&(h=c.nodeValue),b.attr(a,h)}""!==d.style.cssText&&(b[0].style.cssText=d.style.cssText)},_4e_isEditable:function(d){var d=m.nodeName(d),b=r.XHTML_DTD;return(d=!b.$nonEditable[d]&&(b[d]||b.span))&&d["#"]},_4e_getByAddress:function(d,b,e){for(var d=d.documentElement,k=0;d&&
k<b.length;k++){var i=b[k];if(e)for(var c=-1,a=0;a<d.childNodes.length;a++){var h=d.childNodes[a];if(!(!0===e&&3==h.nodeType&&h.previousSibling&&3==h.previousSibling.nodeType)&&(c++,c==i)){d=h;break}}else d=d.childNodes[i]}return d}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(g){function t(d){1>arguments.length||(this.range=d,this.forceBrBreak=r,this.enlargeBr=s,this.enforceRealBlocks=r,this._||(this._={}))}var s=!0,r=!1,m=g.Editor,e=g.UA,j=m.Walker,i=m.Range,o=m.RANGE,n=m.ElementPath,u=g.Node,p=g.DOM,q=/^[\r\n\t ]*$/;g.augment(t,{getNextParagraph:function(d){var b,f,k,m,c;if(!this._.lastNode){f=this.range.clone();f.shrink(o.SHRINK_ELEMENT,s);f.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var a=new j(f),h=j.bookmark(s,s);a.evaluator=h;this._.nextNode=a.next();a=new j(f);a.evaluator=h;a=a.previous();this._.lastNode=a._4e_nextSourceNode(s);this._.lastNode&&this._.lastNode[0].nodeType==p.TEXT_NODE&&!g.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(h=new i(f.document),h.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),h.checkEndOfBlock()&&(h=new n(h.endContainer),this._.lastNode=(h.block||h.blockLimit)._4e_nextSourceNode(s)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new u(f.document.createTextNode("")),p.insertAfter(this._.lastNode[0],a[0]));f=null}h=this._.nextNode;a=this._.lastNode;for(this._.nextNode=null;h;){var l=r,v=h[0].nodeType!=p.ELEMENT_NODE,x=r;if(v)h[0].nodeType==p.TEXT_NODE&&q.test(h[0].nodeValue)&&(v=r);else{var z=h.nodeName();if(h._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==z)v=s;else if(!f&&!h[0].childNodes.length&&"hr"!=z){b=h;k=h.equals(a);break}f&&(f.setEndAt(h,o.POSITION_BEFORE_START),"br"!=
z&&(this._.nextNode=h));l=s}else{if(h[0].firstChild){f||(f=new i(this.range.document),f.setStartAt(h,o.POSITION_BEFORE_START));h=new u(h[0].firstChild);continue}v=s}}v&&!f&&(f=new i(this.range.document),f.setStartAt(h,o.POSITION_BEFORE_START));k=(!l||v)&&h.equals(a);if(f&&!l)for(;!h[0].nextSibling&&!k;){z=h.parent();if(z._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=s;k||z.equals(a);break}h=z;v=s;k=h.equals(a);x=s}v&&f.setEndAt(h,o.POSITION_AFTER_END);h=h._4e_nextSourceNode(x,null,a);if((k=!h)||
l&&f)break}if(!b){if(!f)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;b=new n(f.startContainer);h=b.blockLimit;l={div:1,th:1,td:1};b=b.block;if((!b||!b[0])&&!this.enforceRealBlocks&&l[h.nodeName()]&&f.checkStartOfBlock()&&f.checkEndOfBlock())b=h;else if(!b||this.enforceRealBlocks&&"li"==b.nodeName())b=new u(this.range.document.createElement(d||"p")),b[0].appendChild(f.extractContents()),b._4e_trim(),f.insertNode(b),m=c=s;else if("li"!=b.nodeName()){if(!f.checkStartOfBlock()||
!f.checkEndOfBlock())b=b.clone(r),b[0].appendChild(f.extractContents()),b._4e_trim(),c=f.splitBlock(),m=!c.wasStartOfBlock,c=!c.wasEndOfBlock,f.insertNode(b)}else k||(this._.nextNode=b.equals(a)?null:f.getBoundaryNodes().endNode._4e_nextSourceNode(s,null,a))}m&&(f=new u(b[0].previousSibling),f[0]&&f[0].nodeType==p.ELEMENT_NODE&&("br"==f.nodeName()?f._4e_remove():f[0].lastChild&&"br"==p.nodeName(f[0].lastChild)&&p._4e_remove(f[0].lastChild)));c&&(f=j.bookmark(r,s),m=new u(b[0].lastChild),m[0]&&m[0].nodeType==
p.ELEMENT_NODE&&"br"==m.nodeName()&&(e.ie||m.prev(f)||m.next(f))&&m.remove());this._.nextNode||(this._.nextNode=k||b.equals(a)?null:b._4e_nextSourceNode(s,null,a));return b}});i.prototype.createIterator=function(){return new t(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(g){function t(g){for(var n=e,t=e,p=[];g;){if(g[0].nodeType==r.ELEMENT_NODE){this.lastElement||(this.lastElement=g);var q=g.nodeName();if(!t&&(!n&&j[q]&&(n=g),i[q])){var d;if(d=!n)if(d="div"==q){a:{d=g[0].childNodes;for(var b=0,f=d.length;b<f;b++){var k=d[b];if(k.nodeType==r.ELEMENT_NODE&&m.$block[k.nodeName.toLowerCase()]){d=!0;break a}}d=!1}d=!d}d?n=g:t=g}p.push(g);if("body"==q)break}g=g.parent()}this.block=n;this.blockLimit=t;this.elements=p}var s=g.Editor,
r=g.DOM,m=s.XHTML_DTD,e=null,j={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};t.prototype={compare:function(e){var g=this.elements,e=e&&e.elements;if(!e||g.length!=e.length)return!1;for(var i=0;i<g.length;i++)if(!r.equals(g[i],e[i]))return!1;return!0},contains:function(g){for(var i=this.elements,j=0;j<i.length;j++)if(i[j].nodeName()in g)return i[j];return e},toString:function(){var e=this.elements,
i,g=[];for(i=0;i<e.length;i++)g.push(e[i].nodeName());return g.toString()}};return s.ElementPath=t},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(g){function t(p){var q;q=p.getSelection().getRanges();for(var d=q.length-1;0<d;d--)q[d].deleteContents();q=q[0];d=q.document;if(q.checkStartOfBlock()&&q.checkEndOfBlock()){var b=(new u(q.startContainer)).block;if(b&&("li"==b.nodeName()||"li"==b.parent().nodeName()))return p.hasCommand("outdent")?(p.execCommand("save"),p.execCommand("outdent"),p.execCommand("save"),!0):!1}var f=q.splitBlock("p");if(!f)return!0;var p=f.previousBlock,b=f.nextBlock,k=
f.wasStartOfBlock,o=f.wasEndOfBlock,c;if(b)c=b.parent(),"li"==c.nodeName()&&(b._4e_breakParent(c),b._4e_move(b.next(),!0));else if(p&&(c=p.parent())&&"li"==c.nodeName())p._4e_breakParent(c),q.moveToElementEditablePosition(p.next()),p._4e_move(p.prev());if(!k&&!o){if("li"==b.nodeName()&&(c=b.first(n.invisible(!0)))&&g.inArray(c.nodeName(),["ul","ol"]))(m.ie?new i(d.createTextNode("\u00a0")):new i(d.createElement("br"))).insertBefore(c);b&&q.moveToElementEditablePosition(b)}else{var a;if(p){if("li"==p.nodeName()||
!e.test(p.nodeName()))a=p.clone()}else b&&(a=b.clone());a||(a=new i("<p>",null,d));if(c=f.elementPath)for(var f=0,h=c.elements.length;f<h;f++){var l=c.elements[f];if(l.equals(c.block)||l.equals(c.blockLimit))break;j.$removeEmpty[l.nodeName()]&&(l=l.clone(),a._4e_moveChildren(l),a.append(l))}m.ie||a._4e_appendBogus();q.insertNode(a);if(m.ie&&k&&(!o||!p[0].childNodes.length))q.moveToElementEditablePosition(o?p:a),q.select();q.moveToElementEditablePosition(k&&!o?b:a)}m.ie||(b?(a=new i(d.createElement("span")),
a.html("&nbsp;"),q.insertNode(a),a.scrollIntoView(void 0,!1),q.deleteContents()):a.scrollIntoView(void 0,!1));q.select();return!0}function s(e){var i=e.get("document")[0];o.on(i,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){e.execCommand("save");var b=e.execCommand("enterBlock");e.execCommand("save");!1!==b&&d.preventDefault()}})}var r=g.Editor,m=g.UA,e=/^h[1-6]$/,j=r.XHTML_DTD,i=g.Node,o=g.Event,n=r.Walker,u=r.ElementPath;return{init:function(e){e.addCommand("enterBlock",
{exec:t});e.docReady(function(){s(e)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(g){function t(){var e=this;e.__iframeFocus=n;o=e;i&&clearTimeout(i);i=setTimeout(function(){e.fire("focus")},100)}function s(){var e=this;e.__iframeFocus=u;o=p;i&&clearTimeout(i);i=setTimeout(function(){e.fire("blur")},100)}var r=g.Editor,m=g.DOM,e=g.Event,j={},i,o,g={refreshAll:function(){for(var e in j)if(j.hasOwnProperty(e)){var d=j[e].get("document")[0];d.designMode="off";d.designMode="on"}},currentInstance:function(){return o},getInstance:function(e){return j[e]},
add:function(i){var d=m._4e_getWin(i.get("document")[0]);e.on(d,"focus",t,i);e.on(d,"blur",s,i)},register:function(e){j[e._UUID]=e},remove:function(i){delete j[i._UUID];var d=m._4e_getWin(i.get("document")[0]);e.remove(d,"focus",t,i);e.remove(d,"blur",s,i)}},n=!0,u=!1,p=null;g.refreshAll=g.refreshAll;r.focusManager=g;r.getInstances=function(){return j};return g},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(g){return{init:function(t){function s(e){return e.replace(d,function(d,c,a){return"<"+c+a.replace(b,function(c,b){return-1==a.indexOf("_ke_saved_"+b)?" _ke_saved_"+c+" "+c:c})+">"})}function r(b){return b.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(b){return"<\!--"+f+"{C}"+encodeURIComponent(b).replace(/--/g,"%2D%2D")+"--\>"})}function m(b){return b.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(b,c){return decodeURIComponent(c)})}
var e=e,j=g.Editor,i=g.Node,o=g.UA,n=g.require("htmlparser"),u=new n.Filter,p=new n.Filter,q=new n.Filter;(function(){var b=function(a,c){return function(b,d){var e=[];(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,l,G){l=l.toLowerCase();"font-family"==l&&(G=G.replace(/["']/g,""));for(var k,w,f,i=0;i<a.length;i++)if(a[i]&&(b=a[i][0],k=a[i][1],w=a[i][2],f=a[i][3],l.match(b)&&(!k||G.match(k)))){l=f||l;c&&(w=w||G);"function"==typeof w&&(w=w(G,d,l));w&&w.push&&
(l=w[0],w=w[1]);"string"==typeof w&&e.push([l,w]);return}!c&&e.push([l,G])});for(var k=0;k<e.length;k++)e[k]=e[k].join(":");return e.length?e.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],e),d={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var c=a.nodeName||"";if(-1!=c.indexOf(":")&&
!/^ke/.test(c))if("v:imagedata"==c){if(c=a.getAttribute("o:href"))a.setAttribute("src",c),a.removeAttribute("o:href");if(c=a.getAttribute("o:title"))a.setAttribute("title",c),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=b(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},c={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=
["name","href","src"],b,d=0;d<c.length;d++)b="_ke_saved_"+c[d],a.getAttribute(b)&&a.removeAttribute(c[d]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!g.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,f.length)==f?(a="{C}"==a.substr(f.length,3)?a.substr(f.length+3):a.substr(f.length),new n.CData(decodeURIComponent(a))):a}};o.ie&&(c.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});u.addRules(c);p.addRules(d);q.addRules(d)})();(function(){function b(a){for(var a=a.childNodes,c=a.length,h=a[c-1];h&&3==h.nodeType&&!g.trim(h.nodeValue);)h=a[--c];return h}
function d(a,c){var h=b(a);h&&((c||!o.ie)&&1==h.nodeType&&"br"==h.nodeName?a.removeChild(h):3==h.nodeType&&e.test(h.nodeValue)&&a.removeChild(h))}function c(a){var c=b(a);return!c||1==c.nodeType&&"br"==c.nodeName||"form"==a.nodeName&&"input"==c.nodeName}function a(a){d(a,!0);c(a)&&(o.ie?a.appendChild(new n.Text("\u00a0")):(a.appendChild(new n.Text("&nbsp;")),a.appendChild(new n.Tag("br"))))}function h(a){d(a,!1);c(a)&&a.appendChild(new n.Text("\u00a0"))}var e=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,f=j.XHTML_DTD,i=j.Utils.mix({},
f.$block,f.$listItem,f.$tableContent),m;for(m in i)i.hasOwnProperty(m)&&("br"in f[m]||delete i[m]);delete i.td;delete i.pre;var f={tags:{}},t={tags:{}};for(m in i)i.hasOwnProperty(m)&&(f.tags[m]=a,t.tags[m]=h);p.addRules(f);u.addRules(t);q.addRules(f)})();(function(){u.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}})})();var d=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,f="{ke_protected}";t.htmlDataProcessor={wordFilter:q,
dataFilter:p,htmlFilter:u,toHtml:function(b){var d=new n.BeautifyWriter;(new n.Parser(b)).parse().writeHtml(d,u);return d.getHtml()},toDataFormat:function(b,d,c){c=c||p;o.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=s(b);d=new i("<div>");d.html("a"+b);b=d.html().substr(1);b=m(b);d=new n.BeautifyWriter;(new n.Parser(b)).parse().writeHtml(d,c);b=d.getHtml();return b=r(b)},toServer:function(b){var d=new n.MinifyWriter;(new n.Parser(b)).parse().writeHtml(d,
u);return d.getHtml()}}}}},{requires:["editor"]});
KISSY.add("editor/core/meta",function(){var g={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../select/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubbleview/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],insertOrderedList:["../listUtils/btn","./cmd"],insertUnorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubbleview/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["./focus","dd"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui","./cmd"],
undo:["./btn","./cmd"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},t,s,r={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../select/"],"flashCommon/baseClass":["../contextmenu/","../bubbleview/","../dialogLoader/","./utils"],
"font/ui":["../button/","../select/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../select/"],"indent/cmd":["../dentUtils/cmd"],"insertOrderedList/cmd":["../listUtils/cmd"],"insertUnorderedList/cmd":["../listUtils/cmd.js"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],"link/dialog":["../overlay/",
"./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../select/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../select/"],"xiamiMusic/dialog":["../flash/dialog","../select/"]},m={};for(t in g)s="editor/plugin/"+t+"/index",m[s]={requires:g[t]};
for(t in r)s="editor/plugin/"+t,m[s]={requires:r[t]};KISSY.add(m)});
KISSY.add("editor/core/range",function(g,t,s,r,m){function e(a){var b=a.nodeType!=k.TEXT_NODE&&k.nodeName(a)in c.$removeEmpty,h=a.nodeType==k.TEXT_NODE&&!g.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||h||a}function j(a){return!v(a)&&!x(a)}function i(a){var c=q;return function(b){if(x(b))return p;if(b.nodeType==k.TEXT_NODE){if(g.trim(b.nodeValue).length)return q}else if(b.nodeType==k.ELEMENT_NODE&&(b=k.nodeName(b),!F[b]))if(!a&&!E.ie&&"br"==b&&!c)c=p;else return q;return p}}
function o(c,b){var h=c.startContainer,d=c.endContainer,e=c.startOffset,l=c.endOffset,f,i=q,v=q,g=void 0,j=c.document,m;if(c.collapsed)return g;0<b&&(g=j.createDocumentFragment());c.optimizeBookmark();d[0].nodeType==k.TEXT_NODE?(v=p,d=d._4e_splitText(l)):0<d[0].childNodes.length&&(l>=d[0].childNodes.length?(d=new a(d[0].appendChild(j.createTextNode(""))),m=p):d=new a(d[0].childNodes[l]));h[0].nodeType==k.TEXT_NODE?(i=p,h._4e_splitText(e)):e?e>=h[0].childNodes.length?(h=new a(h[0].appendChild(j.createTextNode(""))),
f=p):h=new a(h[0].childNodes[e].previousSibling):(f=new a(j.createTextNode("")),h.prepend(f),h=f,f=p);var x=h._4e_parents(),n=d._4e_parents();x.each(function(a,c){x[c]=a});n.each(function(a,c){n[c]=a});for(var C,J,j=0;j<x.length&&!(C=x[j],J=n[j],!C.equals(J));j++);for(var e=g,y,o,z=j;z<x.length;z++){y=x[z];l=0<b&&!y.equals(h)?e.appendChild(y.clone()[0]):null;y=y[0].nextSibling;o=n[z];for(var t=d[0],r=o&&o[0];y&&!(r==y||t==y);)o=y.nextSibling,2==b?e.appendChild(y.cloneNode(p)):(k._4e_remove(y),1==
b&&e.appendChild(y)),y=o;l&&(e=l)}for(e=g;j<n.length;j++){y=n[j];l=0<b&&!y.equals(d)?e.appendChild(y.clone()[0]):null;if(!x[j]||!y._4e_sameLevel(x[j]))for(y=y[0].previousSibling;y;)o=y.previousSibling,2==b?e.insertBefore(y.cloneNode(p),e.firstChild):(k._4e_remove(y),1==b&&e.insertBefore(y,e.firstChild)),y=o;l&&(e=l)}if(2==b){if(i&&(C=h[0],C.nodeType==k.TEXT_NODE&&C.nextSibling&&C.nextSibling.nodeType==k.TEXT_NODE&&(C.data+=C.nextSibling.data,C.parentNode.removeChild(C.nextSibling))),v)v=d[0],v.nodeType==
k.TEXT_NODE&&v.previousSibling&&v.previousSibling.nodeType==k.TEXT_NODE&&(v.previousSibling.data+=v.data,v.parentNode.removeChild(v))}else{if(C&&J&&(!h._4e_sameLevel(C)||!d._4e_sameLevel(J)))v=C._4e_index(),f&&C._4e_sameLevel(h)&&v--,c.setStart(C.parent(),v+1);c.collapse(p)}f&&h.remove();m&&d.remove();return g}function n(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function u(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=d;this.collapsed=p;this.document=a}t.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var p=!0,q=!1,d=null,b=t.RANGE,f=t.POSITION,k=g.DOM,E=g.UA,c=t.XHTML_DTD,a=g.Node,h=a.all,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new r.whitespaces,x=new r.bookmark,z=r.whitespaces(p),A=r.bookmark(!1,
!0),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};g.augment(u,{toString:function(){var a=[],c=this.startContainer[0],b=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,c=this.startOffset;a[0].nodeType!=k.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=k.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
c=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);c&&"span"==c.nodeName()&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(a,c){a[0].nodeType==k.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);n(this)},setEnd:function(a,c){a[0].nodeType==k.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+1);this.endContainer=a;this.endOffset=
c;this.startContainer||(this.startContainer=a,this.startOffset=c);n(this)},setStartAt:function(a,c){switch(c){case b.POSITION_AFTER_START:this.setStart(a,0);break;case b.POSITION_BEFORE_END:a[0].nodeType==k.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case b.POSITION_BEFORE_START:this.setStartBefore(a);break;case b.POSITION_AFTER_END:this.setStartAfter(a)}n(this)},setEndAt:function(a,c){switch(c){case b.POSITION_AFTER_START:this.setEnd(a,0);break;
case b.POSITION_BEFORE_END:a[0].nodeType==k.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case b.POSITION_BEFORE_START:this.setEndBefore(a);break;case b.POSITION_AFTER_END:this.setEndAfter(a)}n(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=p},clone:function(){var a=new u(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=k.ELEMENT_NODE||a.endContainer[0].nodeType!=k.ELEMENT_NODE)return d;var c=new r(a);c.evaluator=function(a){return z(a)&&A(a)};a=c.next();c.reset();c=
c.previous();return a&&a.equals(c)?a:d},shrink:function(a,c){if(!this.collapsed){var a=a||b.SHRINK_TEXT,h=this.clone(),d=this.startContainer,e=this.endContainer,l=this.startOffset,f=this.endOffset,i=p,v,g,j=p;d&&d[0].nodeType==k.TEXT_NODE&&(l?l>=d[0].nodeValue.length?h.setStartAfter(d):(h.setStartBefore(d),i=q):h.setStartBefore(d));e&&e[0].nodeType==k.TEXT_NODE&&(f?f>=e[0].nodeValue.length?h.setEndAfter(e):(h.setEndAfter(e),j=q):h.setEndBefore(e));if(i||j)g=new r(h),g.evaluator=function(c){return c.nodeType==
(a==b.SHRINK_ELEMENT?k.ELEMENT_NODE:k.TEXT_NODE)},g.guard=function(c,h){c=c[0]||c;if(a==b.SHRINK_ELEMENT&&c.nodeType==k.TEXT_NODE||h&&c==v)return q;!h&&c.nodeType==k.ELEMENT_NODE&&(v=c);return p};i&&(h=g[a==b.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(h,c?b.POSITION_AFTER_START:b.POSITION_BEFORE_START);j&&(g.reset(),(g=g[a==b.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(g,c?b.POSITION_BEFORE_END:b.POSITION_AFTER_END));return i||j}},createBookmark2:function(c){var b=this.startContainer,
h=this.endContainer,e=this.startOffset,l=this.endOffset,f,i;if(!b||!h)return{start:0,end:0};if(c){if(b[0].nodeType==k.ELEMENT_NODE&&(f=new a(b[0].childNodes[e]))&&f[0]&&f[0].nodeType==k.TEXT_NODE&&0<e&&f[0].previousSibling.nodeType==k.TEXT_NODE)b=f,e=0;for(;b[0].nodeType==k.TEXT_NODE&&(i=b.prev())&&i[0].nodeType==k.TEXT_NODE;)b=i,e+=i[0].nodeValue.length;if(!this.collapsed){if(h[0].nodeType==k.ELEMENT_NODE&&(f=new a(h[0].childNodes[l]))&&f[0]&&f[0].nodeType==k.TEXT_NODE&&0<l&&f[0].previousSibling.nodeType==
k.TEXT_NODE)h=f,l=0;for(;h[0].nodeType==k.TEXT_NODE&&(i=h.prev())&&i[0].nodeType==k.TEXT_NODE;)h=i,l+=i[0].nodeValue.length}}return{start:b._4e_address(c),end:this.collapsed?d:h._4e_address(c),startOffset:e,endOffset:l,normalized:c,is2:p}},createBookmark:function(c){var h,e,l,f,i=this.collapsed;h=new a("<span>",d,this.document);h.attr("_ke_bookmark",1);h.css("display","none");h.html("&nbsp;");c&&(l=g.guid("ke_bm_"),h.attr("id",l+"S"));i||(e=h.clone(),e.html("&nbsp;"),c&&e.attr("id",l+"E"),f=this.clone(),
f.collapse(),f.insertNode(e));f=this.clone();f.collapse(p);f.insertNode(h);e?(this.setStartAfter(h),this.setEndBefore(e)):this.moveToPosition(h,b.POSITION_AFTER_END);return{startNode:c?l+"S":h,endNode:c?l+"E":e,serializable:c,collapsed:i}},moveToPosition:function(a,c){this.setStartAt(a,c);this.collapse(p)},trim:function(a,c){var b=this.startContainer,h=this.startOffset,d=this.collapsed;if((!a||d)&&b[0]&&b[0].nodeType==k.TEXT_NODE){if(h)if(h>=b[0].nodeValue.length)h=b._4e_index()+1,b=b.parent();else{var e=
b._4e_splitText(h),h=b._4e_index()+1,b=b.parent();k.equals(this.startContainer,this.endContainer)?this.setEnd(e,this.endOffset-this.startOffset):k.equals(b,this.endContainer)&&(this.endOffset+=1)}else h=b._4e_index(),b=b.parent();this.setStart(b,h);if(d){this.collapse(p);return}}b=this.endContainer;h=this.endOffset;!c&&!d&&b[0]&&b[0].nodeType==k.TEXT_NODE&&(h?(h>=b[0].nodeValue.length||b._4e_splitText(h),h=b._4e_index()+1):h=b._4e_index(),b=b.parent(),this.setEnd(b,h))},insertNode:function(a){this.optimizeBookmark();
this.trim(q,p);var c=this.startContainer;c[0].insertBefore(a[0],c[0].childNodes[this.startOffset]||null);c[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var c=h(this.document);if(a.is2){var b=c._4e_getByAddress(a.start,a.normalized),d=a.startOffset,c=a.end&&c._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(b,d);c?this.setEnd(c,a):this.collapse(p)}else b=(d=a.serializable)?g.one("#"+a.startNode,c):a.startNode,a=d?g.one("#"+a.endNode,
c):a.endNode,this.setStartBefore(b),b._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(p)},getCommonAncestor:function(c,b){var h=this.startContainer,d=this.endContainer,h=h[0]==d[0]?c&&h[0].nodeType==k.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new a(h[0].childNodes[this.startOffset]):h:h._4e_commonAncestor(d);return b&&h[0].nodeType==k.TEXT_NODE?h.parent():h},enlarge:function(){function c(a,b,d,e){var l=a[b?"startContainer":"endContainer"],f,i=b?0:1,g=0,j=b?"previousSibling":
"nextSibling";f=a[b?"startOffset":"endOffset"];if(l[0].nodeType==k.TEXT_NODE){if(b){if(f)return}else if(f<l[0].nodeValue.length)return;f=l[0][j];l=l[0].parentNode}else f=l[0].childNodes[f+(b?-1:1)]||null,l=l[0];for(;l;){for(;f;)if(v(f)||x(f))f=f[j];else break;if(f){if(!g)a[b?"setStartAfter":"setEndBefore"](h(f));break}l=h(l);if("body"==l.nodeName())break;if(g||l.equals(e))d[i]=l,g=1;else a[b?"setStartBefore":"setEndAfter"](l);f=l[0][j];l=l[0].parentNode}}return function(e){switch(e){case b.ENLARGE_ELEMENT:if(this.collapsed)break;
var e=this.getCommonAncestor(),l=[];c(this,1,l,e);c(this,0,l,e);l[0]&&l[1]&&(e=l[0].contains(l[1])?l[1]:l[0],this.setStartBefore(e),this.setEndAfter(e));break;case b.ENLARGE_BLOCK_CONTENTS:case b.ENLARGE_LIST_ITEM_CONTENTS:var f=new u(this.document),l=new a(this.document.body);f.setStartAt(l,b.POSITION_AFTER_START);f.setEnd(this.startContainer,this.startOffset);var f=new r(f),i,v,g=r.blockBoundary(e==b.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:d),j=function(a){var c=g(a);c||(i=h(a));return c},m=function(a){var c=
j(a);!c&&"br"==k.nodeName(a)&&(v=h(a));return c};f.guard=j;f=f.lastBackward();i=i||l;this.setStartAt(i,"br"!=i.nodeName()&&(!f&&this.checkStartOfBlock()||f&&i.contains(f))?b.POSITION_AFTER_START:b.POSITION_AFTER_END);f=this.clone();f.collapse();f.setEndAt(l,b.POSITION_BEFORE_END);f=new r(f);f.guard=e==b.ENLARGE_LIST_ITEM_CONTENTS?m:j;i=d;f=f.lastForward();i=i||l;this.setEndAt(i,!f&&this.checkEndOfBlock()||f&&i.contains(f)?b.POSITION_BEFORE_END:b.POSITION_BEFORE_START);v&&this.setEndAfter(v)}}}(),
checkStartOfBlock:function(){var a=this.startContainer,c=this.startOffset;if(c&&a[0].nodeType==k.TEXT_NODE&&g.trim(a[0].nodeValue.substring(0,c)).length)return q;this.trim();a=new m(this.startContainer);c=this.clone();c.collapse(p);c.setStartAt(a.block||a.blockLimit,b.POSITION_AFTER_START);a=new r(c);a.evaluator=i(p);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,c=this.endOffset;if(a[0].nodeType==k.TEXT_NODE&&g.trim(a[0].nodeValue.substring(c)).length)return q;this.trim();
a=new m(this.endContainer);c=this.clone();c.collapse(q);c.setEndAt(a.block||a.blockLimit,b.POSITION_BEFORE_END);a=new r(c);a.evaluator=i(q);return a.checkForward()},checkBoundaryOfElement:function(a,c){var h=this.clone();h[c==b.START?"setStartAt":"setEndAt"](a,c==b.START?b.POSITION_AFTER_START:b.POSITION_BEFORE_END);h=new r(h);h.evaluator=e;return h[c==b.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,c=this.endContainer,b=this.startOffset,d=this.endOffset,
e;if(a[0].nodeType==k.ELEMENT_NODE)if(e=a[0].childNodes.length,e>b)a=h(a[0].childNodes[b]);else if(0==e)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=h(a);a=a._4e_nextSourceNode()||a}if(c[0].nodeType==k.ELEMENT_NODE)if(e=c[0].childNodes.length,e>d)c=h(c[0].childNodes[d])._4e_previousSourceNode(p);else if(0==e)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=h(c)}a._4e_position(c)&f.POSITION_FOLLOWING&&(a=c);return{startNode:a,endNode:c}},fixBlock:function(a,
c){var d=this.createBookmark(),e=h(this.document.createElement(c));this.collapse(a);this.enlarge(b.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();E.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(d);return e},splitBlock:function(a){var c=new m(this.startContainer),h=new m(this.endContainer),e=c.block,l=h.block,f=d;if(!c.blockLimit.equals(h.blockLimit))return d;"br"!=a&&(e||(e=this.fixBlock(p,a),l=(new m(this.endContainer)).block),l||(l=this.fixBlock(q,
a)));a=e&&this.checkStartOfBlock();c=l&&this.checkEndOfBlock();this.deleteContents();e&&e[0]==l[0]&&(c?(f=new m(this.startContainer),this.moveToPosition(l,b.POSITION_AFTER_END),l=d):a?(f=new m(this.startContainer),this.moveToPosition(e,b.POSITION_BEFORE_START),e=d):(l=this.splitElement(e),!E.ie&&!g.inArray(e.nodeName(),["ul","ol"])&&e._4e_appendBogus()));return{previousBlock:e,nextBlock:l,wasStartOfBlock:a,wasEndOfBlock:c,elementPath:f}},splitElement:function(a){if(!this.collapsed)return d;this.setEndAt(a,
b.POSITION_BEFORE_END);var c=this.extractContents(),h=a.clone(q);h[0].appendChild(c);h.insertAfter(a);this.moveToPosition(a,b.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(a,c){for(var h=0;a;){if(a[0].nodeType==k.TEXT_NODE){this.moveToPosition(a,c?b.POSITION_AFTER_END:b.POSITION_BEFORE_START);h=1;break}a[0].nodeType==k.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,c?b.POSITION_BEFORE_END:b.POSITION_AFTER_START),h=1);var d=a,e=h,l=void 0;d[0].nodeType==k.ELEMENT_NODE&&
d._4e_isEditable()&&(l=d[c?"last":"first"](j));!e&&!l&&(l=d[c?"prev":"next"](j));a=l}return!!h},selectNodeContents:function(a){var c=a[0];this.setStart(a,0);this.setEnd(a,c.nodeType==k.TEXT_NODE?c.nodeValue.length:c.childNodes.length)}});s.injectDom({_4e_breakParent:function(a,c){var c=h(c),a=h(a),b,d=new t.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(c);b=d.extractContents();d.insertNode(a.remove());a.after(b)}});t.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(g){function t(c){this.document=c;this._={cache:{}};if(p){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=c||a.parentElement&&a.parentElement().ownerDocument!=c)this.isInvalid=m}}function s(c){c=new t(c);return!c||c.isInvalid?e:c}var r=g.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var m=!0,e=null,j=g.UA,i=g.DOM,o=g.Node,n=r.SELECTION,u=r.RANGE,p=j.ie,q=r.Walker,d=r.Range,b={img:1,hr:1,li:1,table:1,
tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};g.augment(t,{getNative:!p?function(){var c=this._.cache;return c.nativeSel||(c.nativeSel=i._4e_getWin(this.document).getSelection())}:function(){var c=this._.cache;return c.nativeSel||(c.nativeSel=this.document.selection)},getType:!p?function(){var c=this._.cache;if(c.type)return c.type;var a=n.SELECTION_TEXT,h=this.getNative();if(h){if(1==h.rangeCount){var h=h.getRangeAt(0),d=h.startContainer;
d==h.endContainer&&d.nodeType==i.ELEMENT_NODE&&1==Number(h.endOffset-h.startOffset)&&b[d.childNodes[h.startOffset].nodeName.toLowerCase()]&&(a=n.SELECTION_ELEMENT)}}else a=n.SELECTION_NONE;return c.type=a}:function(){var c=this._.cache;if(c.type)return c.type;var a=n.SELECTION_NONE;try{var b=this.getNative(),d=b.type;"Text"==d&&(a=n.SELECTION_TEXT);"Control"==d&&(a=n.SELECTION_ELEMENT);b.createRange().parentElement&&(a=n.SELECTION_TEXT)}catch(e){}return c.type=a},getRanges:p?function(){var c=function(a,
c){a=a.duplicate();a.collapse(c);for(var b=a.parentElement(),d=b.childNodes,f,k=0;k<d.length;k++){var g=d[k];if(g.nodeType==i.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(g);var g=f.compareEndPoints("StartToStart",a),j=f.compareEndPoints("EndToStart",a);f.collapse();if(0<g)break;else{if(!g||1==j&&-1==g)return{container:b,offset:k};if(!j)return{container:b,offset:k+1}}f=e}}f||(f=a.duplicate(),f.moveToElementText(b),f.collapse(!1));f.setEndPoint("StartToStart",a);f=(""+f.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<f;)f-=d[--k].nodeValue.length}catch(m){f=0}return 0===f?{container:b,offset:k}:{container:d[k],offset:-f}};return function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var e=this.getNative(),a=e&&e.createRange(),f=this.getType();if(!e)return[];if(f==n.SELECTION_TEXT)return e=new d(this.document),f=c(a,m),e.setStart(new o(f.container),f.offset),f=c(a),e.setEnd(new o(f.container),f.offset),b.ranges=[e];if(f==n.SELECTION_ELEMENT){b=b.ranges=[];for(f=0;f<a.length;f++){for(var i=
a.item(f),k=i.parentNode,g=0,e=new d(this.document);g<k.childNodes.length&&k.childNodes[g]!=i;g++);e.setStart(new o(k),g);e.setEnd(new o(k),g+1);b.push(e)}return b}return b.ranges=[]}}():function(c){var a=this._.cache;if(a.ranges&&!c)return a.ranges;var c=[],b=this.getNative();if(!b)return[];for(var e=0;e<b.rangeCount;e++){var f=b.getRangeAt(e),i=new d(this.document);i.setStart(new o(f.startContainer),f.startOffset);i.setEnd(new o(f.endContainer),f.endOffset);c.push(i)}return a.ranges=c},getStartElement:function(){var c=
this._.cache;if(void 0!==c.startElement)return c.startElement;var a,b=this.getNative();switch(this.getType()){case n.SELECTION_ELEMENT:return this.getSelectedElement();case n.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();m;)if(a=d.startContainer,d.startOffset==(a[0].nodeType===i.ELEMENT_NODE?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break;a=d.startContainer;if(a[0].nodeType!=i.ELEMENT_NODE)return a.parent();a=new o(a[0].childNodes[d.startOffset]);
if(!a[0]||a[0].nodeType!=i.ELEMENT_NODE)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==i.ELEMENT_NODE;)a=new o(d),d=d.firstChild;return a}if(p)d=b.createRange(),d.collapse(m),a=new o(d.parentElement());else{if((a=b.anchorNode)&&a.nodeType!=i.ELEMENT_NODE)a=a.parentNode;a&&(a=new o(a))}}return c.startElement=a},getSelectedElement:function(){var c,a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;p&&(c=this.getNative().createRange(),c=c.item&&c.item(0));if(!c){c=this.getRanges()[0];
for(var h,d,e=2;e&&(!(h=c.getEnclosedNode())||!(h[0].nodeType==i.ELEMENT_NODE&&b[h.nodeName()]&&(d=h)));e--)c.shrink(u.SHRINK_ELEMENT);c=d}return a.selectedElement=new o(c)},reset:function(){this._.cache={}},selectElement:function(c){var a,b=this.document;if(p)try{a=b.body.createControlRange(),a.addElement(c[0]),a.select()}catch(d){a=b.body.createTextRange(),a.moveToElementText(c[0]),a.select()}finally{}else a=b.createRange(),a.selectNode(c[0]),c=this.getNative(),c.removeAllRanges(),c.addRange(a);
this.reset()},selectRanges:function(c){if(p){if(1<c.length){var a=c[c.length-1];c[0].setEnd(a.endContainer,a.endOffset);c.length=1}c[0]&&c[0].select()}else{a=this.getNative();if(!a)return;a.removeAllRanges();for(var b=0;b<c.length;b++){var d=c[b],e=this.document.createRange(),f=d.startContainer;if(d.collapsed&&(j.gecko&&1.09>j.gecko||j.opera||j.webkit)&&f[0].nodeType==i.ELEMENT_NODE&&!f[0].childNodes.length)f[0].appendChild(this.document.createTextNode(j.webkit?"\u200b":"")),d.startOffset++,d.endOffset++;
e.setStart(f[0],d.startOffset);e.setEnd(d.endContainer[0],d.endOffset);a.addRange(e)}}this.reset()},createBookmarks2:function(c){for(var a=[],b=this.getRanges(),d=0;d<b.length;d++)a.push(b[d].createBookmark2(c));return a},createBookmarks:function(c,a){for(var b=[],d=this.document,e,a=a||this.getRanges(),f=a.length,k=0;k<f;k++){b.push(e=a[k].createBookmark(c,m));var j=(c=e.serializable)?g.one("#"+e.startNode,d):e.startNode;e=c?g.one("#"+e.endNode,d):e.endNode;for(var n=k+1;n<f;n++){var o=a[n],p=o.startContainer,
t=o.endContainer;i.equals(p,j.parent())&&o.startOffset++;i.equals(p,e.parent())&&o.startOffset++;i.equals(t,j.parent())&&o.endOffset++;i.equals(t,e.parent())&&o.endOffset++}}return b},selectBookmarks:function(c){for(var a=[],b=0;b<c.length;b++){var e=new d(this.document);e.moveToBookmark(c[b]);a.push(e)}this.selectRanges(a);return this},getCommonAncestor:function(){var c=this.getRanges();return c[0].startContainer._4e_commonAncestor(c[c.length-1].endContainer)},scrollIntoView:function(){var c=this.getStartElement();
c&&c.scrollIntoView(void 0,!1)},removeAllRanges:function(){var c=this.getNative();p?c&&c.clear():c&&c.removeAllRanges()}});var f={table:1,tbody:1,tr:1},k=q.whitespaces(m),E=/\ufeff|\u00a0/;d.prototype.select=d.prototype.select=!p?function(){var c=this.startContainer;this.collapsed&&c[0].nodeType==i.ELEMENT_NODE&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(c[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(b){if(0<=
b.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(m),a.setEnd(this.endContainer[0],this.endOffset);else throw b;}c=s(this.document).getNative();c.removeAllRanges();c.addRange(a)}:function(c){var a=this.collapsed,b,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==i.ELEMENT_NODE){(new t(this.document)).selectElement(new o(e));return}}(this.startContainer[0].nodeType==i.ELEMENT_NODE&&
this.startContainer.nodeName()in f||this.endContainer[0].nodeType==i.ELEMENT_NODE&&this.endContainer.nodeName()in f)&&this.shrink(u.SHRINK_ELEMENT,m);var g=this.createBookmark(),e=g.startNode,j;a||(j=g.endNode);g=this.document.body.createTextRange();g.moveToElementText(e[0]);g.moveStart("character",1);if(j)c=this.document.body.createTextRange(),c.moveToElementText(j[0]),g.setEndPoint("EndToEnd",c),g.moveEnd("character",-1);else{for(b=e[0].nextSibling;b&&!k(b);)b=b.nextSibling;b=!(b&&b.nodeValue&&
b.nodeValue.match(E))&&(c||!e[0].previousSibling||e[0].previousSibling&&"br"==i.nodeName(e[0].previousSibling));d=new o(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(e);b&&i.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(a){if(b?(g.moveStart("character",-1),g.select(),this.document.selection.clear()):g.select(),d)this.moveToPosition(d,u.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(j),j._4e_remove(),g.select()};
t.getSelection=s;return r.Selection=t},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(g,t){function s(b){function d(a,c){var b=h.body.createTextRange();try{b.moveToPoint(a,c)}catch(e){b=o}return b}function e(){var a=h.selection.createRange();l&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&l.select();u.remove(h,"mouseup",e);u.remove(h,"mousemove",i);l=c=0}function i(a){if(a.button){if(a=d(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",l)?a.setEndPoint("StartToStart",l):a.setEndPoint("EndToEnd",l),a.select()}else e()}var c,
a=b.get("iframe")[0].contentWindow,h=b.get("document")[0],l;u.on(h,"mousedown contextmenu",function(b){var g=h.documentElement;if(b.target===g&&(c&&e(),!(g.scrollHeight>g.clientHeight)&&(c=1,l=d(b.pageX,b.pageY))))u.on(h,"mouseup",e),u.on(h,"mousemove",i),a.focus(),l.select()})}function r(b){function e(c){if(h){var l=b.getSelection(),i=l&&l.getType(),g=l&&k.selection;if(c&&g&&i==d.SELECTION_NONE&&!k.queryCommandEnabled("InsertImage"))setTimeout(function(){e(j)},50);else{var m;if(!g||!g.type||!("Control"!=
g.type&&(m=g.createRange())&&(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))a=g&&l.getRanges()[0],b._monitor()}}}var k=b.get("document")[0],g=new q(k.body),c=new q(k.documentElement);if(8>t.Utils.ieEngine)c.on("click",function(a){"html"===(new q(a.target)).nodeName()&&b.getSelection().getNative().createRange().select()});var a,h,l=j;c.on("mousedown",function(){l=i});c.on("mouseup",function(){l=j});g.on("focusin",function(c){if("body"==(new q(c.target)).nodeName()&&a){try{l&&
a.select()}catch(b){}a=o}});g.on("focus",function(){h=j;e()});g.on("beforedeactivate",function(a){a.relatedTarget||(h=i,l=j)});g.on("mousedown",function(){h=i});g.on("mouseup",function(){h=j;setTimeout(function(){e(j)},0)});g.on("keydown",function(){h=i});g.on("keyup",function(){h=j;setTimeout(function(){e()},0)})}function m(b){var d=b.get("document")[0];u.on(d,"mouseup keyup",function(){b._monitor()})}function e(b){function d(a){var c=t.XHTML_DTD;return a._4e_isBlockBoundary()&&c.$empty[a.nodeName()]}
function e(c){return a(c)&&h(c)}var g=b.get("document")[0],c=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,a=t.Walker.whitespaces(j),h=t.Walker.bookmark(i,j),l=function(c){return a(c)&&8!=c.nodeType};b.on("selectionChange",function(a){var h=a.path,m=new q(b.get("document")[0].body),a=(a=a.selection)&&a.getRanges()[0],o=h.blockLimit;if(n.gecko){var r=h.block||h.blockLimit,s=r&&r.last(e);r&&r._4e_isBlockBoundary()&&
(!s||!(1==s[0].nodeType&&s._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(a&&a.collapsed&&!h.block){if("body"==o.nodeName()){if((h=a.fixBlock(j,"p"))&&h[0]!=m[0].lastChild&&h._4e_outerHtml().match(c))if((o=h.next(l))&&o[0].nodeType==p.ELEMENT_NODE&&!d[o])a.moveToElementEditablePosition(o),h._4e_remove();else if((o=h.prev(l))&&o[0].nodeType==p.ELEMENT_NODE&&!d[o])a.moveToElementEditablePosition(o,o._4e_outerHtml().match(c)?i:j),h._4e_remove();a.select();b.notifySelectionChange()}h=
new t.Range(g);h.moveToElementEditablePosition(m,j);"body"!==(new t.ElementPath(h.startContainer)).blockLimit.nodeName()&&(m=(new q(g.createElement("p"))).appendTo(m),n.ie||m._4e_appendBogus())}})}var j=!0,i=!1,o=null,n=g.UA,u=g.Event,p=g.DOM,q=g.Node,d=t.SELECTION;return{init:function(b){b.docReady(function(){n.ie?(s(b),r(b)):m(b)});e(b)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(g){function t(a){return!A.attr(a,"_ke_bookmark")}function s(a,c){for(var b in a)a.hasOwnProperty(b)&&(g.isString(a[b])?a[b]=a[b].replace(P,function(a,b){return c[b]}):s(a[b],c))}function r(a,c){c&&(a=g.clone(a),s(a,c));var b=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==b||K[b]?F.STYLE_BLOCK:L[b]?F.STYLE_OBJECT:F.STYLE_INLINE;this._={definition:a}}function m(a,c){var b=c?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new N(a),e=d.getRanges(),h=0;h<e.length;h++)b.call(this,e[h]);d.selectRanges(e)}function e(a,c,b){var d=a.element;"*"==d&&(d="span");c=new D(c.createElement(d));b&&b._4e_copyAttributes(c);b=a._.definition;a=b.attributes;b=r.getStyleText(b);if(a)for(var e in a)a.hasOwnProperty(e)&&c.attr(e,a[e]);b&&(c[0].style.cssText=b);return c}function j(a){var c=a.createBookmark(l),b=a.createIterator();b.enforceRealBlocks=l;b.enlargeBr=l;for(var d,h=a.document;d=b.getNextParagraph();){var f=e(this,h,
d),g=f,f="pre"==g.nodeName,k="pre"==d.nodeName,j=!f&&k;f&&!k?(k=d,j=k.html(),j=i(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),B.ie?(k=k[0].ownerDocument.createElement("div"),k.appendChild(g[0]),g[0].outerHTML="<pre>"+j+"</pre>",g=new D(k.firstChild),g._4e_remove()):g.html(j)):j?g=n(o(d),g):d._4e_moveChildren(g);d[0].parentNode.replaceChild(g[0],d[0]);if(f&&(d=g,f=void 0,(f=d._4e_previousSourceNode(l,
A.ELEMENT_NODE))&&"pre"==f.nodeName()))g=i(f.html(),/\n$/,"")+"\n\n"+i(d.html(),/^\n/,""),B.ie?d[0].outerHTML="<pre>"+g+"</pre>":d.html(g),f._4e_remove()}a.moveToBookmark(c)}function i(a,c,b){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,b){c&&(d=c);b&&(e=b);return""});return d+a.replace(c,b)+e}function o(a){var c=[];i(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,c,b){return c+"</pre>"+
b+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,b){c.push(b)});return c}function n(a,c){for(var b=c[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=i(e,/^[ \t]*\n/,""),e=i(e,/\n$/,""),e=i(e,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
h=c.clone();h.html(e);b.appendChild(h[0])}return b}function u(a){var c=a.document;if(a.collapsed)c=e(this,c,void 0),a.insertNode(c),a.moveToPosition(c,G.POSITION_BEFORE_END);else{var b=this.element,d=this._.definition,h,f=H[b];f||(h=l,f=H.span);var g=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var i=a.createBookmark(),k=i.startNode,i=i.endNode,j=k,m;j&&j[0];){var n=v;if(A.equals(j,i))j=x,n=l;else{var o=j[0].nodeType,p=o==A.ELEMENT_NODE?j.nodeName():x;if(p&&j.attr("_ke_bookmark")){j=
j._4e_nextSourceNode(l);continue}if(!p||f[p]&&(j._4e_position(i)|w.POSITION_PRECEDING|w.POSITION_IDENTICAL|w.POSITION_IS_CONTAINED)==w.POSITION_PRECEDING+w.POSITION_IDENTICAL+w.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(j))){var q=j.parent();if(q&&"a"==b&&q.nodeName()==b)o=e(this,c,void 0),q._4e_moveChildren(o),q[0].parentNode.replaceChild(o[0],q[0]),o._4e_mergeSiblings();else if(q&&q[0]&&((H[q.nodeName()]||H.span)[b]||h)&&(!d.parentRule||d.parentRule(q))){if(!m&&(!p||!H.$removeEmpty[p]||(j._4e_position(i)|
w.POSITION_PRECEDING|w.POSITION_IDENTICAL|w.POSITION_IS_CONTAINED)==w.POSITION_PRECEDING+w.POSITION_IDENTICAL+w.POSITION_IS_CONTAINED))m=new O(c),m.setStartBefore(j);if(o==A.TEXT_NODE||o==A.ELEMENT_NODE&&!j[0].childNodes.length){q=j;for(o=null;(n=!q.next(t))&&(o=q.parent())&&f[o.nodeName()]&&(o._4e_position(k)|w.POSITION_FOLLOWING|w.POSITION_IDENTICAL|w.POSITION_IS_CONTAINED)==w.POSITION_FOLLOWING+w.POSITION_IDENTICAL+w.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(o));)q=o;m.setEndAfter(q)}}else n=
l}else n=l;j=j._4e_nextSourceNode()}if(n&&m&&!m.collapsed){for(var n=e(this,c,void 0),q=m.getCommonAncestor(),o={},p={},r,s=null,z;n&&q&&n[0]&&q[0];){if(q.nodeName()==b){for(r in d.attributes)if(d.attributes.hasOwnProperty(r)&&!p[r]&&(z=q.attr(s)))n.attr(r)==z?n.removeAttr(r):p[r]=1;for(s in d.styles)if(d.styles.hasOwnProperty(s)&&!o[s]&&(z=q.style(s)))n.style(s)==z?n.style(s,""):o[s]=1;if(!n._4e_hasAttributes()){n=x;break}}q=q.parent()}n?(n[0].appendChild(m.extractContents()),E(this,n),m.insertNode(n),
n._4e_mergeSiblings(),B.ie||n[0].normalize()):(n=new D(c.createElement("span")),n[0].appendChild(m.extractContents()),m.insertNode(n),E(this,n),n._4e_remove(!0));m=x}}k._4e_remove();i._4e_remove();a.moveToBookmark(g);a.shrink(G.SHRINK_TEXT)}}function p(a){a.enlarge(G.ENLARGE_ELEMENT);var d=a.createBookmark(),e=d.startNode;if(a.collapsed){for(var h=new I(e.parent()),l,g=0,i;g<h.elements.length&&(i=h.elements[g])&&!(i==h.block||i==h.blockLimit);g++)if(this.checkElementRemovable(i)){var k=a.checkBoundaryOfElement(i,
G.END),j=!k&&a.checkBoundaryOfElement(i,G.START);j||k?(l=i,l.match=j?"start":"end"):(i._4e_mergeSiblings(),i.nodeName()!=this.element?(k=b(this),c(i,k[i.nodeName()]||k["*"])):f(this,i))}if(l){i=e;for(g=0;;g++){k=h.elements[g];if(A.equals(k,l))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(i[0]);i=k}i["start"==l.match?"insertBefore":"insertAfter"](l)}}else{var m=d.endNode,n=this,h=function(){for(var a=new I(e.parent()),c=new I(m.parent()),b=x,d=x,h=0;h<a.elements.length;h++){var f=
a.elements[h];if(f==a.block||f==a.blockLimit)break;n.checkElementRemovable(f)&&(b=f)}for(h=0;h<c.elements.length;h++){f=c.elements[h];if(f==c.block||f==c.blockLimit)break;n.checkElementRemovable(f)&&(d=f)}d&&m._4e_breakParent(d);b&&e._4e_breakParent(b)};h();for(l=new D(e[0].nextSibling);l[0]!==m[0];){g=l._4e_nextSourceNode();if(l[0]&&l[0].nodeType==A.ELEMENT_NODE&&this.checkElementRemovable(l)&&(l.nodeName()==this.element?f(this,l):(i=b(this),c(l,i[l.nodeName()]||i["*"])),g[0].nodeType==A.ELEMENT_NODE&&
g.contains(e)))h(),g=new D(e[0].nextSibling);l=g}}a.moveToBookmark(d)}function q(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,b,d){c[b]=d});return c}function d(a,c){var b="";c!==v?(b=document.createElement("span"),b.style.cssText=a,b=b.style.cssText||""):b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var c=a._.overrides={},b=a._.definition.overrides;
if(b){g.isArray(b)||(b=[b]);for(var d=0;d<b.length;d++){var e=b[d],h,f,l;"string"==typeof e?h=e.toLowerCase():(h=e.element?e.element.toLowerCase():a.element,f=e.attributes,l=e.styles);e=c[h]||(c[h]={});if(f){h=e.attributes=e.attributes||[];for(var i in f)f.hasOwnProperty(i)&&h.push([i.toLowerCase(),f[i]])}if(l){var e=e.styles=e.styles||[],k;for(k in l)l.hasOwnProperty(k)&&e.push([k.toLowerCase(),l[k]])}}}return c}function f(c,d){var e=c._.definition,h=b(c),f=z.mix(e.attributes,(h[d.nodeName()]||h["*"]||
{}).attributes),e=z.mix(e.styles,(h[d.nodeName()]||h["*"]||{}).styles),h=g.isEmptyObject(f)&&g.isEmptyObject(e),i;for(i in f)if(f.hasOwnProperty(i)&&!(("class"==i||c._.definition.fullMatch)&&d.attr(i)!=k(i,f[i])))h=h||!!d.hasAttr(i),d.removeAttr(i);for(var j in e)e.hasOwnProperty(j)&&!(c._.definition.fullMatch&&d.style(j)!=k(j,e[j],l))&&(h=h||!!d.style(j),d.style(j,""));a(d)}function k(a,c,b){var d=new D("<span>");d[b?"style":"attr"](a,c);return d[b?"style":"attr"](a)}function E(a,d){for(var e=b(a),
h=d.all(a.element),i=h.length;0<=--i;)f(a,new D(h[i]));for(var l in e)if(e.hasOwnProperty(l)&&l!=a.element){h=d.all(l);for(i=h.length-1;0<=i;i--){var g=new D(h[i]);c(g,e[l])}}}function c(c,b){var d,e=b&&b.attributes;if(e)for(d=0;d<e.length;d++){var h=e[d][0],f;if(f=c.attr(h)){var i=e[d][1];(i===x||i.test&&i.test(f)||"string"==typeof i&&f==i)&&c[0].removeAttribute(h)}}if(e=b&&b.styles)for(d=0;d<e.length;d++)if(h=e[d][0],i=c.css(h)){var l=e[d][1];(l===x||l.test&&l.test(f)||"string"==typeof l&&i==l)&&
c.css(h,"")}a(c)}function a(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(l);c&&(c.nodeType==A.ELEMENT_NODE&&A._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==A.ELEMENT_NODE&&A._4e_mergeSiblings(b))}}var h=g.Editor,l=!0,v=!1,x=null,z=h.Utils,A=g.DOM,F={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=h.RANGE,N=h.Selection,w=h.POSITION,O=h.Range,D=g.Node,B=g.UA,I=h.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},H=h.XHTML_DTD,L={embed:1,hr:1,img:1,
li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},M=/\s*(?:;\s*|$)/g,P=/#\((.+?)\)/g;h.STYLE=F;r.prototype={apply:function(a){m.call(this,a,v)},remove:function(a){m.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==F.STYLE_INLINE?u:this.type==F.STYLE_BLOCK?j:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==F.STYLE_INLINE?p:x).call(this,a)},checkElementRemovable:function(a,c){if(!a)return v;var e=this._.definition,h;
if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return l;var f=e._AC;if(f)e=f;else{var f={},i=0,g=e.attributes;if(g)for(var k in g)g.hasOwnProperty(k)&&(i++,f[k]=g[k]);if(g=r.getStyleText(e))f.style||i++,f.style=g;f._length=i;e=e._AC=f}if(e._length){for(var j in e)if("_length"!=j&&e.hasOwnProperty(j)){i=a.attr(j)||"";if("style"==j)a:{f=e[j];i=d(i,v);"string"==typeof f&&(f=q(f));"string"==typeof i&&(i=q(i));g=void 0;for(g in f)if(f.hasOwnProperty(g)&&!(g in i&&(i[g]==f[g]||"inherit"==
f[g]||"inherit"==i[g]))){f=v;break a}f=l}else f=e[j]==i;if(f){if(!c)return l}else if(c)return v}if(c)return l}else return l}j=b(this);if(j=j[a.nodeName()]||j["*"]){if(!(e=j.attributes)&&!(h=j.styles))return l;if(e)for(f=0;f<e.length;f++)if(j=e[f][0],j=a.attr(j))if(i=e[f][1],i===x||"string"==typeof i&&j==i||i.test&&i.test(j))return l;if(h)for(f=0;f<h.length;f++)if(j=a.css(h[f][0]))if(e=h[f][1],e===x||"string"==typeof e&&j==e||e.test&&e.test(j))return l}return v},checkActive:function(a){switch(this.type){case F.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,l);case F.STYLE_OBJECT:case F.STYLE_INLINE:for(var c=a.elements,b=0,d;b<c.length;b++)if(d=c[b],!(this.type==F.STYLE_INLINE&&(A.equals(d,a.block)||A.equals(d,a.blockLimit))))if((this.type!=F.STYLE_OBJECT||d.nodeName()in L)&&this.checkElementRemovable(d,l))return l}return v}};r.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,b=a.attributes&&a.attributes.style||"",e="";b.length&&(b=b.replace(M,";"));for(var h in c)if(c.hasOwnProperty(h)){var f=c[h],i=(h+":"+f).replace(M,
";");"inherit"==f?e+=i:b+=i}b.length&&(b=d(b));return a._ST=b+e};h.Style=r},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(g){var t=g.Node,s=g.DOM,r=g.UA,m={debugUrl:function(e){var j=g.Config;j.debug||(e=e.replace(/\.(js|css)/i,"-min.$1"));-1==e.indexOf("?t")&&(e=-1!=e.indexOf("?")?e+"&":e+"?",e+="t="+encodeURIComponent(j.tag));return j.base+"editor/"+e},lazyRun:function(e,g,i){var m=e[g],n=e[i];e[g]=function(){m.apply(this,arguments);e[g]=e[i];return n.apply(this,arguments)}},getXY:function(e,g,i,m){i=i.defaultView||i.parentWindow;e-=s.scrollLeft(i);g-=s.scrollTop(i);m&&(m=m.defaultView||
m.parentWindow,i!=m&&i.frameElement&&(m=s.offset(i.frameElement,void 0,m),e+=m.left,g+=m.top));return{left:e,top:g}},tryThese:function(e){for(var g,i=0,m=arguments.length;i<m;i++){var n=arguments[i];try{g=n();break}catch(r){}}return g},arrayCompare:function(e,g){if(!e&&!g)return!0;if(!e||!g||e.length!=g.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==g[i])return!1;return!0},clearAllMarkers:function(e){for(var g in e)e.hasOwnProperty(g)&&e[g]._4e_clearMarkers(e,!0,void 0)},ltrim:function(e){return e.replace(/^\s+/,
"")},rtrim:function(e){return e.replace(/\s+$/,"")},mix:function(e){for(var j={},i=0;i<arguments.length;i++)j=g.mix(j,arguments[i]);return j},isCustomDomain:function(){if(!r.ie)return!1;var e=document.domain,g=window.location.hostname;return e!=g&&e!="["+g+"]"},isNumber:function(e){return/^\d+(.\d+)?$/.test(g.trim(e))},verifyInputs:function(e){for(var j=0;j<e.length;j++){var i=new t(e[j]),o=g.trim(m.valInput(i)),n=i.attr("data-verify"),i=i.attr("data-warning");if(n&&!RegExp(n).test(o))return alert(i),
!1}return!0},sourceDisable:function(e,g){e.on("sourceMode",g.disable,g);e.on("wysiwygMode",g.enable,g)},resetInput:function(e){var g=e.attr("placeholder");g&&r.ie?(e.addClass("ke-input-tip"),e.val(g)):r.ie||e.val("")},valInput:function(e,g){if(void 0===g)return e.hasClass("ke-input-tip")?"":e.val();e.removeClass("ke-input-tip");e.val(g)},placeholder:function(e,j){e.attr("placeholder",j);r.ie&&(e.on("blur",function(){g.trim(e.val())||(e.addClass("ke-input-tip"),e.val(j))}),e.on("focus",function(){e.removeClass("ke-input-tip");
g.trim(e.val())==j&&e.val("")}))},htmlEncode:function(e){return!e?e:(""+e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(e){var e=g.clone(e),j;for(j in e)if(e.hasOwnProperty(j)){var i=e[j];g.isFunction(i)&&(e[j]=i())}return e},map:function(e,g){for(var i=0;i<e.length;i++)e[i]=g(e[i]);return e},ieEngine:document.documentMode||r.ie,preventFocus:function(e){r.ie?e.unselectable(void 0):e.attr("onmousedown","return false;")},injectDom:function(e){g.mix(s,
e);for(var j in e)e.hasOwnProperty(j)&&function(i){t.prototype[i]=function(){var j=[].slice.call(arguments,0);j.unshift(this[0]);return(j=e[i].apply(null,j))&&(j.nodeType||g.isWindow(j))?new t(j):g.isArray(j)&&(j.__IS_NODELIST||j[0]&&j[0].nodeType)?new t(j):j}}(j)},addRes:function(){var e=this.__res=this.__res||[];e.push.apply(e,g.makeArray(arguments))},destroyRes:function(){for(var e=this.__res||[],j=0;j<e.length;j++){var i=e[j];g.isFunction(i)?i():(i.destroy&&i.destroy(),i.remove&&i.remove())}this.__res=
[]},getQueryCmd:function(e){return"query"+("-"+e).replace(/-(\w)/g,function(e,i){return i.toUpperCase()})+"Active"}};return g.Editor.Utils=m},{requires:["./base"]});
KISSY.add("editor/core/walker",function(g,t){function s(b,d){if(this._.end)return i;var c,a=this.range,h,f=this.guard,g=this.type,m=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,a.trim(),a.collapsed))return this.end(),i;if(!b&&!this._.guardLTR){var o=a.endContainer[0],q=o.childNodes[a.endOffset];this._.guardLTR=function(a,c){return c&&(o==a||"body"==n.nodeName(a))?!1:a!=q}}if(b&&!this._.guardRTL){var r=a.startContainer[0],t=0<a.startOffset&&r.childNodes[a.startOffset-
1]||null;this._.guardRTL=function(a,c){return c&&(r==a||"body"==n.nodeName(a))?!1:a!=t}}var s=b?this._.guardRTL:this._.guardLTR;h=f?function(a,c){return s(a,c)===j?j:f(a,c)}:s;this.current?c=this.current[m](j,g,h):b?(c=a.endContainer,0<a.endOffset?(c=new p(c[0].childNodes[a.endOffset-1]),h(c)===j&&(c=i)):c=h(c,e)===j?i:c._4e_previousSourceNode(e,g,h,void 0)):(c=a.startContainer,c=new p(c[0].childNodes[a.startOffset]),c.length?h(c)===j&&(c=i):c=h(a.startContainer,e)===j?i:a.startContainer._4e_nextSourceNode(e,
g,h,void 0));for(;c&&!this._.end;){this.current=c;if(!this.evaluator||this.evaluator(c[0])!==j){if(!d)return c}else if(d&&this.evaluator)return j;c=c[m](j,g,h)}this.end();return this.current=i}function r(b){for(var d,c=i;d=s.call(this,b);)c=d;return c}function m(b){this.range=b;this._={}}var e=!0,j=!1,i=null,o=g.UA,n=g.DOM,u=t.XHTML_DTD,p=g.Node;g.augment(m,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,e)},checkForward:function(){return s.call(this,
j,e)!==j},checkBackward:function(){return s.call(this,e,e)!==j},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,e)},reset:function(){delete this.current;this._={}},_iterator:s});m.blockBoundary=function(b){return function(d){return!(d.nodeType==n.ELEMENT_NODE&&n._4e_isBlockBoundary(d,b))}};m.bookmark=function(b,d){function c(a){return"span"==n.nodeName(a)&&n.attr(a,"_ke_bookmark")}return function(a){var e,f;e=a.nodeType==n.TEXT_NODE&&(f=a.parentNode)&&c(f);e=
b?e:e||c(a);return!!(d^e)}};m.whitespaces=function(b){return function(d){d=d.nodeType==n.TEXT_NODE&&!g.trim(d.nodeValue);return!!(b^d)}};m.invisible=function(b){var d=m.whitespaces();return function(c){c=d(c)||c.nodeType==n.ELEMENT_NODE&&!c.offsetHeight;return!!(b^c)}};var q=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,d=m.whitespaces(),b=m.bookmark(),f=function(e){var f=n.nodeName(e);return b(e)||d(e)||1==e.nodeType&&f in u.$inline&&!(f in u.$empty)};t.Utils.injectDom({_4e_getBogus:function(b){b=new p(b);do b=
b._4e_previousSourceNode();while(b&&f(b[0]));return b&&(!o.ie?"br"==b.nodeName():3==b[0].nodeType&&q.test(b.text()))?b[0]:!1}});return t.Walker=m},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(g){var t=g.Editor;t.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};t.baseZIndex=function(g){return(t.Config.baseZIndex||1E4)+g}},{requires:["./base"]});
KISSY.add("editor",function(g,t,s,r){function m(c,a){var d=c.body;b(function(){c.designMode="on";setTimeout(function(){c.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=e)},50)},function(){c.designMode="off";p.attr(d,"contentEditable",i);p.attr(d,"contentEditable",e);!a&&m(c,1)})}var e=!0,j=g.all,i=!1,o=document,n=g.UA,u=n.ie,p=g.DOM,q=g.Node,d=g.Event,b=s.tryThese,f="document.open();"+(s.isCustomDomain()?'document.domain="'+o.domain+'";':"")+"document.close();",k='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(u?' src="javascript:void(function(){'+encodeURIComponent(f)+'}())"':"")+' allowTransparency="true"></iframe>';g.mix(t,{SOURCE_MODE:0,WYSIWYG_MODE:1});var E=t.WYSIWYG_MODE;g.augment(t,{createDom:function(){var c=this.get("textarea"),a;c||this.set("textarea",c=j("<textarea></textarea>"));a=this.get("el");a.addClass(this.get("prefixCls")+"editor-wrap",void 0);a.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=g.guid();var b=
a.one(".ke-textarea-wrap");this.__set("iframeWrapEl",b);this.__set("toolBarEl",a.one(".ke-editor-tools"));this.__set("statusBarEl",a.one(".ke-editor-status"));var d=this.get("width"),e=this.get("height");a.css("width",d);c.css("width","100%");c.css("display","none");b.append(c);b.css("height",e);c.css("height",e)},_uiSetHeight:function(c){var a=this.get("toolBarEl"),b=this.get("statusBarEl"),c=parseInt(c,10),c=c-((a&&a.outerHeight()||0)+(b&&b.outerHeight()||0));this.get("iframeWrapEl").css("height",
c);this.get("textarea").css("height",c)},_uiSetMode:function(c){var a=this,b,d=a.get("textarea");c?(a.execCommand("save"),a.on("docReady",b=function(){a.execCommand("save");a.detach("docReady",b)}),a._setData(d.val())):(d.val(a._getData(1,E)),d[0].focus());d[c?"hide":"show"]();a.get("iframe")[c?"show":"hide"]();a.fire((c?"wysiwyg":"source")+"Mode")},renderUI:function(){function c(){a.detach("docReady",c);if(a.get("focus"))a.focus();else{var b=a.getSelection();b&&b.removeAllRanges()}}var a=this,b=
a.get("textarea");r.register(a);a.get("attachForm")&&b[0].form&&a._attachForm();a.on("docReady",c)},_createIframe:function(c){var a=this,b=new q(k),d=a.get("textarea");d.hasAttr("tabindex")&&b.attr("tabIndex",n.webkit?-1:d.attr("tabIndex"));a.get("iframeWrapEl").prepend(b);a.set("iframe",b);a.__docReady=0;if(n.gecko&&!b.__loaded)b.on("load",function(){a._setUpIFrame(c)},a);else a._setUpIFrame(c)},destructor:function(){var c=this.get("el"),a=this.get("textarea"),b=this.get("document")[0],e=this.get("iframe")[0].contentWindow;
this.sync();t.focusManager.remove(this);d.remove([b,b.documentElement,b.body,e]);g.each(this.__dialogs,function(a){a.destroy&&a.destroy()});this.__commands=0;this.__editor_created_new||(a.insertBefore(c,void 0),a.css({width:this.get("width"),height:this.get("height")}),a.show())},_attachForm:function(){var c=this,a=c.get("textarea"),b=new q(a[0].form);b.on("submit",c.sync,c);c.on("destroy",function(){b.detach("submit",c.sync,c)})},addDialog:function(c,a){this.__dialogs[c]=a},showDialog:function(c,
a){var b=this.__dialogs[c];b.show(a);this.fire("dialogShow",{dialog:b.dialog,pluginDialog:b,dialogName:c})},hasDialog:function(c){return!!this.__dialogs[c]},addCommand:function(c,a){this.__commands[c]=a},hasCommand:function(c){return this.__commands[c]},execCommand:function(c){var a=this.__commands[c],b=g.makeArray(arguments);b.shift();b.unshift(this);if(a)return a.exec.apply(a,b)},_clearIframeDocContent:function(){if(this.get("iframe")){var c=this.get("iframe"),a=c[0].contentWindow,b=this.get("document")[0];
d.remove([b,b.documentElement,b.body,a]);c.remove()}},_getData:function(c,a){var b=this.htmlDataProcessor,d;void 0==a&&(a=this.get("mode"));d=a==E?this.get("document")[0].body.innerHTML:b.toDataFormat(this.get("textarea").val());d=c?b.toHtml(d):b.toServer(d);d=g.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(c){var a,b=c;if(this.get("mode")!=E)this.get("textarea").val(c);else{if(a=this.htmlDataProcessor)b=a.toDataFormat(c,"p");this._clearIframeDocContent();
this._createIframe(b)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},_setRawData:function(c){this.get("document")[0].body.innerHTML=c},_prepareIFrameHtml:function(c,a){var b=this.get("customStyle"),d=this.get("customLink"),e="",f=t.Utils.debugUrl("theme/editor-iframe.css");if(d)for(var g=0;g<d.length;g++)e+='<link href="'+d[g]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===o.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':
"")+"<title>${title}</title><link href='"+f+"' rel='stylesheet'/><style>"+(b||"")+"</style>"+e+"</head><body class='ke-editor'>"+(a||"&nbsp;")+(c?'<script id="ke_actscript" type="text/javascript">'+(s.isCustomDomain()?'document.domain="'+o.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+c+'");<\/script>':"")+"</body></html>"},getSelection:function(){return t.Selection.getSelection(this.get("document")[0])},focus:function(){var c=this.get("document")[0],a=p._4e_getWin(c);n.ie||a&&a.parent&&
a.parent.focus();a&&a.focus();c.body.focus();this.notifySelectionChange()},blur:function(){p._4e_getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},addCustomStyle:function(c){var a=this.get("customStyle")||"",a=a+("\n"+c);this.set("customStyle",a);p.addStyleSheet(this.get("iframe")[0].contentWindow,a)},addCustomLink:function(c){var a=this.get("customLink")||[],b=this.get("document")[0];a.push(c);this.set("customLink",a);a=b.createElement("link");a.rel="stylesheet";b.getElementsByTagName("head")[0].appendChild(a);
a.href=c},removeCustomLink:function(c){for(var a=this.get("document")[0],a=p.query("link",a),b=0;b<a.length;b++)a[b].href==c&&p.remove(a[b]);a=this.get("customLink")||[];c=g.indexOf(c,a);-1!=c&&a.splice(c,1)},_setUpIFrame:function(b){function a(){i=g.document;d.__set("document",new q(i));d.__set("window",new q(g));e.detach();i.open("text/html","replace");i.write(f);i.close()}var d=this,e=d.get("iframe"),f=d._prepareIFrameHtml(d._UUID,b),g=e[0].contentWindow,i;e.__loaded=1;try{i=g.document}catch(j){if(e[0].src=
e[0].src,7>u){setTimeout(a,10);return}}a()},docReady:function(b){this.on("docReady",b);this.__docReady&&b.call(this)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var d=a.getStartElement(),e=new t.ElementPath(d);if(!b.__previousPath||!b.__previousPath.compare(e))b.__previousPath=e,b.fire("selectionChange",{selection:a,path:e,element:d})}},100)},notifySelectionChange:function(){this.__previousPath=
null;this._monitor()},insertElement:function(b,a,d){var f=this;if(f.get("mode")===E){f.focus();var g,j=b.nodeName(),k=t.XHTML_DTD,m=t.RANGE,n=k.$block[j],o=f.getSelection(),r=o&&o.getRanges(),s,u,D,B;if(!r||0==r.length){var I=arguments,K=I.callee;setTimeout(function(){K.apply(f,I)},30)}else{f.execCommand("save");for(var H=r.length-1;0<=H;H--){s=r[H];s.deleteContents();g=!H&&b||b.clone(e);a&&a(g);if(n)for(;(D=s.getCommonAncestor(i,e))&&(B=k[D.nodeName()])&&(!B||!B[j]);)D.nodeName()in k.span?s.splitElement(D):
s.checkStartOfBlock()&&s.checkEndOfBlock()?(s.setStartBefore(D),s.collapse(e),D.remove()):s.splitBlock();s.insertNode(g);u||(u=g)}u&&(j=u._4e_nextSourceNode(e),k=f.get("document")[0],B=t.XHTML_DTD,B.$inline[g.nodeName()]?(j=new q(k.createTextNode(" ")),j.insertAfter(u)):j?"br"==j.nodeName()&&B[j.parent().nodeName()].p&&(B=new q("<p>&nbsp;</p>",null,k),j[0].parentNode.replaceChild(B[0],j[0]),j=B):(B=new q("<p>&nbsp;</p>",null,k),B.insertAfter(u),j=B),s.moveToPosition(u,m.POSITION_AFTER_END),j&&j[0].nodeType==
p.ELEMENT_NODE&&s.moveToElementEditablePosition(j),o.selectRanges([s]),f.focus(),g&&g.scrollIntoView(void 0,!1),f._saveLater(),d&&d(g))}}},insertHtml:function(b,a){var d=this,e;if(d.get("mode")===E){if(e=d.htmlDataProcessor)b=e.toDataFormat(b,null,a);d.focus();d.execCommand("save");var f=d.get("document")[0];e=0;if(u){var g=f.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(b)}catch(j){}}else try{f.execCommand("inserthtml",i,b)}catch(k){setTimeout(function(){if(0==d.getSelection().getRanges().length){var a=
new t.Range(f),e=p.first(f.body,function(a){return 1==a.nodeType&&"br"!=p.nodeName(a)});e||(e=new q(f.createElement("p")),f.body.appendChild(e[0]));a.setStartAt(e,t.RANGE.POSITION_AFTER_START);a.select()}f.execCommand("inserthtml",i,b)},e=100)}setTimeout(function(){d.getSelection().scrollIntoView()},e);d._saveLater(e)}},_saveLater:function(b){var a=this;a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)},_fixByBindIframeDoc:function(){var b=
this,a=b.get("iframe"),e=b.get("textarea")[0],a=a[0].contentWindow,f=b.get("document")[0];n.webkit&&(d.on(f,"click",function(a){var b=new q(a.target);g.inArray(b.nodeName(),["input","select"])&&a.preventDefault()}),d.on(f,"mouseup",function(a){var b=new q(a.target);g.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(n.gecko||u||n.opera){var j;j=(new q('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(e);j.on("focus",function(){b.focus()});
b.activateGecko=function(){n.gecko&&b.__iframeFocus&&j[0].focus()};b.on("destroy",function(){j.detach();j.remove()})}d.on(a,"focus",function(){n.gecko?m(f,i):n.opera&&f.body.focus();b.notifySelectionChange()});if(n.gecko)d.on(f,"mousedown",function(){b.__iframeFocus||m(f,i)});if(u&&(d.on(f,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var d=b.getSelection(),e=d.getSelectedElement();if(e){b.fire("save");var f=d.getRanges()[0].createBookmark();e.remove();d.selectBookmarks([f]);b.fire("save");a.preventDefault()}}}),
"CSS1Compat"==f.compatMode)){var k={33:1,34:1};d.on(f,"keydown",function(a){a.keyCode in k&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}if(n.webkit)d.on(f,"mousedown",function(a){a=new q(a.target);g.inArray(a.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(a)});if(n.gecko)d.on(f,"dragstart",function(a){var b=new q(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(b)}});t._initIFrame=function(b){var a=r.getInstance(b),
f=a.get("document")[0],b=f.getElementById("ke_actscript");p.remove(b);a._fixByBindIframeDoc();var g=f.body;u?(g.hideFocus=e,g.disabled=e,g.contentEditable=e,g.removeAttribute("disabled")):setTimeout(function(){n.gecko||n.opera?g.contentEditable=e:n.webkit?g.parentNode.contentEditable=e:f.designMode="on"},0);if(n.gecko||n.opera){var j=f.documentElement;d.on(j,"mousedown",function(b){if(b.target==j){n.gecko&&m(f,i);a.activateGecko()}})}setTimeout(function(){u&&setTimeout(function(){if(f){g.runtimeStyle.marginBottom=
"0px";g.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.__docReady=1;a.fire("docReady");var b=a.get("disableObjectResizing"),c=a.get("disableInlineTableEditing");if(b||c)try{f.execCommand("enableObjectResizing",i,!b);f.execCommand("enableInlineTableEditing",i,!c)}catch(e){d.on(g,u?"resizestart":"resize",function(a){var d=new q(a.target);(b||d.nodeName()==="table"&&c)&&a.preventDefault()})}},10)};return t},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
