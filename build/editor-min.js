/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 22 20:39
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(g,u,v,q){u=q.create(v.Controller,[q.Box],{initializer:function(){var g;this.__commands={};this.__dialogs={};if(g=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var s=g.next();s?this.__set("elBefore",s):this.__set("render",g.parent())}this.get("width")||this.__set("width",g.style("width")||g.css("width"));this.get("height")||this.__set("height",g.style("height")||g.css("height"))}else this.__editor_created_new=1},use:function(k,s){for(var r=
this,p=r.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],k=k.split(","),d=k.length-1;0<=d;d--)k[d]||k.splice(d,1);for(d=0;d<p.length;d++){var f=p[d];g.inArray(f,k)||k.unshift(f)}g.each(k,function(f,d){k[d]&&(k[d]="editor/plugin/"+f+"/")});g.use(k.join(","),function(){var f=g.makeArray(arguments);f.shift();for(var d=0;d<f.length;d++)f[d].init(r);s&&s.call(r)});r.__CORE_PLUGINS=[];return r}},{Config:{base:g.Config.base+"editor/"},XHTML_DTD:u.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(g){return this._setData(g)}},formatData:{getter:function(){return this._getData(1)},setter:function(g){return this._setData(g)}},prefixCls:{value:"ke-"}}},"Editor");u.DefaultRender=q.create(v.Render,[q.Box.Render],{_uiSetHeight:function(){}});g.mix(u,g.EventTarget);return KISSY.Editor=u},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(g){function u(b){this.editor=b;this._init()}function v(b){if(s.ie&&"BackCompat"!=b.get("document")[0].compatMode){var c=b.getSelection(),h;if(c.getType()==t.SELECTION_ELEMENT&&(h=c.getSelectedElement())){var a=c.getRanges()[0],e=new k(b.get("document")[0].createTextNode(""));e.insertBefore(h);a.setStartBefore(e);a.setEndAfter(h);c.selectRanges([a]);setTimeout(function(){h.parent()&&(e.remove(),c.selectElement(h))},0)}}}var q=g.Editor,k=g.Node,s=g.UA,
r=q.Range,p=q.RANGE,d=g.Event;g.augment(u,{_init:function(){var b=this.editor;d.on(b.get("document")[0].body,s.webkit?"paste":s.gecko?"paste":"beforepaste",this._paste,this);d.on(b.get("document")[0].body,"contextmenu",function(){c=1;setTimeout(function(){c=0},10)});b.addCommand("copy",new n("copy"));b.addCommand("cut",new n("cut"));b.addCommand("paste",new n("paste"))},_paste:function(){if(!c){var b=this.editor,l=b.get("document")[0];if(!l.getElementById("ke_pastebin")){var h=b.getSelection(),a=
new r(l),e=new k(s.webkit?"<body></body>":"<div></div>",null,l);e.attr("id","ke_pastebin");s.webkit&&e[0].appendChild(l.createTextNode("\u00a0"));l.body.appendChild(e[0]);e.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var j=h.createBookmarks();a.setStartAt(e,p.POSITION_AFTER_START);a.setEndAt(e,p.POSITION_BEFORE_END);a.select(!0);setTimeout(function(){e.remove();var a;e=s.webkit&&(a=e.first())&&a.hasClass("Apple-style-span")?
a:e;h.selectBookmarks(j);a=e.html();if(a=g.trim(a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var c=b.fire("paste",{html:a,holder:e});void 0!==c&&(a=c);c=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(a)&&(c=b.htmlDataProcessor.wordFilter);b.insertHtml(a,c)}},0)}}}});var f=function(b,c){var h=b.get("document")[0],a=new k(h.body),e=!1,j=function(){e=!0};a.on(c,j);(7<s.ie?h:h.selection.createRange()).execCommand(c);a.detach(c,j);return e},o=s.ie?function(b,c){return f(b,
c)}:function(b,c){try{return b.get("document")[0].execCommand(c)}catch(h){return!1}},m={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},n=function(b){this.type=b};n.prototype={exec:function(b){"cut"==this.type&&v(b);(b=o(b,this.type))||alert(m[this.type]);return b}};var t=q.Selection,b={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},c;q.on("contextmenu",function(c){var l=c.contextmenu,h=l.get("editor"),
a=l.menu.get("contentEl"),e={copy:0,cut:0,paste:0},j;for(j in e)e.hasOwnProperty(j)&&(e[j]=a.one(".ke-paste-"+j),e[j]||function(j){var c=(new k("<a href='#'class='ke-paste-"+j+"'>"+b[j]+"</a>")).appendTo(a);c.on("click",function(a){a.halt();l.hide();setTimeout(function(){h.execCommand(j)},30)});e[j]=c}(j))});return{init:function(b){b.docReady(function(){new u(b)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(g){function u(b,c){var i=b[c?"next":"prev"]();if(i&&i[0].nodeType==f.NODE_ELEMENT){for(var l=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemovable(v);)if(l.push(i),i=c?i.next():i.prev(),!i)return;if(b._4e_isIdentical(i,v)){for(var h=new r(c?b[0].lastChild:b[0].firstChild);l.length;)l.shift()._4e_move(b,!c,v);i._4e_moveChildren(b,!c,v);i.remove();h[0]&&h[0].nodeType==f.NODE_ELEMENT&&h._4e_mergeSiblings()}}}var v=v,q=g.Editor,k=g.DOM,s=g.UA,r=g.Node,p=q.Utils,
d={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};q.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var f=q.NODE,o=q.POSITION,m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},n={hr:1},t=function(b){return b&&(b[0]||b)};p.injectDom({_4e_isBlockBoundary:function(b,c){var i=g.merge(n,c);return!(!m[k.css(b,"display")]&&!i[k.nodeName(b)])},_4e_getWin:k._getWin,_4e_index:function(b,c){for(var i=b.parentNode.childNodes,l,h=-1,a=0;a<i.length;a++)if(l=i[a],!c||!(3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType))if(h++,l===b)return h;return-1},_4e_move:function(b,
c,i){c=t(c);i?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4e_isIdentical:function(b,c){if(!c)return!1;c=t(c);if(k.nodeName(b)!=k.nodeName(c))return!1;var i=b.attributes,l=c.attributes,h=i.length,a=l.length;if(h!=a)return!1;for(var e=0;e<h;e++){var j=i[e],w=j.name;if(j.specified&&k.attr(b,w)!=k.attr(c,w))return!1}if(8>p.ieEngine)for(e=0;e<a;e++)if(j=l[e],w=j.name,j.specified&&k.attr(b,w)!=k.attr(c,w))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){for(var b=b.childNodes,c=0,i=b.length;c<
i;c++){var l=b[c],h=l.nodeType;if(!(h==f.NODE_ELEMENT&&l.getAttribute("_ke_bookmark"))&&(h==f.NODE_ELEMENT&&!k._4e_isEmptyInlineRemovable(l)||h==f.NODE_TEXT&&g.trim(l.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,c,i){c=t(c);if(b!=c)if(i)for(;i=b.lastChild;)c.insertBefore(b.removeChild(i),c.firstChild);else for(;i=b.firstChild;)c.appendChild(b.removeChild(i))},_4e_mergeSiblings:function(b){b=new r(b);d[b.nodeName()]&&(u(b,!0),u(b))},_4e_splitText:function(b,c){var i=b.ownerDocument;if(b.nodeType==
f.NODE_TEXT){if(s.ie&&c==b.nodeValue.length){var l=i.createTextNode("");k.insertAfter(l,b);return l}l=b.splitText(c);i.documentMode&&(i=i.createTextNode(""),k.insertAfter(i,l),k.remove(i));return l}},_4e_parents:function(b,c){var i=[];i.__IS_NODELIST=1;do i[c?"push":"unshift"](b);while(b=b.parentNode);return i},_4e_nextSourceNode:function(b,c,i,l){if(l&&!l.call)var h=t(l),l=function(a){return a!==h};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType==f.NODE_ELEMENT&&l&&!1===l(b,!0))return null;c=b.nextSibling}for(;!c&&
(a=a.parentNode);){if(l&&!1===l(a,!0))return null;c=a.nextSibling}return!c||l&&!1===l(c)?null:i&&i!=c.nodeType?k._4e_nextSourceNode(c,!1,i,l):c},_4e_previousSourceNode:function(b,c,i,l){if(l&&!l.call)var h=t(l),l=function(a){return a!==h};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType==f.NODE_ELEMENT&&l&&!1===l(b,!0))return null;c=b.previousSibling}for(;!c&&(a=a.parentNode);){if(l&&!1===l(a,!0))return null;c=a.previousSibling}return!c||l&&!1===l(c)?null:i&&c.nodeType!=i?k._4e_previousSourceNode(c,
!1,i,l):c},_4e_commonAncestor:function(b,c){c=t(c);if(b===c)return b;if(k.contains(c,b))return c;var i=b;do if(k.contains(i,c))return i;while(i=i.parentNode);return null},_4e_hasAttributes:9>p.ieEngine?function(b){for(var c=b.attributes,i=0;i<c.length;i++){var l=c[i];switch(l.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(l.specified)return!0}}return!1}:function(b){s.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4e_position:function(b,c){var i=t(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(i);
if(b==i)return o.POSITION_IDENTICAL;if(b.nodeType==f.NODE_ELEMENT&&i.nodeType==f.NODE_ELEMENT){if(k.contains(b,i))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(k.contains(i,b))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>i.sourceIndex?o.POSITION_DISCONNECTED:b.sourceIndex<i.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var l=k._4e_address(b),i=k._4e_address(i),h=Math.min(l.length,i.length),a=0;a<=h-1;a++)if(l[a]!=i[a])return l[a]<
i[a]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return l.length<i.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(b,c){for(var i=[],l=b.ownerDocument.documentElement,h=b;h&&h!=l;)i.unshift(k._4e_index(h,c)),h=h.parentNode;return i},_4e_remove:function(b,c){var i=b.parentNode;if(i){if(c)for(var l;l=b.firstChild;)i.insertBefore(b.removeChild(l),b);i.removeChild(b)}return b},_4e_trim:function(b){k._4e_ltrim(b);k._4e_rtrim(b)},_4e_ltrim:function(b){for(var c;c=
b.firstChild;){if(c.nodeType==f.NODE_TEXT){var i=p.ltrim(c.nodeValue),l=c.nodeValue.length;if(i)i.length<l&&(k._4e_splitText(c,l-i.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){for(var c;c=b.lastChild;){if(c.type==f.NODE_TEXT){var i=p.rtrim(c.nodeValue),l=c.nodeValue.length;if(i)i.length<l&&(k._4e_splitText(c,i.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!s.ie&&!s.opera&&(c=b.lastChild)&&1==c.nodeType&&"br"==k.nodeName(c)&&
b.removeChild(c)},_4e_appendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType==f.NODE_TEXT&&!g.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==f.NODE_TEXT||"br"!==k.nodeName(c))c=s.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),s.gecko&&c.setAttribute("type","_moz"),b.appendChild(c)},_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");c.appendChild(b.cloneNode(!0));return c.innerHTML},
_4e_setMarker:function(b,c,i,l){var b=new r(b),h=b.data("list_marker_id")||b.data("list_marker_id",g.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[h]=b;a[i]=1;return b.data(i,l)},_4e_clearMarkers:function(b,c,i){var b=new r(b),l=b.data("list_marker_names"),h=b.data("list_marker_id"),a;for(a in l)l.hasOwnProperty(a)&&b.removeData(a);b.removeData("list_marker_names");i&&(b.removeData("list_marker_id"),delete c[h])},_4e_copyAttributes:function(b,
c,i){for(var c=new r(c),l=b.attributes,i=i||{},h=0;h<l.length;h++){var a=l[h],e=a.name.toLowerCase(),j;if(!(e in i))if("checked"==e&&(j=k.attr(b,e)))c.attr(e,j);else if(a.specified||s.ie&&a.value&&"value"==e)j=k.attr(b,e),null===j&&(j=a.nodeValue),c.attr(e,j)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){var b=k.nodeName(b),c=q.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(g){function u(b){1>arguments.length||(this.range=b,this.forceBrBreak=q,this.enlargeBr=v,this.enforceRealBlocks=q,this._||(this._={}))}var v=!0,q=!1,k=g.Editor,s=g.UA,r=k.Walker,p=k.Range,d=k.RANGE,f=k.NODE,o=k.ElementPath,m=g.Node,n=g.DOM,t=/^[\r\n\t ]*$/;g.augment(u,{getNextParagraph:function(b){var c,i,l,h,a;if(!this._.lastNode){i=this.range.clone();i.shrink(d.SHRINK_ELEMENT,v);i.enlarge(this.forceBrBreak||!this.enlargeBr?d.ENLARGE_LIST_ITEM_CONTENTS:
d.ENLARGE_BLOCK_CONTENTS);var e=new r(i),j=r.bookmark(v,v);e.evaluator=j;this._.nextNode=e.next();e=new r(i);e.evaluator=j;e=e.previous();this._.lastNode=e._4e_nextSourceNode(v);this._.lastNode&&this._.lastNode[0].nodeType==f.NODE_TEXT&&!g.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new p(i.document),j.moveToPosition(this._.lastNode,d.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new o(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(v)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new m(i.document.createTextNode("")),n.insertAfter(this._.lastNode[0],e[0]));i=null}j=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;j;){var w=q,x=j[0].nodeType!=f.NODE_ELEMENT,y=q;if(x)j[0].nodeType==f.NODE_TEXT&&t.test(j[0].nodeValue)&&(x=q);else{var k=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==k)x=v;else if(!i&&!j[0].childNodes.length&&"hr"!=k){c=j;l=j.equals(e);break}i&&(i.setEndAt(j,d.POSITION_BEFORE_START),
"br"!=k&&(this._.nextNode=j));w=v}else{if(j[0].firstChild){i||(i=new p(this.range.document),i.setStartAt(j,d.POSITION_BEFORE_START));j=new m(j[0].firstChild);continue}x=v}}x&&!i&&(i=new p(this.range.document),i.setStartAt(j,d.POSITION_BEFORE_START));l=(!w||x)&&j.equals(e);if(i&&!w)for(;!j[0].nextSibling&&!l;){k=j.parent();if(k._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){w=v;l||k.equals(e);break}j=k;x=v;l=j.equals(e);y=v}x&&i.setEndAt(j,d.POSITION_AFTER_END);j=j._4e_nextSourceNode(y,null,e);if((l=
!j)||w&&i)break}if(!c){if(!i)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new o(i.startContainer);j=c.blockLimit;w={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&w[j.nodeName()]&&i.checkStartOfBlock()&&i.checkEndOfBlock())c=j;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new m(this.range.document.createElement(b||"p")),c[0].appendChild(i.extractContents()),c._4e_trim(),i.insertNode(c),h=a=v;else if("li"!=c.nodeName()){if(!i.checkStartOfBlock()||
!i.checkEndOfBlock())c=c.clone(q),c[0].appendChild(i.extractContents()),c._4e_trim(),a=i.splitBlock(),h=!a.wasStartOfBlock,a=!a.wasEndOfBlock,i.insertNode(c)}else l||(this._.nextNode=c.equals(e)?null:i.getBoundaryNodes().endNode._4e_nextSourceNode(v,null,e))}h&&(i=new m(c[0].previousSibling),i[0]&&i[0].nodeType==f.NODE_ELEMENT&&("br"==i.nodeName()?i._4e_remove():i[0].lastChild&&"br"==n.nodeName(i[0].lastChild)&&n._4e_remove(i[0].lastChild)));a&&(i=r.bookmark(q,v),h=new m(c[0].lastChild),h[0]&&h[0].nodeType==
f.NODE_ELEMENT&&"br"==h.nodeName()&&(s.ie||h.prev(i)||h.next(i))&&h.remove());this._.nextNode||(this._.nextNode=l||c.equals(e)?null:c._4e_nextSourceNode(v,null,e));return c}});p.prototype.createIterator=function(){return new u(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(g){function u(f){for(var g=r,m=r,n=[];f;){if(f[0].nodeType==s.NODE_ELEMENT){this.lastElement||(this.lastElement=f);var t=f.nodeName();if(!m&&(!g&&p[t]&&(g=f),d[t])){var b;if(b=!g)if(b="div"==t){a:{b=f[0].childNodes;for(var c=0,i=b.length;c<i;c++){var l=b[c];if(l.nodeType==s.NODE_ELEMENT&&k.$block[l.nodeName.toLowerCase()]){b=!0;break a}}b=!1}b=!b}b?g=f:m=f}n.push(f);if("body"==t)break}f=f.parent()}this.block=g;this.blockLimit=m;this.elements=n}var v=g.Editor,
q=g.DOM,k=v.XHTML_DTD,s=v.NODE,r=null,p={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},d={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};u.prototype={compare:function(f){var d=this.elements,f=f&&f.elements;if(!f||d.length!=f.length)return!1;for(var m=0;m<d.length;m++)if(!q.equals(d[m],f[m]))return!1;return!0},contains:function(d){for(var g=this.elements,m=0;m<g.length;m++)if(g[m].nodeName()in d)return g[m];return r},toString:function(){var d=this.elements,
g,m=[];for(g=0;g<d.length;g++)m.push(d[g].nodeName());return m.toString()}};return v.ElementPath=u},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(g){function u(d){var n;n=d.getSelection().getRanges();for(var t=n.length-1;0<t;t--)n[t].deleteContents();n=n[0];t=n.document;if(n.checkStartOfBlock()&&n.checkEndOfBlock()){var b=(new o(n.startContainer)).block;if(b&&("li"==b.nodeName()||"li"==b.parent().nodeName()))return d.hasCommand("outdent")?(d.execCommand("save"),d.execCommand("outdent"),d.execCommand("save"),!0):!1}var c=n.splitBlock("p");if(!c)return!0;var d=c.previousBlock,b=c.nextBlock,i=
c.wasStartOfBlock,l=c.wasEndOfBlock,h;if(b)h=b.parent(),"li"==h.nodeName()&&(b._4e_breakParent(h),b._4e_move(b.next(),!0));else if(d&&(h=d.parent())&&"li"==h.nodeName())d._4e_breakParent(h),n.moveToElementEditablePosition(d.next()),d._4e_move(d.prev());if(!i&&!l){if("li"==b.nodeName()&&(h=b.first(f.invisible(!0)))&&g.inArray(h.nodeName(),["ul","ol"]))(k.ie?new p(t.createTextNode("\u00a0")):new p(t.createElement("br"))).insertBefore(h);b&&n.moveToElementEditablePosition(b)}else{var a;if(d){if("li"==d.nodeName()||
!s.test(d.nodeName()))a=d.clone()}else b&&(a=b.clone());a||(a=new p("<p>",null,t));if(h=c.elementPath)for(var c=0,e=h.elements.length;c<e;c++){var j=h.elements[c];if(j.equals(h.block)||j.equals(h.blockLimit))break;r.$removeEmpty[j.nodeName()]&&(j=j.clone(),a._4e_moveChildren(j),a.append(j))}k.ie||a._4e_appendBogus();n.insertNode(a);if(k.ie&&i&&(!l||!d[0].childNodes.length))n.moveToElementEditablePosition(l?d:a),n.select();n.moveToElementEditablePosition(i&&!l?b:a)}k.ie||(b?(a=new p(t.createElement("span")),
a.html("&nbsp;"),n.insertNode(a),a.scrollIntoView(void 0,!1),n.deleteContents()):a.scrollIntoView(void 0,!1));n.select();return!0}function v(f){var g=f.get("document")[0];d.on(g,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){f.execCommand("save");var b=f.execCommand("enterBlock");f.execCommand("save");!1!==b&&d.preventDefault()}})}var q=g.Editor,k=g.UA,s=/^h[1-6]$/,r=q.XHTML_DTD,p=g.Node,d=g.Event,f=q.Walker,o=q.ElementPath;return{init:function(d){d.addCommand("enterBlock",
{exec:u});d.docReady(function(){v(d)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(g){function u(){var g=this;g.__iframeFocus=f;d=g;p&&clearTimeout(p);p=setTimeout(function(){g.fire("focus")},100)}function v(){var f=this;f.__iframeFocus=o;d=m;p&&clearTimeout(p);p=setTimeout(function(){f.fire("blur")},100)}var q=g.Editor,k=g.DOM,s=g.Event,r={},p,d,g={refreshAll:function(){for(var d in r)if(r.hasOwnProperty(d)){var f=r[d].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return d},getInstance:function(d){return r[d]},
add:function(d){var f=k._4e_getWin(d.get("document")[0]);s.on(f,"focus",u,d);s.on(f,"blur",v,d)},register:function(d){r[d._UUID]=d},remove:function(d){delete r[d._UUID];var f=k._4e_getWin(d.get("document")[0]);s.remove(f,"focus",u,d);s.remove(f,"blur",v,d)}},f=!0,o=!1,m=null;g.refreshAll=g.refreshAll;q.focusManager=g;q.getInstances=function(){return r};return g},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(g){return{init:function(u){function v(c){return c.replace(t,function(c,h,a){return"<"+h+a.replace(b,function(e,b){return-1==a.indexOf("_ke_saved_"+b)?" _ke_saved_"+e+" "+e:e})+">"})}function q(b){return b.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(b){return"<\!--"+c+"{C}"+encodeURIComponent(b).replace(/--/g,"%2D%2D")+"--\>"})}function k(b){return b.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(b,c){return decodeURIComponent(c)})}
var s=s,r=g.Editor,p=g.Node,d=g.UA,f=g.require("htmlparser"),o=new f.Filter,m=new f.Filter,n=new f.Filter;(function(){var b=function(a,e){return function(b,c){var h=[];(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,j,d){j=j.toLowerCase();"font-family"==j&&(d=d.replace(/["']/g,""));for(var f,z,A,i=0;i<a.length;i++)if(a[i]&&(b=a[i][0],f=a[i][1],z=a[i][2],A=a[i][3],j.match(b)&&(!f||d.match(f)))){j=A||j;e&&(z=z||d);"function"==typeof z&&(z=z(d,c,j));z&&z.push&&
(j=z[0],z=z[1]);"string"==typeof z&&h.push([j,z]);return}!e&&h.push([j,d])});for(var d=0;d<h.length;d++)h[d]=h[d].join(":");return h.length?h.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],s),l={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var e=a.nodeName||"";if(-1!=e.indexOf(":")&&
!/^ke/.test(e))if("v:imagedata"==e){if(e=a.getAttribute("o:href"))a.setAttribute("src",e),a.removeAttribute("o:href");if(e=a.getAttribute("o:title"))a.setAttribute("title",e),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=b(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},h={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var e=
["name","href","src"],b,c=0;c<e.length;c++)b="_ke_saved_"+e[c],a.getAttribute(b)&&a.removeAttribute(e[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var j=b.getAttribute("width"),b=b.getAttribute("height");j&&a.setAttribute("width",j);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!g.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,c.length)==c?(a="{C}"==a.substr(c.length,3)?a.substr(c.length+3):a.substr(c.length),new f.CData(decodeURIComponent(a))):a}};d.ie&&(h.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});o.addRules(h);m.addRules(l);n.addRules(l)})();(function(){function b(a){for(var a=a.childNodes,e=a.length,j=a[e-1];j&&3==j.nodeType&&!g.trim(j.nodeValue);)j=a[--e];return j}
function c(a,e){var h=b(a);h&&((e||!d.ie)&&1==h.nodeType&&"br"==h.nodeName?a.removeChild(h):3==h.nodeType&&j.test(h.nodeValue)&&a.removeChild(h))}function h(a){var e=b(a);return!e||1==e.nodeType&&"br"==e.nodeName||"form"==a.nodeName&&"input"==e.nodeName}function a(a){c(a,!0);h(a)&&(d.ie?a.appendChild(new f.Text("\u00a0")):(a.appendChild(new f.Text("&nbsp;")),a.appendChild(new f.Tag("br"))))}function e(a){c(a,!1);h(a)&&a.appendChild(new f.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=r.XHTML_DTD,x=r.Utils.mix({},
w.$block,w.$listItem,w.$tableContent),k;for(k in x)x.hasOwnProperty(k)&&("br"in w[k]||delete x[k]);delete x.td;delete x.pre;var w={tags:{}},s={tags:{}};for(k in x)x.hasOwnProperty(k)&&(w.tags[k]=a,s.tags[k]=e);m.addRules(w);o.addRules(s);n.addRules(w)})();(function(){o.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}})})();var t=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}";u.htmlDataProcessor={wordFilter:n,
dataFilter:m,htmlFilter:o,toHtml:function(b){var c=new f.BeautifyWriter;(new f.Parser(b)).parse().writeHtml(c,o);return c.getHtml()},toDataFormat:function(b,c,h){h=h||m;d.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=v(b);c=new p("<div>");c.html("a"+b);b=c.html().substr(1);b=k(b);c=new f.BeautifyWriter;(new f.Parser(b)).parse().writeHtml(c,h);b=c.getHtml();return b=q(b)},toServer:function(b){var c=new f.MinifyWriter;(new f.Parser(b)).parse().writeHtml(c,
o);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(g,u,v,q,k){function s(a){var j=a.nodeType!=b.NODE_TEXT&&l.nodeName(a)in e.$removeEmpty,c=a.nodeType==b.NODE_TEXT&&!g.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return j||c||a}function r(a){return!y(a)&&!F(a)}function p(e){var j=n;return function(c){if(F(c))return m;if(c.nodeType==b.NODE_TEXT){if(g.trim(c.nodeValue).length)return n}else if(c.nodeType==b.NODE_ELEMENT&&(c=l.nodeName(c),!M[c]))if(!e&&!a.ie&&"br"==c&&!j)j=m;else return n;return m}}
function d(a,e){var c=a.startContainer,h=a.endContainer,d=a.startOffset,f=a.endOffset,w,i=n,g=n,x=void 0,k=a.document,Q;if(a.collapsed)return x;0<e&&(x=k.createDocumentFragment());a.optimizeBookmark();h[0].nodeType==b.NODE_TEXT?(g=m,h=h._4e_splitText(f)):0<h[0].childNodes.length&&(f>=h[0].childNodes.length?(h=new j(h[0].appendChild(k.createTextNode(""))),Q=m):h=new j(h[0].childNodes[f]));c[0].nodeType==b.NODE_TEXT?(i=m,c._4e_splitText(d)):d?d>=c[0].childNodes.length?(c=new j(c[0].appendChild(k.createTextNode(""))),
w=m):c=new j(c[0].childNodes[d].previousSibling):(w=new j(k.createTextNode("")),c.prepend(w),c=w,w=m);var o=c._4e_parents(),K=h._4e_parents();o.each(function(a,b){o[b]=a});K.each(function(a,b){K[b]=a});for(var C,L,k=0;k<o.length&&!(C=o[k],L=K[k],!C.equals(L));k++);for(var d=x,y,I,s=k;s<o.length;s++){y=o[s];f=0<e&&!y.equals(c)?d.appendChild(y.clone()[0]):null;y=y[0].nextSibling;I=K[s];for(var r=h[0],p=I&&I[0];y&&!(p==y||r==y);)I=y.nextSibling,2==e?d.appendChild(y.cloneNode(m)):(l._4e_remove(y),1==
e&&d.appendChild(y)),y=I;f&&(d=f)}for(d=x;k<K.length;k++){y=K[k];f=0<e&&!y.equals(h)?d.appendChild(y.clone()[0]):null;if(!o[k]||y[0].parentNode!=o[k][0].parentNode)for(y=y[0].previousSibling;y;)I=y.previousSibling,2==e?d.insertBefore(y.cloneNode(m),d.firstChild):(l._4e_remove(y),1==e&&d.insertBefore(y,d.firstChild)),y=I;f&&(d=f)}if(2==e){if(i&&(C=c[0],C.nodeType==b.NODE_TEXT&&C.nextSibling&&C.nextSibling.nodeType==b.NODE_TEXT&&(C.data+=C.nextSibling.data,C.parentNode.removeChild(C.nextSibling))),
g)g=h[0],g.nodeType==b.NODE_TEXT&&g.previousSibling&&g.previousSibling.nodeType==b.NODE_TEXT&&(g.previousSibling.data+=g.data,g.parentNode.removeChild(g))}else{if(C&&L&&(!c.parent().equals(C.parent())||!h.parent().equals(L.parent())))g=C._4e_index(),w&&C.parent().equals(c.parent())&&g--,a.setStart(C.parent(),g+1);a.collapse(m)}w&&c.remove();Q&&h.remove();return x}function f(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function o(a){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=t;this.collapsed=m;this.document=a}u.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var m=!0,n=!1,t=null,b=u.NODE,c=u.RANGE,i=u.POSITION,l=g.DOM,h=v.getByAddress,a=g.UA,e=u.XHTML_DTD,j=g.Node,w=j.all,x={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},y=new q.whitespaces,
F=new q.bookmark,E=q.whitespaces(m),H=q.bookmark(!1,!0),M={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};g.augment(o,{toString:function(){var a=[],b=this.startContainer[0],e=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((e.id||e.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,e=this.startOffset;
a[0].nodeType!=b.NODE_ELEMENT&&(e?e>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;e=this.endOffset;a[0].nodeType!=b.NODE_ELEMENT&&(e?e>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},
optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,e){a[0].nodeType==b.NODE_ELEMENT&&x[a.nodeName()]&&(a=a.parent(),e=a._4e_index());this.startContainer=a;this.startOffset=e;this.endContainer||(this.endContainer=a,this.endOffset=e);f(this)},setEnd:function(a,e){a[0].nodeType==b.NODE_ELEMENT&&x[a.nodeName()]&&(a=a.parent(),
e=a._4e_index()+1);this.endContainer=a;this.endOffset=e;this.startContainer||(this.startContainer=a,this.startOffset=e);f(this)},setStartAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}f(this)},setEndAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setEnd(a,
0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}f(this)},cloneContents:function(){return d(this,2)},deleteContents:function(){return d(this,0)},extractContents:function(){return d(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=
this.endContainer,this.startOffset=this.endOffset);this.collapsed=m},clone:function(){var a=new o(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=b.NODE_ELEMENT||a.endContainer[0].nodeType!=b.NODE_ELEMENT)return t;var e=new q(a);e.evaluator=function(a){return E(a)&&H(a)};a=e.next();
e.reset();e=e.previous();return a&&a.equals(e)?a:t},shrink:function(a,e){if(!this.collapsed){var a=a||c.SHRINK_TEXT,j=this.clone(),h=this.startContainer,d=this.endContainer,f=this.startOffset,w=this.endOffset,i=m,g,l,x=m;h&&h[0].nodeType==b.NODE_TEXT&&(f?f>=h[0].nodeValue.length?j.setStartAfter(h):(j.setStartBefore(h),i=n):j.setStartBefore(h));d&&d[0].nodeType==b.NODE_TEXT&&(w?w>=d[0].nodeValue.length?j.setEndAfter(d):(j.setEndAfter(d),x=n):j.setEndBefore(d));if(i||x)l=new q(j),l.evaluator=function(e){return e.nodeType==
(a==c.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)},l.guard=function(e,j){e=e[0]||e;if(a==c.SHRINK_ELEMENT&&e.nodeType==b.NODE_TEXT||j&&e==g)return n;!j&&e.nodeType==b.NODE_ELEMENT&&(g=e);return m};i&&(j=l[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(j,e?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);x&&(l.reset(),(l=l[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(l,e?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return i||x}},createBookmark2:function(a){var e=this.startContainer,
c=this.endContainer,h=this.startOffset,d=this.endOffset,f,w;if(!e||!c)return{start:0,end:0};if(a){if(e[0].nodeType==b.NODE_ELEMENT&&(f=new j(e[0].childNodes[h]))&&f[0]&&f[0].nodeType==b.NODE_TEXT&&0<h&&f[0].previousSibling.nodeType==b.NODE_TEXT)e=f,h=0;for(;e[0].nodeType==b.NODE_TEXT&&(w=e.prev())&&w[0].nodeType==b.NODE_TEXT;)e=w,h+=w[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==b.NODE_ELEMENT&&(f=new j(c[0].childNodes[d]))&&f[0]&&f[0].nodeType==b.NODE_TEXT&&0<d&&f[0].previousSibling.nodeType==
b.NODE_TEXT)c=f,d=0;for(;c[0].nodeType==b.NODE_TEXT&&(w=c.prev())&&w[0].nodeType==b.NODE_TEXT;)c=w,d+=w[0].nodeValue.length}}return{start:e._4e_address(a),end:this.collapsed?t:c._4e_address(a),startOffset:h,endOffset:d,normalized:a,is2:m}},createBookmark:function(a){var e,b,h,d,f=this.collapsed;e=new j("<span>",t,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");a&&(h=g.guid("ke_bm_"),e.attr("id",h+"S"));f||(b=e.clone(),b.html("&nbsp;"),a&&b.attr("id",h+"E"),d=this.clone(),
d.collapse(),d.insertNode(b));d=this.clone();d.collapse(m);d.insertNode(e);b?(this.setStartAfter(e),this.setEndBefore(b)):this.moveToPosition(e,c.POSITION_AFTER_END);return{startNode:a?h+"S":e,endNode:a?h+"E":b,serializable:a,collapsed:f}},moveToPosition:function(a,e){this.setStartAt(a,e);this.collapse(m)},trim:function(a,e){var c=this.startContainer,j=this.startOffset,h=this.collapsed;if((!a||h)&&c[0]&&c[0].nodeType==b.NODE_TEXT){if(j)if(j>=c[0].nodeValue.length)j=c._4e_index()+1,c=c.parent();else{var d=
c._4e_splitText(j),j=c._4e_index()+1,c=c.parent();l.equals(this.startContainer,this.endContainer)?this.setEnd(d,this.endOffset-this.startOffset):l.equals(c,this.endContainer)&&(this.endOffset+=1)}else j=c._4e_index(),c=c.parent();this.setStart(c,j);if(h){this.collapse(m);return}}c=this.endContainer;j=this.endOffset;!e&&!h&&c[0]&&c[0].nodeType==b.NODE_TEXT&&(j?(j>=c[0].nodeValue.length||c._4e_splitText(j),j=c._4e_index()+1):j=c._4e_index(),c=c.parent(),this.setEnd(c,j))},insertNode:function(a){this.optimizeBookmark();
this.trim(n,m);var e=this.startContainer;e[0].insertBefore(a[0],e[0].childNodes[this.startOffset]||null);e[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var e=this.document;if(a.is2){var b=h(e,a.start,a.normalized),c=a.startOffset,e=a.end&&h(e,a.end,a.normalized),a=a.endOffset;this.setStart(b,c);e?this.setEnd(e,a):this.collapse(m)}else b=(c=a.serializable)?g.one("#"+a.startNode,e):a.startNode,a=c?g.one("#"+a.endNode,e):a.endNode,this.setStartBefore(b),
b._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(m)},getCommonAncestor:function(a,e){var c=this.startContainer,h=this.endContainer,c=c[0]==h[0]?a&&c[0].nodeType==b.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new j(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(h);return e&&c[0].nodeType==b.NODE_TEXT?c.parent():c},enlarge:function(){function a(e,b,c,j){var h=e[b?"startContainer":"endContainer"],d,f=b?0:1,i=0,g=b?"previousSibling":"nextSibling";d=e[b?"startOffset":
"endOffset"];if(h[0].nodeType==l.TEXT_NODE){if(b){if(d)return}else if(d<h[0].nodeValue.length)return;d=h[0][g];h=h[0].parentNode}else d=h[0].childNodes[d+(b?-1:1)]||null,h=h[0];for(;h;){for(;d;)if(y(d)||F(d))d=d[g];else break;if(d){if(!i)e[b?"setStartAfter":"setEndBefore"](w(d));break}h=w(h);if("body"==h.nodeName())break;if(i||h.equals(j))c[f]=h,i=1;else e[b?"setStartBefore":"setEndAfter"](h);d=h[0][g];h=h[0].parentNode}}return function(e){switch(e){case c.ENLARGE_ELEMENT:if(this.collapsed)break;
var e=this.getCommonAncestor(),b=[];a(this,1,b,e);a(this,0,b,e);b[0]&&b[1]&&(e=b[0].contains(b[1])?b[1]:b[0],this.setStartBefore(e),this.setEndAfter(e));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var h=new o(this.document),b=new j(this.document.body);h.setStartAt(b,c.POSITION_AFTER_START);h.setEnd(this.startContainer,this.startOffset);var h=new q(h),d,f,i=q.blockBoundary(e==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:t),g=function(a){var e=i(a);e||(d=w(a));return e},x=function(a){var e=
g(a);!e&&"br"==l.nodeName(a)&&(f=w(a));return e};h.guard=g;h=h.lastBackward();d=d||b;this.setStartAt(d,"br"!=d.nodeName()&&(!h&&this.checkStartOfBlock()||h&&d.contains(h))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);h=this.clone();h.collapse();h.setEndAt(b,c.POSITION_BEFORE_END);h=new q(h);h.guard=e==c.ENLARGE_LIST_ITEM_CONTENTS?x:g;d=t;h=h.lastForward();d=d||b;this.setEndAt(d,!h&&this.checkEndOfBlock()||h&&d.contains(h)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);f&&this.setEndAfter(f)}}}(),
checkStartOfBlock:function(){var a=this.startContainer,e=this.startOffset;if(e&&a[0].nodeType==b.NODE_TEXT&&g.trim(a[0].nodeValue.substring(0,e)).length)return n;this.trim();a=new k(this.startContainer);e=this.clone();e.collapse(m);e.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new q(e);a.evaluator=p(m);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,e=this.endOffset;if(a[0].nodeType==b.NODE_TEXT&&g.trim(a[0].nodeValue.substring(e)).length)return n;this.trim();
a=new k(this.endContainer);e=this.clone();e.collapse(n);e.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new q(e);a.evaluator=p(n);return a.checkForward()},checkBoundaryOfElement:function(a,e){var b=this.clone();b[e==c.START?"setStartAt":"setEndAt"](a,e==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);b=new q(b);b.evaluator=s;return b[e==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,e=this.endContainer,c=this.startOffset,h=this.endOffset,
j;if(a[0].nodeType==b.NODE_ELEMENT)if(j=a[0].childNodes.length,j>c)a=w(a[0].childNodes[c]);else if(0==j)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=w(a);a=a._4e_nextSourceNode()||a}if(e[0].nodeType==b.NODE_ELEMENT)if(j=e[0].childNodes.length,j>h)e=w(e[0].childNodes[h])._4e_previousSourceNode(m);else if(0==j)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=w(e)}a._4e_position(e)&i.POSITION_FOLLOWING&&(a=e);return{startNode:a,endNode:e}},fixBlock:function(e,
b){var h=this.createBookmark(),j=w(this.document.createElement(b));this.collapse(e);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);j[0].appendChild(this.extractContents());j._4e_trim();a.ie||j._4e_appendBogus();this.insertNode(j);this.moveToBookmark(h);return j},splitBlock:function(e){var b=new k(this.startContainer),h=new k(this.endContainer),j=b.block,d=h.block,f=t;if(!b.blockLimit.equals(h.blockLimit))return t;"br"!=e&&(j||(j=this.fixBlock(m,e),d=(new k(this.endContainer)).block),d||(d=this.fixBlock(n,
e)));e=j&&this.checkStartOfBlock();b=d&&this.checkEndOfBlock();this.deleteContents();j&&j[0]==d[0]&&(b?(f=new k(this.startContainer),this.moveToPosition(d,c.POSITION_AFTER_END),d=t):e?(f=new k(this.startContainer),this.moveToPosition(j,c.POSITION_BEFORE_START),j=t):(d=this.splitElement(j),!a.ie&&!g.inArray(j.nodeName(),["ul","ol"])&&j._4e_appendBogus()));return{previousBlock:j,nextBlock:d,wasStartOfBlock:e,wasEndOfBlock:b,elementPath:f}},splitElement:function(a){if(!this.collapsed)return t;this.setEndAt(a,
c.POSITION_BEFORE_END);var e=this.extractContents(),b=a.clone(n);b[0].appendChild(e);b.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(a,j){var h;if(e.$empty[a.nodeName()])return n;for(;a&&a[0].nodeType==b.NODE_ELEMENT;){if(h=a._4e_isEditable())this.moveToPosition(a,j?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);else if(e.$inline[a.nodeName()])return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),m;if((a=e.$empty[a.nodeName()]?
a[j?"prev":"next"](r):j?a.last(r):a.first(r))&&a[0].nodeType==b.NODE_TEXT)return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),m}return h},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==b.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});v.injectDom({_4e_breakParent:function(a,e){var b=u.Range,e=w(e),b=new b(a.ownerDocument);b.setStartAfter(w(a));b.setEndAfter(e);var c=b.extractContents();b.insertNode(w(l._4e_remove(a)));a.parentNode.insertBefore(c,
a.nextSibling)}});u.Range=o},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(g){function u(a){this.document=a;this._={cache:{}};if(n){var e=this.getNative().createRange();if(!e||e.item&&e.item(0).ownerDocument!=a||e.parentElement&&e.parentElement().ownerDocument!=a)this.isInvalid=k}}function v(a){a=new u(a);return!a||a.isInvalid?s:a}var q=g.Editor;q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var k=!0,s=null,r=g.UA,p=g.DOM,d=g.Node,f=q.SELECTION,o=q.RANGE,m=q.NODE,n=r.ie,t=q.Walker,b=q.Range,c={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};g.augment(u,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=p._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var a=this._.cache;if(a.type)return a.type;var e=f.SELECTION_TEXT,b=this.getNative();if(b){if(1==b.rangeCount){var b=b.getRangeAt(0),
h=b.startContainer;h==b.endContainer&&h.nodeType==m.NODE_ELEMENT&&1==Number(b.endOffset-b.startOffset)&&c[h.childNodes[b.startOffset].nodeName.toLowerCase()]&&(e=f.SELECTION_ELEMENT)}}else e=f.SELECTION_NONE;return a.type=e}:function(){var a=this._.cache;if(a.type)return a.type;var e=f.SELECTION_NONE;try{var b=this.getNative(),c=b.type;"Text"==c&&(e=f.SELECTION_TEXT);"Control"==c&&(e=f.SELECTION_ELEMENT);b.createRange().parentElement&&(e=f.SELECTION_TEXT)}catch(h){}return a.type=e},getRanges:n?function(){var a=
function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),h=c.childNodes,d,f=0;f<h.length;f++){var i=h[f];if(i.nodeType==m.NODE_ELEMENT){d=a.duplicate();d.moveToElementText(i);var i=d.compareEndPoints("StartToStart",a),g=d.compareEndPoints("EndToStart",a);d.collapse();if(0<i)break;else{if(!i||1==g&&-1==i)return{container:c,offset:f};if(!g)return{container:c,offset:f+1}}d=s}}d||(d=a.duplicate(),d.moveToElementText(c),d.collapse(!1));d.setEndPoint("StartToStart",a);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=h[--f].nodeValue.length}catch(l){d=0}return 0===d?{container:c,offset:f}:{container:h[f],offset:-d}};return function(e){var c=this._.cache;if(c.ranges&&!e)return c.ranges;var h=this.getNative(),e=h&&h.createRange(),i=this.getType();if(!h)return[];if(i==f.SELECTION_TEXT)return h=new b(this.document),i=a(e,k),h.setStart(new d(i.container),i.offset),i=a(e),h.setEnd(new d(i.container),i.offset),c.ranges=[h];if(i==f.SELECTION_ELEMENT){c=c.ranges=[];for(i=0;i<e.length;i++){for(var g=
e.item(i),l=g.parentNode,m=0,h=new b(this.document);m<l.childNodes.length&&l.childNodes[m]!=g;m++);h.setStart(new d(l),m);h.setEnd(new d(l),m+1);c.push(h)}return c}return c.ranges=[]}}():function(a){var e=this._.cache;if(e.ranges&&!a)return e.ranges;var a=[],c=this.getNative();if(!c)return[];for(var h=0;h<c.rangeCount;h++){var f=c.getRangeAt(h),i=new b(this.document);i.setStart(new d(f.startContainer),f.startOffset);i.setEnd(new d(f.endContainer),f.endOffset);a.push(i)}return e.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var e,b=this.getNative();switch(this.getType()){case f.SELECTION_ELEMENT:return this.getSelectedElement();case f.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();k;)if(e=c.startContainer,c.startOffset==(e[0].nodeType===m.NODE_ELEMENT?e[0].childNodes.length:e[0].nodeValue.length)&&!e._4e_isBlockBoundary())c.setStartAfter(e);else break;e=c.startContainer;if(e[0].nodeType!=m.NODE_ELEMENT)return e.parent();e=new d(e[0].childNodes[c.startOffset]);
if(!e[0]||e[0].nodeType!=m.NODE_ELEMENT)return c.startContainer;for(c=e[0].firstChild;c&&c.nodeType==m.NODE_ELEMENT;)e=new d(c),c=c.firstChild;return e}if(n)c=b.createRange(),c.collapse(k),e=new d(c.parentElement());else{if((e=b.anchorNode)&&e.nodeType!=m.NODE_ELEMENT)e=e.parentNode;e&&(e=new d(e))}}return a.startElement=e},getSelectedElement:function(){var a,e=this._.cache;if(void 0!==e.selectedElement)return e.selectedElement;n&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];
for(var b,h,f=2;f&&(!(b=a.getEnclosedNode())||!(b[0].nodeType==m.NODE_ELEMENT&&c[b.nodeName()]&&(h=b)));f--)a.shrink(o.SHRINK_ELEMENT);a=h}return e.selectedElement=new d(a)},reset:function(){this._.cache={}},selectElement:function(a){var e,b=this.document;if(n)try{e=b.body.createControlRange(),e.addElement(a[0]),e.select()}catch(c){e=b.body.createTextRange(),e.moveToElementText(a[0]),e.select()}finally{}else e=b.createRange(),e.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(e);
this.reset()},selectRanges:function(a){if(n){if(1<a.length){var e=a[a.length-1];a[0].setEnd(e.endContainer,e.endOffset);a.length=1}a[0]&&a[0].select()}else{e=this.getNative();if(!e)return;e.removeAllRanges();for(var b=0;b<a.length;b++){var c=a[b],h=this.document.createRange(),d=c.startContainer;if(c.collapsed&&(r.gecko&&1.09>r.gecko||r.opera||r.webkit)&&d[0].nodeType==m.NODE_ELEMENT&&!d[0].childNodes.length)d[0].appendChild(this.document.createTextNode(r.webkit?"\u200b":"")),c.startOffset++,c.endOffset++;
h.setStart(d[0],c.startOffset);h.setEnd(c.endContainer[0],c.endOffset);e.addRange(h)}}this.reset()},createBookmarks2:function(a){for(var e=[],b=this.getRanges(),c=0;c<b.length;c++)e.push(b[c].createBookmark2(a));return e},createBookmarks:function(a,e){for(var b=[],c=this.document,h,e=e||this.getRanges(),d=e.length,f=0;f<d;f++){b.push(h=e[f].createBookmark(a,k));var i=(a=h.serializable)?g.one("#"+h.startNode,c):h.startNode;h=a?g.one("#"+h.endNode,c):h.endNode;for(var l=f+1;l<d;l++){var m=e[l],o=m.startContainer,
n=m.endContainer;p.equals(o,i.parent())&&m.startOffset++;p.equals(o,h.parent())&&m.startOffset++;p.equals(n,i.parent())&&m.endOffset++;p.equals(n,h.parent())&&m.endOffset++}}return b},selectBookmarks:function(a){for(var e=[],c=0;c<a.length;c++){var h=new b(this.document);h.moveToBookmark(a[c]);e.push(h)}this.selectRanges(e);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var i={table:1,tbody:1,tr:1},l=t.whitespaces(k),h=/\ufeff|\u00a0/;b.prototype.select=b.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==m.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var e=this.document.createRange();e.setStart(a[0],this.startOffset);try{e.setEnd(this.endContainer[0],this.endOffset)}catch(b){if(0<=
b.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(k),e.setEnd(this.endContainer[0],this.endOffset);else throw b;}a=v(this.document).getNative();a.removeAllRanges();a.addRange(e)}:function(a){var e=this.collapsed,b,c;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==m.NODE_ELEMENT){(new u(this.document)).selectElement(new d(f));return}}(this.startContainer[0].nodeType==m.NODE_ELEMENT&&
this.startContainer.nodeName()in i||this.endContainer[0].nodeType==m.NODE_ELEMENT&&this.endContainer.nodeName()in i)&&this.shrink(o.SHRINK_ELEMENT,k);var g=this.createBookmark(),f=g.startNode,n;e||(n=g.endNode);g=this.document.body.createTextRange();g.moveToElementText(f[0]);g.moveStart("character",1);if(n)a=this.document.body.createTextRange(),a.moveToElementText(n[0]),g.setEndPoint("EndToEnd",a),g.moveEnd("character",-1);else{for(b=f[0].nextSibling;b&&!l(b);)b=b.nextSibling;b=!(b&&b.nodeValue&&
b.nodeValue.match(h))&&(a||!f[0].previousSibling||f[0].previousSibling&&"br"==p.nodeName(f[0].previousSibling));c=new d(this.document.createElement("span"));c.html("&#65279;");c.insertBefore(f);b&&p.insertBefore(this.document.createTextNode("\ufeff"),f[0]||f)}this.setStartBefore(f);f._4e_remove();if(e){if(b?(g.moveStart("character",-1),g.select(),this.document.selection.clear()):g.select(),c)this.moveToPosition(c,o.POSITION_BEFORE_START),c._4e_remove()}else this.setEndBefore(n),n._4e_remove(),g.select()};
u.getSelection=v;return q.Selection=u},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(g,u){function v(b){function c(a,b){var c=e.body.createTextRange();try{c.moveToPoint(a,b)}catch(h){c=d}return c}function f(){var a=e.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();o.remove(e,"mouseup",f);o.remove(e,"mousemove",g);j=h=0}function g(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",j)?a.setEndPoint("StartToStart",j):a.setEndPoint("EndToEnd",j),a.select()}else f()}var h,
a=b.get("iframe")[0].contentWindow,e=b.get("document")[0],j;o.on(e,"mousedown contextmenu",function(b){var d=e.documentElement;if(b.target===d&&(h&&f(),!(d.scrollHeight>d.clientHeight)&&(h=1,j=c(b.pageX,b.pageY))))o.on(e,"mouseup",f),o.on(e,"mousemove",g),a.focus(),j.select()})}function q(b){function c(h){if(e){var d=b.getSelection(),j=d&&d.getType(),g=d&&f.selection;if(h&&g&&j==n.SELECTION_NONE&&!f.queryCommandEnabled("InsertImage"))setTimeout(function(){c(r)},50);else{var l;if(!g||!g.type||!("Control"!=
g.type&&(l=g.createRange())&&(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))a=g&&d.getRanges()[0],b._monitor()}}}var f=b.get("document")[0],g=new m(f.body),h=new m(f.documentElement);if(8>u.Utils.ieEngine)h.on("click",function(a){"html"===(new m(a.target)).nodeName()&&b.getSelection().getNative().createRange().select()});var a,e,j=r;h.on("mousedown",function(){j=p});h.on("mouseup",function(){j=r});g.on("focusin",function(b){if("body"==(new m(b.target)).nodeName()&&a){try{j&&
a.select()}catch(e){}a=d}});g.on("focus",function(){e=r;c()});g.on("beforedeactivate",function(a){a.relatedTarget||(e=p,j=r)});g.on("mousedown",function(){e=p});g.on("mouseup",function(){e=r;setTimeout(function(){c(r)},0)});g.on("keydown",function(){e=p});g.on("keyup",function(){e=r;setTimeout(function(){c()},0)})}function k(b){var c=b.get("document")[0];o.on(c,"mouseup keyup",function(){b._monitor()})}function s(b){function c(a){var b=u.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function d(b){return a(b)&&e(b)}var g=b.get("document")[0],h=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,a=u.Walker.whitespaces(r),e=u.Walker.bookmark(p,r),j=function(b){return a(b)&&8!=b.nodeType};b.on("selectionChange",function(a){var e=a.path,k=new m(b.get("document")[0].body),a=(a=a.selection)&&a.getRanges()[0],o=e.blockLimit;if(f.gecko){var n=e.block||e.blockLimit,s=n&&n.last(d);n&&n._4e_isBlockBoundary()&&
(!s||!(1==s[0].nodeType&&s._4e_isBlockBoundary()))&&"pre"!=n.nodeName()&&!n._4e_getBogus()&&n._4e_appendBogus()}if(a&&a.collapsed&&!e.block){if("body"==o.nodeName()){if((e=a.fixBlock(r,"p"))&&e[0]!=k[0].lastChild&&e._4e_outerHtml().match(h))if((o=e.next(j))&&o[0].nodeType==t.NODE_ELEMENT&&!c[o])a.moveToElementEditablePosition(o),e._4e_remove();else if((o=e.prev(j))&&o[0].nodeType==t.NODE_ELEMENT&&!c[o])a.moveToElementEditablePosition(o,o._4e_outerHtml().match(h)?p:r),e._4e_remove();a.select();b.notifySelectionChange()}e=
new u.Range(g);e.moveToElementEditablePosition(k,r);"body"!==(new u.ElementPath(e.startContainer)).blockLimit.nodeName()&&(k=(new m(g.createElement("p"))).appendTo(k),f.ie||k._4e_appendBogus())}})}var r=!0,p=!1,d=null,f=g.UA,o=g.Event,m=g.Node,n=u.SELECTION,t=u.NODE;return{init:function(b){b.docReady(function(){f.ie?(v(b),q(b)):k(b)});s(b)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(g){function u(a){return!F.attr(a,"_ke_bookmark")}function v(a,b){for(var e in a)a.hasOwnProperty(e)&&(g.isString(a[e])?a[e]=a[e].replace(S,function(a,e){return b[e]}):v(a[e],b))}function q(a,b){b&&(a=g.clone(a),v(a,b));var e=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==e||N[e]?E.STYLE_BLOCK:O[e]?E.STYLE_OBJECT:E.STYLE_INLINE;this._={definition:a}}function k(a,b){var e=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var c=new M(a),h=c.getRanges(),d=0;d<h.length;d++)e.call(this,h[d]);c.selectRanges(h)}function s(a,b,e){var c=a.element;"*"==c&&(c="span");b=new D(b.createElement(c));e&&e._4e_copyAttributes(b);e=a._.definition;a=e.attributes;e=q.getStyleText(e);if(a)for(var h in a)a.hasOwnProperty(h)&&b.attr(h,a[h]);e&&(b[0].style.cssText=e);return b}function r(a){var e=a.createBookmark(j),b=a.createIterator();b.enforceRealBlocks=j;b.enlargeBr=j;for(var c,h=a.document;c=b.getNextParagraph();){var g=s(this,h,
c),i=g,g="pre"==i.nodeName,l="pre"==c.nodeName,k=!g&&l;g&&!l?(l=c,k=l.html(),k=p(k,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),k=k.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),k=k.replace(/([ \t\n\r]+|&nbsp;)/g," "),k=k.replace(/<br\b[^>]*>/gi,"\n"),B.ie?(l=l[0].ownerDocument.createElement("div"),l.appendChild(i[0]),i[0].outerHTML="<pre>"+k+"</pre>",i=new D(l.firstChild),i._4e_remove()):i.html(k)):k?i=f(d(c),i):c._4e_moveChildren(i);c[0].parentNode.replaceChild(i[0],c[0]);if(g&&(c=i,g=void 0,(g=c._4e_previousSourceNode(j,
z.NODE_ELEMENT))&&"pre"==g.nodeName()))i=p(g.html(),/\n$/,"")+"\n\n"+p(c.html(),/^\n/,""),B.ie?c[0].outerHTML="<pre>"+i+"</pre>":c.html(i),g._4e_remove()}a.moveToBookmark(e)}function p(a,b,e){var c="",h="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,e){b&&(c=b);e&&(h=e);return""});return c+a.replace(b,e)+h}function d(a){var b=[];p(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,e){return b+"</pre>"+
e+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,e){b.push(e)});return b}function f(a,b){for(var e=b[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var h=a[c],h=h.replace(/(\r\n|\r)/g,"\n"),h=p(h,/^[ \t]*\n/,""),h=p(h,/\n$/,""),h=p(h,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),h=h.replace(/\n/g,"<br>"),h=h.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
d=b.clone();d.html(h);e.appendChild(d[0])}return e}function o(a){var b=a.document;if(a.collapsed)b=s(this,b,void 0),a.insertNode(b),a.moveToPosition(b,H.POSITION_BEFORE_END);else{var e=this.element,c=this._.definition,h,d=G[e];d||(h=j,d=G.span);var f=a.createBookmark();a.enlarge(H.ENLARGE_ELEMENT);a.trim();for(var g=a.createBookmark(),i=g.startNode,g=g.endNode,k=i,o;k&&k[0];){var m=w;if(F.equals(k,g))k=x,m=j;else{var n=k[0].nodeType,r=n==z.NODE_ELEMENT?k.nodeName():x;if(r&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(j);continue}if(!r||d[r]&&(k._4e_position(g)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(k))){var p=k.parent();if(p&&"a"==e&&p.nodeName()==e)n=s(this,b,void 0),p._4e_moveChildren(n),p[0].parentNode.replaceChild(n[0],p[0]),n._4e_mergeSiblings();else if(p&&p[0]&&((G[p.nodeName()]||G.span)[e]||h)&&(!c.parentRule||c.parentRule(p))){if(!o&&(!r||!G.$removeEmpty[r]||(k._4e_position(g)|
A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))o=new R(b),o.setStartBefore(k);if(n==z.NODE_TEXT||n==z.NODE_ELEMENT&&!k[0].childNodes.length){p=k;for(n=null;(m=!p.next(u))&&(n=p.parent())&&d[n.nodeName()]&&(n._4e_position(i)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(n));)p=n;o.setEndAfter(p)}}else m=
j}else m=j;k=k._4e_nextSourceNode()}if(m&&o&&!o.collapsed){for(var m=s(this,b,void 0),p=o.getCommonAncestor(),n={},r={},y,t=null,q;m&&p&&m[0]&&p[0];){if(p.nodeName()==e){for(y in c.attributes)if(c.attributes.hasOwnProperty(y)&&!r[y]&&(q=p.attr(t)))m.attr(y)==q?m.removeAttr(y):r[y]=1;for(t in c.styles)if(c.styles.hasOwnProperty(t)&&!n[t]&&(q=p.style(t)))m.style(t)==q?m.style(t,""):n[t]=1;if(!m._4e_hasAttributes()){m=x;break}}p=p.parent()}m?(m[0].appendChild(o.extractContents()),l(this,m),o.insertNode(m),
m._4e_mergeSiblings(),B.ie||m[0].normalize()):(m=new D(b.createElement("span")),m[0].appendChild(o.extractContents()),o.insertNode(m),l(this,m),m._4e_remove(!0));o=x}}i._4e_remove();g._4e_remove();a.moveToBookmark(f);a.shrink(H.SHRINK_TEXT)}}function m(a){a.enlarge(H.ENLARGE_ELEMENT);var e=a.createBookmark(),d=e.startNode;if(a.collapsed){for(var j=new J(d.parent()),f,g=0,i;g<j.elements.length&&(i=j.elements[g])&&!(i==j.block||i==j.blockLimit);g++)if(this.checkElementRemovable(i)){var l=a.checkBoundaryOfElement(i,
H.END),k=!l&&a.checkBoundaryOfElement(i,H.START);k||l?(f=i,f.match=k?"start":"end"):(i._4e_mergeSiblings(),i.nodeName()!=this.element?(l=b(this),h(i,l[i.nodeName()]||l["*"])):c(this,i))}if(f.length){i=d;for(g=0;;g++){l=j.elements[g];if(F.equals(l,f))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(i[0]);i=l}i["start"==f.match?"insertBefore":"insertAfter"](f)}}else{var m=e.endNode,o=this,j=function(){for(var a=new J(d.parent()),b=new J(m.parent()),e=x,c=x,h=0;h<a.elements.length;h++){var j=
a.elements[h];if(j==a.block||j==a.blockLimit)break;o.checkElementRemovable(j)&&(e=j)}for(h=0;h<b.elements.length;h++){j=b.elements[h];if(j==b.block||j==b.blockLimit)break;o.checkElementRemovable(j)&&(c=j)}c&&m._4e_breakParent(c);e&&d._4e_breakParent(e)};j();for(f=new D(d[0].nextSibling);f[0]!==m[0];){g=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==z.NODE_ELEMENT&&this.checkElementRemovable(f)&&(f.nodeName()==this.element?c(this,f):(i=b(this),h(f,i[f.nodeName()]||i["*"])),g[0].nodeType==z.NODE_ELEMENT&&
g.contains(d)))j(),g=new D(d[0].nextSibling);f=g}}a.moveToBookmark(e)}function n(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,e,c){b[e]=c});return b}function t(a,b){var e="";b!==w?(e=document.createElement("span"),e.style.cssText=a,e=e.style.cssText||""):e=a;return e.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var e=a._.overrides={},b=a._.definition.overrides;
if(b){g.isArray(b)||(b=[b]);for(var c=0;c<b.length;c++){var h=b[c],d,j,f;"string"==typeof h?d=h.toLowerCase():(d=h.element?h.element.toLowerCase():a.element,j=h.attributes,f=h.styles);h=e[d]||(e[d]={});if(j){d=h.attributes=h.attributes||[];for(var i in j)j.hasOwnProperty(i)&&d.push([i.toLowerCase(),j[i]])}if(f){var h=h.styles=h.styles||[],l;for(l in f)f.hasOwnProperty(l)&&h.push([l.toLowerCase(),f[l]])}}}return e}function c(e,c){var h=e._.definition,d=b(e),f=y.mix(h.attributes,(d[c.nodeName()]||d["*"]||
{}).attributes),h=y.mix(h.styles,(d[c.nodeName()]||d["*"]||{}).styles),d=g.isEmptyObject(f)&&g.isEmptyObject(h),l;for(l in f)if(f.hasOwnProperty(l)&&!(("class"==l||e._.definition.fullMatch)&&c.attr(l)!=i(l,f[l])))d=d||!!c.hasAttr(l),c.removeAttr(l);for(var k in h)h.hasOwnProperty(k)&&!(e._.definition.fullMatch&&c.style(k)!=i(k,h[k],j))&&(d=d||!!c.style(k),c.style(k,""));a(c)}function i(a,e,b){var c=new D("<span>");c[b?"style":"attr"](a,e);return c[b?"style":"attr"](a)}function l(a,e){for(var d=b(a),
j=e.all(a.element),f=j.length;0<=--f;)c(a,new D(j[f]));for(var g in d)if(d.hasOwnProperty(g)&&g!=a.element){j=e.all(g);for(f=j.length-1;0<=f;f--){var i=new D(j[f]);h(i,d[g])}}}function h(e,b){var c,h=b&&b.attributes;if(h)for(c=0;c<h.length;c++){var d=h[c][0],j;if(j=e.attr(d)){var f=h[c][1];(f===x||f.test&&f.test(j)||"string"==typeof f&&j==f)&&e[0].removeAttribute(d)}}if(h=b&&b.styles)for(c=0;c<h.length;c++)if(d=h[c][0],f=e.css(d)){var g=h[c][1];(g===x||g.test&&g.test(j)||"string"==typeof g&&f==g)&&
e.css(d,"")}a(e)}function a(a){if(!a._4e_hasAttributes()){var e=a[0].firstChild,b=a[0].lastChild;a._4e_remove(j);e&&(e.nodeType==z.NODE_ELEMENT&&F._4e_mergeSiblings(e),b&&e!=b&&b.nodeType==z.NODE_ELEMENT&&F._4e_mergeSiblings(b))}}var e=g.Editor,j=!0,w=!1,x=null,y=e.Utils,F=g.DOM,E={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},H=e.RANGE,M=e.Selection,z=e.NODE,A=e.POSITION,R=e.Range,D=g.Node,B=g.UA,J=e.ElementPath,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},G=e.XHTML_DTD,O={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;e.STYLE=E;q.prototype={apply:function(a){k.call(this,a,w)},remove:function(a){k.call(this,a,j)},applyToRange:function(a){return(this.applyToRange=this.type==E.STYLE_INLINE?o:this.type==E.STYLE_BLOCK?r:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==E.STYLE_INLINE?m:x).call(this,a)},checkElementRemovable:function(a,e){if(!a)return w;var c=this._.definition,
h;if(a.nodeName()==this.element){if(!e&&!a._4e_hasAttributes())return j;var d=c._AC;if(d)c=d;else{var d={},f=0,g=c.attributes;if(g)for(var i in g)g.hasOwnProperty(i)&&(f++,d[i]=g[i]);if(g=q.getStyleText(c))d.style||f++,d.style=g;d._length=f;c=c._AC=d}if(c._length){for(var l in c)if("_length"!=l&&c.hasOwnProperty(l)){f=a.attr(l)||"";if("style"==l)a:{d=c[l];f=t(f,w);"string"==typeof d&&(d=n(d));"string"==typeof f&&(f=n(f));g=void 0;for(g in d)if(d.hasOwnProperty(g)&&!(g in f&&(f[g]==d[g]||"inherit"==
d[g]||"inherit"==f[g]))){d=w;break a}d=j}else d=c[l]==f;if(d){if(!e)return j}else if(e)return w}if(e)return j}else return j}l=b(this);if(l=l[a.nodeName()]||l["*"]){if(!(c=l.attributes)&&!(h=l.styles))return j;if(c)for(d=0;d<c.length;d++)if(l=c[d][0],l=a.attr(l))if(f=c[d][1],f===x||"string"==typeof f&&l==f||f.test&&f.test(l))return j;if(h)for(d=0;d<h.length;d++)if(l=a.css(h[d][0]))if(c=h[d][1],c===x||"string"==typeof c&&l==c||c.test&&c.test(l))return j}return w},checkActive:function(a){switch(this.type){case E.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,j);case E.STYLE_OBJECT:case E.STYLE_INLINE:for(var e=a.elements,b=0,c;b<e.length;b++)if(c=e[b],!(this.type==E.STYLE_INLINE&&(F.equals(c,a.block)||F.equals(c,a.blockLimit))))if((this.type!=E.STYLE_OBJECT||c.nodeName()in O)&&this.checkElementRemovable(c,j))return j}return w}};q.getStyleText=function(a){var e=a._ST;if(e)return e;var e=a.styles,b=a.attributes&&a.attributes.style||"",c="";b.length&&(b=b.replace(P,";"));for(var h in e)if(e.hasOwnProperty(h)){var d=e[h],f=(h+":"+d).replace(P,
";");"inherit"==d?c+=f:b+=f}b.length&&(b=t(b));return a._ST=b+c};e.Style=q},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(g){var u=g.Editor,v=null,q=g.Node,k=g.DOM,s=g.UA,r=g.Event,p={debugUrl:function(d){d=d.replace(/-min\.(js|css)/i,".$1");g.Config.debug||(d=d.replace(/\.(js|css)/i,"-min.$1"));-1==d.indexOf("?t")&&(d=-1!=d.indexOf("?")?d+"&":d+"?",d+="t="+encodeURIComponent("20120522203859"));g.startsWith(d,"/")&&(d=d.substring(1));return u.Config.base+d},lazyRun:function(d,f,g){var k=d[f],n=d[g];d[f]=function(){k.apply(this,arguments);d[f]=d[g];return n.apply(this,arguments)}},
getXY:function(d,f,g,m){g=g.defaultView||g.parentWindow;d-=k.scrollLeft(g);f-=k.scrollTop(g);m&&(m=m.defaultView||m.parentWindow,g!=m&&g.frameElement&&(m=k.offset(g.frameElement,void 0,m),d+=m.left,f+=m.top));return{left:d,top:f}},tryThese:function(d){for(var f,g=0,k=arguments.length;g<k;g++){var n=arguments[g];try{f=n();break}catch(p){}}return f},arrayCompare:function(d,f){if(!d&&!f)return!0;if(!d||!f||d.length!=f.length)return!1;for(var g=0;g<d.length;g++)if(d[g]!==f[g])return!1;return!0},getByAddress:function(d,
f,g){for(var d=d.documentElement,k=0;d&&k<f.length;k++){var n=f[k];if(g)for(var p=-1,b=0;b<d.childNodes.length;b++){var c=d.childNodes[b];if(!(!0===g&&3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType)&&(p++,p==n)){d=c;break}}else d=d.childNodes[n]}return d?new q(d):v},clearAllMarkers:function(d){for(var f in d)d.hasOwnProperty(f)&&d[f]._4e_clearMarkers(d,!0)},ltrim:function(d){return d.replace(/^\s+/,"")},rtrim:function(d){return d.replace(/\s+$/,"")},mix:function(d){for(var f={},k=
0;k<arguments.length;k++)f=g.mix(f,arguments[k]);return f},isCustomDomain:function(){if(!s.ie)return!1;var d=document.domain,f=window.location.hostname;return d!=f&&d!="["+f+"]"},isNumber:function(d){return/^\d+(.\d+)?$/.test(g.trim(d))},verifyInputs:function(d){for(var f=0;f<d.length;f++){var k=new q(d[f]),m=g.trim(p.valInput(k)),n=k.attr("data-verify"),k=k.attr("data-warning");if(n&&!RegExp(n).test(m))return alert(k),!1}return!0},sourceDisable:function(d,f){d.on("sourceMode",f.disable,f);d.on("wysiwygMode",
f.enable,f)},resetInput:function(d){var f=d.attr("placeholder");f&&s.ie?(d.addClass("ke-input-tip"),d.val(f)):s.ie||d.val("")},valInput:function(d,f){if(void 0===f)return d.hasClass("ke-input-tip")?"":d.val();d.removeClass("ke-input-tip");d.val(f)},placeholder:function(d,f){d.attr("placeholder",f);s.ie&&(d.on("blur",function(){g.trim(d.val())||(d.addClass("ke-input-tip"),d.val(f))}),d.on("focus",function(){d.removeClass("ke-input-tip");g.trim(d.val())==f&&d.val("")}))},htmlEncode:function(d){return!d?
d:(""+d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(d){var d=g.clone(d),f;for(f in d)if(d.hasOwnProperty(f)){var k=d[f];g.isFunction(k)&&(d[f]=k())}return d},doFormUpload:function(d,f,o){function m(){var b={responseText:"",responseXML:v};b.argument=d?d.argument:v;try{var a;if((a=s.ie?t.contentWindow.document:t.contentDocument||window.frames[n].document)&&a.body)b.responseText=g.trim(k.text(a.body));b.responseXML=a&&a.XMLDocument?a.XMLDocument:
a}catch(e){}r.remove(t,"load",m);d.callback&&d.callback(b);setTimeout(function(){k._4e_remove(t)},100)}var n=g.guid("form-upload-"),t=document.createElement("iframe");t.id=n;t.name=n;t.className="ke-hidden";var b="document.open();"+(p.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";s.ie&&(t.src=s.ie?"javascript:void(function(){"+encodeURIComponent(b)+"}())":"");document.body.appendChild(t);s.ie&&(document.frames[n].name=n);var b=d.form,c={target:k.attr(b,"target"),
method:k.attr(b,"method"),encoding:k.attr(b,"encoding"),enctype:k.attr(b,"enctype"),action:k.attr(b,"action")};k.attr(b,{target:n,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});o&&k.attr(b,"action",o);var i;if(f){i=[];var f=u.Utils.normParams(f),l;for(l in f)f.hasOwnProperty(l)&&(o=document.createElement("input"),o.type="hidden",o.name=l,o.value=f[l],b.appendChild(o),i.push(o))}r.on(t,"load",m);b.submit();k.attr(b,c);if(i){f=0;for(l=i.length;f<l;f++)k._4e_remove(i[f])}return t},
map:function(d,f){for(var g=0;g<d.length;g++)d[g]=f(d[g]);return d},ieEngine:document.documentMode||s.ie,preventFocus:function(d){s.ie?d.unselectable():d.attr("onmousedown","return false;")},injectDom:function(d){g.mix(k,d);for(var f in d)d.hasOwnProperty(f)&&function(f){q.prototype[f]=function(){var k=[].slice.call(arguments,0);k.unshift(this[0]);return(k=d[f].apply(v,k))&&(k.nodeType||g.isWindow(k))?new q(k):g.isArray(k)&&(k.__IS_NODELIST||k[0]&&k[0].nodeType)?new q(k):k}}(f)},addRes:function(){var d=
this.__res=this.__res||[];d.push.apply(d,g.makeArray(arguments))},destroyRes:function(){for(var d=this.__res||[],f=0;f<d.length;f++){var k=d[f];g.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(d,g){return g.toUpperCase()})+"Active"}};return u.Utils=p},{requires:["./base"]});
KISSY.add("editor/core/walker",function(g,u){function v(b,c){if(this._.end)return p;var a,e=this.range,d,f=this.guard,g=this.type,i=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,e.trim(),e.collapsed))return this.end(),p;if(!b&&!this._.guardLTR){var k=e.endContainer[0],m=k.childNodes[e.endOffset];this._.guardLTR=function(a,b){return b&&(k==a||"body"==o.nodeName(a))?!1:a!=m}}if(b&&!this._.guardRTL){var t=e.startContainer[0],q=0<e.startOffset&&t.childNodes[e.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(t==a||"body"==o.nodeName(a))?!1:a!=q}}var u=b?this._.guardRTL:this._.guardLTR;d=f?function(a,b){return u(a,b)===r?r:f(a,b)}:u;this.current?a=this.current[i](r,g,d):b?(a=e.endContainer,0<e.endOffset?(a=new n(a[0].childNodes[e.endOffset-1]),d(a)===r&&(a=p)):a=d(a,s)===r?p:a._4e_previousSourceNode(s,g,d,void 0)):(a=e.startContainer,a=new n(a[0].childNodes[e.startOffset]),a.length?d(a)===r&&(a=p):a=d(e.startContainer,s)===r?p:e.startContainer._4e_nextSourceNode(s,
g,d,void 0));for(;a&&!this._.end;){this.current=a;if(!this.evaluator||this.evaluator(a[0])!==r){if(!c)return a}else if(c&&this.evaluator)return r;a=a[i](r,g,d)}this.end();return this.current=p}function q(b){for(var c,a=p;c=v.call(this,b);)a=c;return a}function k(b){this.range=b;this._={}}var s=!0,r=!1,p=null,d=g.UA,f=u.NODE,o=g.DOM,m=u.XHTML_DTD,n=g.Node;g.augment(k,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,s)},checkForward:function(){return v.call(this,
r,s)!==r},checkBackward:function(){return v.call(this,s,s)!==r},lastForward:function(){return q.call(this)},lastBackward:function(){return q.call(this,s)},reset:function(){delete this.current;this._={}},_iterator:v});k.blockBoundary=function(b){return function(c){return!(c.nodeType==f.NODE_ELEMENT&&o._4e_isBlockBoundary(c,b))}};k.bookmark=function(b,c){function a(a){return"span"==o.nodeName(a)&&o.attr(a,"_ke_bookmark")}return function(e){var d,g;d=e.nodeType==f.NODE_TEXT&&(g=e.parentNode)&&a(g);d=
b?d:d||a(e);return!!(c^d)}};k.whitespaces=function(b){return function(c){c=c.nodeType==f.NODE_TEXT&&!g.trim(c.nodeValue);return!!(b^c)}};k.invisible=function(b){var c=k.whitespaces();return function(a){a=c(a)||a.nodeType==f.NODE_ELEMENT&&!a.offsetHeight;return!!(b^a)}};var t=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,b=k.whitespaces(),c=k.bookmark(),i=function(d){var h=o.nodeName(d);return c(d)||b(d)||1==d.nodeType&&h in m.$inline&&!(h in m.$empty)};u.Utils.injectDom({_4e_getBogus:function(b){b=new n(b);do b=
b._4e_previousSourceNode();while(b&&i(b[0]));return b&&(!d.ie?"br"==b.nodeName():3==b[0].nodeType&&t.test(b.text()))?b[0]:!1}});return u.Walker=k},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(g){var u=g.Editor;u.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};u.baseZIndex=function(g){return(u.Config.baseZIndex||1E4)+g}},{requires:["./base"]});
KISSY.add("editor",function(g,u,v,q){function k(c,a){var e=c.body;b(function(){c.designMode="on";setTimeout(function(){c.designMode="off";e.focus();arguments.callee.retry||(arguments.callee.retry=s)},50)},function(){c.designMode="off";m.attr(e,"contentEditable",p);m.attr(e,"contentEditable",s);!a&&k(c,1)})}var s=!0,r=g.all,p=!1,d=document,f=g.UA,o=f.ie,m=g.DOM,n=g.Node,t=g.Event,b=v.tryThese,c="document.open();"+(v.isCustomDomain()?'document.domain="'+d.domain+'";':"")+"document.close();",i='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(o?' src="javascript:void(function(){'+encodeURIComponent(c)+'}())"':"")+' allowTransparency="true"></iframe>';g.mix(u,{SOURCE_MODE:0,WYSIWYG_MODE:1});var l=u.WYSIWYG_MODE;g.augment(u,{createDom:function(){var b=this.get("textarea"),a;b||this.set("textarea",b=r("<textarea></textarea>"));a=this.get("el");a.addClass(this.get("prefixCls")+"editor-wrap",void 0);a.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=g.guid();var e=
a.one(".ke-textarea-wrap");this.__set("iframeWrapEl",e);this.__set("toolBarEl",a.one(".ke-editor-tools"));this.__set("statusBarEl",a.one(".ke-editor-status"));var c=this.get("width"),d=this.get("height");a.css("width",c);b.css("width","100%");b.css("display","none");e.append(b);e.css("height",d);b.css("height",d);a.css("height","")},_uiSetHeight:function(b){this.get("iframeWrapEl").css("height",b);this.get("textarea").css("height",b)},_uiSetMode:function(b){var a=this,e,c=a.get("textarea");b?(a.execCommand("save"),
a.on("docReady",e=function(){a.execCommand("save");a.detach("docReady",e)}),a._setData(c.val())):(c.val(a._getData(1,l)),c[0].focus());c[b?"hide":"show"]();a.get("iframe")[b?"show":"hide"]();a.fire((b?"wysiwyg":"source")+"Mode")},renderUI:function(){function b(){a.detach("docReady",b);if(a.get("focus"))a.focus();else{var e=a.getSelection();e&&e.removeAllRanges()}}var a=this,e=a.get("textarea");q.register(a);a.get("attachForm")&&e[0].form&&a._attachForm();a.on("docReady",b)},_createIframe:function(b){var a=
this,e=new n(i),c=a.get("textarea");c.hasAttr("tabindex")&&e.attr("tabIndex",f.webkit?-1:c.attr("tabIndex"));a.get("iframeWrapEl").prepend(e);a.set("iframe",e);a.__docReady=0;if(f.gecko&&!e.__loaded)e.on("load",function(){a._setUpIFrame(b)},a);else a._setUpIFrame(b)},destructor:function(){var b=this.get("el"),a=this.get("textarea"),e=this.get("document")[0],c=this.get("iframe")[0].contentWindow;this.sync();u.focusManager.remove(this);t.remove([e,e.documentElement,e.body,c]);g.each(this.__dialogs,
function(a){a.destroy&&a.destroy()});this.__commands=0;this.__editor_created_new||(a.insertBefore(b,void 0),a.css({width:this.get("width"),height:this.get("height")}),a.show())},_attachForm:function(){var b=this,a=b.get("textarea"),c=new n(a[0].form);c.on("submit",b.sync,b);b.on("destroy",function(){c.detach("submit",b.sync,b)})},addDialog:function(b,a){this.__dialogs[b]=a},showDialog:function(b,a){var c=this.__dialogs[b];c.show(a);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:b})},
hasDialog:function(b){return!!this.__dialogs[b]},addCommand:function(b,a){this.__commands[b]=a},hasCommand:function(b){return this.__commands[b]},execCommand:function(b){var a=this.__commands[b],c=g.makeArray(arguments);c.shift();c.unshift(this);if(a)return a.exec.apply(a,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var b=this.get("iframe"),a=b[0].contentWindow,c=this.get("document")[0];t.remove([c,c.documentElement,c.body,a]);b.remove()}},_getData:function(b,a){var c=this.htmlDataProcessor,
d;void 0==a&&(a=this.get("mode"));d=a==l?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=b?c.toHtml(d):c.toServer(d);d=g.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(b){var a,c=b;if(this.get("mode")!=l)this.get("textarea").val(b);else{if(a=this.htmlDataProcessor)c=a.toDataFormat(b,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(b){this.get("document")[0].body.innerHTML=b},_prepareIFrameHtml:function(b,a){var c=this.get("customStyle"),f=this.get("customLink"),g="",i=u.Utils.debugUrl("/theme/editor-iframe.css");if(f)for(var k=0;k<f.length;k++)g+='<link href="'+f[k]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===d.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+i+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+g+"</head><body class='ke-editor'>"+
(a||"&nbsp;")+(b?'<script id="ke_actscript" type="text/javascript">'+(v.isCustomDomain()?'document.domain="'+d.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return u.Selection.getSelection(this.get("document")[0])},focus:function(){var b=this.get("document")[0],a=m._4e_getWin(b);f.ie||a&&a.parent&&a.parent.focus();a&&a.focus();b.body.focus();this.notifySelectionChange()},blur:function(){m._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(b){var a=this.get("customStyle")||"",a=a+("\n"+b);this.set("customStyle",a);m.addStyleSheet(this.get("iframe")[0].contentWindow,a)},addCustomLink:function(b){var a=this.get("customLink")||[],c=this.get("document")[0];a.push(b);this.set("customLink",a);a=c.createElement("link");a.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(a);a.href=b},removeCustomLink:function(b){for(var a=this.get("document")[0],a=m.query("link",a),c=
0;c<a.length;c++)a[c].href==b&&m.remove(a[c]);a=this.get("customLink")||[];b=g.indexOf(b,a);-1!=b&&a.splice(b,1)},_setUpIFrame:function(b){function a(){i=g.document;c.__set("document",new n(i));c.__set("window",new n(g));d.detach();i.open("text/html","replace");i.write(f);i.close()}var c=this,d=c.get("iframe"),f=c._prepareIFrameHtml(c._UUID,b),g=d[0].contentWindow,i;d.__loaded=1;try{i=g.document}catch(k){if(d[0].src=d[0].src,7>o){setTimeout(a,10);return}}a()},docReady:function(b){this.on("docReady",
b);this.__docReady&&b.call(this)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var c=a.getStartElement(),d=new u.ElementPath(c);if(!b.__previousPath||!b.__previousPath.compare(d))b.__previousPath=d,b.fire("selectionChange",{selection:a,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(b,a,c){var d=this;if(d.get("mode")===
l){d.focus();var f,g=b.nodeName(),i=u.XHTML_DTD,k=u.RANGE,m=u.NODE,o=i.$block[g],r=d.getSelection(),t=r&&r.getRanges(),q,v,D,B;if(!t||0==t.length){var J=arguments,N=J.callee;setTimeout(function(){N.apply(d,J)},30)}else{d.execCommand("save");for(var G=t.length-1;0<=G;G--){q=t[G];q.deleteContents();f=!G&&b||b.clone(s);a&&a(f);if(o)for(;(D=q.getCommonAncestor(p,s))&&(B=i[D.nodeName()])&&(!B||!B[g]);)D.nodeName()in i.span?q.splitElement(D):q.checkStartOfBlock()&&q.checkEndOfBlock()?(q.setStartBefore(D),
q.collapse(s),D.remove()):q.splitBlock();q.insertNode(f);v||(v=f)}v&&(g=v._4e_nextSourceNode(s),i=d.get("document")[0],B=u.XHTML_DTD,B.$inline[f.nodeName()]?(g=new n(i.createTextNode(" ")),g.insertAfter(v)):g?"br"==g.nodeName()&&B[g.parent().nodeName()].p&&(B=new n("<p>&nbsp;</p>",null,i),g[0].parentNode.replaceChild(B[0],g[0]),g=B):(B=new n("<p>&nbsp;</p>",null,i),B.insertAfter(v),g=B),q.moveToPosition(v,k.POSITION_AFTER_END),g&&g[0].nodeType==m.NODE_ELEMENT&&q.moveToElementEditablePosition(g),r.selectRanges([q]),
d.focus(),f&&f.scrollIntoView(void 0,!1),d._saveLater(),c&&c(f))}}},insertHtml:function(b,a){var c=this,d;if(c.get("mode")===l){if(d=c.htmlDataProcessor)b=d.toDataFormat(b,null,a);c.focus();c.execCommand("save");var f=c.get("document")[0];d=0;if(o){var g=f.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(b)}catch(i){}}else try{f.execCommand("inserthtml",p,b)}catch(k){setTimeout(function(){if(0==c.getSelection().getRanges().length){var a=new u.Range(f),d=m.first(f.body,function(a){return 1==
a.nodeType&&"br"!=m.nodeName(a)});d||(d=new n(f.createElement("p")),f.body.appendChild(d[0]));a.setStartAt(d,u.RANGE.POSITION_AFTER_START);a.select()}f.execCommand("inserthtml",p,b)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);c._saveLater(d)}},_saveLater:function(b){var a=this;a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)},_fixByBindIframeDoc:function(){var b=this,a=b.get("iframe"),c=b.get("textarea")[0],
a=a[0].contentWindow,d=b.get("document")[0];f.webkit&&(t.on(d,"click",function(a){var b=new n(a.target);g.inArray(b.nodeName(),["input","select"])&&a.preventDefault()}),t.on(d,"mouseup",function(a){var b=new n(a.target);g.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(f.gecko||o||f.opera){var i;i=(new n('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);i.on("focus",function(){b.focus()});b.activateGecko=function(){f.gecko&&
b.__iframeFocus&&i[0].focus()};b.on("destroy",function(){i.detach();i.remove()})}t.on(a,"focus",function(){f.gecko?k(d,p):f.opera&&d.body.focus();b.notifySelectionChange()});if(f.gecko)t.on(d,"mousedown",function(){b.__iframeFocus||k(d,p)});if(o&&(t.on(d,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),e=c.getSelectedElement();if(e){b.fire("save");var d=c.getRanges()[0].createBookmark();e.remove();c.selectBookmarks([d]);b.fire("save");a.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var l=
{33:1,34:1};t.on(d,"keydown",function(a){a.keyCode in l&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}if(f.webkit)t.on(d,"mousedown",function(a){a=new n(a.target);g.inArray(a.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(a)});if(f.gecko)t.on(d,"dragstart",function(a){var b=new n(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});q.add(b)}});u._initIFrame=function(b){var a=q.getInstance(b),c=a.get("document")[0],
b=c.getElementById("ke_actscript");m.remove(b);a._fixByBindIframeDoc();var d=c.body;o?(d.hideFocus=s,d.disabled=s,d.contentEditable=s,d.removeAttribute("disabled")):setTimeout(function(){f.gecko||f.opera?d.contentEditable=s:f.webkit?d.parentNode.contentEditable=s:c.designMode="on"},0);if(f.gecko||f.opera){var g=c.documentElement;t.on(g,"mousedown",function(b){if(b.target==g){f.gecko&&k(c,p);a.activateGecko()}})}setTimeout(function(){o&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";
d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.__docReady=1;a.fire("docReady");var b=a.get("disableObjectResizing"),f=a.get("disableInlineTableEditing");if(b||f)try{c.execCommand("enableObjectResizing",p,!b);c.execCommand("enableInlineTableEditing",p,!f)}catch(g){t.on(d,o?"resizestart":"resize",function(a){var c=new n(a.target);(b||c.nodeName()==="table"&&f)&&a.preventDefault()})}},10)};return u},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
