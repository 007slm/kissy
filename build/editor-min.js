/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Jun 28 20:23
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(f,i,r){i=r.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:i.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(f){return this._setData(f)}},formatData:{getter:function(){return this._getData(1)},setter:function(f){return this._setData(f)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});i.HTML_PARSER={textarea:function(f){return f.one(".ks-editor-textarea")}};f.mix(i,f.EventTarget);return KISSY.Editor=i},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(f,i,r,s){function q(a){this.editor=a;this._init()}function g(a){if(l.ie&&"BackCompat"!=a.get("document")[0].compatMode){var c=a.getSelection(),h;if(c.getType()==s.SELECTION_ELEMENT&&(h=c.getSelectedElement())){var b=c.getRanges()[0],j=d(a.get("document")[0].createTextNode(""));j.insertBefore(h);b.setStartBefore(j);b.setEndAfter(h);c.selectRanges([b]);setTimeout(function(){h.parent()&&(j.remove(),c.selectElement(h))},0)}}}var d=f.all,l=f.UA,m=i.RANGE,n=f.Event;
f.augment(q,{_init:function(){var a=this.editor,d=a.get("document")[0].body;n.on(d,l.ie?"beforepaste":"paste",this._paste,this);n.on(d,"contextmenu",function(){c=1;setTimeout(function(){c=0},10)});a.addCommand("copy",new t("copy"));a.addCommand("cut",new t("cut"));a.addCommand("paste",new t("paste"))},_paste:function(){if(!c){var a=this.editor,p=a.get("document")[0];if(!p.getElementById("ke_pastebin")){var h=a.getSelection(),b=new r(p),j=d(l.webkit?"<body></body>":"<div></div>",null,p);j.attr("id",
"ke_pastebin");l.webkit&&j[0].appendChild(p.createTextNode("\u00a0"));p.body.appendChild(j[0]);j.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});j.css("left","-1000px");var k=h.createBookmarks();b.setStartAt(j,m.POSITION_AFTER_START);b.setEndAt(j,m.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){var b;j=l.webkit&&(b=j.first())&&b.hasClass("Apple-style-span")?b:j;h.selectBookmarks(k);j.remove();var c=j.html();if(c=f.trim(c.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))b=a.fire("paste",{html:c,holder:j}),void 0!==b&&(c=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(c)?f.use("editor/core/dynamic/wordFilter",function(j,b){a.insertHtml(b.toDataFormat(c,a))}):a.insertHtml(c)},0)}}}});var u=function(a,c){var h=a.get("document")[0],b=d(h.body),j=!1,k=function(){j=!0};b.on(c,k);(7<l.ie?h:h.selection.createRange()).execCommand(c);b.detach(c,k);return j},o=l.ie?function(a,c){return u(a,c)}:function(a,c){try{return a.get("document")[0].execCommand(c)}catch(h){return!1}},
w={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},t=function(a){this.type=a};t.prototype={exec:function(a){"cut"==this.type&&g(a);(a=o(a,this.type))||alert(w[this.type]);return a}};var a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},c;return{init:function(c){c.docReady(function(){new q(c)});var d={copy:1,cut:1,paste:1};c.on("contextmenu",function(h){h=h.contextmenu;if(!h.__copy_fix){h.__copy_fix=
1;for(var b in d)d.hasOwnProperty(b)&&h.addChild({xclass:"menuitem",content:a[b],value:b});h.on("click",function(a){var b=a.target.get("value");d[b]&&(this.hide(),setTimeout(function(){c.execCommand(b)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core/dom",function(f,i,r){function s(a,c){var e=a[c?"next":"prev"](q,1);if(e&&e[0].nodeType==d.ELEMENT_NODE){for(var p=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemovable(q);)if(p.push(e),e=c?e.next(q,1):e.prev(q,1),!e)return;if(a._4e_isIdentical(e,q)){for(var h=new m(c?a[0].lastChild:a[0].firstChild);p.length;)p.shift()._4e_move(a,!c,q);e._4e_moveChildren(a,!c,q);e.remove();h[0]&&h[0].nodeType==d.ELEMENT_NODE&&h._4e_mergeSiblings()}}}var q=q,g=i.XHTML_DTD,d=f.DOM,l=f.UA,m=f.Node,
n={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};i.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var u=i.POSITION,o={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},w={hr:1},t=function(a){return a&&(a[0]||a)};r.injectDom({_4e_sameLevel:function(a,c){var c=t(c),e=a.parentNode;return e&&e==c.parentNode},_4e_isBlockBoundary:function(a,c){var e=f.merge(w,c);return!(!o[d.css(a,"display")]&&!e[d.nodeName(a)])},_4e_index:function(a,c){for(var e=a.parentNode.childNodes,d,h=-1,b=0;b<e.length;b++)if(d=e[b],!c||!(3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType))if(h++,d===a)return h;return-1},_4e_move:function(a,c,e){c=
t(c);e?c.insertBefore(a,c.firstChild):c.appendChild(a)},_4e_isIdentical:function(a,c){if(!c)return!1;c=t(c);if(d.nodeName(a)!=d.nodeName(c))return!1;var e=a.attributes,p=c.attributes,h=e.length,b=p.length;if(h!=b)return!1;for(var j=0;j<h;j++){var k=e[j],v=k.name;if(k.specified&&d.attr(a,v)!=d.attr(c,v))return!1}if(8>r.ieEngine)for(j=0;j<b;j++)if(k=p[j],v=k.name,k.specified&&d.attr(a,v)!=d.attr(c,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!g.$removeEmpty[d.nodeName(a)])return!1;
for(var a=a.childNodes,c=0,e=a.length;c<e;c++){var p=a[c],h=p.nodeType;if(!(h==d.ELEMENT_NODE&&p.getAttribute("_ke_bookmark"))&&(h==d.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(p)||h==d.TEXT_NODE&&f.trim(p.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,c,e){c=t(c);if(a!=c)if(e)for(;e=a.lastChild;)c.insertBefore(a.removeChild(e),c.firstChild);else for(;e=a.firstChild;)c.appendChild(a.removeChild(e))},_4e_mergeSiblings:function(a){a=new m(a);n[a.nodeName()]&&(s(a,!0),s(a))},_4e_splitText:function(a,
c){var e=a.ownerDocument;if(a.nodeType==d.TEXT_NODE){if(l.ie&&c==a.nodeValue.length){var p=e.createTextNode("");d.insertAfter(p,a);return p}p=a.splitText(c);e.documentMode&&(e=e.createTextNode(""),d.insertAfter(e,p),d.remove(e));return p}},_4e_parents:function(a,c){var e=[];e.__IS_NODELIST=1;do e[c?"push":"unshift"](a);while(a=a.parentNode);return e},_4e_nextSourceNode:function(a,c,e,p){if(p&&!p.call)var h=t(p),p=function(a){return a!==h};var c=!c&&a.firstChild,b=a;if(!c){if(a.nodeType==d.ELEMENT_NODE&&
p&&!1===p(a,!0))return null;c=a.nextSibling}for(;!c&&(b=b.parentNode);){if(p&&!1===p(b,!0))return null;c=b.nextSibling}return!c||p&&!1===p(c)?null:e&&e!=c.nodeType?d._4e_nextSourceNode(c,!1,e,p):c},_4e_previousSourceNode:function(a,c,e,p){if(p&&!p.call)var h=t(p),p=function(a){return a!==h};var c=!c&&a.lastChild,b=a;if(!c){if(a.nodeType==d.ELEMENT_NODE&&p&&!1===p(a,!0))return null;c=a.previousSibling}for(;!c&&(b=b.parentNode);){if(p&&!1===p(b,!0))return null;c=b.previousSibling}return!c||p&&!1===
p(c)?null:e&&c.nodeType!=e?d._4e_previousSourceNode(c,!1,e,p):c},_4e_commonAncestor:function(a,c){c=t(c);if(a===c)return a;if(d.contains(c,a))return c;var e=a;do if(d.contains(e,c))return e;while(e=e.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(a){for(var c=a.attributes,e=0;e<c.length;e++){var d=c[e];switch(d.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(d.specified)return!0}}return!1}:function(a){l.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,c){var e=t(c);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a==e)return u.POSITION_IDENTICAL;if(a.nodeType==d.ELEMENT_NODE&&e.nodeType==d.ELEMENT_NODE){if(d.contains(a,e))return u.POSITION_CONTAINS+u.POSITION_PRECEDING;if(d.contains(e,a))return u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?u.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?u.POSITION_PRECEDING:u.POSITION_FOLLOWING}for(var f=
d._4e_address(a),e=d._4e_address(e),h=Math.min(f.length,e.length),b=0;b<=h-1;b++)if(f[b]!=e[b])return f[b]<e[b]?u.POSITION_PRECEDING:u.POSITION_FOLLOWING;return f.length<e.length?u.POSITION_CONTAINS+u.POSITION_PRECEDING:u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING},_4e_address:function(a,c){for(var e=[],f=a.ownerDocument.documentElement,h=a;h&&h!=f;)e.unshift(d._4e_index(h,c)),h=h.parentNode;return e},_4e_remove:function(a,c){var e=a.parentNode;if(e){if(c)for(var d;d=a.firstChild;)e.insertBefore(a.removeChild(d),
a);e.removeChild(a)}return a},_4e_trim:function(a){d._4e_ltrim(a);d._4e_rtrim(a)},_4e_ltrim:function(a){for(var c;c=a.firstChild;){if(c.nodeType==d.TEXT_NODE){var e=r.ltrim(c.nodeValue),f=c.nodeValue.length;if(e)e.length<f&&(d._4e_splitText(c,f-e.length),a.removeChild(a.firstChild));else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){for(var c;c=a.lastChild;){if(c.type==d.TEXT_NODE){var e=r.rtrim(c.nodeValue),f=c.nodeValue.length;if(e)e.length<f&&(d._4e_splitText(c,e.length),a.removeChild(a.lastChild));
else{a.removeChild(c);continue}}break}!l.ie&&!l.opera&&(c=a.lastChild)&&1==c.nodeType&&"br"==d.nodeName(c)&&a.removeChild(c)},_4e_appendBogus:function(a){for(var c=a.lastChild;c&&c.nodeType==d.TEXT_NODE&&!f.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==d.TEXT_NODE||"br"!==d.nodeName(c))c=l.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),l.gecko&&c.setAttribute("type","_moz"),a.appendChild(c)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(!0));return c.innerHTML},_4e_setMarker:function(a,c,e,d){var a=new m(a),h=a.data("list_marker_id")||a.data("list_marker_id",f.guid()).data("list_marker_id"),b=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");c[h]=a;b[e]=1;return a.data(e,d)},_4e_clearMarkers:function(a,c,e){var a=new m(a),d=a.data("list_marker_names"),h=a.data("list_marker_id"),b;for(b in d)d.hasOwnProperty(b)&&a.removeData(b);
a.removeData("list_marker_names");e&&(a.removeData("list_marker_id"),delete c[h])},_4e_copyAttributes:function(a,c,e){for(var c=new m(c),f=a.attributes,e=e||{},h=0;h<f.length;h++){var b=f[h],j=b.name.toLowerCase(),k;if(!(j in e))if("checked"==j&&(k=d.attr(a,j)))c.attr(j,k);else if(b.specified||l.ie&&b.value&&"value"==j)k=d.attr(a,j),null===k&&(k=b.nodeValue),c.attr(j,k)}""!==a.style.cssText&&(c[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=d.nodeName(a);return(a=!g.$nonEditable[a]&&
(g[a]||g.span))&&a["#text"]},_4e_getByAddress:function(a,c,e){for(var a=a.documentElement,d=0;a&&d<c.length;d++){var h=c[d];if(e)for(var b=-1,j=0;j<a.childNodes.length;j++){var k=a.childNodes[j];if(!(!0===e&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(b++,b==h)){a=k;break}}else a=a.childNodes[h]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(f){function i(d){1>arguments.length||(this.range=d,this.forceBrBreak=s,this.enlargeBr=r,this.enforceRealBlocks=s,this._||(this._={}))}var r=!0,s=!1,q=f.Editor,g=f.UA,d=q.Walker,l=q.Range,m=q.RANGE,n=q.ElementPath,u=f.Node,o=f.DOM,w=/^[\r\n\t ]*$/;f.augment(i,{getNextParagraph:function(i){var a,c,e,p,h;if(!this._.lastNode){c=this.range.clone();c.shrink(m.SHRINK_ELEMENT,r);c.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:m.ENLARGE_BLOCK_CONTENTS);
var b=new d(c),j=d.bookmark(r,r);b.evaluator=j;this._.nextNode=b.next();b=new d(c);b.evaluator=j;b=b.previous();this._.lastNode=b._4e_nextSourceNode(r);this._.lastNode&&this._.lastNode[0].nodeType==o.TEXT_NODE&&!f.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new l(c.document),j.moveToPosition(this._.lastNode,m.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new n(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(r)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new u(c.document.createTextNode("")),o.insertAfter(this._.lastNode[0],b[0]));c=null}j=this._.nextNode;b=this._.lastNode;for(this._.nextNode=null;j;){var k=s,v=j[0].nodeType!=o.ELEMENT_NODE,x=s;if(v)j[0].nodeType==o.TEXT_NODE&&w.test(j[0].nodeValue)&&(v=s);else{var y=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==y)v=r;else if(!c&&!j[0].childNodes.length&&"hr"!=y){a=j;e=j.equals(b);break}c&&(c.setEndAt(j,m.POSITION_BEFORE_START),"br"!=
y&&(this._.nextNode=j));k=r}else{if(j[0].firstChild){c||(c=new l(this.range.document),c.setStartAt(j,m.POSITION_BEFORE_START));j=new u(j[0].firstChild);continue}v=r}}v&&!c&&(c=new l(this.range.document),c.setStartAt(j,m.POSITION_BEFORE_START));e=(!k||v)&&j.equals(b);if(c&&!k)for(;!j[0].nextSibling&&!e;){y=j.parent();if(y._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=r;e||y.equals(b);break}j=y;v=r;e=j.equals(b);x=r}v&&c.setEndAt(j,m.POSITION_AFTER_END);j=j._4e_nextSourceNode(x,null,b);if((e=!j)||
k&&c)break}if(!a){if(!c)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new n(c.startContainer);j=a.blockLimit;k={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&k[j.nodeName()]&&c.checkStartOfBlock()&&c.checkEndOfBlock())a=j;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new u(this.range.document.createElement(i||"p")),a[0].appendChild(c.extractContents()),a._4e_trim(),c.insertNode(a),p=h=r;else if("li"!=a.nodeName()){if(!c.checkStartOfBlock()||
!c.checkEndOfBlock())a=a.clone(s),a[0].appendChild(c.extractContents()),a._4e_trim(),h=c.splitBlock(),p=!h.wasStartOfBlock,h=!h.wasEndOfBlock,c.insertNode(a)}else e||(this._.nextNode=a.equals(b)?null:c.getBoundaryNodes().endNode._4e_nextSourceNode(r,null,b))}p&&(c=new u(a[0].previousSibling),c[0]&&c[0].nodeType==o.ELEMENT_NODE&&("br"==c.nodeName()?c._4e_remove():c[0].lastChild&&"br"==o.nodeName(c[0].lastChild)&&o._4e_remove(c[0].lastChild)));h&&(c=d.bookmark(s,r),p=new u(a[0].lastChild),p[0]&&p[0].nodeType==
o.ELEMENT_NODE&&"br"==p.nodeName()&&(g.ie||p.prev(c,1)||p.next(c,1))&&p.remove());this._.nextNode||(this._.nextNode=e||a.equals(b)?null:a._4e_nextSourceNode(r,null,b));return a}});l.prototype.createIterator=function(){return new i(this)};return i},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(f){function i(f){for(var n=g,i=g,o=[];f;){if(f[0].nodeType==s.ELEMENT_NODE){this.lastElement||(this.lastElement=f);var w=f.nodeName();if(!i&&(!n&&d[w]&&(n=f),l[w])){var t;if(t=!n)if(t="div"==w){a:{t=f[0].childNodes;for(var a=0,c=t.length;a<c;a++){var e=t[a];if(e.nodeType==s.ELEMENT_NODE&&q.$block[e.nodeName.toLowerCase()]){t=!0;break a}}t=!1}t=!t}t?n=f:i=f}o.push(f);if("body"==w)break}f=f.parent()}this.block=n;this.blockLimit=i;this.elements=o}var r=f.Editor,
s=f.DOM,q=r.XHTML_DTD,g=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},l={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};i.prototype={compare:function(d){var f=this.elements,d=d&&d.elements;if(!d||f.length!=d.length)return!1;for(var g=0;g<f.length;g++)if(!s.equals(f[g],d[g]))return!1;return!0},contains:function(d){for(var f=this.elements,l=0;l<f.length;l++)if(f[l].nodeName()in d)return f[l];return g},toString:function(){var d=this.elements,
f,g=[];for(f=0;f<d.length;f++)g.push(d[f].nodeName());return g.toString()}};return r.ElementPath=i},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(f,i,r,s){function q(g){var i;i=g.getSelection().getRanges();for(var t=i.length-1;0<t;t--)i[t].deleteContents();i=i[0];t=i.document;if(i.checkStartOfBlock()&&i.checkEndOfBlock()){var a=(new s(i.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return g.hasCommand("outdent")?(g.execCommand("save"),g.execCommand("outdent"),g.execCommand("save"),!0):!1}var c=i.splitBlock("p");if(!c)return!0;var g=c.previousBlock,a=c.nextBlock,e=c.wasStartOfBlock,
p=c.wasEndOfBlock,h;if(a)h=a.parent(),"li"==h.nodeName()&&(a._4e_breakParent(h),a._4e_move(a.next(),!0));else if(g&&(h=g.parent())&&"li"==h.nodeName())g._4e_breakParent(h),i.moveToElementEditablePosition(g.next()),g._4e_move(g.prev());if(!e&&!p){if("li"==a.nodeName()&&(h=a.first(r.invisible(!0)))&&f.inArray(h.nodeName(),["ul","ol"]))(d.ie?new n(t.createTextNode("\u00a0")):new n(t.createElement("br"))).insertBefore(h);a&&i.moveToElementEditablePosition(a)}else{var b;if(g){if("li"==g.nodeName()||!l.test(g.nodeName()))b=
g.clone()}else a&&(b=a.clone());b||(b=new n("<p>",null,t));if(h=c.elementPath)for(var c=0,j=h.elements.length;c<j;c++){var k=h.elements[c];if(k.equals(h.block)||k.equals(h.blockLimit))break;m.$removeEmpty[k.nodeName()]&&(k=k.clone(),b._4e_moveChildren(k),b.append(k))}d.ie||b._4e_appendBogus();i.insertNode(b);if(d.ie&&e&&(!p||!g[0].childNodes.length))i.moveToElementEditablePosition(p?g:b),i.select();i.moveToElementEditablePosition(e&&!p?a:b)}d.ie||(a?(b=new n(t.createElement("span")),b.html("&nbsp;"),
i.insertNode(b),b.scrollIntoView(void 0,!1),i.deleteContents()):b.scrollIntoView(void 0,!1));i.select();return!0}function g(d){var f=d.get("document")[0];u.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){d.execCommand("save");var a=d.execCommand("enterBlock");d.execCommand("save");!1!==a&&f.preventDefault()}})}var d=f.UA,l=/^h[1-6]$/,m=i.XHTML_DTD,n=f.Node,u=f.Event;return{init:function(d){d.addCommand("enterBlock",{exec:q});d.docReady(function(){g(d)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(f){function i(){var d=this;d.__iframeFocus=n;m=d;l&&clearTimeout(l);l=setTimeout(function(){d.fire("focus")},100)}function r(){var d=this;d.__iframeFocus=u;m=o;l&&clearTimeout(l);l=setTimeout(function(){d.fire("blur")},100)}var s=f.Editor,q=f.DOM,g=f.Event,d={},l,m,f={refreshAll:function(){for(var f in d)if(d.hasOwnProperty(f)){var g=d[f].get("document")[0];g.designMode="off";g.designMode="on"}},currentInstance:function(){return m},getInstance:function(f){return d[f]},
add:function(d){var f=q._getWin(d.get("document")[0]);g.on(f,"focus",i,d);g.on(f,"blur",r,d)},register:function(f){d[f._UUID]=f},remove:function(f){delete d[f._UUID];var l=q._getWin(f.get("document")[0]);g.remove(l,"focus",i,f);g.remove(l,"blur",r,f)}},n=!0,u=!1,o=null;f.refreshAll=f.refreshAll;s.focusManager=f;s.getInstances=function(){return d};return f},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(f,i){return{init:function(r){function s(a){if("Apple-style-span"==a.getAttribute("class")||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function q(a){return a.replace(w,function(a,b,c){return"<"+b+c.replace(t,function(a,b){return-1==c.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function g(a){return a.replace(c,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function d(a){return a.replace(e,function(a,b){return decodeURIComponent(b)})}var l=f.Node,m=f.UA,n=f.require("htmlparser"),u=new n.Filter,o=new n.Filter;(function(){function b(c){c=n.serialize(c);return new n.Comment(a+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:s}},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,e=0;e<b.length;e++)c="_ke_saved_"+b[e],a.getAttribute(c)&&a.removeAttribute(b[e]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:s},attributes:{style:function(a){if(!f.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,a.length)==a)return b=f.trim(decodeURIComponent(b.substr(a.length))),n.parse(b).childNodes[0]}};m.ie&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});u.addRules(e);o.addRules(c)})();(function(){function a(b){for(var b=b.childNodes,c=b.length,B=b[c-1];B&&3==B.nodeType&&!f.trim(B.nodeValue);)B=b[--c];return B}function b(B,c){var e=a(B);e&&((c||!m.ie)&&1==e.nodeType&&"br"==e.nodeName?B.removeChild(e):
3==e.nodeType&&h.test(e.nodeValue)&&B.removeChild(e))}function c(b){var B=a(b);return!B||1==B.nodeType&&"br"==B.nodeName||"form"==b.nodeName&&"input"==B.nodeName}function e(a){b(a,!0);c(a)&&(m.ie?a.appendChild(new n.Text("\u00a0")):(a.appendChild(new n.Text("&nbsp;")),a.appendChild(new n.Tag("br"))))}function d(a){b(a,!1);c(a)&&a.appendChild(new n.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,g=i.XHTML_DTD,B=f.merge(g.$block,g.$listItem,g.$tableContent),z;for(z in B)B.hasOwnProperty(z)&&("br"in g[z]||
delete B[z]);delete B.td;delete B.pre;var g={tags:{}},G={tags:{}};for(z in B)B.hasOwnProperty(z)&&(g.tags[z]=e,G.tags[z]=d);o.addRules(g);u.addRules(G)})();u.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var w=/<(a|area|img|input)\b([^>]*)>/gi,t=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",c=/(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,p=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
h=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,b=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;r.htmlDataProcessor={dataFilter:o,htmlFilter:u,toHtml:function(a){var b=new n.BeautifyWriter;(new n.Parser(a)).parse().writeHtml(b,u);return a=b.getHtml()},toDataFormat:function(a,c){var c=c||o,a=q(a),a=g(a),a=a.replace(p,"$1ke:$2"),a=a.replace(b,"<ke:$1$2></ke:$1>"),e=new l("<div>");e.html("a"+a);a=e.html().substr(1);a=a.replace(h,"$1$2");a=d(a);e=new n.BasicWriter;
(new n.Parser(a)).parse().writeHtml(e,c);return a=e.getHtml()},toServer:function(a){var b=new n.MinifyWriter;(new n.Parser(a)).parse().writeHtml(b,u);return b.getHtml()}}}}},{requires:["./base"]});
KISSY.add("editor/core/meta",function(){var f={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../menubutton/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubble/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],orderedList:["../listUtils/btn","./cmd"],unorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubble/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["dd","../focusFix/"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],menubutton:["menubutton"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui",
"./cmd"],undo:["./btn","./cmd"],contextmenu:["menu","../focusFix/"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},i,r,s={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../menubutton/"],"flashCommon/baseClass":["../contextmenu/",
"../bubble/","../dialogLoader/","./utils"],"font/ui":["../button/","../menubutton/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../menubutton/"],"indent/cmd":["../dentUtils/cmd"],"orderedList/cmd":["../listUtils/cmd"],"unorderedList/cmd":["../listUtils/cmd"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],
"link/dialog":["../overlay/","./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../menubutton/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../menubutton/"],"xiamiMusic/dialog":["../flash/dialog","../menubutton/"]},q={};for(i in f)r=
"editor/plugin/"+i+"/index",q[r]={requires:f[i]};for(i in s)r="editor/plugin/"+i,q[r]={requires:s[i]};KISSY.add(q)});
KISSY.add("editor/core/range",function(f,i,r,s,q){function g(a){var b=a.nodeType!=e.TEXT_NODE&&e.nodeName(a)in h.$removeEmpty,c=a.nodeType==e.TEXT_NODE&&!f.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||c||a}function d(a){return!v(a)&&!x(a)}function l(a){var b=w;return function(c){if(x(c))return o;if(c.nodeType==e.TEXT_NODE){if(f.trim(c.nodeValue).length)return w}else if(c.nodeType==e.ELEMENT_NODE&&(c=e.nodeName(c),!H[c]))if(!a&&!p.ie&&"br"==c&&!b)b=o;else return w;return o}}
function m(a,c){var d=a.startContainer,h=a.endContainer,C=a.startOffset,j=a.endOffset,k,f=w,g=w,v=void 0,l=a.document,P;0<c&&(v=l.createDocumentFragment());if(a.collapsed)return v;a.optimizeBookmark();h[0].nodeType==e.TEXT_NODE?(g=o,h=h._4e_splitText(j)):0<h[0].childNodes.length&&(j>=h[0].childNodes.length?(h=new b(h[0].appendChild(l.createTextNode(""))),P=o):h=new b(h[0].childNodes[j]));d[0].nodeType==e.TEXT_NODE?(f=o,d._4e_splitText(C)):C?C>=d[0].childNodes.length?(d=new b(d[0].appendChild(l.createTextNode(""))),
k=o):d=new b(d[0].childNodes[C].previousSibling):(k=new b(l.createTextNode("")),d.prepend(k),d=k,k=o);var J=d._4e_parents(),K=h._4e_parents();J.each(function(a,b){J[b]=a});K.each(function(a,b){K[b]=a});for(var E,M,l=0;l<J.length&&!(E=J[l],M=K[l],!E.equals(M));l++);for(var C=v,i,p,x=l;x<J.length;x++){i=J[x];j=0<c&&!i.equals(d)?C.appendChild(i.clone()[0]):null;i=i[0].nextSibling;p=K[x];for(var m=h[0],y=p&&p[0];i&&!(y==i||m==i);)p=i.nextSibling,2==c?C.appendChild(i.cloneNode(o)):(e._4e_remove(i),1==
c&&C.appendChild(i)),i=p;j&&(C=j)}for(C=v;l<K.length;l++){i=K[l];j=0<c&&!i.equals(h)?C.appendChild(i.clone()[0]):null;if(!J[l]||!i._4e_sameLevel(J[l]))for(i=i[0].previousSibling;i;)p=i.previousSibling,2==c?C.insertBefore(i.cloneNode(o),C.firstChild):(e._4e_remove(i),1==c&&C.insertBefore(i,C.firstChild)),i=p;j&&(C=j)}if(2==c){if(f&&(E=d[0],E.nodeType==e.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==e.TEXT_NODE&&(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),g)g=h[0],g.nodeType==
e.TEXT_NODE&&g.previousSibling&&g.previousSibling.nodeType==e.TEXT_NODE&&(g.previousSibling.data+=g.data,g.parentNode.removeChild(g))}else{if(E&&M&&(!d._4e_sameLevel(E)||!h._4e_sameLevel(M)))g=E._4e_index(),k&&E._4e_sameLevel(d)&&g--,a.setStart(E.parent(),g+1);a.collapse(o)}k&&d.remove();P&&h.remove();return v}function n(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function u(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=t;this.collapsed=o;this.document=a}i.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,w=!1,t=null,a=i.RANGE,c=i.POSITION,e=f.DOM,p=f.UA,h=i.XHTML_DTD,b=f.Node,j=b.all,k={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new s.whitespaces,x=new s.bookmark,y=s.whitespaces(o),A=s.bookmark(!1,
!0),H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};f.augment(u,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);n(this)},setEnd:function(a,b){a[0].nodeType==e.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);n(this)},setStartAt:function(b,c){switch(c){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==e.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}n(this)},setEndAt:function(b,c){switch(c){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==e.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}n(this)},cloneContents:function(){return m(this,2)},deleteContents:function(){return m(this,0)},extractContents:function(){return m(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new u(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.ELEMENT_NODE||a.endContainer[0].nodeType!=e.ELEMENT_NODE)return t;var b=new s(a);b.evaluator=function(a){return y(a)&&A(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:t},shrink:function(b,c){if(!this.collapsed){var b=b||a.SHRINK_TEXT,d=this.clone(),h=this.startContainer,j=this.endContainer,k=this.startOffset,f=this.endOffset,g=o,l,v,i=o;h&&h[0].nodeType==e.TEXT_NODE&&(k?k>=h[0].nodeValue.length?d.setStartAfter(h):(d.setStartBefore(h),g=w):d.setStartBefore(h));j&&j[0].nodeType==e.TEXT_NODE&&(f?f>=j[0].nodeValue.length?d.setEndAfter(j):(d.setEndAfter(j),i=w):d.setEndBefore(j));if(g||i)v=new s(d),v.evaluator=function(c){return c.nodeType==
(b==a.SHRINK_ELEMENT?e.ELEMENT_NODE:e.TEXT_NODE)},v.guard=function(c,d){if(b==a.SHRINK_ELEMENT&&c.nodeType==e.TEXT_NODE||d&&c==l)return w;!d&&c.nodeType==e.ELEMENT_NODE&&(l=c);return o};g&&(d=v[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,c?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);i&&(v.reset(),(v=v[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,c?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return g||i}},createBookmark2:function(a){var c=this.startContainer,
d=this.endContainer,h=this.startOffset,j=this.endOffset,k,f;if(!c||!d)return{start:0,end:0};if(a){if(c[0].nodeType==e.ELEMENT_NODE&&(k=new b(c[0].childNodes[h]))&&k[0]&&k[0].nodeType==e.TEXT_NODE&&0<h&&k[0].previousSibling.nodeType==e.TEXT_NODE)c=k,h=0;for(;c[0].nodeType==e.TEXT_NODE&&(f=c.prev(void 0,1))&&f[0].nodeType==e.TEXT_NODE;)c=f,h+=f[0].nodeValue.length;if(!this.collapsed){if(d[0].nodeType==e.ELEMENT_NODE&&(k=new b(d[0].childNodes[j]))&&k[0]&&k[0].nodeType==e.TEXT_NODE&&0<j&&k[0].previousSibling.nodeType==
e.TEXT_NODE)d=k,j=0;for(;d[0].nodeType==e.TEXT_NODE&&(f=d.prev(void 0,1))&&f[0].nodeType==e.TEXT_NODE;)d=f,j+=f[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?t:d._4e_address(a),startOffset:h,endOffset:j,normalized:a,is2:o}},createBookmark:function(c){var d,h,e,j,k=this.collapsed;d=new b("<span>",t,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");c&&(e=f.guid("ke_bm_"),d.attr("id",e+"S"));k||(h=d.clone(),h.html("&nbsp;"),c&&h.attr("id",e+"E"),
j=this.clone(),j.collapse(),j.insertNode(h));j=this.clone();j.collapse(o);j.insertNode(d);h?(this.setStartAfter(d),this.setEndBefore(h)):this.moveToPosition(d,a.POSITION_AFTER_END);return{startNode:c?e+"S":d,endNode:c?e+"E":h,serializable:c,collapsed:k}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var c=this.startContainer,d=this.startOffset,h=this.collapsed;if((!a||h)&&c[0]&&c[0].nodeType==e.TEXT_NODE){if(d)if(d>=c[0].nodeValue.length)d=c._4e_index()+1,
c=c.parent();else{var j=c._4e_splitText(d),d=c._4e_index()+1,c=c.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(j,this.endOffset-this.startOffset):e.equals(c,this.endContainer)&&(this.endOffset+=1)}else d=c._4e_index(),c=c.parent();this.setStart(c,d);if(h){this.collapse(o);return}}c=this.endContainer;d=this.endOffset;!b&&!h&&c[0]&&c[0].nodeType==e.TEXT_NODE&&(d?(d>=c[0].nodeValue.length||c._4e_splitText(d),d=c._4e_index()+1):d=c._4e_index(),c=c.parent(),this.setEnd(c,d))},insertNode:function(a){this.optimizeBookmark();
this.trim(w,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=j(this.document);if(a.is2){var c=b._4e_getByAddress(a.start,a.normalized),d=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(c,d);b?this.setEnd(b,a):this.collapse(o)}else c=(d=a.serializable)?f.one("#"+a.startNode,b):a.startNode,a=d?f.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(c),c._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,c){var d=this.startContainer,h=this.endContainer,d=d[0]==h[0]?a&&d[0].nodeType==e.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new b(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(h);return c&&d[0].nodeType==e.TEXT_NODE?d.parent():d},enlarge:function(){function c(a,b,d,h){var k=a[b?"startContainer":"endContainer"],f,g=b?0:1,l=0,i=b?"previousSibling":
"nextSibling";f=a[b?"startOffset":"endOffset"];if(k[0].nodeType==e.TEXT_NODE){if(b){if(f)return}else if(f<k[0].nodeValue.length)return;f=k[0][i];k=k[0].parentNode}else f=k[0].childNodes[f+(b?-1:1)]||null,k=k[0];for(;k;){for(;f;)if(v(f)||x(f))f=f[i];else break;if(f){if(!l)a[b?"setStartAfter":"setEndBefore"](j(f));break}k=j(k);if("body"==k.nodeName())break;if(l||k.equals(h))d[g]=k,l=1;else a[b?"setStartBefore":"setEndAfter"](k);f=k[0][i];k=k[0].parentNode}}return function(d){switch(d){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var d=this.getCommonAncestor(),h=[];c(this,1,h,d);c(this,0,h,d);h[0]&&h[1]&&(d=h[0].contains(h[1])?h[1]:h[0],this.setStartBefore(d),this.setEndAfter(d));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var k=new u(this.document),h=new b(this.document.body);k.setStartAt(h,a.POSITION_AFTER_START);k.setEnd(this.startContainer,this.startOffset);var k=new s(k),f,g,l=s.blockBoundary(d==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:t),v=function(a){var b=l(a);b||(f=j(a));return b},i=function(a){var b=
v(a);!b&&"br"==e.nodeName(a)&&(g=j(a));return b};k.guard=v;k=k.lastBackward();f=f||h;this.setStartAt(f,"br"!=f.nodeName()&&(!k&&this.checkStartOfBlock()||k&&f.contains(k))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);k=this.clone();k.collapse();k.setEndAt(h,a.POSITION_BEFORE_END);k=new s(k);k.guard=d==a.ENLARGE_LIST_ITEM_CONTENTS?i:v;f=t;k=k.lastForward();f=f||h;this.setEndAt(f,!k&&this.checkEndOfBlock()||k&&f.contains(k)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);g&&this.setEndAfter(g)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,c=this.startOffset;if(c&&b[0].nodeType==e.TEXT_NODE&&f.trim(b[0].nodeValue.substring(0,c)).length)return w;this.trim();b=new q(this.startContainer);c=this.clone();c.collapse(o);c.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new s(c);b.evaluator=l(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,c=this.endOffset;if(b[0].nodeType==e.TEXT_NODE&&f.trim(b[0].nodeValue.substring(c)).length)return w;this.trim();
b=new q(this.endContainer);c=this.clone();c.collapse(w);c.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new s(c);b.evaluator=l(w);return b.checkForward()},checkBoundaryOfElement:function(b,c){var d=this.clone();d[c==a.START?"setStartAt":"setEndAt"](b,c==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);d=new s(d);d.evaluator=g;return d[c==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,d=this.startOffset,h=this.endOffset,
k;if(a[0].nodeType==e.ELEMENT_NODE)if(k=a[0].childNodes.length,k>d)a=j(a[0].childNodes[d]);else if(0==k)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=j(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==e.ELEMENT_NODE)if(k=b[0].childNodes.length,k>h)b=j(b[0].childNodes[h])._4e_previousSourceNode(o);else if(0==k)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=j(b)}a._4e_position(b)&c.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(b,
c){var d=this.createBookmark(),h=j(this.document.createElement(c));this.collapse(b);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);h[0].appendChild(this.extractContents());h._4e_trim();p.ie||h._4e_appendBogus();this.insertNode(h);this.moveToBookmark(d);return h},splitBlock:function(b){var c=new q(this.startContainer),d=new q(this.endContainer),h=c.block,k=d.block,e=t;if(!c.blockLimit.equals(d.blockLimit))return t;"br"!=b&&(h||(h=this.fixBlock(o,b),k=(new q(this.endContainer)).block),k||(k=this.fixBlock(w,
b)));b=h&&this.checkStartOfBlock();c=k&&this.checkEndOfBlock();this.deleteContents();h&&h[0]==k[0]&&(c?(e=new q(this.startContainer),this.moveToPosition(k,a.POSITION_AFTER_END),k=t):b?(e=new q(this.startContainer),this.moveToPosition(h,a.POSITION_BEFORE_START),h=t):(k=this.splitElement(h),!p.ie&&!f.inArray(h.nodeName(),["ul","ol"])&&h._4e_appendBogus()));return{previousBlock:h,nextBlock:k,wasStartOfBlock:b,wasEndOfBlock:c,elementPath:e}},splitElement:function(b){if(!this.collapsed)return t;this.setEndAt(b,
a.POSITION_BEFORE_END);var c=this.extractContents(),d=b.clone(w);d[0].appendChild(c);d.insertAfter(b);this.moveToPosition(b,a.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(b,c){for(var h=0;b;){if(b[0].nodeType==e.TEXT_NODE){this.moveToPosition(b,c?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);h=1;break}b[0].nodeType==e.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,c?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),h=1);var k=b,f=h,j=void 0;k[0].nodeType==e.ELEMENT_NODE&&
k._4e_isEditable()&&(j=k[c?"last":"first"](d,1));!f&&!j&&(j=k[c?"prev":"next"](d,1));b=j}return!!h},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,c,d,k=a.nodeName();b=h.$block[k];this.deleteContents();if(b){for(b=this.getCommonAncestor(w,o);(c=h[b.nodeName()])&&(!c||!c[k]);){var e=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(o),
b.remove()):d=b;b=e}d&&this.splitElement(d)}this.insertNode(a)}});r.injectDom({_4e_breakParent:function(a,b){var b=j(b),a=j(a),c,d=new i.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);c=d.extractContents();d.insertNode(a.remove());a.after(c)}});return i.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(f){function i(a){this.document=a;this._={cache:{}};if(o)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=q}catch(c){this.isInvalid=q}}function r(a){a=new i(a);return!a||a.isInvalid?g:a}var s=f.Editor;s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var q=!0,g=null,d=f.UA,l=f.DOM,m=f.Node,n=s.SELECTION,u=s.RANGE,o=d.ie,w=s.Walker,t=s.Range,
a={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};f.augment(i,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=l._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var c=this._.cache;if(c.type)return c.type;var b=n.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=
d.getRangeAt(0),k=d.startContainer;k==d.endContainer&&k.nodeType==l.ELEMENT_NODE&&1==Number(d.endOffset-d.startOffset)&&a[k.childNodes[d.startOffset].nodeName.toLowerCase()]&&(b=n.SELECTION_ELEMENT)}}else b=n.SELECTION_NONE;return c.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=n.SELECTION_NONE;try{var c=this.getNative(),d=c.type;"Text"==d&&(b=n.SELECTION_TEXT);"Control"==d&&(b=n.SELECTION_ELEMENT);c.createRange().parentElement&&(b=n.SELECTION_TEXT)}catch(e){}return a.type=b},
getRanges:o?function(){var a=function(a,c){a=a.duplicate();a.collapse(c);for(var d=a.parentElement(),h=d.childNodes,e,f=0;f<h.length;f++){var i=h[f];if(i.nodeType==l.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(i);var i=e.compareEndPoints("StartToStart",a),p=e.compareEndPoints("EndToStart",a);e.collapse();if(0<i)break;else{if(!i||1==p&&-1==i)return{container:d,offset:f};if(!p)return{container:d,offset:f+1}}e=g}}e||(e=a.duplicate(),e.moveToElementText(d),e.collapse(!1));e.setEndPoint("StartToStart",
a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=h[--f].nodeValue.length}catch(m){e=0}return 0===e?{container:d,offset:f}:{container:h[f],offset:-e}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var d=this.getNative(),b=d&&d.createRange(),e=this.getType();if(!d)return[];if(e==n.SELECTION_TEXT)return d=new t(this.document),e=a(b,q),d.setStart(new m(e.container),e.offset),e=a(b),d.setEnd(new m(e.container),e.offset),c.ranges=[d];if(e==n.SELECTION_ELEMENT){c=
c.ranges=[];for(e=0;e<b.length;e++){for(var f=b.item(e),g=f.parentNode,i=0,d=new t(this.document);i<g.childNodes.length&&g.childNodes[i]!=f;i++);d.setStart(new m(g),i);d.setEnd(new m(g),i+1);c.push(d)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var e=c.getRangeAt(d),f=new t(this.document);f.setStart(new m(e.startContainer),e.startOffset);f.setEnd(new m(e.endContainer),e.endOffset);
a.push(f)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case n.SELECTION_ELEMENT:return this.getSelectedElement();case n.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();q;)if(b=d.startContainer,d.startOffset==(b[0].nodeType===l.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())d.setStartAfter(b);else break;b=d.startContainer;
if(b[0].nodeType!=l.ELEMENT_NODE)return b.parent();b=new m(b[0].childNodes[d.startOffset]);if(!b[0]||b[0].nodeType!=l.ELEMENT_NODE)return d.startContainer;for(d=b[0].firstChild;d&&d.nodeType==l.ELEMENT_NODE;)b=new m(d),d=d.firstChild;return b}if(o)d=c.createRange(),d.collapse(q),b=new m(d.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=l.ELEMENT_NODE)b=b.parentNode;b&&(b=new m(b))}}return a.startElement=b},getSelectedElement:function(){var c,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;
o&&(c=this.getNative().createRange(),c=c.item&&c.item(0));var d;if(c)d=new m(c);else{c=this.getRanges()[0];for(var e,f=2;f&&(!(d=c.getEnclosedNode())||!(d[0].nodeType==l.ELEMENT_NODE&&a[d.nodeName()]&&(e=d)));f--)c.shrink(u.SHRINK_ELEMENT);d=e}return b.selectedElement=d},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(o)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(d){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=
c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var e=a[c],f=this.document.createRange(),g=e.startContainer;if(e.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&g[0].nodeType==l.ELEMENT_NODE&&!g[0].childNodes.length)g[0].appendChild(this.document.createTextNode(d.webkit?
"\u200b":"")),e.startOffset++,e.endOffset++;f.setStart(g[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);b.addRange(f)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],d=this.document,e,b=b||this.getRanges(),g=b.length,i=0;i<g;i++){c.push(e=b[i].createBookmark(a,q));var p=(a=e.serializable)?f.one("#"+e.startNode,d):e.startNode;e=a?f.one("#"+e.endNode,d):e.endNode;
for(var m=i+1;m<g;m++){var n=b[m],o=n.startContainer,r=n.endContainer;l.equals(o,p.parent())&&n.startOffset++;l.equals(o,e.parent())&&n.startOffset++;l.equals(r,p.parent())&&n.endOffset++;l.equals(r,e.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var d=new t(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-
1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var c={table:1,tbody:1,tr:1},e=w.whitespaces(q),p=/\ufeff|\u00a0/;t.prototype.select=t.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==l.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],
this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(q),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=r(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,d,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var g=this.startContainer[0].childNodes[this.startOffset];if(g.nodeType==l.ELEMENT_NODE){(new i(this.document)).selectElement(new m(g));
return}}(this.startContainer[0].nodeType==l.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType==l.ELEMENT_NODE&&this.endContainer.nodeName()in c)&&this.shrink(u.SHRINK_ELEMENT,q);var n=this.createBookmark(),g=n.startNode,o;b||(o=n.endNode);n=this.document.body.createTextRange();n.moveToElementText(g[0]);n.moveStart("character",1);if(o)a=this.document.body.createTextRange(),a.moveToElementText(o[0]),n.setEndPoint("EndToEnd",a),n.moveEnd("character",-1);else{for(d=g[0].nextSibling;d&&
!e(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(p))&&(a||!g[0].previousSibling||g[0].previousSibling&&"br"==l.nodeName(g[0].previousSibling));f=new m(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(g);d&&l.insertBefore(this.document.createTextNode("\ufeff"),g[0]||g)}this.setStartBefore(g);g._4e_remove();if(b){if(d?(n.moveStart("character",-1),n.select(),this.document.selection.clear()):n.select(),f)this.moveToPosition(f,u.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(o),
o._4e_remove(),n.select()};i.getSelection=r;return s.Selection=i},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(f,i){function r(a){function c(a,b){var c=j.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=m}return c}function d(){var a=j.selection.createRange();k&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&k.select();u.remove(j,"mouseup",d);u.remove(j,"mousemove",f);k=g=0}function f(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",k)?a.setEndPoint("StartToStart",k):a.setEndPoint("EndToEnd",k),a.select()}else d()}var g,b=a.get("window")[0],
j=a.get("document")[0],k;u.on(j,"mousedown contextmenu",function(a){var i=j.documentElement;if(a.target===i&&(g&&d(),!(i.scrollHeight>i.clientHeight)&&(g=1,k=c(a.pageX,a.pageY))))u.on(j,"mouseup",d),u.on(j,"mousemove",f),b.focus(),k.select()})}function s(a){function c(f){if(j){var g=a.getSelection(),k=g&&g.getType(),h=g&&e.selection;if(f&&h&&k==t.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){c(d)},50);else{var i;if(!h||!h.type||!("Control"!=h.type&&(i=h.createRange())&&
(i=i.parentElement())&&(i=i.nodeName)&&i.toLowerCase()in{input:1,textarea:1}))b=h&&g.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],f=new w(e.body),g=new w(e.documentElement);if(8>i.Utils.ieEngine)g.on("click",function(b){"html"===(new w(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var b,j,k=d;g.on("mousedown",function(){k=l});g.on("mouseup",function(){k=d});f.on("focusin",function(a){if("body"==(new w(a.target)).nodeName()&&b){try{k&&b.select()}catch(c){}b=
m}});f.on("focus",function(){j=d;c()});f.on("beforedeactivate",function(a){a.relatedTarget||(j=l,k=d)});f.on("mousedown",function(){j=l});f.on("mouseup",function(){j=d;setTimeout(function(){c(d)},0)});f.on("keydown",function(){j=l});f.on("keyup",function(){j=d;setTimeout(function(){c()},0)})}function q(a){var c=a.get("document")[0];u.on(c,"mouseup keyup",function(){a.checkSelectionChange()})}function g(a){function c(a){var b=i.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}function e(a){return g(a)&&
b(a)}var f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,g=i.Walker.whitespaces(d),b=i.Walker.bookmark(l,d),j=function(a){return g(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var g=b.path,h=new w(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],m=g.blockLimit;if(n.gecko){var r=g.block||g.blockLimit,q=r&&r.last(e);r&&r._4e_isBlockBoundary()&&(!q||!(1==q[0].nodeType&&q._4e_isBlockBoundary()))&&
"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!g.block){if("body"==m.nodeName()){if((g=b.fixBlock(d,"p"))&&g[0]!=h[0].lastChild&&g._4e_outerHtml().match(f))if((m=g.next(j,1))&&m[0].nodeType==o.ELEMENT_NODE&&!c[m])b.moveToElementEditablePosition(m),g._4e_remove();else if((m=g.prev(j,1))&&m[0].nodeType==o.ELEMENT_NODE&&!c[m])b.moveToElementEditablePosition(m,m._4e_outerHtml().match(f)?l:d),g._4e_remove();b.select();a.notifySelectionChange()}g=a.get("document")[0];b=
new i.Range(g);b.moveToElementEditablePosition(h,d);"body"!==(new i.ElementPath(b.startContainer)).blockLimit.nodeName()&&(h=(new w(g.createElement("p"))).appendTo(h),n.ie||h._4e_appendBogus())}})}var d=!0,l=!1,m=null,n=f.UA,u=f.Event,o=f.DOM,w=f.Node,t=i.SELECTION;return{init:function(a){a.docReady(function(){n.ie?(r(a),s(a)):q(a)});g(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(f,i){function r(a){return!y.attr(a,"_ke_bookmark")}function s(a,b){for(var c in a)a.hasOwnProperty(c)&&(f.isString(a[c])?a[c]=a[c].replace(Q,function(a,c){return b[c]}):s(a[c],b))}function q(a,b){b&&(a=f.clone(a),s(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==c||I[c]?A.STYLE_BLOCK:N[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function g(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new B(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function d(a,b,c){var d=a.element;"*"==d&&(d="span");b=new F(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function l(a){var b=a.createBookmark(k),c=a.createIterator();c.enforceRealBlocks=k;c.enlargeBr=k;for(var e,f=a.document;e=c.getNextParagraph();){var g=d(this,f,
e),h=g,g="pre"==h.nodeName,i="pre"==e.nodeName,j=!g&&i;g&&!i?(i=e,j=i.html(),j=m(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),C.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(h[0]),h[0].outerHTML="<pre>"+j+"</pre>",h=new F(i.firstChild),h._4e_remove()):h.html(j)):j?h=u(n(e),h):e._4e_moveChildren(h);e[0].parentNode.replaceChild(h[0],e[0]);if(g&&(e=h,g=void 0,(g=e._4e_previousSourceNode(k,
y.ELEMENT_NODE))&&"pre"==g.nodeName()))h=m(g.html(),/\n$/,"")+"\n\n"+m(e.html(),/^\n/,""),C.ie?e[0].outerHTML="<pre>"+h+"</pre>":e.html(h),g._4e_remove()}a.moveToBookmark(b)}function m(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function n(a){var b=[];m(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function u(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=m(e,/^[ \t]*\n/,""),e=m(e,/\n$/,""),e=m(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
f=b.clone();f.html(e);c.appendChild(f[0])}return c}function o(a){var b=a.document;if(a.collapsed)b=d(this,b,void 0),a.insertNode(b),a.moveToPosition(b,H.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,f,g=L[c];g||(f=k,g=L.span);var i=a.createBookmark();a.enlarge(H.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),l=j.startNode,j=j.endNode,D=l,p;D&&D[0];){var m=v;if(y.equals(D,j))D=x,m=k;else{var n=D[0].nodeType,I=n==y.ELEMENT_NODE?D.nodeName():x;if(I&&D.attr("_ke_bookmark")){D=
D._4e_nextSourceNode(k);continue}if(!I||g[I]&&(D._4e_position(j)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(D))){var o=D.parent();if(o&&"a"==c&&o.nodeName()==c)n=d(this,b,void 0),o._4e_moveChildren(n),o[0].parentNode.replaceChild(n[0],o[0]),n._4e_mergeSiblings();else if(o&&o[0]&&((L[o.nodeName()]||L.span)[c]||f)&&(!e.parentRule||e.parentRule(o))){if(!p&&(!I||!L.$removeEmpty[I]||(D._4e_position(j)|
z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))p=new G(b),p.setStartBefore(D);if(n==y.TEXT_NODE||n==y.ELEMENT_NODE&&!D[0].childNodes.length){o=D;for(n=null;(m=!o.next(r,1))&&(n=o.parent())&&g[n.nodeName()]&&(n._4e_position(l)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(n));)o=n;p.setEndAfter(o)}}else m=
k}else m=k;D=D._4e_nextSourceNode()}if(m&&p&&!p.collapsed){for(var m=d(this,b,void 0),o=p.getCommonAncestor(),n={},I={},q,s=null,t;m&&o&&m[0]&&o[0];){if(o.nodeName()==c){for(q in e.attributes)if(e.attributes.hasOwnProperty(q)&&!I[q]&&(t=o.attr(s)))m.attr(q)==t?m.removeAttr(q):I[q]=1;for(s in e.styles)if(e.styles.hasOwnProperty(s)&&!n[s]&&(t=o.style(s)))m.style(s)==t?m.style(s,""):n[s]=1;if(!m._4e_hasAttributes()){m=x;break}}o=o.parent()}m?(m[0].appendChild(p.extractContents()),h(this,m),p.insertNode(m),
m._4e_mergeSiblings(),C.ie||m[0].normalize()):(m=new F(b.createElement("span")),m[0].appendChild(p.extractContents()),p.insertNode(m),h(this,m),m._4e_remove(!0));p=x}}l._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(H.SHRINK_TEXT)}}function w(a){a.enlarge(H.ENLARGE_ELEMENT);var d=a.createBookmark(),f=d.startNode;if(a.collapsed){for(var g=new D(f.parent()),h,k=0,j;k<g.elements.length&&(j=g.elements[k])&&!(j==g.block||j==g.blockLimit);k++)if(this.checkElementRemovable(j)){var i=a.checkBoundaryOfElement(j,
H.END),l=!i&&a.checkBoundaryOfElement(j,H.START);l||i?(h=j,h.match=l?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(i=c(this),b(j,i[j.nodeName()]||i["*"])):e(this,j))}if(h){j=f;for(k=0;;k++){i=g.elements[k];if(y.equals(i,h))break;else if(i.match)continue;else i=i.clone();i[0].appendChild(j[0]);j=i}j["start"==h.match?"insertBefore":"insertAfter"](h)}}else{var C=d.endNode,m=this,g=function(){for(var a=new D(f.parent()),b=new D(C.parent()),c=x,d=x,e=0;e<a.elements.length;e++){var g=
a.elements[e];if(g==a.block||g==a.blockLimit)break;m.checkElementRemovable(g)&&(c=g)}for(e=0;e<b.elements.length;e++){g=b.elements[e];if(g==b.block||g==b.blockLimit)break;m.checkElementRemovable(g)&&(d=g)}d&&C._4e_breakParent(d);c&&f._4e_breakParent(c)};g();for(h=new F(f[0].nextSibling);h[0]!==C[0];){k=h._4e_nextSourceNode();if(h[0]&&h[0].nodeType==y.ELEMENT_NODE&&this.checkElementRemovable(h)&&(h.nodeName()==this.element?e(this,h):(j=c(this),b(h,j[h.nodeName()]||j["*"])),k[0].nodeType==y.ELEMENT_NODE&&
k.contains(f)))g(),k=new F(f[0].nextSibling);h=k}}a.moveToBookmark(d)}function t(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function a(a,b){var c="";b!==v?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){f.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],g,h,j;"string"==typeof e?g=e.toLowerCase():(g=e.element?e.element.toLowerCase():a.element,h=e.attributes,j=e.styles);e=b[g]||(b[g]={});if(h){g=e.attributes=e.attributes||[];for(var k in h)h.hasOwnProperty(k)&&g.push([k.toLowerCase(),h[k]])}if(j){var e=e.styles=e.styles||[],i;for(i in j)j.hasOwnProperty(i)&&e.push([i.toLowerCase(),j[i]])}}}return b}function e(a,b){var d=a._.definition,e=c(a),g=f.merge(d.attributes,(e[b.nodeName()]||
e["*"]||{}).attributes),d=f.merge(d.styles,(e[b.nodeName()]||e["*"]||{}).styles),e=f.isEmptyObject(g)&&f.isEmptyObject(d),h;for(h in g)if(g.hasOwnProperty(h)&&!(("class"==h||a._.definition.fullMatch)&&b.attr(h)!=p(h,g[h])))e=e||!!b.hasAttr(h),b.removeAttr(h);for(var i in d)d.hasOwnProperty(i)&&!(a._.definition.fullMatch&&b.style(i)!=p(i,d[i],k))&&(e=e||!!b.style(i),b.style(i,""));j(b)}function p(a,b,c){var d=new F("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function h(a,d){for(var f=
c(a),g=d.all(a.element),h=g.length;0<=--h;)e(a,new F(g[h]));for(var j in f)if(f.hasOwnProperty(j)&&j!=a.element){g=d.all(j);for(h=g.length-1;0<=h;h--){var k=new F(g[h]);b(k,f[j])}}}function b(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],f;if(f=a.attr(e)){var g=d[c][1];(g===x||g.test&&g.test(f)||"string"==typeof g&&f==g)&&a[0].removeAttribute(e)}}if(d=b&&b.styles)for(c=0;c<d.length;c++)if(e=d[c][0],g=a.css(e)){var h=d[c][1];(h===x||h.test&&h.test(f)||"string"==typeof h&&
g==h)&&a.css(e,"")}j(a)}function j(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(k);b&&(b.nodeType==y.ELEMENT_NODE&&y._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==y.ELEMENT_NODE&&y._4e_mergeSiblings(c))}}var k=!0,v=!1,x=null,y=f.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},H=i.RANGE,B=i.Selection,z=i.POSITION,G=i.Range,F=f.Node,C=f.UA,D=i.ElementPath,I={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=i.XHTML_DTD,N={embed:1,hr:1,img:1,li:1,object:1,
ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;i.STYLE=A;q.prototype={apply:function(a){g.call(this,a,v)},remove:function(a){g.call(this,a,k)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?o:this.type==A.STYLE_BLOCK?l:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?w:x).call(this,a)},checkElementRemovable:function(b,d){if(!b)return v;var e=this._.definition,f;if(b.nodeName()==
this.element){if(!d&&!b._4e_hasAttributes())return k;var g=e._AC;if(g)e=g;else{var g={},h=0,j=e.attributes;if(j)for(var i in j)j.hasOwnProperty(i)&&(h++,g[i]=j[i]);if(j=q.getStyleText(e))g.style||h++,g.style=j;g._length=h;e=e._AC=g}if(e._length){for(var l in e)if("_length"!=l&&e.hasOwnProperty(l)){h=b.attr(l)||"";if("style"==l)a:{g=e[l];h=a(h,v);"string"==typeof g&&(g=t(g));"string"==typeof h&&(h=t(h));j=void 0;for(j in g)if(g.hasOwnProperty(j)&&!(j in h&&(h[j]==g[j]||"inherit"==g[j]||"inherit"==
h[j]))){g=v;break a}g=k}else g=e[l]==h;if(g){if(!d)return k}else if(d)return v}if(d)return k}else return k}l=c(this);if(l=l[b.nodeName()]||l["*"]){if(!(e=l.attributes)&&!(f=l.styles))return k;if(e)for(g=0;g<e.length;g++)if(l=e[g][0],l=b.attr(l))if(h=e[g][1],h===x||"string"==typeof h&&l==h||h.test&&h.test(l))return k;if(f)for(g=0;g<f.length;g++)if(l=b.css(f[g][0]))if(e=f[g][1],e===x||"string"==typeof e&&l==e||e.test&&e.test(l))return k}return v},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,k);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==A.STYLE_INLINE&&(y.equals(d,a.block)||y.equals(d,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||d.nodeName()in N)&&this.checkElementRemovable(d,k))return k}return v}};q.getStyleText=function(b){var c=b._ST;if(c)return c;var c=b.styles,d=b.attributes&&b.attributes.style||"",e="";d.length&&(d=d.replace(O,";"));for(var g in c)if(c.hasOwnProperty(g)){var f=c[g],h=(g+":"+f).replace(O,
";");"inherit"==f?e+=h:d+=h}d.length&&(d=a(d));return b._ST=d+e};return i.Style=q},{requires:["./base","./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(f){var i=f.Node,r=f.DOM,s=f.UA,q={debugUrl:function(g){var d=f.Config;d.debug||(g=g.replace(/\.(js|css)/i,"-min.$1"));-1==g.indexOf("?t")&&(g=-1!=g.indexOf("?")?g+"&":g+"?",g+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+g},lazyRun:function(g,d,f){var i=g[d],n=g[f];g[d]=function(){i.apply(this,arguments);g[d]=g[f];return n.apply(this,arguments)}},getXY:function(g,d,f,i){f=f.defaultView||f.parentWindow;g-=r.scrollLeft(f);d-=r.scrollTop(f);i&&(i=i.defaultView||
i.parentWindow,f!=i&&f.frameElement&&(i=r.offset(f.frameElement,void 0,i),g+=i.left,d+=i.top));return{left:g,top:d}},tryThese:function(g){for(var d,f=0,i=arguments.length;f<i;f++){var n=arguments[f];try{d=n();break}catch(q){}}return d},arrayCompare:function(g,d){if(!g&&!d)return!0;if(!g||!d||g.length!=d.length)return!1;for(var f=0;f<g.length;f++)if(g[f]!==d[f])return!1;return!0},clearAllMarkers:function(g){for(var d in g)g.hasOwnProperty(d)&&g[d]._4e_clearMarkers(g,!0,void 0)},ltrim:function(g){return g.replace(/^\s+/,
"")},rtrim:function(g){return g.replace(/\s+$/,"")},isNumber:function(g){return/^\d+(.\d+)?$/.test(f.trim(g))},verifyInputs:function(g){for(var d=0;d<g.length;d++){var l=new i(g[d]),m=f.trim(q.valInput(l)),n=l.attr("data-verify"),l=l.attr("data-warning");if(n&&!RegExp(n).test(m))return alert(l),!1}return!0},sourceDisable:function(g,d){g.on("sourceMode",d.disable,d);g.on("wysiwygMode",d.enable,d)},resetInput:function(g){var d=g.attr("placeholder");d&&s.ie?(g.addClass("ks-editor-input-tip"),g.val(d)):
s.ie||g.val("")},valInput:function(g,d){if(void 0===d)return g.hasClass("ks-editor-input-tip")?"":g.val();g.removeClass("ks-editor-input-tip");g.val(d)},placeholder:function(g,d){g.attr("placeholder",d);s.ie&&(g.on("blur",function(){f.trim(g.val())||(g.addClass("ks-editor-input-tip"),g.val(d))}),g.on("focus",function(){g.removeClass("ks-editor-input-tip");f.trim(g.val())==d&&g.val("")}))},htmlEncode:function(g){return!g?g:(""+g).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,
"&quot;")},normParams:function(g){var g=f.clone(g),d;for(d in g)if(g.hasOwnProperty(d)){var i=g[d];f.isFunction(i)&&(g[d]=i())}return g},map:function(g,d){for(var f=0;f<g.length;f++)g[f]=d(g[f]);return g},ieEngine:document.documentMode||s.ie,preventFocus:function(f){s.ie?f.unselectable(void 0):f.attr("onmousedown","return false;")},injectDom:function(g){f.mix(r,g);for(var d in g)g.hasOwnProperty(d)&&function(d){i.prototype[d]=function(){var m=[].slice.call(arguments,0);m.unshift(this[0]);return(m=
g[d].apply(null,m))&&(m.nodeType||f.isWindow(m))?new i(m):f.isArray(m)&&(m.__IS_NODELIST||m[0]&&m[0].nodeType)?new i(m):m}}(d)},addRes:function(){var g=this.__res=this.__res||[];g.push.apply(g,f.makeArray(arguments))},destroyRes:function(){for(var g=this.__res||[],d=0;d<g.length;d++){var i=g[d];f.isFunction(i)?i():i.destroy?i.destroy():i.remove&&i.remove()}this.__res=[]},getQueryCmd:function(f){return"query"+("-"+f).replace(/-(\w)/g,function(d,f){return f.toUpperCase()})+"Value"}};return f.Editor.Utils=
q},{requires:["./base"]});
KISSY.add("editor/core/walker",function(f,i){function r(a,c){if(this._.end)return l;var f,b=this.range,i,k=this.guard,m=this.type,q=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,b.trim(),b.collapsed))return this.end(),l;if(!a&&!this._.guardLTR){var r=b.endContainer[0],s=r.childNodes[b.endOffset];this._.guardLTR=function(a,b){return b&&(r==a||"body"==n.nodeName(a))?!1:a!=s}}if(a&&!this._.guardRTL){var t=b.startContainer[0],u=0<b.startOffset&&t.childNodes[b.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(t==a||"body"==n.nodeName(a))?!1:a!=u}}var w=a?this._.guardRTL:this._.guardLTR;i=k?function(a,b){return w(a,b)===d?d:k(a,b)}:w;this.current?f=this.current[q](d,m,i):a?(f=b.endContainer,0<b.endOffset?(f=new o(f[0].childNodes[b.endOffset-1]),i(f[0])===d&&(f=l)):f=i(f,g)===d?l:f._4e_previousSourceNode(g,m,i,void 0)):(f=b.startContainer,f=new o(f[0].childNodes[b.startOffset]),f.length?i(f[0])===d&&(f=l):f=i(b.startContainer,g)===d?l:b.startContainer._4e_nextSourceNode(g,
m,i,void 0));for(;f&&!this._.end;){this.current=f;if(!this.evaluator||this.evaluator(f[0])!==d){if(!c)return f}else if(c&&this.evaluator)return d;f=f[q](d,m,i)}this.end();return this.current=l}function s(a){for(var c,d=l;c=r.call(this,a);)d=c;return d}function q(a){this.range=a;this.guard=this.evaluator=l;this._={}}var g=!0,d=!1,l=null,m=f.UA,n=f.DOM,u=i.XHTML_DTD,o=f.Node;f.augment(q,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,g)},checkForward:function(){return r.call(this,
d,g)!==d},checkBackward:function(){return r.call(this,g,g)!==d},lastForward:function(){return s.call(this)},lastBackward:function(){return s.call(this,g)},reset:function(){delete this.current;this._={}},_iterator:r});f.mix(q,{blockBoundary:function(a){return function(c){return!(c.nodeType==n.ELEMENT_NODE&&n._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function d(a){return"span"==n.nodeName(a)&&n.attr(a,"_ke_bookmark")}return function(b){var f,g;f=b.nodeType==n.TEXT_NODE&&(g=b.parentNode)&&d(g);
f=a?f:f||d(b);return!!(c^f)}},whitespaces:function(a){return function(c){c=c.nodeType==n.TEXT_NODE&&!f.trim(c.nodeValue);return!!(a^c)}},invisible:function(a){var c=q.whitespaces();return function(d){d=c(d)||d.nodeType==n.ELEMENT_NODE&&!d.offsetHeight;return!!(a^d)}}});var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,t=q.whitespaces(),a=q.bookmark(),c=function(c){var d=n.nodeName(c);return a(c)||t(c)||1==c.nodeType&&d in u.$inline&&!(d in u.$empty)};i.Utils.injectDom({_4e_getBogus:function(a){a=new o(a);do a=
a._4e_previousSourceNode();while(a&&c(a[0]));return a&&(!m.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return i.Walker=q},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(f){var i=f.Editor,f=i.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};i.baseZIndex=function(f){return(i.Config.baseZIndex||1E4)+f};return f},{requires:["./base"]});
KISSY.add("editor",function(f,i,r,s,q,g,d,l,m,n,u){function o(a,c){var d=a.body;H(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=e)},50)},function(){a.designMode="off";x.attr(d,"contentEditable",b);x.attr(d,"contentEditable",e);!c&&o(a,1)})}function w(a){a.get("iframe");var c=a.get("textarea")[0],d=a.get("window")[0],e=a.get("document")[0];k.webkit&&(A.on(e,"click",function(a){var b=new y(a.target);f.inArray(b.nodeName(),
["input","select"])&&a.preventDefault()}),A.on(e,"mouseup",function(a){var b=new y(a.target);f.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(k.gecko||v||k.opera){var g;g=(new y('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);g.on("focus",function(){a.focus()});a.activateGecko=function(){k.gecko&&a.__iframeFocus&&g[0].focus()};a.on("destroy",function(){g.detach();g.remove()})}A.on(d,"focus",function(){k.gecko?o(e,b):k.opera&&
e.body.focus();a.notifySelectionChange()});if(k.gecko)A.on(e,"mousedown",function(){a.__iframeFocus||o(e,b)});if(v&&(A.on(e,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}}),"CSS1Compat"==e.compatMode)){var h={33:1,34:1};A.on(e,"keydown",function(b){b.keyCode in h&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(k.webkit)A.on(e,"mousedown",function(b){b=new y(b.target);f.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(k.gecko)A.on(e,"dragstart",function(a){var b=new y(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});s.add(a)}function t(a,b,c,d){var e="",g,h=r.debugUrl("theme/editor-iframe.css");for(g=0;g<c.length;g++)e+=f.substitute('<link href="{href}" rel="stylesheet" />',{href:c[g]});return f.substitute(B,{doctype:8===
j.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:h,style:b,data:d||"&nbsp;",script:a?'<script id="ke_active_script">'+(x.isCustomDomain()?'document.domain="'+j.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function a(a,b){function c(){h=g.document;a.__set("document",new y(h));a.__set("window",new y(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=t(a._UUID,a.get("customStyle"),a.get("customLink"),
b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(i){if(f.src=f.src,7>v){setTimeout(c,10);return}}c()}function c(b,c){var d=new y(z),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabIndex",k.webkit?-1:e.attr("tabIndex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(k.gecko&&!d.__loaded)d.on("load",function(){a(b,c)},b);else a(b,c)}var e=!0,p=p,h=f.all,b=!1,j=document,k=f.UA,v=k.ie,x=f.DOM,y=f.Node,A=f.Event,H=r.tryThese,B="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",
q=x.getEmptyIframeSrc(),z='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(q?' src="'+q+'"':"")+"</iframe>";f.mix(i,{SOURCE_MODE:0,WYSIWYG_MODE:1});var G=i.WYSIWYG_MODE;f.augment(i,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=h("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');
a=c.one(".ks-editor-textarea-wrap");this._UUID=f.guid();this.set({toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display","none");a.append(b);s.register(this)},renderUI:function(){l.init(this);m.init(this);n.init(this);u.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&
(c=e[0].form))x.on(c,"submit",b.sync,b),b.on("destroy",function(){x.detach(c,"submit",b.sync,b)});b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){var a=this.get("height");a&&this._uiSetHeight(a)},_uiSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",
a);b.css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("render"),e=b.get("iframe"),f=b.get("textarea");a==G?(d&&b.execCommand("save"),b.on("docReady",c=function(){d&&b.execCommand("save");b.detach("docReady",c)}),b._setData(f.val()),b.fire("wysiwygMode")):(f.val(b._getData(1,G)),f[0].focus(),f.show(),e.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();s.remove(this);
A.remove([a,a.documentElement,a.body,b[0]]);f.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},
execCommand:function(a){var b=this.__commands[a],c=f.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},queryCommandValue:function(a){return this.execCommand(r.getQueryCmd(a))},_getData:function(a,b){var c=this.htmlDataProcessor,d;b==p&&(b=this.get("mode"));d=b==G?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=f.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,
d=a;if(this.get("mode")!=G)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var e=this.get("document")[0];A.remove([e,e.documentElement,e.body,b]);a.remove()}c(this,d)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return t(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return i.Selection.getSelection(this.get("document")[0])},
focus:function(){var a=this.get("document")[0],b=x._getWin(a);k.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){x._getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);x.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){x.remove(x.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=
this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=x.query("link",b),c=0;c<b.length;c++)x.attr(b[c],"href")==a&&x.remove(b[c]);b=this.get("customLink")||[];a=f.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=
this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new i.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===G){this.focus();
var b,c=a.nodeName(),d=i.XHTML_DTD,f=d.$block[c],g=i.RANGE,h=(c=this.getSelection())&&c.getRanges(),j,k,l;if(h&&0!=h.length){this.execCommand("save");for(k=h.length-1;0<=k;k--)j=h[k],b=!k&&a||a.clone(e),j.insertNodeByDtd(b),l||(l=b);if(l)return j.moveToPosition(l,g.POSITION_AFTER_END),f&&(a=i.Walker.whitespaces(!0),(a=(l=l.next(a,1))&&l[0].nodeType==x.ELEMENT_NODE&&l.nodeName())&&d.$block[a]&&d[a]["#text"]&&j.moveToElementEditablePosition(l)),c.selectRanges([j]),this.focus(),b&&1==b[0].nodeType&&
b.scrollIntoView(p,!1),F.call(this),b}}},insertHtml:function(a,c){var d=this,e,f=d.get("document")[0];if(d.get("mode")===G){if(e=d.htmlDataProcessor)a=e.toDataFormat(a,c);if(k.webkit)(new y(a,null,f)).each(function(a){d.insertElement(a)});else{d.focus();d.execCommand("save");if(v){e=f.selection;"Control"==e.type&&e.clear();try{e.createRange().pasteHTML(a)}catch(g){}}else try{f.execCommand("inserthtml",b,a)}catch(h){setTimeout(function(){if(0==d.getSelection().getRanges().length){var c=new i.Range(f),
e=x.first(f.body,function(a){return 1==a.nodeType&&"br"!=x.nodeName(a)});e||(e=new y(f.createElement("p")),e._4e_appendBogus(p),f.body.appendChild(e[0]));c.setStartAt(e,i.RANGE.POSITION_AFTER_START);c.select()}f.execCommand("inserthtml",b,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);F.call(d)}}}});i._initIFrame=function(a){var c=s.getInstance(a),d=c.get("document")[0],a=d.getElementById("ke_active_script");x.remove(a);w(c);var f=d.body;v?(f.hideFocus=e,f.disabled=e,f.contentEditable=
e,f.removeAttribute("disabled")):setTimeout(function(){k.gecko||k.opera?f.contentEditable=e:k.webkit?f.parentNode.contentEditable=e:d.designMode="on"},0);if(k.gecko||k.opera){var g=d.documentElement;A.on(g,"mousedown",function(a){if(a.target==g){k.gecko&&o(d,b);c.activateGecko()}})}setTimeout(function(){v&&setTimeout(function(){if(d){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=1;c.fire("docReady");var a=c.get("disableObjectResizing"),
e=c.get("disableInlineTableEditing");if(a||e)try{d.execCommand("enableObjectResizing",b,!a);d.execCommand("enableInlineTableEditing",b,!e)}catch(g){A.on(f,v?"resizestart":"resize",function(b){var c=new y(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};var F=f.buffer(function(){this.execCommand("save")},50);return i},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/meta,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
