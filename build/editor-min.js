/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 16 15:20
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(g,u,v,q){u=q.create(v.Controller,[q.Box],{initializer:function(){var g;this.__commands={};this.__dialogs={};if(g=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var r=g.next();r?this.__set("elBefore",r):this.__set("render",g.parent())}this.get("width")||this.__set("width",g.style("width")||g.css("width"));this.get("height")||this.__set("height",g.style("height")||g.css("height"))}else this.__editor_created_new=1},use:function(k,r){for(var p=
this,s=p.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],k=k.split(","),d=k.length-1;0<=d;d--)k[d]||k.splice(d,1);for(d=0;d<s.length;d++){var e=s[d];g.inArray(e,k)||k.unshift(e)}g.each(k,function(e,d){k[d]&&(k[d]="editor/plugin/"+e+"/")});g.use(k.join(","),function(){var e=g.makeArray(arguments);e.shift();for(var d=0;d<e.length;d++)e[d].init(p);r&&r.call(p)});p.__CORE_PLUGINS=[];return p}},{Config:{base:g.Config.base+"editor/"},XHTML_DTD:u.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(g){return this._setData(g)}},formatData:{getter:function(){return this._getData(1)},setter:function(g){return this._setData(g)}},prefixCls:{value:"ke-"}}},"Editor");u.DefaultRender=q.create(v.Render,[q.Box.Render],{_uiSetHeight:function(){}});g.mix(u,g.EventTarget);return KISSY.Editor=u},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(g){function u(b){this.editor=b;this._init()}function v(b){if(r.ie&&"BackCompat"!=b.get("document")[0].compatMode){var c=b.getSelection(),f;if(c.getType()==t.SELECTION_ELEMENT&&(f=c.getSelectedElement())){var a=c.getRanges()[0],h=new k(b.get("document")[0].createTextNode(""));h.insertBefore(f);a.setStartBefore(h);a.setEndAfter(f);c.selectRanges([a]);setTimeout(function(){f.parent()&&(h.remove(),c.selectElement(f))},0)}}}var q=g.Editor,k=g.Node,r=g.UA,
p=q.Range,s=q.RANGE,d=g.Event;g.augment(u,{_init:function(){var b=this.editor;d.on(b.get("document")[0].body,r.webkit?"paste":r.gecko?"paste":"beforepaste",this._paste,this);d.on(b.get("document")[0].body,"contextmenu",function(){c=1;setTimeout(function(){c=0},10)});b.addCommand("copy",new n("copy"));b.addCommand("cut",new n("cut"));b.addCommand("paste",new n("paste"))},_paste:function(){if(!c){var b=this.editor,l=b.get("document")[0];if(!l.getElementById("ke_pastebin")){var f=b.getSelection(),a=
new p(l),h=new k(r.webkit?"<body></body>":"<div></div>",null,l);h.attr("id","ke_pastebin");r.webkit&&h[0].appendChild(l.createTextNode("\u00a0"));l.body.appendChild(h[0]);h.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});h.css("left","-1000px");var j=f.createBookmarks();a.setStartAt(h,s.POSITION_AFTER_START);a.setEndAt(h,s.POSITION_BEFORE_END);a.select(!0);setTimeout(function(){h.remove();var a;h=r.webkit&&(a=h.first())&&a.hasClass("Apple-style-span")?
a:h;f.selectBookmarks(j);a=h.html();if(a=g.trim(a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var c=b.fire("paste",{html:a,holder:h});void 0!==c&&(a=c);c=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(a)&&(c=b.htmlDataProcessor.wordFilter);b.insertHtml(a,c)}},0)}}}});var e=function(b,c){var f=b.get("document")[0],a=new k(f.body),h=!1,j=function(){h=!0};a.on(c,j);(7<r.ie?f:f.selection.createRange()).execCommand(c);a.detach(c,j);return h},o=r.ie?function(b,c){return e(b,
c)}:function(b,c){try{return b.get("document")[0].execCommand(c)}catch(f){return!1}},m={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},n=function(b){this.type=b};n.prototype={exec:function(b){"cut"==this.type&&v(b);(b=o(b,this.type))||alert(m[this.type]);return b}};var t=q.Selection,b={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},c;q.on("contextmenu",function(c){var l=c.contextmenu,f=l.get("editor"),
a=l.menu.get("contentEl"),h={copy:0,cut:0,paste:0},j;for(j in h)h.hasOwnProperty(j)&&(h[j]=a.one(".ke-paste-"+j),h[j]||function(j){var c=(new k("<a href='#'class='ke-paste-"+j+"'>"+b[j]+"</a>")).appendTo(a);c.on("click",function(a){a.halt();l.hide();setTimeout(function(){f.execCommand(j)},30)});h[j]=c}(j))});return{init:function(b){b.docReady(function(){new u(b)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(g){function u(b,c){var i=b[c?"next":"prev"]();if(i&&i[0].nodeType==e.NODE_ELEMENT){for(var l=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemovable(v);)if(l.push(i),i=c?i.next():i.prev(),!i)return;if(b._4e_isIdentical(i,v)){for(var f=new p(c?b[0].lastChild:b[0].firstChild);l.length;)l.shift()._4e_move(b,!c,v);i._4e_moveChildren(b,!c,v);i.remove();f[0]&&f[0].nodeType==e.NODE_ELEMENT&&f._4e_mergeSiblings()}}}var v=v,q=g.Editor,k=g.DOM,r=g.UA,p=g.Node,s=q.Utils,
d={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};q.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var e=q.NODE,o=q.POSITION,m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},n={hr:1},t=function(b){return b&&(b[0]||b)};s.injectDom({_4e_isBlockBoundary:function(b,c){var i=g.merge(n,c);return!(!m[k.css(b,"display")]&&!i[k.nodeName(b)])},_4e_getWin:k._getWin,_4e_index:function(b,c){for(var i=b.parentNode.childNodes,l,f=-1,a=0;a<i.length;a++)if(l=i[a],!c||!(3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType))if(f++,l===b)return f;return-1},_4e_move:function(b,
c,i){c=t(c);i?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4e_isIdentical:function(b,c){if(!c)return!1;c=t(c);if(k.nodeName(b)!=k.nodeName(c))return!1;var i=b.attributes,l=c.attributes,f=i.length,a=l.length;if(f!=a)return!1;for(var h=0;h<f;h++){var j=i[h],w=j.name;if(j.specified&&k.attr(b,w)!=k.attr(c,w))return!1}if(8>s.ieEngine)for(h=0;h<a;h++)if(j=l[h],w=j.name,j.specified&&k.attr(b,w)!=k.attr(c,w))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){for(var b=b.childNodes,c=0,i=b.length;c<
i;c++){var l=b[c],f=l.nodeType;if(!(f==e.NODE_ELEMENT&&l.getAttribute("_ke_bookmark"))&&(f==e.NODE_ELEMENT&&!k._4e_isEmptyInlineRemovable(l)||f==e.NODE_TEXT&&g.trim(l.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,c,i){c=t(c);if(b!=c)if(i)for(;i=b.lastChild;)c.insertBefore(b.removeChild(i),c.firstChild);else for(;i=b.firstChild;)c.appendChild(b.removeChild(i))},_4e_mergeSiblings:function(b){b=new p(b);d[b.nodeName()]&&(u(b,!0),u(b))},_4e_splitText:function(b,c){var i=b.ownerDocument;if(b.nodeType==
e.NODE_TEXT){if(r.ie&&c==b.nodeValue.length){var l=i.createTextNode("");k.insertAfter(l,b);return l}l=b.splitText(c);i.documentMode&&(i=i.createTextNode(""),k.insertAfter(i,l),k.remove(i));return l}},_4e_parents:function(b,c){var i=[];i.__IS_NODELIST=1;do i[c?"push":"unshift"](b);while(b=b.parentNode);return i},_4e_nextSourceNode:function(b,c,i,l){if(l&&!l.call)var f=t(l),l=function(a){return a!==f};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType==e.NODE_ELEMENT&&l&&!1===l(b,!0))return null;c=b.nextSibling}for(;!c&&
(a=a.parentNode);){if(l&&!1===l(a,!0))return null;c=a.nextSibling}return!c||l&&!1===l(c)?null:i&&i!=c.nodeType?k._4e_nextSourceNode(c,!1,i,l):c},_4e_previousSourceNode:function(b,c,i,l){if(l&&!l.call)var f=t(l),l=function(a){return a!==f};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType==e.NODE_ELEMENT&&l&&!1===l(b,!0))return null;c=b.previousSibling}for(;!c&&(a=a.parentNode);){if(l&&!1===l(a,!0))return null;c=a.previousSibling}return!c||l&&!1===l(c)?null:i&&c.nodeType!=i?k._4e_previousSourceNode(c,
!1,i,l):c},_4e_commonAncestor:function(b,c){c=t(c);if(b===c)return b;if(k.contains(c,b))return c;var i=b;do if(k.contains(i,c))return i;while(i=i.parentNode);return null},_4e_hasAttributes:9>s.ieEngine?function(b){for(var c=b.attributes,i=0;i<c.length;i++){var l=c[i];switch(l.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(l.specified)return!0}}return!1}:function(b){r.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4e_position:function(b,c){var i=t(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(i);
if(b==i)return o.POSITION_IDENTICAL;if(b.nodeType==e.NODE_ELEMENT&&i.nodeType==e.NODE_ELEMENT){if(k.contains(b,i))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(k.contains(i,b))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>i.sourceIndex?o.POSITION_DISCONNECTED:b.sourceIndex<i.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var l=k._4e_address(b),i=k._4e_address(i),f=Math.min(l.length,i.length),a=0;a<=f-1;a++)if(l[a]!=i[a])return l[a]<
i[a]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return l.length<i.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(b,c){for(var i=[],l=b.ownerDocument.documentElement,f=b;f&&f!=l;)i.unshift(k._4e_index(f,c)),f=f.parentNode;return i},_4e_remove:function(b,c){var i=b.parentNode;if(i){if(c)for(var l;l=b.firstChild;)i.insertBefore(b.removeChild(l),b);i.removeChild(b)}return b},_4e_trim:function(b){k._4e_ltrim(b);k._4e_rtrim(b)},_4e_ltrim:function(b){for(var c;c=
b.firstChild;){if(c.nodeType==e.NODE_TEXT){var i=s.ltrim(c.nodeValue),l=c.nodeValue.length;if(i)i.length<l&&(k._4e_splitText(c,l-i.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){for(var c;c=b.lastChild;){if(c.type==e.NODE_TEXT){var i=s.rtrim(c.nodeValue),l=c.nodeValue.length;if(i)i.length<l&&(k._4e_splitText(c,i.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!r.ie&&!r.opera&&(c=b.lastChild)&&1==c.nodeType&&"br"==k.nodeName(c)&&
b.removeChild(c)},_4e_appendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType==e.NODE_TEXT&&!g.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==e.NODE_TEXT||"br"!==k.nodeName(c))c=r.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),r.gecko&&c.setAttribute("type","_moz"),b.appendChild(c)},_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");c.appendChild(b.cloneNode(!0));return c.innerHTML},
_4e_setMarker:function(b,c,i,l){var b=new p(b),f=b.data("list_marker_id")||b.data("list_marker_id",g.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[f]=b;a[i]=1;return b.data(i,l)},_4e_clearMarkers:function(b,c,i){var b=new p(b),l=b.data("list_marker_names"),f=b.data("list_marker_id"),a;for(a in l)l.hasOwnProperty(a)&&b.removeData(a);b.removeData("list_marker_names");i&&(b.removeData("list_marker_id"),delete c[f])},_4e_copyAttributes:function(b,
c,i){for(var c=new p(c),l=b.attributes,i=i||{},f=0;f<l.length;f++){var a=l[f],h=a.name.toLowerCase(),j;if(!(h in i))if("checked"==h&&(j=k.attr(b,h)))c.attr(h,j);else if(a.specified||r.ie&&a.value&&"value"==h)j=k.attr(b,h),null===j&&(j=a.nodeValue),c.attr(h,j)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){var b=k.nodeName(b),c=q.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(g){function u(b){1>arguments.length||(this.range=b,this.forceBrBreak=q,this.enlargeBr=v,this.enforceRealBlocks=q,this._||(this._={}))}var v=!0,q=!1,k=g.Editor,r=g.UA,p=k.Walker,s=k.Range,d=k.RANGE,e=k.NODE,o=k.ElementPath,m=g.Node,n=g.DOM,t=/^[\r\n\t ]*$/;g.augment(u,{getNextParagraph:function(b){var c,i,l,f,a;if(!this._.lastNode){i=this.range.clone();i.shrink(d.SHRINK_ELEMENT,v);i.enlarge(this.forceBrBreak||!this.enlargeBr?d.ENLARGE_LIST_ITEM_CONTENTS:
d.ENLARGE_BLOCK_CONTENTS);var h=new p(i),j=p.bookmark(v,v);h.evaluator=j;this._.nextNode=h.next();h=new p(i);h.evaluator=j;h=h.previous();this._.lastNode=h._4e_nextSourceNode(v);this._.lastNode&&this._.lastNode[0].nodeType==e.NODE_TEXT&&!g.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new s(i.document),j.moveToPosition(this._.lastNode,d.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new o(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(v)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new m(i.document.createTextNode("")),n.insertAfter(this._.lastNode[0],h[0]));i=null}j=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;j;){var w=q,x=j[0].nodeType!=e.NODE_ELEMENT,E=q;if(x)j[0].nodeType==e.NODE_TEXT&&t.test(j[0].nodeValue)&&(x=q);else{var k=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==k)x=v;else if(!i&&!j[0].childNodes.length&&"hr"!=k){c=j;l=j.equals(h);break}i&&(i.setEndAt(j,d.POSITION_BEFORE_START),
"br"!=k&&(this._.nextNode=j));w=v}else{if(j[0].firstChild){i||(i=new s(this.range.document),i.setStartAt(j,d.POSITION_BEFORE_START));j=new m(j[0].firstChild);continue}x=v}}x&&!i&&(i=new s(this.range.document),i.setStartAt(j,d.POSITION_BEFORE_START));l=(!w||x)&&j.equals(h);if(i&&!w)for(;!j[0].nextSibling&&!l;){k=j.parent();if(k._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){w=v;l||k.equals(h);break}j=k;x=v;l=j.equals(h);E=v}x&&i.setEndAt(j,d.POSITION_AFTER_END);j=j._4e_nextSourceNode(E,null,h);if((l=
!j)||w&&i)break}if(!c){if(!i)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new o(i.startContainer);j=c.blockLimit;w={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&w[j.nodeName()]&&i.checkStartOfBlock()&&i.checkEndOfBlock())c=j;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new m(this.range.document.createElement(b||"p")),c[0].appendChild(i.extractContents()),c._4e_trim(),i.insertNode(c),f=a=v;else if("li"!=c.nodeName()){if(!i.checkStartOfBlock()||
!i.checkEndOfBlock())c=c.clone(q),c[0].appendChild(i.extractContents()),c._4e_trim(),a=i.splitBlock(),f=!a.wasStartOfBlock,a=!a.wasEndOfBlock,i.insertNode(c)}else l||(this._.nextNode=c.equals(h)?null:i.getBoundaryNodes().endNode._4e_nextSourceNode(v,null,h))}f&&(i=new m(c[0].previousSibling),i[0]&&i[0].nodeType==e.NODE_ELEMENT&&("br"==i.nodeName()?i._4e_remove():i[0].lastChild&&"br"==n.nodeName(i[0].lastChild)&&n._4e_remove(i[0].lastChild)));a&&(i=p.bookmark(q,v),f=new m(c[0].lastChild),f[0]&&f[0].nodeType==
e.NODE_ELEMENT&&"br"==f.nodeName()&&(r.ie||f.prev(i)||f.next(i))&&f.remove());this._.nextNode||(this._.nextNode=l||c.equals(h)?null:c._4e_nextSourceNode(v,null,h));return c}});s.prototype.createIterator=function(){return new u(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(g){function u(e){for(var g=p,m=p,n=[];e;){if(e[0].nodeType==r.NODE_ELEMENT){this.lastElement||(this.lastElement=e);var t=e.nodeName();if(!m&&(!g&&s[t]&&(g=e),d[t])){var b;if(b=!g)if(b="div"==t){a:{b=e[0].childNodes;for(var c=0,i=b.length;c<i;c++){var l=b[c];if(l.nodeType==r.NODE_ELEMENT&&k.$block[l.nodeName.toLowerCase()]){b=!0;break a}}b=!1}b=!b}b?g=e:m=e}n.push(e);if("body"==t)break}e=e.parent()}this.block=g;this.blockLimit=m;this.elements=n}var v=g.Editor,
q=g.DOM,k=v.XHTML_DTD,r=v.NODE,p=null,s={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},d={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};u.prototype={compare:function(e){var d=this.elements,e=e&&e.elements;if(!e||d.length!=e.length)return!1;for(var m=0;m<d.length;m++)if(!q.equals(d[m],e[m]))return!1;return!0},contains:function(d){for(var g=this.elements,m=0;m<g.length;m++)if(g[m].nodeName()in d)return g[m];return p},toString:function(){var d=this.elements,
g,m=[];for(g=0;g<d.length;g++)m.push(d[g].nodeName());return m.toString()}};return v.ElementPath=u},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(g){function u(d){var n;n=d.getSelection().getRanges();for(var t=n.length-1;0<t;t--)n[t].deleteContents();n=n[0];t=n.document;if(n.checkStartOfBlock()&&n.checkEndOfBlock()){var b=(new o(n.startContainer)).block;if(b&&("li"==b.nodeName()||"li"==b.parent().nodeName()))return d.hasCommand("outdent")?(d.execCommand("save"),d.execCommand("outdent"),d.execCommand("save"),!0):!1}var c=n.splitBlock("p");if(!c)return!0;var d=c.previousBlock,b=c.nextBlock,i=
c.wasStartOfBlock,l=c.wasEndOfBlock,f;if(b)f=b.parent(),"li"==f.nodeName()&&(b._4e_breakParent(f),b._4e_move(b.next(),!0));else if(d&&(f=d.parent())&&"li"==f.nodeName())d._4e_breakParent(f),n.moveToElementEditablePosition(d.next()),d._4e_move(d.prev());if(!i&&!l){if("li"==b.nodeName()&&(f=b.first(e.invisible(!0)))&&g.inArray(f.nodeName(),["ul","ol"]))(k.ie?new s(t.createTextNode("\u00a0")):new s(t.createElement("br"))).insertBefore(f);b&&n.moveToElementEditablePosition(b)}else{var a;if(d){if("li"==d.nodeName()||
!r.test(d.nodeName()))a=d.clone()}else b&&(a=b.clone());a||(a=new s("<p>",null,t));if(f=c.elementPath)for(var c=0,h=f.elements.length;c<h;c++){var j=f.elements[c];if(j.equals(f.block)||j.equals(f.blockLimit))break;p.$removeEmpty[j.nodeName()]&&(j=j.clone(),a._4e_moveChildren(j),a.append(j))}k.ie||a._4e_appendBogus();n.insertNode(a);if(k.ie&&i&&(!l||!d[0].childNodes.length))n.moveToElementEditablePosition(l?d:a),n.select();n.moveToElementEditablePosition(i&&!l?b:a)}k.ie||(b?(a=new s(t.createElement("span")),
a.html("&nbsp;"),n.insertNode(a),a.scrollIntoView(void 0,!1),n.deleteContents()):a.scrollIntoView(void 0,!1));n.select();return!0}function v(e){var g=e.get("document")[0];d.on(g,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){e.execCommand("save");var b=e.execCommand("enterBlock");e.execCommand("save");!1!==b&&d.preventDefault()}})}var q=g.Editor,k=g.UA,r=/^h[1-6]$/,p=q.XHTML_DTD,s=g.Node,d=g.Event,e=q.Walker,o=q.ElementPath;return{init:function(d){d.addCommand("enterBlock",
{exec:u});d.docReady(function(){v(d)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(g){function u(){var g=this;g.__iframeFocus=e;d=g;s&&clearTimeout(s);s=setTimeout(function(){g.fire("focus")},100)}function v(){var e=this;e.__iframeFocus=o;d=m;s&&clearTimeout(s);s=setTimeout(function(){e.fire("blur")},100)}var q=g.Editor,k=g.DOM,r=g.Event,p={},s,d,g={refreshAll:function(){for(var d in p)if(p.hasOwnProperty(d)){var e=p[d].get("document")[0];e.designMode="off";e.designMode="on"}},currentInstance:function(){return d},getInstance:function(d){return p[d]},
add:function(d){var e=k._4e_getWin(d.get("document")[0]);r.on(e,"focus",u,d);r.on(e,"blur",v,d)},register:function(d){p[d._UUID]=d},remove:function(d){delete p[d._UUID];var e=k._4e_getWin(d.get("document")[0]);r.remove(e,"focus",u,d);r.remove(e,"blur",v,d)}},e=!0,o=!1,m=null;g.refreshAll=g.refreshAll;q.focusManager=g;q.getInstances=function(){return p};return g},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(g){return{init:function(u){function v(c){return c.replace(t,function(c,f,a){return"<"+f+a.replace(b,function(h,b){return-1==a.indexOf("_ke_saved_"+b)?" _ke_saved_"+h+" "+h:h})+">"})}function q(b){return b.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(b){return"<\!--"+c+"{C}"+encodeURIComponent(b).replace(/--/g,"%2D%2D")+"--\>"})}function k(b){return b.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(b,c){return decodeURIComponent(c)})}
var r=r,p=g.Editor,s=g.Node,d=g.UA,e=g.require("htmlparser"),o=new e.Filter,m=new e.Filter,n=new e.Filter;(function(){var b=function(a,h){return function(b,c){var f=[];(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,j,d){j=j.toLowerCase();"font-family"==j&&(d=d.replace(/["']/g,""));for(var F,e,i,l=0;l<a.length;l++)if(a[l]&&(b=a[l][0],F=a[l][1],e=a[l][2],i=a[l][3],j.match(b)&&(!F||d.match(F)))){j=i||j;h&&(e=e||d);"function"==typeof e&&(e=e(d,c,j));e&&e.push&&
(j=e[0],e=e[1]);"string"==typeof e&&f.push([j,e]);return}!h&&f.push([j,d])});for(var d=0;d<f.length;d++)f[d]=f[d].join(":");return f.length?f.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],r),l={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var b=a.nodeName||"";if(-1!=b.indexOf(":")&&
!/^ke/.test(b))if("v:imagedata"==b){if(b=a.getAttribute("o:href"))a.setAttribute("src",b),a.removeAttribute("o:href");if(b=a.getAttribute("o:title"))a.setAttribute("title",b),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=b(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],j,c=0;c<b.length;c++)j="_ke_saved_"+b[c],a.getAttribute(j)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var j=b.getAttribute("width"),b=b.getAttribute("height");j&&a.setAttribute("width",j);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!g.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,c.length)==c?(a="{C}"==a.substr(c.length,3)?a.substr(c.length+3):a.substr(c.length),new e.CData(decodeURIComponent(a))):a}};d.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});o.addRules(f);m.addRules(l);n.addRules(l)})();(function(){function b(a){for(var a=a.childNodes,h=a.length,j=a[h-1];j&&3==j.nodeType&&!g.trim(j.nodeValue);)j=a[--h];return j}
function c(a,h){var F=b(a);F&&((h||!d.ie)&&1==F.nodeType&&"br"==F.nodeName?a.removeChild(F):3==F.nodeType&&j.test(F.nodeValue)&&a.removeChild(F))}function f(a){var j=b(a);return!j||1==j.nodeType&&"br"==j.nodeName||"form"==a.nodeName&&"input"==j.nodeName}function a(a){c(a,!0);f(a)&&(d.ie?a.appendChild(new e.Text("\u00a0")):(a.appendChild(new e.Text("&nbsp;")),a.appendChild(new e.Tag("br"))))}function h(a){c(a,!1);f(a)&&a.appendChild(new e.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=p.XHTML_DTD,x=p.Utils.mix({},
w.$block,w.$listItem,w.$tableContent),k;for(k in x)x.hasOwnProperty(k)&&("br"in w[k]||delete x[k]);delete x.td;delete x.pre;var w={tags:{}},r={tags:{}};for(k in x)x.hasOwnProperty(k)&&(w.tags[k]=a,r.tags[k]=h);m.addRules(w);o.addRules(r);n.addRules(w)})();(function(){o.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}})})();var t=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}";u.htmlDataProcessor={wordFilter:n,
dataFilter:m,htmlFilter:o,toHtml:function(b){var c=new e.BeautifyWriter;(new e.Parser(b)).parse().writeHtml(c,o);return c.getHtml()},toDataFormat:function(b,c,f){f=f||m;d.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=v(b);c=new s("<div>");c.html("a"+b);b=c.html().substr(1);b=k(b);c=new e.BeautifyWriter;(new e.Parser(b)).parse().writeHtml(c,f);b=c.getHtml();return b=q(b)},toServer:function(b){var c=new e.MinifyWriter;(new e.Parser(b)).parse().writeHtml(c,
o);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(g,u,v,q,k){function r(a,h){var c=a.startContainer,f=a.endContainer,d=a.startOffset,e=a.endOffset,w,i=n,g=n,x=void 0,k=a.document,o;if(a.collapsed)return x;0<h&&(x=k.createDocumentFragment());a.optimizeBookmark();f[0].nodeType==b.NODE_TEXT?(g=m,f=f._4e_splitText(e)):0<f[0].childNodes.length&&(e>=f[0].childNodes.length?(f=new j(f[0].appendChild(k.createTextNode(""))),o=m):f=new j(f[0].childNodes[e]));c[0].nodeType==b.NODE_TEXT?(i=m,c._4e_splitText(d)):d?d>=c[0].childNodes.length?
(c=new j(c[0].appendChild(k.createTextNode(""))),w=m):c=new j(c[0].childNodes[d].previousSibling):(w=new j(k.createTextNode("")),c.prepend(w),c=w,w=m);var K=c._4e_parents(),E=f._4e_parents();K.each(function(a,b){K[b]=a});E.each(function(a,b){E[b]=a});for(var B,M,k=0;k<K.length&&!(B=K[k],M=E[k],!B.equals(M));k++);for(var d=x,y,N,O=k;O<K.length;O++){y=K[O];e=0<h&&!y.equals(c)?d.appendChild(y.clone()[0]):null;y=y[0].nextSibling;for(var r=f[0],s=E[O][0];y&&!(s==y||r==y);)N=y.nextSibling,2==h?d.appendChild(y.cloneNode(m)):
(l._4e_remove(y),1==h&&d.appendChild(y)),y=N;e&&(d=e)}for(d=x;k<E.length;k++){y=E[k];e=0<h&&!y.equals(f)?d.appendChild(y.clone()[0]):null;if(!K[k]||y[0].parentNode!=K[k][0].parentNode)for(y=y[0].previousSibling;y;)N=y.previousSibling,2==h?d.insertBefore(y.cloneNode(m),d.firstChild):(l._4e_remove(y),1==h&&d.insertBefore(y,d.firstChild)),y=N;e&&(d=e)}if(2==h){if(i&&(B=c[0],B.nodeType==b.NODE_TEXT&&B.nextSibling&&B.nextSibling.nodeType==b.NODE_TEXT&&(B.data+=B.nextSibling.data,B.parentNode.removeChild(B.nextSibling))),
g)g=f[0],g.nodeType==b.NODE_TEXT&&g.previousSibling&&g.previousSibling.nodeType==b.NODE_TEXT&&(g.previousSibling.data+=g.data,g.parentNode.removeChild(g))}else{if(B&&M&&(!c.parent().equals(B.parent())||!f.parent().equals(M.parent())))g=B._4e_index(),w&&B.parent().equals(w.parent())&&g--,a.setStart(B.parent(),g+1);a.collapse(m)}w&&c.remove();o&&f.remove();return x}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function s(a){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=t;this.collapsed=m;this.document=a}function d(a){var c=a.nodeType!=b.NODE_TEXT&&l.nodeName(a)in h.$removeEmpty,j=!g.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return c||j||a}function e(a){return!C(a)&&!I(a)}function o(h){var c=n,j=q.bookmark(m);return function(f){if(j(f))return m;if(f.nodeType==b.NODE_TEXT){if(g.trim(f.nodeValue).length)return n}else if(f.nodeType==b.NODE_ELEMENT&&(f=l.nodeName(f),!H[f]))if(!h&&!a.ie&&"br"==
f&&!c)c=m;else return n;return m}}u.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var m=!0,n=!1,t=null,b=u.NODE,c=u.RANGE,i=u.POSITION,l=g.DOM,f=v.getByAddress,a=g.UA,h=u.XHTML_DTD,j=g.Node,w=j.all,x={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},E=q.whitespaces(m);q.whitespaces();g.augment(s,{toString:function(){var a=
[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,c=this.startOffset;a[0].nodeType!=b.NODE_ELEMENT&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=b.NODE_ELEMENT&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),
a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,c){a[0].nodeType==b.NODE_ELEMENT&&x[a.nodeName()]&&
(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);p(this)},setEnd:function(a,c){a[0].nodeType==b.NODE_ELEMENT&&x[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+1);this.endContainer=a;this.endOffset=c;this.startContainer||(this.startContainer=a,this.startOffset=c);p(this)},setStartAt:function(a,h){switch(h){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setStart(a,
a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}p(this)},setEndAt:function(a,h){switch(h){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}p(this)},
cloneContents:function(){return r(this,2)},deleteContents:function(){return r(this,0)},extractContents:function(){return r(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=m},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=
this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=b.NODE_ELEMENT||a.endContainer[0].nodeType!=b.NODE_ELEMENT)return t;var c=new q(a),h=q.bookmark(!1,!0);c.evaluator=function(a){return E(a)&&h(a)};a=c.next();c.reset();c=c.previous();return a&&a.equals(c)?a:t},shrink:function(a,h){if(!this.collapsed){var a=a||c.SHRINK_TEXT,j=this.clone(),f=this.startContainer,d=this.endContainer,e=this.startOffset,w=this.endOffset,l=m,g,i,x=m;f&&f[0].nodeType==
b.NODE_TEXT&&(e?e>=f[0].nodeValue.length?j.setStartAfter(f):(j.setStartBefore(f),l=n):j.setStartBefore(f));d&&d[0].nodeType==b.NODE_TEXT&&(w?w>=d[0].nodeValue.length?j.setEndAfter(d):(j.setEndAfter(d),x=n):j.setEndBefore(d));if(l||x)i=new q(j),i.evaluator=function(h){return h.nodeType==(a==c.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)},i.guard=function(h,j){h=h[0]||h;if(a==c.SHRINK_ELEMENT&&h.nodeType==b.NODE_TEXT||j&&h==g)return n;!j&&h.nodeType==b.NODE_ELEMENT&&(g=h);return m};l&&(j=i[a==c.SHRINK_ELEMENT?
"lastForward":"next"]())&&this.setStartAt(j,h?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);x&&(i.reset(),(i=i[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,h?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return l||x}},createBookmark2:function(a){var c=this.startContainer,h=this.endContainer,f=this.startOffset,d=this.endOffset,e,w;if(!c||!h)return{start:0,end:0};if(a){if(c[0].nodeType==b.NODE_ELEMENT&&(e=new j(c[0].childNodes[f]))&&e[0]&&e[0].nodeType==b.NODE_TEXT&&0<f&&e[0].previousSibling.nodeType==
b.NODE_TEXT)c=e,f=0;for(;c[0].nodeType==b.NODE_TEXT&&(w=c.prev())&&w[0].nodeType==b.NODE_TEXT;)c=w,f+=w[0].nodeValue.length;if(!this.collapsed){if(h[0].nodeType==b.NODE_ELEMENT&&(e=new j(h[0].childNodes[d]))&&e[0]&&e[0].nodeType==b.NODE_TEXT&&0<d&&e[0].previousSibling.nodeType==b.NODE_TEXT)h=e,d=0;for(;h[0].nodeType==b.NODE_TEXT&&(w=h.prev())&&w[0].nodeType==b.NODE_TEXT;)h=w,d+=w[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?t:h._4e_address(a),startOffset:f,endOffset:d,normalized:a,
is2:m}},createBookmark:function(a){var b,h,f,d,e=this.collapsed;b=new j("<span>",t,this.document);b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");a&&(f=g.guid("ke_bm_"),b.attr("id",f+"S"));e||(h=b.clone(),h.html("&nbsp;"),a&&h.attr("id",f+"E"),d=this.clone(),d.collapse(),d.insertNode(h));d=this.clone();d.collapse(m);d.insertNode(b);h?(this.setStartAfter(b),this.setEndBefore(h)):this.moveToPosition(b,c.POSITION_AFTER_END);return{startNode:a?f+"S":b,endNode:a?f+"E":h,serializable:a,
collapsed:e}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(m)},trim:function(a,h){var c=this.startContainer,j=this.startOffset,f=this.collapsed;if((!a||f)&&c[0]&&c[0].nodeType==b.NODE_TEXT){if(j)if(j>=c[0].nodeValue.length)j=c._4e_index()+1,c=c.parent();else{var d=c._4e_splitText(j),j=c._4e_index()+1,c=c.parent();l.equals(this.startContainer,this.endContainer)?this.setEnd(d,this.endOffset-this.startOffset):l.equals(c,this.endContainer)&&(this.endOffset+=1)}else j=c._4e_index(),
c=c.parent();this.setStart(c,j);if(f){this.collapse(m);return}}c=this.endContainer;j=this.endOffset;!h&&!f&&c[0]&&c[0].nodeType==b.NODE_TEXT&&(j?(j>=c.nodeValue.length||c._4e_splitText(j),j=c._4e_index()+1):j=c._4e_index(),c=c.parent(),this.setEnd(c,j))},insertNode:function(a){this.optimizeBookmark();this.trim(n,m);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=
this.document;if(a.is2){var c=f(b,a.start,a.normalized),h=a.startOffset,b=a.end&&f(b,a.end,a.normalized),a=a.endOffset;this.setStart(c,h);b?this.setEnd(b,a):this.collapse(m)}else c=(h=a.serializable)?g.one("#"+a.startNode,b):a.startNode,a=h?g.one("#"+a.endNode,b):a.endNode,this.setStartBefore(c),c._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(m)},getCommonAncestor:function(a,c){var h=this.startContainer,f=this.endContainer,h=h[0]==f[0]?a&&h[0].nodeType==b.NODE_ELEMENT&&
this.startOffset==this.endOffset-1?new j(h[0].childNodes[this.startOffset]):h:h._4e_commonAncestor(f);return c&&h[0].nodeType==b.NODE_TEXT?h.parent():h},enlarge:function(){function a(b,c,h,j){var f=b[c?"startContainer":"endContainer"],d,e=c?0:1,i=0,g=c?"previousSibling":"nextSibling";d=b[c?"startOffset":"endOffset"];if(f[0].nodeType==l.TEXT_NODE){if(c){if(d)return}else if(d<f[0].nodeValue.length)return;d=f[0][g];f=f[0].parentNode}else d=f[0].childNodes[d+(c?-1:1)]||null,f=f[0];for(;f;){for(;d;)if(C(d))d=
d[g];else break;if(d){if(!i)b[c?"setStartAfter":"setEndBefore"](w(d));break}f=w(f);if("body"==f.nodeName())break;if(i||f.equals(j))h[e]=f,i=1;else b[c?"setStartBefore":"setEndAfter"](f);d=f[0][g];f=f[0].parentNode}}return function(b){switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),h=[];a(this,1,h,b);a(this,0,h,b);h[0]&&h[1]&&(b=h[0].contains(h[1])?h[1]:h[0],this.setStartBefore(b),this.setEndAfter(b));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var f=
new s(this.document),h=new j(this.document.body);f.setStartAt(h,c.POSITION_AFTER_START);f.setEnd(this.startContainer,this.startOffset);var f=new q(f),d,e,w=q.blockBoundary(b==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:t),i=function(a){var b=w(a);b||(d=new j(a));return b},g=function(a){var b=i(a);!b&&"br"==l.nodeName(a)&&(e=new j(a));return b};f.guard=i;f=f.lastBackward();d=d||h;this.setStartAt(d,"br"!=d.nodeName()&&(!f&&this.checkStartOfBlock()||f&&d.contains(f))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);
f=this.clone();f.collapse();f.setEndAt(h,c.POSITION_BEFORE_END);f=new q(f);f.guard=b==c.ENLARGE_LIST_ITEM_CONTENTS?g:i;d=t;f=f.lastForward();d=d||h;this.setEndAt(d,!f&&this.checkEndOfBlock()||f&&d.contains(f)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);e&&this.setEndAfter(e)}}}(),checkStartOfBlock:function(){var a=this.startContainer,h=this.startOffset;if(h&&a[0].nodeType==b.NODE_TEXT&&g.trim(a[0].nodeValue.substring(0,h)).length)return n;this.trim();a=new k(this.startContainer);h=this.clone();
h.collapse(m);h.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new q(h);a.evaluator=o(m);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,h=this.endOffset;if(a[0].nodeType==b.NODE_TEXT&&g.trim(a[0].nodeValue.substring(h)).length)return n;this.trim();a=new k(this.endContainer);h=this.clone();h.collapse(n);h.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new q(h);a.evaluator=o(n);return a.checkForward()},checkBoundaryOfElement:function(a,b){var h=this.clone();
h[b==c.START?"setStartAt":"setEndAt"](a,b==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);h=new q(h);h.evaluator=d;return h[b==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,h=this.endContainer,c=this.startOffset,f=this.endOffset,d;if(a[0].nodeType==b.NODE_ELEMENT)if(d=a[0].childNodes.length,d>c)a=new j(a[0].childNodes[c]);else if(1>d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new j(a);a=a._4e_nextSourceNode()||
a}if(h[0].nodeType==b.NODE_ELEMENT)if(d=h[0].childNodes.length,d>f)h=(new j(h[0].childNodes[f]))._4e_previousSourceNode(m);else if(1>d)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=new j(h)}a._4e_position(h)&i.POSITION_FOLLOWING&&(a=h);return{startNode:a,endNode:h}},fixBlock:function(b,h){var f=this.createBookmark(),d=new j(this.document.createElement(h));this.collapse(b);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();a.ie||
d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(f);return d},splitBlock:function(b){var h=new k(this.startContainer),f=new k(this.endContainer),j=h.block,d=f.block,e=t;if(!h.blockLimit.equals(f.blockLimit))return t;"br"!=b&&(j||(j=this.fixBlock(m,b),d=(new k(this.endContainer)).block),d||(d=this.fixBlock(n,b)));b=j&&this.checkStartOfBlock();h=d&&this.checkEndOfBlock();this.deleteContents();j&&l.equals(j,d)&&(h?(e=new k(this.startContainer),this.moveToPosition(d,c.POSITION_AFTER_END),d=
t):b?(e=new k(this.startContainer),this.moveToPosition(j,c.POSITION_BEFORE_START),j=t):(d=this.splitElement(j),!a.ie&&!g.inArray(j.nodeName(),["ul","ol"])&&j._4e_appendBogus()));return{previousBlock:j,nextBlock:d,wasStartOfBlock:b,wasEndOfBlock:h,elementPath:e}},splitElement:function(a){if(!this.collapsed)return t;this.setEndAt(a,c.POSITION_BEFORE_END);var b=this.extractContents(),h=a.clone(n);h[0].appendChild(b);h.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(a,
j){var f,d=h;if(d.$empty[a.nodeName()])return n;for(;a&&a[0].nodeType==b.NODE_ELEMENT;){if(f=a._4e_isEditable())this.moveToPosition(a,j?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);else if(d.$inline[a.nodeName()])return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),m;if((a=d.$empty[a.nodeName()]?a[j?"prev":"next"](e):j?a.last(e):a.first(e))&&a[0].nodeType==b.NODE_TEXT)return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),m}return f},selectNodeContents:function(a){this.setStart(a,
0);this.setEnd(a,a[0].nodeType==b.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},C=new q.whitespaces,I=new q.bookmark;u.Utils.injectDom({_4e_breakParent:function(a,b){var h=u.Range,b=new j(b),h=new h(a.ownerDocument);h.setStartAfter(new j(a));h.setEndAfter(b);var c=h.extractContents();h.insertNode(new j(l._4e_remove(a)));
a.parentNode.insertBefore(c,a.nextSibling)}});u.Range=s},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(g){function u(a){this.document=a;this._={cache:{}};if(n){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=k}}function v(a){a=new u(a);return!a||a.isInvalid?r:a}var q=g.Editor;q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var k=!0,r=null,p=g.UA,s=g.DOM,d=g.Node,e=q.SELECTION,o=q.RANGE,m=q.NODE,n=p.ie,t=q.Walker,b=q.Range,c={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};g.augment(u,{getNative:!n?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=s._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!n?function(){var a=this._.cache;if(a.type)return a.type;var b=e.SELECTION_TEXT,j=this.getNative();if(j){if(1==j.rangeCount){var j=j.getRangeAt(0),
f=j.startContainer;f==j.endContainer&&f.nodeType==m.NODE_ELEMENT&&1==Number(j.endOffset-j.startOffset)&&c[f.childNodes[j.startOffset].nodeName.toLowerCase()]&&(b=e.SELECTION_ELEMENT)}}else b=e.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=e.SELECTION_NONE;try{var c=this.getNative(),f=c.type;"Text"==f&&(b=e.SELECTION_TEXT);"Control"==f&&(b=e.SELECTION_ELEMENT);c.createRange().parentElement&&(b=e.SELECTION_TEXT)}catch(d){}return a.type=b},getRanges:n?function(){var a=
function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),f=c.childNodes,d,e=0;e<f.length;e++){var i=f[e];if(i.nodeType==m.NODE_ELEMENT){d=a.duplicate();d.moveToElementText(i);var i=d.compareEndPoints("StartToStart",a),l=d.compareEndPoints("EndToStart",a);d.collapse();if(0<i)break;else{if(!i||1==l&&-1==i)return{container:c,offset:e};if(!l)return{container:c,offset:e+1}}d=r}}d||(d=a.duplicate(),d.moveToElementText(c),d.collapse(!1));d.setEndPoint("StartToStart",a);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=f[--e].nodeValue.length}catch(g){d=0}return 0===d?{container:c,offset:e}:{container:f[e],offset:-d}};return function(h){var c=this._.cache;if(c.ranges&&!h)return c.ranges;var f=this.getNative(),h=f&&f.createRange(),i=this.getType();if(!f)return[];if(i==e.SELECTION_TEXT)return f=new b(this.document),i=a(h,k),f.setStart(new d(i.container),i.offset),i=a(h),f.setEnd(new d(i.container),i.offset),c.ranges=[f];if(i==e.SELECTION_ELEMENT){c=c.ranges=[];for(i=0;i<h.length;i++){for(var l=
h.item(i),g=l.parentNode,m=0,f=new b(this.document);m<g.childNodes.length&&g.childNodes[m]!=l;m++);f.setStart(new d(g),m);f.setEnd(new d(g),m+1);c.push(f)}return c}return c.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],f=this.getNative();if(!f)return[];for(var e=0;e<f.rangeCount;e++){var i=f.getRangeAt(e),l=new b(this.document);l.setStart(new d(i.startContainer),i.startOffset);l.setEnd(new d(i.endContainer),i.endOffset);a.push(l)}return c.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case e.SELECTION_ELEMENT:return this.getSelectedElement();case e.SELECTION_TEXT:var f=this.getRanges()[0];if(f&&!f.collapsed){for(f.optimize();k;)if(b=f.startContainer,f.startOffset==(b[0].nodeType===m.NODE_ELEMENT?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())f.setStartAfter(b);else break;b=f.startContainer;if(b[0].nodeType!=m.NODE_ELEMENT)return b.parent();b=new d(b[0].childNodes[f.startOffset]);
if(!b[0]||b[0].nodeType!=m.NODE_ELEMENT)return f.startContainer;for(f=b[0].firstChild;f&&f.nodeType==m.NODE_ELEMENT;)b=new d(f),f=f.firstChild;return b}if(n)f=c.createRange(),f.collapse(k),b=new d(f.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=m.NODE_ELEMENT)b=b.parentNode;b&&(b=new d(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;n&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];
for(var f,e,i=2;i&&(!(f=a.getEnclosedNode())||!(f[0].nodeType==m.NODE_ELEMENT&&c[f.nodeName()]&&(e=f)));i--)a.shrink(o.SHRINK_ELEMENT);a=e}return b.selectedElement=new d(a)},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(n)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(f){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);
this.reset()},selectRanges:function(a){if(n){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var f=a[c],d=this.document.createRange(),e=f.startContainer;if(f.collapsed&&(p.gecko&&1.09>p.gecko||p.opera||p.webkit)&&e[0].nodeType==m.NODE_ELEMENT&&!e[0].childNodes.length)e[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),f.startOffset++,f.endOffset++;
d.setStart(e[0],f.startOffset);d.setEnd(f.endContainer[0],f.endOffset);b.addRange(d)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),f=0;f<c.length;f++)b.push(c[f].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],f=this.document,d,b=b||this.getRanges(),e=b.length,i=0;i<e;i++){c.push(d=b[i].createBookmark(a,k));var l=(a=d.serializable)?g.one("#"+d.startNode,f):d.startNode;d=a?g.one("#"+d.endNode,f):d.endNode;for(var m=i+1;m<e;m++){var o=b[m],n=o.startContainer,
r=o.endContainer;s.equals(n,l.parent())&&o.startOffset++;s.equals(n,d.parent())&&o.startOffset++;s.equals(r,l.parent())&&o.endOffset++;s.equals(r,d.parent())&&o.endOffset++}}return c},selectBookmarks:function(a){for(var c=[],f=0;f<a.length;f++){var d=new b(this.document);d.moveToBookmark(a[f]);c.push(d)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();n?a&&a.clear():a&&a.removeAllRanges()}});var i={table:1,tbody:1,tr:1},l=t.whitespaces(k),f=/\ufeff|\u00a0/;b.prototype.select=b.prototype.select=!n?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==m.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(k),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=v(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,c,e;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var g=this.startContainer[0].childNodes[this.startOffset];if(g.nodeType==m.NODE_ELEMENT){(new u(this.document)).selectElement(new d(g));return}}(this.startContainer[0].nodeType==m.NODE_ELEMENT&&
this.startContainer.nodeName()in i||this.endContainer[0].nodeType==m.NODE_ELEMENT&&this.endContainer.nodeName()in i)&&this.shrink(o.SHRINK_ELEMENT,k);var n=this.createBookmark(),g=n.startNode,r;b||(r=n.endNode);n=this.document.body.createTextRange();n.moveToElementText(g[0]);n.moveStart("character",1);if(r)a=this.document.body.createTextRange(),a.moveToElementText(r[0]),n.setEndPoint("EndToEnd",a),n.moveEnd("character",-1);else{for(c=g[0].nextSibling;c&&!l(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(f))&&(a||!g[0].previousSibling||g[0].previousSibling&&"br"==s.nodeName(g[0].previousSibling));e=new d(this.document.createElement("span"));e.html("&#65279;");e.insertBefore(g);c&&s.insertBefore(this.document.createTextNode("\ufeff"),g[0]||g)}this.setStartBefore(g);g._4e_remove();if(b){if(c?(n.moveStart("character",-1),n.select(),this.document.selection.clear()):n.select(),e)this.moveToPosition(e,o.POSITION_BEFORE_START),e._4e_remove()}else this.setEndBefore(r),r._4e_remove(),n.select()};
u.getSelection=v;return q.Selection=u},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(g,u){function v(b){function c(a,b){var c=h.body.createTextRange();try{c.moveToPoint(a,b)}catch(f){c=d}return c}function e(){var a=h.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();o.remove(h,"mouseup",e);o.remove(h,"mousemove",g);j=f=0}function g(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",j)?a.setEndPoint("StartToStart",j):a.setEndPoint("EndToEnd",j),a.select()}else e()}var f,
a=b.get("iframe")[0].contentWindow,h=b.get("document")[0],j;o.on(h,"mousedown contextmenu",function(b){var d=h.documentElement;if(b.target===d&&(f&&e(),!(d.scrollHeight>d.clientHeight)&&(f=1,j=c(b.pageX,b.pageY))))o.on(h,"mouseup",e),o.on(h,"mousemove",g),a.focus(),j.select()})}function q(b){function c(f){if(h){var d=b.getSelection(),j=d&&d.getType(),g=d&&e.selection;if(f&&g&&j==n.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){c(p)},50);else{var l;if(!g||!g.type||!("Control"!=
g.type&&(l=g.createRange())&&(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))a=g&&d.getRanges()[0],b._monitor()}}}var e=b.get("document")[0],g=new m(e.body),f=new m(e.documentElement);if(8>u.Utils.ieEngine)f.on("click",function(a){"html"===(new m(a.target)).nodeName()&&b.getSelection().getNative().createRange().select()});var a,h,j=p;f.on("mousedown",function(){j=s});f.on("mouseup",function(){j=p});g.on("focusin",function(b){if("body"==(new m(b.target)).nodeName()&&a){try{j&&
a.select()}catch(c){}a=d}});g.on("focus",function(){h=p;c()});g.on("beforedeactivate",function(a){a.relatedTarget||(h=s,j=p)});g.on("mousedown",function(){h=s});g.on("mouseup",function(){h=p;setTimeout(function(){c(p)},0)});g.on("keydown",function(){h=s});g.on("keyup",function(){h=p;setTimeout(function(){c()},0)})}function k(b){var c=b.get("document")[0];o.on(c,"mouseup keyup",function(){b._monitor()})}function r(b){function c(a){var b=u.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function d(b){return a(b)&&h(b)}var g=b.get("document")[0],f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,a=u.Walker.whitespaces(p),h=u.Walker.bookmark(s,p),j=function(b){return a(b)&&8!=b.nodeType};b.on("selectionChange",function(a){var h=a.path,k=new m(b.get("document")[0].body),a=(a=a.selection)&&a.getRanges()[0],o=h.blockLimit;if(e.gecko){var n=h.block||h.blockLimit,r=n&&n.last(d);n&&n._4e_isBlockBoundary()&&
(!r||!(1==r[0].nodeType&&r._4e_isBlockBoundary()))&&"pre"!=n.nodeName()&&!n._4e_getBogus()&&n._4e_appendBogus()}if(a&&a.collapsed&&!h.block){if("body"==o.nodeName()){if((h=a.fixBlock(p,"p"))&&h[0]!=k[0].lastChild&&h._4e_outerHtml().match(f))if((o=h.next(j))&&o[0].nodeType==t.NODE_ELEMENT&&!c[o])a.moveToElementEditablePosition(o),h._4e_remove();else if((o=h.prev(j))&&o[0].nodeType==t.NODE_ELEMENT&&!c[o])a.moveToElementEditablePosition(o,o._4e_outerHtml().match(f)?s:p),h._4e_remove();a.select();b.notifySelectionChange()}h=
new u.Range(g);h.moveToElementEditablePosition(k,p);"body"!==(new u.ElementPath(h.startContainer)).blockLimit.nodeName()&&(k=(new m(g.createElement("p"))).appendTo(k),e.ie||k._4e_appendBogus())}})}var p=!0,s=!1,d=null,e=g.UA,o=g.Event,m=g.Node,n=u.SELECTION,t=u.NODE;return{init:function(b){b.docReady(function(){e.ie?(v(b),q(b)):k(b)});r(b)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(g){function u(a){return!H.attr(a,"_ke_bookmark")}function v(a,b){for(var c in a)a.hasOwnProperty(c)&&(g.isString(a[c])?a[c]=a[c].replace(T,function(a,c){return b[c]}):v(a[c],b))}function q(a,b){b&&(a=g.clone(a),v(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||P[c]?C.STYLE_BLOCK:Q[c]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:a}}function k(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var f=new F(a),d=f.getRanges(),h=0;h<d.length;h++)c.call(this,d[h]);f.selectRanges(d)}function r(a,b,c){var f=a.element;"*"==f&&(f="span");b=new D(b.createElement(f));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var d in a)a.hasOwnProperty(d)&&b.attr(d,a[d]);c&&(b[0].style.cssText=c);return b}function p(a){var b=a.createBookmark(j),c=a.createIterator();c.enforceRealBlocks=j;c.enlargeBr=j;for(var f,h=a.document;f=c.getNextParagraph();){var g=r(this,h,
f),i=g,g="pre"==i.nodeName,l="pre"==f.nodeName,k=!g&&l;g&&!l?(l=f,k=l.html(),k=s(k,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),k=k.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),k=k.replace(/([ \t\n\r]+|&nbsp;)/g," "),k=k.replace(/<br\b[^>]*>/gi,"\n"),A.ie?(l=l[0].ownerDocument.createElement("div"),l.appendChild(i[0]),i[0].outerHTML="<pre>"+k+"</pre>",i=new D(l.firstChild),i._4e_remove()):i.html(k)):k?i=e(d(f),i):f._4e_moveChildren(i);f[0].parentNode.replaceChild(i[0],f[0]);if(g&&(f=i,g=void 0,(g=f._4e_previousSourceNode(j,
J.NODE_ELEMENT))&&"pre"==g.nodeName()))i=s(g.html(),/\n$/,"")+"\n\n"+s(f.html(),/^\n/,""),A.ie?f[0].outerHTML="<pre>"+i+"</pre>":f.html(i),g._4e_remove()}a.moveToBookmark(b)}function s(a,b,c){var f="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(f=b);c&&(d=c);return""});return f+a.replace(b,c)+d}function d(a){var b=[];s(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function e(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),f=0;f<a.length;f++){var d=a[f],d=d.replace(/(\r\n|\r)/g,"\n"),d=s(d,/^[ \t]*\n/,""),d=s(d,/\n$/,""),d=s(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
h=b.clone();h.html(d);c.appendChild(h[0])}return c}function o(a){var b=a.document;if(a.collapsed)b=r(this,b,void 0),a.insertNode(b),a.moveToPosition(b,I.POSITION_BEFORE_END);else{var c=this.element,f=this._.definition,d,h=G[c];h||(d=j,h=G.span);var e=a.createBookmark();a.enlarge(I.ENLARGE_ELEMENT);a.trim();for(var g=a.createBookmark(),i=g.startNode,g=g.endNode,k=i,m;k&&k[0];){var o=w;if(H.equals(k,g))k=x,o=j;else{var n=k[0].nodeType,s=n==J.NODE_ELEMENT?k.nodeName():x;if(s&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(j);continue}if(!s||h[s]&&(k._4e_position(g)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(k))){var p=k.parent();if(p&&"a"==c&&p.nodeName()==c)n=r(this,b,void 0),p._4e_moveChildren(n),p[0].parentNode.replaceChild(n[0],p[0]),n._4e_mergeSiblings();else if(p&&p[0]&&((G[p.nodeName()]||G.span)[c]||d)&&(!f.parentRule||f.parentRule(p))){if(!m&&(!s||!G.$removeEmpty[s]||(k._4e_position(g)|
z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))m=new S(b),m.setStartBefore(k);if(n==J.NODE_TEXT||n==J.NODE_ELEMENT&&!k[0].childNodes.length){p=k;for(n=null;(o=!p.next(u))&&(n=p.parent())&&h[n.nodeName()]&&(n._4e_position(i)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(n));)p=n;m.setEndAfter(p)}}else o=
j}else o=j;k=k._4e_nextSourceNode()}if(o&&m&&!m.collapsed){for(var o=r(this,b,void 0),p=m.getCommonAncestor(),n={},s={},q,t=null,v;o&&p&&o[0]&&p[0];){if(p.nodeName()==c){for(q in f.attributes)if(f.attributes.hasOwnProperty(q)&&!s[q]&&(v=p.attr(t)))o.attr(q)==v?o.removeAttr(q):s[q]=1;for(t in f.styles)if(f.styles.hasOwnProperty(t)&&!n[t]&&(v=p.style(t)))o.style(t)==v?o.style(t,""):n[t]=1;if(!o._4e_hasAttributes()){o=x;break}}p=p.parent()}o?(o[0].appendChild(m.extractContents()),l(this,o),m.insertNode(o),
o._4e_mergeSiblings(),A.ie||o[0].normalize()):(o=new D(b.createElement("span")),o[0].appendChild(m.extractContents()),m.insertNode(o),l(this,o),o._4e_remove(!0));m=x}}i._4e_remove();g._4e_remove();a.moveToBookmark(e);a.shrink(I.SHRINK_TEXT)}}function m(a){a.enlarge(I.ENLARGE_ELEMENT);var d=a.createBookmark(),h=d.startNode;if(a.collapsed){for(var j=new L(h.parent()),e,g=0,i;g<j.elements.length&&(i=j.elements[g])&&!(i==j.block||i==j.blockLimit);g++)if(this.checkElementRemovable(i)){var l=a.checkBoundaryOfElement(i,
I.END),k=!l&&a.checkBoundaryOfElement(i,I.START);k||l?(e=i,e.match=k?"start":"end"):(i._4e_mergeSiblings(),i.nodeName()!=this.element?(l=b(this),f(i,l[i.nodeName()]||l["*"])):c(this,i))}if(e.length){i=h;for(g=0;;g++){l=j.elements[g];if(H.equals(l,e))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(i[0]);i=l}i["start"==e.match?"insertBefore":"insertAfter"](e)}}else{var o=d.endNode,m=this,j=function(){for(var a=new L(h.parent()),b=new L(o.parent()),c=x,f=x,d=0;d<a.elements.length;d++){var j=
a.elements[d];if(j==a.block||j==a.blockLimit)break;m.checkElementRemovable(j)&&(c=j)}for(d=0;d<b.elements.length;d++){j=b.elements[d];if(j==b.block||j==b.blockLimit)break;m.checkElementRemovable(j)&&(f=j)}f&&o._4e_breakParent(f);c&&h._4e_breakParent(c)};j();for(e=new D(h[0].nextSibling);e[0]!==o[0];){g=e._4e_nextSourceNode();if(e[0]&&e[0].nodeType==J.NODE_ELEMENT&&this.checkElementRemovable(e)&&(e.nodeName()==this.element?c(this,e):(i=b(this),f(e,i[e.nodeName()]||i["*"])),g[0].nodeType==J.NODE_ELEMENT&&
g.contains(h)))j(),g=new D(h[0].nextSibling);e=g}}a.moveToBookmark(d)}function n(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,f){b[c]=f});return b}function t(a,b){var c="";b!==w?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){g.isArray(c)||(c=[c]);for(var f=0;f<c.length;f++){var d=c[f],h,j,e;"string"==typeof d?h=d.toLowerCase():(h=d.element?d.element.toLowerCase():a.element,j=d.attributes,e=d.styles);d=b[h]||(b[h]={});if(j){h=d.attributes=d.attributes||[];for(var i in j)j.hasOwnProperty(i)&&h.push([i.toLowerCase(),j[i]])}if(e){var d=d.styles=d.styles||[],l;for(l in e)e.hasOwnProperty(l)&&d.push([l.toLowerCase(),e[l]])}}}return b}function c(c,f){var d=c._.definition,h=b(c),e=E.mix(d.attributes,(h[f.nodeName()]||h["*"]||
{}).attributes),d=E.mix(d.styles,(h[f.nodeName()]||h["*"]||{}).styles),h=g.isEmptyObject(e)&&g.isEmptyObject(d),l;for(l in e)if(e.hasOwnProperty(l)&&!(("class"==l||c._.definition.fullMatch)&&f.attr(l)!=i(l,e[l])))h=h||!!f.hasAttr(l),f.removeAttr(l);for(var k in d)d.hasOwnProperty(k)&&!(c._.definition.fullMatch&&f.style(k)!=i(k,d[k],j))&&(h=h||!!f.style(k),f.style(k,""));a(f)}function i(a,b,c){var f=new D("<span>");f[c?"style":"attr"](a,b);return f[c?"style":"attr"](a)}function l(a,d){for(var h=b(a),
j=d.all(a.element),e=j.length;0<=--e;)c(a,new D(j[e]));for(var g in h)if(h.hasOwnProperty(g)&&g!=a.element){j=d.all(g);for(e=j.length-1;0<=e;e--){var i=new D(j[e]);f(i,h[g])}}}function f(b,c){var f,d=c&&c.attributes;if(d)for(f=0;f<d.length;f++){var h=d[f][0],j;if(j=b.attr(h)){var e=d[f][1];(e===x||e.test&&e.test(j)||"string"==typeof e&&j==e)&&b[0].removeAttribute(h)}}if(d=c&&c.styles)for(f=0;f<d.length;f++)if(h=d[f][0],e=b.css(h)){var g=d[f][1];(g===x||g.test&&g.test(j)||"string"==typeof g&&e==g)&&
b.css(h,"")}a(b)}function a(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(j);b&&(b.nodeType==J.NODE_ELEMENT&&H._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==J.NODE_ELEMENT&&H._4e_mergeSiblings(c))}}var h=g.Editor,j=!0,w=!1,x=null,E=h.Utils,H=g.DOM,C={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},I=h.RANGE,F=h.Selection,J=h.NODE,z=h.POSITION,S=h.Range,D=g.Node,A=g.UA,L=h.ElementPath,P={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},G=h.XHTML_DTD,Q={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;h.STYLE=C;q.prototype={apply:function(a){k.call(this,a,w)},remove:function(a){k.call(this,a,j)},applyToRange:function(a){return(this.applyToRange=this.type==C.STYLE_INLINE?o:this.type==C.STYLE_BLOCK?p:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==C.STYLE_INLINE?m:x).call(this,a)},checkElementRemovable:function(a,c){if(!a)return w;var f=this._.definition,
d;if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return j;var h=f._AC;if(h)f=h;else{var h={},e=0,g=f.attributes;if(g)for(var i in g)g.hasOwnProperty(i)&&(e++,h[i]=g[i]);if(g=q.getStyleText(f))h.style||e++,h.style=g;h._length=e;f=f._AC=h}if(f._length){for(var l in f)if("_length"!=l&&f.hasOwnProperty(l)){e=a.attr(l)||"";if("style"==l)a:{h=f[l];e=t(e,w);"string"==typeof h&&(h=n(h));"string"==typeof e&&(e=n(e));g=void 0;for(g in h)if(h.hasOwnProperty(g)&&!(g in e&&(e[g]==h[g]||"inherit"==
h[g]||"inherit"==e[g]))){h=w;break a}h=j}else h=f[l]==e;if(h){if(!c)return j}else if(c)return w}if(c)return j}else return j}l=b(this);if(l=l[a.nodeName()]||l["*"]){if(!(f=l.attributes)&&!(d=l.styles))return j;if(f)for(h=0;h<f.length;h++)if(l=f[h][0],l=a.attr(l))if(e=f[h][1],e===x||"string"==typeof e&&l==e||e.test&&e.test(l))return j;if(d)for(h=0;h<d.length;h++)if(l=a.css(d[h][0]))if(f=d[h][1],f===x||"string"==typeof f&&l==f||f.test&&f.test(l))return j}return w},checkActive:function(a){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,j);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var b=a.elements,c=0,f;c<b.length;c++)if(f=b[c],!(this.type==C.STYLE_INLINE&&(H.equals(f,a.block)||H.equals(f,a.blockLimit))))if((this.type!=C.STYLE_OBJECT||f.nodeName()in Q)&&this.checkElementRemovable(f,j))return j}return w}};q.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",f="";c.length&&(c=c.replace(R,";"));for(var d in b)if(b.hasOwnProperty(d)){var h=b[d],e=(d+":"+h).replace(R,
";");"inherit"==h?f+=e:c+=e}c.length&&(c=t(c));return a._ST=c+f};h.Style=q},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(g){var u=g.Editor,v=null,q=g.Node,k=g.DOM,r=g.UA,p=g.Event,s={debugUrl:function(d){d=d.replace(/-min\.(js|css)/i,".$1");g.Config.debug||(d=d.replace(/\.(js|css)/i,"-min.$1"));-1==d.indexOf("?t")&&(d=-1!=d.indexOf("?")?d+"&":d+"?",d+="t="+encodeURIComponent("20120516152023"));g.startsWith(d,"/")&&(d=d.substring(1));return u.Config.base+d},lazyRun:function(d,e,g){var k=d[e],n=d[g];d[e]=function(){k.apply(this,arguments);d[e]=d[g];return n.apply(this,arguments)}},
getXY:function(d,e,g,m){g=g.defaultView||g.parentWindow;d-=k.scrollLeft(g);e-=k.scrollTop(g);m&&(m=m.defaultView||m.parentWindow,g!=m&&g.frameElement&&(m=k.offset(g.frameElement,void 0,m),d+=m.left,e+=m.top));return{left:d,top:e}},tryThese:function(d){for(var e,g=0,k=arguments.length;g<k;g++){var n=arguments[g];try{e=n();break}catch(p){}}return e},arrayCompare:function(d,e){if(!d&&!e)return!0;if(!d||!e||d.length!=e.length)return!1;for(var g=0;g<d.length;g++)if(d[g]!==e[g])return!1;return!0},getByAddress:function(d,
e,g){for(var d=d.documentElement,k=0;d&&k<e.length;k++){var n=e[k];if(g)for(var p=-1,b=0;b<d.childNodes.length;b++){var c=d.childNodes[b];if(!(!0===g&&3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType)&&(p++,p==n)){d=c;break}}else d=d.childNodes[n]}return d?new q(d):v},clearAllMarkers:function(d){for(var e in d)d.hasOwnProperty(e)&&d[e]._4e_clearMarkers(d,!0)},ltrim:function(d){return d.replace(/^\s+/,"")},rtrim:function(d){return d.replace(/\s+$/,"")},mix:function(d){for(var e={},k=
0;k<arguments.length;k++)e=g.mix(e,arguments[k]);return e},isCustomDomain:function(){if(!r.ie)return!1;var d=document.domain,e=window.location.hostname;return d!=e&&d!="["+e+"]"},isNumber:function(d){return/^\d+(.\d+)?$/.test(g.trim(d))},verifyInputs:function(d){for(var e=0;e<d.length;e++){var k=new q(d[e]),m=g.trim(s.valInput(k)),n=k.attr("data-verify"),k=k.attr("data-warning");if(n&&!RegExp(n).test(m))return alert(k),!1}return!0},sourceDisable:function(d,e){d.on("sourceMode",e.disable,e);d.on("wysiwygMode",
e.enable,e)},resetInput:function(d){var e=d.attr("placeholder");e&&r.ie?(d.addClass("ke-input-tip"),d.val(e)):r.ie||d.val("")},valInput:function(d,e){if(void 0===e)return d.hasClass("ke-input-tip")?"":d.val();d.removeClass("ke-input-tip");d.val(e)},placeholder:function(d,e){d.attr("placeholder",e);r.ie&&(d.on("blur",function(){g.trim(d.val())||(d.addClass("ke-input-tip"),d.val(e))}),d.on("focus",function(){d.removeClass("ke-input-tip");g.trim(d.val())==e&&d.val("")}))},htmlEncode:function(d){return!d?
d:(""+d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(d){var d=g.clone(d),e;for(e in d)if(d.hasOwnProperty(e)){var k=d[e];g.isFunction(k)&&(d[e]=k())}return d},doFormUpload:function(d,e,o){function m(){var b={responseText:"",responseXML:v};b.argument=d?d.argument:v;try{var a;if((a=r.ie?q.contentWindow.document:q.contentDocument||window.frames[n].document)&&a.body)b.responseText=g.trim(k.text(a.body));b.responseXML=a&&a.XMLDocument?a.XMLDocument:
a}catch(c){}p.remove(q,"load",m);d.callback&&d.callback(b);setTimeout(function(){k._4e_remove(q)},100)}var n=g.guid("form-upload-"),q=document.createElement("iframe");q.id=n;q.name=n;q.className="ke-hidden";var b="document.open();"+(s.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";r.ie&&(q.src=r.ie?"javascript:void(function(){"+encodeURIComponent(b)+"}())":"");document.body.appendChild(q);r.ie&&(document.frames[n].name=n);var b=d.form,c={target:k.attr(b,"target"),
method:k.attr(b,"method"),encoding:k.attr(b,"encoding"),enctype:k.attr(b,"enctype"),action:k.attr(b,"action")};k.attr(b,{target:n,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});o&&k.attr(b,"action",o);var i;if(e){i=[];var e=u.Utils.normParams(e),l;for(l in e)e.hasOwnProperty(l)&&(o=document.createElement("input"),o.type="hidden",o.name=l,o.value=e[l],b.appendChild(o),i.push(o))}p.on(q,"load",m);b.submit();k.attr(b,c);if(i){e=0;for(l=i.length;e<l;e++)k._4e_remove(i[e])}return q},
map:function(d,e){for(var g=0;g<d.length;g++)d[g]=e(d[g]);return d},ieEngine:document.documentMode||r.ie,preventFocus:function(d){r.ie?d.unselectable():d.attr("onmousedown","return false;")},injectDom:function(d){g.mix(k,d);for(var e in d)d.hasOwnProperty(e)&&function(e){q.prototype[e]=function(){var k=[].slice.call(arguments,0);k.unshift(this[0]);return(k=d[e].apply(v,k))&&(k.nodeType||g.isWindow(k))?new q(k):g.isArray(k)&&(k.__IS_NODELIST||k[0]&&k[0].nodeType)?new q(k):k}}(e)},addRes:function(){var d=
this.__res=this.__res||[];d.push.apply(d,g.makeArray(arguments))},destroyRes:function(){for(var d=this.__res||[],e=0;e<d.length;e++){var k=d[e];g.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(d,g){return g.toUpperCase()})+"Active"}};return u.Utils=s},{requires:["./base"]});
KISSY.add("editor/core/walker",function(g,u){function v(b,c){if(this._.end)return s;var a,d=this.range,e,g=this.guard,i=this.type,k=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,d.trim(),d.collapsed))return this.end(),s;if(!b&&!this._.guardLTR){var m=d.endContainer[0],q=m.childNodes[d.endOffset];this._.guardLTR=function(a,b){return b&&(m==a||"body"==o.nodeName(a))?!1:a!=q}}if(b&&!this._.guardRTL){var u=d.startContainer[0],t=0<d.startOffset&&u.childNodes[d.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(u==a||"body"==o.nodeName(a))?!1:a!=t}}var v=b?this._.guardRTL:this._.guardLTR;e=g?function(a,b){return v(a,b)===p?p:g(a,b)}:v;this.current?a=this.current[k](p,i,e):b?(a=d.endContainer,0<d.endOffset?(a=new n(a[0].childNodes[d.endOffset-1]),e(a)===p&&(a=s)):a=e(a,r)===p?s:a._4e_previousSourceNode(r,i,e,void 0)):(a=d.startContainer,a=new n(a[0].childNodes[d.startOffset]),a.length?e(a)===p&&(a=s):a=e(d.startContainer,r)===p?s:d.startContainer._4e_nextSourceNode(r,
i,e,void 0));for(;a&&!this._.end;){this.current=a;if(!this.evaluator||this.evaluator(a[0])!==p){if(!c)return a}else if(c&&this.evaluator)return p;a=a[k](p,i,e)}this.end();return this.current=s}function q(b){for(var c,a=s;c=v.call(this,b);)a=c;return a}function k(b){this.range=b;this._={}}var r=!0,p=!1,s=null,d=g.UA,e=u.NODE,o=g.DOM,m=u.XHTML_DTD,n=g.Node;g.augment(k,{end:function(){this._.end=1},next:function(){return v.call(this)},previous:function(){return v.call(this,r)},checkForward:function(){return v.call(this,
p,r)!==p},checkBackward:function(){return v.call(this,r,r)!==p},lastForward:function(){return q.call(this)},lastBackward:function(){return q.call(this,r)},reset:function(){delete this.current;this._={}},_iterator:v});k.blockBoundary=function(b){return function(c){return!(c.nodeType==e.NODE_ELEMENT&&o._4e_isBlockBoundary(c,b))}};k.bookmark=function(b,c){function a(a){return"span"==o.nodeName(a)&&o.attr(a,"_ke_bookmark")}return function(d){var j,g;j=d.nodeType==e.NODE_TEXT&&(g=d.parentNode)&&a(g);j=
b?j:j||a(d);return!!(c^j)}};k.whitespaces=function(b){return function(c){c=c.nodeType==e.NODE_TEXT&&!g.trim(c.nodeValue);return!!(b^c)}};k.invisible=function(b){var c=k.whitespaces();return function(a){a=c(a)||a.nodeType==e.NODE_ELEMENT&&!a.offsetHeight;return!!(b^a)}};var t=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,b=k.whitespaces(),c=k.bookmark(),i=function(d){var f=o.nodeName(d);return c(d)||b(d)||1==d.nodeType&&f in m.$inline&&!(f in m.$empty)};u.Utils.injectDom({_4e_getBogus:function(b){b=new n(b);do b=
b._4e_previousSourceNode();while(b&&i(b[0]));return b&&(!d.ie?"br"==b.nodeName():3==b[0].nodeType&&t.test(b.text()))?b[0]:!1}});return u.Walker=k},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(g){var u=g.Editor;u.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};u.baseZIndex=function(g){return(u.Config.baseZIndex||1E4)+g}},{requires:["./base"]});
KISSY.add("editor",function(g,u,v,q){function k(c,a){var d=c.body;b(function(){c.designMode="on";setTimeout(function(){c.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=r)},50)},function(){c.designMode="off";m.attr(d,"contentEditable",s);m.attr(d,"contentEditable",r);!a&&k(c,1)})}var r=!0,p=g.all,s=!1,d=document,e=g.UA,o=e.ie,m=g.DOM,n=g.Node,t=g.Event,b=v.tryThese,c="document.open();"+(v.isCustomDomain()?'document.domain="'+d.domain+'";':"")+"document.close();",i='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(o?' src="javascript:void(function(){'+encodeURIComponent(c)+'}())"':"")+' allowTransparency="true"></iframe>';g.mix(u,{SOURCE_MODE:0,WYSIWYG_MODE:1});var l=u.WYSIWYG_MODE;g.augment(u,{createDom:function(){var b=this.get("textarea"),a;b||this.set("textarea",b=p("<textarea></textarea>"));a=this.get("el");a.addClass(this.get("prefixCls")+"editor-wrap",void 0);a.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=g.guid();var c=
a.one(".ke-textarea-wrap");this.__set("iframeWrapEl",c);this.__set("toolBarEl",a.one(".ke-editor-tools"));this.__set("statusBarEl",a.one(".ke-editor-status"));var d=this.get("width"),e=this.get("height");a.css("width",d);b.css("width","100%");b.css("display","none");c.append(b);c.css("height",e);b.css("height",e);a.css("height","")},_uiSetHeight:function(b){this.get("iframeWrapEl").css("height",b);this.get("textarea").css("height",b)},_uiSetMode:function(b){var a=this.get("textarea");b?(this.execCommand("save"),
this._setData(a.val()),this.execCommand("save")):(a.val(this._getData(1,l)),a[0].focus());a[b?"hide":"show"]();this.get("iframe")[b?"show":"hide"]();this.fire((b?"wysiwyg":"source")+"Mode")},renderUI:function(){function b(){a.detach("docReady",b);if(a.get("focus"))a.focus();else{var c=a.getSelection();c&&c.removeAllRanges()}}var a=this,c=a.get("textarea");q.register(a);a.get("attachForm")&&c[0].form&&a._attachForm();a.on("docReady",b)},_createIframe:function(b){var a=this,c=new n(i),d=a.get("textarea");
d.hasAttr("tabindex")&&c.attr("tabIndex",e.webkit?-1:d.attr("tabIndex"));a.get("iframeWrapEl").prepend(c);a.set("iframe",c);a.__docReady=0;if(e.gecko&&!c.__loaded)c.on("load",function(){a._setUpIFrame(b)},a);else a._setUpIFrame(b)},destructor:function(){var b=this.get("el"),a=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();u.focusManager.remove(this);t.remove([c,c.documentElement,c.body,d]);g.each(this.__dialogs,function(a){a.destroy&&a.destroy()});
this.__commands=0;this.__editor_created_new||(a.insertBefore(b,void 0),a.css({width:this.get("width"),height:this.get("height")}),a.show())},_attachForm:function(){var b=this,a=b.get("textarea"),c=new n(a[0].form);c.on("submit",b.sync,b);b.on("destroy",function(){c.detach("submit",b.sync,b)})},addDialog:function(b,a){this.__dialogs[b]=a},showDialog:function(b,a){var c=this.__dialogs[b];c.show(a);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:b})},hasDialog:function(b){return!!this.__dialogs[b]},
addCommand:function(b,a){this.__commands[b]=a},hasCommand:function(b){return this.__commands[b]},execCommand:function(b){var a=this.__commands[b],c=g.makeArray(arguments);c.shift();c.unshift(this);if(a)return a.exec.apply(a,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var b=this.get("iframe"),a=b[0].contentWindow,c=this.get("document")[0];t.remove([c,c.documentElement,c.body,a]);b.remove()}},_getData:function(b,a){var c=this.htmlDataProcessor,d;void 0==a&&(a=this.get("mode"));d=a==
l?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=b?c.toHtml(d):c.toServer(d);d=g.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(b){var a,c=b;if(this.get("mode")!=l)this.get("textarea").val(b);else{if(a=this.htmlDataProcessor)c=a.toDataFormat(b,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(b){this.get("document")[0].body.innerHTML=b},_prepareIFrameHtml:function(b,a){var c=this.get("customStyle"),e=this.get("customLink"),g="",i=u.Utils.debugUrl("/theme/editor-iframe.css");if(e)for(var k=0;k<e.length;k++)g+='<link href="'+e[k]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===d.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+i+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+g+"</head><body class='ke-editor'>"+
(a||"&nbsp;")+(b?'<script id="ke_actscript" type="text/javascript">'+(v.isCustomDomain()?'document.domain="'+d.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return u.Selection.getSelection(this.get("document")[0])},focus:function(){var b=this.get("document")[0],a=m._4e_getWin(b);e.ie||a&&a.parent&&a.parent.focus();a&&a.focus();b.body.focus();this.notifySelectionChange()},blur:function(){m._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(b){var a=this.get("customStyle")||"",a=a+("\n"+b);this.set("customStyle",a);m.addStyleSheet(this.get("iframe")[0].contentWindow,a)},addCustomLink:function(b){var a=this.get("customLink")||[],c=this.get("document")[0];a.push(b);this.set("customLink",a);a=c.createElement("link");a.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(a);a.href=b},removeCustomLink:function(b){for(var a=this.get("document")[0],a=m.query("link",a),c=
0;c<a.length;c++)a[c].href==b&&m.remove(a[c]);a=this.get("customLink")||[];b=g.indexOf(b,a);-1!=b&&a.splice(b,1)},_setUpIFrame:function(b){function a(){i=g.document;c.__set("document",new n(i));c.__set("window",new n(g));d.detach();i.open("text/html","replace");i.write(e);i.close()}var c=this,d=c.get("iframe"),e=c._prepareIFrameHtml(c._UUID,b),g=d[0].contentWindow,i;d.__loaded=1;try{i=g.document}catch(k){if(d[0].src=d[0].src,7>o){setTimeout(a,10);return}}a()},docReady:function(b){this.on("docReady",
b);this.__docReady&&b.call(this)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var c=a.getStartElement(),d=new u.ElementPath(c);if(!b.__previousPath||!b.__previousPath.compare(d))b.__previousPath=d,b.fire("selectionChange",{selection:a,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(b,a,c){var d=this;if(d.get("mode")===
l){d.focus();var e,g=b.nodeName(),i=u.XHTML_DTD,k=u.RANGE,m=u.NODE,o=i.$block[g],p=d.getSelection(),q=p&&p.getRanges(),t,v,D,A;if(!q||0==q.length){var L=arguments,P=L.callee;setTimeout(function(){P.apply(d,L)},30)}else{d.execCommand("save");for(var G=q.length-1;0<=G;G--){t=q[G];t.deleteContents();e=!G&&b||b.clone(r);a&&a(e);if(o)for(;(D=t.getCommonAncestor(s,r))&&(A=i[D.nodeName()])&&(!A||!A[g]);)D.nodeName()in i.span?t.splitElement(D):t.checkStartOfBlock()&&t.checkEndOfBlock()?(t.setStartBefore(D),
t.collapse(r),D.remove()):t.splitBlock();t.insertNode(e);v||(v=e)}v&&(g=v._4e_nextSourceNode(r),i=d.get("document")[0],A=u.XHTML_DTD,A.$inline[e.nodeName()]?(g=new n(i.createTextNode(" ")),g.insertAfter(v)):g?"br"==g.nodeName()&&A[g.parent().nodeName()].p&&(A=new n("<p>&nbsp;</p>",null,i),g[0].parentNode.replaceChild(A[0],g[0]),g=A):(A=new n("<p>&nbsp;</p>",null,i),A.insertAfter(v),g=A),t.moveToPosition(v,k.POSITION_AFTER_END),g&&g[0].nodeType==m.NODE_ELEMENT&&t.moveToElementEditablePosition(g),p.selectRanges([t]),
d.focus(),e&&e.scrollIntoView(void 0,!1),d._saveLater(),c&&c(e))}}},insertHtml:function(b,a){var c=this,d;if(c.get("mode")===l){if(d=c.htmlDataProcessor)b=d.toDataFormat(b,null,a);c.focus();c.execCommand("save");var e=c.get("document")[0];d=0;if(o){var g=e.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(b)}catch(i){}}else try{e.execCommand("inserthtml",s,b)}catch(k){setTimeout(function(){if(0==c.getSelection().getRanges().length){var a=new u.Range(e),d=m.first(e.body,function(a){return 1==
a.nodeType&&"br"!=m.nodeName(a)});d||(d=new n(e.createElement("p")),e.body.appendChild(d[0]));a.setStartAt(d,u.RANGE.POSITION_AFTER_START);a.select()}e.execCommand("inserthtml",s,b)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);c._saveLater(d)}},_saveLater:function(b){var a=this;a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)},_fixByBindIframeDoc:function(){var b=this,a=b.get("iframe"),c=b.get("textarea")[0],
a=a[0].contentWindow,d=b.get("document")[0];e.webkit&&(t.on(d,"click",function(a){var b=new n(a.target);g.inArray(b.nodeName(),["input","select"])&&a.preventDefault()}),t.on(d,"mouseup",function(a){var b=new n(a.target);g.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(e.gecko||o||e.opera){var i;i=(new n('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);i.on("focus",function(){b.focus()});b.activateGecko=function(){e.gecko&&
b.__iframeFocus&&i[0].focus()};b.on("destroy",function(){i.detach();i.remove()})}t.on(a,"focus",function(){e.gecko?k(d,s):e.opera&&d.body.focus();b.notifySelectionChange()});if(e.gecko)t.on(d,"mousedown",function(){b.__iframeFocus||k(d,s)});if(o&&(t.on(d,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.fire("save");a.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var l=
{33:1,34:1};t.on(d,"keydown",function(a){a.keyCode in l&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}if(e.webkit)t.on(d,"mousedown",function(a){a=new n(a.target);g.inArray(a.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(a)});if(e.gecko)t.on(d,"dragstart",function(a){var b=new n(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});q.add(b)}});u._initIFrame=function(b){var a=q.getInstance(b),c=a.get("document")[0],
b=c.getElementById("ke_actscript");m.remove(b);a._fixByBindIframeDoc();var d=c.body;o?(d.hideFocus=r,d.disabled=r,d.contentEditable=r,d.removeAttribute("disabled")):setTimeout(function(){e.gecko||e.opera?d.contentEditable=r:e.webkit?d.parentNode.contentEditable=r:c.designMode="on"},0);if(e.gecko||e.opera){var g=c.documentElement;t.on(g,"mousedown",function(b){if(b.target==g){e.gecko&&k(c,s);a.activateGecko()}})}setTimeout(function(){o&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";
d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.__docReady=1;a.fire("docReady");var b=a.get("disableObjectResizing"),e=a.get("disableInlineTableEditing");if(b||e)try{c.execCommand("enableObjectResizing",s,!b);c.execCommand("enableInlineTableEditing",s,!e)}catch(f){t.on(d,o?"resizestart":"resize",function(a){var c=new n(a.target);(b||c.nodeName()==="table"&&e)&&a.preventDefault()})}},10)};return u},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
