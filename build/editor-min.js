/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 23 14:35
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(e,p,t,r){p=r.create(t.Controller,[r.Box],{initializer:function(){var e;this.__commands={};this.__dialogs={};if(e=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var p=e.next();p?this.__set("elBefore",p):this.__set("render",e.parent())}this.get("width")||this.__set("width",e.style("width")||e.css("width"));this.get("height")||this.__set("height",e.style("height")||e.css("height"))}else this.__editor_created_new=1},use:function(i,p){for(var a=
this,k=a.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],i=i.split(","),o=i.length-1;0<=o;o--)i[o]||i.splice(o,1);for(o=0;o<k.length;o++){var h=k[o];e.inArray(h,i)||i.unshift(h)}e.each(i,function(a,h){i[h]&&(i[h]="editor/plugin/"+a+"/")});e.use(i.join(","),function(){var h=e.makeArray(arguments);h.shift();for(var k=0;k<h.length;k++)h[k].init(a);p&&p.call(a)});a.__CORE_PLUGINS=[];return a}},{Config:{base:e.Config.base+"editor/"},XHTML_DTD:p.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(e){return this._setData(e)}},formatData:{getter:function(){return this._getData(1)},setter:function(e){return this._setData(e)}},prefixCls:{value:"ke-"}}},"Editor");p.DefaultRender=r.create(t.Render,[r.Box.Render],{_uiSetHeight:function(){}});e.mix(p,e.EventTarget);return KISSY.Editor=p},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(e){function p(c){this.editor=c;this._init()}function t(c){if(v.ie&&"BackCompat"!=c.get("document")[0].compatMode){var d=c.getSelection(),g;if(d.getType()==w.SELECTION_ELEMENT&&(g=d.getSelectedElement())){var b=d.getRanges()[0],f=new i(c.get("document")[0].createTextNode(""));f.insertBefore(g);b.setStartBefore(f);b.setEndAfter(g);d.selectRanges([b]);setTimeout(function(){g.parent()&&(f.remove(),d.selectElement(g))},0)}}}var r=e.Editor,i=e.Node,v=e.UA,
a=r.Range,k=r.RANGE,o=e.Event;e.augment(p,{_init:function(){var c=this.editor;o.on(c.get("document")[0].body,v.webkit?"paste":v.gecko?"paste":"beforepaste",this._paste,this);o.on(c.get("document")[0].body,"contextmenu",function(){d=1;setTimeout(function(){d=0},10)});c.addCommand("copy",new n("copy"));c.addCommand("cut",new n("cut"));c.addCommand("paste",new n("paste"))},_paste:function(){if(!d){var c=this.editor,l=c.get("document")[0];if(!l.getElementById("ke_pastebin")){var g=c.getSelection(),b=
new a(l),f=new i(v.webkit?"<body></body>":"<div></div>",null,l);f.attr("id","ke_pastebin");v.webkit&&f[0].appendChild(l.createTextNode("\u00a0"));l.body.appendChild(f[0]);f.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});f.css("left","-1000px");var j=g.createBookmarks();b.setStartAt(f,k.POSITION_AFTER_START);b.setEndAt(f,k.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){f.remove();var b;f=v.webkit&&(b=f.first())&&b.hasClass("Apple-style-span")?
b:f;g.selectBookmarks(j);b=f.html();if(b=e.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var d=c.fire("paste",{html:b,holder:f});void 0!==d&&(b=d);d=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)&&(d=c.htmlDataProcessor.wordFilter);c.insertHtml(b,d)}},0)}}}});var h=function(c,d){var g=c.get("document")[0],b=new i(g.body),f=!1,j=function(){f=!0};b.on(d,j);(7<v.ie?g:g.selection.createRange()).execCommand(d);b.detach(d,j);return f},s=v.ie?function(c,d){return h(c,
d)}:function(c,d){try{return c.get("document")[0].execCommand(d)}catch(g){return!1}},m={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},n=function(c){this.type=c};n.prototype={exec:function(c){"cut"==this.type&&t(c);(c=s(c,this.type))||alert(m[this.type]);return c}};var w=r.Selection,c={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},d;r.on("contextmenu",function(d){var a=d.contextmenu,g=a.get("editor"),
b=a.menu.get("contentEl"),f={copy:0,cut:0,paste:0},j;for(j in f)f.hasOwnProperty(j)&&(f[j]=b.one(".ke-paste-"+j),f[j]||function(j){var d=(new i("<a href='#'class='ke-paste-"+j+"'>"+c[j]+"</a>")).appendTo(b);d.on("click",function(b){b.halt();a.hide();setTimeout(function(){g.execCommand(j)},30)});f[j]=d}(j))});return{init:function(c){c.docReady(function(){new p(c)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(e){function p(c,d){var q=c[d?"next":"prev"]();if(q&&q[0].nodeType==h.NODE_ELEMENT){for(var l=[];q.attr("_ke_bookmark")||q._4e_isEmptyInlineRemovable(t);)if(l.push(q),q=d?q.next():q.prev(),!q)return;if(c._4e_isIdentical(q,t)){for(var g=new a(d?c[0].lastChild:c[0].firstChild);l.length;)l.shift()._4e_move(c,!d,t);q._4e_moveChildren(c,!d,t);q.remove();g[0]&&g[0].nodeType==h.NODE_ELEMENT&&g._4e_mergeSiblings()}}}var t=t,r=e.Editor,i=e.DOM,v=e.UA,a=e.Node,k=r.Utils,
o={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var h=r.NODE,s=r.POSITION,m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},n={hr:1},w=function(c){return c&&(c[0]||c)};k.injectDom({_4e_isBlockBoundary:function(c,d){var a=e.merge(n,d);return!(!m[i.css(c,"display")]&&!a[i.nodeName(c)])},_4e_getWin:i._getWin,_4e_index:function(c,d){for(var a=c.parentNode.childNodes,l,g=-1,b=0;b<a.length;b++)if(l=a[b],!d||!(3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType))if(g++,l===c)return g;return-1},_4e_move:function(c,
d,a){d=w(d);a?d.insertBefore(c,d.firstChild):d.appendChild(c)},_4e_isIdentical:function(c,d){if(!d)return!1;d=w(d);if(i.nodeName(c)!=i.nodeName(d))return!1;var a=c.attributes,l=d.attributes,g=a.length,b=l.length;if(g!=b)return!1;for(var f=0;f<g;f++){var j=a[f],u=j.name;if(j.specified&&i.attr(c,u)!=i.attr(d,u))return!1}if(8>k.ieEngine)for(f=0;f<b;f++)if(j=l[f],u=j.name,j.specified&&i.attr(c,u)!=i.attr(d,u))return!1;return!0},_4e_isEmptyInlineRemovable:function(c){for(var c=c.childNodes,d=0,a=c.length;d<
a;d++){var l=c[d],g=l.nodeType;if(!(g==h.NODE_ELEMENT&&l.getAttribute("_ke_bookmark"))&&(g==h.NODE_ELEMENT&&!i._4e_isEmptyInlineRemovable(l)||g==h.NODE_TEXT&&e.trim(l.nodeValue)))return!1}return!0},_4e_moveChildren:function(c,d,a){d=w(d);if(c!=d)if(a)for(;a=c.lastChild;)d.insertBefore(c.removeChild(a),d.firstChild);else for(;a=c.firstChild;)d.appendChild(c.removeChild(a))},_4e_mergeSiblings:function(c){c=new a(c);o[c.nodeName()]&&(p(c,!0),p(c))},_4e_splitText:function(c,d){var a=c.ownerDocument;if(c.nodeType==
h.NODE_TEXT){if(v.ie&&d==c.nodeValue.length){var l=a.createTextNode("");i.insertAfter(l,c);return l}l=c.splitText(d);a.documentMode&&(a=a.createTextNode(""),i.insertAfter(a,l),i.remove(a));return l}},_4e_parents:function(c,d){var a=[];a.__IS_NODELIST=1;do a[d?"push":"unshift"](c);while(c=c.parentNode);return a},_4e_nextSourceNode:function(c,d,a,l){if(l&&!l.call)var g=w(l),l=function(b){return b!==g};var d=!d&&c.firstChild,b=c;if(!d){if(c.nodeType==h.NODE_ELEMENT&&l&&!1===l(c,!0))return null;d=c.nextSibling}for(;!d&&
(b=b.parentNode);){if(l&&!1===l(b,!0))return null;d=b.nextSibling}return!d||l&&!1===l(d)?null:a&&a!=d.nodeType?i._4e_nextSourceNode(d,!1,a,l):d},_4e_previousSourceNode:function(c,d,a,l){if(l&&!l.call)var g=w(l),l=function(b){return b!==g};var d=!d&&c.lastChild,b=c;if(!d){if(c.nodeType==h.NODE_ELEMENT&&l&&!1===l(c,!0))return null;d=c.previousSibling}for(;!d&&(b=b.parentNode);){if(l&&!1===l(b,!0))return null;d=b.previousSibling}return!d||l&&!1===l(d)?null:a&&d.nodeType!=a?i._4e_previousSourceNode(d,
!1,a,l):d},_4e_commonAncestor:function(c,d){d=w(d);if(c===d)return c;if(i.contains(d,c))return d;var a=c;do if(i.contains(a,d))return a;while(a=a.parentNode);return null},_4e_hasAttributes:9>k.ieEngine?function(c){for(var d=c.attributes,a=0;a<d.length;a++){var l=d[a];switch(l.name){case "class":if(c.getAttribute("class"))return!0;break;default:if(l.specified)return!0}}return!1}:function(c){v.gecko&&c.removeAttribute("_moz_dirty");return c.hasAttributes()},_4e_position:function(c,d){var a=w(d);if(c.compareDocumentPosition)return c.compareDocumentPosition(a);
if(c==a)return s.POSITION_IDENTICAL;if(c.nodeType==h.NODE_ELEMENT&&a.nodeType==h.NODE_ELEMENT){if(i.contains(c,a))return s.POSITION_CONTAINS+s.POSITION_PRECEDING;if(i.contains(a,c))return s.POSITION_IS_CONTAINED+s.POSITION_FOLLOWING;if("sourceIndex"in c)return 0>c.sourceIndex||0>a.sourceIndex?s.POSITION_DISCONNECTED:c.sourceIndex<a.sourceIndex?s.POSITION_PRECEDING:s.POSITION_FOLLOWING}for(var l=i._4e_address(c),a=i._4e_address(a),g=Math.min(l.length,a.length),b=0;b<=g-1;b++)if(l[b]!=a[b])return l[b]<
a[b]?s.POSITION_PRECEDING:s.POSITION_FOLLOWING;return l.length<a.length?s.POSITION_CONTAINS+s.POSITION_PRECEDING:s.POSITION_IS_CONTAINED+s.POSITION_FOLLOWING},_4e_address:function(c,d){for(var a=[],l=c.ownerDocument.documentElement,g=c;g&&g!=l;)a.unshift(i._4e_index(g,d)),g=g.parentNode;return a},_4e_remove:function(c,d){var a=c.parentNode;if(a){if(d)for(var l;l=c.firstChild;)a.insertBefore(c.removeChild(l),c);a.removeChild(c)}return c},_4e_trim:function(c){i._4e_ltrim(c);i._4e_rtrim(c)},_4e_ltrim:function(c){for(var d;d=
c.firstChild;){if(d.nodeType==h.NODE_TEXT){var a=k.ltrim(d.nodeValue),l=d.nodeValue.length;if(a)a.length<l&&(i._4e_splitText(d,l-a.length),c.removeChild(c.firstChild));else{c.removeChild(d);continue}}break}},_4e_rtrim:function(c){for(var d;d=c.lastChild;){if(d.type==h.NODE_TEXT){var a=k.rtrim(d.nodeValue),l=d.nodeValue.length;if(a)a.length<l&&(i._4e_splitText(d,a.length),c.removeChild(c.lastChild));else{c.removeChild(d);continue}}break}!v.ie&&!v.opera&&(d=c.lastChild)&&1==d.nodeType&&"br"==i.nodeName(d)&&
c.removeChild(d)},_4e_appendBogus:function(c){for(var a=c.lastChild;a&&a.nodeType==h.NODE_TEXT&&!e.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==h.NODE_TEXT||"br"!==i.nodeName(a))a=v.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),v.gecko&&a.setAttribute("type","_moz"),c.appendChild(a)},_4e_outerHtml:function(c){if(c.outerHTML)return c.outerHTML.replace(/<\?[^>]*>/,"");var a=c.ownerDocument.createElement("div");a.appendChild(c.cloneNode(!0));return a.innerHTML},
_4e_setMarker:function(c,d,h,l){var c=new a(c),g=c.data("list_marker_id")||c.data("list_marker_id",e.guid()).data("list_marker_id"),b=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");d[g]=c;b[h]=1;return c.data(h,l)},_4e_clearMarkers:function(c,d,h){var c=new a(c),l=c.data("list_marker_names"),g=c.data("list_marker_id"),b;for(b in l)l.hasOwnProperty(b)&&c.removeData(b);c.removeData("list_marker_names");h&&(c.removeData("list_marker_id"),delete d[g])},_4e_copyAttributes:function(c,
d,h){for(var d=new a(d),l=c.attributes,h=h||{},g=0;g<l.length;g++){var b=l[g],f=b.name.toLowerCase(),j;if(!(f in h))if("checked"==f&&(j=i.attr(c,f)))d.attr(f,j);else if(b.specified||v.ie&&b.value&&"value"==f)j=i.attr(c,f),null===j&&(j=b.nodeValue),d.attr(f,j)}""!==c.style.cssText&&(d[0].style.cssText=c.style.cssText)},_4e_isEditable:function(c){var c=i.nodeName(c),a=r.XHTML_DTD;return(c=!a.$nonEditable[c]&&(a[c]||a.span))&&c["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(e){function p(c){1>arguments.length||(this.range=c,this.forceBrBreak=r,this.enlargeBr=t,this.enforceRealBlocks=r,this._||(this._={}))}var t=!0,r=!1,i=e.Editor,v=e.UA,a=i.Walker,k=i.Range,o=i.RANGE,h=i.NODE,s=i.ElementPath,m=e.Node,n=e.DOM,w=/^[\r\n\t ]*$/;e.augment(p,{getNextParagraph:function(c){var d,q,l,g,b;if(!this._.lastNode){q=this.range.clone();q.shrink(o.SHRINK_ELEMENT,t);q.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:
o.ENLARGE_BLOCK_CONTENTS);var f=new a(q),j=a.bookmark(t,t);f.evaluator=j;this._.nextNode=f.next();f=new a(q);f.evaluator=j;f=f.previous();this._.lastNode=f._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==h.NODE_TEXT&&!e.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new k(q.document),j.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new s(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(t)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new m(q.document.createTextNode("")),n.insertAfter(this._.lastNode[0],f[0]));q=null}j=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;j;){var u=r,x=j[0].nodeType!=h.NODE_ELEMENT,y=r;if(x)j[0].nodeType==h.NODE_TEXT&&w.test(j[0].nodeValue)&&(x=r);else{var i=j.nodeName();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==i)x=t;else if(!q&&!j[0].childNodes.length&&"hr"!=i){d=j;l=j.equals(f);break}q&&(q.setEndAt(j,o.POSITION_BEFORE_START),
"br"!=i&&(this._.nextNode=j));u=t}else{if(j[0].firstChild){q||(q=new k(this.range.document),q.setStartAt(j,o.POSITION_BEFORE_START));j=new m(j[0].firstChild);continue}x=t}}x&&!q&&(q=new k(this.range.document),q.setStartAt(j,o.POSITION_BEFORE_START));l=(!u||x)&&j.equals(f);if(q&&!u)for(;!j[0].nextSibling&&!l;){i=j.parent();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){u=t;l||i.equals(f);break}j=i;x=t;l=j.equals(f);y=t}x&&q.setEndAt(j,o.POSITION_AFTER_END);j=j._4e_nextSourceNode(y,null,f);if((l=
!j)||u&&q)break}if(!d){if(!q)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;d=new s(q.startContainer);j=d.blockLimit;u={div:1,th:1,td:1};d=d.block;if((!d||!d[0])&&!this.enforceRealBlocks&&u[j.nodeName()]&&q.checkStartOfBlock()&&q.checkEndOfBlock())d=j;else if(!d||this.enforceRealBlocks&&"li"==d.nodeName())d=new m(this.range.document.createElement(c||"p")),d[0].appendChild(q.extractContents()),d._4e_trim(),q.insertNode(d),g=b=t;else if("li"!=d.nodeName()){if(!q.checkStartOfBlock()||
!q.checkEndOfBlock())d=d.clone(r),d[0].appendChild(q.extractContents()),d._4e_trim(),b=q.splitBlock(),g=!b.wasStartOfBlock,b=!b.wasEndOfBlock,q.insertNode(d)}else l||(this._.nextNode=d.equals(f)?null:q.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,f))}g&&(q=new m(d[0].previousSibling),q[0]&&q[0].nodeType==h.NODE_ELEMENT&&("br"==q.nodeName()?q._4e_remove():q[0].lastChild&&"br"==n.nodeName(q[0].lastChild)&&n._4e_remove(q[0].lastChild)));b&&(q=a.bookmark(r,t),g=new m(d[0].lastChild),g[0]&&g[0].nodeType==
h.NODE_ELEMENT&&"br"==g.nodeName()&&(v.ie||g.prev(q)||g.next(q))&&g.remove());this._.nextNode||(this._.nextNode=l||d.equals(f)?null:d._4e_nextSourceNode(t,null,f));return d}});k.prototype.createIterator=function(){return new p(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(e){function p(h){for(var e=a,m=a,n=[];h;){if(h[0].nodeType==v.NODE_ELEMENT){this.lastElement||(this.lastElement=h);var p=h.nodeName();if(!m&&(!e&&k[p]&&(e=h),o[p])){var c;if(c=!e)if(c="div"==p){a:{c=h[0].childNodes;for(var d=0,q=c.length;d<q;d++){var l=c[d];if(l.nodeType==v.NODE_ELEMENT&&i.$block[l.nodeName.toLowerCase()]){c=!0;break a}}c=!1}c=!c}c?e=h:m=h}n.push(h);if("body"==p)break}h=h.parent()}this.block=e;this.blockLimit=m;this.elements=n}var t=e.Editor,
r=e.DOM,i=t.XHTML_DTD,v=t.NODE,a=null,k={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},o={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};p.prototype={compare:function(a){var e=this.elements,a=a&&a.elements;if(!a||e.length!=a.length)return!1;for(var k=0;k<e.length;k++)if(!r.equals(e[k],a[k]))return!1;return!0},contains:function(h){for(var e=this.elements,k=0;k<e.length;k++)if(e[k].nodeName()in h)return e[k];return a},toString:function(){var a=this.elements,
e,k=[];for(e=0;e<a.length;e++)k.push(a[e].nodeName());return k.toString()}};return t.ElementPath=p},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(e){function p(m){var n;n=m.getSelection().getRanges();for(var o=n.length-1;0<o;o--)n[o].deleteContents();n=n[0];o=n.document;if(n.checkStartOfBlock()&&n.checkEndOfBlock()){var c=(new s(n.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return m.hasCommand("outdent")?(m.execCommand("save"),m.execCommand("outdent"),m.execCommand("save"),!0):!1}var d=n.splitBlock("p");if(!d)return!0;var m=d.previousBlock,c=d.nextBlock,q=
d.wasStartOfBlock,l=d.wasEndOfBlock,g;if(c)g=c.parent(),"li"==g.nodeName()&&(c._4e_breakParent(g),c._4e_move(c.next(),!0));else if(m&&(g=m.parent())&&"li"==g.nodeName())m._4e_breakParent(g),n.moveToElementEditablePosition(m.next()),m._4e_move(m.prev());if(!q&&!l){if("li"==c.nodeName()&&(g=c.first(h.invisible(!0)))&&e.inArray(g.nodeName(),["ul","ol"]))(i.ie?new k(o.createTextNode("\u00a0")):new k(o.createElement("br"))).insertBefore(g);c&&n.moveToElementEditablePosition(c)}else{var b;if(m){if("li"==m.nodeName()||
!v.test(m.nodeName()))b=m.clone()}else c&&(b=c.clone());b||(b=new k("<p>",null,o));if(g=d.elementPath)for(var d=0,f=g.elements.length;d<f;d++){var j=g.elements[d];if(j.equals(g.block)||j.equals(g.blockLimit))break;a.$removeEmpty[j.nodeName()]&&(j=j.clone(),b._4e_moveChildren(j),b.append(j))}i.ie||b._4e_appendBogus();n.insertNode(b);if(i.ie&&q&&(!l||!m[0].childNodes.length))n.moveToElementEditablePosition(l?m:b),n.select();n.moveToElementEditablePosition(q&&!l?c:b)}i.ie||(c?(b=new k(o.createElement("span")),
b.html("&nbsp;"),n.insertNode(b),b.scrollIntoView(void 0,!1),n.deleteContents()):b.scrollIntoView(void 0,!1));n.select();return!0}function t(a){var e=a.get("document")[0];o.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&e.preventDefault()}})}var r=e.Editor,i=e.UA,v=/^h[1-6]$/,a=r.XHTML_DTD,k=e.Node,o=e.Event,h=r.Walker,s=r.ElementPath;return{init:function(a){a.addCommand("enterBlock",
{exec:p});a.docReady(function(){t(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(e){function p(){var a=this;a.__iframeFocus=h;o=a;k&&clearTimeout(k);k=setTimeout(function(){a.fire("focus")},100)}function t(){var a=this;a.__iframeFocus=s;o=m;k&&clearTimeout(k);k=setTimeout(function(){a.fire("blur")},100)}var r=e.Editor,i=e.DOM,v=e.Event,a={},k,o,e={refreshAll:function(){for(var e in a)if(a.hasOwnProperty(e)){var k=a[e].get("document")[0];k.designMode="off";k.designMode="on"}},currentInstance:function(){return o},getInstance:function(e){return a[e]},
add:function(a){var e=i._4e_getWin(a.get("document")[0]);v.on(e,"focus",p,a);v.on(e,"blur",t,a)},register:function(e){a[e._UUID]=e},remove:function(e){delete a[e._UUID];var k=i._4e_getWin(e.get("document")[0]);v.remove(k,"focus",p,e);v.remove(k,"blur",t,e)}},h=!0,s=!1,m=null;e.refreshAll=e.refreshAll;r.focusManager=e;r.getInstances=function(){return a};return e},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(e){return{init:function(p){function t(a){return a.replace(w,function(a,d,b){return"<"+d+b.replace(c,function(f,a){return-1==b.indexOf("_ke_saved_"+a)?" _ke_saved_"+f+" "+f:f})+">"})}function r(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+d+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function i(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,c){return decodeURIComponent(c)})}
var v=v,a=e.Editor,k=e.Node,o=e.UA,h=e.require("htmlparser"),s=new h.Filter,m=new h.Filter,n=new h.Filter;(function(){var a=function(b,a){return function(c,d){var g=[];(""+c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,j,e){j=j.toLowerCase();"font-family"==j&&(e=e.replace(/["']/g,""));for(var l,A,B,H=0;H<b.length;H++)if(b[H]&&(c=b[H][0],l=b[H][1],A=b[H][2],B=b[H][3],j.match(c)&&(!l||e.match(l)))){j=B||j;a&&(A=A||e);"function"==typeof A&&(A=A(e,d,j));A&&A.push&&
(j=A[0],A=A[1]);"string"==typeof A&&g.push([j,A]);return}!a&&g.push([j,e])});for(var e=0;e<g.length;e++)g[e]=g[e].join(":");return g.length?g.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],v),c={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(b){b.filterChildren()},tags:{p:function(b){b.filterChildren()},$:function(b){var a=b.nodeName||"";if(-1!=a.indexOf(":")&&
!/^ke/.test(a))if("v:imagedata"==a){if(a=b.getAttribute("o:href"))b.setAttribute("src",a),b.removeAttribute("o:href");if(a=b.getAttribute("o:title"))b.setAttribute("title",a),b.removeAttribute("o:title");b.setTagName("img")}else b.setTagName("")}},attributes:{"class":function(b){return!b||/(^|\s+)Mso/.test(b)?!1:b},style:function(b){b=a(b);return!b?!1:b}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(b){if(b.attributes.length)for(var a=
["name","href","src"],c,d=0;d<a.length;d++)c="_ke_saved_"+a[d],b.getAttribute(c)&&b.removeAttribute(a[d]);return b},embed:function(b){var a=b.parentNode;if(a&&"object"==a.nodeName){var c=a.getAttribute("width"),a=a.getAttribute("height");c&&b.setAttribute("width",c);a&&b.setAttribute("width",a)}},a:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1},span:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1}},attributes:{style:function(b){if(!e.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(b){return b.substr(0,d.length)==d?(b="{C}"==b.substr(d.length,3)?b.substr(d.length+3):b.substr(d.length),new h.CData(decodeURIComponent(b))):b}};o.ie&&(g.attributes.style=function(b){return b.replace(/(^|;)([^:]+)/g,function(b){return b.toLowerCase()})});s.addRules(g);m.addRules(c);n.addRules(c)})();(function(){function c(b){for(var b=b.childNodes,a=b.length,f=b[a-1];f&&3==f.nodeType&&!e.trim(f.nodeValue);)f=b[--a];return f}
function d(b,a){var f=c(b);f&&((a||!o.ie)&&1==f.nodeType&&"br"==f.nodeName?b.removeChild(f):3==f.nodeType&&j.test(f.nodeValue)&&b.removeChild(f))}function g(b){var a=c(b);return!a||1==a.nodeType&&"br"==a.nodeName||"form"==b.nodeName&&"input"==a.nodeName}function b(b){d(b,!0);g(b)&&(o.ie?b.appendChild(new h.Text("\u00a0")):(b.appendChild(new h.Text("&nbsp;")),b.appendChild(new h.Tag("br"))))}function f(b){d(b,!1);g(b)&&b.appendChild(new h.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,u=a.XHTML_DTD,k=a.Utils.mix({},
u.$block,u.$listItem,u.$tableContent),y;for(y in k)k.hasOwnProperty(y)&&("br"in u[y]||delete k[y]);delete k.td;delete k.pre;var u={tags:{}},i={tags:{}};for(y in k)k.hasOwnProperty(y)&&(u.tags[y]=b,i.tags[y]=f);m.addRules(u);s.addRules(i);n.addRules(u)})();(function(){s.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var w=/<(a|area|img|input)\b([^>]*)>/gi,c=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,d="{ke_protected}";p.htmlDataProcessor={wordFilter:n,
dataFilter:m,htmlFilter:s,toHtml:function(a){var c=new h.BeautifyWriter;(new h.Parser(a)).parse().writeHtml(c,s);return c.getHtml()},toDataFormat:function(a,c,d){d=d||m;o.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=t(a);c=new k("<div>");c.html("a"+a);a=c.html().substr(1);a=i(a);c=new h.BeautifyWriter;(new h.Parser(a)).parse().writeHtml(c,d);a=c.getHtml();return a=r(a)},toServer:function(a){var c=new h.MinifyWriter;(new h.Parser(a)).parse().writeHtml(c,
s);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(e,p,t,r,i){function v(b){var a=b.nodeType!=c.NODE_TEXT&&l.nodeName(b)in f.$removeEmpty,j=b.nodeType==c.NODE_TEXT&&!e.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return a||j||b}function a(b){return!y(b)&&!F(b)}function k(a){var f=n;return function(j){if(F(j))return m;if(j.nodeType==c.NODE_TEXT){if(e.trim(j.nodeValue).length)return n}else if(j.nodeType==c.NODE_ELEMENT&&(j=l.nodeName(j),!N[j]))if(!a&&!b.ie&&"br"==j&&!f)f=m;else return n;return m}}
function o(b,a){var f=b.startContainer,d=b.endContainer,g=b.startOffset,u=b.endOffset,e,k=n,h=n,x=void 0,o=b.document,R;if(b.collapsed)return x;0<a&&(x=o.createDocumentFragment());b.optimizeBookmark();d[0].nodeType==c.NODE_TEXT?(h=m,d=d._4e_splitText(u)):0<d[0].childNodes.length&&(u>=d[0].childNodes.length?(d=new j(d[0].appendChild(o.createTextNode(""))),R=m):d=new j(d[0].childNodes[u]));f[0].nodeType==c.NODE_TEXT?(k=m,f._4e_splitText(g)):g?g>=f[0].childNodes.length?(f=new j(f[0].appendChild(o.createTextNode(""))),
e=m):f=new j(f[0].childNodes[g].previousSibling):(e=new j(o.createTextNode("")),f.prepend(e),f=e,e=m);var y=f._4e_parents(),L=d._4e_parents();y.each(function(b,a){y[a]=b});L.each(function(b,a){L[a]=b});for(var i,M,o=0;o<y.length&&!(i=y[o],M=L[o],!i.equals(M));o++);for(var g=x,z,J,p=o;p<y.length;p++){z=y[p];u=0<a&&!z.equals(f)?g.appendChild(z.clone()[0]):null;z=z[0].nextSibling;J=L[p];for(var q=d[0],r=J&&J[0];z&&!(r==z||q==z);)J=z.nextSibling,2==a?g.appendChild(z.cloneNode(m)):(l._4e_remove(z),1==
a&&g.appendChild(z)),z=J;u&&(g=u)}for(g=x;o<L.length;o++){z=L[o];u=0<a&&!z.equals(d)?g.appendChild(z.clone()[0]):null;if(!y[o]||z[0].parentNode!=y[o][0].parentNode)for(z=z[0].previousSibling;z;)J=z.previousSibling,2==a?g.insertBefore(z.cloneNode(m),g.firstChild):(l._4e_remove(z),1==a&&g.insertBefore(z,g.firstChild)),z=J;u&&(g=u)}if(2==a){if(k&&(i=f[0],i.nodeType==c.NODE_TEXT&&i.nextSibling&&i.nextSibling.nodeType==c.NODE_TEXT&&(i.data+=i.nextSibling.data,i.parentNode.removeChild(i.nextSibling))),
h)h=d[0],h.nodeType==c.NODE_TEXT&&h.previousSibling&&h.previousSibling.nodeType==c.NODE_TEXT&&(h.previousSibling.data+=h.data,h.parentNode.removeChild(h))}else{if(i&&M&&(!f.parent().equals(i.parent())||!d.parent().equals(M.parent())))h=i._4e_index(),e&&i.parent().equals(f.parent())&&h--,b.setStart(i.parent(),h+1);b.collapse(m)}e&&f.remove();R&&d.remove();return x}function h(b){b.collapsed=b.startContainer&&b.endContainer&&b.startContainer[0]==b.endContainer[0]&&b.startOffset==b.endOffset}function s(b){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=w;this.collapsed=m;this.document=b}p.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var m=!0,n=!1,w=null,c=p.NODE,d=p.RANGE,q=p.POSITION,l=e.DOM,g=t.getByAddress,b=e.UA,f=p.XHTML_DTD,j=e.Node,u=j.all,x={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},y=new r.whitespaces,
F=new r.bookmark,E=r.whitespaces(m),I=r.bookmark(!1,!0),N={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};e.augment(s,{toString:function(){var b=[],a=this.startContainer[0],f=this.endContainer[0];b.push((a.id||a.nodeName)+":"+this.startOffset);b.push((f.id||f.nodeName)+":"+this.endOffset);return b.join("<br/>")},optimize:function(){var b=this.startContainer,a=this.startOffset;
b[0].nodeType!=c.NODE_ELEMENT&&(a?a>=b[0].nodeValue.length&&this.setStartAfter(b):this.setStartBefore(b));b=this.endContainer;a=this.endOffset;b[0].nodeType!=c.NODE_ELEMENT&&(a?a>=b[0].nodeValue.length&&this.setEndAfter(b):this.setEndBefore(b))},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},
optimizeBookmark:function(){var b=this.startContainer,a=this.endContainer;b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setStartBefore(b);a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setEndAfter(a)},setStart:function(b,a){b[0].nodeType==c.NODE_ELEMENT&&x[b.nodeName()]&&(b=b.parent(),a=b._4e_index());this.startContainer=b;this.startOffset=a;this.endContainer||(this.endContainer=b,this.endOffset=a);h(this)},setEnd:function(b,a){b[0].nodeType==c.NODE_ELEMENT&&x[b.nodeName()]&&(b=b.parent(),
a=b._4e_index()+1);this.endContainer=b;this.endOffset=a;this.startContainer||(this.startContainer=b,this.startOffset=a);h(this)},setStartAt:function(b,a){switch(a){case d.POSITION_AFTER_START:this.setStart(b,0);break;case d.POSITION_BEFORE_END:b[0].nodeType==c.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setStartBefore(b);break;case d.POSITION_AFTER_END:this.setStartAfter(b)}h(this)},setEndAt:function(b,a){switch(a){case d.POSITION_AFTER_START:this.setEnd(b,
0);break;case d.POSITION_BEFORE_END:b[0].nodeType==c.NODE_TEXT?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setEndBefore(b);break;case d.POSITION_AFTER_END:this.setEndAfter(b)}h(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,1)},collapse:function(b){b?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=
this.endContainer,this.startOffset=this.endOffset);this.collapsed=m},clone:function(){var b=new s(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=c.NODE_ELEMENT||b.endContainer[0].nodeType!=c.NODE_ELEMENT)return w;var a=new r(b);a.evaluator=function(b){return E(b)&&I(b)};b=a.next();
a.reset();a=a.previous();return b&&b.equals(a)?b:w},shrink:function(b,a){if(!this.collapsed){var b=b||d.SHRINK_TEXT,f=this.clone(),j=this.startContainer,g=this.endContainer,u=this.startOffset,e=this.endOffset,k=m,h,l,x=m;j&&j[0].nodeType==c.NODE_TEXT&&(u?u>=j[0].nodeValue.length?f.setStartAfter(j):(f.setStartBefore(j),k=n):f.setStartBefore(j));g&&g[0].nodeType==c.NODE_TEXT&&(e?e>=g[0].nodeValue.length?f.setEndAfter(g):(f.setEndAfter(g),x=n):f.setEndBefore(g));if(k||x)l=new r(f),l.evaluator=function(a){return a.nodeType==
(b==d.SHRINK_ELEMENT?c.NODE_ELEMENT:c.NODE_TEXT)},l.guard=function(a,f){a=a[0]||a;if(b==d.SHRINK_ELEMENT&&a.nodeType==c.NODE_TEXT||f&&a==h)return n;!f&&a.nodeType==c.NODE_ELEMENT&&(h=a);return m};k&&(f=l[b==d.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(f,a?d.POSITION_AFTER_START:d.POSITION_BEFORE_START);x&&(l.reset(),(l=l[b==d.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(l,a?d.POSITION_BEFORE_END:d.POSITION_AFTER_END));return k||x}},createBookmark2:function(b){var a=this.startContainer,
f=this.endContainer,d=this.startOffset,g=this.endOffset,u,e;if(!a||!f)return{start:0,end:0};if(b){if(a[0].nodeType==c.NODE_ELEMENT&&(u=new j(a[0].childNodes[d]))&&u[0]&&u[0].nodeType==c.NODE_TEXT&&0<d&&u[0].previousSibling.nodeType==c.NODE_TEXT)a=u,d=0;for(;a[0].nodeType==c.NODE_TEXT&&(e=a.prev())&&e[0].nodeType==c.NODE_TEXT;)a=e,d+=e[0].nodeValue.length;if(!this.collapsed){if(f[0].nodeType==c.NODE_ELEMENT&&(u=new j(f[0].childNodes[g]))&&u[0]&&u[0].nodeType==c.NODE_TEXT&&0<g&&u[0].previousSibling.nodeType==
c.NODE_TEXT)f=u,g=0;for(;f[0].nodeType==c.NODE_TEXT&&(e=f.prev())&&e[0].nodeType==c.NODE_TEXT;)f=e,g+=e[0].nodeValue.length}}return{start:a._4e_address(b),end:this.collapsed?w:f._4e_address(b),startOffset:d,endOffset:g,normalized:b,is2:m}},createBookmark:function(b){var a,f,c,g,u=this.collapsed;a=new j("<span>",w,this.document);a.attr("_ke_bookmark",1);a.css("display","none");a.html("&nbsp;");b&&(c=e.guid("ke_bm_"),a.attr("id",c+"S"));u||(f=a.clone(),f.html("&nbsp;"),b&&f.attr("id",c+"E"),g=this.clone(),
g.collapse(),g.insertNode(f));g=this.clone();g.collapse(m);g.insertNode(a);f?(this.setStartAfter(a),this.setEndBefore(f)):this.moveToPosition(a,d.POSITION_AFTER_END);return{startNode:b?c+"S":a,endNode:b?c+"E":f,serializable:b,collapsed:u}},moveToPosition:function(b,a){this.setStartAt(b,a);this.collapse(m)},trim:function(b,a){var f=this.startContainer,j=this.startOffset,d=this.collapsed;if((!b||d)&&f[0]&&f[0].nodeType==c.NODE_TEXT){if(j)if(j>=f[0].nodeValue.length)j=f._4e_index()+1,f=f.parent();else{var g=
f._4e_splitText(j),j=f._4e_index()+1,f=f.parent();l.equals(this.startContainer,this.endContainer)?this.setEnd(g,this.endOffset-this.startOffset):l.equals(f,this.endContainer)&&(this.endOffset+=1)}else j=f._4e_index(),f=f.parent();this.setStart(f,j);if(d){this.collapse(m);return}}f=this.endContainer;j=this.endOffset;!a&&!d&&f[0]&&f[0].nodeType==c.NODE_TEXT&&(j?(j>=f[0].nodeValue.length||f._4e_splitText(j),j=f._4e_index()+1):j=f._4e_index(),f=f.parent(),this.setEnd(f,j))},insertNode:function(b){this.optimizeBookmark();
this.trim(n,m);var a=this.startContainer;a[0].insertBefore(b[0],a[0].childNodes[this.startOffset]||null);a[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){var a=this.document;if(b.is2){var f=g(a,b.start,b.normalized),c=b.startOffset,a=b.end&&g(a,b.end,b.normalized),b=b.endOffset;this.setStart(f,c);a?this.setEnd(a,b):this.collapse(m)}else f=(c=b.serializable)?e.one("#"+b.startNode,a):b.startNode,b=c?e.one("#"+b.endNode,a):b.endNode,this.setStartBefore(f),
f._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(m)},getCommonAncestor:function(b,a){var f=this.startContainer,d=this.endContainer,f=f[0]==d[0]?b&&f[0].nodeType==c.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new j(f[0].childNodes[this.startOffset]):f:f._4e_commonAncestor(d);return a&&f[0].nodeType==c.NODE_TEXT?f.parent():f},enlarge:function(){function b(a,f,c,j){var d=a[f?"startContainer":"endContainer"],g,e=f?0:1,k=0,h=f?"previousSibling":"nextSibling";g=a[f?"startOffset":
"endOffset"];if(d[0].nodeType==l.TEXT_NODE){if(f){if(g)return}else if(g<d[0].nodeValue.length)return;g=d[0][h];d=d[0].parentNode}else g=d[0].childNodes[g+(f?-1:1)]||null,d=d[0];for(;d;){for(;g;)if(y(g)||F(g))g=g[h];else break;if(g){if(!k)a[f?"setStartAfter":"setEndBefore"](u(g));break}d=u(d);if("body"==d.nodeName())break;if(k||d.equals(j))c[e]=d,k=1;else a[f?"setStartBefore":"setEndAfter"](d);g=d[0][h];d=d[0].parentNode}}return function(a){switch(a){case d.ENLARGE_ELEMENT:if(this.collapsed)break;
var a=this.getCommonAncestor(),f=[];b(this,1,f,a);b(this,0,f,a);f[0]&&f[1]&&(a=f[0].contains(f[1])?f[1]:f[0],this.setStartBefore(a),this.setEndAfter(a));break;case d.ENLARGE_BLOCK_CONTENTS:case d.ENLARGE_LIST_ITEM_CONTENTS:var c=new s(this.document),f=new j(this.document.body);c.setStartAt(f,d.POSITION_AFTER_START);c.setEnd(this.startContainer,this.startOffset);var c=new r(c),g,e,k=r.blockBoundary(a==d.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),h=function(b){var a=k(b);a||(g=u(b));return a},x=function(b){var a=
h(b);!a&&"br"==l.nodeName(b)&&(e=u(b));return a};c.guard=h;c=c.lastBackward();g=g||f;this.setStartAt(g,"br"!=g.nodeName()&&(!c&&this.checkStartOfBlock()||c&&g.contains(c))?d.POSITION_AFTER_START:d.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(f,d.POSITION_BEFORE_END);c=new r(c);c.guard=a==d.ENLARGE_LIST_ITEM_CONTENTS?x:h;g=w;c=c.lastForward();g=g||f;this.setEndAt(g,!c&&this.checkEndOfBlock()||c&&g.contains(c)?d.POSITION_BEFORE_END:d.POSITION_BEFORE_START);e&&this.setEndAfter(e)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,a=this.startOffset;if(a&&b[0].nodeType==c.NODE_TEXT&&e.trim(b[0].nodeValue.substring(0,a)).length)return n;this.trim();b=new i(this.startContainer);a=this.clone();a.collapse(m);a.setStartAt(b.block||b.blockLimit,d.POSITION_AFTER_START);b=new r(a);b.evaluator=k(m);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,a=this.endOffset;if(b[0].nodeType==c.NODE_TEXT&&e.trim(b[0].nodeValue.substring(a)).length)return n;this.trim();
b=new i(this.endContainer);a=this.clone();a.collapse(n);a.setEndAt(b.block||b.blockLimit,d.POSITION_BEFORE_END);b=new r(a);b.evaluator=k(n);return b.checkForward()},checkBoundaryOfElement:function(b,a){var f=this.clone();f[a==d.START?"setStartAt":"setEndAt"](b,a==d.START?d.POSITION_AFTER_START:d.POSITION_BEFORE_END);f=new r(f);f.evaluator=v;return f[a==d.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,a=this.endContainer,f=this.startOffset,j=this.endOffset,
d;if(b[0].nodeType==c.NODE_ELEMENT)if(d=b[0].childNodes.length,d>f)b=u(b[0].childNodes[f]);else if(0==d)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=u(b);b=b._4e_nextSourceNode()||b}if(a[0].nodeType==c.NODE_ELEMENT)if(d=a[0].childNodes.length,d>j)a=u(a[0].childNodes[j])._4e_previousSourceNode(m);else if(0==d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=u(a)}b._4e_position(a)&q.POSITION_FOLLOWING&&(b=a);return{startNode:b,endNode:a}},fixBlock:function(a,
f){var c=this.createBookmark(),j=u(this.document.createElement(f));this.collapse(a);this.enlarge(d.ENLARGE_BLOCK_CONTENTS);j[0].appendChild(this.extractContents());j._4e_trim();b.ie||j._4e_appendBogus();this.insertNode(j);this.moveToBookmark(c);return j},splitBlock:function(a){var f=new i(this.startContainer),c=new i(this.endContainer),j=f.block,g=c.block,u=w;if(!f.blockLimit.equals(c.blockLimit))return w;"br"!=a&&(j||(j=this.fixBlock(m,a),g=(new i(this.endContainer)).block),g||(g=this.fixBlock(n,
a)));a=j&&this.checkStartOfBlock();f=g&&this.checkEndOfBlock();this.deleteContents();j&&j[0]==g[0]&&(f?(u=new i(this.startContainer),this.moveToPosition(g,d.POSITION_AFTER_END),g=w):a?(u=new i(this.startContainer),this.moveToPosition(j,d.POSITION_BEFORE_START),j=w):(g=this.splitElement(j),!b.ie&&!e.inArray(j.nodeName(),["ul","ol"])&&j._4e_appendBogus()));return{previousBlock:j,nextBlock:g,wasStartOfBlock:a,wasEndOfBlock:f,elementPath:u}},splitElement:function(b){if(!this.collapsed)return w;this.setEndAt(b,
d.POSITION_BEFORE_END);var a=this.extractContents(),f=b.clone(n);f[0].appendChild(a);f.insertAfter(b);this.moveToPosition(b,d.POSITION_AFTER_END);return f},moveToElementEditablePosition:function(b,j){var g;if(f.$empty[b.nodeName()])return n;for(;b&&b[0].nodeType==c.NODE_ELEMENT;){if(g=b._4e_isEditable())this.moveToPosition(b,j?d.POSITION_BEFORE_END:d.POSITION_AFTER_START);else if(f.$inline[b.nodeName()])return this.moveToPosition(b,j?d.POSITION_AFTER_END:d.POSITION_BEFORE_START),m;if((b=f.$empty[b.nodeName()]?
b[j?"prev":"next"](a):j?b.last(a):b.first(a))&&b[0].nodeType==c.NODE_TEXT)return this.moveToPosition(b,j?d.POSITION_AFTER_END:d.POSITION_BEFORE_START),m}return g},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==c.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});t.injectDom({_4e_breakParent:function(b,a){var f=p.Range,a=u(a),f=new f(b.ownerDocument);f.setStartAfter(u(b));f.setEndAfter(a);var c=f.extractContents();f.insertNode(u(l._4e_remove(b)));b.parentNode.insertBefore(c,
b.nextSibling)}});p.Range=s},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(e){function p(b){this.document=b;this._={cache:{}};if(n){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=i}}function t(b){b=new p(b);return!b||b.isInvalid?v:b}var r=e.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var i=!0,v=null,a=e.UA,k=e.DOM,o=e.Node,h=r.SELECTION,s=r.RANGE,m=r.NODE,n=a.ie,w=r.Walker,c=r.Range,d={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};e.augment(p,{getNative:!n?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=k._4e_getWin(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!n?function(){var b=this._.cache;if(b.type)return b.type;var a=h.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),
g=c.startContainer;g==c.endContainer&&g.nodeType==m.NODE_ELEMENT&&1==Number(c.endOffset-c.startOffset)&&d[g.childNodes[c.startOffset].nodeName.toLowerCase()]&&(a=h.SELECTION_ELEMENT)}}else a=h.SELECTION_NONE;return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=h.SELECTION_NONE;try{var c=this.getNative(),g=c.type;"Text"==g&&(a=h.SELECTION_TEXT);"Control"==g&&(a=h.SELECTION_ELEMENT);c.createRange().parentElement&&(a=h.SELECTION_TEXT)}catch(d){}return b.type=a},getRanges:n?function(){var b=
function(b,a){b=b.duplicate();b.collapse(a);for(var c=b.parentElement(),g=c.childNodes,d,e=0;e<g.length;e++){var k=g[e];if(k.nodeType==m.NODE_ELEMENT){d=b.duplicate();d.moveToElementText(k);var k=d.compareEndPoints("StartToStart",b),h=d.compareEndPoints("EndToStart",b);d.collapse();if(0<k)break;else{if(!k||1==h&&-1==k)return{container:c,offset:e};if(!h)return{container:c,offset:e+1}}d=v}}d||(d=b.duplicate(),d.moveToElementText(c),d.collapse(!1));d.setEndPoint("StartToStart",b);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=g[--e].nodeValue.length}catch(l){d=0}return 0===d?{container:c,offset:e}:{container:g[e],offset:-d}};return function(a){var d=this._.cache;if(d.ranges&&!a)return d.ranges;var g=this.getNative(),a=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==h.SELECTION_TEXT)return g=new c(this.document),e=b(a,i),g.setStart(new o(e.container),e.offset),e=b(a),g.setEnd(new o(e.container),e.offset),d.ranges=[g];if(e==h.SELECTION_ELEMENT){d=d.ranges=[];for(e=0;e<a.length;e++){for(var k=
a.item(e),l=k.parentNode,m=0,g=new c(this.document);m<l.childNodes.length&&l.childNodes[m]!=k;m++);g.setStart(new o(l),m);g.setEnd(new o(l),m+1);d.push(g)}return d}return d.ranges=[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;var b=[],d=this.getNative();if(!d)return[];for(var g=0;g<d.rangeCount;g++){var e=d.getRangeAt(g),k=new c(this.document);k.setStart(new o(e.startContainer),e.startOffset);k.setEnd(new o(e.endContainer),e.endOffset);b.push(k)}return a.ranges=b},getStartElement:function(){var b=
this._.cache;if(void 0!==b.startElement)return b.startElement;var a,c=this.getNative();switch(this.getType()){case h.SELECTION_ELEMENT:return this.getSelectedElement();case h.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();i;)if(a=d.startContainer,d.startOffset==(a[0].nodeType===m.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break;a=d.startContainer;if(a[0].nodeType!=m.NODE_ELEMENT)return a.parent();a=new o(a[0].childNodes[d.startOffset]);
if(!a[0]||a[0].nodeType!=m.NODE_ELEMENT)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==m.NODE_ELEMENT;)a=new o(d),d=d.firstChild;return a}if(n)d=c.createRange(),d.collapse(i),a=new o(d.parentElement());else{if((a=c.anchorNode)&&a.nodeType!=m.NODE_ELEMENT)a=a.parentNode;a&&(a=new o(a))}}return b.startElement=a},getSelectedElement:function(){var b,a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;n&&(b=this.getNative().createRange(),b=b.item&&b.item(0));if(!b){b=this.getRanges()[0];
for(var c,g,e=2;e&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==m.NODE_ELEMENT&&d[c.nodeName()]&&(g=c)));e--)b.shrink(s.SHRINK_ELEMENT);b=g}return a.selectedElement=new o(b)},reset:function(){this._.cache={}},selectElement:function(b){var a,c=this.document;if(n)try{a=c.body.createControlRange(),a.addElement(b[0]),a.select()}catch(d){a=c.body.createTextRange(),a.moveToElementText(b[0]),a.select()}finally{}else a=c.createRange(),a.selectNode(b[0]),b=this.getNative(),b.removeAllRanges(),b.addRange(a);
this.reset()},selectRanges:function(b){if(n){if(1<b.length){var c=b[b.length-1];b[0].setEnd(c.endContainer,c.endOffset);b.length=1}b[0]&&b[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var d=0;d<b.length;d++){var g=b[d],e=this.document.createRange(),k=g.startContainer;if(g.collapsed&&(a.gecko&&1.09>a.gecko||a.opera||a.webkit)&&k[0].nodeType==m.NODE_ELEMENT&&!k[0].childNodes.length)k[0].appendChild(this.document.createTextNode(a.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;
e.setStart(k[0],g.startOffset);e.setEnd(g.endContainer[0],g.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),d=0;d<c.length;d++)a.push(c[d].createBookmark2(b));return a},createBookmarks:function(b,a){for(var c=[],d=this.document,g,a=a||this.getRanges(),l=a.length,h=0;h<l;h++){c.push(g=a[h].createBookmark(b,i));var o=(b=g.serializable)?e.one("#"+g.startNode,d):g.startNode;g=b?e.one("#"+g.endNode,d):g.endNode;for(var m=h+1;m<l;m++){var p=a[m],n=p.startContainer,
q=p.endContainer;k.equals(n,o.parent())&&p.startOffset++;k.equals(n,g.parent())&&p.startOffset++;k.equals(q,o.parent())&&p.endOffset++;k.equals(q,g.parent())&&p.endOffset++}}return c},selectBookmarks:function(b){for(var a=[],d=0;d<b.length;d++){var g=new c(this.document);g.moveToBookmark(b[d]);a.push(g)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();
b&&b.scrollIntoView(void 0,!1)},removeAllRanges:function(){var b=this.getNative();n?b&&b.clear():b&&b.removeAllRanges()}});var q={table:1,tbody:1,tr:1},l=w.whitespaces(i),g=/\ufeff|\u00a0/;c.prototype.select=c.prototype.select=!n?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==m.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(i),a.setEnd(this.endContainer[0],this.endOffset);else throw c;}b=t(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(b){var a=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==m.NODE_ELEMENT){(new p(this.document)).selectElement(new o(e));return}}(this.startContainer[0].nodeType==m.NODE_ELEMENT&&
this.startContainer.nodeName()in q||this.endContainer[0].nodeType==m.NODE_ELEMENT&&this.endContainer.nodeName()in q)&&this.shrink(s.SHRINK_ELEMENT,i);var h=this.createBookmark(),e=h.startNode,n;a||(n=h.endNode);h=this.document.body.createTextRange();h.moveToElementText(e[0]);h.moveStart("character",1);if(n)b=this.document.body.createTextRange(),b.moveToElementText(n[0]),h.setEndPoint("EndToEnd",b),h.moveEnd("character",-1);else{for(c=e[0].nextSibling;c&&!l(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(g))&&(b||!e[0].previousSibling||e[0].previousSibling&&"br"==k.nodeName(e[0].previousSibling));d=new o(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(e);c&&k.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(a){if(c?(h.moveStart("character",-1),h.select(),this.document.selection.clear()):h.select(),d)this.moveToPosition(d,s.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(n),n._4e_remove(),h.select()};
p.getSelection=t;return r.Selection=p},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(e,p){function t(a){function d(b,a){var c=f.body.createTextRange();try{c.moveToPoint(b,a)}catch(d){c=o}return c}function e(){var b=f.selection.createRange();j&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&j.select();s.remove(f,"mouseup",e);s.remove(f,"mousemove",k);j=g=0}function k(b){if(b.button){if(b=d(b.pageX,b.pageY))0<b.compareEndPoints("StartToStart",j)?b.setEndPoint("StartToStart",j):b.setEndPoint("EndToEnd",j),b.select()}else e()}var g,
b=a.get("iframe")[0].contentWindow,f=a.get("document")[0],j;s.on(f,"mousedown contextmenu",function(a){var c=f.documentElement;if(a.target===c&&(g&&e(),!(c.scrollHeight>c.clientHeight)&&(g=1,j=d(a.pageX,a.pageY))))s.on(f,"mouseup",e),s.on(f,"mousemove",k),b.focus(),j.select()})}function r(c){function d(g){if(f){var j=c.getSelection(),k=j&&j.getType(),h=j&&e.selection;if(g&&h&&k==n.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){d(a)},50);else{var l;if(!h||!h.type||!("Control"!=
h.type&&(l=h.createRange())&&(l=l.parentElement())&&(l=l.nodeName)&&l.toLowerCase()in{input:1,textarea:1}))b=h&&j.getRanges()[0],c._monitor()}}}var e=c.get("document")[0],h=new m(e.body),g=new m(e.documentElement);if(8>p.Utils.ieEngine)g.on("click",function(b){"html"===(new m(b.target)).nodeName()&&c.getSelection().getNative().createRange().select()});var b,f,j=a;g.on("mousedown",function(){j=k});g.on("mouseup",function(){j=a});h.on("focusin",function(a){if("body"==(new m(a.target)).nodeName()&&b){try{j&&
b.select()}catch(c){}b=o}});h.on("focus",function(){f=a;d()});h.on("beforedeactivate",function(b){b.relatedTarget||(f=k,j=a)});h.on("mousedown",function(){f=k});h.on("mouseup",function(){f=a;setTimeout(function(){d(a)},0)});h.on("keydown",function(){f=k});h.on("keyup",function(){f=a;setTimeout(function(){d()},0)})}function i(a){var d=a.get("document")[0];s.on(d,"mouseup keyup",function(){a._monitor()})}function v(c){function d(b){var a=p.XHTML_DTD;return b._4e_isBlockBoundary()&&a.$empty[b.nodeName()]}
function e(a){return b(a)&&f(a)}var l=c.get("document")[0],g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=p.Walker.whitespaces(a),f=p.Walker.bookmark(k,a),j=function(a){return b(a)&&8!=a.nodeType};c.on("selectionChange",function(b){var f=b.path,o=new m(c.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],i=f.blockLimit;if(h.gecko){var n=f.block||f.blockLimit,r=n&&n.last(e);n&&n._4e_isBlockBoundary()&&
(!r||!(1==r[0].nodeType&&r._4e_isBlockBoundary()))&&"pre"!=n.nodeName()&&!n._4e_getBogus()&&n._4e_appendBogus()}if(b&&b.collapsed&&!f.block){if("body"==i.nodeName()){if((f=b.fixBlock(a,"p"))&&f[0]!=o[0].lastChild&&f._4e_outerHtml().match(g))if((i=f.next(j))&&i[0].nodeType==w.NODE_ELEMENT&&!d[i])b.moveToElementEditablePosition(i),f._4e_remove();else if((i=f.prev(j))&&i[0].nodeType==w.NODE_ELEMENT&&!d[i])b.moveToElementEditablePosition(i,i._4e_outerHtml().match(g)?k:a),f._4e_remove();b.select();c.notifySelectionChange()}f=
new p.Range(l);f.moveToElementEditablePosition(o,a);"body"!==(new p.ElementPath(f.startContainer)).blockLimit.nodeName()&&(o=(new m(l.createElement("p"))).appendTo(o),h.ie||o._4e_appendBogus())}})}var a=!0,k=!1,o=null,h=e.UA,s=e.Event,m=e.Node,n=p.SELECTION,w=p.NODE;return{init:function(a){a.docReady(function(){h.ie?(t(a),r(a)):i(a)});v(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(e){function p(b){return!F.attr(b,"_ke_bookmark")}function t(b,a){for(var c in b)b.hasOwnProperty(c)&&(e.isString(b[c])?b[c]=b[c].replace(S,function(b,c){return a[c]}):t(b[c],a))}function r(b,a){a&&(b=e.clone(b),t(b,a));var c=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#"==c||O[c]?E.STYLE_BLOCK:P[c]?E.STYLE_OBJECT:E.STYLE_INLINE;this._={definition:b}}function i(b,a){var c=a?this.removeFromRange:this.applyToRange;b.body.focus();
for(var d=new N(b),g=d.getRanges(),f=0;f<g.length;f++)c.call(this,g[f]);d.selectRanges(g)}function v(b,a,c){var d=b.element;"*"==d&&(d="span");a=new D(a.createElement(d));c&&c._4e_copyAttributes(a);c=b._.definition;b=c.attributes;c=r.getStyleText(c);if(b)for(var g in b)b.hasOwnProperty(g)&&a.attr(g,b[g]);c&&(a[0].style.cssText=c);return a}function a(b){var a=b.createBookmark(j),c=b.createIterator();c.enforceRealBlocks=j;c.enlargeBr=j;for(var d,g=b.document;d=c.getNextParagraph();){var f=v(this,g,
d),e=f,f="pre"==e.nodeName,l="pre"==d.nodeName,i=!f&&l;f&&!l?(l=d,i=l.html(),i=k(i,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),i=i.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),i=i.replace(/([ \t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),C.ie?(l=l[0].ownerDocument.createElement("div"),l.appendChild(e[0]),e[0].outerHTML="<pre>"+i+"</pre>",e=new D(l.firstChild),e._4e_remove()):e.html(i)):i?e=h(o(d),e):d._4e_moveChildren(e);d[0].parentNode.replaceChild(e[0],d[0]);if(f&&(d=e,f=void 0,(f=d._4e_previousSourceNode(j,
A.NODE_ELEMENT))&&"pre"==f.nodeName()))e=k(f.html(),/\n$/,"")+"\n\n"+k(d.html(),/^\n/,""),C.ie?d[0].outerHTML="<pre>"+e+"</pre>":d.html(e),f._4e_remove()}b.moveToBookmark(a)}function k(b,a,c){var d="",f="",b=b.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(b,a,c){a&&(d=a);c&&(f=c);return""});return d+b.replace(a,c)+f}function o(b){var a=[];k(b._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,a,c){return a+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(b,c){a.push(c)});return a}function h(b,a){for(var c=a[0].ownerDocument.createDocumentFragment(),d=0;d<b.length;d++){var f=b[d],f=f.replace(/(\r\n|\r)/g,"\n"),f=k(f,/^[ \t]*\n/,""),f=k(f,/\n$/,""),f=k(f,/^[ \t]+|[ \t]+$/g,function(b,a){return 1==b.length?"&nbsp;":a?" "+Array(b.length).join("&nbsp;"):Array(b.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(b){return Array(b.length).join("&nbsp;")+" "}),
g=a.clone();g.html(f);c.appendChild(g[0])}return c}function s(b){var a=b.document;if(b.collapsed)a=v(this,a,void 0),b.insertNode(a),b.moveToPosition(a,I.POSITION_BEFORE_END);else{var c=this.element,d=this._.definition,f,g=G[c];g||(f=j,g=G.span);var e=b.createBookmark();b.enlarge(I.ENLARGE_ELEMENT);b.trim();for(var h=b.createBookmark(),k=h.startNode,h=h.endNode,i=k,o;i&&i[0];){var m=u;if(F.equals(i,h))i=x,m=j;else{var n=i[0].nodeType,r=n==A.NODE_ELEMENT?i.nodeName():x;if(r&&i.attr("_ke_bookmark")){i=
i._4e_nextSourceNode(j);continue}if(!r||g[r]&&(i._4e_position(h)|B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(i))){var q=i.parent();if(q&&"a"==c&&q.nodeName()==c)n=v(this,a,void 0),q._4e_moveChildren(n),q[0].parentNode.replaceChild(n[0],q[0]),n._4e_mergeSiblings();else if(q&&q[0]&&((G[q.nodeName()]||G.span)[c]||f)&&(!d.parentRule||d.parentRule(q))){if(!o&&(!r||!G.$removeEmpty[r]||(i._4e_position(h)|
B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED))o=new H(a),o.setStartBefore(i);if(n==A.NODE_TEXT||n==A.NODE_ELEMENT&&!i[0].childNodes.length){q=i;for(n=null;(m=!q.next(p))&&(n=q.parent())&&g[n.nodeName()]&&(n._4e_position(k)|B.POSITION_FOLLOWING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_FOLLOWING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!d.childRule||d.childRule(n));)q=n;o.setEndAfter(q)}}else m=
j}else m=j;i=i._4e_nextSourceNode()}if(m&&o&&!o.collapsed){for(var m=v(this,a,void 0),q=o.getCommonAncestor(),n={},r={},s,y=null,t;m&&q&&m[0]&&q[0];){if(q.nodeName()==c){for(s in d.attributes)if(d.attributes.hasOwnProperty(s)&&!r[s]&&(t=q.attr(y)))m.attr(s)==t?m.removeAttr(s):r[s]=1;for(y in d.styles)if(d.styles.hasOwnProperty(y)&&!n[y]&&(t=q.style(y)))m.style(y)==t?m.style(y,""):n[y]=1;if(!m._4e_hasAttributes()){m=x;break}}q=q.parent()}m?(m[0].appendChild(o.extractContents()),l(this,m),o.insertNode(m),
m._4e_mergeSiblings(),C.ie||m[0].normalize()):(m=new D(a.createElement("span")),m[0].appendChild(o.extractContents()),o.insertNode(m),l(this,m),m._4e_remove(!0));o=x}}k._4e_remove();h._4e_remove();b.moveToBookmark(e);b.shrink(I.SHRINK_TEXT)}}function m(b){b.enlarge(I.ENLARGE_ELEMENT);var a=b.createBookmark(),f=a.startNode;if(b.collapsed){for(var e=new K(f.parent()),j,h=0,k;h<e.elements.length&&(k=e.elements[h])&&!(k==e.block||k==e.blockLimit);h++)if(this.checkElementRemovable(k)){var l=b.checkBoundaryOfElement(k,
I.END),i=!l&&b.checkBoundaryOfElement(k,I.START);i||l?(j=k,j.match=i?"start":"end"):(k._4e_mergeSiblings(),k.nodeName()!=this.element?(l=c(this),g(k,l[k.nodeName()]||l["*"])):d(this,k))}if(j.length){k=f;for(h=0;;h++){l=e.elements[h];if(F.equals(l,j))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(k[0]);k=l}k["start"==j.match?"insertBefore":"insertAfter"](j)}}else{var o=a.endNode,m=this,e=function(){for(var b=new K(f.parent()),a=new K(o.parent()),c=x,d=x,g=0;g<b.elements.length;g++){var j=
b.elements[g];if(j==b.block||j==b.blockLimit)break;m.checkElementRemovable(j)&&(c=j)}for(g=0;g<a.elements.length;g++){j=a.elements[g];if(j==a.block||j==a.blockLimit)break;m.checkElementRemovable(j)&&(d=j)}d&&o._4e_breakParent(d);c&&f._4e_breakParent(c)};e();for(j=new D(f[0].nextSibling);j[0]!==o[0];){h=j._4e_nextSourceNode();if(j[0]&&j[0].nodeType==A.NODE_ELEMENT&&this.checkElementRemovable(j)&&(j.nodeName()==this.element?d(this,j):(k=c(this),g(j,k[j.nodeName()]||k["*"])),h[0].nodeType==A.NODE_ELEMENT&&
h.contains(f)))e(),h=new D(f[0].nextSibling);j=h}}b.moveToBookmark(a)}function n(b){var a={};(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,d){a[c]=d});return a}function w(b,a){var c="";a!==u?(c=document.createElement("span"),c.style.cssText=b,c=c.style.cssText||""):c=b;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(b){if(b._.overrides)return b._.overrides;var a=b._.overrides={},c=b._.definition.overrides;
if(c){e.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var f=c[d],g,j,h;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():b.element,j=f.attributes,h=f.styles);f=a[g]||(a[g]={});if(j){g=f.attributes=f.attributes||[];for(var k in j)j.hasOwnProperty(k)&&g.push([k.toLowerCase(),j[k]])}if(h){var f=f.styles=f.styles||[],l;for(l in h)h.hasOwnProperty(l)&&f.push([l.toLowerCase(),h[l]])}}}return a}function d(a,d){var f=a._.definition,g=c(a),h=y.mix(f.attributes,(g[d.nodeName()]||g["*"]||
{}).attributes),f=y.mix(f.styles,(g[d.nodeName()]||g["*"]||{}).styles),g=e.isEmptyObject(h)&&e.isEmptyObject(f),k;for(k in h)if(h.hasOwnProperty(k)&&!(("class"==k||a._.definition.fullMatch)&&d.attr(k)!=q(k,h[k])))g=g||!!d.hasAttr(k),d.removeAttr(k);for(var l in f)f.hasOwnProperty(l)&&!(a._.definition.fullMatch&&d.style(l)!=q(l,f[l],j))&&(g=g||!!d.style(l),d.style(l,""));b(d)}function q(b,a,c){var d=new D("<span>");d[c?"style":"attr"](b,a);return d[c?"style":"attr"](b)}function l(b,a){for(var f=c(b),
j=a.all(b.element),e=j.length;0<=--e;)d(b,new D(j[e]));for(var k in f)if(f.hasOwnProperty(k)&&k!=b.element){j=a.all(k);for(e=j.length-1;0<=e;e--){var h=new D(j[e]);g(h,f[k])}}}function g(a,c){var d,f=c&&c.attributes;if(f)for(d=0;d<f.length;d++){var g=f[d][0],j;if(j=a.attr(g)){var e=f[d][1];(e===x||e.test&&e.test(j)||"string"==typeof e&&j==e)&&a[0].removeAttribute(g)}}if(f=c&&c.styles)for(d=0;d<f.length;d++)if(g=f[d][0],e=a.css(g)){var k=f[d][1];(k===x||k.test&&k.test(j)||"string"==typeof k&&e==k)&&
a.css(g,"")}b(a)}function b(b){if(!b._4e_hasAttributes()){var a=b[0].firstChild,c=b[0].lastChild;b._4e_remove(j);a&&(a.nodeType==A.NODE_ELEMENT&&F._4e_mergeSiblings(a),c&&a!=c&&c.nodeType==A.NODE_ELEMENT&&F._4e_mergeSiblings(c))}}var f=e.Editor,j=!0,u=!1,x=null,y=f.Utils,F=e.DOM,E={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},I=f.RANGE,N=f.Selection,A=f.NODE,B=f.POSITION,H=f.Range,D=e.Node,C=e.UA,K=f.ElementPath,O={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},G=f.XHTML_DTD,P={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;f.STYLE=E;r.prototype={apply:function(b){i.call(this,b,u)},remove:function(b){i.call(this,b,j)},applyToRange:function(b){return(this.applyToRange=this.type==E.STYLE_INLINE?s:this.type==E.STYLE_BLOCK?a:x).call(this,b)},removeFromRange:function(b){return(this.removeFromRange=this.type==E.STYLE_INLINE?m:x).call(this,b)},checkElementRemovable:function(b,a){if(!b)return u;var d=this._.definition,
f;if(b.nodeName()==this.element){if(!a&&!b._4e_hasAttributes())return j;var g=d._AC;if(g)d=g;else{var g={},e=0,k=d.attributes;if(k)for(var h in k)k.hasOwnProperty(h)&&(e++,g[h]=k[h]);if(k=r.getStyleText(d))g.style||e++,g.style=k;g._length=e;d=d._AC=g}if(d._length){for(var l in d)if("_length"!=l&&d.hasOwnProperty(l)){e=b.attr(l)||"";if("style"==l)a:{g=d[l];e=w(e,u);"string"==typeof g&&(g=n(g));"string"==typeof e&&(e=n(e));k=void 0;for(k in g)if(g.hasOwnProperty(k)&&!(k in e&&(e[k]==g[k]||"inherit"==
g[k]||"inherit"==e[k]))){g=u;break a}g=j}else g=d[l]==e;if(g){if(!a)return j}else if(a)return u}if(a)return j}else return j}l=c(this);if(l=l[b.nodeName()]||l["*"]){if(!(d=l.attributes)&&!(f=l.styles))return j;if(d)for(g=0;g<d.length;g++)if(l=d[g][0],l=b.attr(l))if(e=d[g][1],e===x||"string"==typeof e&&l==e||e.test&&e.test(l))return j;if(f)for(g=0;g<f.length;g++)if(l=b.css(f[g][0]))if(d=f[g][1],d===x||"string"==typeof d&&l==d||d.test&&d.test(l))return j}return u},checkActive:function(b){switch(this.type){case E.STYLE_BLOCK:return this.checkElementRemovable(b.block||
b.blockLimit,j);case E.STYLE_OBJECT:case E.STYLE_INLINE:for(var a=b.elements,c=0,d;c<a.length;c++)if(d=a[c],!(this.type==E.STYLE_INLINE&&(F.equals(d,b.block)||F.equals(d,b.blockLimit))))if((this.type!=E.STYLE_OBJECT||d.nodeName()in P)&&this.checkElementRemovable(d,j))return j}return u}};r.getStyleText=function(b){var a=b._ST;if(a)return a;var a=b.styles,c=b.attributes&&b.attributes.style||"",d="";c.length&&(c=c.replace(Q,";"));for(var f in a)if(a.hasOwnProperty(f)){var g=a[f],e=(f+":"+g).replace(Q,
";");"inherit"==g?d+=e:c+=e}c.length&&(c=w(c));return b._ST=c+d};f.Style=r},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(e){var p=e.Editor,t=e.Node,r=e.DOM,i=e.UA,v={debugUrl:function(a){a=a.replace(/-min\.(js|css)/i,".$1");e.Config.debug||(a=a.replace(/\.(js|css)/i,"-min.$1"));-1==a.indexOf("?t")&&(a=-1!=a.indexOf("?")?a+"&":a+"?",a+="t="+encodeURIComponent("20120523143504"));e.startsWith(a,"/")&&(a=a.substring(1));return p.Config.base+a},lazyRun:function(a,e,i){var h=a[e],p=a[i];a[e]=function(){h.apply(this,arguments);a[e]=a[i];return p.apply(this,arguments)}},getXY:function(a,
e,i,h){i=i.defaultView||i.parentWindow;a-=r.scrollLeft(i);e-=r.scrollTop(i);h&&(h=h.defaultView||h.parentWindow,i!=h&&i.frameElement&&(h=r.offset(i.frameElement,void 0,h),a+=h.left,e+=h.top));return{left:a,top:e}},tryThese:function(a){for(var e,i=0,h=arguments.length;i<h;i++){var p=arguments[i];try{e=p();break}catch(m){}}return e},arrayCompare:function(a,e){if(!a&&!e)return!0;if(!a||!e||a.length!=e.length)return!1;for(var i=0;i<a.length;i++)if(a[i]!==e[i])return!1;return!0},getByAddress:function(a,
e,i){for(var a=a.documentElement,h=0;a&&h<e.length;h++){var p=e[h];if(i)for(var m=-1,n=0;n<a.childNodes.length;n++){var r=a.childNodes[n];if(!(!0===i&&3==r.nodeType&&r.previousSibling&&3==r.previousSibling.nodeType)&&(m++,m==p)){a=r;break}}else a=a.childNodes[p]}return a?new t(a):null},clearAllMarkers:function(a){for(var e in a)a.hasOwnProperty(e)&&a[e]._4e_clearMarkers(a,!0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},mix:function(a){for(var k={},
i=0;i<arguments.length;i++)k=e.mix(k,arguments[i]);return k},isCustomDomain:function(){if(!i.ie)return!1;var a=document.domain,e=window.location.hostname;return a!=e&&a!="["+e+"]"},isNumber:function(a){return/^\d+(.\d+)?$/.test(e.trim(a))},verifyInputs:function(a){for(var k=0;k<a.length;k++){var i=new t(a[k]),h=e.trim(v.valInput(i)),p=i.attr("data-verify"),i=i.attr("data-warning");if(p&&!RegExp(p).test(h))return alert(i),!1}return!0},sourceDisable:function(a,e){a.on("sourceMode",e.disable,e);a.on("wysiwygMode",
e.enable,e)},resetInput:function(a){var e=a.attr("placeholder");e&&i.ie?(a.addClass("ke-input-tip"),a.val(e)):i.ie||a.val("")},valInput:function(a,e){if(void 0===e)return a.hasClass("ke-input-tip")?"":a.val();a.removeClass("ke-input-tip");a.val(e)},placeholder:function(a,k){a.attr("placeholder",k);i.ie&&(a.on("blur",function(){e.trim(a.val())||(a.addClass("ke-input-tip"),a.val(k))}),a.on("focus",function(){a.removeClass("ke-input-tip");e.trim(a.val())==k&&a.val("")}))},htmlEncode:function(a){return!a?
a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(a){var a=e.clone(a),k;for(k in a)if(a.hasOwnProperty(k)){var i=a[k];e.isFunction(i)&&(a[k]=i())}return a},map:function(a,e){for(var i=0;i<a.length;i++)a[i]=e(a[i]);return a},ieEngine:document.documentMode||i.ie,preventFocus:function(a){i.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(a){e.mix(r,a);for(var k in a)a.hasOwnProperty(k)&&function(k){t.prototype[k]=
function(){var h=[].slice.call(arguments,0);h.unshift(this[0]);return(h=a[k].apply(null,h))&&(h.nodeType||e.isWindow(h))?new t(h):e.isArray(h)&&(h.__IS_NODELIST||h[0]&&h[0].nodeType)?new t(h):h}}(k)},addRes:function(){var a=this.__res=this.__res||[];a.push.apply(a,e.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],k=0;k<a.length;k++){var i=a[k];e.isFunction(i)?i():(i.destroy&&i.destroy(),i.remove&&i.remove())}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,
function(a,e){return e.toUpperCase()})+"Active"}};return p.Utils=v},{requires:["./base"]});
KISSY.add("editor/core/walker",function(e,p){function t(c,d){if(this._.end)return k;var b,f=this.range,e,h=this.guard,i=this.type,m=c?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),k;if(!c&&!this._.guardLTR){var o=f.endContainer[0],p=o.childNodes[f.endOffset];this._.guardLTR=function(b,a){return a&&(o==b||"body"==s.nodeName(b))?!1:b!=p}}if(c&&!this._.guardRTL){var q=f.startContainer[0],r=0<f.startOffset&&q.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(b,a){return a&&(q==b||"body"==s.nodeName(b))?!1:b!=r}}var t=c?this._.guardRTL:this._.guardLTR;e=h?function(b,c){return t(b,c)===a?a:h(b,c)}:t;this.current?b=this.current[m](a,i,e):c?(b=f.endContainer,0<f.endOffset?(b=new n(b[0].childNodes[f.endOffset-1]),e(b)===a&&(b=k)):b=e(b,v)===a?k:b._4e_previousSourceNode(v,i,e,void 0)):(b=f.startContainer,b=new n(b[0].childNodes[f.startOffset]),b.length?e(b)===a&&(b=k):b=e(f.startContainer,v)===a?k:f.startContainer._4e_nextSourceNode(v,
i,e,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==a){if(!d)return b}else if(d&&this.evaluator)return a;b=b[m](a,i,e)}this.end();return this.current=k}function r(a){for(var c,b=k;c=t.call(this,a);)b=c;return b}function i(a){this.range=a;this._={}}var v=!0,a=!1,k=null,o=e.UA,h=p.NODE,s=e.DOM,m=p.XHTML_DTD,n=e.Node;e.augment(i,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,v)},checkForward:function(){return t.call(this,
a,v)!==a},checkBackward:function(){return t.call(this,v,v)!==a},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,v)},reset:function(){delete this.current;this._={}},_iterator:t});i.blockBoundary=function(a){return function(c){return!(c.nodeType==h.NODE_ELEMENT&&s._4e_isBlockBoundary(c,a))}};i.bookmark=function(a,c){function b(b){return"span"==s.nodeName(b)&&s.attr(b,"_ke_bookmark")}return function(d){var e,i;e=d.nodeType==h.NODE_TEXT&&(i=d.parentNode)&&b(i);e=
a?e:e||b(d);return!!(c^e)}};i.whitespaces=function(a){return function(c){c=c.nodeType==h.NODE_TEXT&&!e.trim(c.nodeValue);return!!(a^c)}};i.invisible=function(a){var c=i.whitespaces();return function(b){b=c(b)||b.nodeType==h.NODE_ELEMENT&&!b.offsetHeight;return!!(a^b)}};var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,c=i.whitespaces(),d=i.bookmark(),q=function(a){var g=s.nodeName(a);return d(a)||c(a)||1==a.nodeType&&g in m.$inline&&!(g in m.$empty)};p.Utils.injectDom({_4e_getBogus:function(a){a=new n(a);do a=
a._4e_previousSourceNode();while(a&&q(a[0]));return a&&(!o.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return p.Walker=i},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(e){var p=e.Editor;p.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};p.baseZIndex=function(e){return(p.Config.baseZIndex||1E4)+e}},{requires:["./base"]});
KISSY.add("editor",function(e,p,t,r){function i(a,b){var d=a.body;c(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=v)},50)},function(){a.designMode="off";m.attr(d,"contentEditable",k);m.attr(d,"contentEditable",v);!b&&i(a,1)})}var v=!0,a=e.all,k=!1,o=document,h=e.UA,s=h.ie,m=e.DOM,n=e.Node,w=e.Event,c=t.tryThese,d="document.open();"+(t.isCustomDomain()?'document.domain="'+o.domain+'";':"")+"document.close();",q='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(s?' src="javascript:void(function(){'+encodeURIComponent(d)+'}())"':"")+' allowTransparency="true"></iframe>';e.mix(p,{SOURCE_MODE:0,WYSIWYG_MODE:1});var l=p.WYSIWYG_MODE;e.augment(p,{createDom:function(){var c=this.get("textarea"),b;c||this.set("textarea",c=a("<textarea></textarea>"));b=this.get("el");b.addClass(this.get("prefixCls")+"editor-wrap",void 0);b.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=e.guid();var d=
b.one(".ke-textarea-wrap");this.__set("iframeWrapEl",d);this.__set("toolBarEl",b.one(".ke-editor-tools"));this.__set("statusBarEl",b.one(".ke-editor-status"));var j=this.get("width"),h=this.get("height");b.css("width",j);c.css("width","100%");c.css("display","none");d.append(c);d.css("height",h);c.css("height",h);b.css("height","")},_uiSetHeight:function(a){this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("textarea");a?(b.execCommand("save"),
b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",c)}),b._setData(d.val())):(d.val(b._getData(1,l)),d[0].focus());d[a?"hide":"show"]();b.get("iframe")[a?"show":"hide"]();b.fire((a?"wysiwyg":"source")+"Mode")},renderUI:function(){function a(){b.detach("docReady",a);if(b.get("focus"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c=b.get("textarea");r.register(b);b.get("attachForm")&&c[0].form&&b._attachForm();b.on("docReady",a)},_createIframe:function(a){var b=
this,c=new n(q),d=b.get("textarea");d.hasAttr("tabindex")&&c.attr("tabIndex",h.webkit?-1:d.attr("tabIndex"));b.get("iframeWrapEl").prepend(c);b.set("iframe",c);b.__docReady=0;if(h.gecko&&!c.__loaded)c.on("load",function(){b._setUpIFrame(a)},b);else b._setUpIFrame(a)},destructor:function(){var a=this.get("el"),b=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();p.focusManager.remove(this);w.remove([c,c.documentElement,c.body,d]);e.each(this.__dialogs,
function(b){b.destroy&&b.destroy()});this.__commands=0;this.__editor_created_new||(b.insertBefore(a,void 0),b.css({width:this.get("width"),height:this.get("height")}),b.show())},_attachForm:function(){var a=this,b=a.get("textarea"),c=new n(b[0].form);c.on("submit",a.sync,a);a.on("destroy",function(){c.detach("submit",a.sync,a)})},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var c=this.__dialogs[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},
hasDialog:function(a){return!!this.__dialogs[a]},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=e.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var a=this.get("iframe"),b=a[0].contentWindow,c=this.get("document")[0];w.remove([c,c.documentElement,c.body,b]);a.remove()}},_getData:function(a,b){var c=this.htmlDataProcessor,
d;void 0==b&&(b=this.get("mode"));d=b==l?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=e.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,c=a;if(this.get("mode")!=l)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(a){this.get("document")[0].body.innerHTML=a},_prepareIFrameHtml:function(a,b){var c=this.get("customStyle"),d=this.get("customLink"),e="",h=p.Utils.debugUrl("/theme/editor-iframe.css");if(d)for(var i=0;i<d.length;i++)e+='<link href="'+d[i]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===o.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+h+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+e+"</head><body class='ke-editor'>"+
(b||"&nbsp;")+(a?'<script id="ke_actscript" type="text/javascript">'+(t.isCustomDomain()?'document.domain="'+o.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"},getSelection:function(){return p.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=m._4e_getWin(a);h.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){m._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a){var b=this.get("customStyle")||"",b=b+("\n"+a);this.set("customStyle",b);m.addStyleSheet(this.get("iframe")[0].contentWindow,b)},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=m.query("link",b),c=
0;c<b.length;c++)b[c].href==a&&m.remove(b[c]);b=this.get("customLink")||[];a=e.indexOf(a,b);-1!=a&&b.splice(a,1)},_setUpIFrame:function(a){function b(){i=h.document;c.__set("document",new n(i));c.__set("window",new n(h));d.detach();i.open("text/html","replace");i.write(e);i.close()}var c=this,d=c.get("iframe"),e=c._prepareIFrameHtml(c._UUID,a),h=d[0].contentWindow,i;d.__loaded=1;try{i=h.document}catch(k){if(d[0].src=d[0].src,7>s){setTimeout(b,10);return}}b()},docReady:function(a){this.on("docReady",
a);this.__docReady&&a.call(this)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new p.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(a,b,c){var d=this;if(d.get("mode")===
l){d.focus();var e,h=a.nodeName(),i=p.XHTML_DTD,m=p.RANGE,o=p.NODE,q=i.$block[h],r=d.getSelection(),t=r&&r.getRanges(),s,w,D,C;if(!t||0==t.length){var K=arguments,O=K.callee;setTimeout(function(){O.apply(d,K)},30)}else{d.execCommand("save");for(var G=t.length-1;0<=G;G--){s=t[G];s.deleteContents();e=!G&&a||a.clone(v);b&&b(e);if(q)for(;(D=s.getCommonAncestor(k,v))&&(C=i[D.nodeName()])&&(!C||!C[h]);)D.nodeName()in i.span?s.splitElement(D):s.checkStartOfBlock()&&s.checkEndOfBlock()?(s.setStartBefore(D),
s.collapse(v),D.remove()):s.splitBlock();s.insertNode(e);w||(w=e)}w&&(h=w._4e_nextSourceNode(v),i=d.get("document")[0],C=p.XHTML_DTD,C.$inline[e.nodeName()]?(h=new n(i.createTextNode(" ")),h.insertAfter(w)):h?"br"==h.nodeName()&&C[h.parent().nodeName()].p&&(C=new n("<p>&nbsp;</p>",null,i),h[0].parentNode.replaceChild(C[0],h[0]),h=C):(C=new n("<p>&nbsp;</p>",null,i),C.insertAfter(w),h=C),s.moveToPosition(w,m.POSITION_AFTER_END),h&&h[0].nodeType==o.NODE_ELEMENT&&s.moveToElementEditablePosition(h),r.selectRanges([s]),
d.focus(),e&&e.scrollIntoView(void 0,!1),d._saveLater(),c&&c(e))}}},insertHtml:function(a,b){var c=this,d;if(c.get("mode")===l){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,null,b);c.focus();c.execCommand("save");var e=c.get("document")[0];d=0;if(s){var h=e.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(a)}catch(i){}}else try{e.execCommand("inserthtml",k,a)}catch(o){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new p.Range(e),d=m.first(e.body,function(a){return 1==
a.nodeType&&"br"!=m.nodeName(a)});d||(d=new n(e.createElement("p")),e.body.appendChild(d[0]));b.setStartAt(d,p.RANGE.POSITION_AFTER_START);b.select()}e.execCommand("inserthtml",k,a)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);c._saveLater(d)}},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null);b.__saveTimer=setTimeout(function(){b.execCommand("save")},a||0)},_fixByBindIframeDoc:function(){var a=this,b=a.get("iframe"),c=a.get("textarea")[0],
b=b[0].contentWindow,d=a.get("document")[0];h.webkit&&(w.on(d,"click",function(a){var b=new n(a.target);e.inArray(b.nodeName(),["input","select"])&&a.preventDefault()}),w.on(d,"mouseup",function(a){var b=new n(a.target);e.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(h.gecko||s||h.opera){var l;l=(new n('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);l.on("focus",function(){a.focus()});a.activateGecko=function(){h.gecko&&
a.__iframeFocus&&l[0].focus()};a.on("destroy",function(){l.detach();l.remove()})}w.on(b,"focus",function(){h.gecko?i(d,k):h.opera&&d.body.focus();a.notifySelectionChange()});if(h.gecko)w.on(d,"mousedown",function(){a.__iframeFocus||i(d,k)});if(s&&(w.on(d,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var m=
{33:1,34:1};w.on(d,"keydown",function(b){b.keyCode in m&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(h.webkit)w.on(d,"mousedown",function(b){b=new n(b.target);e.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(h.gecko)w.on(d,"dragstart",function(a){var b=new n(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(a)}});p._initIFrame=function(a){var b=r.getInstance(a),c=b.get("document")[0],
a=c.getElementById("ke_actscript");m.remove(a);b._fixByBindIframeDoc();var d=c.body;s?(d.hideFocus=v,d.disabled=v,d.contentEditable=v,d.removeAttribute("disabled")):setTimeout(function(){h.gecko||h.opera?d.contentEditable=v:h.webkit?d.parentNode.contentEditable=v:c.designMode="on"},0);if(h.gecko||h.opera){var e=c.documentElement;w.on(e,"mousedown",function(a){if(a.target==e){h.gecko&&i(c,k);b.activateGecko()}})}setTimeout(function(){s&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";
d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),e=b.get("disableInlineTableEditing");if(a||e)try{c.execCommand("enableObjectResizing",k,!a);c.execCommand("enableInlineTableEditing",k,!e)}catch(g){w.on(d,s?"resizestart":"resize",function(b){var c=new n(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};return p},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
