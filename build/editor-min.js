/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 9 14:53
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(k,q,s,r){q=r.create(s.Controller,[r.Box],{initializer:function(){var k;this.__commands={};this.__dialogs={};if(k=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var o=k.next();o?this.__set("elBefore",o):this.__set("render",k.parent())}this.get("width")||this.__set("width",k.style("width")||k.css("width"));this.get("height")||this.__set("height",k.style("height")||k.css("height"))}else this.__editor_created_new=1},use:function(j,o){for(var p=
this,n=p.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],j=j.split(","),a=j.length-1;0<=a;a--)j[a]||j.splice(a,1);for(a=0;a<n.length;a++){var d=n[a];k.inArray(d,j)||j.unshift(d)}k.each(j,function(a,d){j[d]&&(j[d]="editor/plugin/"+a+"/")});k.use(j.join(","),function(){var a=k.makeArray(arguments);a.shift();for(var d=0;d<a.length;d++)a[d].init(p);o&&o.call(p)});p.__CORE_PLUGINS=[];return p}},{Config:{base:k.Config.base+"editor/"},XHTML_DTD:q.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(k){return this._setData(k)}},formatData:{getter:function(){return this._getData(1)},setter:function(k){return this._setData(k)}},prefixCls:{value:"ke-"}}},"Editor");q.DefaultRender=r.create(s.Render,[r.Box.Render],{_uiSetHeight:function(){}});k.mix(q,k.EventTarget);return KISSY.Editor=q},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(k){function q(i){this.editor=i;this._init()}function s(i){if(o.ie&&"BackCompat"!=i.get("document")[0].compatMode){var l=i.getSelection(),g;if(l.getType()==x.SELECTION_ELEMENT&&(g=l.getSelectedElement())){var b=l.getRanges()[0],f=new j(i.get("document")[0].createTextNode(""));f.insertBefore(g);b.setStartBefore(f);b.setEndAfter(g);l.selectRanges([b]);setTimeout(function(){g.parent()&&(f.remove(),l.selectElement(g))},0)}}}var r=k.Editor,j=k.Node,o=k.UA,
p=r.Range,n=r.RANGE,a=k.Event;k.augment(q,{_init:function(){var i=this.editor;a.on(i.get("document")[0].body,o.webkit?"paste":o.gecko?"paste":"beforepaste",this._paste,this);a.on(i.get("document")[0].body,"contextmenu",function(){l=1;setTimeout(function(){l=0},10)});i.addCommand("copy",new m("copy"));i.addCommand("cut",new m("cut"));i.addCommand("paste",new m("paste"))},_paste:function(){if(!l){var i=this.editor,a=i.get("document")[0];if(!a.getElementById("ke_pastebin")){var g=i.getSelection(),b=
new p(a),f=new j(o.webkit?"<body></body>":"<div></div>",null,a);f.attr("id","ke_pastebin");o.webkit&&f[0].appendChild(a.createTextNode("\u00a0"));a.body.appendChild(f[0]);f.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});f.css("left","-1000px");var c=g.createBookmarks();b.setStartAt(f,n.POSITION_AFTER_START);b.setEndAt(f,n.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){f.remove();var b;f=o.webkit&&(b=f.first())&&b.hasClass("Apple-style-span")?
b:f;g.selectBookmarks(c);b=f.html();if(b=k.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var l=i.fire("paste",{html:b,holder:f});void 0!==l&&(b=l);l=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)&&(l=i.htmlDataProcessor.wordFilter);i.insertHtml(b,l)}},0)}}}});var d=function(i,l){var g=i.get("document")[0],b=new j(g.body),f=!1,c=function(){f=!0};b.on(l,c);(7<o.ie?g:g.selection.createRange()).execCommand(l);b.detach(l,c);return f},h=o.ie?function(i,l){return d(i,
l)}:function(i,l){try{return i.get("document")[0].execCommand(l)}catch(g){return!1}},e={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},m=function(i){this.type=i};m.prototype={exec:function(i){"cut"==this.type&&s(i);(i=h(i,this.type))||alert(e[this.type]);return i}};var x=r.Selection,i={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},l;r.on("contextmenu",function(l){var a=l.contextmenu,g=a.get("editor"),
b=a.menu.get("contentEl"),f={copy:0,cut:0,paste:0},c;for(c in f)f.hasOwnProperty(c)&&(f[c]=b.one(".ke-paste-"+c),f[c]||function(c){var l=(new j("<a href='#'class='ke-paste-"+c+"'>"+i[c]+"</a>")).appendTo(b);l.on("click",function(b){b.halt();a.hide();setTimeout(function(){g.execCommand(c)},30)});f[c]=l}(c))});return{init:function(i){i.docReady(function(){new q(i)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(k){function q(i,l){var a=i[l?"next":"prev"]();if(a&&a[0].nodeType==d.NODE_ELEMENT){for(var e=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(s);)if(e.push(a),a=l?a.next():a.prev(),!a)return;if(i._4e_isIdentical(a,s)){for(var g=new p(l?i[0].lastChild:i[0].firstChild);e.length;)e.shift()._4e_move(i,!l,s);a._4e_moveChildren(i,!l,s);a.remove();g[0]&&g[0].nodeType==d.NODE_ELEMENT&&g._4e_mergeSiblings()}}}var s=s,r=k.Editor,j=k.DOM,o=k.UA,p=k.Node,n=r.Utils,
a={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var d=r.NODE,h=r.POSITION,e={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},m={hr:1},x=function(i){return i&&(i[0]||i)};n.injectDom({_4e_isBlockBoundary:function(i,l){var a=k.merge(m,l);return!(!e[j.css(i,"display")]&&!a[j._4e_name(i)])},_4e_getWin:j._getWin,_4e_index:function(i,l){for(var a=i.parentNode.childNodes,d,g=-1,b=0;b<a.length;b++)if(d=a[b],!l||!(3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType))if(g++,d===i)return g;return-1},_4e_move:function(i,
l,a){l=x(l);a?l.insertBefore(i,l.firstChild):l.appendChild(i)},_4e_name:function(i){var l=i.nodeName.toLowerCase();o.ie&&(i=i.scopeName)&&"HTML"!=i&&(l=i.toLowerCase()+":"+l);return l},_4e_isIdentical:function(i,l){if(!l)return!1;l=x(l);if(j._4e_name(i)!=j._4e_name(l))return!1;var a=i.attributes,d=l.attributes,g=a.length,b=d.length;if(g!=b)return!1;for(var f=0;f<g;f++){var c=a[f],v=c.name;if(c.specified&&j.attr(i,v)!=j.attr(l,v))return!1}if(8>n.ieEngine)for(f=0;f<b;f++)if(c=d[f],v=c.name,c.specified&&
j.attr(i,v)!=j.attr(l,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(i){for(var i=i.childNodes,l=0,a=i.length;l<a;l++){var e=i[l],g=e.nodeType;if(!(g==d.NODE_ELEMENT&&e.getAttribute("_ke_bookmark"))&&(g==d.NODE_ELEMENT&&!j._4e_isEmptyInlineRemovable(e)||g==d.NODE_TEXT&&k.trim(e.nodeValue)))return!1}return!0},_4e_moveChildren:function(i,l,a){l=x(l);if(i!=l)if(a)for(;a=i.lastChild;)l.insertBefore(i.removeChild(a),l.firstChild);else for(;a=i.firstChild;)l.appendChild(i.removeChild(a))},_4e_mergeSiblings:function(i){i=
new p(i);a[i._4e_name()]&&(q(i,!0),q(i))},_4e_splitText:function(i,a){var e=i.ownerDocument;if(i.nodeType==d.NODE_TEXT){if(o.ie&&a==i.nodeValue.length){var h=e.createTextNode("");j.insertAfter(h,i);return h}h=i.splitText(a);e.documentMode&&(e=e.createTextNode(""),j.insertAfter(e,h),j.remove(e));return h}},_4e_parents:function(i,a){var d=[];d.__IS_NODELIST=1;do d[a?"push":"unshift"](i);while(i=i.parentNode);return d},_4e_nextSourceNode:function(i,a,e,h){if(h&&!h.call)var g=x(h),h=function(b){return b!==
g};var a=!a&&i.firstChild,b=i;if(!a){if(i.nodeType==d.NODE_ELEMENT&&h&&!1===h(i,!0))return null;a=i.nextSibling}for(;!a&&(b=b.parentNode);){if(h&&!1===h(b,!0))return null;a=b.nextSibling}return!a||h&&!1===h(a)?null:e&&e!=a.nodeType?j._4e_nextSourceNode(a,!1,e,h):a},_4e_previousSourceNode:function(i,a,e,h){if(h&&!h.call)var g=x(h),h=function(b){return b!==g};var a=!a&&i.lastChild,b=i;if(!a){if(i.nodeType==d.NODE_ELEMENT&&h&&!1===h(i,!0))return null;a=i.previousSibling}for(;!a&&(b=b.parentNode);){if(h&&
!1===h(b,!0))return null;a=b.previousSibling}return!a||h&&!1===h(a)?null:e&&a.nodeType!=e?j._4e_previousSourceNode(a,!1,e,h):a},_4e_commonAncestor:function(i,a){a=x(a);if(i===a)return i;if(j.contains(a,i))return a;var d=i;do if(j.contains(d,a))return d;while(d=d.parentNode);return null},_4e_hasAttributes:9>n.ieEngine?function(a){for(var d=a.attributes,e=0;e<d.length;e++){var h=d[e];switch(h.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(h.specified)return!0}}return!1}:function(a){o.gecko&&
a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,l){var e=x(l);if(a.compareDocumentPosition)return a.compareDocumentPosition(e);if(a==e)return h.POSITION_IDENTICAL;if(a.nodeType==d.NODE_ELEMENT&&e.nodeType==d.NODE_ELEMENT){if(j.contains(a,e))return h.POSITION_CONTAINS+h.POSITION_PRECEDING;if(j.contains(e,a))return h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>e.sourceIndex?h.POSITION_DISCONNECTED:a.sourceIndex<e.sourceIndex?
h.POSITION_PRECEDING:h.POSITION_FOLLOWING}for(var m=j._4e_address(a),e=j._4e_address(e),g=Math.min(m.length,e.length),b=0;b<=g-1;b++)if(m[b]!=e[b])return m[b]<e[b]?h.POSITION_PRECEDING:h.POSITION_FOLLOWING;return m.length<e.length?h.POSITION_CONTAINS+h.POSITION_PRECEDING:h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING},_4e_address:function(a,d){for(var e=[],h=a.ownerDocument.documentElement,g=a;g&&g!=h;)e.unshift(j._4e_index(g,d)),g=g.parentNode;return e},_4e_remove:function(a,d){var e=a.parentNode;
if(e){if(d)for(var h;h=a.firstChild;)e.insertBefore(a.removeChild(h),a);e.removeChild(a)}return a},_4e_trim:function(a){j._4e_ltrim(a);j._4e_rtrim(a)},_4e_ltrim:function(a){for(var e;e=a.firstChild;){if(e.nodeType==d.NODE_TEXT){var h=n.ltrim(e.nodeValue),m=e.nodeValue.length;if(h)h.length<m&&(j._4e_splitText(e,m-h.length),a.removeChild(a.firstChild));else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){for(var e;e=a.lastChild;){if(e.type==d.NODE_TEXT){var h=n.rtrim(e.nodeValue),m=e.nodeValue.length;
if(h)h.length<m&&(j._4e_splitText(e,h.length),a.removeChild(a.lastChild));else{a.removeChild(e);continue}}break}!o.ie&&!o.opera&&(e=a.lastChild)&&1==e.nodeType&&"br"==j._4e_name(e)&&a.removeChild(e)},_4e_appendBogus:function(a){for(var e=a.lastChild;e&&e.nodeType==d.NODE_TEXT&&!k.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==d.NODE_TEXT||"br"!==j._4e_name(e))e=o.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),o.gecko&&e.setAttribute("type","_moz"),a.appendChild(e)},
_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var e=a.ownerDocument.createElement("div");e.appendChild(a.cloneNode(!0));return e.innerHTML},_4e_setMarker:function(a,e,d,h){var a=new p(a),g=a.data("list_marker_id")||a.data("list_marker_id",k.guid()).data("list_marker_id"),b=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");e[g]=a;b[d]=1;return a.data(d,h)},_4e_clearMarkers:function(a,e,d){var a=new p(a),h=a.data("list_marker_names"),
g=a.data("list_marker_id"),b;for(b in h)h.hasOwnProperty(b)&&a.removeData(b);a.removeData("list_marker_names");d&&(a.removeData("list_marker_id"),delete e[g])},_4e_copyAttributes:function(a,e,d){for(var e=new p(e),h=a.attributes,d=d||{},g=0;g<h.length;g++){var b=h[g],f=b.name.toLowerCase(),c;if(!(f in d))if("checked"==f&&(c=j.attr(a,f)))e.attr(f,c);else if(b.specified||o.ie&&b.value&&"value"==f)c=j.attr(a,f),null===c&&(c=b.nodeValue),e.attr(f,c)}""!==a.style.cssText&&(e[0].style.cssText=a.style.cssText)},
_4e_isEditable:function(a){var a=j._4e_name(a),e=r.XHTML_DTD;return(a=!e.$nonEditable[a]&&(e[a]||e.span))&&a["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(k){function q(a){1>arguments.length||(this.range=a,this.forceBrBreak=r,this.enlargeBr=s,this.enforceRealBlocks=r,this._||(this._={}))}var s=!0,r=!1,j=k.Editor,o=k.UA,p=j.Walker,n=j.Range,a=j.RANGE,d=j.NODE,h=j.ElementPath,e=k.Node,m=k.DOM,x=/^[\r\n\t ]*$/;k.augment(q,{getNextParagraph:function(i){var l,j,w,g,b;if(!this._.lastNode){j=this.range.clone();j.shrink(a.SHRINK_ELEMENT,s);j.enlarge(this.forceBrBreak||!this.enlargeBr?a.ENLARGE_LIST_ITEM_CONTENTS:
a.ENLARGE_BLOCK_CONTENTS);var f=new p(j),c=p.bookmark(s,s);f.evaluator=c;this._.nextNode=f.next();f=new p(j);f.evaluator=c;f=f.previous();this._.lastNode=f._4e_nextSourceNode(s);this._.lastNode&&this._.lastNode[0].nodeType==d.NODE_TEXT&&!k.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(c=new n(j.document),c.moveToPosition(this._.lastNode,a.POSITION_AFTER_END),c.checkEndOfBlock()&&(c=new h(c.endContainer),this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(s)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new e(j.document.createTextNode("")),m.insertAfter(this._.lastNode[0],f[0]));j=null}c=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;c;){var v=r,t=c[0].nodeType!=d.NODE_ELEMENT,u=r;if(t)c[0].nodeType==d.NODE_TEXT&&x.test(c[0].nodeValue)&&(t=r);else{var z=c._4e_name();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==z)t=s;else if(!j&&!c[0].childNodes.length&&"hr"!=z){l=c;w=c.equals(f);break}j&&(j.setEndAt(c,a.POSITION_BEFORE_START),
"br"!=z&&(this._.nextNode=c));v=s}else{if(c[0].firstChild){j||(j=new n(this.range.document),j.setStartAt(c,a.POSITION_BEFORE_START));c=new e(c[0].firstChild);continue}t=s}}t&&!j&&(j=new n(this.range.document),j.setStartAt(c,a.POSITION_BEFORE_START));w=(!v||t)&&c.equals(f);if(j&&!v)for(;!c[0].nextSibling&&!w;){z=c.parent();if(z._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){v=s;w||z.equals(f);break}c=z;t=s;w=c.equals(f);u=s}t&&j.setEndAt(c,a.POSITION_AFTER_END);c=c._4e_nextSourceNode(u,null,f);if((w=
!c)||v&&j)break}if(!l){if(!j)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;l=new h(j.startContainer);c=l.blockLimit;v={div:1,th:1,td:1};l=l.block;if((!l||!l[0])&&!this.enforceRealBlocks&&v[c._4e_name()]&&j.checkStartOfBlock()&&j.checkEndOfBlock())l=c;else if(!l||this.enforceRealBlocks&&"li"==l._4e_name())l=new e(this.range.document.createElement(i||"p")),l[0].appendChild(j.extractContents()),l._4e_trim(),j.insertNode(l),g=b=s;else if("li"!=l._4e_name()){if(!j.checkStartOfBlock()||
!j.checkEndOfBlock())l=l.clone(r),l[0].appendChild(j.extractContents()),l._4e_trim(),b=j.splitBlock(),g=!b.wasStartOfBlock,b=!b.wasEndOfBlock,j.insertNode(l)}else w||(this._.nextNode=l.equals(f)?null:j.getBoundaryNodes().endNode._4e_nextSourceNode(s,null,f))}g&&(j=new e(l[0].previousSibling),j[0]&&j[0].nodeType==d.NODE_ELEMENT&&("br"==j._4e_name()?j._4e_remove():j[0].lastChild&&"br"==m._4e_name(j[0].lastChild)&&m._4e_remove(j[0].lastChild)));b&&(j=p.bookmark(r,s),g=new e(l[0].lastChild),g[0]&&g[0].nodeType==
d.NODE_ELEMENT&&"br"==g._4e_name()&&(o.ie||g.prev(j)||g.next(j))&&g.remove());this._.nextNode||(this._.nextNode=w||l.equals(f)?null:l._4e_nextSourceNode(s,null,f));return l}});n.prototype.createIterator=function(){return new q(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(k){function q(d){for(var h=p,e=p,m=[];d;){if(d[0].nodeType==o.NODE_ELEMENT){this.lastElement||(this.lastElement=d);var k=d._4e_name();if(!e&&(!h&&n[k]&&(h=d),a[k])){var i;if(i=!h)if(i="div"==k){a:{i=d[0].childNodes;for(var l=0,q=i.length;l<q;l++){var w=i[l];if(w.nodeType==o.NODE_ELEMENT&&j.$block[w.nodeName.toLowerCase()]){i=!0;break a}}i=!1}i=!i}i?h=d:e=d}m.push(d);if("body"==k)break}d=d.parent()}this.block=h;this.blockLimit=e;this.elements=m}var s=k.Editor,
r=k.DOM,j=s.XHTML_DTD,o=s.NODE,p=null,n={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},a={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};q.prototype={compare:function(a){var h=this.elements,a=a&&a.elements;if(!a||h.length!=a.length)return!1;for(var e=0;e<h.length;e++)if(!r.equals(h[e],a[e]))return!1;return!0},contains:function(a){for(var h=this.elements,e=0;e<h.length;e++)if(h[e]._4e_name()in a)return h[e];return p},toString:function(){var a=this.elements,
h,e=[];for(h=0;h<a.length;h++)e.push(a[h]._4e_name());return e.toString()}};s.ElementPath=q},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(k){function q(a){var m;m=a.getSelection().getRanges();for(var q=m.length-1;0<q;q--)m[q].deleteContents();m=m[0];q=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var i=(new h(m.startContainer)).block;if(i&&("li"==i._4e_name()||"li"==i.parent()._4e_name()))return a.hasCommand("outdent")?(a.execCommand("save"),a.execCommand("outdent"),a.execCommand("save"),!0):!1}var l=m.splitBlock("p");if(!l)return!0;var a=l.previousBlock,i=l.nextBlock,r=
l.wasStartOfBlock,w=l.wasEndOfBlock,g;if(i)g=i.parent(),"li"==g._4e_name()&&(i._4e_breakParent(g),i._4e_move(i.next(),!0));else if(a&&(g=a.parent())&&"li"==g._4e_name())a._4e_breakParent(g),m.moveToElementEditablePosition(a.next()),a._4e_move(a.prev());if(!r&&!w){if("li"==i._4e_name()&&(g=i.first(d.invisible(!0)))&&k.inArray(g._4e_name(),["ul","ol"]))(j.ie?new n(q.createTextNode("\u00a0")):new n(q.createElement("br"))).insertBefore(g);i&&m.moveToElementEditablePosition(i)}else{var b;if(a){if("li"==a._4e_name()||
!o.test(a._4e_name()))b=a.clone()}else i&&(b=i.clone());b||(b=new n("<p>",null,q));if(g=l.elementPath)for(var l=0,f=g.elements.length;l<f;l++){var c=g.elements[l];if(c.equals(g.block)||c.equals(g.blockLimit))break;p.$removeEmpty[c._4e_name()]&&(c=c.clone(),b._4e_moveChildren(c),b.append(c))}j.ie||b._4e_appendBogus();m.insertNode(b);if(j.ie&&r&&(!w||!a[0].childNodes.length))m.moveToElementEditablePosition(w?a:b),m.select();m.moveToElementEditablePosition(r&&!w?i:b)}j.ie||(i?(b=new n(q.createElement("span")),
b.html("&nbsp;"),m.insertNode(b),b.scrollIntoView(void 0,!1),m.deleteContents()):b.scrollIntoView(void 0,!1));m.select();return!0}function s(e){var d=e.get("document")[0];a.on(d,"keydown",function(a){if(13===a.keyCode&&!a.shiftKey&&!a.ctrlKey&&!a.metaKey){e.execCommand("save");var d=e.execCommand("enterBlock");e.execCommand("save");!1!==d&&a.preventDefault()}})}var r=k.Editor,j=k.UA,o=/^h[1-6]$/,p=r.XHTML_DTD,n=k.Node,a=k.Event,d=r.Walker,h=r.ElementPath;return{init:function(a){a.addCommand("enterBlock",
{exec:q});a.docReady(function(){s(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(k){function q(){var e=this;e.__iframeFocus=d;a=e;n&&clearTimeout(n);n=setTimeout(function(){e.fire("focus")},100)}function s(){var d=this;d.__iframeFocus=h;a=e;n&&clearTimeout(n);n=setTimeout(function(){d.fire("blur")},100)}var r=k.Editor,j=k.DOM,o=k.Event,p={},n,a,k={refreshAll:function(){for(var a in p)if(p.hasOwnProperty(a)){var e=p[a].get("document")[0];e.designMode="off";e.designMode="on"}},currentInstance:function(){return a},getInstance:function(a){return p[a]},
add:function(a){var e=j._4e_getWin(a.get("document")[0]);o.on(e,"focus",q,a);o.on(e,"blur",s,a)},register:function(a){p[a._UUID]=a},remove:function(a){delete p[a._UUID];var e=j._4e_getWin(a.get("document")[0]);o.remove(e,"focus",q,a);o.remove(e,"blur",s,a)}},d=!0,h=!1,e=null;k.refreshAll=k.refreshAll;r.focusManager=k;r.getInstances=function(){return p};return k},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(k){return{init:function(q){function s(a){return a.replace(x,function(a,e,b){return"<"+e+b.replace(i,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function r(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+l+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function j(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,e){return decodeURIComponent(e)})}
var o=o,p=k.Editor,n=k.Node,a=k.UA,d=k.require("htmlparser"),h=new d.Filter,e=new d.Filter,m=new d.Filter;(function(){var i=function(a,f){return function(c,e){var g=[];(""+c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,c,d){c=c.toLowerCase();"font-family"==c&&(d=d.replace(/["']/g,""));for(var h,i,l,j=0;j<a.length;j++)if(a[j]&&(z=a[j][0],h=a[j][1],i=a[j][2],l=a[j][3],c.match(z)&&(!h||d.match(h)))){c=l||c;f&&(i=i||d);"function"==typeof i&&(i=i(d,e,c));i&&i.push&&
(c=i[0],i=i[1]);"string"==typeof i&&g.push([c,i]);return}!f&&g.push([c,d])});for(var d=0;d<g.length;d++)g[d]=g[d].join(":");return g.length?g.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],o),j={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var f=a.nodeName||"";if(-1!=f.indexOf(":")&&
!/^ke/.test(f))if("v:imagedata"==f){if(f=a.getAttribute("o:href"))a.setAttribute("src",f),a.removeAttribute("o:href");if(f=a.getAttribute("o:title"))a.setAttribute("title",f),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=i(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var f=
["name","href","src"],c,e=0;e<f.length;e++)c="_ke_saved_"+f[e],a.getAttribute(c)&&a.removeAttribute(f[e]);return a},embed:function(a){var f=a.parentNode;if(f&&"object"==f.nodeName){var c=f.getAttribute("width"),f=f.getAttribute("height");c&&a.setAttribute("width",c);f&&a.setAttribute("width",f)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!k.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,l.length)==l?(a="{C}"==a.substr(l.length,3)?a.substr(l.length+3):a.substr(l.length),new d.CData(decodeURIComponent(a))):a}};a.ie&&(g.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});h.addRules(g);e.addRules(j);m.addRules(j)})();(function(){function i(a){for(var a=a.childNodes,b=a.length,f=a[b-1];f&&3==f.nodeType&&!k.trim(f.nodeValue);)f=a[--b];return f}
function l(b,f){var z=i(b);z&&((f||!a.ie)&&1==z.nodeType&&"br"==z.nodeName?b.removeChild(z):3==z.nodeType&&c.test(z.nodeValue)&&b.removeChild(z))}function g(a){var b=i(a);return!b||1==b.nodeType&&"br"==b.nodeName||"form"==a.nodeName&&"input"==b.nodeName}function b(b){l(b,!0);g(b)&&(a.ie?b.appendChild(new d.Text("\u00a0")):(b.appendChild(new d.Text("&nbsp;")),b.appendChild(new d.Tag("br"))))}function f(a){l(a,!1);g(a)&&a.appendChild(new d.Text("\u00a0"))}var c=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,v=p.XHTML_DTD,j=p.Utils.mix({},
v.$block,v.$listItem,v.$tableContent),u;for(u in j)j.hasOwnProperty(u)&&("br"in v[u]||delete j[u]);delete j.td;delete j.pre;var v={tags:{}},z={tags:{}};for(u in j)j.hasOwnProperty(u)&&(v.tags[u]=b,z.tags[u]=f);e.addRules(v);h.addRules(z);m.addRules(v)})();(function(){h.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var x=/<(a|area|img|input)\b([^>]*)>/gi,i=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,l="{ke_protected}";q.htmlDataProcessor={wordFilter:m,
dataFilter:e,htmlFilter:h,toHtml:function(a){var e=new d.BeautifyWriter;(new d.Parser(a)).parse().writeHtml(e,h);return e.getHtml()},toDataFormat:function(i,h,g){g=g||e;a.gecko&&(i=i.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));i=s(i);h=new n("<div>");h.html("a"+i);i=h.html().substr(1);i=j(i);h=new d.BeautifyWriter;(new d.Parser(i)).parse().writeHtml(h,g);i=h.getHtml();return i=r(i)},toServer:function(a){var e=new d.MinifyWriter;(new d.Parser(a)).parse().writeHtml(e,
h);return e.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(k){function q(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=h;this.collapsed=a;this.document=b}function s(a){var b=a.nodeType!=e.NODE_TEXT&&l._4e_name(a)in g.$removeEmpty,f=!k.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||f||a}function r(a){return!t(a)&&!u(a)}function j(b){var f=d,c=i.bookmark(a);return function(g){if(c(g))return a;if(g.nodeType==e.NODE_TEXT){if(k.trim(g.nodeValue).length)return d}else if(g.nodeType==
e.NODE_ELEMENT&&(g=l._4e_name(g),!v[g]))if(!b&&!w.ie&&"br"==g&&!f)f=a;else return d;return a}}function o(a,b){function f(a){return a&&"span"==a.nodeName&&a.getAttribute("_ke_bookmark")}return function(c){var e,g;e=c&&!c.nodeName&&(g=c.parentNode)&&f(g);e=a?e:e||f(c);return b^e}}function p(a){return function(b){b=(b=b[0]||b)&&b.nodeType==e.NODE_TEXT&&!k.trim(b.nodeValue);return a^b}}var n=k.Editor;n.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var a=!0,d=!1,h=null,e=n.NODE,m=n.RANGE,x=n.POSITION,i=n.Walker,l=k.DOM,y=n.Utils.getByAddress,w=k.UA,g=n.XHTML_DTD,b=n.ElementPath,f=k.Node,c={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};q.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};k.augment(q,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&l.equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=e.NODE_ELEMENT&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.NODE_ELEMENT&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):
this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a._4e_name()&&a.attr("_ke_bookmark")&&this.setStartAt(a,m.POSITION_BEFORE_START);b&&"span"==b._4e_name()&&b.attr("_ke_bookmark")&&
this.setEndAt(b,m.POSITION_AFTER_END)},setStart:function(a,b){a[0].nodeType==e.NODE_ELEMENT&&c[a._4e_name()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);this.updateCollapsed()},setEnd:function(a,b){a[0].nodeType==e.NODE_ELEMENT&&c[a._4e_name()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);this.updateCollapsed()},setStartAt:function(a,
b){switch(b){case m.POSITION_AFTER_START:this.setStart(a,0);break;case m.POSITION_BEFORE_END:a[0].nodeType==e.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case m.POSITION_BEFORE_START:this.setStartBefore(a);break;case m.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,b){switch(b){case m.POSITION_AFTER_START:this.setEnd(a,0);break;case m.POSITION_BEFORE_END:a[0].nodeType==e.NODE_TEXT?this.setEnd(a,a[0].nodeValue.length):
this.setEnd(a,a[0].childNodes.length);break;case m.POSITION_BEFORE_START:this.setEndBefore(a);break;case m.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(b,c){var g=this.startContainer,d=this.endContainer,i=this.startOffset,h=this.endOffset,v,j=this.document,k;this.optimizeBookmark();d[0].nodeType==e.NODE_TEXT?d=d._4e_splitText(h):0<d[0].childNodes.length&&(h>=d[0].childNodes.length?(d=new f(d[0].appendChild(j.createTextNode(""))),k=a):d=new f(d[0].childNodes[h]));
g[0].nodeType==e.NODE_TEXT?(g._4e_splitText(i),g.equals(d)&&(d=new f(g[0].nextSibling))):i?i>=g[0].childNodes.length?(v=new f(j.createTextNode("")),g.append(v),g=v,v=a):g=new f(g[0].childNodes[i].previousSibling):(v=new f(j.createTextNode("")),g.prepend(v),g=v,v=a);var m=g._4e_parents(),t=d._4e_parents();m.each(function(a,b){m[b]=a});t.each(function(a,b){t[b]=a});for(var u,n,j=0;j<m.length&&!(u=m[j],n=t[j],!u.equals(n));j++);for(var i=c,q,w,I=j;I<m.length;I++){q=m[I];h=i&&!q.equals(g)?i.appendChild(q.clone()[0]):
null;for(q=q[0].nextSibling;q&&!l.equals(t[I],q)&&!l.equals(d,q);)w=q.nextSibling,2==b?i.appendChild(q.cloneNode(a)):(l._4e_remove(q),1==b&&i.appendChild(q)),q=w;h&&(i=h)}for(i=c;j<t.length;j++){q=t[j];h=i&&0<b&&!q.equals(d)?i.appendChild(q.clone()[0]):null;if(!m[j]||!q.parent().equals(m[j].parent()))for(q=q[0].previousSibling;q&&!l.equals(m[j],q)&&!l.equals(g,q);)w=q.previousSibling,2==b?i.insertBefore(q.cloneNode(a),i.firstChild):(l._4e_remove(q),1==b&&i.insertBefore(q,i.firstChild)),q=w;h&&(i=
h)}if(2==b){if(n=this.startContainer[0],n.nodeType==e.NODE_TEXT&&n.nextSibling&&n.nextSibling.nodeType==e.NODE_TEXT&&(n.data+=n.nextSibling.data,n.parentNode.removeChild(n.nextSibling)),n=this.endContainer[0],n.nodeType==e.NODE_TEXT&&n.nextSibling&&n.nextSibling.nodeType==e.NODE_TEXT)n.data+=n.nextSibling.data,n.parentNode.removeChild(n.nextSibling)}else{if(u&&n&&(!g.parent().equals(u.parent())||!d.parent().equals(n.parent())))u=n._4e_index(),v&&n.parent().equals(g.parent())&&u--,this.setStart(n.parent(),
u);this.collapse(a)}v&&g._4e_remove();k&&d[0].parentNode&&d._4e_remove()},collapse:function(b){b?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=a},clone:function(){var a=new q(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var b=
this.clone();b.optimize();if(b.startContainer[0].nodeType!=e.NODE_ELEMENT||b.endContainer[0].nodeType!=e.NODE_ELEMENT)return h;var f=new n.Walker(b),c=o(a,void 0),g=p(a);b.evaluator=function(a){return g(a)&&c(a)};b=f.next();f.reset();f=f.previous();return b&&b.equals(f)?b:h},shrink:function(b,f){if(!this.collapsed){var b=b||m.SHRINK_TEXT,c=this.clone(),g=this.startContainer,h=this.endContainer,v=this.startOffset,j=this.endOffset,l=1,k=1;g&&g[0].nodeType==e.NODE_TEXT&&(v?v>=g[0].nodeValue.length?c.setStartAfter(g):
(c.setStartBefore(g),l=0):c.setStartBefore(g));h&&h[0].nodeType==e.NODE_TEXT&&(j?j>=h[0].nodeValue.length?c.setEndAfter(h):(c.setEndAfter(h),k=0):c.setEndBefore(h));c=new i(c);c.evaluator=function(a){return a.nodeType==(b==m.SHRINK_ELEMENT?e.NODE_ELEMENT:e.NODE_TEXT)};var t;c.guard=function(f,c){f=f[0]||f;if(b==m.SHRINK_ELEMENT&&f.nodeType==e.NODE_TEXT||c&&f==t)return d;!c&&f.nodeType==e.NODE_ELEMENT&&(t=f);return a};l&&(g=c[b==m.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,f?m.POSITION_AFTER_START:
m.POSITION_BEFORE_START);k&&(c.reset(),(c=c[b==m.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(c,f?m.POSITION_BEFORE_END:m.POSITION_AFTER_END));return!(!l&&!k)}},createBookmark2:function(b){var c=this.startContainer,g=this.endContainer,d=this.startOffset,i=this.endOffset,v,j;if(!c||!g)return{start:0,end:0};if(b){if(c[0].nodeType==e.NODE_ELEMENT&&(v=new f(c[0].childNodes[d]))&&v[0]&&v[0].nodeType==e.NODE_TEXT&&0<d&&v[0].previousSibling.nodeType==e.NODE_TEXT)c=v,d=0;for(;c[0].nodeType==
e.NODE_TEXT&&(j=c.prev())&&j[0].nodeType==e.NODE_TEXT;)c=j,d+=j[0].nodeValue.length;if(!this.collapsed){if(g[0].nodeType==e.NODE_ELEMENT&&(v=new f(g[0].childNodes[i]))&&v[0]&&v[0].nodeType==e.NODE_TEXT&&0<i&&v[0].previousSibling.nodeType==e.NODE_TEXT)g=v,i=0;for(;g[0].nodeType==e.NODE_TEXT&&(j=g.prev())&&j[0].nodeType==e.NODE_TEXT;)g=j,i+=j[0].nodeValue.length}}return{start:c._4e_address(b),end:this.collapsed?h:g._4e_address(b),startOffset:d,endOffset:i,normalized:b,is2:a}},createBookmark:function(b){var c,
g,e,d,i=this.collapsed;c=new f("<span>",h,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(e=k.guid("ke_bm_"),c.attr("id",e+"S"));i||(g=c.clone(),g.html("&nbsp;"),b&&g.attr("id",e+"E"),d=this.clone(),d.collapse(),d.insertNode(g));d=this.clone();d.collapse(a);d.insertNode(c);g?(this.setStartAfter(c),this.setEndBefore(g)):this.moveToPosition(c,m.POSITION_AFTER_END);return{startNode:b?e+"S":c,endNode:b?e+"E":g,serializable:b,collapsed:i}},moveToPosition:function(b,
f){this.setStartAt(b,f);this.collapse(a)},trim:function(b,f){var c=this.startContainer,g=this.startOffset,d=this.collapsed;if((!b||d)&&c[0]&&c[0].nodeType==e.NODE_TEXT){if(g)if(g>=c[0].nodeValue.length)g=c._4e_index()+1,c=c.parent();else{var i=c._4e_splitText(g),g=c._4e_index()+1,c=c.parent();l.equals(this.startContainer,this.endContainer)?this.setEnd(i,this.endOffset-this.startOffset):l.equals(c,this.endContainer)&&(this.endOffset+=1)}else g=c._4e_index(),c=c.parent();this.setStart(c,g);if(d){this.collapse(a);
return}}c=this.endContainer;g=this.endOffset;!f&&!d&&c[0]&&c[0].nodeType==e.NODE_TEXT&&(g?(g>=c.nodeValue.length||c._4e_splitText(g),g=c._4e_index()+1):g=c._4e_index(),c=c.parent(),this.setEnd(c,g))},insertNode:function(b){this.optimizeBookmark();this.trim(d,a);var f=this.startContainer;f[0].insertBefore(b[0]||b,f[0].childNodes[this.startOffset]||null);l.equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var f=y(this.document,b.start,
b.normalized),c=b.startOffset,g=b.end&&y(this.document,b.end,b.normalized),b=b.endOffset;this.setStart(f,c);g?this.setEnd(g,b):this.collapse(a)}else f=(c=b.serializable)?k.one("#"+b.startNode,this.document):b.startNode,b=c?k.one("#"+b.endNode,this.document):b.endNode,this.setStartBefore(f),f._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(a)},getCommonAncestor:function(a,b){var c=this.startContainer,g=this.endContainer,c=l.equals(c,g)?a&&c[0].nodeType==e.NODE_ELEMENT&&this.startOffset==
this.endOffset-1?new f(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(g);return b&&c[0].nodeType==e.NODE_TEXT?c.parent():c},enlarge:function(b){switch(b){case m.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),c=new f(this.document.body),v,j,t,u,n,w=d,o,p;o=this.startContainer;p=this.startOffset;if(o[0].nodeType==e.NODE_TEXT){if(p&&(o=!k.trim(o[0].nodeValue.substring(0,p)).length&&o,w=!!o),o&&!(u=o[0].previousSibling))t=o.parent()}else p&&(u=o[0].childNodes[p-1]||
o[0].lastChild),u||(t=o);for(;t||u;){if(t&&!u){!n&&l.equals(t,b)&&(n=a);if(!c.contains(t))break;if(!w||"inline"!=t.css("display"))w=d,n?v=t:this.setStartBefore(t);u=t[0].previousSibling}for(;u;){o=d;if(u.nodeType==e.NODE_TEXT)p=u.nodeValue,/[^\s\ufeff]/.test(p)&&(u=h),o=/[\s\ufeff]$/.test(p);else if((0<u.offsetWidth||"br"==l._4e_name(u))&&!u.getAttribute("_ke_bookmark"))if(w&&g.$removeEmpty[u.nodeName.toLowerCase()]){p=l.text(u);if(/[^\s\ufeff]/.test(p))u=h;else for(var r=u.all||u.getElementsByTagName("*"),
s=0,x;x=r[s++];)if(!g.$removeEmpty[x.nodeName.toLowerCase()]){u=h;break}u&&(o=!!p.length)}else u=h;o&&(w?n?v=t:t&&this.setStartBefore(t):w=a);if(u){o=u.previousSibling;if(!t&&!o){t=new f(u);u=h;break}u=o}else t=h}t&&(t=t.parent())}o=this.endContainer;p=this.endOffset;t=u=h;n=w=d;if(o[0].nodeType==e.NODE_TEXT){if(o=!k.trim(o[0].nodeValue.substring(p)).length&&o,w=!(o&&o[0].nodeValue.length),o&&!(u=o[0].nextSibling))t=o.parent()}else(u=o[0].childNodes[p])||(t=o);for(;t||u;){if(t&&!u){!n&&l.equals(t,
b)&&(n=a);if(!c.contains(t))break;if(!w||"inline"!=t.css("display"))w=d,n?j=t:t&&this.setEndAfter(t);u=t[0].nextSibling}for(;u;){o=d;if(u.nodeType==e.NODE_TEXT)p=u.nodeValue,/[^\s\ufeff]/.test(p)&&(u=h),o=/^[\s\ufeff]/.test(p);else if((0<u.offsetWidth||"br"==l._4e_name(u))&&!u.getAttribute("_ke_bookmark"))if(w&&g.$removeEmpty[u.nodeName.toLowerCase()]){p=l.text(u);if(/[^\s\ufeff]/.test(p))u=h;else{r=u.all||u.getElementsByTagName("*");for(s=0;x=r[s++];)if(!g.$removeEmpty[x.nodeName.toLowerCase()]){u=
h;break}}u&&(o=!!p.length)}else u=h;o&&w&&(n?j=t:this.setEndAfter(t));if(u){o=u.nextSibling;if(!t&&!o){t=new f(u);u=h;break}u=o}else t=h}t&&(t=t.parent())}v&&j&&(b=v.contains(j)?j:v,this.setStartBefore(b),this.setEndAfter(b));break;case m.ENLARGE_BLOCK_CONTENTS:case m.ENLARGE_LIST_ITEM_CONTENTS:t=new q(this.document);c=new f(this.document.body);t.setStartAt(c,m.POSITION_AFTER_START);t.setEnd(this.startContainer,this.startOffset);t=new i(t);var y,J,I=i.blockBoundary(b==m.ENLARGE_LIST_ITEM_CONTENTS?
{br:1}:h),L=function(a){var b=I(a);b||(y=new f(a));return b};v=function(a){var b=L(a);!b&&"br"==l._4e_name(a)&&(J=new f(a));return b};t.guard=L;t=t.lastBackward();y=y||c;this.setStartAt(y,"br"!=y._4e_name()&&(!t&&this.checkStartOfBlock()||t&&y.contains(t))?m.POSITION_AFTER_START:m.POSITION_AFTER_END);t=this.clone();t.collapse();t.setEndAt(c,m.POSITION_BEFORE_END);t=new i(t);t.guard=b==m.ENLARGE_LIST_ITEM_CONTENTS?v:L;y=h;t=t.lastForward();y=y||c;this.setEndAt(y,!t&&this.checkEndOfBlock()||t&&y.contains(t)?
m.POSITION_BEFORE_END:m.POSITION_BEFORE_START);J&&this.setEndAfter(J)}},checkStartOfBlock:function(){var c=this.startContainer,f=this.startOffset;if(f&&c[0].nodeType==e.NODE_TEXT&&k.trim(c[0].nodeValue.substring(0,f)).length)return d;this.trim();c=new b(this.startContainer);f=this.clone();f.collapse(a);f.setStartAt(c.block||c.blockLimit,m.POSITION_AFTER_START);c=new i(f);c.evaluator=j(a);return c.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,c=this.endOffset;if(a[0].nodeType==
e.NODE_TEXT&&k.trim(a[0].nodeValue.substring(c)).length)return d;this.trim();a=new b(this.endContainer);c=this.clone();c.collapse(d);c.setEndAt(a.block||a.blockLimit,m.POSITION_BEFORE_END);a=new i(c);a.evaluator=j(d);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,b){var c=this.clone();c[b==m.START?
"setStartAt":"setEndAt"](a,b==m.START?m.POSITION_AFTER_START:m.POSITION_BEFORE_END);c=new i(c);c.evaluator=s;return c[b==m.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,c=this.endContainer,g=this.startOffset,d=this.endOffset,i;if(b[0].nodeType==e.NODE_ELEMENT)if(i=b[0].childNodes.length,i>g)b=new f(b[0].childNodes[g]);else if(1>i)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new f(b);b=b._4e_nextSourceNode()||b}if(c[0].nodeType==
e.NODE_ELEMENT)if(i=c[0].childNodes.length,i>d)c=(new f(c[0].childNodes[d]))._4e_previousSourceNode(a);else if(1>i)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new f(c)}b._4e_position(c)&x.POSITION_FOLLOWING&&(b=c);return{startNode:b,endNode:c}},fixBlock:function(a,b){var c=this.createBookmark(),g=new f(this.document.createElement(b));this.collapse(a);this.enlarge(m.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();w.ie||g._4e_appendBogus();
this.insertNode(g);this.moveToBookmark(c);return g},splitBlock:function(c){var f=new b(this.startContainer),g=new b(this.endContainer),e=f.block,i=g.block,v=h;if(!f.blockLimit.equals(g.blockLimit))return h;"br"!=c&&(e||(e=this.fixBlock(a,c),i=(new b(this.endContainer)).block),i||(i=this.fixBlock(d,c)));c=e&&this.checkStartOfBlock();f=i&&this.checkEndOfBlock();this.deleteContents();e&&l.equals(e,i)&&(f?(v=new b(this.startContainer),this.moveToPosition(i,m.POSITION_AFTER_END),i=h):c?(v=new b(this.startContainer),
this.moveToPosition(e,m.POSITION_BEFORE_START),e=h):(i=this.splitElement(e),!w.ie&&!k.inArray(e._4e_name(),["ul","ol"])&&e._4e_appendBogus()));return{previousBlock:e,nextBlock:i,wasStartOfBlock:c,wasEndOfBlock:f,elementPath:v}},splitElement:function(a){if(!this.collapsed)return h;this.setEndAt(a,m.POSITION_BEFORE_END);var b=this.extractContents(),c=a.clone(d);c[0].appendChild(b);c.insertAfter(a);this.moveToPosition(a,m.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(b,c){var f,
i=g;if(i.$empty[b._4e_name()])return d;for(;b&&b[0].nodeType==e.NODE_ELEMENT;){if(f=b._4e_isEditable())this.moveToPosition(b,c?m.POSITION_BEFORE_END:m.POSITION_AFTER_START);else if(i.$inline[b._4e_name()])return this.moveToPosition(b,c?m.POSITION_AFTER_END:m.POSITION_BEFORE_START),a;if((b=i.$empty[b._4e_name()]?b[c?"prev":"next"](r):c?b.last(r):b.first(r))&&b[0].nodeType==e.NODE_TEXT)return this.moveToPosition(b,c?m.POSITION_AFTER_END:m.POSITION_BEFORE_START),a}return f},selectNodeContents:function(a){this.setStart(a,
0);this.setEnd(a,a[0].nodeType==e.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var v={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},t=new i.whitespaces,u=new i.bookmark;n.Utils.injectDom({_4e_breakParent:function(a,b){var c=n.Range,b=new f(b),c=new c(a.ownerDocument);c.setStartAfter(new f(a));c.setEndAfter(b);var g=c.extractContents();c.insertNode(new f(l._4e_remove(a)));
a.parentNode.insertBefore(g,a.nextSibling)}});n.Range=q},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(k){function q(a){this.document=a;this._={cache:{}};if(m){var f=this.getNative().createRange();if(!f||f.item&&f.item(0).ownerDocument!=a||f.parentElement&&f.parentElement().ownerDocument!=a)this.isInvalid=j}}function s(a){a=new q(a);return!a||a.isInvalid?o:a}var r=k.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var j=!0,o=null,p=k.UA,n=k.DOM,a=k.Node,d=r.SELECTION,h=r.RANGE,e=r.NODE,m=p.ie,x=r.Walker,i=r.Range,l={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};k.augment(q,{getNative:!m?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=n._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!m?function(){var a=this._.cache;if(a.type)return a.type;var f=d.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),
g=c.startContainer;g==c.endContainer&&g.nodeType==e.NODE_ELEMENT&&1==Number(c.endOffset-c.startOffset)&&l[g.childNodes[c.startOffset].nodeName.toLowerCase()]&&(f=d.SELECTION_ELEMENT)}}else f=d.SELECTION_NONE;return a.type=f}:function(){var a=this._.cache;if(a.type)return a.type;var f=d.SELECTION_NONE;try{var c=this.getNative(),g=c.type;"Text"==g&&(f=d.SELECTION_TEXT);"Control"==g&&(f=d.SELECTION_ELEMENT);c.createRange().parentElement&&(f=d.SELECTION_TEXT)}catch(e){}return a.type=f},getRanges:m?function(){var b=
function(a,b){a=a.duplicate();a.collapse(b);for(var g=a.parentElement(),i=g.childNodes,d,h=0;h<i.length;h++){var j=i[h];if(j.nodeType==e.NODE_ELEMENT){d=a.duplicate();d.moveToElementText(j);var j=d.compareEndPoints("StartToStart",a),l=d.compareEndPoints("EndToStart",a);d.collapse();if(0<j)break;else{if(!j||1==l&&-1==j)return{container:g,offset:h};if(!l)return{container:g,offset:h+1}}d=o}}d||(d=a.duplicate(),d.moveToElementText(g),d.collapse(!1));d.setEndPoint("StartToStart",a);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=i[--h].nodeValue.length}catch(k){d=0}return 0===d?{container:g,offset:h}:{container:i[h],offset:-d}};return function(f){var c=this._.cache;if(c.ranges&&!f)return c.ranges;var g=this.getNative(),f=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==d.SELECTION_TEXT)return g=new i(this.document),e=b(f,j),g.setStart(new a(e.container),e.offset),e=b(f),g.setEnd(new a(e.container),e.offset),c.ranges=[g];if(e==d.SELECTION_ELEMENT){c=c.ranges=[];for(e=0;e<f.length;e++){for(var h=
f.item(e),l=h.parentNode,k=0,g=new i(this.document);k<l.childNodes.length&&l.childNodes[k]!=h;k++);g.setStart(new a(l),k);g.setEnd(new a(l),k+1);c.push(g)}return c}return c.ranges=[]}}():function(b){var f=this._.cache;if(f.ranges&&!b)return f.ranges;var b=[],c=this.getNative();if(!c)return[];for(var g=0;g<c.rangeCount;g++){var e=c.getRangeAt(g),d=new i(this.document);d.setStart(new a(e.startContainer),e.startOffset);d.setEnd(new a(e.endContainer),e.endOffset);b.push(d)}return f.ranges=b},getStartElement:function(){var b=
this._.cache;if(void 0!==b.startElement)return b.startElement;var f,c=this.getNative();switch(this.getType()){case d.SELECTION_ELEMENT:return this.getSelectedElement();case d.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();j;)if(f=g.startContainer,g.startOffset==(f[0].nodeType===e.NODE_ELEMENT?f[0].childNodes.length:f[0].nodeValue.length)&&!f._4e_isBlockBoundary())g.setStartAfter(f);else break;f=g.startContainer;if(f[0].nodeType!=e.NODE_ELEMENT)return f.parent();f=new a(f[0].childNodes[g.startOffset]);
if(!f[0]||f[0].nodeType!=e.NODE_ELEMENT)return g.startContainer;for(g=f[0].firstChild;g&&g.nodeType==e.NODE_ELEMENT;)f=new a(g),g=g.firstChild;return f}if(m)g=c.createRange(),g.collapse(j),f=new a(g.parentElement());else{if((f=c.anchorNode)&&f.nodeType!=e.NODE_ELEMENT)f=f.parentNode;f&&(f=new a(f))}}return b.startElement=f},getSelectedElement:function(){var b,g=this._.cache;if(void 0!==g.selectedElement)return g.selectedElement;m&&(b=this.getNative().createRange(),b=b.item&&b.item(0));if(!b){b=this.getRanges()[0];
for(var c,d,i=2;i&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==e.NODE_ELEMENT&&l[c._4e_name()]&&(d=c)));i--)b.shrink(h.SHRINK_ELEMENT);b=d}return g.selectedElement=new a(b)},reset:function(){this._.cache={}},selectElement:function(a){var g,c=this.document;if(m)try{g=c.body.createControlRange(),g.addElement(a[0]),g.select()}catch(e){g=c.body.createTextRange(),g.moveToElementText(a[0]),g.select()}finally{}else g=c.createRange(),g.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(g);
this.reset()},selectRanges:function(a){if(m){if(1<a.length){var g=a[a.length-1];a[0].setEnd(g.endContainer,g.endOffset);a.length=1}a[0]&&a[0].select()}else{g=this.getNative();if(!g)return;g.removeAllRanges();for(var c=0;c<a.length;c++){var d=a[c],i=this.document.createRange(),h=d.startContainer;if(d.collapsed&&(p.gecko&&1.09>p.gecko||p.opera||p.webkit)&&h[0].nodeType==e.NODE_ELEMENT&&!h[0].childNodes.length)h[0].appendChild(this.document.createTextNode(p.webkit?"\u200b":"")),d.startOffset++,d.endOffset++;
i.setStart(h[0],d.startOffset);i.setEnd(d.endContainer[0],d.endOffset);g.addRange(i)}}this.reset()},createBookmarks2:function(a){for(var g=[],c=this.getRanges(),e=0;e<c.length;e++)g.push(c[e].createBookmark2(a));return g},createBookmarks:function(a,g){for(var c=[],e=this.document,d,g=g||this.getRanges(),i=g.length,h=0;h<i;h++){c.push(d=g[h].createBookmark(a,j));var l=(a=d.serializable)?k.one("#"+d.startNode,e):d.startNode;d=a?k.one("#"+d.endNode,e):d.endNode;for(var m=h+1;m<i;m++){var o=g[m],q=o.startContainer,
w=o.endContainer;n.equals(q,l.parent())&&o.startOffset++;n.equals(q,d.parent())&&o.startOffset++;n.equals(w,l.parent())&&o.endOffset++;n.equals(w,d.parent())&&o.endOffset++}}return c},selectBookmarks:function(a){for(var g=[],c=0;c<a.length;c++){var d=new i(this.document);d.moveToBookmark(a[c]);g.push(d)}this.selectRanges(g);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();m?a&&a.clear():a&&a.removeAllRanges()}});var y={table:1,tbody:1,tr:1},w=x.whitespaces(j),g=/\ufeff|\u00a0/;i.prototype.select=i.prototype.select=!m?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==e.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var g=this.document.createRange();g.setStart(a[0],this.startOffset);try{g.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(j),g.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=s(this.document).getNative();a.removeAllRanges();a.addRange(g)}:function(b){var f=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==e.NODE_ELEMENT){(new q(this.document)).selectElement(new a(i));return}}(this.startContainer[0].nodeType==e.NODE_ELEMENT&&
this.startContainer._4e_name()in y||this.endContainer[0].nodeType==e.NODE_ELEMENT&&this.endContainer._4e_name()in y)&&this.shrink(h.SHRINK_ELEMENT,j);var l=this.createBookmark(),i=l.startNode,k;f||(k=l.endNode);l=this.document.body.createTextRange();l.moveToElementText(i[0]);l.moveStart("character",1);if(k)b=this.document.body.createTextRange(),b.moveToElementText(k[0]),l.setEndPoint("EndToEnd",b),l.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!w(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(g))&&(b||!i[0].previousSibling||i[0].previousSibling&&"br"==n._4e_name(i[0].previousSibling));d=new a(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(i);c&&n.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(f){if(c?(l.moveStart("character",-1),l.select(),this.document.selection.clear()):l.select(),d)this.moveToPosition(d,h.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(k),k._4e_remove(),l.select()};
q.getSelection=s;return r.Selection=q},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(k,q){function s(d){function e(b,c){var g=f.body.createTextRange();try{g.moveToPoint(b,c)}catch(d){g=a}return g}function j(){var a=f.selection.createRange();c&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&c.select();h.remove(f,"mouseup",j);h.remove(f,"mousemove",k);c=g=0}function k(a){if(a.button){if(a=e(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",c)?a.setEndPoint("StartToStart",c):a.setEndPoint("EndToEnd",c),a.select()}else j()}var g,
b=d.get("iframe")[0].contentWindow,f=d.get("document")[0],c;h.on(f,"mousedown contextmenu",function(a){var d=f.documentElement;if(a.target===d&&(g&&j(),!(d.scrollHeight>d.clientHeight)&&(g=1,c=e(a.pageX,a.pageY))))h.on(f,"mouseup",j),h.on(f,"mousemove",k),b.focus(),c.select()})}function r(d){function h(a){if(f){var c=d.getSelection(),g=c&&c.getType(),e=c&&j.selection;if(a&&e&&g==m.SELECTION_NONE&&!j.queryCommandEnabled("InsertImage"))setTimeout(function(){h(p)},50);else{var k;if(!e||!e.type||!("Control"!=
e.type&&(k=e.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))b=e&&c.getRanges()[0],d._monitor()}}}var j=d.get("document")[0],k=new e(j.body),g=new e(j.documentElement);if(8>q.Utils.ieEngine)g.on("click",function(a){"html"===(new e(a.target))._4e_name()&&d.getSelection().getNative().createRange().select()});var b,f,c=p;g.on("mousedown",function(){c=n});g.on("mouseup",function(){c=p});k.on("focusin",function(g){if("body"==(new e(g.target))._4e_name()&&b){try{c&&
b.select()}catch(f){}b=a}});k.on("focus",function(){f=p;h()});k.on("beforedeactivate",function(a){a.relatedTarget||(f=n,c=p)});k.on("mousedown",function(){f=n});k.on("mouseup",function(){f=p;setTimeout(function(){h(p)},0)});k.on("keydown",function(){f=n});k.on("keyup",function(){f=p;setTimeout(function(){h()},0)})}function j(a){var d=a.get("document")[0];h.on(d,"mouseup keyup",function(){a._monitor()})}function o(a){function h(a){var b=q.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a._4e_name()]}
function j(a){return b(a)&&f(a)}var k=a.get("document")[0],g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=q.Walker.whitespaces(p),f=q.Walker.bookmark(n,p),c=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var f=b.path,m=new e(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],o=f.blockLimit;if(d.gecko){var r=f.block||f.blockLimit,s=r&&r.last(j);r&&r._4e_isBlockBoundary()&&
(!s||!(1==s[0].nodeType&&s._4e_isBlockBoundary()))&&"pre"!=r._4e_name()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!f.block){if("body"==o._4e_name()){if((f=b.fixBlock(p,"p"))&&f[0]!=m[0].lastChild&&f._4e_outerHtml().match(g))if((o=f.next(c))&&o[0].nodeType==x.NODE_ELEMENT&&!h[o])b.moveToElementEditablePosition(o),f._4e_remove();else if((o=f.prev(c))&&o[0].nodeType==x.NODE_ELEMENT&&!h[o])b.moveToElementEditablePosition(o,o._4e_outerHtml().match(g)?n:p),f._4e_remove();b.select();a.notifySelectionChange()}f=
new q.Range(k);f.moveToElementEditablePosition(m,p);"body"!==(new q.ElementPath(f.startContainer)).blockLimit._4e_name()&&(m=(new e(k.createElement("p"))).appendTo(m),d.ie||m._4e_appendBogus())}})}var p=!0,n=!1,a=null,d=k.UA,h=k.Event,e=k.Node,m=q.SELECTION,x=q.NODE;return{init:function(a){a.docReady(function(){d.ie?(s(a),r(a)):j(a)});o(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(k){function q(a){return!z.attr(a,"_ke_bookmark")}function s(a,b){for(var c in a)a.hasOwnProperty(c)&&(k.isString(a[c])?a[c]=a[c].replace(J,function(a,c){return b[c]}):s(a[c],b))}function r(a,b){b&&(a=k.clone(a),s(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||K[c]?C.STYLE_BLOCK:M[c]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:a}}function j(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var g=new O(a),f=g.getRanges(),d=0;d<f.length;d++)c.call(this,f[d]);g.selectRanges(f)}function o(a,b,c){var g=a.element;"*"==g&&(g="span");b=new F(b.createElement(g));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=r.getStyleText(c);if(a)for(var f in a)a.hasOwnProperty(f)&&b.attr(f,a[f]);c&&(b[0].style.cssText=c);return b}function p(b){var g=b.createBookmark(c),f=b.createIterator();f.enforceRealBlocks=c;f.enlargeBr=c;for(var e,i=b.document;e=f.getNextParagraph();){var h=o(this,i,
e),j=h,h="pre"==j._4e_name,k="pre"==e._4e_name,l=!h&&k;h&&!k?(k=e,l=k.html(),l=n(l,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),l=l.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),l=l.replace(/([ \t\n\r]+|&nbsp;)/g," "),l=l.replace(/<br\b[^>]*>/gi,"\n"),B.ie?(k=k[0].ownerDocument.createElement("div"),k.appendChild(j[0]),j[0].outerHTML="<pre>"+l+"</pre>",j=new F(k.firstChild),j._4e_remove()):j.html(l)):l?j=d(a(e),j):e._4e_moveChildren(j);e[0].parentNode.replaceChild(j[0],e[0]);if(h&&(e=j,h=void 0,(h=e._4e_previousSourceNode(c,
E.NODE_ELEMENT))&&"pre"==h._4e_name()))j=n(h.html(),/\n$/,"")+"\n\n"+n(e.html(),/^\n/,""),B.ie?e[0].outerHTML="<pre>"+j+"</pre>":e.html(j),h._4e_remove()}b.moveToBookmark(g)}function n(a,b,c){var g="",f="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(g=b);c&&(f=c);return""});return g+a.replace(b,c)+f}function a(a){var b=[];n(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function d(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),g=0;g<a.length;g++){var f=a[g],f=f.replace(/(\r\n|\r)/g,"\n"),f=n(f,/^[ \t]*\n/,""),f=n(f,/\n$/,""),f=n(f,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
d=b.clone();d.html(f);c.appendChild(d[0])}return c}function h(a){var b=a.document;if(a.collapsed)b=o(this,b,void 0),a.insertNode(b),a.moveToPosition(b,G.POSITION_BEFORE_END);else{var g=this.element,f=this._.definition,d,e=D[g];e||(d=c,e=D.span);var i=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var h=a.createBookmark(),j=h.startNode,h=h.endNode,k=j,l;k&&k[0];){var m=v;if(z.equals(k,h))k=t,m=c;else{var n=k[0].nodeType,u=n==E.NODE_ELEMENT?k._4e_name():t;if(u&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(c);continue}if(!u||e[u]&&(k._4e_position(h)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(k))){var p=k.parent();if(p&&"a"==g&&p._4e_name()==g)n=o(this,b,void 0),p._4e_moveChildren(n),p[0].parentNode.replaceChild(n[0],p[0]),n._4e_mergeSiblings();else if(p&&p[0]&&((D[p._4e_name()]||D.span)[g]||d)&&(!f.parentRule||f.parentRule(p))){if(!l&&(!u||!D.$removeEmpty[u]||(k._4e_position(h)|
A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))l=new P(b),l.setStartBefore(k);if(n==E.NODE_TEXT||n==E.NODE_ELEMENT&&!k[0].childNodes.length){p=k;for(n=null;(m=!p.next(q))&&(n=p.parent())&&e[n._4e_name()]&&(n._4e_position(j)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(n));)p=n;l.setEndAfter(p)}}else m=
c}else m=c;k=k._4e_nextSourceNode()}if(m&&l&&!l.collapsed){for(var m=o(this,b,void 0),p=l.getCommonAncestor(),n={},u={},r,s=null,x;m&&p&&m[0]&&p[0];){if(p._4e_name()==g){for(r in f.attributes)if(f.attributes.hasOwnProperty(r)&&!u[r]&&(x=p.attr(s)))m.attr(r)==x?m.removeAttr(r):u[r]=1;for(s in f.styles)if(f.styles.hasOwnProperty(s)&&!n[s]&&(x=p.style(s)))m.style(s)==x?m.style(s,""):n[s]=1;if(!m._4e_hasAttributes()){m=t;break}}p=p.parent()}m?(m[0].appendChild(l.extractContents()),w(this,m),l.insertNode(m),
m._4e_mergeSiblings(),B.ie||m[0].normalize()):(m=new F(b.createElement("span")),m[0].appendChild(l.extractContents()),l.insertNode(m),w(this,m),m._4e_remove(!0));l=t}}j._4e_remove();h._4e_remove();a.moveToBookmark(i);a.shrink(G.SHRINK_TEXT)}}function e(a){a.enlarge(G.ENLARGE_ELEMENT);var b=a.createBookmark(),c=b.startNode;if(a.collapsed){for(var f=new H(c.parent()),d,e=0,h;e<f.elements.length&&(h=f.elements[e])&&!(h==f.block||h==f.blockLimit);e++)if(this.checkElementRemovable(h)){var j=a.checkBoundaryOfElement(h,
G.END),k=!j&&a.checkBoundaryOfElement(h,G.START);k||j?(d=h,d.match=k?"start":"end"):(h._4e_mergeSiblings(),h._4e_name()!=this.element?(j=i(this),g(h,j[h._4e_name()]||j["*"])):l(this,h))}if(d.length){h=c;for(e=0;;e++){j=f.elements[e];if(z.equals(j,d))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(h[0]);h=j}h["start"==d.match?"insertBefore":"insertAfter"](d)}}else{var m=b.endNode,n=this,f=function(){for(var a=new H(c.parent()),b=new H(m.parent()),g=t,f=t,d=0;d<a.elements.length;d++){var e=
a.elements[d];if(e==a.block||e==a.blockLimit)break;n.checkElementRemovable(e)&&(g=e)}for(d=0;d<b.elements.length;d++){e=b.elements[d];if(e==b.block||e==b.blockLimit)break;n.checkElementRemovable(e)&&(f=e)}f&&m._4e_breakParent(f);g&&c._4e_breakParent(g)};f();for(d=new F(c[0].nextSibling);d[0]!==m[0];){e=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==E.NODE_ELEMENT&&this.checkElementRemovable(d)&&(d._4e_name()==this.element?l(this,d):(h=i(this),g(d,h[d._4e_name()]||h["*"])),e[0].nodeType==E.NODE_ELEMENT&&
e.contains(c)))f(),e=new F(c[0].nextSibling);d=e}}a.moveToBookmark(b)}function m(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,g){b[c]=g});return b}function x(a,b){var c="";b!==v?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){k.isArray(c)||(c=[c]);for(var g=0;g<c.length;g++){var f=c[g],d,e,h;"string"==typeof f?d=f.toLowerCase():(d=f.element?f.element.toLowerCase():a.element,e=f.attributes,h=f.styles);f=b[d]||(b[d]={});if(e){d=f.attributes=f.attributes||[];for(var i in e)e.hasOwnProperty(i)&&d.push([i.toLowerCase(),e[i]])}if(h){var f=f.styles=f.styles||[],j;for(j in h)h.hasOwnProperty(j)&&f.push([j.toLowerCase(),h[j]])}}}return b}function l(a,g){var f=a._.definition,d=i(a),e=u.mix(f.attributes,(d[g._4e_name()]||d["*"]||
{}).attributes),f=u.mix(f.styles,(d[g._4e_name()]||d["*"]||{}).styles),d=k.isEmptyObject(e)&&k.isEmptyObject(f),h;for(h in e)if(e.hasOwnProperty(h)&&!(("class"==h||a._.definition.fullMatch)&&g.attr(h)!=y(h,e[h])))d=d||!!g.hasAttr(h),g.removeAttr(h);for(var j in f)f.hasOwnProperty(j)&&!(a._.definition.fullMatch&&g.style(j)!=y(j,f[j],c))&&(d=d||!!g.style(j),g.style(j,""));b(g)}function y(a,b,c){var g=new F("<span>");g[c?"style":"attr"](a,b);return g[c?"style":"attr"](a)}function w(a,b){for(var c=i(a),
f=b.all(a.element),d=f.length;0<=--d;)l(a,new F(f[d]));for(var e in c)if(c.hasOwnProperty(e)&&e!=a.element){f=b.all(e);for(d=f.length-1;0<=d;d--){var h=new F(f[d]);g(h,c[e])}}}function g(a,c){var g,f=c&&c.attributes;if(f)for(g=0;g<f.length;g++){var d=f[g][0],e;if(e=a.attr(d)){var h=f[g][1];(h===t||h.test&&h.test(e)||"string"==typeof h&&e==h)&&a[0].removeAttribute(d)}}if(f=c&&c.styles)for(g=0;g<f.length;g++)if(d=f[g][0],h=a.css(d)){var i=f[g][1];(i===t||i.test&&i.test(e)||"string"==typeof i&&h==i)&&
a.css(d,"")}b(a)}function b(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,g=a[0].lastChild;a._4e_remove(c);b&&(b.nodeType==E.NODE_ELEMENT&&z._4e_mergeSiblings(b),g&&b!=g&&g.nodeType==E.NODE_ELEMENT&&z._4e_mergeSiblings(g))}}var f=k.Editor,c=!0,v=!1,t=null,u=f.Utils,z=k.DOM,C={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=f.RANGE,O=f.Selection,E=f.NODE,A=f.POSITION,P=f.Range,F=k.Node,B=k.UA,H=f.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},D=f.XHTML_DTD,M={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},N=/\s*(?:;\s*|$)/g,J=/#\((.+?)\)/g;f.STYLE=C;r.prototype={apply:function(a){j.call(this,a,v)},remove:function(a){j.call(this,a,c)},applyToRange:function(a){return(this.applyToRange=this.type==C.STYLE_INLINE?h:this.type==C.STYLE_BLOCK?p:t).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==C.STYLE_INLINE?e:t).call(this,a)},checkElementRemovable:function(a,b){if(!a)return v;var g=this._.definition,
f;if(a._4e_name()==this.element){if(!b&&!a._4e_hasAttributes())return c;var d=g._AC;if(d)g=d;else{var d={},e=0,h=g.attributes;if(h)for(var j in h)h.hasOwnProperty(j)&&(e++,d[j]=h[j]);if(h=r.getStyleText(g))d.style||e++,d.style=h;d._length=e;g=g._AC=d}if(g._length){for(var k in g)if("_length"!=k&&g.hasOwnProperty(k)){e=a.attr(k)||"";if("style"==k)a:{d=g[k];e=x(e,v);"string"==typeof d&&(d=m(d));"string"==typeof e&&(e=m(e));h=void 0;for(h in d)if(d.hasOwnProperty(h)&&!(h in e&&(e[h]==d[h]||"inherit"==
d[h]||"inherit"==e[h]))){d=v;break a}d=c}else d=g[k]==e;if(d){if(!b)return c}else if(b)return v}if(b)return c}else return c}k=i(this);if(k=k[a._4e_name()]||k["*"]){if(!(g=k.attributes)&&!(f=k.styles))return c;if(g)for(d=0;d<g.length;d++)if(k=g[d][0],k=a.attr(k))if(e=g[d][1],e===t||"string"==typeof e&&k==e||e.test&&e.test(k))return c;if(f)for(d=0;d<f.length;d++)if(k=a.css(f[d][0]))if(g=f[d][1],g===t||"string"==typeof g&&k==g||g.test&&g.test(k))return c}return v},checkActive:function(a){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,c);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var b=a.elements,g=0,f;g<b.length;g++)if(f=b[g],!(this.type==C.STYLE_INLINE&&(z.equals(f,a.block)||z.equals(f,a.blockLimit))))if((this.type!=C.STYLE_OBJECT||f._4e_name()in M)&&this.checkElementRemovable(f,c))return c}return v}};r.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,g=a.attributes&&a.attributes.style||"",c="";g.length&&(g=g.replace(N,";"));for(var f in b)if(b.hasOwnProperty(f)){var d=b[f],e=(f+":"+d).replace(N,
";");"inherit"==d?c+=e:g+=e}g.length&&(g=x(g));return a._ST=g+c};f.Style=r},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(k){var q=k.Editor,s=null,r=k.Node,j=k.DOM,o=k.UA,p=k.Event,n={debugUrl:function(a){a=a.replace(/-min\.(js|css)/i,".$1");k.Config.debug||(a=a.replace(/\.(js|css)/i,"-min.$1"));-1==a.indexOf("?t")&&(a=-1!=a.indexOf("?")?a+"&":a+"?",a+="t="+encodeURIComponent("20120509145356"));k.startsWith(a,"/")&&(a=a.substring(1));return q.Config.base+a},lazyRun:function(a,d,h){var e=a[d],j=a[h];a[d]=function(){e.apply(this,arguments);a[d]=a[h];return j.apply(this,arguments)}},
getXY:function(a,d,h,e){h=h.defaultView||h.parentWindow;a-=j.scrollLeft(h);d-=j.scrollTop(h);e&&(e=e.defaultView||e.parentWindow,h!=e&&h.frameElement&&(e=j.offset(h.frameElement,void 0,e),a+=e.left,d+=e.top));return{left:a,top:d}},tryThese:function(a){for(var d,h=0,e=arguments.length;h<e;h++){var j=arguments[h];try{d=j();break}catch(k){}}return d},arrayCompare:function(a,d){if(!a&&!d)return!0;if(!a||!d||a.length!=d.length)return!1;for(var h=0;h<a.length;h++)if(a[h]!==d[h])return!1;return!0},getByAddress:function(a,
d,h){for(var a=a.documentElement,e=0;a&&e<d.length;e++){var j=d[e];if(h)for(var k=-1,i=0;i<a.childNodes.length;i++){var l=a.childNodes[i];if(!(!0===h&&3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType)&&(k++,k==j)){a=l;break}}else a=a.childNodes[j]}return a?new r(a):s},clearAllMarkers:function(a){for(var d in a)a.hasOwnProperty(d)&&a[d]._4e_clearMarkers(a,!0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},mix:function(a){for(var d={},h=
0;h<arguments.length;h++)d=k.mix(d,arguments[h]);return d},isCustomDomain:function(){if(!o.ie)return!1;var a=document.domain,d=window.location.hostname;return a!=d&&a!="["+d+"]"},isNumber:function(a){return/^\d+(.\d+)?$/.test(k.trim(a))},verifyInputs:function(a){for(var d=0;d<a.length;d++){var h=new r(a[d]),e=k.trim(n.valInput(h)),j=h.attr("data-verify"),h=h.attr("data-warning");if(j&&!RegExp(j).test(e))return alert(h),!1}return!0},sourceDisable:function(a,d){a.on("sourceMode",d.disable,d);a.on("wysiwygMode",
d.enable,d)},resetInput:function(a){var d=a.attr("placeholder");d&&o.ie?(a.addClass("ke-input-tip"),a.val(d)):o.ie||a.val("")},valInput:function(a,d){if(void 0===d)return a.hasClass("ke-input-tip")?"":a.val();a.removeClass("ke-input-tip");a.val(d)},placeholder:function(a,d){a.attr("placeholder",d);o.ie&&(a.on("blur",function(){k.trim(a.val())||(a.addClass("ke-input-tip"),a.val(d))}),a.on("focus",function(){a.removeClass("ke-input-tip");k.trim(a.val())==d&&a.val("")}))},htmlEncode:function(a){return!a?
a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(a){var a=k.clone(a),d;for(d in a)if(a.hasOwnProperty(d)){var h=a[d];k.isFunction(h)&&(a[d]=h())}return a},doFormUpload:function(a,d,h){function e(){var g={responseText:"",responseXML:s};g.argument=a?a.argument:s;try{var b;if((b=o.ie?r.contentWindow.document:r.contentDocument||window.frames[m].document)&&b.body)g.responseText=k.trim(j.text(b.body));g.responseXML=b&&b.XMLDocument?b.XMLDocument:
b}catch(f){}p.remove(r,"load",e);a.callback&&a.callback(g);setTimeout(function(){j._4e_remove(r)},100)}var m=k.guid("form-upload-"),r=document.createElement("iframe");r.id=m;r.name=m;r.className="ke-hidden";var i="document.open();"+(n.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";o.ie&&(r.src=o.ie?"javascript:void(function(){"+encodeURIComponent(i)+"}())":"");document.body.appendChild(r);o.ie&&(document.frames[m].name=m);var i=a.form,l={target:j.attr(i,"target"),
method:j.attr(i,"method"),encoding:j.attr(i,"encoding"),enctype:j.attr(i,"enctype"),action:j.attr(i,"action")};j.attr(i,{target:m,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});h&&j.attr(i,"action",h);var y;if(d){y=[];var d=q.Utils.normParams(d),w;for(w in d)d.hasOwnProperty(w)&&(h=document.createElement("input"),h.type="hidden",h.name=w,h.value=d[w],i.appendChild(h),y.push(h))}p.on(r,"load",e);i.submit();j.attr(i,l);if(y){d=0;for(w=y.length;d<w;d++)j._4e_remove(y[d])}return r},
map:function(a,d){for(var h=0;h<a.length;h++)a[h]=d(a[h]);return a},ieEngine:document.documentMode||o.ie,preventFocus:function(a){o.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(a){k.mix(j,a);for(var d in a)a.hasOwnProperty(d)&&function(d){r.prototype[d]=function(){var e=[].slice.call(arguments,0);e.unshift(this[0]);return(e=a[d].apply(s,e))&&(e.nodeType||k.isWindow(e))?new r(e):k.isArray(e)&&(e.__IS_NODELIST||e[0]&&e[0].nodeType)?new r(e):e}}(d)},addRes:function(){var a=
this.__res=this.__res||[];a.push.apply(a,k.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],d=0;d<a.length;d++){var h=a[d];k.isFunction(h)?h():(h.destroy&&h.destroy(),h.remove&&h.remove())}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,h){return h.toUpperCase()})+"Active"}};return q.Utils=n},{requires:["./base"]});
KISSY.add("editor/core/walker",function(k,q){function s(a,g){if(this._.end)return n;var b,f=this.range,c,d=this.guard,e=this.type,i=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),n;if(!a&&!this._.guardLTR){var j=f.endContainer[0],k=j.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(j==a||"body"==h._4e_name(a))?!1:a!=k}}if(a&&!this._.guardRTL){var l=f.startContainer[0],q=0<f.startOffset&&l.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(l==a||"body"==h._4e_name(a))?!1:a!=q}}var r=a?this._.guardRTL:this._.guardLTR;c=d?function(a,b){return r(a,b)===p?p:d(a,b)}:r;this.current?b=this.current[i](p,e,c):a?(b=f.endContainer,0<f.endOffset?(b=new m(b[0].childNodes[f.endOffset-1]),c(b)===p&&(b=n)):b=c(b,o)===p?n:b._4e_previousSourceNode(o,e,c,void 0)):(b=f.startContainer,b=new m(b[0].childNodes[f.startOffset]),b.length?c(b)===p&&(b=n):b=c(f.startContainer,o)===p?n:f.startContainer._4e_nextSourceNode(o,
e,c,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==p){if(!g)return b}else if(g&&this.evaluator)return p;b=b[i](p,e,c)}this.end();return this.current=n}function r(a){for(var g,b=n;g=s.call(this,a);)b=g;return b}function j(a){this.range=a;this._={}}var o=!0,p=!1,n=null,a=k.UA,d=q.NODE,h=k.DOM,e=q.XHTML_DTD,m=k.Node;k.augment(j,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,o)},checkForward:function(){return s.call(this,
p,o)!==p},checkBackward:function(){return s.call(this,o,o)!==p},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,o)},reset:function(){delete this.current;this._={}},_iterator:s});j.blockBoundary=function(a){return function(g){return!(g.nodeType==d.NODE_ELEMENT&&h._4e_isBlockBoundary(g,a))}};j.bookmark=function(a,g){function b(a){return"span"==h._4e_name(a)&&h.attr(a,"_ke_bookmark")}return function(f){var c,e;c=f.nodeType==d.NODE_TEXT&&(e=f.parentNode)&&b(e);c=
a?c:c||b(f);return g^c}};j.whitespaces=function(a){return function(g){g=g.nodeType==d.NODE_TEXT&&!k.trim(g.nodeValue);return a^g}};j.invisible=function(a){var g=j.whitespaces();return function(b){b=g(b)||b.nodeType==d.NODE_ELEMENT&&!b.offsetHeight;return a^b}};var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=j.whitespaces(),l=j.bookmark(),y=function(a){var g=h._4e_name(a);return l(a)||i(a)||1==a.nodeType&&g in e.$inline&&!(g in e.$empty)};q.Utils.injectDom({_4e_getBogus:function(d){d=new m(d);do d=d._4e_previousSourceNode();
while(d&&y(d[0]));return d&&(!a.ie?"br"==d._4e_name():3==d[0].nodeType&&x.test(d.text()))?d[0]:!1}});q.Walker=j},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(k){var q=k.Editor;q.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};q.baseZIndex=function(k){return(q.Config.baseZIndex||1E4)+k}},{requires:["./base"]});
KISSY.add("editor",function(k,q,s,r){function j(a,b){var f=a.body;i(function(){a.designMode="on";setTimeout(function(){a.designMode="off";f.focus();arguments.callee.retry||(arguments.callee.retry=o)},50)},function(){a.designMode="off";e.attr(f,"contentEditable",n);e.attr(f,"contentEditable",o);!b&&j(a,1)})}var o=!0,p=k.all,n=!1,a=document,d=k.UA,h=d.ie,e=k.DOM,m=k.Node,x=k.Event,i=s.tryThese,l="document.open();"+(s.isCustomDomain()?'document.domain="'+a.domain+'";':"")+"document.close();",y='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(h?' src="javascript:void(function(){'+encodeURIComponent(l)+'}())"':"")+' allowTransparency="true"></iframe>';k.mix(q,{SOURCE_MODE:0,WYSIWYG_MODE:1});var w=q.WYSIWYG_MODE;k.augment(q,{createDom:function(){var a=this.get("textarea"),b;a||this.set("textarea",a=p("<textarea></textarea>"));b=this.get("el");b.addClass(this.get("prefixCls")+"editor-wrap",void 0);b.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=k.guid();var f=
b.one(".ke-textarea-wrap");this.__set("iframeWrapEl",f);this.__set("toolBarEl",b.one(".ke-editor-tools"));this.__set("statusBarEl",b.one(".ke-editor-status"));var c=this.get("width"),d=this.get("height");b.css("width",c);a.css("width","100%");a.css("display","none");f.append(a);f.css("height",d);a.css("height",d);b.css("height","")},_uiSetHeight:function(a){this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},_uiSetMode:function(a){var b=this.get("textarea");a?(this.execCommand("save"),
this._setData(b.val()),this.execCommand("save")):(b.val(this._getData(1,w)),b[0].focus());b[a?"hide":"show"]();this.get("iframe")[a?"show":"hide"]();this.fire((a?"wysiwyg":"source")+"Mode")},renderUI:function(){function a(){b.detach("docReady",a);if(b.get("focus"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,f=b.get("textarea");r.register(b);b.get("attachForm")&&f[0].form&&b._attachForm();b.on("docReady",a)},_createIframe:function(a){var b=this,f=new m(y),c=b.get("textarea");
c.hasAttr("tabindex")&&f.attr("tabIndex",d.webkit?-1:c.attr("tabIndex"));b.get("iframeWrapEl").prepend(f);b.set("iframe",f);b.__docReady=0;if(d.gecko&&!f.__loaded)f.on("load",function(){b._setUpIFrame(a)},b);else b._setUpIFrame(a)},destructor:function(){var a=this.get("el"),b=this.get("textarea"),f=this.get("document")[0],c=this.get("iframe")[0].contentWindow;this.sync();q.focusManager.remove(this);x.remove([f,f.documentElement,f.body,c]);k.each(this.__dialogs,function(a){a.destroy&&a.destroy()});
this.__commands=0;this.__editor_created_new||(b.insertBefore(a,void 0),b.css({width:this.get("width"),height:this.get("height")}),b.show())},_attachForm:function(){var a=this,b=a.get("textarea"),f=new m(b[0].form);f.on("submit",a.sync,a);a.on("destroy",function(){f.detach("submit",a.sync,a)})},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var f=this.__dialogs[a];f.show(b);this.fire("dialogShow",{dialog:f.dialog,pluginDialog:f,dialogName:a})},hasDialog:function(a){return!!this.__dialogs[a]},
addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],f=k.makeArray(arguments);f.shift();f.unshift(this);if(b)return b.exec.apply(b,f)},_clearIframeDocContent:function(){if(this.get("iframe")){var a=this.get("iframe"),b=a[0].contentWindow,f=this.get("document")[0];x.remove([f,f.documentElement,f.body,b]);a.remove()}},_getData:function(a,b){var f=this.htmlDataProcessor,c;void 0==b&&(b=this.get("mode"));c=b==
w?this.get("document")[0].body.innerHTML:f.toDataFormat(this.get("textarea").val());c=a?f.toHtml(c):f.toServer(c);c=k.trim(c);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(c)&&(c="");return c},_setData:function(a){var b,f=a;if(this.get("mode")!=w)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)f=b.toDataFormat(a,"p");this._clearIframeDocContent();this._createIframe(f)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(a){this.get("document")[0].body.innerHTML=a},_prepareIFrameHtml:function(g,b){var f=this.get("customStyle"),c=this.get("customLink"),d="",e=q.Utils.debugUrl("/theme/editor-iframe.css");if(c)for(var h=0;h<c.length;h++)d+='<link href="'+c[h]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===a.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+e+"' rel='stylesheet'/><style>"+(f||"")+"</style>"+d+"</head><body class='ke-editor'>"+
(b||"&nbsp;")+(g?'<script id="ke_actscript" type="text/javascript">'+(s.isCustomDomain()?'document.domain="'+a.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+g+'");<\/script>':"")+"</body></html>"},getSelection:function(){return q.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=e._4e_getWin(a);d.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){e._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a){var b=this.get("customStyle")||"",b=b+("\n"+a);this.set("customStyle",b);e.addStyleSheet(this.get("iframe")[0].contentWindow,b)},addCustomLink:function(a){var b=this.get("customLink")||[],d=this.get("document")[0];b.push(a);this.set("customLink",b);b=d.createElement("link");b.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=e.query("link",b),d=
0;d<b.length;d++)b[d].href==a&&e.remove(b[d]);b=this.get("customLink")||[];a=k.indexOf(a,b);-1!=a&&b.splice(a,1)},_setUpIFrame:function(a){function b(){j=i.document;d.__set("document",new m(j));d.__set("window",new m(i));c.detach();j.open("text/html","replace");j.write(e);j.close()}var d=this,c=d.get("iframe"),e=d._prepareIFrameHtml(d._UUID,a),i=c[0].contentWindow,j;c.__loaded=1;try{j=i.document}catch(k){if(c[0].src=c[0].src,7>h){setTimeout(b,10);return}}b()},docReady:function(a){this.on("docReady",
a);this.__docReady&&a.call(this)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var d=b.getStartElement(),c=new q.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(c))a.__previousPath=c,a.fire("selectionChange",{selection:b,path:c,element:d})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(a,b,d){var c=this;if(c.get("mode")===
w){c.focus();var e,h=a._4e_name(),i=q.XHTML_DTD,j=q.RANGE,k=q.NODE,l=i.$block[h],p=c.getSelection(),r=p&&p.getRanges(),s,x,y,B;if(!r||0==r.length){var H=arguments,K=H.callee;setTimeout(function(){K.apply(c,H)},30)}else{c.execCommand("save");for(var D=r.length-1;0<=D;D--){s=r[D];s.deleteContents();e=!D&&a||a.clone(o);b&&b(e);if(l)for(;(y=s.getCommonAncestor(n,o))&&(B=i[y._4e_name()])&&(!B||!B[h]);)y._4e_name()in i.span?s.splitElement(y):s.checkStartOfBlock()&&s.checkEndOfBlock()?(s.setStartBefore(y),
s.collapse(o),y.remove()):s.splitBlock();s.insertNode(e);x||(x=e)}x&&(h=x._4e_nextSourceNode(o),i=c.get("document")[0],B=q.XHTML_DTD,B.$inline[e._4e_name()]?(h=new m(i.createTextNode(" ")),h.insertAfter(x)):h?"br"==h._4e_name()&&B[h.parent()._4e_name()].p&&(B=new m("<p>&nbsp;</p>",null,i),h[0].parentNode.replaceChild(B[0],h[0]),h=B):(B=new m("<p>&nbsp;</p>",null,i),B.insertAfter(x),h=B),s.moveToPosition(x,j.POSITION_AFTER_END),h&&h[0].nodeType==k.NODE_ELEMENT&&s.moveToElementEditablePosition(h),p.selectRanges([s]),
c.focus(),e&&e.scrollIntoView(void 0,!1),c._saveLater(),d&&d(e))}}},insertHtml:function(a,b){var d=this,c;if(d.get("mode")===w){if(c=d.htmlDataProcessor)a=c.toDataFormat(a,null,b);d.focus();d.execCommand("save");var i=d.get("document")[0];c=0;if(h){var j=i.selection;"Control"==j.type&&j.clear();try{j.createRange().pasteHTML(a)}catch(k){}}else try{i.execCommand("inserthtml",n,a)}catch(l){setTimeout(function(){if(0==d.getSelection().getRanges().length){var b=new q.Range(i),c=e.first(i.body,function(a){return 1==
a.nodeType&&"br"!=e._4e_name(a)});c||(c=new m(i.createElement("p")),i.body.appendChild(c[0]));b.setStartAt(c,q.RANGE.POSITION_AFTER_START);b.select()}i.execCommand("inserthtml",n,a)},c=100)}setTimeout(function(){d.getSelection().scrollIntoView()},c);d._saveLater(c)}},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null);b.__saveTimer=setTimeout(function(){b.execCommand("save")},a||0)},_fixByBindIframeDoc:function(){var a=this,b=a.get("iframe"),f=a.get("textarea")[0],
b=b[0].contentWindow,c=a.get("document")[0];d.webkit&&(x.on(c,"click",function(a){var b=new m(a.target);k.inArray(b._4e_name(),["input","select"])&&a.preventDefault()}),x.on(c,"mouseup",function(a){var b=new m(a.target);k.inArray(b._4e_name(),["input","textarea"])&&a.preventDefault()}));if(d.gecko||h||d.opera){var e;e=(new m('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(f);e.on("focus",function(){a.focus()});a.activateGecko=function(){d.gecko&&
a.__iframeFocus&&e[0].focus()};a.on("destroy",function(){e.detach();e.remove()})}x.on(b,"focus",function(){d.gecko?j(c,n):d.opera&&c.body.focus();a.notifySelectionChange()});if(d.gecko)x.on(c,"mousedown",function(){a.__iframeFocus||j(c,n)});if(h&&(x.on(c,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==c.compatMode)){var i=
{33:1,34:1};x.on(c,"keydown",function(b){b.keyCode in i&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(d.webkit)x.on(c,"mousedown",function(b){b=new m(b.target);k.inArray(b._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(d.gecko)x.on(c,"dragstart",function(a){var b=new m(a.target);b._4e_name()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(a)}});q._initIFrame=function(a){var b=r.getInstance(a),f=b.get("document")[0],
a=f.getElementById("ke_actscript");e.remove(a);b._fixByBindIframeDoc();var c=f.body;h?(c.hideFocus=o,c.disabled=o,c.contentEditable=o,c.removeAttribute("disabled")):setTimeout(function(){d.gecko||d.opera?c.contentEditable=o:d.webkit?c.parentNode.contentEditable=o:f.designMode="on"},0);if(d.gecko||d.opera){var i=f.documentElement;x.on(i,"mousedown",function(a){if(a.target==i){d.gecko&&j(f,n);b.activateGecko()}})}setTimeout(function(){h&&setTimeout(function(){if(f){c.runtimeStyle.marginBottom="0px";
c.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),d=b.get("disableInlineTableEditing");if(a||d)try{f.execCommand("enableObjectResizing",n,!a);f.execCommand("enableInlineTableEditing",n,!d)}catch(e){x.on(c,h?"resizestart":"resize",function(b){var c=new m(b.target);(a||c._4e_name()==="table"&&d)&&b.preventDefault()})}},10)};return q},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
