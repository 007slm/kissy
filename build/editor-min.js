/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 23 20:51
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(e,o,s,r){o=r.create(s.Controller,[r.Box],{initializer:function(){var e;this.__commands={};this.__dialogs={};if(e=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var o=e.next();o?this.__set("elBefore",o):this.__set("render",e.parent())}this.get("width")||this.__set("width",e.style("width")||e.css("width"));this.get("height")||this.__set("height",e.style("height")||e.css("height"))}else this.__editor_created_new=1},use:function(l,o){for(var a=
this,j=a.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],l=l.split(","),m=l.length-1;0<=m;m--)l[m]||l.splice(m,1);for(m=0;m<j.length;m++){var h=j[m];e.inArray(h,l)||l.unshift(h)}e.each(l,function(a,h){l[h]&&(l[h]="editor/plugin/"+a+"/")});e.use(l.join(","),function(){var h=e.makeArray(arguments);h.shift();for(var j=0;j<h.length;j++)h[j].init(a);o&&o.call(a)});a.__CORE_PLUGINS=[];return a}},{Config:{base:e.Config.base+"editor/"},XHTML_DTD:o.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(e){return this._setData(e)}},formatData:{getter:function(){return this._getData(1)},setter:function(e){return this._setData(e)}},prefixCls:{value:"ke-"}}},"Editor");o.DefaultRender=r.create(s.Render,[r.Box.Render],{_uiSetHeight:function(){}});e.mix(o,e.EventTarget);return KISSY.Editor=o},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(e){function o(c){this.editor=c;this._init()}function s(c){if(v.ie&&"BackCompat"!=c.get("document")[0].compatMode){var d=c.getSelection(),g;if(d.getType()==w.SELECTION_ELEMENT&&(g=d.getSelectedElement())){var b=d.getRanges()[0],f=new l(c.get("document")[0].createTextNode(""));f.insertBefore(g);b.setStartBefore(f);b.setEndAfter(g);d.selectRanges([b]);setTimeout(function(){g.parent()&&(f.remove(),d.selectElement(g))},0)}}}var r=e.Editor,l=e.Node,v=e.UA,
a=r.Range,j=r.RANGE,m=e.Event;e.augment(o,{_init:function(){var c=this.editor;m.on(c.get("document")[0].body,v.webkit?"paste":v.gecko?"paste":"beforepaste",this._paste,this);m.on(c.get("document")[0].body,"contextmenu",function(){d=1;setTimeout(function(){d=0},10)});c.addCommand("copy",new n("copy"));c.addCommand("cut",new n("cut"));c.addCommand("paste",new n("paste"))},_paste:function(){if(!d){var c=this.editor,k=c.get("document")[0];if(!k.getElementById("ke_pastebin")){var g=c.getSelection(),b=
new a(k),f=new l(v.webkit?"<body></body>":"<div></div>",null,k);f.attr("id","ke_pastebin");v.webkit&&f[0].appendChild(k.createTextNode("\u00a0"));k.body.appendChild(f[0]);f.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});f.css("left","-1000px");var i=g.createBookmarks();b.setStartAt(f,j.POSITION_AFTER_START);b.setEndAt(f,j.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){f.remove();var b;f=v.webkit&&(b=f.first())&&b.hasClass("Apple-style-span")?
b:f;g.selectBookmarks(i);b=f.html();if(b=e.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var d=c.fire("paste",{html:b,holder:f});void 0!==d&&(b=d);d=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)&&(d=c.htmlDataProcessor.wordFilter);c.insertHtml(b,d)}},0)}}}});var h=function(c,d){var g=c.get("document")[0],b=new l(g.body),f=!1,i=function(){f=!0};b.on(d,i);(7<v.ie?g:g.selection.createRange()).execCommand(d);b.detach(d,i);return f},u=v.ie?function(c,d){return h(c,
d)}:function(c,d){try{return c.get("document")[0].execCommand(d)}catch(g){return!1}},p={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},n=function(c){this.type=c};n.prototype={exec:function(c){"cut"==this.type&&s(c);(c=u(c,this.type))||alert(p[this.type]);return c}};var w=r.Selection,c={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},d;r.on("contextmenu",function(d){var a=d.contextmenu,g=a.get("editor"),
b=a.menu.get("contentEl"),f={copy:0,cut:0,paste:0},i;for(i in f)f.hasOwnProperty(i)&&(f[i]=b.one(".ke-paste-"+i),f[i]||function(i){var d=(new l("<a href='#'class='ke-paste-"+i+"'>"+c[i]+"</a>")).appendTo(b);d.on("click",function(b){b.halt();a.hide();setTimeout(function(){g.execCommand(i)},30)});f[i]=d}(i))});return{init:function(c){c.docReady(function(){new o(c)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(e){function o(c,d){var q=c[d?"next":"prev"]();if(q&&q[0].nodeType==h.NODE_ELEMENT){for(var k=[];q.attr("_ke_bookmark")||q._4e_isEmptyInlineRemovable(s);)if(k.push(q),q=d?q.next():q.prev(),!q)return;if(c._4e_isIdentical(q,s)){for(var g=new a(d?c[0].lastChild:c[0].firstChild);k.length;)k.shift()._4e_move(c,!d,s);q._4e_moveChildren(c,!d,s);q.remove();g[0]&&g[0].nodeType==h.NODE_ELEMENT&&g._4e_mergeSiblings()}}}var s=s,r=e.Editor,l=e.DOM,v=e.UA,a=e.Node,j=r.Utils,
m={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var h=r.NODE,u=r.POSITION,p={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},n={hr:1},w=function(c){return c&&(c[0]||c)};j.injectDom({_4e_isBlockBoundary:function(c,d){var a=e.merge(n,d);return!(!p[l.css(c,"display")]&&!a[l.nodeName(c)])},_4e_getWin:l._getWin,_4e_index:function(c,d){for(var a=c.parentNode.childNodes,k,g=-1,b=0;b<a.length;b++)if(k=a[b],!d||!(3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType))if(g++,k===c)return g;return-1},_4e_move:function(c,
d,a){d=w(d);a?d.insertBefore(c,d.firstChild):d.appendChild(c)},_4e_isIdentical:function(c,d){if(!d)return!1;d=w(d);if(l.nodeName(c)!=l.nodeName(d))return!1;var a=c.attributes,k=d.attributes,g=a.length,b=k.length;if(g!=b)return!1;for(var f=0;f<g;f++){var i=a[f],t=i.name;if(i.specified&&l.attr(c,t)!=l.attr(d,t))return!1}if(8>j.ieEngine)for(f=0;f<b;f++)if(i=k[f],t=i.name,i.specified&&l.attr(c,t)!=l.attr(d,t))return!1;return!0},_4e_isEmptyInlineRemovable:function(c){for(var c=c.childNodes,d=0,a=c.length;d<
a;d++){var k=c[d],g=k.nodeType;if(!(g==h.NODE_ELEMENT&&k.getAttribute("_ke_bookmark"))&&(g==h.NODE_ELEMENT&&!l._4e_isEmptyInlineRemovable(k)||g==h.NODE_TEXT&&e.trim(k.nodeValue)))return!1}return!0},_4e_moveChildren:function(c,d,a){d=w(d);if(c!=d)if(a)for(;a=c.lastChild;)d.insertBefore(c.removeChild(a),d.firstChild);else for(;a=c.firstChild;)d.appendChild(c.removeChild(a))},_4e_mergeSiblings:function(c){c=new a(c);m[c.nodeName()]&&(o(c,!0),o(c))},_4e_splitText:function(c,d){var a=c.ownerDocument;if(c.nodeType==
h.NODE_TEXT){if(v.ie&&d==c.nodeValue.length){var k=a.createTextNode("");l.insertAfter(k,c);return k}k=c.splitText(d);a.documentMode&&(a=a.createTextNode(""),l.insertAfter(a,k),l.remove(a));return k}},_4e_parents:function(c,d){var a=[];a.__IS_NODELIST=1;do a[d?"push":"unshift"](c);while(c=c.parentNode);return a},_4e_nextSourceNode:function(c,d,a,k){if(k&&!k.call)var g=w(k),k=function(b){return b!==g};var d=!d&&c.firstChild,b=c;if(!d){if(c.nodeType==h.NODE_ELEMENT&&k&&!1===k(c,!0))return null;d=c.nextSibling}for(;!d&&
(b=b.parentNode);){if(k&&!1===k(b,!0))return null;d=b.nextSibling}return!d||k&&!1===k(d)?null:a&&a!=d.nodeType?l._4e_nextSourceNode(d,!1,a,k):d},_4e_previousSourceNode:function(c,d,a,k){if(k&&!k.call)var g=w(k),k=function(b){return b!==g};var d=!d&&c.lastChild,b=c;if(!d){if(c.nodeType==h.NODE_ELEMENT&&k&&!1===k(c,!0))return null;d=c.previousSibling}for(;!d&&(b=b.parentNode);){if(k&&!1===k(b,!0))return null;d=b.previousSibling}return!d||k&&!1===k(d)?null:a&&d.nodeType!=a?l._4e_previousSourceNode(d,
!1,a,k):d},_4e_commonAncestor:function(c,d){d=w(d);if(c===d)return c;if(l.contains(d,c))return d;var a=c;do if(l.contains(a,d))return a;while(a=a.parentNode);return null},_4e_hasAttributes:9>j.ieEngine?function(c){for(var d=c.attributes,a=0;a<d.length;a++){var k=d[a];switch(k.name){case "class":if(c.getAttribute("class"))return!0;break;default:if(k.specified)return!0}}return!1}:function(c){v.gecko&&c.removeAttribute("_moz_dirty");return c.hasAttributes()},_4e_position:function(c,d){var a=w(d);if(c.compareDocumentPosition)return c.compareDocumentPosition(a);
if(c==a)return u.POSITION_IDENTICAL;if(c.nodeType==h.NODE_ELEMENT&&a.nodeType==h.NODE_ELEMENT){if(l.contains(c,a))return u.POSITION_CONTAINS+u.POSITION_PRECEDING;if(l.contains(a,c))return u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING;if("sourceIndex"in c)return 0>c.sourceIndex||0>a.sourceIndex?u.POSITION_DISCONNECTED:c.sourceIndex<a.sourceIndex?u.POSITION_PRECEDING:u.POSITION_FOLLOWING}for(var k=l._4e_address(c),a=l._4e_address(a),g=Math.min(k.length,a.length),b=0;b<=g-1;b++)if(k[b]!=a[b])return k[b]<
a[b]?u.POSITION_PRECEDING:u.POSITION_FOLLOWING;return k.length<a.length?u.POSITION_CONTAINS+u.POSITION_PRECEDING:u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING},_4e_address:function(c,d){for(var a=[],k=c.ownerDocument.documentElement,g=c;g&&g!=k;)a.unshift(l._4e_index(g,d)),g=g.parentNode;return a},_4e_remove:function(c,d){var a=c.parentNode;if(a){if(d)for(var k;k=c.firstChild;)a.insertBefore(c.removeChild(k),c);a.removeChild(c)}return c},_4e_trim:function(c){l._4e_ltrim(c);l._4e_rtrim(c)},_4e_ltrim:function(c){for(var d;d=
c.firstChild;){if(d.nodeType==h.NODE_TEXT){var a=j.ltrim(d.nodeValue),k=d.nodeValue.length;if(a)a.length<k&&(l._4e_splitText(d,k-a.length),c.removeChild(c.firstChild));else{c.removeChild(d);continue}}break}},_4e_rtrim:function(c){for(var d;d=c.lastChild;){if(d.type==h.NODE_TEXT){var a=j.rtrim(d.nodeValue),k=d.nodeValue.length;if(a)a.length<k&&(l._4e_splitText(d,a.length),c.removeChild(c.lastChild));else{c.removeChild(d);continue}}break}!v.ie&&!v.opera&&(d=c.lastChild)&&1==d.nodeType&&"br"==l.nodeName(d)&&
c.removeChild(d)},_4e_appendBogus:function(c){for(var a=c.lastChild;a&&a.nodeType==h.NODE_TEXT&&!e.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==h.NODE_TEXT||"br"!==l.nodeName(a))a=v.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),v.gecko&&a.setAttribute("type","_moz"),c.appendChild(a)},_4e_outerHtml:function(c){if(c.outerHTML)return c.outerHTML.replace(/<\?[^>]*>/,"");var a=c.ownerDocument.createElement("div");a.appendChild(c.cloneNode(!0));return a.innerHTML},
_4e_setMarker:function(c,d,h,k){var c=new a(c),g=c.data("list_marker_id")||c.data("list_marker_id",e.guid()).data("list_marker_id"),b=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");d[g]=c;b[h]=1;return c.data(h,k)},_4e_clearMarkers:function(c,d,h){var c=new a(c),k=c.data("list_marker_names"),g=c.data("list_marker_id"),b;for(b in k)k.hasOwnProperty(b)&&c.removeData(b);c.removeData("list_marker_names");h&&(c.removeData("list_marker_id"),delete d[g])},_4e_copyAttributes:function(c,
d,h){for(var d=new a(d),k=c.attributes,h=h||{},g=0;g<k.length;g++){var b=k[g],f=b.name.toLowerCase(),i;if(!(f in h))if("checked"==f&&(i=l.attr(c,f)))d.attr(f,i);else if(b.specified||v.ie&&b.value&&"value"==f)i=l.attr(c,f),null===i&&(i=b.nodeValue),d.attr(f,i)}""!==c.style.cssText&&(d[0].style.cssText=c.style.cssText)},_4e_isEditable:function(c){var c=l.nodeName(c),a=r.XHTML_DTD;return(c=!a.$nonEditable[c]&&(a[c]||a.span))&&c["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(e){function o(c){1>arguments.length||(this.range=c,this.forceBrBreak=r,this.enlargeBr=s,this.enforceRealBlocks=r,this._||(this._={}))}var s=!0,r=!1,l=e.Editor,v=e.UA,a=l.Walker,j=l.Range,m=l.RANGE,h=l.NODE,u=l.ElementPath,p=e.Node,n=e.DOM,w=/^[\r\n\t ]*$/;e.augment(o,{getNextParagraph:function(c){var d,q,k,g,b;if(!this._.lastNode){q=this.range.clone();q.shrink(m.SHRINK_ELEMENT,s);q.enlarge(this.forceBrBreak||!this.enlargeBr?m.ENLARGE_LIST_ITEM_CONTENTS:
m.ENLARGE_BLOCK_CONTENTS);var f=new a(q),i=a.bookmark(s,s);f.evaluator=i;this._.nextNode=f.next();f=new a(q);f.evaluator=i;f=f.previous();this._.lastNode=f._4e_nextSourceNode(s);this._.lastNode&&this._.lastNode[0].nodeType==h.NODE_TEXT&&!e.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(i=new j(q.document),i.moveToPosition(this._.lastNode,m.POSITION_AFTER_END),i.checkEndOfBlock()&&(i=new u(i.endContainer),this._.lastNode=(i.block||i.blockLimit)._4e_nextSourceNode(s)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new p(q.document.createTextNode("")),n.insertAfter(this._.lastNode[0],f[0]));q=null}i=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;i;){var t=r,y=i[0].nodeType!=h.NODE_ELEMENT,x=r;if(y)i[0].nodeType==h.NODE_TEXT&&w.test(i[0].nodeValue)&&(y=r);else{var l=i.nodeName();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==l)y=s;else if(!q&&!i[0].childNodes.length&&"hr"!=l){d=i;k=i.equals(f);break}q&&(q.setEndAt(i,m.POSITION_BEFORE_START),
"br"!=l&&(this._.nextNode=i));t=s}else{if(i[0].firstChild){q||(q=new j(this.range.document),q.setStartAt(i,m.POSITION_BEFORE_START));i=new p(i[0].firstChild);continue}y=s}}y&&!q&&(q=new j(this.range.document),q.setStartAt(i,m.POSITION_BEFORE_START));k=(!t||y)&&i.equals(f);if(q&&!t)for(;!i[0].nextSibling&&!k;){l=i.parent();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){t=s;k||l.equals(f);break}i=l;y=s;k=i.equals(f);x=s}y&&q.setEndAt(i,m.POSITION_AFTER_END);i=i._4e_nextSourceNode(x,null,f);if((k=
!i)||t&&q)break}if(!d){if(!q)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;d=new u(q.startContainer);i=d.blockLimit;t={div:1,th:1,td:1};d=d.block;if((!d||!d[0])&&!this.enforceRealBlocks&&t[i.nodeName()]&&q.checkStartOfBlock()&&q.checkEndOfBlock())d=i;else if(!d||this.enforceRealBlocks&&"li"==d.nodeName())d=new p(this.range.document.createElement(c||"p")),d[0].appendChild(q.extractContents()),d._4e_trim(),q.insertNode(d),g=b=s;else if("li"!=d.nodeName()){if(!q.checkStartOfBlock()||
!q.checkEndOfBlock())d=d.clone(r),d[0].appendChild(q.extractContents()),d._4e_trim(),b=q.splitBlock(),g=!b.wasStartOfBlock,b=!b.wasEndOfBlock,q.insertNode(d)}else k||(this._.nextNode=d.equals(f)?null:q.getBoundaryNodes().endNode._4e_nextSourceNode(s,null,f))}g&&(q=new p(d[0].previousSibling),q[0]&&q[0].nodeType==h.NODE_ELEMENT&&("br"==q.nodeName()?q._4e_remove():q[0].lastChild&&"br"==n.nodeName(q[0].lastChild)&&n._4e_remove(q[0].lastChild)));b&&(q=a.bookmark(r,s),g=new p(d[0].lastChild),g[0]&&g[0].nodeType==
h.NODE_ELEMENT&&"br"==g.nodeName()&&(v.ie||g.prev(q)||g.next(q))&&g.remove());this._.nextNode||(this._.nextNode=k||d.equals(f)?null:d._4e_nextSourceNode(s,null,f));return d}});j.prototype.createIterator=function(){return new o(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(e){function o(h){for(var e=a,p=a,n=[];h;){if(h[0].nodeType==v.NODE_ELEMENT){this.lastElement||(this.lastElement=h);var o=h.nodeName();if(!p&&(!e&&j[o]&&(e=h),m[o])){var c;if(c=!e)if(c="div"==o){a:{c=h[0].childNodes;for(var d=0,q=c.length;d<q;d++){var k=c[d];if(k.nodeType==v.NODE_ELEMENT&&l.$block[k.nodeName.toLowerCase()]){c=!0;break a}}c=!1}c=!c}c?e=h:p=h}n.push(h);if("body"==o)break}h=h.parent()}this.block=e;this.blockLimit=p;this.elements=n}var s=e.Editor,
r=e.DOM,l=s.XHTML_DTD,v=s.NODE,a=null,j={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},m={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};o.prototype={compare:function(a){var e=this.elements,a=a&&a.elements;if(!a||e.length!=a.length)return!1;for(var j=0;j<e.length;j++)if(!r.equals(e[j],a[j]))return!1;return!0},contains:function(h){for(var e=this.elements,j=0;j<e.length;j++)if(e[j].nodeName()in h)return e[j];return a},toString:function(){var a=this.elements,
e,j=[];for(e=0;e<a.length;e++)j.push(a[e].nodeName());return j.toString()}};return s.ElementPath=o},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(e){function o(m){var n;n=m.getSelection().getRanges();for(var o=n.length-1;0<o;o--)n[o].deleteContents();n=n[0];o=n.document;if(n.checkStartOfBlock()&&n.checkEndOfBlock()){var c=(new u(n.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return m.hasCommand("outdent")?(m.execCommand("save"),m.execCommand("outdent"),m.execCommand("save"),!0):!1}var d=n.splitBlock("p");if(!d)return!0;var m=d.previousBlock,c=d.nextBlock,q=
d.wasStartOfBlock,k=d.wasEndOfBlock,g;if(c)g=c.parent(),"li"==g.nodeName()&&(c._4e_breakParent(g),c._4e_move(c.next(),!0));else if(m&&(g=m.parent())&&"li"==g.nodeName())m._4e_breakParent(g),n.moveToElementEditablePosition(m.next()),m._4e_move(m.prev());if(!q&&!k){if("li"==c.nodeName()&&(g=c.first(h.invisible(!0)))&&e.inArray(g.nodeName(),["ul","ol"]))(l.ie?new j(o.createTextNode("\u00a0")):new j(o.createElement("br"))).insertBefore(g);c&&n.moveToElementEditablePosition(c)}else{var b;if(m){if("li"==m.nodeName()||
!v.test(m.nodeName()))b=m.clone()}else c&&(b=c.clone());b||(b=new j("<p>",null,o));if(g=d.elementPath)for(var d=0,f=g.elements.length;d<f;d++){var i=g.elements[d];if(i.equals(g.block)||i.equals(g.blockLimit))break;a.$removeEmpty[i.nodeName()]&&(i=i.clone(),b._4e_moveChildren(i),b.append(i))}l.ie||b._4e_appendBogus();n.insertNode(b);if(l.ie&&q&&(!k||!m[0].childNodes.length))n.moveToElementEditablePosition(k?m:b),n.select();n.moveToElementEditablePosition(q&&!k?c:b)}l.ie||(c?(b=new j(o.createElement("span")),
b.html("&nbsp;"),n.insertNode(b),b.scrollIntoView(void 0,!1),n.deleteContents()):b.scrollIntoView(void 0,!1));n.select();return!0}function s(a){var e=a.get("document")[0];m.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&e.preventDefault()}})}var r=e.Editor,l=e.UA,v=/^h[1-6]$/,a=r.XHTML_DTD,j=e.Node,m=e.Event,h=r.Walker,u=r.ElementPath;return{init:function(a){a.addCommand("enterBlock",
{exec:o});a.docReady(function(){s(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(e){function o(){var a=this;a.__iframeFocus=h;m=a;j&&clearTimeout(j);j=setTimeout(function(){a.fire("focus")},100)}function s(){var a=this;a.__iframeFocus=u;m=p;j&&clearTimeout(j);j=setTimeout(function(){a.fire("blur")},100)}var r=e.Editor,l=e.DOM,v=e.Event,a={},j,m,e={refreshAll:function(){for(var e in a)if(a.hasOwnProperty(e)){var j=a[e].get("document")[0];j.designMode="off";j.designMode="on"}},currentInstance:function(){return m},getInstance:function(e){return a[e]},
add:function(a){var e=l._4e_getWin(a.get("document")[0]);v.on(e,"focus",o,a);v.on(e,"blur",s,a)},register:function(e){a[e._UUID]=e},remove:function(e){delete a[e._UUID];var j=l._4e_getWin(e.get("document")[0]);v.remove(j,"focus",o,e);v.remove(j,"blur",s,e)}},h=!0,u=!1,p=null;e.refreshAll=e.refreshAll;r.focusManager=e;r.getInstances=function(){return a};return e},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(e){return{init:function(o){function s(a){return a.replace(w,function(a,d,b){return"<"+d+b.replace(c,function(f,a){return-1==b.indexOf("_ke_saved_"+a)?" _ke_saved_"+f+" "+f:f})+">"})}function r(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+d+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function l(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,c){return decodeURIComponent(c)})}
var v=v,a=e.Editor,j=e.Node,m=e.UA,h=e.require("htmlparser"),u=new h.Filter,p=new h.Filter,n=new h.Filter;(function(){var a=function(b,a){return function(c,d){var g=[];(""+c).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,i,e){i=i.toLowerCase();"font-family"==i&&(e=e.replace(/["']/g,""));for(var k,A,B,H=0;H<b.length;H++)if(b[H]&&(c=b[H][0],k=b[H][1],A=b[H][2],B=b[H][3],i.match(c)&&(!k||e.match(k)))){i=B||i;a&&(A=A||e);"function"==typeof A&&(A=A(e,d,i));A&&A.push&&
(i=A[0],A=A[1]);"string"==typeof A&&g.push([i,A]);return}!a&&g.push([i,e])});for(var e=0;e<g.length;e++)g[e]=g[e].join(":");return g.length?g.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],v),c={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(b){b.filterChildren()},tags:{p:function(b){b.filterChildren()},$:function(b){var a=b.nodeName||"";if(-1!=a.indexOf(":")&&
!/^ke/.test(a))if("v:imagedata"==a){if(a=b.getAttribute("o:href"))b.setAttribute("src",a),b.removeAttribute("o:href");if(a=b.getAttribute("o:title"))b.setAttribute("title",a),b.removeAttribute("o:title");b.setTagName("img")}else b.setTagName("")}},attributes:{"class":function(b){return!b||/(^|\s+)Mso/.test(b)?!1:b},style:function(b){b=a(b);return!b?!1:b}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(b){if(b.attributes.length)for(var a=
["name","href","src"],c,d=0;d<a.length;d++)c="_ke_saved_"+a[d],b.getAttribute(c)&&b.removeAttribute(a[d]);return b},embed:function(b){var a=b.parentNode;if(a&&"object"==a.nodeName){var c=a.getAttribute("width"),a=a.getAttribute("height");c&&b.setAttribute("width",c);a&&b.setAttribute("width",a)}},a:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1},span:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1}},attributes:{style:function(b){if(!e.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(b){return b.substr(0,d.length)==d?(b="{C}"==b.substr(d.length,3)?b.substr(d.length+3):b.substr(d.length),new h.CData(decodeURIComponent(b))):b}};m.ie&&(g.attributes.style=function(b){return b.replace(/(^|;)([^:]+)/g,function(b){return b.toLowerCase()})});u.addRules(g);p.addRules(c);n.addRules(c)})();(function(){function c(b){for(var b=b.childNodes,a=b.length,f=b[a-1];f&&3==f.nodeType&&!e.trim(f.nodeValue);)f=b[--a];return f}
function d(b,a){var f=c(b);f&&((a||!m.ie)&&1==f.nodeType&&"br"==f.nodeName?b.removeChild(f):3==f.nodeType&&i.test(f.nodeValue)&&b.removeChild(f))}function g(b){var a=c(b);return!a||1==a.nodeType&&"br"==a.nodeName||"form"==b.nodeName&&"input"==a.nodeName}function b(b){d(b,!0);g(b)&&(m.ie?b.appendChild(new h.Text("\u00a0")):(b.appendChild(new h.Text("&nbsp;")),b.appendChild(new h.Tag("br"))))}function f(b){d(b,!1);g(b)&&b.appendChild(new h.Text("\u00a0"))}var i=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,t=a.XHTML_DTD,j=a.Utils.mix({},
t.$block,t.$listItem,t.$tableContent),x;for(x in j)j.hasOwnProperty(x)&&("br"in t[x]||delete j[x]);delete j.td;delete j.pre;var t={tags:{}},l={tags:{}};for(x in j)j.hasOwnProperty(x)&&(t.tags[x]=b,l.tags[x]=f);p.addRules(t);u.addRules(l);n.addRules(t)})();(function(){u.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var w=/<(a|area|img|input)\b([^>]*)>/gi,c=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,d="{ke_protected}";o.htmlDataProcessor={wordFilter:n,
dataFilter:p,htmlFilter:u,toHtml:function(a){var c=new h.BeautifyWriter;(new h.Parser(a)).parse().writeHtml(c,u);return c.getHtml()},toDataFormat:function(a,c,d){d=d||p;m.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=s(a);c=new j("<div>");c.html("a"+a);a=c.html().substr(1);a=l(a);c=new h.BeautifyWriter;(new h.Parser(a)).parse().writeHtml(c,d);a=c.getHtml();return a=r(a)},toServer:function(a){var c=new h.MinifyWriter;(new h.Parser(a)).parse().writeHtml(c,
u);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(e,o,s,r,l){function v(b){var a=b.nodeType!=c.NODE_TEXT&&k.nodeName(b)in f.$removeEmpty,i=b.nodeType==c.NODE_TEXT&&!e.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return a||i||b}function a(b){return!x(b)&&!F(b)}function j(a){var f=n;return function(i){if(F(i))return p;if(i.nodeType==c.NODE_TEXT){if(e.trim(i.nodeValue).length)return n}else if(i.nodeType==c.NODE_ELEMENT&&(i=k.nodeName(i),!M[i]))if(!a&&!b.ie&&"br"==i&&!f)f=p;else return n;return p}}
function m(b,a){var f=b.startContainer,d=b.endContainer,g=b.startOffset,t=b.endOffset,e,j=n,h=n,y=void 0,m=b.document,Q;if(b.collapsed)return y;0<a&&(y=m.createDocumentFragment());b.optimizeBookmark();d[0].nodeType==c.NODE_TEXT?(h=p,d=d._4e_splitText(t)):0<d[0].childNodes.length&&(t>=d[0].childNodes.length?(d=new i(d[0].appendChild(m.createTextNode(""))),Q=p):d=new i(d[0].childNodes[t]));f[0].nodeType==c.NODE_TEXT?(j=p,f._4e_splitText(g)):g?g>=f[0].childNodes.length?(f=new i(f[0].appendChild(m.createTextNode(""))),
e=p):f=new i(f[0].childNodes[g].previousSibling):(e=new i(m.createTextNode("")),f.prepend(e),f=e,e=p);var x=f._4e_parents(),K=d._4e_parents();x.each(function(b,a){x[a]=b});K.each(function(b,a){K[a]=b});for(var l,L,m=0;m<x.length&&!(l=x[m],L=K[m],!l.equals(L));m++);for(var g=y,z,o,q=m;q<x.length;q++){z=x[q];t=0<a&&!z.equals(f)?g.appendChild(z.clone()[0]):null;z=z[0].nextSibling;o=K[q];for(var r=d[0],u=o&&o[0];z&&!(u==z||r==z);)o=z.nextSibling,2==a?g.appendChild(z.cloneNode(p)):(k._4e_remove(z),1==
a&&g.appendChild(z)),z=o;t&&(g=t)}for(g=y;m<K.length;m++){z=K[m];t=0<a&&!z.equals(d)?g.appendChild(z.clone()[0]):null;if(!x[m]||z[0].parentNode!=x[m][0].parentNode)for(z=z[0].previousSibling;z;)o=z.previousSibling,2==a?g.insertBefore(z.cloneNode(p),g.firstChild):(k._4e_remove(z),1==a&&g.insertBefore(z,g.firstChild)),z=o;t&&(g=t)}if(2==a){if(j&&(l=f[0],l.nodeType==c.NODE_TEXT&&l.nextSibling&&l.nextSibling.nodeType==c.NODE_TEXT&&(l.data+=l.nextSibling.data,l.parentNode.removeChild(l.nextSibling))),
h)h=d[0],h.nodeType==c.NODE_TEXT&&h.previousSibling&&h.previousSibling.nodeType==c.NODE_TEXT&&(h.previousSibling.data+=h.data,h.parentNode.removeChild(h))}else{if(l&&L&&(!f.parent().equals(l.parent())||!d.parent().equals(L.parent())))h=l._4e_index(),e&&l.parent().equals(f.parent())&&h--,b.setStart(l.parent(),h+1);b.collapse(p)}e&&f.remove();Q&&d.remove();return y}function h(b){b.collapsed=b.startContainer&&b.endContainer&&b.startContainer[0]==b.endContainer[0]&&b.startOffset==b.endOffset}function u(b){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=w;this.collapsed=p;this.document=b}o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var p=!0,n=!1,w=null,c=o.NODE,d=o.RANGE,q=o.POSITION,k=e.DOM,g=s.getByAddress,b=e.UA,f=o.XHTML_DTD,i=e.Node,t=i.all,y={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},x=new r.whitespaces,
F=new r.bookmark,E=r.whitespaces(p),I=r.bookmark(!1,!0),M={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};e.augment(u,{toString:function(){var b=[],a=this.startContainer[0],f=this.endContainer[0];b.push((a.id||a.nodeName)+":"+this.startOffset);b.push((f.id||f.nodeName)+":"+this.endOffset);return b.join("<br/>")},optimize:function(){var b=this.startContainer,a=this.startOffset;
b[0].nodeType!=c.NODE_ELEMENT&&(a?a>=b[0].nodeValue.length&&this.setStartAfter(b):this.setStartBefore(b));b=this.endContainer;a=this.endOffset;b[0].nodeType!=c.NODE_ELEMENT&&(a?a>=b[0].nodeValue.length&&this.setEndAfter(b):this.setEndBefore(b))},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},
optimizeBookmark:function(){var b=this.startContainer,a=this.endContainer;b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setStartBefore(b);a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setEndAfter(a)},setStart:function(b,a){b[0].nodeType==c.NODE_ELEMENT&&y[b.nodeName()]&&(b=b.parent(),a=b._4e_index());this.startContainer=b;this.startOffset=a;this.endContainer||(this.endContainer=b,this.endOffset=a);h(this)},setEnd:function(b,a){b[0].nodeType==c.NODE_ELEMENT&&y[b.nodeName()]&&(b=b.parent(),
a=b._4e_index()+1);this.endContainer=b;this.endOffset=a;this.startContainer||(this.startContainer=b,this.startOffset=a);h(this)},setStartAt:function(b,a){switch(a){case d.POSITION_AFTER_START:this.setStart(b,0);break;case d.POSITION_BEFORE_END:b[0].nodeType==c.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setStartBefore(b);break;case d.POSITION_AFTER_END:this.setStartAfter(b)}h(this)},setEndAt:function(b,a){switch(a){case d.POSITION_AFTER_START:this.setEnd(b,
0);break;case d.POSITION_BEFORE_END:b[0].nodeType==c.NODE_TEXT?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setEndBefore(b);break;case d.POSITION_AFTER_END:this.setEndAfter(b)}h(this)},cloneContents:function(){return m(this,2)},deleteContents:function(){return m(this,0)},extractContents:function(){return m(this,1)},collapse:function(b){b?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=
this.endContainer,this.startOffset=this.endOffset);this.collapsed=p},clone:function(){var b=new u(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=c.NODE_ELEMENT||b.endContainer[0].nodeType!=c.NODE_ELEMENT)return w;var a=new r(b);a.evaluator=function(b){return E(b)&&I(b)};b=a.next();
a.reset();a=a.previous();return b&&b.equals(a)?b:w},shrink:function(b,a){if(!this.collapsed){var b=b||d.SHRINK_TEXT,f=this.clone(),i=this.startContainer,g=this.endContainer,t=this.startOffset,e=this.endOffset,j=p,k,h,m=p;i&&i[0].nodeType==c.NODE_TEXT&&(t?t>=i[0].nodeValue.length?f.setStartAfter(i):(f.setStartBefore(i),j=n):f.setStartBefore(i));g&&g[0].nodeType==c.NODE_TEXT&&(e?e>=g[0].nodeValue.length?f.setEndAfter(g):(f.setEndAfter(g),m=n):f.setEndBefore(g));if(j||m)h=new r(f),h.evaluator=function(a){return a.nodeType==
(b==d.SHRINK_ELEMENT?c.NODE_ELEMENT:c.NODE_TEXT)},h.guard=function(a,f){a=a[0]||a;if(b==d.SHRINK_ELEMENT&&a.nodeType==c.NODE_TEXT||f&&a==k)return n;!f&&a.nodeType==c.NODE_ELEMENT&&(k=a);return p};j&&(f=h[b==d.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(f,a?d.POSITION_AFTER_START:d.POSITION_BEFORE_START);m&&(h.reset(),(h=h[b==d.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(h,a?d.POSITION_BEFORE_END:d.POSITION_AFTER_END));return j||m}},createBookmark2:function(b){var a=this.startContainer,
f=this.endContainer,d=this.startOffset,g=this.endOffset,t,e;if(!a||!f)return{start:0,end:0};if(b){if(a[0].nodeType==c.NODE_ELEMENT&&(t=new i(a[0].childNodes[d]))&&t[0]&&t[0].nodeType==c.NODE_TEXT&&0<d&&t[0].previousSibling.nodeType==c.NODE_TEXT)a=t,d=0;for(;a[0].nodeType==c.NODE_TEXT&&(e=a.prev())&&e[0].nodeType==c.NODE_TEXT;)a=e,d+=e[0].nodeValue.length;if(!this.collapsed){if(f[0].nodeType==c.NODE_ELEMENT&&(t=new i(f[0].childNodes[g]))&&t[0]&&t[0].nodeType==c.NODE_TEXT&&0<g&&t[0].previousSibling.nodeType==
c.NODE_TEXT)f=t,g=0;for(;f[0].nodeType==c.NODE_TEXT&&(e=f.prev())&&e[0].nodeType==c.NODE_TEXT;)f=e,g+=e[0].nodeValue.length}}return{start:a._4e_address(b),end:this.collapsed?w:f._4e_address(b),startOffset:d,endOffset:g,normalized:b,is2:p}},createBookmark:function(b){var a,f,c,g,t=this.collapsed;a=new i("<span>",w,this.document);a.attr("_ke_bookmark",1);a.css("display","none");a.html("&nbsp;");b&&(c=e.guid("ke_bm_"),a.attr("id",c+"S"));t||(f=a.clone(),f.html("&nbsp;"),b&&f.attr("id",c+"E"),g=this.clone(),
g.collapse(),g.insertNode(f));g=this.clone();g.collapse(p);g.insertNode(a);f?(this.setStartAfter(a),this.setEndBefore(f)):this.moveToPosition(a,d.POSITION_AFTER_END);return{startNode:b?c+"S":a,endNode:b?c+"E":f,serializable:b,collapsed:t}},moveToPosition:function(b,a){this.setStartAt(b,a);this.collapse(p)},trim:function(b,a){var f=this.startContainer,i=this.startOffset,d=this.collapsed;if((!b||d)&&f[0]&&f[0].nodeType==c.NODE_TEXT){if(i)if(i>=f[0].nodeValue.length)i=f._4e_index()+1,f=f.parent();else{var g=
f._4e_splitText(i),i=f._4e_index()+1,f=f.parent();k.equals(this.startContainer,this.endContainer)?this.setEnd(g,this.endOffset-this.startOffset):k.equals(f,this.endContainer)&&(this.endOffset+=1)}else i=f._4e_index(),f=f.parent();this.setStart(f,i);if(d){this.collapse(p);return}}f=this.endContainer;i=this.endOffset;!a&&!d&&f[0]&&f[0].nodeType==c.NODE_TEXT&&(i?(i>=f[0].nodeValue.length||f._4e_splitText(i),i=f._4e_index()+1):i=f._4e_index(),f=f.parent(),this.setEnd(f,i))},insertNode:function(b){this.optimizeBookmark();
this.trim(n,p);var a=this.startContainer;a[0].insertBefore(b[0],a[0].childNodes[this.startOffset]||null);a[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){var a=this.document;if(b.is2){var f=g(a,b.start,b.normalized),c=b.startOffset,a=b.end&&g(a,b.end,b.normalized),b=b.endOffset;this.setStart(f,c);a?this.setEnd(a,b):this.collapse(p)}else f=(c=b.serializable)?e.one("#"+b.startNode,a):b.startNode,b=c?e.one("#"+b.endNode,a):b.endNode,this.setStartBefore(f),
f._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(p)},getCommonAncestor:function(b,a){var f=this.startContainer,d=this.endContainer,f=f[0]==d[0]?b&&f[0].nodeType==c.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new i(f[0].childNodes[this.startOffset]):f:f._4e_commonAncestor(d);return a&&f[0].nodeType==c.NODE_TEXT?f.parent():f},enlarge:function(){function b(a,f,c,i){var d=a[f?"startContainer":"endContainer"],g,e=f?0:1,j=0,h=f?"previousSibling":"nextSibling";g=a[f?"startOffset":
"endOffset"];if(d[0].nodeType==k.TEXT_NODE){if(f){if(g)return}else if(g<d[0].nodeValue.length)return;g=d[0][h];d=d[0].parentNode}else g=d[0].childNodes[g+(f?-1:1)]||null,d=d[0];for(;d;){for(;g;)if(x(g)||F(g))g=g[h];else break;if(g){if(!j)a[f?"setStartAfter":"setEndBefore"](t(g));break}d=t(d);if("body"==d.nodeName())break;if(j||d.equals(i))c[e]=d,j=1;else a[f?"setStartBefore":"setEndAfter"](d);g=d[0][h];d=d[0].parentNode}}return function(a){switch(a){case d.ENLARGE_ELEMENT:if(this.collapsed)break;
var a=this.getCommonAncestor(),f=[];b(this,1,f,a);b(this,0,f,a);f[0]&&f[1]&&(a=f[0].contains(f[1])?f[1]:f[0],this.setStartBefore(a),this.setEndAfter(a));break;case d.ENLARGE_BLOCK_CONTENTS:case d.ENLARGE_LIST_ITEM_CONTENTS:var c=new u(this.document),f=new i(this.document.body);c.setStartAt(f,d.POSITION_AFTER_START);c.setEnd(this.startContainer,this.startOffset);var c=new r(c),g,e,j=r.blockBoundary(a==d.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),h=function(b){var a=j(b);a||(g=t(b));return a},m=function(b){var a=
h(b);!a&&"br"==k.nodeName(b)&&(e=t(b));return a};c.guard=h;c=c.lastBackward();g=g||f;this.setStartAt(g,"br"!=g.nodeName()&&(!c&&this.checkStartOfBlock()||c&&g.contains(c))?d.POSITION_AFTER_START:d.POSITION_AFTER_END);c=this.clone();c.collapse();c.setEndAt(f,d.POSITION_BEFORE_END);c=new r(c);c.guard=a==d.ENLARGE_LIST_ITEM_CONTENTS?m:h;g=w;c=c.lastForward();g=g||f;this.setEndAt(g,!c&&this.checkEndOfBlock()||c&&g.contains(c)?d.POSITION_BEFORE_END:d.POSITION_BEFORE_START);e&&this.setEndAfter(e)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,a=this.startOffset;if(a&&b[0].nodeType==c.NODE_TEXT&&e.trim(b[0].nodeValue.substring(0,a)).length)return n;this.trim();b=new l(this.startContainer);a=this.clone();a.collapse(p);a.setStartAt(b.block||b.blockLimit,d.POSITION_AFTER_START);b=new r(a);b.evaluator=j(p);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,a=this.endOffset;if(b[0].nodeType==c.NODE_TEXT&&e.trim(b[0].nodeValue.substring(a)).length)return n;this.trim();
b=new l(this.endContainer);a=this.clone();a.collapse(n);a.setEndAt(b.block||b.blockLimit,d.POSITION_BEFORE_END);b=new r(a);b.evaluator=j(n);return b.checkForward()},checkBoundaryOfElement:function(b,a){var f=this.clone();f[a==d.START?"setStartAt":"setEndAt"](b,a==d.START?d.POSITION_AFTER_START:d.POSITION_BEFORE_END);f=new r(f);f.evaluator=v;return f[a==d.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,a=this.endContainer,f=this.startOffset,i=this.endOffset,
g;if(b[0].nodeType==c.NODE_ELEMENT)if(g=b[0].childNodes.length,g>f)b=t(b[0].childNodes[f]);else if(0==g)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=t(b);b=b._4e_nextSourceNode()||b}if(a[0].nodeType==c.NODE_ELEMENT)if(g=a[0].childNodes.length,g>i)a=t(a[0].childNodes[i])._4e_previousSourceNode(p);else if(0==g)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=t(a)}b._4e_position(a)&q.POSITION_FOLLOWING&&(b=a);return{startNode:b,endNode:a}},fixBlock:function(a,
f){var c=this.createBookmark(),i=t(this.document.createElement(f));this.collapse(a);this.enlarge(d.ENLARGE_BLOCK_CONTENTS);i[0].appendChild(this.extractContents());i._4e_trim();b.ie||i._4e_appendBogus();this.insertNode(i);this.moveToBookmark(c);return i},splitBlock:function(a){var f=new l(this.startContainer),c=new l(this.endContainer),i=f.block,g=c.block,t=w;if(!f.blockLimit.equals(c.blockLimit))return w;"br"!=a&&(i||(i=this.fixBlock(p,a),g=(new l(this.endContainer)).block),g||(g=this.fixBlock(n,
a)));a=i&&this.checkStartOfBlock();f=g&&this.checkEndOfBlock();this.deleteContents();i&&i[0]==g[0]&&(f?(t=new l(this.startContainer),this.moveToPosition(g,d.POSITION_AFTER_END),g=w):a?(t=new l(this.startContainer),this.moveToPosition(i,d.POSITION_BEFORE_START),i=w):(g=this.splitElement(i),!b.ie&&!e.inArray(i.nodeName(),["ul","ol"])&&i._4e_appendBogus()));return{previousBlock:i,nextBlock:g,wasStartOfBlock:a,wasEndOfBlock:f,elementPath:t}},splitElement:function(b){if(!this.collapsed)return w;this.setEndAt(b,
d.POSITION_BEFORE_END);var a=this.extractContents(),f=b.clone(n);f[0].appendChild(a);f.insertAfter(b);this.moveToPosition(b,d.POSITION_AFTER_END);return f},moveToElementEditablePosition:function(b,f){for(var c=0;b;){if(b[0].nodeType==k.TEXT_NODE){this.moveToPosition(b,f?d.POSITION_AFTER_END:d.POSITION_BEFORE_START);c=1;break}b[0].nodeType==k.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,f?d.POSITION_BEFORE_END:d.POSITION_AFTER_START),c=1);var i=b,g=c,t=void 0;i[0].nodeType==k.ELEMENT_NODE&&
i._4e_isEditable()&&(t=i[f?"last":"first"](a));!g&&!t&&(t=i[f?"prev":"next"](a));b=t}return!!c},selectNodeContents:function(b){var a=b[0];this.setStart(b,0);this.setEnd(b,a.nodeType==c.NODE_TEXT?a.nodeValue.length:a.childNodes.length)}});s.injectDom({_4e_breakParent:function(b,a){var a=t(a),b=t(b),f,c=new o.Range(b[0].ownerDocument);c.setStartAfter(b);c.setEndAfter(a);f=c.extractContents();c.insertNode(b.remove());b.after(f)}});o.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(e){function o(b){this.document=b;this._={cache:{}};if(n){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=l}}function s(b){b=new o(b);return!b||b.isInvalid?v:b}var r=e.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var l=!0,v=null,a=e.UA,j=e.DOM,m=e.Node,h=r.SELECTION,u=r.RANGE,p=r.NODE,n=a.ie,w=r.Walker,c=r.Range,d={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};e.augment(o,{getNative:!n?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=j._4e_getWin(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!n?function(){var b=this._.cache;if(b.type)return b.type;var a=h.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=c.getRangeAt(0),
g=c.startContainer;g==c.endContainer&&g.nodeType==p.NODE_ELEMENT&&1==Number(c.endOffset-c.startOffset)&&d[g.childNodes[c.startOffset].nodeName.toLowerCase()]&&(a=h.SELECTION_ELEMENT)}}else a=h.SELECTION_NONE;return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=h.SELECTION_NONE;try{var c=this.getNative(),g=c.type;"Text"==g&&(a=h.SELECTION_TEXT);"Control"==g&&(a=h.SELECTION_ELEMENT);c.createRange().parentElement&&(a=h.SELECTION_TEXT)}catch(d){}return b.type=a},getRanges:n?function(){var b=
function(b,a){b=b.duplicate();b.collapse(a);for(var c=b.parentElement(),g=c.childNodes,d,e=0;e<g.length;e++){var j=g[e];if(j.nodeType==p.NODE_ELEMENT){d=b.duplicate();d.moveToElementText(j);var j=d.compareEndPoints("StartToStart",b),h=d.compareEndPoints("EndToStart",b);d.collapse();if(0<j)break;else{if(!j||1==h&&-1==j)return{container:c,offset:e};if(!h)return{container:c,offset:e+1}}d=v}}d||(d=b.duplicate(),d.moveToElementText(c),d.collapse(!1));d.setEndPoint("StartToStart",b);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=g[--e].nodeValue.length}catch(k){d=0}return 0===d?{container:c,offset:e}:{container:g[e],offset:-d}};return function(a){var g=this._.cache;if(g.ranges&&!a)return g.ranges;var d=this.getNative(),a=d&&d.createRange(),e=this.getType();if(!d)return[];if(e==h.SELECTION_TEXT)return d=new c(this.document),e=b(a,l),d.setStart(new m(e.container),e.offset),e=b(a),d.setEnd(new m(e.container),e.offset),g.ranges=[d];if(e==h.SELECTION_ELEMENT){g=g.ranges=[];for(e=0;e<a.length;e++){for(var j=
a.item(e),k=j.parentNode,o=0,d=new c(this.document);o<k.childNodes.length&&k.childNodes[o]!=j;o++);d.setStart(new m(k),o);d.setEnd(new m(k),o+1);g.push(d)}return g}return g.ranges=[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;var b=[],g=this.getNative();if(!g)return[];for(var d=0;d<g.rangeCount;d++){var e=g.getRangeAt(d),j=new c(this.document);j.setStart(new m(e.startContainer),e.startOffset);j.setEnd(new m(e.endContainer),e.endOffset);b.push(j)}return a.ranges=b},getStartElement:function(){var b=
this._.cache;if(void 0!==b.startElement)return b.startElement;var a,c=this.getNative();switch(this.getType()){case h.SELECTION_ELEMENT:return this.getSelectedElement();case h.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();l;)if(a=g.startContainer,g.startOffset==(a[0].nodeType===p.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())g.setStartAfter(a);else break;a=g.startContainer;if(a[0].nodeType!=p.NODE_ELEMENT)return a.parent();a=new m(a[0].childNodes[g.startOffset]);
if(!a[0]||a[0].nodeType!=p.NODE_ELEMENT)return g.startContainer;for(g=a[0].firstChild;g&&g.nodeType==p.NODE_ELEMENT;)a=new m(g),g=g.firstChild;return a}if(n)g=c.createRange(),g.collapse(l),a=new m(g.parentElement());else{if((a=c.anchorNode)&&a.nodeType!=p.NODE_ELEMENT)a=a.parentNode;a&&(a=new m(a))}}return b.startElement=a},getSelectedElement:function(){var b,a=this._.cache;if(void 0!==a.selectedElement)return a.selectedElement;n&&(b=this.getNative().createRange(),b=b.item&&b.item(0));if(!b){b=this.getRanges()[0];
for(var c,g,e=2;e&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==p.NODE_ELEMENT&&d[c.nodeName()]&&(g=c)));e--)b.shrink(u.SHRINK_ELEMENT);b=g}return a.selectedElement=new m(b)},reset:function(){this._.cache={}},selectElement:function(b){var a,c=this.document;if(n)try{a=c.body.createControlRange(),a.addElement(b[0]),a.select()}catch(g){a=c.body.createTextRange(),a.moveToElementText(b[0]),a.select()}finally{}else a=c.createRange(),a.selectNode(b[0]),b=this.getNative(),b.removeAllRanges(),b.addRange(a);
this.reset()},selectRanges:function(b){if(n){if(1<b.length){var c=b[b.length-1];b[0].setEnd(c.endContainer,c.endOffset);b.length=1}b[0]&&b[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var g=0;g<b.length;g++){var d=b[g],e=this.document.createRange(),j=d.startContainer;if(d.collapsed&&(a.gecko&&1.09>a.gecko||a.opera||a.webkit)&&j[0].nodeType==p.NODE_ELEMENT&&!j[0].childNodes.length)j[0].appendChild(this.document.createTextNode(a.webkit?"\u200b":"")),d.startOffset++,d.endOffset++;
e.setStart(j[0],d.startOffset);e.setEnd(d.endContainer[0],d.endOffset);c.addRange(e)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),g=0;g<c.length;g++)a.push(c[g].createBookmark2(b));return a},createBookmarks:function(b,a){for(var c=[],g=this.document,d,a=a||this.getRanges(),h=a.length,k=0;k<h;k++){c.push(d=a[k].createBookmark(b,l));var m=(b=d.serializable)?e.one("#"+d.startNode,g):d.startNode;d=b?e.one("#"+d.endNode,g):d.endNode;for(var o=k+1;o<h;o++){var n=a[o],q=n.startContainer,
p=n.endContainer;j.equals(q,m.parent())&&n.startOffset++;j.equals(q,d.parent())&&n.startOffset++;j.equals(p,m.parent())&&n.endOffset++;j.equals(p,d.parent())&&n.endOffset++}}return c},selectBookmarks:function(b){for(var a=[],g=0;g<b.length;g++){var d=new c(this.document);d.moveToBookmark(b[g]);a.push(d)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();
b&&b.scrollIntoView(void 0,!1)},removeAllRanges:function(){var b=this.getNative();n?b&&b.clear():b&&b.removeAllRanges()}});var q={table:1,tbody:1,tr:1},k=w.whitespaces(l),g=/\ufeff|\u00a0/;c.prototype.select=c.prototype.select=!n?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==p.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(l),a.setEnd(this.endContainer[0],this.endOffset);else throw c;}b=s(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(b){var a=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==p.NODE_ELEMENT){(new o(this.document)).selectElement(new m(e));return}}(this.startContainer[0].nodeType==p.NODE_ELEMENT&&
this.startContainer.nodeName()in q||this.endContainer[0].nodeType==p.NODE_ELEMENT&&this.endContainer.nodeName()in q)&&this.shrink(u.SHRINK_ELEMENT,l);var h=this.createBookmark(),e=h.startNode,n;a||(n=h.endNode);h=this.document.body.createTextRange();h.moveToElementText(e[0]);h.moveStart("character",1);if(n)b=this.document.body.createTextRange(),b.moveToElementText(n[0]),h.setEndPoint("EndToEnd",b),h.moveEnd("character",-1);else{for(c=e[0].nextSibling;c&&!k(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(g))&&(b||!e[0].previousSibling||e[0].previousSibling&&"br"==j.nodeName(e[0].previousSibling));d=new m(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(e);c&&j.insertBefore(this.document.createTextNode("\ufeff"),e[0]||e)}this.setStartBefore(e);e._4e_remove();if(a){if(c?(h.moveStart("character",-1),h.select(),this.document.selection.clear()):h.select(),d)this.moveToPosition(d,u.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(n),n._4e_remove(),h.select()};
o.getSelection=s;return r.Selection=o},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(e,o){function s(a){function d(b,a){var c=f.body.createTextRange();try{c.moveToPoint(b,a)}catch(g){c=m}return c}function e(){var b=f.selection.createRange();i&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&i.select();u.remove(f,"mouseup",e);u.remove(f,"mousemove",j);i=g=0}function j(b){if(b.button){if(b=d(b.pageX,b.pageY))0<b.compareEndPoints("StartToStart",i)?b.setEndPoint("StartToStart",i):b.setEndPoint("EndToEnd",i),b.select()}else e()}var g,
b=a.get("iframe")[0].contentWindow,f=a.get("document")[0],i;u.on(f,"mousedown contextmenu",function(a){var c=f.documentElement;if(a.target===c&&(g&&e(),!(c.scrollHeight>c.clientHeight)&&(g=1,i=d(a.pageX,a.pageY))))u.on(f,"mouseup",e),u.on(f,"mousemove",j),b.focus(),i.select()})}function r(c){function d(g){if(f){var i=c.getSelection(),h=i&&i.getType(),j=i&&e.selection;if(g&&j&&h==n.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){d(a)},50);else{var k;if(!j||!j.type||!("Control"!=
j.type&&(k=j.createRange())&&(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))b=j&&i.getRanges()[0],c._monitor()}}}var e=c.get("document")[0],h=new p(e.body),g=new p(e.documentElement);if(8>o.Utils.ieEngine)g.on("click",function(b){"html"===(new p(b.target)).nodeName()&&c.getSelection().getNative().createRange().select()});var b,f,i=a;g.on("mousedown",function(){i=j});g.on("mouseup",function(){i=a});h.on("focusin",function(a){if("body"==(new p(a.target)).nodeName()&&b){try{i&&
b.select()}catch(c){}b=m}});h.on("focus",function(){f=a;d()});h.on("beforedeactivate",function(b){b.relatedTarget||(f=j,i=a)});h.on("mousedown",function(){f=j});h.on("mouseup",function(){f=a;setTimeout(function(){d(a)},0)});h.on("keydown",function(){f=j});h.on("keyup",function(){f=a;setTimeout(function(){d()},0)})}function l(a){var d=a.get("document")[0];u.on(d,"mouseup keyup",function(){a._monitor()})}function v(c){function d(b){var a=o.XHTML_DTD;return b._4e_isBlockBoundary()&&a.$empty[b.nodeName()]}
function e(a){return b(a)&&f(a)}var k=c.get("document")[0],g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=o.Walker.whitespaces(a),f=o.Walker.bookmark(j,a),i=function(a){return b(a)&&8!=a.nodeType};c.on("selectionChange",function(b){var f=b.path,m=new p(c.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],l=f.blockLimit;if(h.gecko){var n=f.block||f.blockLimit,r=n&&n.last(e);n&&n._4e_isBlockBoundary()&&
(!r||!(1==r[0].nodeType&&r._4e_isBlockBoundary()))&&"pre"!=n.nodeName()&&!n._4e_getBogus()&&n._4e_appendBogus()}if(b&&b.collapsed&&!f.block){if("body"==l.nodeName()){if((f=b.fixBlock(a,"p"))&&f[0]!=m[0].lastChild&&f._4e_outerHtml().match(g))if((l=f.next(i))&&l[0].nodeType==w.NODE_ELEMENT&&!d[l])b.moveToElementEditablePosition(l),f._4e_remove();else if((l=f.prev(i))&&l[0].nodeType==w.NODE_ELEMENT&&!d[l])b.moveToElementEditablePosition(l,l._4e_outerHtml().match(g)?j:a),f._4e_remove();b.select();c.notifySelectionChange()}f=
new o.Range(k);f.moveToElementEditablePosition(m,a);"body"!==(new o.ElementPath(f.startContainer)).blockLimit.nodeName()&&(m=(new p(k.createElement("p"))).appendTo(m),h.ie||m._4e_appendBogus())}})}var a=!0,j=!1,m=null,h=e.UA,u=e.Event,p=e.Node,n=o.SELECTION,w=o.NODE;return{init:function(a){a.docReady(function(){h.ie?(s(a),r(a)):l(a)});v(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(e){function o(b){return!F.attr(b,"_ke_bookmark")}function s(b,a){for(var c in b)b.hasOwnProperty(c)&&(e.isString(b[c])?b[c]=b[c].replace(R,function(b,c){return a[c]}):s(b[c],a))}function r(b,a){a&&(b=e.clone(b),s(b,a));var c=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#"==c||N[c]?E.STYLE_BLOCK:O[c]?E.STYLE_OBJECT:E.STYLE_INLINE;this._={definition:b}}function l(b,a){var c=a?this.removeFromRange:this.applyToRange;b.body.focus();
for(var g=new M(b),d=g.getRanges(),f=0;f<d.length;f++)c.call(this,d[f]);g.selectRanges(d)}function v(b,a,c){var g=b.element;"*"==g&&(g="span");a=new D(a.createElement(g));c&&c._4e_copyAttributes(a);c=b._.definition;b=c.attributes;c=r.getStyleText(c);if(b)for(var d in b)b.hasOwnProperty(d)&&a.attr(d,b[d]);c&&(a[0].style.cssText=c);return a}function a(b){var a=b.createBookmark(i),c=b.createIterator();c.enforceRealBlocks=i;c.enlargeBr=i;for(var g,d=b.document;g=c.getNextParagraph();){var f=v(this,d,
g),e=f,f="pre"==e.nodeName,k="pre"==g.nodeName,l=!f&&k;f&&!k?(k=g,l=k.html(),l=j(l,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),l=l.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),l=l.replace(/([ \t\n\r]+|&nbsp;)/g," "),l=l.replace(/<br\b[^>]*>/gi,"\n"),C.ie?(k=k[0].ownerDocument.createElement("div"),k.appendChild(e[0]),e[0].outerHTML="<pre>"+l+"</pre>",e=new D(k.firstChild),e._4e_remove()):e.html(l)):l?e=h(m(g),e):g._4e_moveChildren(e);g[0].parentNode.replaceChild(e[0],g[0]);if(f&&(g=e,f=void 0,(f=g._4e_previousSourceNode(i,
A.NODE_ELEMENT))&&"pre"==f.nodeName()))e=j(f.html(),/\n$/,"")+"\n\n"+j(g.html(),/^\n/,""),C.ie?g[0].outerHTML="<pre>"+e+"</pre>":g.html(e),f._4e_remove()}b.moveToBookmark(a)}function j(b,a,c){var g="",f="",b=b.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(b,a,c){a&&(g=a);c&&(f=c);return""});return g+b.replace(a,c)+f}function m(b){var a=[];j(b._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,a,c){return a+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(b,c){a.push(c)});return a}function h(b,a){for(var c=a[0].ownerDocument.createDocumentFragment(),g=0;g<b.length;g++){var f=b[g],f=f.replace(/(\r\n|\r)/g,"\n"),f=j(f,/^[ \t]*\n/,""),f=j(f,/\n$/,""),f=j(f,/^[ \t]+|[ \t]+$/g,function(b,a){return 1==b.length?"&nbsp;":a?" "+Array(b.length).join("&nbsp;"):Array(b.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(b){return Array(b.length).join("&nbsp;")+" "}),
d=a.clone();d.html(f);c.appendChild(d[0])}return c}function u(b){var a=b.document;if(b.collapsed)a=v(this,a,void 0),b.insertNode(a),b.moveToPosition(a,I.POSITION_BEFORE_END);else{var c=this.element,g=this._.definition,f,d=G[c];d||(f=i,d=G.span);var e=b.createBookmark();b.enlarge(I.ENLARGE_ELEMENT);b.trim();for(var j=b.createBookmark(),h=j.startNode,j=j.endNode,m=h,l;m&&m[0];){var n=t;if(F.equals(m,j))m=y,n=i;else{var p=m[0].nodeType,r=p==A.NODE_ELEMENT?m.nodeName():y;if(r&&m.attr("_ke_bookmark")){m=
m._4e_nextSourceNode(i);continue}if(!r||d[r]&&(m._4e_position(j)|B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(m))){var q=m.parent();if(q&&"a"==c&&q.nodeName()==c)p=v(this,a,void 0),q._4e_moveChildren(p),q[0].parentNode.replaceChild(p[0],q[0]),p._4e_mergeSiblings();else if(q&&q[0]&&((G[q.nodeName()]||G.span)[c]||f)&&(!g.parentRule||g.parentRule(q))){if(!l&&(!r||!G.$removeEmpty[r]||(m._4e_position(j)|
B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED))l=new H(a),l.setStartBefore(m);if(p==A.NODE_TEXT||p==A.NODE_ELEMENT&&!m[0].childNodes.length){q=m;for(p=null;(n=!q.next(o))&&(p=q.parent())&&d[p.nodeName()]&&(p._4e_position(h)|B.POSITION_FOLLOWING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_FOLLOWING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(p));)q=p;l.setEndAfter(q)}}else n=
i}else n=i;m=m._4e_nextSourceNode()}if(n&&l&&!l.collapsed){for(var n=v(this,a,void 0),q=l.getCommonAncestor(),p={},r={},u,x=null,s;n&&q&&n[0]&&q[0];){if(q.nodeName()==c){for(u in g.attributes)if(g.attributes.hasOwnProperty(u)&&!r[u]&&(s=q.attr(x)))n.attr(u)==s?n.removeAttr(u):r[u]=1;for(x in g.styles)if(g.styles.hasOwnProperty(x)&&!p[x]&&(s=q.style(x)))n.style(x)==s?n.style(x,""):p[x]=1;if(!n._4e_hasAttributes()){n=y;break}}q=q.parent()}n?(n[0].appendChild(l.extractContents()),k(this,n),l.insertNode(n),
n._4e_mergeSiblings(),C.ie||n[0].normalize()):(n=new D(a.createElement("span")),n[0].appendChild(l.extractContents()),l.insertNode(n),k(this,n),n._4e_remove(!0));l=y}}h._4e_remove();j._4e_remove();b.moveToBookmark(e);b.shrink(I.SHRINK_TEXT)}}function p(b){b.enlarge(I.ENLARGE_ELEMENT);var a=b.createBookmark(),f=a.startNode;if(b.collapsed){for(var e=new J(f.parent()),i,j=0,h;j<e.elements.length&&(h=e.elements[j])&&!(h==e.block||h==e.blockLimit);j++)if(this.checkElementRemovable(h)){var k=b.checkBoundaryOfElement(h,
I.END),m=!k&&b.checkBoundaryOfElement(h,I.START);m||k?(i=h,i.match=m?"start":"end"):(h._4e_mergeSiblings(),h.nodeName()!=this.element?(k=c(this),g(h,k[h.nodeName()]||k["*"])):d(this,h))}if(i.length){h=f;for(j=0;;j++){k=e.elements[j];if(F.equals(k,i))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(h[0]);h=k}h["start"==i.match?"insertBefore":"insertAfter"](i)}}else{var l=a.endNode,n=this,e=function(){for(var b=new J(f.parent()),a=new J(l.parent()),c=y,g=y,d=0;d<b.elements.length;d++){var i=
b.elements[d];if(i==b.block||i==b.blockLimit)break;n.checkElementRemovable(i)&&(c=i)}for(d=0;d<a.elements.length;d++){i=a.elements[d];if(i==a.block||i==a.blockLimit)break;n.checkElementRemovable(i)&&(g=i)}g&&l._4e_breakParent(g);c&&f._4e_breakParent(c)};e();for(i=new D(f[0].nextSibling);i[0]!==l[0];){j=i._4e_nextSourceNode();if(i[0]&&i[0].nodeType==A.NODE_ELEMENT&&this.checkElementRemovable(i)&&(i.nodeName()==this.element?d(this,i):(h=c(this),g(i,h[i.nodeName()]||h["*"])),j[0].nodeType==A.NODE_ELEMENT&&
j.contains(f)))e(),j=new D(f[0].nextSibling);i=j}}b.moveToBookmark(a)}function n(b){var a={};(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,g){a[c]=g});return a}function w(b,a){var c="";a!==t?(c=document.createElement("span"),c.style.cssText=b,c=c.style.cssText||""):c=b;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(b){if(b._.overrides)return b._.overrides;var a=b._.overrides={},c=b._.definition.overrides;
if(c){e.isArray(c)||(c=[c]);for(var g=0;g<c.length;g++){var f=c[g],d,i,h;"string"==typeof f?d=f.toLowerCase():(d=f.element?f.element.toLowerCase():b.element,i=f.attributes,h=f.styles);f=a[d]||(a[d]={});if(i){d=f.attributes=f.attributes||[];for(var j in i)i.hasOwnProperty(j)&&d.push([j.toLowerCase(),i[j]])}if(h){var f=f.styles=f.styles||[],k;for(k in h)h.hasOwnProperty(k)&&f.push([k.toLowerCase(),h[k]])}}}return a}function d(a,g){var f=a._.definition,d=c(a),h=x.mix(f.attributes,(d[g.nodeName()]||d["*"]||
{}).attributes),f=x.mix(f.styles,(d[g.nodeName()]||d["*"]||{}).styles),d=e.isEmptyObject(h)&&e.isEmptyObject(f),j;for(j in h)if(h.hasOwnProperty(j)&&!(("class"==j||a._.definition.fullMatch)&&g.attr(j)!=q(j,h[j])))d=d||!!g.hasAttr(j),g.removeAttr(j);for(var k in f)f.hasOwnProperty(k)&&!(a._.definition.fullMatch&&g.style(k)!=q(k,f[k],i))&&(d=d||!!g.style(k),g.style(k,""));b(g)}function q(b,a,c){var g=new D("<span>");g[c?"style":"attr"](b,a);return g[c?"style":"attr"](b)}function k(b,a){for(var f=c(b),
i=a.all(b.element),e=i.length;0<=--e;)d(b,new D(i[e]));for(var h in f)if(f.hasOwnProperty(h)&&h!=b.element){i=a.all(h);for(e=i.length-1;0<=e;e--){var j=new D(i[e]);g(j,f[h])}}}function g(a,c){var g,f=c&&c.attributes;if(f)for(g=0;g<f.length;g++){var d=f[g][0],i;if(i=a.attr(d)){var e=f[g][1];(e===y||e.test&&e.test(i)||"string"==typeof e&&i==e)&&a[0].removeAttribute(d)}}if(f=c&&c.styles)for(g=0;g<f.length;g++)if(d=f[g][0],e=a.css(d)){var h=f[g][1];(h===y||h.test&&h.test(i)||"string"==typeof h&&e==h)&&
a.css(d,"")}b(a)}function b(b){if(!b._4e_hasAttributes()){var a=b[0].firstChild,c=b[0].lastChild;b._4e_remove(i);a&&(a.nodeType==A.NODE_ELEMENT&&F._4e_mergeSiblings(a),c&&a!=c&&c.nodeType==A.NODE_ELEMENT&&F._4e_mergeSiblings(c))}}var f=e.Editor,i=!0,t=!1,y=null,x=f.Utils,F=e.DOM,E={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},I=f.RANGE,M=f.Selection,A=f.NODE,B=f.POSITION,H=f.Range,D=e.Node,C=e.UA,J=f.ElementPath,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},G=f.XHTML_DTD,O={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;f.STYLE=E;r.prototype={apply:function(b){l.call(this,b,t)},remove:function(b){l.call(this,b,i)},applyToRange:function(b){return(this.applyToRange=this.type==E.STYLE_INLINE?u:this.type==E.STYLE_BLOCK?a:y).call(this,b)},removeFromRange:function(b){return(this.removeFromRange=this.type==E.STYLE_INLINE?p:y).call(this,b)},checkElementRemovable:function(b,a){if(!b)return t;var g=this._.definition,
f;if(b.nodeName()==this.element){if(!a&&!b._4e_hasAttributes())return i;var d=g._AC;if(d)g=d;else{var d={},e=0,h=g.attributes;if(h)for(var j in h)h.hasOwnProperty(j)&&(e++,d[j]=h[j]);if(h=r.getStyleText(g))d.style||e++,d.style=h;d._length=e;g=g._AC=d}if(g._length){for(var k in g)if("_length"!=k&&g.hasOwnProperty(k)){e=b.attr(k)||"";if("style"==k)a:{d=g[k];e=w(e,t);"string"==typeof d&&(d=n(d));"string"==typeof e&&(e=n(e));h=void 0;for(h in d)if(d.hasOwnProperty(h)&&!(h in e&&(e[h]==d[h]||"inherit"==
d[h]||"inherit"==e[h]))){d=t;break a}d=i}else d=g[k]==e;if(d){if(!a)return i}else if(a)return t}if(a)return i}else return i}k=c(this);if(k=k[b.nodeName()]||k["*"]){if(!(g=k.attributes)&&!(f=k.styles))return i;if(g)for(d=0;d<g.length;d++)if(k=g[d][0],k=b.attr(k))if(e=g[d][1],e===y||"string"==typeof e&&k==e||e.test&&e.test(k))return i;if(f)for(d=0;d<f.length;d++)if(k=b.css(f[d][0]))if(g=f[d][1],g===y||"string"==typeof g&&k==g||g.test&&g.test(k))return i}return t},checkActive:function(b){switch(this.type){case E.STYLE_BLOCK:return this.checkElementRemovable(b.block||
b.blockLimit,i);case E.STYLE_OBJECT:case E.STYLE_INLINE:for(var a=b.elements,c=0,g;c<a.length;c++)if(g=a[c],!(this.type==E.STYLE_INLINE&&(F.equals(g,b.block)||F.equals(g,b.blockLimit))))if((this.type!=E.STYLE_OBJECT||g.nodeName()in O)&&this.checkElementRemovable(g,i))return i}return t}};r.getStyleText=function(b){var a=b._ST;if(a)return a;var a=b.styles,c=b.attributes&&b.attributes.style||"",g="";c.length&&(c=c.replace(P,";"));for(var f in a)if(a.hasOwnProperty(f)){var d=a[f],e=(f+":"+d).replace(P,
";");"inherit"==d?g+=e:c+=e}c.length&&(c=w(c));return b._ST=c+g};f.Style=r},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(e){var o=e.Editor,s=e.Node,r=e.DOM,l=e.UA,v={debugUrl:function(a){a=a.replace(/-min\.(js|css)/i,".$1");e.Config.debug||(a=a.replace(/\.(js|css)/i,"-min.$1"));-1==a.indexOf("?t")&&(a=-1!=a.indexOf("?")?a+"&":a+"?",a+="t="+encodeURIComponent("20120523205139"));e.startsWith(a,"/")&&(a=a.substring(1));return o.Config.base+a},lazyRun:function(a,e,m){var h=a[e],l=a[m];a[e]=function(){h.apply(this,arguments);a[e]=a[m];return l.apply(this,arguments)}},getXY:function(a,
e,m,h){m=m.defaultView||m.parentWindow;a-=r.scrollLeft(m);e-=r.scrollTop(m);h&&(h=h.defaultView||h.parentWindow,m!=h&&m.frameElement&&(h=r.offset(m.frameElement,void 0,h),a+=h.left,e+=h.top));return{left:a,top:e}},tryThese:function(a){for(var e,m=0,h=arguments.length;m<h;m++){var l=arguments[m];try{e=l();break}catch(o){}}return e},arrayCompare:function(a,e){if(!a&&!e)return!0;if(!a||!e||a.length!=e.length)return!1;for(var m=0;m<a.length;m++)if(a[m]!==e[m])return!1;return!0},getByAddress:function(a,
e,m){for(var a=a.documentElement,h=0;a&&h<e.length;h++){var l=e[h];if(m)for(var o=-1,n=0;n<a.childNodes.length;n++){var r=a.childNodes[n];if(!(!0===m&&3==r.nodeType&&r.previousSibling&&3==r.previousSibling.nodeType)&&(o++,o==l)){a=r;break}}else a=a.childNodes[l]}return a?new s(a):null},clearAllMarkers:function(a){for(var e in a)a.hasOwnProperty(e)&&a[e]._4e_clearMarkers(a,!0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},mix:function(a){for(var j={},
m=0;m<arguments.length;m++)j=e.mix(j,arguments[m]);return j},isCustomDomain:function(){if(!l.ie)return!1;var a=document.domain,e=window.location.hostname;return a!=e&&a!="["+e+"]"},isNumber:function(a){return/^\d+(.\d+)?$/.test(e.trim(a))},verifyInputs:function(a){for(var j=0;j<a.length;j++){var m=new s(a[j]),h=e.trim(v.valInput(m)),l=m.attr("data-verify"),m=m.attr("data-warning");if(l&&!RegExp(l).test(h))return alert(m),!1}return!0},sourceDisable:function(a,e){a.on("sourceMode",e.disable,e);a.on("wysiwygMode",
e.enable,e)},resetInput:function(a){var e=a.attr("placeholder");e&&l.ie?(a.addClass("ke-input-tip"),a.val(e)):l.ie||a.val("")},valInput:function(a,e){if(void 0===e)return a.hasClass("ke-input-tip")?"":a.val();a.removeClass("ke-input-tip");a.val(e)},placeholder:function(a,j){a.attr("placeholder",j);l.ie&&(a.on("blur",function(){e.trim(a.val())||(a.addClass("ke-input-tip"),a.val(j))}),a.on("focus",function(){a.removeClass("ke-input-tip");e.trim(a.val())==j&&a.val("")}))},htmlEncode:function(a){return!a?
a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(a){var a=e.clone(a),j;for(j in a)if(a.hasOwnProperty(j)){var m=a[j];e.isFunction(m)&&(a[j]=m())}return a},map:function(a,e){for(var m=0;m<a.length;m++)a[m]=e(a[m]);return a},ieEngine:document.documentMode||l.ie,preventFocus:function(a){l.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(a){e.mix(r,a);for(var j in a)a.hasOwnProperty(j)&&function(j){s.prototype[j]=
function(){var h=[].slice.call(arguments,0);h.unshift(this[0]);return(h=a[j].apply(null,h))&&(h.nodeType||e.isWindow(h))?new s(h):e.isArray(h)&&(h.__IS_NODELIST||h[0]&&h[0].nodeType)?new s(h):h}}(j)},addRes:function(){var a=this.__res=this.__res||[];a.push.apply(a,e.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],j=0;j<a.length;j++){var l=a[j];e.isFunction(l)?l():(l.destroy&&l.destroy(),l.remove&&l.remove())}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,
function(a,e){return e.toUpperCase()})+"Active"}};return o.Utils=v},{requires:["./base"]});
KISSY.add("editor/core/walker",function(e,o){function s(c,g){if(this._.end)return j;var b,f=this.range,d,e=this.guard,h=this.type,l=c?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),j;if(!c&&!this._.guardLTR){var m=f.endContainer[0],o=m.childNodes[f.endOffset];this._.guardLTR=function(b,a){return a&&(m==b||"body"==u.nodeName(b))?!1:b!=o}}if(c&&!this._.guardRTL){var p=f.startContainer[0],q=0<f.startOffset&&p.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(b,a){return a&&(p==b||"body"==u.nodeName(b))?!1:b!=q}}var r=c?this._.guardRTL:this._.guardLTR;d=e?function(b,c){return r(b,c)===a?a:e(b,c)}:r;this.current?b=this.current[l](a,h,d):c?(b=f.endContainer,0<f.endOffset?(b=new n(b[0].childNodes[f.endOffset-1]),d(b)===a&&(b=j)):b=d(b,v)===a?j:b._4e_previousSourceNode(v,h,d,void 0)):(b=f.startContainer,b=new n(b[0].childNodes[f.startOffset]),b.length?d(b)===a&&(b=j):b=d(f.startContainer,v)===a?j:f.startContainer._4e_nextSourceNode(v,
h,d,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==a){if(!g)return b}else if(g&&this.evaluator)return a;b=b[l](a,h,d)}this.end();return this.current=j}function r(a){for(var c,b=j;c=s.call(this,a);)b=c;return b}function l(a){this.range=a;this._={}}var v=!0,a=!1,j=null,m=e.UA,h=o.NODE,u=e.DOM,p=o.XHTML_DTD,n=e.Node;e.augment(l,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,v)},checkForward:function(){return s.call(this,
a,v)!==a},checkBackward:function(){return s.call(this,v,v)!==a},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,v)},reset:function(){delete this.current;this._={}},_iterator:s});l.blockBoundary=function(a){return function(c){return!(c.nodeType==h.NODE_ELEMENT&&u._4e_isBlockBoundary(c,a))}};l.bookmark=function(a,c){function b(b){return"span"==u.nodeName(b)&&u.attr(b,"_ke_bookmark")}return function(d){var e,j;e=d.nodeType==h.NODE_TEXT&&(j=d.parentNode)&&b(j);e=
a?e:e||b(d);return!!(c^e)}};l.whitespaces=function(a){return function(c){c=c.nodeType==h.NODE_TEXT&&!e.trim(c.nodeValue);return!!(a^c)}};l.invisible=function(a){var c=l.whitespaces();return function(b){b=c(b)||b.nodeType==h.NODE_ELEMENT&&!b.offsetHeight;return!!(a^b)}};var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,c=l.whitespaces(),d=l.bookmark(),q=function(a){var g=u.nodeName(a);return d(a)||c(a)||1==a.nodeType&&g in p.$inline&&!(g in p.$empty)};o.Utils.injectDom({_4e_getBogus:function(a){a=new n(a);do a=
a._4e_previousSourceNode();while(a&&q(a[0]));return a&&(!m.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return o.Walker=l},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(e){var o=e.Editor;o.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};o.baseZIndex=function(e){return(o.Config.baseZIndex||1E4)+e}},{requires:["./base"]});
KISSY.add("editor",function(e,o,s,r){function l(a,b){var d=a.body;c(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=v)},50)},function(){a.designMode="off";p.attr(d,"contentEditable",j);p.attr(d,"contentEditable",v);!b&&l(a,1)})}var v=!0,a=e.all,j=!1,m=document,h=e.UA,u=h.ie,p=e.DOM,n=e.Node,w=e.Event,c=s.tryThese,d="document.open();"+(s.isCustomDomain()?'document.domain="'+m.domain+'";':"")+"document.close();",q='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(u?' src="javascript:void(function(){'+encodeURIComponent(d)+'}())"':"")+' allowTransparency="true"></iframe>';e.mix(o,{SOURCE_MODE:0,WYSIWYG_MODE:1});var k=o.WYSIWYG_MODE;e.augment(o,{createDom:function(){var c=this.get("textarea"),b;c||this.set("textarea",c=a("<textarea></textarea>"));b=this.get("el");b.addClass(this.get("prefixCls")+"editor-wrap",void 0);b.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=e.guid();var d=
b.one(".ke-textarea-wrap");this.__set("iframeWrapEl",d);this.__set("toolBarEl",b.one(".ke-editor-tools"));this.__set("statusBarEl",b.one(".ke-editor-status"));var i=this.get("width"),h=this.get("height");b.css("width",i);c.css("width","100%");c.css("display","none");d.append(c);d.css("height",h);c.css("height",h);b.css("height","")},_uiSetHeight:function(a){this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("textarea");a?(b.execCommand("save"),
b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",c)}),b._setData(d.val())):(d.val(b._getData(1,k)),d[0].focus());d[a?"hide":"show"]();b.get("iframe")[a?"show":"hide"]();b.fire((a?"wysiwyg":"source")+"Mode")},renderUI:function(){function a(){b.detach("docReady",a);if(b.get("focus"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c=b.get("textarea");r.register(b);b.get("attachForm")&&c[0].form&&b._attachForm();b.on("docReady",a)},_createIframe:function(a){var b=
this,c=new n(q),d=b.get("textarea");d.hasAttr("tabindex")&&c.attr("tabIndex",h.webkit?-1:d.attr("tabIndex"));b.get("iframeWrapEl").prepend(c);b.set("iframe",c);b.__docReady=0;if(h.gecko&&!c.__loaded)c.on("load",function(){b._setUpIFrame(a)},b);else b._setUpIFrame(a)},destructor:function(){var a=this.get("el"),b=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();o.focusManager.remove(this);w.remove([c,c.documentElement,c.body,d]);e.each(this.__dialogs,
function(b){b.destroy&&b.destroy()});this.__commands=0;this.__editor_created_new||(b.insertBefore(a,void 0),b.css({width:this.get("width"),height:this.get("height")}),b.show())},_attachForm:function(){var a=this,b=a.get("textarea"),c=new n(b[0].form);c.on("submit",a.sync,a);a.on("destroy",function(){c.detach("submit",a.sync,a)})},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var c=this.__dialogs[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},
hasDialog:function(a){return!!this.__dialogs[a]},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=e.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var a=this.get("iframe"),b=a[0].contentWindow,c=this.get("document")[0];w.remove([c,c.documentElement,c.body,b]);a.remove()}},_getData:function(a,b){var c=this.htmlDataProcessor,
d;void 0==b&&(b=this.get("mode"));d=b==k?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=e.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,c=a;if(this.get("mode")!=k)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(a){this.get("document")[0].body.innerHTML=a},_prepareIFrameHtml:function(a,b){var c=this.get("customStyle"),d=this.get("customLink"),e="",h=o.Utils.debugUrl("/theme/editor-iframe.css");if(d)for(var j=0;j<d.length;j++)e+='<link href="'+d[j]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===m.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+h+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+e+"</head><body class='ke-editor'>"+
(b||"&nbsp;")+(a?'<script id="ke_actscript" type="text/javascript">'+(s.isCustomDomain()?'document.domain="'+m.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"},getSelection:function(){return o.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=p._4e_getWin(a);h.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){p._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a){var b=this.get("customStyle")||"",b=b+("\n"+a);this.set("customStyle",b);p.addStyleSheet(this.get("iframe")[0].contentWindow,b)},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=p.query("link",b),c=
0;c<b.length;c++)b[c].href==a&&p.remove(b[c]);b=this.get("customLink")||[];a=e.indexOf(a,b);-1!=a&&b.splice(a,1)},_setUpIFrame:function(a){function b(){j=h.document;c.__set("document",new n(j));c.__set("window",new n(h));d.detach();j.open("text/html","replace");j.write(e);j.close()}var c=this,d=c.get("iframe"),e=c._prepareIFrameHtml(c._UUID,a),h=d[0].contentWindow,j;d.__loaded=1;try{j=h.document}catch(k){if(d[0].src=d[0].src,7>u){setTimeout(b,10);return}}b()},docReady:function(a){this.on("docReady",
a);this.__docReady&&a.call(this)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new o.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(a,b,c){var d=this;if(d.get("mode")===
k){d.focus();var e,h=a.nodeName(),l=o.XHTML_DTD,m=o.RANGE,p=o.NODE,q=l.$block[h],r=d.getSelection(),u=r&&r.getRanges(),s,w,D,C;if(!u||0==u.length){var J=arguments,N=J.callee;setTimeout(function(){N.apply(d,J)},30)}else{d.execCommand("save");for(var G=u.length-1;0<=G;G--){s=u[G];s.deleteContents();e=!G&&a||a.clone(v);b&&b(e);if(q)for(;(D=s.getCommonAncestor(j,v))&&(C=l[D.nodeName()])&&(!C||!C[h]);)D.nodeName()in l.span?s.splitElement(D):s.checkStartOfBlock()&&s.checkEndOfBlock()?(s.setStartBefore(D),
s.collapse(v),D.remove()):s.splitBlock();s.insertNode(e);w||(w=e)}w&&(h=w._4e_nextSourceNode(v),l=d.get("document")[0],C=o.XHTML_DTD,C.$inline[e.nodeName()]?(h=new n(l.createTextNode(" ")),h.insertAfter(w)):h?"br"==h.nodeName()&&C[h.parent().nodeName()].p&&(C=new n("<p>&nbsp;</p>",null,l),h[0].parentNode.replaceChild(C[0],h[0]),h=C):(C=new n("<p>&nbsp;</p>",null,l),C.insertAfter(w),h=C),s.moveToPosition(w,m.POSITION_AFTER_END),h&&h[0].nodeType==p.NODE_ELEMENT&&s.moveToElementEditablePosition(h),r.selectRanges([s]),
d.focus(),e&&e.scrollIntoView(void 0,!1),d._saveLater(),c&&c(e))}}},insertHtml:function(a,b){var c=this,d;if(c.get("mode")===k){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,null,b);c.focus();c.execCommand("save");var e=c.get("document")[0];d=0;if(u){var h=e.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(a)}catch(l){}}else try{e.execCommand("inserthtml",j,a)}catch(m){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new o.Range(e),d=p.first(e.body,function(a){return 1==
a.nodeType&&"br"!=p.nodeName(a)});d||(d=new n(e.createElement("p")),e.body.appendChild(d[0]));b.setStartAt(d,o.RANGE.POSITION_AFTER_START);b.select()}e.execCommand("inserthtml",j,a)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);c._saveLater(d)}},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null);b.__saveTimer=setTimeout(function(){b.execCommand("save")},a||0)},_fixByBindIframeDoc:function(){var a=this,b=a.get("iframe"),c=a.get("textarea")[0],
b=b[0].contentWindow,d=a.get("document")[0];h.webkit&&(w.on(d,"click",function(a){var b=new n(a.target);e.inArray(b.nodeName(),["input","select"])&&a.preventDefault()}),w.on(d,"mouseup",function(a){var b=new n(a.target);e.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(h.gecko||u||h.opera){var k;k=(new n('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);k.on("focus",function(){a.focus()});a.activateGecko=function(){h.gecko&&
a.__iframeFocus&&k[0].focus()};a.on("destroy",function(){k.detach();k.remove()})}w.on(b,"focus",function(){h.gecko?l(d,j):h.opera&&d.body.focus();a.notifySelectionChange()});if(h.gecko)w.on(d,"mousedown",function(){a.__iframeFocus||l(d,j)});if(u&&(w.on(d,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var m=
{33:1,34:1};w.on(d,"keydown",function(b){b.keyCode in m&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(h.webkit)w.on(d,"mousedown",function(b){b=new n(b.target);e.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(h.gecko)w.on(d,"dragstart",function(a){var b=new n(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(a)}});o._initIFrame=function(a){var b=r.getInstance(a),c=b.get("document")[0],
a=c.getElementById("ke_actscript");p.remove(a);b._fixByBindIframeDoc();var d=c.body;u?(d.hideFocus=v,d.disabled=v,d.contentEditable=v,d.removeAttribute("disabled")):setTimeout(function(){h.gecko||h.opera?d.contentEditable=v:h.webkit?d.parentNode.contentEditable=v:c.designMode="on"},0);if(h.gecko||h.opera){var e=c.documentElement;w.on(e,"mousedown",function(a){if(a.target==e){h.gecko&&l(c,j);b.activateGecko()}})}setTimeout(function(){u&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";
d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),e=b.get("disableInlineTableEditing");if(a||e)try{c.execCommand("enableObjectResizing",j,!a);c.execCommand("enableInlineTableEditing",j,!e)}catch(g){w.on(d,u?"resizestart":"resize",function(b){var c=new n(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};return o},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
