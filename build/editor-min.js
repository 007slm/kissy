/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 23 21:27
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(j,r,q,m){r=m.create(q.Controller,[m.Box],{initializer:function(){var g;this.__commands={};this.__dialogs={};if(g=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var j=g.next();j?this.__set("elBefore",j):this.__set("render",g.parent())}this.get("width")||this.__set("width",g.style("width")||g.css("width"));this.get("height")||this.__set("height",g.style("height")||g.css("height"))}else this.__editor_created_new=1},use:function(g,m){for(var a=
this,d=a.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],g=g.split(","),n=g.length-1;0<=n;n--)g[n]||g.splice(n,1);for(n=0;n<d.length;n++){var k=d[n];j.inArray(k,g)||g.unshift(k)}j.each(g,function(a,d){g[d]&&(g[d]="editor/plugin/"+a+"/")});j.use(g.join(","),function(){var d=j.makeArray(arguments);d.shift();for(var k=0;k<d.length;k++)d[k].init(a);m&&m.call(a)});a.__CORE_PLUGINS=[];return a}},{Config:{base:j.Config.base+"editor/"},XHTML_DTD:r.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(j){return this._setData(j)}},formatData:{getter:function(){return this._getData(1)},setter:function(j){return this._setData(j)}},prefixCls:{value:"ke-"}}},"Editor");r.DefaultRender=m.create(q.Render,[m.Box.Render],{_uiSetHeight:function(){}});j.mix(r,j.EventTarget);return KISSY.Editor=r},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(j){function r(c){this.editor=c;this._init()}function q(c){if(s.ie&&"BackCompat"!=c.get("document")[0].compatMode){var a=c.getSelection(),e;if(a.getType()==f.SELECTION_ELEMENT&&(e=a.getSelectedElement())){var b=a.getRanges()[0],i=new g(c.get("document")[0].createTextNode(""));i.insertBefore(e);b.setStartBefore(i);b.setEndAfter(e);a.selectRanges([b]);setTimeout(function(){e.parent()&&(i.remove(),a.selectElement(e))},0)}}}var m=j.Editor,g=j.Node,s=j.UA,
a=m.Range,d=m.RANGE,n=j.Event;j.augment(r,{_init:function(){var c=this.editor;n.on(c.get("document")[0].body,s.webkit?"paste":s.gecko?"paste":"beforepaste",this._paste,this);n.on(c.get("document")[0].body,"contextmenu",function(){u=1;setTimeout(function(){u=0},10)});c.addCommand("copy",new p("copy"));c.addCommand("cut",new p("cut"));c.addCommand("paste",new p("paste"))},_paste:function(){if(!u){var c=this.editor,f=c.get("document")[0];if(!f.getElementById("ke_pastebin")){var e=c.getSelection(),b=
new a(f),i=new g(s.webkit?"<body></body>":"<div></div>",null,f);i.attr("id","ke_pastebin");s.webkit&&i[0].appendChild(f.createTextNode("\u00a0"));f.body.appendChild(i[0]);i.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});i.css("left","-1000px");var l=e.createBookmarks();b.setStartAt(i,d.POSITION_AFTER_START);b.setEndAt(i,d.POSITION_BEFORE_END);b.select(!0);setTimeout(function(){i.remove();var b;i=s.webkit&&(b=i.first())&&b.hasClass("Apple-style-span")?
b:i;e.selectBookmarks(l);b=i.html();if(b=j.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var f=c.fire("paste",{html:b,holder:i});void 0!==f&&(b=f);f=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)&&(f=c.htmlDataProcessor.wordFilter);c.insertHtml(b,f)}},0)}}}});var k=function(c,f){var e=c.get("document")[0],b=new g(e.body),i=!1,l=function(){i=!0};b.on(f,l);(7<s.ie?e:e.selection.createRange()).execCommand(f);b.detach(f,l);return i},t=s.ie?function(c,f){return k(c,
f)}:function(c,f){try{return c.get("document")[0].execCommand(f)}catch(e){return!1}},o={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},p=function(c){this.type=c};p.prototype={exec:function(c){"cut"==this.type&&q(c);(c=t(c,this.type))||alert(o[this.type]);return c}};var f=m.Selection,c={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},u;m.on("contextmenu",function(f){var a=f.contextmenu,e=a.get("editor"),
b=a.menu.get("contentEl"),i={copy:0,cut:0,paste:0},l;for(l in i)i.hasOwnProperty(l)&&(i[l]=b.one(".ke-paste-"+l),i[l]||function(f){var l=(new g("<a href='#'class='ke-paste-"+f+"'>"+c[f]+"</a>")).appendTo(b);l.on("click",function(b){b.halt();a.hide();setTimeout(function(){e.execCommand(f)},30)});i[f]=l}(l))});return{init:function(c){c.docReady(function(){new r(c)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(j){function r(f,c){var u=f[c?"next":"prev"]();if(u&&u[0].nodeType==g.ELEMENT_NODE){for(var h=[];u.attr("_ke_bookmark")||u._4e_isEmptyInlineRemovable(q);)if(h.push(u),u=c?u.next():u.prev(),!u)return;if(f._4e_isIdentical(u,q)){for(var d=new a(c?f[0].lastChild:f[0].firstChild);h.length;)h.shift()._4e_move(f,!c,q);u._4e_moveChildren(f,!c,q);u.remove();d[0]&&d[0].nodeType==g.ELEMENT_NODE&&d._4e_mergeSiblings()}}}var q=q,m=j.Editor,g=j.DOM,s=j.UA,a=j.Node,d=m.Utils,
n={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};m.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var k=m.POSITION,t={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},o={hr:1},p=function(f){return f&&(f[0]||f)};d.injectDom({_4e_sameLevel:function(f,c){var c=p(c),a=f.parentNode;return a&&a==c.parentNode},_4e_isBlockBoundary:function(f,c){var a=j.merge(o,c);return!(!t[g.css(f,"display")]&&!a[g.nodeName(f)])},_4e_getWin:g._getWin,_4e_index:function(f,c){for(var a=f.parentNode.childNodes,h,d=-1,e=0;e<a.length;e++)if(h=a[e],!c||!(3==h.nodeType&&h.previousSibling&&3==h.previousSibling.nodeType))if(d++,h===f)return d;return-1},_4e_move:function(f,
c,a){c=p(c);a?c.insertBefore(f,c.firstChild):c.appendChild(f)},_4e_isIdentical:function(f,c){if(!c)return!1;c=p(c);if(g.nodeName(f)!=g.nodeName(c))return!1;var a=f.attributes,h=c.attributes,k=a.length,e=h.length;if(k!=e)return!1;for(var b=0;b<k;b++){var i=a[b],l=i.name;if(i.specified&&g.attr(f,l)!=g.attr(c,l))return!1}if(8>d.ieEngine)for(b=0;b<e;b++)if(i=h[b],l=i.name,i.specified&&g.attr(f,l)!=g.attr(c,l))return!1;return!0},_4e_isEmptyInlineRemovable:function(f){for(var f=f.childNodes,c=0,a=f.length;c<
a;c++){var h=f[c],d=h.nodeType;if(!(d==g.ELEMENT_NODE&&h.getAttribute("_ke_bookmark"))&&(d==g.ELEMENT_NODE&&!g._4e_isEmptyInlineRemovable(h)||d==g.TEXT_NODE&&j.trim(h.nodeValue)))return!1}return!0},_4e_moveChildren:function(f,c,a){c=p(c);if(f!=c)if(a)for(;a=f.lastChild;)c.insertBefore(f.removeChild(a),c.firstChild);else for(;a=f.firstChild;)c.appendChild(f.removeChild(a))},_4e_mergeSiblings:function(f){f=new a(f);n[f.nodeName()]&&(r(f,!0),r(f))},_4e_splitText:function(f,c){var a=f.ownerDocument;if(f.nodeType==
g.TEXT_NODE){if(s.ie&&c==f.nodeValue.length){var h=a.createTextNode("");g.insertAfter(h,f);return h}h=f.splitText(c);a.documentMode&&(a=a.createTextNode(""),g.insertAfter(a,h),g.remove(a));return h}},_4e_parents:function(f,c){var a=[];a.__IS_NODELIST=1;do a[c?"push":"unshift"](f);while(f=f.parentNode);return a},_4e_nextSourceNode:function(f,c,a,h){if(h&&!h.call)var d=p(h),h=function(b){return b!==d};var c=!c&&f.firstChild,e=f;if(!c){if(f.nodeType==g.ELEMENT_NODE&&h&&!1===h(f,!0))return null;c=f.nextSibling}for(;!c&&
(e=e.parentNode);){if(h&&!1===h(e,!0))return null;c=e.nextSibling}return!c||h&&!1===h(c)?null:a&&a!=c.nodeType?g._4e_nextSourceNode(c,!1,a,h):c},_4e_previousSourceNode:function(f,c,a,h){if(h&&!h.call)var d=p(h),h=function(b){return b!==d};var c=!c&&f.lastChild,e=f;if(!c){if(f.nodeType==g.ELEMENT_NODE&&h&&!1===h(f,!0))return null;c=f.previousSibling}for(;!c&&(e=e.parentNode);){if(h&&!1===h(e,!0))return null;c=e.previousSibling}return!c||h&&!1===h(c)?null:a&&c.nodeType!=a?g._4e_previousSourceNode(c,
!1,a,h):c},_4e_commonAncestor:function(f,c){c=p(c);if(f===c)return f;if(g.contains(c,f))return c;var a=f;do if(g.contains(a,c))return a;while(a=a.parentNode);return null},_4e_hasAttributes:9>d.ieEngine?function(f){for(var c=f.attributes,a=0;a<c.length;a++){var h=c[a];switch(h.name){case "class":if(f.getAttribute("class"))return!0;break;default:if(h.specified)return!0}}return!1}:function(f){s.gecko&&f.removeAttribute("_moz_dirty");return f.hasAttributes()},_4e_position:function(f,c){var a=p(c);if(f.compareDocumentPosition)return f.compareDocumentPosition(a);
if(f==a)return k.POSITION_IDENTICAL;if(f.nodeType==g.ELEMENT_NODE&&a.nodeType==g.ELEMENT_NODE){if(g.contains(f,a))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(g.contains(a,f))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in f)return 0>f.sourceIndex||0>a.sourceIndex?k.POSITION_DISCONNECTED:f.sourceIndex<a.sourceIndex?k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var h=g._4e_address(f),a=g._4e_address(a),d=Math.min(h.length,a.length),e=0;e<=d-1;e++)if(h[e]!=a[e])return h[e]<
a[e]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return h.length<a.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4e_address:function(a,c){for(var d=[],h=a.ownerDocument.documentElement,k=a;k&&k!=h;)d.unshift(g._4e_index(k,c)),k=k.parentNode;return d},_4e_remove:function(a,c){var d=a.parentNode;if(d){if(c)for(var h;h=a.firstChild;)d.insertBefore(a.removeChild(h),a);d.removeChild(a)}return a},_4e_trim:function(a){g._4e_ltrim(a);g._4e_rtrim(a)},_4e_ltrim:function(a){for(var c;c=
a.firstChild;){if(c.nodeType==g.TEXT_NODE){var k=d.ltrim(c.nodeValue),h=c.nodeValue.length;if(k)k.length<h&&(g._4e_splitText(c,h-k.length),a.removeChild(a.firstChild));else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){for(var c;c=a.lastChild;){if(c.type==g.TEXT_NODE){var k=d.rtrim(c.nodeValue),h=c.nodeValue.length;if(k)k.length<h&&(g._4e_splitText(c,k.length),a.removeChild(a.lastChild));else{a.removeChild(c);continue}}break}!s.ie&&!s.opera&&(c=a.lastChild)&&1==c.nodeType&&"br"==g.nodeName(c)&&
a.removeChild(c)},_4e_appendBogus:function(a){for(var c=a.lastChild;c&&c.nodeType==g.TEXT_NODE&&!j.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==g.TEXT_NODE||"br"!==g.nodeName(c))c=s.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),s.gecko&&c.setAttribute("type","_moz"),a.appendChild(c)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(!0));return c.innerHTML},
_4e_setMarker:function(f,c,d,h){var f=new a(f),k=f.data("list_marker_id")||f.data("list_marker_id",j.guid()).data("list_marker_id"),e=f.data("list_marker_names")||f.data("list_marker_names",{}).data("list_marker_names");c[k]=f;e[d]=1;return f.data(d,h)},_4e_clearMarkers:function(f,c,d){var f=new a(f),h=f.data("list_marker_names"),k=f.data("list_marker_id"),e;for(e in h)h.hasOwnProperty(e)&&f.removeData(e);f.removeData("list_marker_names");d&&(f.removeData("list_marker_id"),delete c[k])},_4e_copyAttributes:function(f,
c,d){for(var c=new a(c),h=f.attributes,d=d||{},k=0;k<h.length;k++){var e=h[k],b=e.name.toLowerCase(),i;if(!(b in d))if("checked"==b&&(i=g.attr(f,b)))c.attr(b,i);else if(e.specified||s.ie&&e.value&&"value"==b)i=g.attr(f,b),null===i&&(i=e.nodeValue),c.attr(b,i)}""!==f.style.cssText&&(c[0].style.cssText=f.style.cssText)},_4e_isEditable:function(a){var a=g.nodeName(a),c=m.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(j){function r(a){1>arguments.length||(this.range=a,this.forceBrBreak=m,this.enlargeBr=q,this.enforceRealBlocks=m,this._||(this._={}))}var q=!0,m=!1,g=j.Editor,s=j.UA,a=g.Walker,d=g.Range,n=g.RANGE,k=g.ElementPath,t=j.Node,o=j.DOM,p=/^[\r\n\t ]*$/;j.augment(r,{getNextParagraph:function(f){var c,g,h,x,e;if(!this._.lastNode){g=this.range.clone();g.shrink(n.SHRINK_ELEMENT,q);g.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var b=new a(g),i=a.bookmark(q,q);b.evaluator=i;this._.nextNode=b.next();b=new a(g);b.evaluator=i;b=b.previous();this._.lastNode=b._4e_nextSourceNode(q);this._.lastNode&&this._.lastNode[0].nodeType==o.TEXT_NODE&&!j.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(i=new d(g.document),i.moveToPosition(this._.lastNode,n.POSITION_AFTER_END),i.checkEndOfBlock()&&(i=new k(i.endContainer),this._.lastNode=(i.block||i.blockLimit)._4e_nextSourceNode(q)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new t(g.document.createTextNode("")),o.insertAfter(this._.lastNode[0],b[0]));g=null}i=this._.nextNode;b=this._.lastNode;for(this._.nextNode=null;i;){var l=m,w=i[0].nodeType!=o.ELEMENT_NODE,y=m;if(w)i[0].nodeType==o.TEXT_NODE&&p.test(i[0].nodeValue)&&(w=m);else{var v=i.nodeName();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==v)w=q;else if(!g&&!i[0].childNodes.length&&"hr"!=v){c=i;h=i.equals(b);break}g&&(g.setEndAt(i,n.POSITION_BEFORE_START),"br"!=
v&&(this._.nextNode=i));l=q}else{if(i[0].firstChild){g||(g=new d(this.range.document),g.setStartAt(i,n.POSITION_BEFORE_START));i=new t(i[0].firstChild);continue}w=q}}w&&!g&&(g=new d(this.range.document),g.setStartAt(i,n.POSITION_BEFORE_START));h=(!l||w)&&i.equals(b);if(g&&!l)for(;!i[0].nextSibling&&!h;){v=i.parent();if(v._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=q;h||v.equals(b);break}i=v;w=q;h=i.equals(b);y=q}w&&g.setEndAt(i,n.POSITION_AFTER_END);i=i._4e_nextSourceNode(y,null,b);if((h=!i)||
l&&g)break}if(!c){if(!g)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new k(g.startContainer);i=c.blockLimit;l={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&l[i.nodeName()]&&g.checkStartOfBlock()&&g.checkEndOfBlock())c=i;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new t(this.range.document.createElement(f||"p")),c[0].appendChild(g.extractContents()),c._4e_trim(),g.insertNode(c),x=e=q;else if("li"!=c.nodeName()){if(!g.checkStartOfBlock()||
!g.checkEndOfBlock())c=c.clone(m),c[0].appendChild(g.extractContents()),c._4e_trim(),e=g.splitBlock(),x=!e.wasStartOfBlock,e=!e.wasEndOfBlock,g.insertNode(c)}else h||(this._.nextNode=c.equals(b)?null:g.getBoundaryNodes().endNode._4e_nextSourceNode(q,null,b))}x&&(g=new t(c[0].previousSibling),g[0]&&g[0].nodeType==o.ELEMENT_NODE&&("br"==g.nodeName()?g._4e_remove():g[0].lastChild&&"br"==o.nodeName(g[0].lastChild)&&o._4e_remove(g[0].lastChild)));e&&(g=a.bookmark(m,q),x=new t(c[0].lastChild),x[0]&&x[0].nodeType==
o.ELEMENT_NODE&&"br"==x.nodeName()&&(s.ie||x.prev(g)||x.next(g))&&x.remove());this._.nextNode||(this._.nextNode=h||c.equals(b)?null:c._4e_nextSourceNode(q,null,b));return c}});d.prototype.createIterator=function(){return new r(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(j){function r(j){for(var k=s,t=s,o=[];j;){if(j[0].nodeType==m.ELEMENT_NODE){this.lastElement||(this.lastElement=j);var p=j.nodeName();if(!t&&(!k&&a[p]&&(k=j),d[p])){var f;if(f=!k)if(f="div"==p){a:{f=j[0].childNodes;for(var c=0,r=f.length;c<r;c++){var h=f[c];if(h.nodeType==m.ELEMENT_NODE&&g.$block[h.nodeName.toLowerCase()]){f=!0;break a}}f=!1}f=!f}f?k=j:t=j}o.push(j);if("body"==p)break}j=j.parent()}this.block=k;this.blockLimit=t;this.elements=o}var q=j.Editor,
m=j.DOM,g=q.XHTML_DTD,s=null,a={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},d={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};r.prototype={compare:function(a){var d=this.elements,a=a&&a.elements;if(!a||d.length!=a.length)return!1;for(var g=0;g<d.length;g++)if(!m.equals(d[g],a[g]))return!1;return!0},contains:function(a){for(var d=this.elements,g=0;g<d.length;g++)if(d[g].nodeName()in a)return d[g];return s},toString:function(){var a=this.elements,
d,g=[];for(d=0;d<a.length;d++)g.push(a[d].nodeName());return g.toString()}};return q.ElementPath=r},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(j){function r(n){var p;p=n.getSelection().getRanges();for(var f=p.length-1;0<f;f--)p[f].deleteContents();p=p[0];f=p.document;if(p.checkStartOfBlock()&&p.checkEndOfBlock()){var c=(new t(p.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return n.hasCommand("outdent")?(n.execCommand("save"),n.execCommand("outdent"),n.execCommand("save"),!0):!1}var m=p.splitBlock("p");if(!m)return!0;var n=m.previousBlock,c=m.nextBlock,h=
m.wasStartOfBlock,x=m.wasEndOfBlock,e;if(c)e=c.parent(),"li"==e.nodeName()&&(c._4e_breakParent(e),c._4e_move(c.next(),!0));else if(n&&(e=n.parent())&&"li"==e.nodeName())n._4e_breakParent(e),p.moveToElementEditablePosition(n.next()),n._4e_move(n.prev());if(!h&&!x){if("li"==c.nodeName()&&(e=c.first(k.invisible(!0)))&&j.inArray(e.nodeName(),["ul","ol"]))(g.ie?new d(f.createTextNode("\u00a0")):new d(f.createElement("br"))).insertBefore(e);c&&p.moveToElementEditablePosition(c)}else{var b;if(n){if("li"==n.nodeName()||
!s.test(n.nodeName()))b=n.clone()}else c&&(b=c.clone());b||(b=new d("<p>",null,f));if(e=m.elementPath)for(var m=0,i=e.elements.length;m<i;m++){var l=e.elements[m];if(l.equals(e.block)||l.equals(e.blockLimit))break;a.$removeEmpty[l.nodeName()]&&(l=l.clone(),b._4e_moveChildren(l),b.append(l))}g.ie||b._4e_appendBogus();p.insertNode(b);if(g.ie&&h&&(!x||!n[0].childNodes.length))p.moveToElementEditablePosition(x?n:b),p.select();p.moveToElementEditablePosition(h&&!x?c:b)}g.ie||(c?(b=new d(f.createElement("span")),
b.html("&nbsp;"),p.insertNode(b),b.scrollIntoView(void 0,!1),p.deleteContents()):b.scrollIntoView(void 0,!1));p.select();return!0}function q(a){var d=a.get("document")[0];n.on(d,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&f.preventDefault()}})}var m=j.Editor,g=j.UA,s=/^h[1-6]$/,a=m.XHTML_DTD,d=j.Node,n=j.Event,k=m.Walker,t=m.ElementPath;return{init:function(a){a.addCommand("enterBlock",
{exec:r});a.docReady(function(){q(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(j){function r(){var a=this;a.__iframeFocus=k;n=a;d&&clearTimeout(d);d=setTimeout(function(){a.fire("focus")},100)}function q(){var a=this;a.__iframeFocus=t;n=o;d&&clearTimeout(d);d=setTimeout(function(){a.fire("blur")},100)}var m=j.Editor,g=j.DOM,s=j.Event,a={},d,n,j={refreshAll:function(){for(var d in a)if(a.hasOwnProperty(d)){var f=a[d].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return n},getInstance:function(d){return a[d]},
add:function(a){var f=g._4e_getWin(a.get("document")[0]);s.on(f,"focus",r,a);s.on(f,"blur",q,a)},register:function(d){a[d._UUID]=d},remove:function(d){delete a[d._UUID];var f=g._4e_getWin(d.get("document")[0]);s.remove(f,"focus",r,d);s.remove(f,"blur",q,d)}},k=!0,t=!1,o=null;j.refreshAll=j.refreshAll;m.focusManager=j;m.getInstances=function(){return a};return j},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(j){return{init:function(r){function q(a){return a.replace(f,function(a,e,b){return"<"+e+b.replace(c,function(e,a){return-1==b.indexOf("_ke_saved_"+a)?" _ke_saved_"+e+" "+e:e})+">"})}function m(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+u+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function g(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,e){return decodeURIComponent(e)})}
var s=s,a=j.Editor,d=j.Node,n=j.UA,k=j.require("htmlparser"),t=new k.Filter,o=new k.Filter,p=new k.Filter;(function(){var a=function(b,e){return function(a,c){var d=[];(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,l,f){l=l.toLowerCase();"font-family"==l&&(f=f.replace(/["']/g,""));for(var K,h,g,k=0;k<b.length;k++)if(b[k]&&(a=b[k][0],K=b[k][1],h=b[k][2],g=b[k][3],l.match(a)&&(!K||f.match(K)))){l=g||l;e&&(h=h||f);"function"==typeof h&&(h=h(f,c,l));h&&h.push&&
(l=h[0],h=h[1]);"string"==typeof h&&d.push([l,h]);return}!e&&d.push([l,f])});for(var f=0;f<d.length;f++)d[f]=d[f].join(":");return d.length?d.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],s),c={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(b){b.filterChildren()},tags:{p:function(b){b.filterChildren()},$:function(b){var e=b.nodeName||"";if(-1!=e.indexOf(":")&&
!/^ke/.test(e))if("v:imagedata"==e){if(e=b.getAttribute("o:href"))b.setAttribute("src",e),b.removeAttribute("o:href");if(e=b.getAttribute("o:title"))b.setAttribute("title",e),b.removeAttribute("o:title");b.setTagName("img")}else b.setTagName("")}},attributes:{"class":function(b){return!b||/(^|\s+)Mso/.test(b)?!1:b},style:function(b){b=a(b);return!b?!1:b}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(b){if(b.attributes.length)for(var e=
["name","href","src"],a,c=0;c<e.length;c++)a="_ke_saved_"+e[c],b.getAttribute(a)&&b.removeAttribute(e[c]);return b},embed:function(b){var e=b.parentNode;if(e&&"object"==e.nodeName){var a=e.getAttribute("width"),e=e.getAttribute("height");a&&b.setAttribute("width",a);e&&b.setAttribute("width",e)}},a:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1},span:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1}},attributes:{style:function(b){if(!j.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(b){return b.substr(0,u.length)==u?(b="{C}"==b.substr(u.length,3)?b.substr(u.length+3):b.substr(u.length),new k.CData(decodeURIComponent(b))):b}};n.ie&&(e.attributes.style=function(b){return b.replace(/(^|;)([^:]+)/g,function(b){return b.toLowerCase()})});t.addRules(e);o.addRules(c);p.addRules(c)})();(function(){function c(b){for(var b=b.childNodes,e=b.length,a=b[e-1];a&&3==a.nodeType&&!j.trim(a.nodeValue);)a=b[--e];return a}
function f(b,e){var a=c(b);a&&((e||!n.ie)&&1==a.nodeType&&"br"==a.nodeName?b.removeChild(a):3==a.nodeType&&l.test(a.nodeValue)&&b.removeChild(a))}function e(b){var e=c(b);return!e||1==e.nodeType&&"br"==e.nodeName||"form"==b.nodeName&&"input"==e.nodeName}function b(b){f(b,!0);e(b)&&(n.ie?b.appendChild(new k.Text("\u00a0")):(b.appendChild(new k.Text("&nbsp;")),b.appendChild(new k.Tag("br"))))}function i(b){f(b,!1);e(b)&&b.appendChild(new k.Text("\u00a0"))}var l=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,d=a.XHTML_DTD,g=a.Utils.mix({},
d.$block,d.$listItem,d.$tableContent),v;for(v in g)g.hasOwnProperty(v)&&("br"in d[v]||delete g[v]);delete g.td;delete g.pre;var d={tags:{}},m={tags:{}};for(v in g)g.hasOwnProperty(v)&&(d.tags[v]=b,m.tags[v]=i);o.addRules(d);t.addRules(m);p.addRules(d)})();(function(){t.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var f=/<(a|area|img|input)\b([^>]*)>/gi,c=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,u="{ke_protected}";r.htmlDataProcessor={wordFilter:p,
dataFilter:o,htmlFilter:t,toHtml:function(a){var c=new k.BeautifyWriter;(new k.Parser(a)).parse().writeHtml(c,t);return c.getHtml()},toDataFormat:function(a,c,e){e=e||o;n.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=q(a);c=new d("<div>");c.html("a"+a);a=c.html().substr(1);a=g(a);c=new k.BeautifyWriter;(new k.Parser(a)).parse().writeHtml(c,e);a=c.getHtml();return a=m(a)},toServer:function(a){var c=new k.MinifyWriter;(new k.Parser(a)).parse().writeHtml(c,
t);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(j,r,q,m,g){function s(a){var e=a.nodeType!=h.TEXT_NODE&&h.nodeName(a)in b.$removeEmpty,c=a.nodeType==h.TEXT_NODE&&!j.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return e||c||a}function a(b){return!y(b)&&!v(b)}function d(b){var a=p;return function(c){if(v(c))return o;if(c.nodeType==h.TEXT_NODE){if(j.trim(c.nodeValue).length)return p}else if(c.nodeType==h.ELEMENT_NODE&&(c=h.nodeName(c),!H[c]))if(!b&&!e.ie&&"br"==c&&!a)a=o;else return p;return o}}
function n(b,a){var e=b.startContainer,c=b.endContainer,l=b.startOffset,d=b.endOffset,f,g=p,k=p,w=void 0,j=b.document,n;if(b.collapsed)return w;0<a&&(w=j.createDocumentFragment());b.optimizeBookmark();c[0].nodeType==h.TEXT_NODE?(k=o,c=c._4e_splitText(d)):0<c[0].childNodes.length&&(d>=c[0].childNodes.length?(c=new i(c[0].appendChild(j.createTextNode(""))),n=o):c=new i(c[0].childNodes[d]));e[0].nodeType==h.TEXT_NODE?(g=o,e._4e_splitText(l)):l?l>=e[0].childNodes.length?(e=new i(e[0].appendChild(j.createTextNode(""))),
f=o):e=new i(e[0].childNodes[l].previousSibling):(f=new i(j.createTextNode("")),e.prepend(f),e=f,f=o);var y=e._4e_parents(),J=c._4e_parents();y.each(function(b,a){y[a]=b});J.each(function(b,a){J[a]=b});for(var D,L,j=0;j<y.length&&!(D=y[j],L=J[j],!D.equals(L));j++);for(var l=w,z,v,m=j;m<y.length;m++){z=y[m];d=0<a&&!z.equals(e)?l.appendChild(z.clone()[0]):null;z=z[0].nextSibling;v=J[m];for(var r=c[0],A=v&&v[0];z&&!(A==z||r==z);)v=z.nextSibling,2==a?l.appendChild(z.cloneNode(o)):(h._4e_remove(z),1==
a&&l.appendChild(z)),z=v;d&&(l=d)}for(l=w;j<J.length;j++){z=J[j];d=0<a&&!z.equals(c)?l.appendChild(z.clone()[0]):null;if(!y[j]||!z._4e_sameLevel(y[j]))for(z=z[0].previousSibling;z;)v=z.previousSibling,2==a?l.insertBefore(z.cloneNode(o),l.firstChild):(h._4e_remove(z),1==a&&l.insertBefore(z,l.firstChild)),z=v;d&&(l=d)}if(2==a){if(g&&(D=e[0],D.nodeType==h.TEXT_NODE&&D.nextSibling&&D.nextSibling.nodeType==h.TEXT_NODE&&(D.data+=D.nextSibling.data,D.parentNode.removeChild(D.nextSibling))),k)k=c[0],k.nodeType==
h.TEXT_NODE&&k.previousSibling&&k.previousSibling.nodeType==h.TEXT_NODE&&(k.previousSibling.data+=k.data,k.parentNode.removeChild(k))}else{if(D&&L&&(!e._4e_sameLevel(D)||!c._4e_sameLevel(L)))k=D._4e_index(),f&&D._4e_sameLevel(e)&&k--,b.setStart(D.parent(),k+1);b.collapse(o)}f&&e.remove();n&&c.remove();return w}function k(b){b.collapsed=b.startContainer&&b.endContainer&&b.startContainer[0]==b.endContainer[0]&&b.startOffset==b.endOffset}function t(b){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=f;this.collapsed=o;this.document=b}r.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,p=!1,f=null,c=r.RANGE,u=r.POSITION,h=j.DOM,x=q.getByAddress,e=j.UA,b=r.XHTML_DTD,i=j.Node,l=i.all,w={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},y=new m.whitespaces,v=new m.bookmark,A=m.whitespaces(o),
F=m.bookmark(!1,!0),H={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};j.augment(t,{toString:function(){var b=[],a=this.startContainer[0],e=this.endContainer[0];b.push((a.id||a.nodeName)+":"+this.startOffset);b.push((e.id||e.nodeName)+":"+this.endOffset);return b.join("<br/>")},optimize:function(){var b=this.startContainer,a=this.startOffset;b[0].nodeType!=h.ELEMENT_NODE&&(a?a>=
b[0].nodeValue.length&&this.setStartAfter(b):this.setStartBefore(b));b=this.endContainer;a=this.endOffset;b[0].nodeType!=h.ELEMENT_NODE&&(a?a>=b[0].nodeValue.length&&this.setEndAfter(b):this.setEndBefore(b))},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=
this.startContainer,a=this.endContainer;b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setStartBefore(b);a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setEndAfter(a)},setStart:function(b,a){b[0].nodeType==h.ELEMENT_NODE&&w[b.nodeName()]&&(b=b.parent(),a=b._4e_index());this.startContainer=b;this.startOffset=a;this.endContainer||(this.endContainer=b,this.endOffset=a);k(this)},setEnd:function(b,a){b[0].nodeType==h.ELEMENT_NODE&&w[b.nodeName()]&&(b=b.parent(),a=b._4e_index()+1);this.endContainer=
b;this.endOffset=a;this.startContainer||(this.startContainer=b,this.startOffset=a);k(this)},setStartAt:function(b,a){switch(a){case c.POSITION_AFTER_START:this.setStart(b,0);break;case c.POSITION_BEFORE_END:b[0].nodeType==h.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(b);break;case c.POSITION_AFTER_END:this.setStartAfter(b)}k(this)},setEndAt:function(b,a){switch(a){case c.POSITION_AFTER_START:this.setEnd(b,
0);break;case c.POSITION_BEFORE_END:b[0].nodeType==h.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(b);break;case c.POSITION_AFTER_END:this.setEndAfter(b)}k(this)},cloneContents:function(){return n(this,2)},deleteContents:function(){return n(this,0)},extractContents:function(){return n(this,1)},collapse:function(b){b?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=
this.endContainer,this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var b=new t(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=h.ELEMENT_NODE||b.endContainer[0].nodeType!=h.ELEMENT_NODE)return f;var a=new m(b);a.evaluator=function(b){return A(b)&&F(b)};b=a.next();
a.reset();a=a.previous();return b&&b.equals(a)?b:f},shrink:function(b,a){if(!this.collapsed){var b=b||c.SHRINK_TEXT,e=this.clone(),i=this.startContainer,l=this.endContainer,d=this.startOffset,f=this.endOffset,g=o,k,w,j=o;i&&i[0].nodeType==h.TEXT_NODE&&(d?d>=i[0].nodeValue.length?e.setStartAfter(i):(e.setStartBefore(i),g=p):e.setStartBefore(i));l&&l[0].nodeType==h.TEXT_NODE&&(f?f>=l[0].nodeValue.length?e.setEndAfter(l):(e.setEndAfter(l),j=p):e.setEndBefore(l));if(g||j)w=new m(e),w.evaluator=function(a){return a.nodeType==
(b==c.SHRINK_ELEMENT?h.ELEMENT_NODE:h.TEXT_NODE)},w.guard=function(a,e){a=a[0]||a;if(b==c.SHRINK_ELEMENT&&a.nodeType==h.TEXT_NODE||e&&a==k)return p;!e&&a.nodeType==h.ELEMENT_NODE&&(k=a);return o};g&&(e=w[b==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,a?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);j&&(w.reset(),(w=w[b==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(w,a?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return g||j}},createBookmark2:function(b){var a=this.startContainer,
e=this.endContainer,c=this.startOffset,l=this.endOffset,d,g;if(!a||!e)return{start:0,end:0};if(b){if(a[0].nodeType==h.ELEMENT_NODE&&(d=new i(a[0].childNodes[c]))&&d[0]&&d[0].nodeType==h.TEXT_NODE&&0<c&&d[0].previousSibling.nodeType==h.TEXT_NODE)a=d,c=0;for(;a[0].nodeType==h.TEXT_NODE&&(g=a.prev())&&g[0].nodeType==h.TEXT_NODE;)a=g,c+=g[0].nodeValue.length;if(!this.collapsed){if(e[0].nodeType==h.ELEMENT_NODE&&(d=new i(e[0].childNodes[l]))&&d[0]&&d[0].nodeType==h.TEXT_NODE&&0<l&&d[0].previousSibling.nodeType==
h.TEXT_NODE)e=d,l=0;for(;e[0].nodeType==h.TEXT_NODE&&(g=e.prev())&&g[0].nodeType==h.TEXT_NODE;)e=g,l+=g[0].nodeValue.length}}return{start:a._4e_address(b),end:this.collapsed?f:e._4e_address(b),startOffset:c,endOffset:l,normalized:b,is2:o}},createBookmark:function(b){var a,e,l,d,g=this.collapsed;a=new i("<span>",f,this.document);a.attr("_ke_bookmark",1);a.css("display","none");a.html("&nbsp;");b&&(l=j.guid("ke_bm_"),a.attr("id",l+"S"));g||(e=a.clone(),e.html("&nbsp;"),b&&e.attr("id",l+"E"),d=this.clone(),
d.collapse(),d.insertNode(e));d=this.clone();d.collapse(o);d.insertNode(a);e?(this.setStartAfter(a),this.setEndBefore(e)):this.moveToPosition(a,c.POSITION_AFTER_END);return{startNode:b?l+"S":a,endNode:b?l+"E":e,serializable:b,collapsed:g}},moveToPosition:function(b,a){this.setStartAt(b,a);this.collapse(o)},trim:function(b,a){var e=this.startContainer,c=this.startOffset,i=this.collapsed;if((!b||i)&&e[0]&&e[0].nodeType==h.TEXT_NODE){if(c)if(c>=e[0].nodeValue.length)c=e._4e_index()+1,e=e.parent();else{var l=
e._4e_splitText(c),c=e._4e_index()+1,e=e.parent();h.equals(this.startContainer,this.endContainer)?this.setEnd(l,this.endOffset-this.startOffset):h.equals(e,this.endContainer)&&(this.endOffset+=1)}else c=e._4e_index(),e=e.parent();this.setStart(e,c);if(i){this.collapse(o);return}}e=this.endContainer;c=this.endOffset;!a&&!i&&e[0]&&e[0].nodeType==h.TEXT_NODE&&(c?(c>=e[0].nodeValue.length||e._4e_splitText(c),c=e._4e_index()+1):c=e._4e_index(),e=e.parent(),this.setEnd(e,c))},insertNode:function(b){this.optimizeBookmark();
this.trim(p,o);var a=this.startContainer;a[0].insertBefore(b[0],a[0].childNodes[this.startOffset]||null);a[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){var a=this.document;if(b.is2){var e=x(a,b.start,b.normalized),c=b.startOffset,a=b.end&&x(a,b.end,b.normalized),b=b.endOffset;this.setStart(e,c);a?this.setEnd(a,b):this.collapse(o)}else e=(c=b.serializable)?j.one("#"+b.startNode,a):b.startNode,b=c?j.one("#"+b.endNode,a):b.endNode,this.setStartBefore(e),
e._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(o)},getCommonAncestor:function(b,a){var e=this.startContainer,c=this.endContainer,e=e[0]==c[0]?b&&e[0].nodeType==h.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new i(e[0].childNodes[this.startOffset]):e:e._4e_commonAncestor(c);return a&&e[0].nodeType==h.TEXT_NODE?e.parent():e},enlarge:function(){function b(a,e,c,i){var d=a[e?"startContainer":"endContainer"],f,g=e?0:1,k=0,w=e?"previousSibling":"nextSibling";f=a[e?"startOffset":
"endOffset"];if(d[0].nodeType==h.TEXT_NODE){if(e){if(f)return}else if(f<d[0].nodeValue.length)return;f=d[0][w];d=d[0].parentNode}else f=d[0].childNodes[f+(e?-1:1)]||null,d=d[0];for(;d;){for(;f;)if(y(f)||v(f))f=f[w];else break;if(f){if(!k)a[e?"setStartAfter":"setEndBefore"](l(f));break}d=l(d);if("body"==d.nodeName())break;if(k||d.equals(i))c[g]=d,k=1;else a[e?"setStartBefore":"setEndAfter"](d);f=d[0][w];d=d[0].parentNode}}return function(a){switch(a){case c.ENLARGE_ELEMENT:if(this.collapsed)break;
var a=this.getCommonAncestor(),e=[];b(this,1,e,a);b(this,0,e,a);e[0]&&e[1]&&(a=e[0].contains(e[1])?e[1]:e[0],this.setStartBefore(a),this.setEndAfter(a));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var d=new t(this.document),e=new i(this.document.body);d.setStartAt(e,c.POSITION_AFTER_START);d.setEnd(this.startContainer,this.startOffset);var d=new m(d),g,k,w=m.blockBoundary(a==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:f),j=function(b){var a=w(b);a||(g=l(b));return a},y=function(b){var a=
j(b);!a&&"br"==h.nodeName(b)&&(k=l(b));return a};d.guard=j;d=d.lastBackward();g=g||e;this.setStartAt(g,"br"!=g.nodeName()&&(!d&&this.checkStartOfBlock()||d&&g.contains(d))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);d=this.clone();d.collapse();d.setEndAt(e,c.POSITION_BEFORE_END);d=new m(d);d.guard=a==c.ENLARGE_LIST_ITEM_CONTENTS?y:j;g=f;d=d.lastForward();g=g||e;this.setEndAt(g,!d&&this.checkEndOfBlock()||d&&g.contains(d)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);k&&this.setEndAfter(k)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,a=this.startOffset;if(a&&b[0].nodeType==h.TEXT_NODE&&j.trim(b[0].nodeValue.substring(0,a)).length)return p;this.trim();b=new g(this.startContainer);a=this.clone();a.collapse(o);a.setStartAt(b.block||b.blockLimit,c.POSITION_AFTER_START);b=new m(a);b.evaluator=d(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,a=this.endOffset;if(b[0].nodeType==h.TEXT_NODE&&j.trim(b[0].nodeValue.substring(a)).length)return p;this.trim();
b=new g(this.endContainer);a=this.clone();a.collapse(p);a.setEndAt(b.block||b.blockLimit,c.POSITION_BEFORE_END);b=new m(a);b.evaluator=d(p);return b.checkForward()},checkBoundaryOfElement:function(b,a){var e=this.clone();e[a==c.START?"setStartAt":"setEndAt"](b,a==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);e=new m(e);e.evaluator=s;return e[a==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,a=this.endContainer,e=this.startOffset,c=this.endOffset,
d;if(b[0].nodeType==h.ELEMENT_NODE)if(d=b[0].childNodes.length,d>e)b=l(b[0].childNodes[e]);else if(0==d)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=l(b);b=b._4e_nextSourceNode()||b}if(a[0].nodeType==h.ELEMENT_NODE)if(d=a[0].childNodes.length,d>c)a=l(a[0].childNodes[c])._4e_previousSourceNode(o);else if(0==d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=l(a)}b._4e_position(a)&u.POSITION_FOLLOWING&&(b=a);return{startNode:b,endNode:a}},fixBlock:function(b,
a){var d=this.createBookmark(),i=l(this.document.createElement(a));this.collapse(b);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);i[0].appendChild(this.extractContents());i._4e_trim();e.ie||i._4e_appendBogus();this.insertNode(i);this.moveToBookmark(d);return i},splitBlock:function(b){var a=new g(this.startContainer),d=new g(this.endContainer),i=a.block,l=d.block,h=f;if(!a.blockLimit.equals(d.blockLimit))return f;"br"!=b&&(i||(i=this.fixBlock(o,b),l=(new g(this.endContainer)).block),l||(l=this.fixBlock(p,
b)));b=i&&this.checkStartOfBlock();a=l&&this.checkEndOfBlock();this.deleteContents();i&&i[0]==l[0]&&(a?(h=new g(this.startContainer),this.moveToPosition(l,c.POSITION_AFTER_END),l=f):b?(h=new g(this.startContainer),this.moveToPosition(i,c.POSITION_BEFORE_START),i=f):(l=this.splitElement(i),!e.ie&&!j.inArray(i.nodeName(),["ul","ol"])&&i._4e_appendBogus()));return{previousBlock:i,nextBlock:l,wasStartOfBlock:b,wasEndOfBlock:a,elementPath:h}},splitElement:function(b){if(!this.collapsed)return f;this.setEndAt(b,
c.POSITION_BEFORE_END);var a=this.extractContents(),e=b.clone(p);e[0].appendChild(a);e.insertAfter(b);this.moveToPosition(b,c.POSITION_AFTER_END);return e},moveToElementEditablePosition:function(b,e){for(var i=0;b;){if(b[0].nodeType==h.TEXT_NODE){this.moveToPosition(b,e?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);i=1;break}b[0].nodeType==h.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,e?c.POSITION_BEFORE_END:c.POSITION_AFTER_START),i=1);var d=b,l=i,f=void 0;d[0].nodeType==h.ELEMENT_NODE&&
d._4e_isEditable()&&(f=d[e?"last":"first"](a));!l&&!f&&(f=d[e?"prev":"next"](a));b=f}return!!i},selectNodeContents:function(b){var a=b[0];this.setStart(b,0);this.setEnd(b,a.nodeType==h.TEXT_NODE?a.nodeValue.length:a.childNodes.length)}});q.injectDom({_4e_breakParent:function(b,a){var a=l(a),b=l(b),e,c=new r.Range(b[0].ownerDocument);c.setStartAfter(b);c.setEndAfter(a);e=c.extractContents();c.insertNode(b.remove());b.after(e)}});r.Range=t},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(j){function r(a){this.document=a;this._={cache:{}};if(o){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=g}}function q(a){a=new r(a);return!a||a.isInvalid?s:a}var m=j.Editor;m.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var g=!0,s=null,a=j.UA,d=j.DOM,n=j.Node,k=m.SELECTION,t=m.RANGE,o=a.ie,p=m.Walker,f=m.Range,c={img:1,hr:1,li:1,table:1,
tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};j.augment(r,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=d._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var a=this._.cache;if(a.type)return a.type;var b=k.SELECTION_TEXT,i=this.getNative();if(i){if(1==i.rangeCount){var i=i.getRangeAt(0),l=i.startContainer;
l==i.endContainer&&l.nodeType==d.ELEMENT_NODE&&1==Number(i.endOffset-i.startOffset)&&c[l.childNodes[i.startOffset].nodeName.toLowerCase()]&&(b=k.SELECTION_ELEMENT)}}else b=k.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=k.SELECTION_NONE;try{var c=this.getNative(),d=c.type;"Text"==d&&(b=k.SELECTION_TEXT);"Control"==d&&(b=k.SELECTION_ELEMENT);c.createRange().parentElement&&(b=k.SELECTION_TEXT)}catch(f){}return a.type=b},getRanges:o?function(){var a=function(b,
a){b=b.duplicate();b.collapse(a);for(var e=b.parentElement(),c=e.childNodes,f,g=0;g<c.length;g++){var h=c[g];if(h.nodeType==d.ELEMENT_NODE){f=b.duplicate();f.moveToElementText(h);var h=f.compareEndPoints("StartToStart",b),k=f.compareEndPoints("EndToStart",b);f.collapse();if(0<h)break;else{if(!h||1==k&&-1==h)return{container:e,offset:g};if(!k)return{container:e,offset:g+1}}f=s}}f||(f=b.duplicate(),f.moveToElementText(e),f.collapse(!1));f.setEndPoint("StartToStart",b);f=(""+f.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<f;)f-=c[--g].nodeValue.length}catch(j){f=0}return 0===f?{container:e,offset:g}:{container:c[g],offset:-f}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var d=this.getNative(),b=d&&d.createRange(),h=this.getType();if(!d)return[];if(h==k.SELECTION_TEXT)return d=new f(this.document),h=a(b,g),d.setStart(new n(h.container),h.offset),h=a(b),d.setEnd(new n(h.container),h.offset),c.ranges=[d];if(h==k.SELECTION_ELEMENT){c=c.ranges=[];for(h=0;h<b.length;h++){for(var j=
b.item(h),v=j.parentNode,m=0,d=new f(this.document);m<v.childNodes.length&&v.childNodes[m]!=j;m++);d.setStart(new n(v),m);d.setEnd(new n(v),m+1);c.push(d)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var g=c.getRangeAt(d),h=new f(this.document);h.setStart(new n(g.startContainer),g.startOffset);h.setEnd(new n(g.endContainer),g.endOffset);a.push(h)}return b.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();case k.SELECTION_TEXT:var f=this.getRanges()[0];if(f&&!f.collapsed){for(f.optimize();g;)if(b=f.startContainer,f.startOffset==(b[0].nodeType===d.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())f.setStartAfter(b);else break;b=f.startContainer;if(b[0].nodeType!=d.ELEMENT_NODE)return b.parent();b=new n(b[0].childNodes[f.startOffset]);
if(!b[0]||b[0].nodeType!=d.ELEMENT_NODE)return f.startContainer;for(f=b[0].firstChild;f&&f.nodeType==d.ELEMENT_NODE;)b=new n(f),f=f.firstChild;return b}if(o)f=c.createRange(),f.collapse(g),b=new n(f.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=d.ELEMENT_NODE)b=b.parentNode;b&&(b=new n(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;o&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];
for(var i,f,g=2;g&&(!(i=a.getEnclosedNode())||!(i[0].nodeType==d.ELEMENT_NODE&&c[i.nodeName()]&&(f=i)));g--)a.shrink(t.SHRINK_ELEMENT);a=f}return b.selectedElement=new n(a)},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(o)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(d){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);
this.reset()},selectRanges:function(e){if(o){if(1<e.length){var b=e[e.length-1];e[0].setEnd(b.endContainer,b.endOffset);e.length=1}e[0]&&e[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<e.length;c++){var f=e[c],g=this.document.createRange(),h=f.startContainer;if(f.collapsed&&(a.gecko&&1.09>a.gecko||a.opera||a.webkit)&&h[0].nodeType==d.ELEMENT_NODE&&!h[0].childNodes.length)h[0].appendChild(this.document.createTextNode(a.webkit?"\u200b":"")),f.startOffset++,f.endOffset++;
g.setStart(h[0],f.startOffset);g.setEnd(f.endContainer[0],f.endOffset);b.addRange(g)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],f=this.document,h,b=b||this.getRanges(),k=b.length,n=0;n<k;n++){c.push(h=b[n].createBookmark(a,g));var m=(a=h.serializable)?j.one("#"+h.startNode,f):h.startNode;h=a?j.one("#"+h.endNode,f):h.endNode;for(var p=n+1;p<k;p++){var o=b[p],r=o.startContainer,
s=o.endContainer;d.equals(r,m.parent())&&o.startOffset++;d.equals(r,h.parent())&&o.startOffset++;d.equals(s,m.parent())&&o.endOffset++;d.equals(s,h.parent())&&o.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var d=new f(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var u={table:1,tbody:1,tr:1},h=p.whitespaces(g),x=/\ufeff|\u00a0/;f.prototype.select=f.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==d.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(g),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=q(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,c,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==d.ELEMENT_NODE){(new r(this.document)).selectElement(new n(k));return}}(this.startContainer[0].nodeType==d.ELEMENT_NODE&&
this.startContainer.nodeName()in u||this.endContainer[0].nodeType==d.ELEMENT_NODE&&this.endContainer.nodeName()in u)&&this.shrink(t.SHRINK_ELEMENT,g);var j=this.createBookmark(),k=j.startNode,m;b||(m=j.endNode);j=this.document.body.createTextRange();j.moveToElementText(k[0]);j.moveStart("character",1);if(m)a=this.document.body.createTextRange(),a.moveToElementText(m[0]),j.setEndPoint("EndToEnd",a),j.moveEnd("character",-1);else{for(c=k[0].nextSibling;c&&!h(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(x))&&(a||!k[0].previousSibling||k[0].previousSibling&&"br"==d.nodeName(k[0].previousSibling));f=new n(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(k);c&&d.insertBefore(this.document.createTextNode("\ufeff"),k[0]||k)}this.setStartBefore(k);k._4e_remove();if(b){if(c?(j.moveStart("character",-1),j.select(),this.document.selection.clear()):j.select(),f)this.moveToPosition(f,t.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(m),m._4e_remove(),j.select()};
r.getSelection=q;return m.Selection=r},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(j,r){function q(a){function d(b,a){var e=i.body.createTextRange();try{e.moveToPoint(b,a)}catch(c){e=n}return e}function f(){var b=i.selection.createRange();l&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&l.select();t.remove(i,"mouseup",f);t.remove(i,"mousemove",g);l=e=0}function g(b){if(b.button){if(b=d(b.pageX,b.pageY))0<b.compareEndPoints("StartToStart",l)?b.setEndPoint("StartToStart",l):b.setEndPoint("EndToEnd",l),b.select()}else f()}var e,
b=a.get("iframe")[0].contentWindow,i=a.get("document")[0],l;t.on(i,"mousedown contextmenu",function(a){var c=i.documentElement;if(a.target===c&&(e&&f(),!(c.scrollHeight>c.clientHeight)&&(e=1,l=d(a.pageX,a.pageY))))t.on(i,"mouseup",f),t.on(i,"mousemove",g),b.focus(),l.select()})}function m(c){function g(e){if(i){var d=c.getSelection(),l=d&&d.getType(),k=d&&h.selection;if(e&&k&&l==f.SELECTION_NONE&&!h.queryCommandEnabled("InsertImage"))setTimeout(function(){g(a)},50);else{var j;if(!k||!k.type||!("Control"!=
k.type&&(j=k.createRange())&&(j=j.parentElement())&&(j=j.nodeName)&&j.toLowerCase()in{input:1,textarea:1}))b=k&&d.getRanges()[0],c._monitor()}}}var h=c.get("document")[0],k=new p(h.body),e=new p(h.documentElement);if(8>r.Utils.ieEngine)e.on("click",function(b){"html"===(new p(b.target)).nodeName()&&c.getSelection().getNative().createRange().select()});var b,i,l=a;e.on("mousedown",function(){l=d});e.on("mouseup",function(){l=a});k.on("focusin",function(a){if("body"==(new p(a.target)).nodeName()&&b){try{l&&
b.select()}catch(e){}b=n}});k.on("focus",function(){i=a;g()});k.on("beforedeactivate",function(b){b.relatedTarget||(i=d,l=a)});k.on("mousedown",function(){i=d});k.on("mouseup",function(){i=a;setTimeout(function(){g(a)},0)});k.on("keydown",function(){i=d});k.on("keyup",function(){i=a;setTimeout(function(){g()},0)})}function g(a){var d=a.get("document")[0];t.on(d,"mouseup keyup",function(){a._monitor()})}function s(c){function f(b){var a=r.XHTML_DTD;return b._4e_isBlockBoundary()&&a.$empty[b.nodeName()]}
function g(a){return b(a)&&i(a)}var j=c.get("document")[0],e=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=r.Walker.whitespaces(a),i=r.Walker.bookmark(d,a),l=function(a){return b(a)&&8!=a.nodeType};c.on("selectionChange",function(b){var i=b.path,n=new p(c.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],m=i.blockLimit;if(k.gecko){var s=i.block||i.blockLimit,q=s&&s.last(g);s&&s._4e_isBlockBoundary()&&
(!q||!(1==q[0].nodeType&&q._4e_isBlockBoundary()))&&"pre"!=s.nodeName()&&!s._4e_getBogus()&&s._4e_appendBogus()}if(b&&b.collapsed&&!i.block){if("body"==m.nodeName()){if((i=b.fixBlock(a,"p"))&&i[0]!=n[0].lastChild&&i._4e_outerHtml().match(e))if((m=i.next(l))&&m[0].nodeType==o.ELEMENT_NODE&&!f[m])b.moveToElementEditablePosition(m),i._4e_remove();else if((m=i.prev(l))&&m[0].nodeType==o.ELEMENT_NODE&&!f[m])b.moveToElementEditablePosition(m,m._4e_outerHtml().match(e)?d:a),i._4e_remove();b.select();c.notifySelectionChange()}i=
new r.Range(j);i.moveToElementEditablePosition(n,a);"body"!==(new r.ElementPath(i.startContainer)).blockLimit.nodeName()&&(n=(new p(j.createElement("p"))).appendTo(n),k.ie||n._4e_appendBogus())}})}var a=!0,d=!1,n=null,k=j.UA,t=j.Event,o=j.DOM,p=j.Node,f=r.SELECTION;return{init:function(a){a.docReady(function(){k.ie?(q(a),m(a)):g(a)});s(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(j){function r(b){return!A.attr(b,"_ke_bookmark")}function q(b,a){for(var e in b)b.hasOwnProperty(e)&&(j.isString(b[e])?b[e]=b[e].replace(Q,function(b,e){return a[e]}):q(b[e],a))}function m(b,a){a&&(b=j.clone(b),q(b,a));var e=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#"==e||M[e]?F.STYLE_BLOCK:N[e]?F.STYLE_OBJECT:F.STYLE_INLINE;this._={definition:b}}function g(b,a){var e=a?this.removeFromRange:this.applyToRange;b.body.focus();
for(var c=new K(b),d=c.getRanges(),f=0;f<d.length;f++)e.call(this,d[f]);c.selectRanges(d)}function s(b,a,e){var c=b.element;"*"==c&&(c="span");a=new E(a.createElement(c));e&&e._4e_copyAttributes(a);e=b._.definition;b=e.attributes;e=m.getStyleText(e);if(b)for(var d in b)b.hasOwnProperty(d)&&a.attr(d,b[d]);e&&(a[0].style.cssText=e);return a}function a(b){var a=b.createBookmark(l),e=b.createIterator();e.enforceRealBlocks=l;e.enlargeBr=l;for(var c,f=b.document;c=e.getNextParagraph();){var i=s(this,f,
c),g=i,i="pre"==g.nodeName,h="pre"==c.nodeName,j=!i&&h;i&&!h?(h=c,j=h.html(),j=d(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),C.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(g[0]),g[0].outerHTML="<pre>"+j+"</pre>",g=new E(h.firstChild),g._4e_remove()):g.html(j)):j?g=k(n(c),g):c._4e_moveChildren(g);c[0].parentNode.replaceChild(g[0],c[0]);if(i&&(c=g,i=void 0,(i=c._4e_previousSourceNode(l,
A.ELEMENT_NODE))&&"pre"==i.nodeName()))g=d(i.html(),/\n$/,"")+"\n\n"+d(c.html(),/^\n/,""),C.ie?c[0].outerHTML="<pre>"+g+"</pre>":c.html(g),i._4e_remove()}b.moveToBookmark(a)}function d(b,a,e){var c="",d="",b=b.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(b,a,e){a&&(c=a);e&&(d=e);return""});return c+b.replace(a,e)+d}function n(b){var a=[];d(b._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,a,e){return a+"</pre>"+
e+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(b,e){a.push(e)});return a}function k(b,a){for(var e=a[0].ownerDocument.createDocumentFragment(),c=0;c<b.length;c++){var f=b[c],f=f.replace(/(\r\n|\r)/g,"\n"),f=d(f,/^[ \t]*\n/,""),f=d(f,/\n$/,""),f=d(f,/^[ \t]+|[ \t]+$/g,function(b,a){return 1==b.length?"&nbsp;":a?" "+Array(b.length).join("&nbsp;"):Array(b.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(b){return Array(b.length).join("&nbsp;")+" "}),
i=a.clone();i.html(f);e.appendChild(i[0])}return e}function t(b){var a=b.document;if(b.collapsed)a=s(this,a,void 0),b.insertNode(a),b.moveToPosition(a,H.POSITION_BEFORE_END);else{var e=this.element,c=this._.definition,d,f=G[e];f||(d=l,f=G.span);var i=b.createBookmark();b.enlarge(H.ENLARGE_ELEMENT);b.trim();for(var g=b.createBookmark(),h=g.startNode,g=g.endNode,k=h,j;k&&k[0];){var n=w;if(A.equals(k,g))k=y,n=l;else{var m=k[0].nodeType,p=m==A.ELEMENT_NODE?k.nodeName():y;if(p&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(l);continue}if(!p||f[p]&&(k._4e_position(g)|B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(k))){var o=k.parent();if(o&&"a"==e&&o.nodeName()==e)m=s(this,a,void 0),o._4e_moveChildren(m),o[0].parentNode.replaceChild(m[0],o[0]),m._4e_mergeSiblings();else if(o&&o[0]&&((G[o.nodeName()]||G.span)[e]||d)&&(!c.parentRule||c.parentRule(o))){if(!j&&(!p||!G.$removeEmpty[p]||(k._4e_position(g)|
B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED))j=new P(a),j.setStartBefore(k);if(m==A.TEXT_NODE||m==A.ELEMENT_NODE&&!k[0].childNodes.length){o=k;for(m=null;(n=!o.next(r))&&(m=o.parent())&&f[m.nodeName()]&&(m._4e_position(h)|B.POSITION_FOLLOWING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_FOLLOWING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(m));)o=m;j.setEndAfter(o)}}else n=
l}else n=l;k=k._4e_nextSourceNode()}if(n&&j&&!j.collapsed){for(var n=s(this,a,void 0),o=j.getCommonAncestor(),m={},p={},v,q=null,t;n&&o&&n[0]&&o[0];){if(o.nodeName()==e){for(v in c.attributes)if(c.attributes.hasOwnProperty(v)&&!p[v]&&(t=o.attr(q)))n.attr(v)==t?n.removeAttr(v):p[v]=1;for(q in c.styles)if(c.styles.hasOwnProperty(q)&&!m[q]&&(t=o.style(q)))n.style(q)==t?n.style(q,""):m[q]=1;if(!n._4e_hasAttributes()){n=y;break}}o=o.parent()}n?(n[0].appendChild(j.extractContents()),x(this,n),j.insertNode(n),
n._4e_mergeSiblings(),C.ie||n[0].normalize()):(n=new E(a.createElement("span")),n[0].appendChild(j.extractContents()),j.insertNode(n),x(this,n),n._4e_remove(!0));j=y}}h._4e_remove();g._4e_remove();b.moveToBookmark(i);b.shrink(H.SHRINK_TEXT)}}function o(b){b.enlarge(H.ENLARGE_ELEMENT);var a=b.createBookmark(),d=a.startNode;if(b.collapsed){for(var f=new I(d.parent()),i,g=0,h;g<f.elements.length&&(h=f.elements[g])&&!(h==f.block||h==f.blockLimit);g++)if(this.checkElementRemovable(h)){var k=b.checkBoundaryOfElement(h,
H.END),l=!k&&b.checkBoundaryOfElement(h,H.START);l||k?(i=h,i.match=l?"start":"end"):(h._4e_mergeSiblings(),h.nodeName()!=this.element?(k=c(this),e(h,k[h.nodeName()]||k["*"])):u(this,h))}if(i.length){h=d;for(g=0;;g++){k=f.elements[g];if(A.equals(k,i))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(h[0]);h=k}h["start"==i.match?"insertBefore":"insertAfter"](i)}}else{var j=a.endNode,n=this,f=function(){for(var b=new I(d.parent()),a=new I(j.parent()),e=y,c=y,f=0;f<b.elements.length;f++){var i=
b.elements[f];if(i==b.block||i==b.blockLimit)break;n.checkElementRemovable(i)&&(e=i)}for(f=0;f<a.elements.length;f++){i=a.elements[f];if(i==a.block||i==a.blockLimit)break;n.checkElementRemovable(i)&&(c=i)}c&&j._4e_breakParent(c);e&&d._4e_breakParent(e)};f();for(i=new E(d[0].nextSibling);i[0]!==j[0];){g=i._4e_nextSourceNode();if(i[0]&&i[0].nodeType==A.ELEMENT_NODE&&this.checkElementRemovable(i)&&(i.nodeName()==this.element?u(this,i):(h=c(this),e(i,h[i.nodeName()]||h["*"])),g[0].nodeType==A.ELEMENT_NODE&&
g.contains(d)))f(),g=new E(d[0].nextSibling);i=g}}b.moveToBookmark(a)}function p(b){var a={};(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,e,c){a[e]=c});return a}function f(b,a){var e="";a!==w?(e=document.createElement("span"),e.style.cssText=b,e=e.style.cssText||""):e=b;return e.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(b){if(b._.overrides)return b._.overrides;var a=b._.overrides={},e=b._.definition.overrides;
if(e){j.isArray(e)||(e=[e]);for(var c=0;c<e.length;c++){var d=e[c],f,i,g;"string"==typeof d?f=d.toLowerCase():(f=d.element?d.element.toLowerCase():b.element,i=d.attributes,g=d.styles);d=a[f]||(a[f]={});if(i){f=d.attributes=d.attributes||[];for(var h in i)i.hasOwnProperty(h)&&f.push([h.toLowerCase(),i[h]])}if(g){var d=d.styles=d.styles||[],k;for(k in g)g.hasOwnProperty(k)&&d.push([k.toLowerCase(),g[k]])}}}return a}function u(a,e){var d=a._.definition,f=c(a),i=v.mix(d.attributes,(f[e.nodeName()]||f["*"]||
{}).attributes),d=v.mix(d.styles,(f[e.nodeName()]||f["*"]||{}).styles),f=j.isEmptyObject(i)&&j.isEmptyObject(d),g;for(g in i)if(i.hasOwnProperty(g)&&!(("class"==g||a._.definition.fullMatch)&&e.attr(g)!=h(g,i[g])))f=f||!!e.hasAttr(g),e.removeAttr(g);for(var k in d)d.hasOwnProperty(k)&&!(a._.definition.fullMatch&&e.style(k)!=h(k,d[k],l))&&(f=f||!!e.style(k),e.style(k,""));b(e)}function h(b,a,e){var c=new E("<span>");c[e?"style":"attr"](b,a);return c[e?"style":"attr"](b)}function x(b,a){for(var d=c(b),
f=a.all(b.element),i=f.length;0<=--i;)u(b,new E(f[i]));for(var g in d)if(d.hasOwnProperty(g)&&g!=b.element){f=a.all(g);for(i=f.length-1;0<=i;i--){var h=new E(f[i]);e(h,d[g])}}}function e(a,e){var c,d=e&&e.attributes;if(d)for(c=0;c<d.length;c++){var f=d[c][0],i;if(i=a.attr(f)){var g=d[c][1];(g===y||g.test&&g.test(i)||"string"==typeof g&&i==g)&&a[0].removeAttribute(f)}}if(d=e&&e.styles)for(c=0;c<d.length;c++)if(f=d[c][0],g=a.css(f)){var h=d[c][1];(h===y||h.test&&h.test(i)||"string"==typeof h&&g==h)&&
a.css(f,"")}b(a)}function b(b){if(!b._4e_hasAttributes()){var a=b[0].firstChild,e=b[0].lastChild;b._4e_remove(l);a&&(a.nodeType==A.ELEMENT_NODE&&A._4e_mergeSiblings(a),e&&a!=e&&e.nodeType==A.ELEMENT_NODE&&A._4e_mergeSiblings(e))}}var i=j.Editor,l=!0,w=!1,y=null,v=i.Utils,A=j.DOM,F={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},H=i.RANGE,K=i.Selection,B=i.POSITION,P=i.Range,E=j.Node,C=j.UA,I=i.ElementPath,M={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},G=i.XHTML_DTD,N={embed:1,hr:1,img:1,
li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;i.STYLE=F;m.prototype={apply:function(b){g.call(this,b,w)},remove:function(b){g.call(this,b,l)},applyToRange:function(b){return(this.applyToRange=this.type==F.STYLE_INLINE?t:this.type==F.STYLE_BLOCK?a:y).call(this,b)},removeFromRange:function(b){return(this.removeFromRange=this.type==F.STYLE_INLINE?o:y).call(this,b)},checkElementRemovable:function(b,a){if(!b)return w;var e=this._.definition,d;
if(b.nodeName()==this.element){if(!a&&!b._4e_hasAttributes())return l;var i=e._AC;if(i)e=i;else{var i={},g=0,h=e.attributes;if(h)for(var k in h)h.hasOwnProperty(k)&&(g++,i[k]=h[k]);if(h=m.getStyleText(e))i.style||g++,i.style=h;i._length=g;e=e._AC=i}if(e._length){for(var j in e)if("_length"!=j&&e.hasOwnProperty(j)){g=b.attr(j)||"";if("style"==j)a:{i=e[j];g=f(g,w);"string"==typeof i&&(i=p(i));"string"==typeof g&&(g=p(g));h=void 0;for(h in i)if(i.hasOwnProperty(h)&&!(h in g&&(g[h]==i[h]||"inherit"==
i[h]||"inherit"==g[h]))){i=w;break a}i=l}else i=e[j]==g;if(i){if(!a)return l}else if(a)return w}if(a)return l}else return l}j=c(this);if(j=j[b.nodeName()]||j["*"]){if(!(e=j.attributes)&&!(d=j.styles))return l;if(e)for(i=0;i<e.length;i++)if(j=e[i][0],j=b.attr(j))if(g=e[i][1],g===y||"string"==typeof g&&j==g||g.test&&g.test(j))return l;if(d)for(i=0;i<d.length;i++)if(j=b.css(d[i][0]))if(e=d[i][1],e===y||"string"==typeof e&&j==e||e.test&&e.test(j))return l}return w},checkActive:function(b){switch(this.type){case F.STYLE_BLOCK:return this.checkElementRemovable(b.block||
b.blockLimit,l);case F.STYLE_OBJECT:case F.STYLE_INLINE:for(var a=b.elements,e=0,c;e<a.length;e++)if(c=a[e],!(this.type==F.STYLE_INLINE&&(A.equals(c,b.block)||A.equals(c,b.blockLimit))))if((this.type!=F.STYLE_OBJECT||c.nodeName()in N)&&this.checkElementRemovable(c,l))return l}return w}};m.getStyleText=function(b){var a=b._ST;if(a)return a;var a=b.styles,e=b.attributes&&b.attributes.style||"",c="";e.length&&(e=e.replace(O,";"));for(var d in a)if(a.hasOwnProperty(d)){var i=a[d],g=(d+":"+i).replace(O,
";");"inherit"==i?c+=g:e+=g}e.length&&(e=f(e));return b._ST=e+c};i.Style=m},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(j){var r=j.Editor,q=j.Node,m=j.DOM,g=j.UA,s={debugUrl:function(a){a=a.replace(/-min\.(js|css)/i,".$1");j.Config.debug||(a=a.replace(/\.(js|css)/i,"-min.$1"));-1==a.indexOf("?t")&&(a=-1!=a.indexOf("?")?a+"&":a+"?",a+="t="+encodeURIComponent("20120523212713"));j.startsWith(a,"/")&&(a=a.substring(1));return r.Config.base+a},lazyRun:function(a,d,g){var k=a[d],j=a[g];a[d]=function(){k.apply(this,arguments);a[d]=a[g];return j.apply(this,arguments)}},getXY:function(a,
d,g,k){g=g.defaultView||g.parentWindow;a-=m.scrollLeft(g);d-=m.scrollTop(g);k&&(k=k.defaultView||k.parentWindow,g!=k&&g.frameElement&&(k=m.offset(g.frameElement,void 0,k),a+=k.left,d+=k.top));return{left:a,top:d}},tryThese:function(a){for(var d,g=0,k=arguments.length;g<k;g++){var j=arguments[g];try{d=j();break}catch(m){}}return d},arrayCompare:function(a,d){if(!a&&!d)return!0;if(!a||!d||a.length!=d.length)return!1;for(var g=0;g<a.length;g++)if(a[g]!==d[g])return!1;return!0},getByAddress:function(a,
d,g){for(var a=a.documentElement,k=0;a&&k<d.length;k++){var j=d[k];if(g)for(var m=-1,p=0;p<a.childNodes.length;p++){var f=a.childNodes[p];if(!(!0===g&&3==f.nodeType&&f.previousSibling&&3==f.previousSibling.nodeType)&&(m++,m==j)){a=f;break}}else a=a.childNodes[j]}return a?new q(a):null},clearAllMarkers:function(a){for(var d in a)a.hasOwnProperty(d)&&a[d]._4e_clearMarkers(a,!0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},mix:function(a){for(var d={},
g=0;g<arguments.length;g++)d=j.mix(d,arguments[g]);return d},isCustomDomain:function(){if(!g.ie)return!1;var a=document.domain,d=window.location.hostname;return a!=d&&a!="["+d+"]"},isNumber:function(a){return/^\d+(.\d+)?$/.test(j.trim(a))},verifyInputs:function(a){for(var d=0;d<a.length;d++){var g=new q(a[d]),k=j.trim(s.valInput(g)),m=g.attr("data-verify"),g=g.attr("data-warning");if(m&&!RegExp(m).test(k))return alert(g),!1}return!0},sourceDisable:function(a,d){a.on("sourceMode",d.disable,d);a.on("wysiwygMode",
d.enable,d)},resetInput:function(a){var d=a.attr("placeholder");d&&g.ie?(a.addClass("ke-input-tip"),a.val(d)):g.ie||a.val("")},valInput:function(a,d){if(void 0===d)return a.hasClass("ke-input-tip")?"":a.val();a.removeClass("ke-input-tip");a.val(d)},placeholder:function(a,d){a.attr("placeholder",d);g.ie&&(a.on("blur",function(){j.trim(a.val())||(a.addClass("ke-input-tip"),a.val(d))}),a.on("focus",function(){a.removeClass("ke-input-tip");j.trim(a.val())==d&&a.val("")}))},htmlEncode:function(a){return!a?
a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(a){var a=j.clone(a),d;for(d in a)if(a.hasOwnProperty(d)){var g=a[d];j.isFunction(g)&&(a[d]=g())}return a},map:function(a,d){for(var g=0;g<a.length;g++)a[g]=d(a[g]);return a},ieEngine:document.documentMode||g.ie,preventFocus:function(a){g.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(a){j.mix(m,a);for(var d in a)a.hasOwnProperty(d)&&function(d){q.prototype[d]=
function(){var g=[].slice.call(arguments,0);g.unshift(this[0]);return(g=a[d].apply(null,g))&&(g.nodeType||j.isWindow(g))?new q(g):j.isArray(g)&&(g.__IS_NODELIST||g[0]&&g[0].nodeType)?new q(g):g}}(d)},addRes:function(){var a=this.__res=this.__res||[];a.push.apply(a,j.makeArray(arguments))},destroyRes:function(){for(var a=this.__res||[],d=0;d<a.length;d++){var g=a[d];j.isFunction(g)?g():(g.destroy&&g.destroy(),g.remove&&g.remove())}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,
function(a,g){return g.toUpperCase()})+"Active"}};return r.Utils=s},{requires:["./base"]});
KISSY.add("editor/core/walker",function(j,r){function q(c,g){if(this._.end)return d;var e,b=this.range,f,j=this.guard,m=this.type,n=c?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,b.trim(),b.collapsed))return this.end(),d;if(!c&&!this._.guardLTR){var p=b.endContainer[0],r=p.childNodes[b.endOffset];this._.guardLTR=function(b,a){return a&&(p==b||"body"==k.nodeName(b))?!1:b!=r}}if(c&&!this._.guardRTL){var q=b.startContainer[0],t=0<b.startOffset&&q.childNodes[b.startOffset-
1]||null;this._.guardRTL=function(b,a){return a&&(q==b||"body"==k.nodeName(b))?!1:b!=t}}var u=c?this._.guardRTL:this._.guardLTR;f=j?function(b,e){return u(b,e)===a?a:j(b,e)}:u;this.current?e=this.current[n](a,m,f):c?(e=b.endContainer,0<b.endOffset?(e=new o(e[0].childNodes[b.endOffset-1]),f(e)===a&&(e=d)):e=f(e,s)===a?d:e._4e_previousSourceNode(s,m,f,void 0)):(e=b.startContainer,e=new o(e[0].childNodes[b.startOffset]),e.length?f(e)===a&&(e=d):e=f(b.startContainer,s)===a?d:b.startContainer._4e_nextSourceNode(s,
m,f,void 0));for(;e&&!this._.end;){this.current=e;if(!this.evaluator||this.evaluator(e[0])!==a){if(!g)return e}else if(g&&this.evaluator)return a;e=e[n](a,m,f)}this.end();return this.current=d}function m(a){for(var c,e=d;c=q.call(this,a);)e=c;return e}function g(a){this.range=a;this._={}}var s=!0,a=!1,d=null,n=j.UA,k=j.DOM,t=r.XHTML_DTD,o=j.Node;j.augment(g,{end:function(){this._.end=1},next:function(){return q.call(this)},previous:function(){return q.call(this,s)},checkForward:function(){return q.call(this,
a,s)!==a},checkBackward:function(){return q.call(this,s,s)!==a},lastForward:function(){return m.call(this)},lastBackward:function(){return m.call(this,s)},reset:function(){delete this.current;this._={}},_iterator:q});g.blockBoundary=function(a){return function(c){return!(c.nodeType==k.ELEMENT_NODE&&k._4e_isBlockBoundary(c,a))}};g.bookmark=function(a,c){function e(b){return"span"==k.nodeName(b)&&k.attr(b,"_ke_bookmark")}return function(b){var d,f;d=b.nodeType==k.TEXT_NODE&&(f=b.parentNode)&&e(f);d=
a?d:d||e(b);return!!(c^d)}};g.whitespaces=function(a){return function(c){c=c.nodeType==k.TEXT_NODE&&!j.trim(c.nodeValue);return!!(a^c)}};g.invisible=function(a){var c=g.whitespaces();return function(e){e=c(e)||e.nodeType==k.ELEMENT_NODE&&!e.offsetHeight;return!!(a^e)}};var p=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,f=g.whitespaces(),c=g.bookmark(),u=function(a){var d=k.nodeName(a);return c(a)||f(a)||1==a.nodeType&&d in t.$inline&&!(d in t.$empty)};r.Utils.injectDom({_4e_getBogus:function(a){a=new o(a);do a=
a._4e_previousSourceNode();while(a&&u(a[0]));return a&&(!n.ie?"br"==a.nodeName():3==a[0].nodeType&&p.test(a.text()))?a[0]:!1}});return r.Walker=g},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(j){var r=j.Editor;r.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};r.baseZIndex=function(j){return(r.Config.baseZIndex||1E4)+j}},{requires:["./base"]});
KISSY.add("editor",function(j,r,q,m){function g(a,b){var f=a.body;c(function(){a.designMode="on";setTimeout(function(){a.designMode="off";f.focus();arguments.callee.retry||(arguments.callee.retry=s)},50)},function(){a.designMode="off";o.attr(f,"contentEditable",d);o.attr(f,"contentEditable",s);!b&&g(a,1)})}var s=!0,a=j.all,d=!1,n=document,k=j.UA,t=k.ie,o=j.DOM,p=j.Node,f=j.Event,c=q.tryThese,u="document.open();"+(q.isCustomDomain()?'document.domain="'+n.domain+'";':"")+"document.close();",h='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(t?' src="javascript:void(function(){'+encodeURIComponent(u)+'}())"':"")+' allowTransparency="true"></iframe>';j.mix(r,{SOURCE_MODE:0,WYSIWYG_MODE:1});var x=r.WYSIWYG_MODE;j.augment(r,{createDom:function(){var e=this.get("textarea"),b;e||this.set("textarea",e=a("<textarea></textarea>"));b=this.get("el");b.addClass(this.get("prefixCls")+"editor-wrap",void 0);b.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=j.guid();var c=
b.one(".ke-textarea-wrap");this.__set("iframeWrapEl",c);this.__set("toolBarEl",b.one(".ke-editor-tools"));this.__set("statusBarEl",b.one(".ke-editor-status"));var d=this.get("width"),f=this.get("height");b.css("width",d);e.css("width","100%");e.css("display","none");c.append(e);c.css("height",f);e.css("height",f);b.css("height","")},_uiSetHeight:function(a){this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("textarea");a?(b.execCommand("save"),
b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",c)}),b._setData(d.val())):(d.val(b._getData(1,x)),d[0].focus());d[a?"hide":"show"]();b.get("iframe")[a?"show":"hide"]();b.fire((a?"wysiwyg":"source")+"Mode")},renderUI:function(){function a(){b.detach("docReady",a);if(b.get("focus"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c=b.get("textarea");m.register(b);b.get("attachForm")&&c[0].form&&b._attachForm();b.on("docReady",a)},_createIframe:function(a){var b=
this,c=new p(h),d=b.get("textarea");d.hasAttr("tabindex")&&c.attr("tabIndex",k.webkit?-1:d.attr("tabIndex"));b.get("iframeWrapEl").prepend(c);b.set("iframe",c);b.__docReady=0;if(k.gecko&&!c.__loaded)c.on("load",function(){b._setUpIFrame(a)},b);else b._setUpIFrame(a)},destructor:function(){var a=this.get("el"),b=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();r.focusManager.remove(this);f.remove([c,c.documentElement,c.body,d]);j.each(this.__dialogs,
function(a){a.destroy&&a.destroy()});this.__commands=0;this.__editor_created_new||(b.insertBefore(a,void 0),b.css({width:this.get("width"),height:this.get("height")}),b.show())},_attachForm:function(){var a=this,b=a.get("textarea"),c=new p(b[0].form);c.on("submit",a.sync,a);a.on("destroy",function(){c.detach("submit",a.sync,a)})},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var c=this.__dialogs[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},
hasDialog:function(a){return!!this.__dialogs[a]},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=j.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var a=this.get("iframe"),b=a[0].contentWindow,c=this.get("document")[0];f.remove([c,c.documentElement,c.body,b]);a.remove()}},_getData:function(a,b){var c=this.htmlDataProcessor,
d;void 0==b&&(b=this.get("mode"));d=b==x?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=j.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,c=a;if(this.get("mode")!=x)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(a){this.get("document")[0].body.innerHTML=a},_prepareIFrameHtml:function(a,b){var c=this.get("customStyle"),d=this.get("customLink"),f="",g=r.Utils.debugUrl("/theme/editor-iframe.css");if(d)for(var h=0;h<d.length;h++)f+='<link href="'+d[h]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===n.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+g+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+f+"</head><body class='ke-editor'>"+
(b||"&nbsp;")+(a?'<script id="ke_actscript" type="text/javascript">'+(q.isCustomDomain()?'document.domain="'+n.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"},getSelection:function(){return r.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=o._4e_getWin(a);k.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){o._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a){var b=this.get("customStyle")||"",b=b+("\n"+a);this.set("customStyle",b);o.addStyleSheet(this.get("iframe")[0].contentWindow,b)},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=o.query("link",b),c=
0;c<b.length;c++)b[c].href==a&&o.remove(b[c]);b=this.get("customLink")||[];a=j.indexOf(a,b);-1!=a&&b.splice(a,1)},_setUpIFrame:function(a){function b(){h=g.document;c.__set("document",new p(h));c.__set("window",new p(g));d.detach();h.open("text/html","replace");h.write(f);h.close()}var c=this,d=c.get("iframe"),f=c._prepareIFrameHtml(c._UUID,a),g=d[0].contentWindow,h;d.__loaded=1;try{h=g.document}catch(j){if(d[0].src=d[0].src,7>t){setTimeout(b,10);return}}b()},docReady:function(a){this.on("docReady",
a);this.__docReady&&a.call(this)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new r.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(a,b,c){var f=this;if(f.get("mode")===
x){f.focus();var g,h=a.nodeName(),j=r.XHTML_DTD,k=r.RANGE,m=j.$block[h],n=f.getSelection(),q=n&&n.getRanges(),t,u,E,C;if(!q||0==q.length){var I=arguments,M=I.callee;setTimeout(function(){M.apply(f,I)},30)}else{f.execCommand("save");for(var G=q.length-1;0<=G;G--){t=q[G];t.deleteContents();g=!G&&a||a.clone(s);b&&b(g);if(m)for(;(E=t.getCommonAncestor(d,s))&&(C=j[E.nodeName()])&&(!C||!C[h]);)E.nodeName()in j.span?t.splitElement(E):t.checkStartOfBlock()&&t.checkEndOfBlock()?(t.setStartBefore(E),t.collapse(s),
E.remove()):t.splitBlock();t.insertNode(g);u||(u=g)}u&&(h=u._4e_nextSourceNode(s),j=f.get("document")[0],C=r.XHTML_DTD,C.$inline[g.nodeName()]?(h=new p(j.createTextNode(" ")),h.insertAfter(u)):h?"br"==h.nodeName()&&C[h.parent().nodeName()].p&&(C=new p("<p>&nbsp;</p>",null,j),h[0].parentNode.replaceChild(C[0],h[0]),h=C):(C=new p("<p>&nbsp;</p>",null,j),C.insertAfter(u),h=C),t.moveToPosition(u,k.POSITION_AFTER_END),h&&h[0].nodeType==o.ELEMENT_NODE&&t.moveToElementEditablePosition(h),n.selectRanges([t]),
f.focus(),g&&g.scrollIntoView(void 0,!1),f._saveLater(),c&&c(g))}}},insertHtml:function(a,b){var c=this,f;if(c.get("mode")===x){if(f=c.htmlDataProcessor)a=f.toDataFormat(a,null,b);c.focus();c.execCommand("save");var g=c.get("document")[0];f=0;if(t){var h=g.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(a)}catch(j){}}else try{g.execCommand("inserthtml",d,a)}catch(k){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new r.Range(g),f=o.first(g.body,function(a){return 1==
a.nodeType&&"br"!=o.nodeName(a)});f||(f=new p(g.createElement("p")),g.body.appendChild(f[0]));b.setStartAt(f,r.RANGE.POSITION_AFTER_START);b.select()}g.execCommand("inserthtml",d,a)},f=100)}setTimeout(function(){c.getSelection().scrollIntoView()},f);c._saveLater(f)}},_saveLater:function(a){var b=this;b.__saveTimer&&(clearTimeout(b.__saveTimer),b.__saveTimer=null);b.__saveTimer=setTimeout(function(){b.execCommand("save")},a||0)},_fixByBindIframeDoc:function(){var a=this,b=a.get("iframe"),c=a.get("textarea")[0],
b=b[0].contentWindow,h=a.get("document")[0];k.webkit&&(f.on(h,"click",function(a){var b=new p(a.target);j.inArray(b.nodeName(),["input","select"])&&a.preventDefault()}),f.on(h,"mouseup",function(a){var b=new p(a.target);j.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(k.gecko||t||k.opera){var n;n=(new p('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);n.on("focus",function(){a.focus()});a.activateGecko=function(){k.gecko&&
a.__iframeFocus&&n[0].focus()};a.on("destroy",function(){n.detach();n.remove()})}f.on(b,"focus",function(){k.gecko?g(h,d):k.opera&&h.body.focus();a.notifySelectionChange()});if(k.gecko)f.on(h,"mousedown",function(){a.__iframeFocus||g(h,d)});if(t&&(f.on(h,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var f=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([f]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==h.compatMode)){var o=
{33:1,34:1};f.on(h,"keydown",function(b){b.keyCode in o&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(k.webkit)f.on(h,"mousedown",function(b){b=new p(b.target);j.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(k.gecko)f.on(h,"dragstart",function(a){var b=new p(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});m.add(a)}});r._initIFrame=function(a){var b=m.getInstance(a),c=b.get("document")[0],
a=c.getElementById("ke_actscript");o.remove(a);b._fixByBindIframeDoc();var h=c.body;t?(h.hideFocus=s,h.disabled=s,h.contentEditable=s,h.removeAttribute("disabled")):setTimeout(function(){k.gecko||k.opera?h.contentEditable=s:k.webkit?h.parentNode.contentEditable=s:c.designMode="on"},0);if(k.gecko||k.opera){var j=c.documentElement;f.on(j,"mousedown",function(a){if(a.target==j){k.gecko&&g(c,d);b.activateGecko()}})}setTimeout(function(){t&&setTimeout(function(){if(c){h.runtimeStyle.marginBottom="0px";
h.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.__docReady=1;b.fire("docReady");var a=b.get("disableObjectResizing"),e=b.get("disableInlineTableEditing");if(a||e)try{c.execCommand("enableObjectResizing",d,!a);c.execCommand("enableInlineTableEditing",d,!e)}catch(g){f.on(h,t?"resizestart":"resize",function(b){var c=new p(b.target);(a||c.nodeName()==="table"&&e)&&b.preventDefault()})}},10)};return r},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
