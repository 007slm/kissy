/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 15 19:31
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(f,k,u){k=u.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:k.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(f){return this._setData(f)}},formatData:{getter:function(){return this._getData(1)},setter:function(f){return this._setData(f)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});k.HTML_PARSER={textarea:function(f){return f.one(".ks-editor-textarea")}};f.mix(k,f.EventTarget);return KISSY.Editor=k},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(f,k,u,r){function q(a){this.editor=a;this._init()}function e(a){if(n.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),c;if(b.getType()==r.SELECTION_ELEMENT&&(c=b.getSelectedElement())){var h=b.getRanges()[0],g=d(a.get("document")[0].createTextNode(""));g.insertBefore(c);h.setStartBefore(g);h.setEndAfter(c);b.selectRanges([h]);setTimeout(function(){c.parent()&&(g.remove(),b.selectElement(c))},0)}}}var d=f.all,n=f.UA,p=k.RANGE,m=f.Event;
f.augment(q,{_init:function(){var a=this.editor,i=a.get("document")[0].body;m.on(i,n.ie?"beforepaste":"paste",this._paste,this);m.on(i,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new v("copy"));a.addCommand("cut",new v("cut"));a.addCommand("paste",new v("paste"))},_paste:function(){if(!b){var a=this.editor,i=a.get("document")[0];if(!i.getElementById("ke_pastebin")){var c=a.getSelection(),h=new u(i),g=d(n.webkit?"<body></body>":"<div></div>",null,i);g.attr("id",
"ke_pastebin");n.webkit&&g[0].appendChild(i.createTextNode("\u00a0"));i.body.appendChild(g[0]);g.css({position:"absolute",top:c.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});g.css("left","-1000px");var l=c.createBookmarks();h.setStartAt(g,p.POSITION_AFTER_START);h.setEndAt(g,p.POSITION_BEFORE_END);h.select(!0);setTimeout(function(){var b;g=n.webkit&&(b=g.first())&&b.hasClass("Apple-style-span")?b:g;c.selectBookmarks(l);g.remove();var h=g.html();if(h=f.trim(h.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))b=a.fire("paste",{html:h,holder:g}),void 0!==b&&(h=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(h)?f.use("editor/core/dynamic/wordFilter",function(c,g){a.insertHtml(g.toDataFormat(h,a))}):a.insertHtml(h)},0)}}}});var w=function(a,b){var c=a.get("document")[0],h=d(c.body),g=!1,l=function(){g=!0};h.on(b,l);(7<n.ie?c:c.selection.createRange()).execCommand(b);h.detach(b,l);return g},o=n.ie?function(a,b){return w(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(c){return!1}},
x={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},v=function(a){this.type=a};v.prototype={exec:function(a){"cut"==this.type&&e(a);(a=o(a,this.type))||alert(x[this.type]);return a}};var j={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;return{init:function(a){a.docReady(function(){new q(a)});var b={copy:1,cut:1,paste:1};a.on("contextmenu",function(c){c=c.contextmenu;if(!c.__copy_fix){c.__copy_fix=
1;for(var h in b)b.hasOwnProperty(h)&&c.addChild({xclass:"menuitem",content:j[h],value:h});c.on("click",function(g){var c=g.target.get("value");b[c]&&(this.hide(),setTimeout(function(){a.execCommand(c)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.Loader&&KISSY.config("modules",{"editor/plugin/heading/cmd":{requires:["editor"]},"editor/plugin/page-break/index":{requires:["editor","editor/plugin/fake-objects/"]},"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/image/dialog":{requires:["ajax","editor","editor/plugin/overlay/","switchable","editor/plugin/menubutton/"]},"editor/plugin/underline/index":{requires:["editor","editor/plugin/font/ui",
"editor/plugin/underline/cmd"]},"editor/plugin/maximize/cmd":{requires:["editor"]},"editor/plugin/contextmenu/index":{requires:["editor","menu","editor/plugin/focus-fix/"]},"editor/plugin/heading/index":{requires:["editor","editor/plugin/heading/cmd"]},"editor/plugin/drag-upload/index":{requires:["editor"]},"editor/plugin/color/cmd":{requires:["editor"]},"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/strike-through/cmd":{requires:["editor",
"editor/plugin/font/cmd"]},"editor/plugin/unordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]},"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/italic/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]},"editor/plugin/remove-format/cmd":{requires:["editor"]},"editor/plugin/font-size/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-size/cmd"]},"editor/plugin/indent/cmd":{requires:["editor",
"editor/plugin/dent-utils/cmd"]},"editor/plugin/table/index":{requires:["editor","editor/plugin/dialog-loader/","editor/plugin/contextmenu/"]},"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/resize/index":{requires:["editor","dd"]},"editor/plugin/focus-fix/index":{requires:["editor"]},"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/xiami-music/index":{requires:["editor","editor/plugin/flash-common/baseClass",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/maximize/index":{requires:["editor","editor/plugin/maximize/cmd"]},"editor/plugin/color/color-picker/dialog":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/smiley/index":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/separator/index":{requires:["editor"]},"editor/plugin/video/index":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/baseClass","editor/plugin/fake-objects/"]},
"editor/plugin/multiple-upload/index":{requires:["editor","editor/plugin/dialog-loader/"]},"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/menubutton/index":{requires:["editor","menubutton"]},"editor/plugin/flash/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/overlay/index":{requires:["editor","overlay","editor/plugin/focus-fix/","dd"]},"editor/plugin/link/utils":{requires:["editor"]},
"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/button/index":{requires:["editor","button"]},"editor/plugin/checkbox-source-area/index":{requires:["editor"]},"editor/plugin/strike-through/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]},"editor/plugin/fore-color/index":{requires:["editor","editor/plugin/color/btn",
"editor/plugin/fore-color/cmd"]},"editor/plugin/flash-bridge/index":{requires:["editor","editor/plugin/flash-common/utils"]},"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/table/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/justify-utils/cmd":{requires:["editor"]},"editor/plugin/undo/index":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]},"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-utils/cmd"]},
"editor/plugin/dent-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/image/index":{requires:["editor","editor/plugin/button/","editor/plugin/bubble/","editor/plugin/contextmenu/","editor/plugin/dialog-loader/"]},"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]},"editor/plugin/list-utils/index":{requires:["editor"]},"editor/plugin/dialog-loader/index":{requires:["overlay","editor"]},"editor/plugin/font-family/index":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-family/cmd"]},"editor/plugin/undo/cmd":{requires:["editor"]},"editor/plugin/indent/index":{requires:["editor","editor/plugin/indent/cmd"]},"editor/plugin/font/cmd":{requires:["editor"]},"editor/plugin/ordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]},"editor/plugin/color/btn":{requires:["editor","editor/plugin/button/","editor/plugin/overlay/","editor/plugin/dialog-loader/"]},"editor/plugin/bold/cmd":{requires:["editor",
"editor/plugin/font/cmd"]},"editor/plugin/local-storage/index":{requires:["editor","overlay","editor/plugin/flash-bridge/"]},"editor/plugin/bubble/index":{requires:["overlay","editor"]},"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/bold/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]},"editor/plugin/back-color/index":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]},"editor/plugin/draft/index":{requires:["editor",
"editor/plugin/local-storage/","overlay","editor/plugin/menubutton/"]},"editor/plugin/link/index":{requires:["editor","editor/plugin/bubble/","editor/plugin/link/utils","editor/plugin/dialog-loader/","editor/plugin/button/"]},"editor/plugin/remove-format/index":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button/"]},"editor/plugin/element-path/index":{requires:["editor"]},"editor/plugin/font/ui":{requires:["editor","editor/plugin/button/","editor/plugin/menubutton/"]},"editor/plugin/source-area/index":{requires:["editor",
"editor/plugin/button/"]},"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/justify-right/index":{requires:["editor","editor/plugin/justify-right/cmd"]},"editor/plugin/justify-left/index":{requires:["editor","editor/plugin/justify-left/cmd"]},"editor/plugin/outdent/index":{requires:["editor","editor/plugin/outdent/cmd"]},"editor/plugin/fake-objects/index":{requires:["editor"]},"editor/plugin/link/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/link/utils"]},
"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/multiple-upload/dialog":{requires:["editor","editor/plugin/progressbar/","editor/plugin/overlay/","editor/plugin/flash-bridge/","editor/plugin/local-storage/"]},"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/flash-common/baseClass":{requires:["editor","editor/plugin/contextmenu/","editor/plugin/bubble/",
"editor/plugin/dialog-loader/","editor/plugin/flash-common/utils"]},"editor/plugin/justify-center/index":{requires:["editor","editor/plugin/justify-center/cmd"]},"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});
KISSY.add("editor/core/dom",function(f,k,u){function r(b,a){var i=b[a?"next":"prev"](q,1);if(i&&i[0].nodeType==n.ELEMENT_NODE){for(var c=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemovable(q);)if(c.push(i),i=a?i.next(q,1):i.prev(q,1),!i)return;if(b._4e_isIdentical(i,q)){for(var h=new m(a?b[0].lastChild:b[0].firstChild);c.length;)c.shift()._4e_move(b,!a,q);i._4e_moveChildren(b,!a,q);i.remove();h[0]&&h[0].nodeType==n.ELEMENT_NODE&&h._4e_mergeSiblings()}}}var q=q,e=k.XHTML_DTD,d=f.DOM,n=d.NodeType,
p=f.UA,m=f.Node,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};k.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var o=k.POSITION,x={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},v={hr:1},j=function(b){return b&&(b[0]||b)};u.injectDom({_4e_sameLevel:function(b,a){var a=j(a),i=b.parentNode;return i&&i==a.parentNode},_4e_isBlockBoundary:function(b,a){var i=f.merge(v,a);return!(!x[d.css(b,"display")]&&!i[d.nodeName(b)])},_4e_index:function(b,a){for(var i=b.parentNode.childNodes,c,h=-1,g=0;g<i.length;g++)if(c=i[g],!a||!(3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType))if(h++,c===b)return h;return-1},_4e_move:function(b,
a,i){a=j(a);i?a.insertBefore(b,a.firstChild):a.appendChild(b)},_4e_isIdentical:function(b,a){if(!a)return!1;a=j(a);if(d.nodeName(b)!=d.nodeName(a))return!1;var i=b.attributes,c=a.attributes,h=i.length,g=c.length;if(h!=g)return!1;for(var l=0;l<h;l++){var s=i[l],e=s.name;if(s.specified&&d.attr(b,e)!=d.attr(a,e))return!1}if(8>u.ieEngine)for(l=0;l<g;l++)if(s=c[l],e=s.name,s.specified&&d.attr(b,e)!=d.attr(a,e))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){if(!e.$removeEmpty[d.nodeName(b)])return!1;
for(var b=b.childNodes,a=0,i=b.length;a<i;a++){var c=b[a],h=c.nodeType;if(!(h==n.ELEMENT_NODE&&c.getAttribute("_ke_bookmark"))&&(h==n.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(c)||h==d.NodeType.TEXT_NODE&&f.trim(c.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,a,i){a=j(a);if(b!=a)if(i)for(;i=b.lastChild;)a.insertBefore(b.removeChild(i),a.firstChild);else for(;i=b.firstChild;)a.appendChild(b.removeChild(i))},_4e_mergeSiblings:function(b){b=new m(b);w[b.nodeName()]&&(r(b,!0),r(b))},_4e_splitText:function(b,
a){var i=b.ownerDocument;if(b.nodeType==d.NodeType.TEXT_NODE){if(p.ie&&a==b.nodeValue.length){var c=i.createTextNode("");d.insertAfter(c,b);return c}c=b.splitText(a);i.documentMode&&(i=i.createTextNode(""),d.insertAfter(i,c),d.remove(i));return c}},_4e_parents:function(b,a){var i=[];i.__IS_NODELIST=1;do i[a?"push":"unshift"](b);while(b=b.parentNode);return i},_4e_nextSourceNode:function(b,a,i,c){if(c&&!c.call)var h=j(c),c=function(a){return a!==h};var a=!a&&b.firstChild,g=b;if(!a){if(b.nodeType==
n.ELEMENT_NODE&&c&&!1===c(b,!0))return null;a=b.nextSibling}for(;!a&&(g=g.parentNode);){if(c&&!1===c(g,!0))return null;a=g.nextSibling}return!a||c&&!1===c(a)?null:i&&i!=a.nodeType?d._4e_nextSourceNode(a,!1,i,c):a},_4e_previousSourceNode:function(b,a,i,c){if(c&&!c.call)var h=j(c),c=function(a){return a!==h};var a=!a&&b.lastChild,g=b;if(!a){if(b.nodeType==n.ELEMENT_NODE&&c&&!1===c(b,!0))return null;a=b.previousSibling}for(;!a&&(g=g.parentNode);){if(c&&!1===c(g,!0))return null;a=g.previousSibling}return!a||
c&&!1===c(a)?null:i&&a.nodeType!=i?d._4e_previousSourceNode(a,!1,i,c):a},_4e_commonAncestor:function(b,a){a=j(a);if(b===a)return b;if(d.contains(a,b))return a;var i=b;do if(d.contains(i,a))return i;while(i=i.parentNode);return null},_4e_hasAttributes:9>u.ieEngine?function(b){for(var a=b.attributes,i=0;i<a.length;i++){var c=a[i];switch(c.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(c.specified)return!0}}return!1}:function(b){p.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},
_4e_position:function(b,a){var i=j(a);if(b.compareDocumentPosition)return b.compareDocumentPosition(i);if(b==i)return o.POSITION_IDENTICAL;if(b.nodeType==n.ELEMENT_NODE&&i.nodeType==n.ELEMENT_NODE){if(d.contains(b,i))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(d.contains(i,b))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>i.sourceIndex?o.POSITION_DISCONNECTED:b.sourceIndex<i.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var c=
d._4e_address(b),i=d._4e_address(i),h=Math.min(c.length,i.length),g=0;g<=h-1;g++)if(c[g]!=i[g])return c[g]<i[g]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return c.length<i.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(b,a){for(var i=[],c=b.ownerDocument.documentElement,h=b;h&&h!=c;)i.unshift(d._4e_index(h,a)),h=h.parentNode;return i},_4e_remove:function(b,a){var i=b.parentNode;if(i){if(a)for(var c;c=b.firstChild;)i.insertBefore(b.removeChild(c),
b);i.removeChild(b)}return b},_4e_trim:function(b){d._4e_ltrim(b);d._4e_rtrim(b)},_4e_ltrim:function(b){for(var a;a=b.firstChild;){if(a.nodeType==d.NodeType.TEXT_NODE){var i=u.ltrim(a.nodeValue),c=a.nodeValue.length;if(i)i.length<c&&(d._4e_splitText(a,c-i.length),b.removeChild(b.firstChild));else{b.removeChild(a);continue}}break}},_4e_rtrim:function(b){for(var a;a=b.lastChild;){if(a.type==d.NodeType.TEXT_NODE){var i=u.rtrim(a.nodeValue),c=a.nodeValue.length;if(i)i.length<c&&(d._4e_splitText(a,i.length),
b.removeChild(b.lastChild));else{b.removeChild(a);continue}}break}!p.ie&&!p.opera&&(a=b.lastChild)&&1==a.nodeType&&"br"==d.nodeName(a)&&b.removeChild(a)},_4e_appendBogus:function(b){for(var a=b.lastChild;a&&a.nodeType==d.NodeType.TEXT_NODE&&!f.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==d.NodeType.TEXT_NODE||"br"!==d.nodeName(a))a=p.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),p.gecko&&a.setAttribute("type","_moz"),b.appendChild(a)},_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,
"");var a=b.ownerDocument.createElement("div");a.appendChild(b.cloneNode(!0));return a.innerHTML},_4e_setMarker:function(b,a,i,c){var b=new m(b),h=b.data("list_marker_id")||b.data("list_marker_id",f.guid()).data("list_marker_id"),g=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");a[h]=b;g[i]=1;return b.data(i,c)},_4e_clearMarkers:function(b,a,i){var b=new m(b),c=b.data("list_marker_names"),h=b.data("list_marker_id"),g;for(g in c)c.hasOwnProperty(g)&&b.removeData(g);
b.removeData("list_marker_names");i&&(b.removeData("list_marker_id"),delete a[h])},_4e_copyAttributes:function(b,a,i){for(var a=new m(a),c=b.attributes,i=i||{},h=0;h<c.length;h++){var g=c[h],l=g.name.toLowerCase(),s;if(!(l in i))if("checked"==l&&(s=d.attr(b,l)))a.attr(l,s);else if(g.specified||p.ie&&g.value&&"value"==l)s=d.attr(b,l),null===s&&(s=g.nodeValue),a.attr(l,s)}""!==b.style.cssText&&(a[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){b=d.nodeName(b);return(b=!e.$nonEditable[b]&&
(e[b]||e.span))&&b["#text"]},_4e_getByAddress:function(b,a,i){for(var b=b.documentElement,c=0;b&&c<a.length;c++){var h=a[c];if(i)for(var g=-1,l=0;l<b.childNodes.length;l++){var s=b.childNodes[l];if(!(!0===i&&3==s.nodeType&&s.previousSibling&&3==s.previousSibling.nodeType)&&(g++,g==h)){b=s;break}}else b=b.childNodes[h]}return b}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(f){function k(d){1>arguments.length||(this.range=d,this.forceBrBreak=r,this.enlargeBr=u,this.enforceRealBlocks=r,this._||(this._={}))}var u=!0,r=!1,q=f.Editor,e=f.UA,d=q.Walker,n=q.Range,p=q.RANGE,m=q.ElementPath,w=f.Node,o=f.DOM,x=/^[\r\n\t ]*$/;f.augment(k,{getNextParagraph:function(k){var j,b,a,i,c;if(!this._.lastNode){b=this.range.clone();b.shrink(p.SHRINK_ELEMENT,u);b.enlarge(this.forceBrBreak||!this.enlargeBr?p.ENLARGE_LIST_ITEM_CONTENTS:p.ENLARGE_BLOCK_CONTENTS);
var h=new d(b),g=d.bookmark(u,u);h.evaluator=g;this._.nextNode=h.next();h=new d(b);h.evaluator=g;h=h.previous();this._.lastNode=h._4e_nextSourceNode(u);this._.lastNode&&this._.lastNode[0].nodeType==o.NodeType.TEXT_NODE&&!f.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(g=new n(b.document),g.moveToPosition(this._.lastNode,p.POSITION_AFTER_END),g.checkEndOfBlock()&&(g=new m(g.endContainer),this._.lastNode=(g.block||g.blockLimit)._4e_nextSourceNode(u)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new w(b.document.createTextNode("")),o.insertAfter(this._.lastNode[0],h[0]));b=null}g=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;g;){var l=r,s=g[0].nodeType!=o.NodeType.ELEMENT_NODE,C=r;if(s)g[0].nodeType==o.NodeType.TEXT_NODE&&x.test(g[0].nodeValue)&&(s=r);else{var y=g.nodeName();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==y)s=u;else if(!b&&!g[0].childNodes.length&&"hr"!=y){j=g;a=g.equals(h);break}b&&(b.setEndAt(g,p.POSITION_BEFORE_START),
"br"!=y&&(this._.nextNode=g));l=u}else{if(g[0].firstChild){b||(b=new n(this.range.document),b.setStartAt(g,p.POSITION_BEFORE_START));g=new w(g[0].firstChild);continue}s=u}}s&&!b&&(b=new n(this.range.document),b.setStartAt(g,p.POSITION_BEFORE_START));a=(!l||s)&&g.equals(h);if(b&&!l)for(;!g[0].nextSibling&&!a;){y=g.parent();if(y._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=u;a||y.equals(h);break}g=y;s=u;a=g.equals(h);C=u}s&&b.setEndAt(g,p.POSITION_AFTER_END);g=g._4e_nextSourceNode(C,null,h);if((a=
!g)||l&&b)break}if(!j){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;j=new m(b.startContainer);g=j.blockLimit;l={div:1,th:1,td:1};j=j.block;if((!j||!j[0])&&!this.enforceRealBlocks&&l[g.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())j=g;else if(!j||this.enforceRealBlocks&&"li"==j.nodeName())j=new w(this.range.document.createElement(k||"p")),j[0].appendChild(b.extractContents()),j._4e_trim(),b.insertNode(j),i=c=u;else if("li"!=j.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())j=j.clone(r),j[0].appendChild(b.extractContents()),j._4e_trim(),c=b.splitBlock(),i=!c.wasStartOfBlock,c=!c.wasEndOfBlock,b.insertNode(j)}else a||(this._.nextNode=j.equals(h)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(u,null,h))}i&&(b=new w(j[0].previousSibling),b[0]&&b[0].nodeType==o.NodeType.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==o.nodeName(b[0].lastChild)&&o._4e_remove(b[0].lastChild)));c&&(b=d.bookmark(r,u),i=new w(j[0].lastChild),
i[0]&&i[0].nodeType==o.NodeType.ELEMENT_NODE&&"br"==i.nodeName()&&(e.ie||i.prev(b,1)||i.next(b,1))&&i.remove());this._.nextNode||(this._.nextNode=a||j.equals(h)?null:j._4e_nextSourceNode(u,null,h));return j}});n.prototype.createIterator=function(){return new k(this)};return k},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(f){function k(f){for(var m=e,k=e,o=[];f;){if(f[0].nodeType==r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=f);var x=f.nodeName();if(!k&&(!m&&d[x]&&(m=f),n[x])){var v;if(v=!m)if(v="div"==x){a:{v=f[0].childNodes;for(var j=0,b=v.length;j<b;j++){var a=v[j];if(a.nodeType==r.NodeType.ELEMENT_NODE&&q.$block[a.nodeName.toLowerCase()]){v=!0;break a}}v=!1}v=!v}v?m=f:k=f}o.push(f);if("body"==x)break}f=f.parent()}this.block=m;this.blockLimit=k;this.elements=
o}var u=f.Editor,r=f.DOM,q=u.XHTML_DTD,e=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},n={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};k.prototype={compare:function(d){var f=this.elements,d=d&&d.elements;if(!d||f.length!=d.length)return!1;for(var e=0;e<f.length;e++)if(!r.equals(f[e],d[e]))return!1;return!0},contains:function(d){for(var f=this.elements,n=0;n<f.length;n++)if(f[n].nodeName()in d)return f[n];return e},toString:function(){var d=
this.elements,f,e=[];for(f=0;f<d.length;f++)e.push(d[f].nodeName());return e.toString()}};return u.ElementPath=k},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(f,k,u,r){function q(e){var k;k=e.getSelection().getRanges();for(var q=k.length-1;0<q;q--)k[q].deleteContents();k=k[0];q=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var j=(new r(k.startContainer)).block;if(j&&("li"==j.nodeName()||"li"==j.parent().nodeName()))return e.hasCommand("outdent")?(e.execCommand("save"),e.execCommand("outdent"),e.execCommand("save"),!0):!1}var b=k.splitBlock("p");if(!b)return!0;var e=b.previousBlock,j=b.nextBlock,a=b.wasStartOfBlock,
i=b.wasEndOfBlock,c;if(j)c=j.parent(),"li"==c.nodeName()&&(j._4e_breakParent(c),j._4e_move(j.next(),!0));else if(e&&(c=e.parent())&&"li"==c.nodeName())e._4e_breakParent(c),k.moveToElementEditablePosition(e.next()),e._4e_move(e.prev());if(!a&&!i){if("li"==j.nodeName()&&(c=j.first(u.invisible(!0)))&&f.inArray(c.nodeName(),["ul","ol"]))(d.ie?new m(q.createTextNode("\u00a0")):new m(q.createElement("br"))).insertBefore(c);j&&k.moveToElementEditablePosition(j)}else{var h;if(e){if("li"==e.nodeName()||!n.test(e.nodeName()))h=
e.clone()}else j&&(h=j.clone());h||(h=new m("<p>",null,q));if(c=b.elementPath)for(var b=0,g=c.elements.length;b<g;b++){var l=c.elements[b];if(l.equals(c.block)||l.equals(c.blockLimit))break;p.$removeEmpty[l.nodeName()]&&(l=l.clone(),h._4e_moveChildren(l),h.append(l))}d.ie||h._4e_appendBogus();k.insertNode(h);if(d.ie&&a&&(!i||!e[0].childNodes.length))k.moveToElementEditablePosition(i?e:h),k.select();k.moveToElementEditablePosition(a&&!i?j:h)}d.ie||(j?(h=new m(q.createElement("span")),h.html("&nbsp;"),
k.insertNode(h),h.scrollIntoView(void 0,!1),k.deleteContents()):h.scrollIntoView(void 0,!1));k.select();return!0}function e(d){var e=d.get("document")[0];w.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){d.execCommand("save");var f=d.execCommand("enterBlock");d.execCommand("save");!1!==f&&e.preventDefault()}})}var d=f.UA,n=/^h[1-6]$/,p=k.XHTML_DTD,m=f.Node,w=f.Event;return{init:function(d){d.addCommand("enterBlock",{exec:q});d.docReady(function(){e(d)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(f){function k(){var e=this;e.__iframeFocus=p;n=e;d&&clearTimeout(d);d=setTimeout(function(){e.fire("focus")},100)}function u(){var e=this;e.__iframeFocus=m;n=w;d&&clearTimeout(d);d=setTimeout(function(){e.fire("blur")},100)}var r=f.Editor,q=f.Event,e={},d,n,f={refreshAll:function(){for(var d in e)if(e.hasOwnProperty(d)){var f=e[d].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return n},getInstance:function(d){return e[d]},
add:function(d){var e=d.get("window")[0];q.on(e,"focus",k,d);q.on(e,"blur",u,d)},register:function(d){e[d._UUID]=d},remove:function(d){delete e[d._UUID];var f=d.get("window")[0];q.remove(f,"focus",k,d);q.remove(f,"blur",u,d)}},p=!0,m=!1,w=null;f.refreshAll=f.refreshAll;r.focusManager=f;r.getInstances=function(){return e};return f},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(f,k){return{init:function(u){function r(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function q(a){return a.replace(x,function(a,c,b){return"<"+c+b.replace(v,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function e(a){return a.replace(b,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function d(c){return c.replace(a,function(a,c){return decodeURIComponent(c)})}var n=f.Node,p=f.UA,m=f.require("htmlparser"),w=new m.Filter,o=new m.Filter;(function(){function a(c){c=m.serialize(c);return new m.Comment(j+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,noscript:a,span:r}},b={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=
["name","href","src"],b,g=0;g<c.length;g++)b="_ke_saved_"+c[g],a.getAttribute(b)&&a.removeAttribute(c[g]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:r},attributes:{style:function(a){if(!f.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,j.length)==j)return a=f.trim(decodeURIComponent(a.substr(j.length))),m.parse(a).childNodes[0]}};p.ie&&(b.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});w.addRules(b);o.addRules(c)})();(function(){function a(c){for(var c=c.childNodes,b=c.length,g=c[b-1];g&&3==g.nodeType&&!f.trim(g.nodeValue);)g=c[--b];return g}function c(b,D){var h=a(b);h&&((D||!p.ie)&&1==h.nodeType&&"br"==h.nodeName?b.removeChild(h):
3==h.nodeType&&e.test(h.nodeValue)&&b.removeChild(h))}function b(c){var D=a(c);return!D||1==D.nodeType&&"br"==D.nodeName||"form"==c.nodeName&&"input"==D.nodeName}function h(a){c(a,!0);b(a)&&(p.ie?a.appendChild(new m.Text("\u00a0")):(a.appendChild(new m.Text("&nbsp;")),a.appendChild(new m.Tag("br"))))}function d(a){c(a,!1);b(a)&&a.appendChild(new m.Text("\u00a0"))}var e=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=k.XHTML_DTD,D=f.merge(i.$block,i.$listItem,i.$tableContent),z;for(z in D)D.hasOwnProperty(z)&&("br"in i[z]||
delete D[z]);delete D.td;delete D.pre;var i={tags:{}},I={tags:{}};for(z in D)D.hasOwnProperty(z)&&(i.tags[z]=h,I.tags[z]=d);o.addRules(i);w.addRules(I)})();w.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var x=/<(a|area|img|input)\b([^>]*)>/gi,v=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}",b=/(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,a=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,i=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
c=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,h=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;u.htmlDataProcessor={dataFilter:o,htmlFilter:w,toHtml:function(a){var c=new m.BeautifyWriter;(new m.Parser(a)).parse().writeHtml(c,w);return a=c.getHtml()},toDataFormat:function(a,b){var b=b||o,a=q(a),a=e(a),a=a.replace(i,"$1ke:$2"),a=a.replace(h,"<ke:$1$2></ke:$1>"),f=new n("<div>");f.html("a"+a);a=f.html().substr(1);a=a.replace(c,"$1$2");a=d(a);f=new m.BasicWriter;
(new m.Parser(a)).parse().writeHtml(f,b);return a=f.getHtml()},toServer:function(a){var c=new m.MinifyWriter;(new m.Parser(a)).parse().writeHtml(c,w);return c.getHtml()}}}}},{requires:["./base"]});
KISSY.add("editor/core/range",function(f,k,u,r,q){function e(b){var h=b.nodeType!=a.NodeType.TEXT_NODE&&a.nodeName(b)in c.$removeEmpty,g=b.nodeType==a.NodeType.TEXT_NODE&&!f.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return h||g||b}function d(a){return!s(a)&&!C(a)}function n(c){var b=x;return function(h){if(C(h))return o;if(h.nodeType==a.NodeType.TEXT_NODE){if(f.trim(h.nodeValue).length)return x}else if(h.nodeType==a.NodeType.ELEMENT_NODE&&(h=a.nodeName(h),!J[h]))if(!c&&!i.ie&&
"br"==h&&!b)b=o;else return x;return o}}function p(c,b){var g=c.startContainer,d=c.endContainer,t=c.startOffset,l=c.endOffset,e,i=x,f=x,s=void 0,j=c.document,P;0<b&&(s=j.createDocumentFragment());if(c.collapsed)return s;c.optimizeBookmark();d[0].nodeType==a.NodeType.TEXT_NODE?(f=o,d=d._4e_splitText(l)):0<d[0].childNodes.length&&(l>=d[0].childNodes.length?(d=new h(d[0].appendChild(j.createTextNode(""))),P=o):d=new h(d[0].childNodes[l]));g[0].nodeType==a.NodeType.TEXT_NODE?(i=o,g._4e_splitText(t)):
t?t>=g[0].childNodes.length?(g=new h(g[0].appendChild(j.createTextNode(""))),e=o):g=new h(g[0].childNodes[t].previousSibling):(e=new h(j.createTextNode("")),g.prepend(e),g=e,e=o);var n=g._4e_parents(),K=d._4e_parents();n.each(function(a,c){n[c]=a});K.each(function(a,c){K[c]=a});for(var G,M,j=0;j<n.length&&!(G=n[j],M=K[j],!G.equals(M));j++);for(var t=s,B,k,m=j;m<n.length;m++){B=n[m];l=0<b&&!B.equals(g)?t.appendChild(B.clone()[0]):null;B=B[0].nextSibling;k=K[m];for(var C=d[0],p=k&&k[0];B&&!(p==B||C==
B);)k=B.nextSibling,2==b?t.appendChild(B.cloneNode(o)):(a._4e_remove(B),1==b&&t.appendChild(B)),B=k;l&&(t=l)}for(t=s;j<K.length;j++){B=K[j];l=0<b&&!B.equals(d)?t.appendChild(B.clone()[0]):null;if(!n[j]||!B._4e_sameLevel(n[j]))for(B=B[0].previousSibling;B;)k=B.previousSibling,2==b?t.insertBefore(B.cloneNode(o),t.firstChild):(a._4e_remove(B),1==b&&t.insertBefore(B,t.firstChild)),B=k;l&&(t=l)}if(2==b){if(i&&(G=g[0],G.nodeType==a.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType==a.NodeType.TEXT_NODE&&
(G.data+=G.nextSibling.data,G.parentNode.removeChild(G.nextSibling))),f)f=d[0],f.nodeType==a.NodeType.TEXT_NODE&&f.previousSibling&&f.previousSibling.nodeType==a.NodeType.TEXT_NODE&&(f.previousSibling.data+=f.data,f.parentNode.removeChild(f))}else{if(G&&M&&(!g._4e_sameLevel(G)||!d._4e_sameLevel(M)))f=G._4e_index(),e&&G._4e_sameLevel(g)&&f--,c.setStart(G.parent(),f+1);c.collapse(o)}e&&g.remove();P&&d.remove();return s}function m(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function w(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=v;this.collapsed=o;this.document=a}k.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,x=!1,v=null,j=k.RANGE,b=k.POSITION,a=f.DOM,i=f.UA,c=k.XHTML_DTD,h=f.Node,g=h.all,l={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},s=new r.whitespaces,C=new r.bookmark,y=r.whitespaces(o),A=r.bookmark(!1,!0),J={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};f.augment(w,{toString:function(){var a=[],c=this.startContainer[0],b=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var c=
this.startContainer,b=this.startOffset;c[0].nodeType!=a.NodeType.ELEMENT_NODE&&(b?b>=c[0].nodeValue.length&&this.setStartAfter(c):this.setStartBefore(c));c=this.endContainer;b=this.endOffset;c[0].nodeType!=a.NodeType.ELEMENT_NODE&&(b?b>=c[0].nodeValue.length&&this.setEndAfter(c):this.setEndBefore(c))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,c=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);c&&"span"==c.nodeName()&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(c,b){c[0].nodeType==a.NodeType.ELEMENT_NODE&&l[c.nodeName()]&&(c=c.parent(),b=c._4e_index());this.startContainer=c;this.startOffset=b;this.endContainer||(this.endContainer=c,this.endOffset=b);m(this)},
setEnd:function(c,b){c[0].nodeType==a.NodeType.ELEMENT_NODE&&l[c.nodeName()]&&(c=c.parent(),b=c._4e_index()+1);this.endContainer=c;this.endOffset=b;this.startContainer||(this.startContainer=c,this.startOffset=b);m(this)},setStartAt:function(c,b){switch(b){case j.POSITION_AFTER_START:this.setStart(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==a.NodeType.TEXT_NODE?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(c);
break;case j.POSITION_AFTER_END:this.setStartAfter(c)}m(this)},setEndAt:function(c,b){switch(b){case j.POSITION_AFTER_START:this.setEnd(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==a.NodeType.TEXT_NODE?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(c);break;case j.POSITION_AFTER_END:this.setEndAfter(c)}m(this)},cloneContents:function(){return p(this,2)},deleteContents:function(){return p(this,0)},extractContents:function(){return p(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new w(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=a.NodeType.ELEMENT_NODE||
c.endContainer[0].nodeType!=a.NodeType.ELEMENT_NODE)return v;var b=new r(c);b.evaluator=function(a){return y(a)&&A(a)};c=b.next();b.reset();b=b.previous();return c&&c.equals(b)?c:v},shrink:function(c,b){if(!this.collapsed){var c=c||j.SHRINK_TEXT,g=this.clone(),h=this.startContainer,d=this.endContainer,l=this.startOffset,e=this.endOffset,f=o,i,s,n=o;h&&h[0].nodeType==a.NodeType.TEXT_NODE&&(l?l>=h[0].nodeValue.length?g.setStartAfter(h):(g.setStartBefore(h),f=x):g.setStartBefore(h));d&&d[0].nodeType==
a.NodeType.TEXT_NODE&&(e?e>=d[0].nodeValue.length?g.setEndAfter(d):(g.setEndAfter(d),n=x):g.setEndBefore(d));if(f||n)s=new r(g),s.evaluator=function(b){return b.nodeType==(c==j.SHRINK_ELEMENT?a.NodeType.ELEMENT_NODE:a.NodeType.TEXT_NODE)},s.guard=function(b,g){if(c==j.SHRINK_ELEMENT&&b.nodeType==a.NodeType.TEXT_NODE||g&&b==i)return x;!g&&b.nodeType==a.NodeType.ELEMENT_NODE&&(i=b);return o};f&&(g=s[c==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,b?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);
n&&(s.reset(),(s=s[c==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(s,b?j.POSITION_BEFORE_END:j.POSITION_AFTER_END));return f||n}},createBookmark2:function(c){var b=this.startContainer,g=this.endContainer,d=this.startOffset,t=this.endOffset,l,e;if(!b||!g)return{start:0,end:0};if(c){if(b[0].nodeType==a.NodeType.ELEMENT_NODE&&(l=new h(b[0].childNodes[d]))&&l[0]&&l[0].nodeType==a.NodeType.TEXT_NODE&&0<d&&l[0].previousSibling.nodeType==a.NodeType.TEXT_NODE)b=l,d=0;for(;b[0].nodeType==
a.NodeType.TEXT_NODE&&(e=b.prev(void 0,1))&&e[0].nodeType==a.NodeType.TEXT_NODE;)b=e,d+=e[0].nodeValue.length;if(!this.collapsed){if(g[0].nodeType==a.NodeType.ELEMENT_NODE&&(l=new h(g[0].childNodes[t]))&&l[0]&&l[0].nodeType==a.NodeType.TEXT_NODE&&0<t&&l[0].previousSibling.nodeType==a.NodeType.TEXT_NODE)g=l,t=0;for(;g[0].nodeType==a.NodeType.TEXT_NODE&&(e=g.prev(void 0,1))&&e[0].nodeType==a.NodeType.TEXT_NODE;)g=e,t+=e[0].nodeValue.length}}return{start:b._4e_address(c),end:this.collapsed?v:g._4e_address(c),
startOffset:d,endOffset:t,normalized:c,is2:o}},createBookmark:function(a){var c,b,g,d,l=this.collapsed;c=new h("<span>",v,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");a&&(g=f.guid("ke_bm_"),c.attr("id",g+"S"));l||(b=c.clone(),b.html("&nbsp;"),a&&b.attr("id",g+"E"),d=this.clone(),d.collapse(),d.insertNode(b));d=this.clone();d.collapse(o);d.insertNode(c);b?(this.setStartAfter(c),this.setEndBefore(b)):this.moveToPosition(c,j.POSITION_AFTER_END);return{startNode:a?
g+"S":c,endNode:a?g+"E":b,serializable:a,collapsed:l}},moveToPosition:function(a,c){this.setStartAt(a,c);this.collapse(o)},trim:function(c,b){var g=this.startContainer,h=this.startOffset,d=this.collapsed;if((!c||d)&&g[0]&&g[0].nodeType==a.NodeType.TEXT_NODE){if(h)if(h>=g[0].nodeValue.length)h=g._4e_index()+1,g=g.parent();else{var l=g._4e_splitText(h),h=g._4e_index()+1,g=g.parent();a.equals(this.startContainer,this.endContainer)?this.setEnd(l,this.endOffset-this.startOffset):a.equals(g,this.endContainer)&&
(this.endOffset+=1)}else h=g._4e_index(),g=g.parent();this.setStart(g,h);if(d){this.collapse(o);return}}g=this.endContainer;h=this.endOffset;!b&&!d&&g[0]&&g[0].nodeType==a.NodeType.TEXT_NODE&&(h?(h>=g[0].nodeValue.length||g._4e_splitText(h),h=g._4e_index()+1):h=g._4e_index(),g=g.parent(),this.setEnd(g,h))},insertNode:function(a){this.optimizeBookmark();this.trim(x,o);var c=this.startContainer;c[0].insertBefore(a[0],c[0].childNodes[this.startOffset]||null);c[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(a){var c=g(this.document);if(a.is2){var b=c._4e_getByAddress(a.start,a.normalized),h=a.startOffset,c=a.end&&c._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(b,h);c?this.setEnd(c,a):this.collapse(o)}else b=(h=a.serializable)?f.one("#"+a.startNode,c):a.startNode,a=h?f.one("#"+a.endNode,c):a.endNode,this.setStartBefore(b),b._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(o)},getCommonAncestor:function(c,b){var g=
this.startContainer,d=this.endContainer,g=g[0]==d[0]?c&&g[0].nodeType==a.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new h(g[0].childNodes[this.startOffset]):g:g._4e_commonAncestor(d);return b&&g[0].nodeType==a.NodeType.TEXT_NODE?g.parent():g},enlarge:function(){function c(b,h,d,l){var e=b[h?"startContainer":"endContainer"],f,i=h?0:1,j=0,n=h?"previousSibling":"nextSibling";f=b[h?"startOffset":"endOffset"];if(e[0].nodeType==a.NodeType.TEXT_NODE){if(h){if(f)return}else if(f<e[0].nodeValue.length)return;
f=e[0][n];e=e[0].parentNode}else f=e[0].childNodes[f+(h?-1:1)]||null,e=e[0];for(;e;){for(;f;)if(s(f)||C(f))f=f[n];else break;if(f){if(!j)b[h?"setStartAfter":"setEndBefore"](g(f));break}e=g(e);if("body"==e.nodeName())break;if(j||e.equals(l))d[i]=e,j=1;else b[h?"setStartBefore":"setEndAfter"](e);f=e[0][n];e=e[0].parentNode}}return function(b){switch(b){case j.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),d=[];c(this,1,d,b);c(this,0,d,b);d[0]&&d[1]&&(b=d[0].contains(d[1])?d[1]:
d[0],this.setStartBefore(b),this.setEndAfter(b));break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:var e=new w(this.document),d=new h(this.document.body);e.setStartAt(d,j.POSITION_AFTER_START);e.setEnd(this.startContainer,this.startOffset);var e=new r(e),l,f,i=r.blockBoundary(b==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:v),s=function(a){var c=i(a);c||(l=g(a));return c},n=function(c){var b=s(c);!b&&"br"==a.nodeName(c)&&(f=g(c));return b};e.guard=s;e=e.lastBackward();l=l||d;this.setStartAt(l,
"br"!=l.nodeName()&&(!e&&this.checkStartOfBlock()||e&&l.contains(e))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);e=this.clone();e.collapse();e.setEndAt(d,j.POSITION_BEFORE_END);e=new r(e);e.guard=b==j.ENLARGE_LIST_ITEM_CONTENTS?n:s;l=v;e=e.lastForward();l=l||d;this.setEndAt(l,!e&&this.checkEndOfBlock()||e&&l.contains(e)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);f&&this.setEndAfter(f)}}}(),checkStartOfBlock:function(){var c=this.startContainer,b=this.startOffset;if(b&&c[0].nodeType==a.NodeType.TEXT_NODE&&
f.trim(c[0].nodeValue.substring(0,b)).length)return x;this.trim();c=new q(this.startContainer);b=this.clone();b.collapse(o);b.setStartAt(c.block||c.blockLimit,j.POSITION_AFTER_START);c=new r(b);c.evaluator=n(o);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,b=this.endOffset;if(c[0].nodeType==a.NodeType.TEXT_NODE&&f.trim(c[0].nodeValue.substring(b)).length)return x;this.trim();c=new q(this.endContainer);b=this.clone();b.collapse(x);b.setEndAt(c.block||c.blockLimit,j.POSITION_BEFORE_END);
c=new r(b);c.evaluator=n(x);return c.checkForward()},checkBoundaryOfElement:function(c,a){var b=this.clone();b[a==j.START?"setStartAt":"setEndAt"](c,a==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);b=new r(b);b.evaluator=e;return b[a==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,h=this.endContainer,d=this.startOffset,e=this.endOffset,l;if(c[0].nodeType==a.NodeType.ELEMENT_NODE)if(l=c[0].childNodes.length,l>d)c=g(c[0].childNodes[d]);else if(0==
l)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=g(c);c=c._4e_nextSourceNode()||c}if(h[0].nodeType==a.NodeType.ELEMENT_NODE)if(l=h[0].childNodes.length,l>e)h=g(h[0].childNodes[e])._4e_previousSourceNode(o);else if(0==l)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=g(h)}c._4e_position(h)&b.POSITION_FOLLOWING&&(c=h);return{startNode:c,endNode:h}},fixBlock:function(c,a){var b=this.createBookmark(),h=g(this.document.createElement(a));this.collapse(c);
this.enlarge(j.ENLARGE_BLOCK_CONTENTS);h[0].appendChild(this.extractContents());h._4e_trim();i.ie||h._4e_appendBogus();this.insertNode(h);this.moveToBookmark(b);return h},splitBlock:function(c){var a=new q(this.startContainer),b=new q(this.endContainer),g=a.block,h=b.block,d=v;if(!a.blockLimit.equals(b.blockLimit))return v;"br"!=c&&(g||(g=this.fixBlock(o,c),h=(new q(this.endContainer)).block),h||(h=this.fixBlock(x,c)));c=g&&this.checkStartOfBlock();a=h&&this.checkEndOfBlock();this.deleteContents();
g&&g[0]==h[0]&&(a?(d=new q(this.startContainer),this.moveToPosition(h,j.POSITION_AFTER_END),h=v):c?(d=new q(this.startContainer),this.moveToPosition(g,j.POSITION_BEFORE_START),g=v):(h=this.splitElement(g),!i.ie&&!f.inArray(g.nodeName(),["ul","ol"])&&g._4e_appendBogus()));return{previousBlock:g,nextBlock:h,wasStartOfBlock:c,wasEndOfBlock:a,elementPath:d}},splitElement:function(c){if(!this.collapsed)return v;this.setEndAt(c,j.POSITION_BEFORE_END);var a=this.extractContents(),b=c.clone(x);b[0].appendChild(a);
b.insertAfter(c);this.moveToPosition(c,j.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(c,b){for(var g=0;c;){if(c[0].nodeType==a.NodeType.TEXT_NODE){this.moveToPosition(c,b?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);g=1;break}c[0].nodeType==a.NodeType.ELEMENT_NODE&&c._4e_isEditable()&&(this.moveToPosition(c,b?j.POSITION_BEFORE_END:j.POSITION_AFTER_START),g=1);var h=c,e=g,l=void 0;h[0].nodeType==a.NodeType.ELEMENT_NODE&&h._4e_isEditable()&&(l=h[b?"last":"first"](d,1));!e&&
!l&&(l=h[b?"prev":"next"](d,1));c=l}return!!g},selectNodeContents:function(c){var b=c[0];this.setStart(c,0);this.setEnd(c,b.nodeType==a.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,g,h,d=a.nodeName();b=c.$block[d];this.deleteContents();if(b){for(b=this.getCommonAncestor(x,o);(g=c[b.nodeName()])&&(!g||!g[d]);){var e=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(o),b.remove()):h=b;b=e}h&&this.splitElement(h)}this.insertNode(a)}});
u.injectDom({_4e_breakParent:function(c,a){var a=g(a),c=g(c),b,h=new k.Range(c[0].ownerDocument);h.setStartAfter(c);h.setEndAfter(a);b=h.extractContents();h.insertNode(c.remove());c.after(b)}});return k.Range=w},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(f){function k(c){this.document=c;this._={cache:{}};if(o)try{var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=c||a.parentElement&&a.parentElement().ownerDocument!=c)this.isInvalid=q}catch(b){this.isInvalid=q}}function u(c){c=new k(c);return!c||c.isInvalid?e:c}var r=f.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var q=!0,e=null,d=f.UA,n=f.DOM,p=f.Node,m=r.SELECTION,w=r.RANGE,o=d.ie,x=r.Walker,v=r.Range,
j={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};f.augment(k,{getNative:!o?function(){var c=this._.cache;return c.nativeSel||(c.nativeSel=n._getWin(this.document).getSelection())}:function(){var c=this._.cache;return c.nativeSel||(c.nativeSel=this.document.selection)},getType:!o?function(){var c=this._.cache;if(c.type)return c.type;var a=m.SELECTION_TEXT,b=this.getNative();if(b){if(1==b.rangeCount){var b=
b.getRangeAt(0),d=b.startContainer;d==b.endContainer&&d.nodeType==n.NodeType.ELEMENT_NODE&&1==Number(b.endOffset-b.startOffset)&&j[d.childNodes[b.startOffset].nodeName.toLowerCase()]&&(a=m.SELECTION_ELEMENT)}}else a=m.SELECTION_NONE;return c.type=a}:function(){var c=this._.cache;if(c.type)return c.type;var a=m.SELECTION_NONE;try{var b=this.getNative(),d=b.type;"Text"==d&&(a=m.SELECTION_TEXT);"Control"==d&&(a=m.SELECTION_ELEMENT);b.createRange().parentElement&&(a=m.SELECTION_TEXT)}catch(e){}return c.type=
a},getRanges:o?function(){var c=function(c,a){c=c.duplicate();c.collapse(a);for(var b=c.parentElement(),d=b.childNodes,f,i=0;i<d.length;i++){var j=d[i];if(j.nodeType==n.NodeType.ELEMENT_NODE){f=c.duplicate();f.moveToElementText(j);var j=f.compareEndPoints("StartToStart",c),k=f.compareEndPoints("EndToStart",c);f.collapse();if(0<j)break;else{if(!j||1==k&&-1==j)return{container:b,offset:i};if(!k)return{container:b,offset:i+1}}f=e}}f||(f=c.duplicate(),f.moveToElementText(b),f.collapse(!1));f.setEndPoint("StartToStart",
c);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=d[--i].nodeValue.length}catch(m){f=0}return 0===f?{container:b,offset:i}:{container:d[i],offset:-f}};return function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var d=this.getNative(),a=d&&d.createRange(),e=this.getType();if(!d)return[];if(e==m.SELECTION_TEXT)return d=new v(this.document),e=c(a,q),d.setStart(new p(e.container),e.offset),e=c(a),d.setEnd(new p(e.container),e.offset),b.ranges=[d];if(e==m.SELECTION_ELEMENT){b=
b.ranges=[];for(e=0;e<a.length;e++){for(var f=a.item(e),i=f.parentNode,j=0,d=new v(this.document);j<i.childNodes.length&&i.childNodes[j]!=f;j++);d.setStart(new p(i),j);d.setEnd(new p(i),j+1);b.push(d)}return b}return b.ranges=[]}}():function(c){var a=this._.cache;if(a.ranges&&!c)return a.ranges;var c=[],b=this.getNative();if(!b)return[];for(var d=0;d<b.rangeCount;d++){var e=b.getRangeAt(d),f=new v(this.document);f.setStart(new p(e.startContainer),e.startOffset);f.setEnd(new p(e.endContainer),e.endOffset);
c.push(f)}return a.ranges=c},getStartElement:function(){var c=this._.cache;if(void 0!==c.startElement)return c.startElement;var a,b=this.getNative();switch(this.getType()){case m.SELECTION_ELEMENT:return this.getSelectedElement();case m.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();q;)if(a=d.startContainer,d.startOffset==(a[0].nodeType===n.NodeType.ELEMENT_NODE?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break;a=d.startContainer;
if(a[0].nodeType!=n.NodeType.ELEMENT_NODE)return a.parent();a=new p(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=n.NodeType.ELEMENT_NODE)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==n.NodeType.ELEMENT_NODE;)a=new p(d),d=d.firstChild;return a}if(o)d=b.createRange(),d.collapse(q),a=new p(d.parentElement());else{if((a=b.anchorNode)&&a.nodeType!=n.NodeType.ELEMENT_NODE)a=a.parentNode;a&&(a=new p(a))}}return c.startElement=a},getSelectedElement:function(){var c,a=this._.cache;
if(void 0!==a.selectedElement)return a.selectedElement;o&&(c=this.getNative().createRange(),c=c.item&&c.item(0));if(c)c=new p(c);else{c=this.getRanges()[0];for(var b,d,e=2;e&&(!(b=c.getEnclosedNode())||!(b[0].nodeType==n.NodeType.ELEMENT_NODE&&j[b.nodeName()]&&(d=b)));e--)c.shrink(w.SHRINK_ELEMENT);c=d}return a.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,d=this.document;if(o)try{b=d.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=d.body.createTextRange(),
b.moveToElementText(a[0]),b.select()}finally{}else b=d.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select();this.reset()}else if(b=this.getNative()){b.removeAllRanges();for(var g=0;g<a.length;g++){var e=a[g],f=this.document.createRange(),i=e.startContainer;if(e.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&
i[0].nodeType==n.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(d.webkit?"\u200b":"")),e.startOffset++,e.endOffset++;f.setStart(i[0],e.startOffset);f.setEnd(e.endContainer[0],e.endOffset);b.addRange(f)}this.reset()}},createBookmarks2:function(a){for(var b=[],d=this.getRanges(),e=0;e<d.length;e++)b.push(d[e].createBookmark2(a));return b},createBookmarks:function(a,b){for(var d=[],e=this.document,i,b=b||this.getRanges(),j=b.length,k=0;k<j;k++){d.push(i=b[k].createBookmark(a,
q));var m=(a=i.serializable)?f.one("#"+i.startNode,e):i.startNode;i=a?f.one("#"+i.endNode,e):i.endNode;for(var p=k+1;p<j;p++){var o=b[p],r=o.startContainer,u=o.endContainer;n.equals(r,m.parent())&&o.startOffset++;n.equals(r,i.parent())&&o.startOffset++;n.equals(u,m.parent())&&o.endOffset++;n.equals(u,i.parent())&&o.endOffset++}}return d},selectBookmarks:function(a){for(var b=[],d=0;d<a.length;d++){var e=new v(this.document);e.moveToBookmark(a[d]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},a=x.whitespaces(q),i=/\ufeff|\u00a0/;v.prototype.select=v.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==n.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));
var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(q),b.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=u(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(c){var d=this.collapsed,g,e;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var f=this.startContainer[0].childNodes[this.startOffset];
if(f.nodeType==n.NodeType.ELEMENT_NODE){(new k(this.document)).selectElement(new p(f));return}}(this.startContainer[0].nodeType==n.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==n.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(w.SHRINK_ELEMENT,q);var j=this.createBookmark(),f=j.startNode,m;d||(m=j.endNode);j=this.document.body.createTextRange();j.moveToElementText(f[0]);j.moveStart("character",1);if(m)c=this.document.body.createTextRange(),
c.moveToElementText(m[0]),j.setEndPoint("EndToEnd",c),j.moveEnd("character",-1);else{for(g=f[0].nextSibling;g&&!a(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(i))&&(c||!f[0].previousSibling||f[0].previousSibling&&"br"==n.nodeName(f[0].previousSibling));e=new p(this.document.createElement("span"));e.html("&#65279;");e.insertBefore(f);g&&n.insertBefore(this.document.createTextNode("\ufeff"),f[0]||f)}this.setStartBefore(f);f._4e_remove();if(d){if(g?(j.moveStart("character",-1),j.select(),this.document.selection.clear()):
j.select(),e)this.moveToPosition(e,w.POSITION_BEFORE_START),e._4e_remove()}else this.setEndBefore(m),m._4e_remove(),j.select()};k.getSelection=u;return r.Selection=k},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(f,k){function u(d){function b(a,b){var c=g.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=p}return c}function a(){var b=g.selection.createRange();l&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&l.select();w.remove(g,"mouseup",a);w.remove(g,"mousemove",e);l=c=0}function e(c){if(c.button){if(c=b(c.pageX,c.pageY))0<c.compareEndPoints("StartToStart",l)?c.setEndPoint("StartToStart",l):c.setEndPoint("EndToEnd",l),c.select()}else a()}var c,f=d.get("window")[0],
g=d.get("document")[0],l;w.on(g,"mousedown contextmenu",function(d){var j=g.documentElement;if(d.target===j&&(c&&a(),!(j.scrollHeight>j.clientHeight)&&(c=1,l=b(d.pageX,d.pageY))))w.on(g,"mouseup",a),w.on(g,"mousemove",e),f.focus(),l.select()})}function r(e){function b(c){if(g){var f=e.getSelection(),i=f&&f.getType(),l=f&&a.selection;if(c&&l&&i==v.SELECTION_NONE&&!a.queryCommandEnabled("InsertImage"))setTimeout(function(){b(d)},50);else{var n;if(!l||!l.type||!("Control"!=l.type&&(n=l.createRange())&&
(n=n.parentElement())&&(n=n.nodeName)&&n.toLowerCase()in{input:1,textarea:1}))h=l&&f.getRanges()[0],e.checkSelectionChange()}}}var a=e.get("document")[0],f=new x(a.body),c=new x(a.documentElement);if(8>k.Utils.ieEngine)c.on("click",function(a){"html"===(new x(a.target)).nodeName()&&e.getSelection().getNative().createRange().select()});var h,g,l=d;c.on("mousedown",function(){l=n});c.on("mouseup",function(){l=d});f.on("focusin",function(a){if("body"==(new x(a.target)).nodeName()&&h){try{l&&h.select()}catch(b){}h=
p}});f.on("focus",function(){g=d;b()});f.on("beforedeactivate",function(a){a.relatedTarget||(g=n,l=d)});f.on("mousedown",function(){g=n});f.on("mouseup",function(){g=d;setTimeout(function(){b(d)},0)});f.on("keydown",function(){g=n});f.on("keyup",function(){g=d;setTimeout(function(){b()},0)})}function q(d){var b=d.get("document")[0];w.on(b,"mouseup keyup",function(){d.checkSelectionChange()})}function e(e){function b(a){var b=k.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}function a(a){return c(a)&&
h(a)}var f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,c=k.Walker.whitespaces(d),h=k.Walker.bookmark(n,d),g=function(a){return c(a)&&8!=a.nodeType};e.on("selectionChange",function(c){var h=c.path,p=new x(e.get("document")[0].body),c=(c=c.selection)&&c.getRanges()[0],q=h.blockLimit;if(m.gecko){var r=h.block||h.blockLimit,u=r&&r.last(a);r&&r._4e_isBlockBoundary()&&(!u||!(1==u[0].nodeType&&u._4e_isBlockBoundary()))&&
"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(c&&c.collapsed&&!h.block){if("body"==q.nodeName()){if((h=c.fixBlock(d,"p"))&&h[0]!=p[0].lastChild&&h._4e_outerHtml().match(f))if((q=h.next(g,1))&&q[0].nodeType==o.NodeType.ELEMENT_NODE&&!b[q])c.moveToElementEditablePosition(q),h._4e_remove();else if((q=h.prev(g,1))&&q[0].nodeType==o.NodeType.ELEMENT_NODE&&!b[q])c.moveToElementEditablePosition(q,q._4e_outerHtml().match(f)?n:d),h._4e_remove();c.select();e.notifySelectionChange()}h=e.get("document")[0];
c=new k.Range(h);c.moveToElementEditablePosition(p,d);"body"!==(new k.ElementPath(c.startContainer)).blockLimit.nodeName()&&(p=(new x(h.createElement("p"))).appendTo(p),m.ie||p._4e_appendBogus())}})}var d=!0,n=!1,p=null,m=f.UA,w=f.Event,o=f.DOM,x=f.Node,v=k.SELECTION;return{init:function(d){d.docReady(function(){m.ie?(u(d),r(d)):q(d)});e(d)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(f,k){function u(a){return!y.attr(a,"_ke_bookmark")}function r(a,b){for(var c in a)a.hasOwnProperty(c)&&(f.isString(a[c])?a[c]=a[c].replace(Q,function(a,c){return b[c]}):r(a[c],b))}function q(a,b){b&&(a=f.clone(a),r(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==c||E[c]?A.STYLE_BLOCK:N[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function e(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new D(a),e=d.getRanges(),g=0;g<e.length;g++)c.call(this,e[g]);d.selectRanges(e)}function d(a,b,c){var d=a.element;"*"==d&&(d="span");b=new H(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=q.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function n(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var e,g=a.document;e=c.getNextParagraph();){var f=d(this,g,
e),h=f,f="pre"==h.nodeName,i="pre"==e.nodeName,j=!f&&i;f&&!i?(i=e,j=i.html(),j=p(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),t.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(h[0]),h[0].outerHTML="<pre>"+j+"</pre>",h=new H(i.firstChild),h._4e_remove()):h.html(j)):j?h=w(m(e),h):e._4e_moveChildren(h);e[0].parentNode.replaceChild(h[0],e[0]);if(f&&(e=h,f=void 0,(f=e._4e_previousSourceNode(l,
y.NodeType.ELEMENT_NODE))&&"pre"==f.nodeName()))h=p(f.html(),/\n$/,"")+"\n\n"+p(e.html(),/^\n/,""),t.ie?e[0].outerHTML="<pre>"+h+"</pre>":e.html(h),f._4e_remove()}a.moveToBookmark(b)}function p(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function m(a){var b=[];p(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+
"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function w(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=p(e,/^[ \t]*\n/,""),e=p(e,/\n$/,""),e=p(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),g=b.clone();g.html(e);c.appendChild(g[0])}return c}function o(a){var b=a.document;if(a.collapsed)b=d(this,b,void 0),a.insertNode(b),a.moveToPosition(b,J.POSITION_BEFORE_END);else{var e=this.element,g=this._.definition,f,h=L[e];h||(f=l,h=L.span);var i=a.createBookmark();a.enlarge(J.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),n=j.startNode,j=j.endNode,k=n,F;k&&k[0];){var m=s;if(y.equals(k,j))k=C,m=l;else{var E=k[0].nodeType,p=E==y.NodeType.ELEMENT_NODE?k.nodeName():C;if(p&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(l);continue}if(!p||h[p]&&(k._4e_position(j)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(k))){var o=k.parent();if(o&&"a"==e&&o.nodeName()==e)E=d(this,b,void 0),o._4e_moveChildren(E),o[0].parentNode.replaceChild(E[0],o[0]),E._4e_mergeSiblings();else if(o&&o[0]&&((L[o.nodeName()]||L.span)[e]||f)&&(!g.parentRule||g.parentRule(o))){if(!F&&(!p||!L.$removeEmpty[p]||(k._4e_position(j)|
z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))F=new I(b),F.setStartBefore(k);if(E==y.NodeType.TEXT_NODE||E==y.NodeType.ELEMENT_NODE&&!k[0].childNodes.length){o=k;for(E=null;(m=!o.next(u,1))&&(E=o.parent())&&h[E.nodeName()]&&(E._4e_position(n)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(E));)o=
E;F.setEndAfter(o)}}else m=l}else m=l;k=k._4e_nextSourceNode()}if(m&&F&&!F.collapsed){for(var m=d(this,b,void 0),o=F.getCommonAncestor(),E={},p={},q,r=null,v;m&&o&&m[0]&&o[0];){if(o.nodeName()==e){for(q in g.attributes)if(g.attributes.hasOwnProperty(q)&&!p[q]&&(v=o.attr(r)))m.attr(q)==v?m.removeAttr(q):p[q]=1;for(r in g.styles)if(g.styles.hasOwnProperty(r)&&!E[r]&&(v=o.style(r)))m.style(r)==v?m.style(r,""):E[r]=1;if(!m._4e_hasAttributes()){m=C;break}}o=o.parent()}m?(m[0].appendChild(F.extractContents()),
c(this,m),F.insertNode(m),m._4e_mergeSiblings(),t.ie||m[0].normalize()):(m=new H(b.createElement("span")),m[0].appendChild(F.extractContents()),F.insertNode(m),c(this,m),m._4e_remove(!0));F=C}}n._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(J.SHRINK_TEXT)}}function x(c){c.enlarge(J.ENLARGE_ELEMENT);var d=c.createBookmark(),e=d.startNode;if(c.collapsed){for(var g=new F(e.parent()),f,i=0,j;i<g.elements.length&&(j=g.elements[i])&&!(j==g.block||j==g.blockLimit);i++)if(this.checkElementRemovable(j)){var t=
c.checkBoundaryOfElement(j,J.END),l=!t&&c.checkBoundaryOfElement(j,J.START);l||t?(f=j,f.match=l?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(t=b(this),h(j,t[j.nodeName()]||t["*"])):a(this,j))}if(f){j=e;for(i=0;;i++){t=g.elements[i];if(y.equals(t,f))break;else if(t.match)continue;else t=t.clone();t[0].appendChild(j[0]);j=t}j["start"==f.match?"insertBefore":"insertAfter"](f)}}else{var n=d.endNode,k=this,g=function(){for(var a=new F(e.parent()),b=new F(n.parent()),c=C,d=C,g=0;g<
a.elements.length;g++){var f=a.elements[g];if(f==a.block||f==a.blockLimit)break;k.checkElementRemovable(f)&&(c=f)}for(g=0;g<b.elements.length;g++){f=b.elements[g];if(f==b.block||f==b.blockLimit)break;k.checkElementRemovable(f)&&(d=f)}d&&n._4e_breakParent(d);c&&e._4e_breakParent(c)};g();for(f=new H(e[0].nextSibling);f[0]!==n[0];){i=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==y.NodeType.ELEMENT_NODE&&this.checkElementRemovable(f)&&(f.nodeName()==this.element?a(this,f):(j=b(this),h(f,j[f.nodeName()]||
j["*"])),i[0].nodeType==y.NodeType.ELEMENT_NODE&&i.contains(e)))g(),i=new H(e[0].nextSibling);f=i}}c.moveToBookmark(d)}function v(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function j(a,b){var c="";b!==s?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;
var b=a._.overrides={},c=a._.definition.overrides;if(c){f.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var e=c[d],g,h,i;"string"==typeof e?g=e.toLowerCase():(g=e.element?e.element.toLowerCase():a.element,h=e.attributes,i=e.styles);e=b[g]||(b[g]={});if(h){g=e.attributes=e.attributes||[];for(var j in h)h.hasOwnProperty(j)&&g.push([j.toLowerCase(),h[j]])}if(i){var e=e.styles=e.styles||[],t;for(t in i)i.hasOwnProperty(t)&&e.push([t.toLowerCase(),i[t]])}}}return b}function a(a,c){var e=a._.definition,
d=b(a),h=f.merge(e.attributes,(d[c.nodeName()]||d["*"]||{}).attributes),e=f.merge(e.styles,(d[c.nodeName()]||d["*"]||{}).styles),d=f.isEmptyObject(h)&&f.isEmptyObject(e),j;for(j in h)if(h.hasOwnProperty(j)&&!(("class"==j||a._.definition.fullMatch)&&c.attr(j)!=i(j,h[j])))d=d||!!c.hasAttr(j),c.removeAttr(j);for(var t in e)e.hasOwnProperty(t)&&!(a._.definition.fullMatch&&c.style(t)!=i(t,e[t],l))&&(d=d||!!c.style(t),c.style(t,""));g(c)}function i(a,c,b){var d=new H("<span>");d[b?"style":"attr"](a,c);
return d[b?"style":"attr"](a)}function c(c,d){for(var e=b(c),g=d.all(c.element),f=g.length;0<=--f;)a(c,new H(g[f]));for(var i in e)if(e.hasOwnProperty(i)&&i!=c.element){g=d.all(i);for(f=g.length-1;0<=f;f--){var j=new H(g[f]);h(j,e[i])}}}function h(a,c){var b,d=c&&c.attributes;if(d)for(b=0;b<d.length;b++){var e=d[b][0],f;if(f=a.attr(e)){var h=d[b][1];(h===C||h.test&&h.test(f)||"string"==typeof h&&f==h)&&a[0].removeAttribute(e)}}if(d=c&&c.styles)for(b=0;b<d.length;b++)if(e=d[b][0],h=a.css(e)){var i=
d[b][1];(i===C||i.test&&i.test(f)||"string"==typeof i&&h==i)&&a.css(e,"")}g(a)}function g(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(l);c&&(c.nodeType==y.NodeType.ELEMENT_NODE&&y._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==y.NodeType.ELEMENT_NODE&&y._4e_mergeSiblings(b))}}var l=!0,s=!1,C=null,y=f.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},J=k.RANGE,D=k.Selection,z=k.POSITION,I=k.Range,H=f.Node,t=f.UA,F=k.ElementPath,E={address:1,div:1,h1:1,h2:1,h3:1,h4:1,
h5:1,h6:1,p:1,pre:1},L=k.XHTML_DTD,N={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,Q=/#\((.+?)\)/g;k.STYLE=A;q.prototype={apply:function(a){e.call(this,a,s)},remove:function(a){e.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?o:this.type==A.STYLE_BLOCK?n:C).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?x:C).call(this,a)},checkElementRemovable:function(a,
c){if(!a)return s;var d=this._.definition,e;if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return l;var g=d._AC;if(g)d=g;else{var g={},f=0,h=d.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(f++,g[i]=h[i]);if(h=q.getStyleText(d))g.style||f++,g.style=h;g._length=f;d=d._AC=g}if(d._length){for(var t in d)if("_length"!=t&&d.hasOwnProperty(t)){f=a.attr(t)||"";if("style"==t)a:{g=d[t];f=j(f,s);"string"==typeof g&&(g=v(g));"string"==typeof f&&(f=v(f));h=void 0;for(h in g)if(g.hasOwnProperty(h)&&
!(h in f&&(f[h]==g[h]||"inherit"==g[h]||"inherit"==f[h]))){g=s;break a}g=l}else g=d[t]==f;if(g){if(!c)return l}else if(c)return s}if(c)return l}else return l}t=b(this);if(t=t[a.nodeName()]||t["*"]){if(!(d=t.attributes)&&!(e=t.styles))return l;if(d)for(g=0;g<d.length;g++)if(t=d[g][0],t=a.attr(t))if(f=d[g][1],f===C||"string"==typeof f&&t==f||f.test&&f.test(t))return l;if(e)for(g=0;g<e.length;g++)if(t=a.css(e[g][0]))if(d=e[g][1],d===C||"string"==typeof d&&t==d||d.test&&d.test(t))return l}return s},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,l);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var c=a.elements,b=0,d;b<c.length;b++)if(d=c[b],!(this.type==A.STYLE_INLINE&&(y.equals(d,a.block)||y.equals(d,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||d.nodeName()in N)&&this.checkElementRemovable(d,l))return l}return s}};q.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,b=a.attributes&&a.attributes.style||"",d="";b.length&&(b=b.replace(O,";"));for(var e in c)if(c.hasOwnProperty(e)){var g=c[e],f=(e+":"+g).replace(O,
";");"inherit"==g?d+=f:b+=f}b.length&&(b=j(b));return a._ST=b+d};return k.Style=q},{requires:["./base","./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(f){var k=f.Node,u=f.DOM,r=f.UA,q={debugUrl:function(e){var d=f.Config;d.debug||(e=e.replace(/\.(js|css)/i,"-min.$1"));-1==e.indexOf("?t")&&(e=-1!=e.indexOf("?")?e+"&":e+"?",e+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+e},lazyRun:function(e,d,f){var k=e[d],m=e[f];e[d]=function(){k.apply(this,arguments);e[d]=e[f];return m.apply(this,arguments)}},getXY:function(e,d){var f=e.left,k=e.top,m=d.get("window")[0],f=f-u.scrollLeft(m),k=k-u.scrollTop(m),m=
d.get("iframe").offset(),f=f+m.left,k=k+m.top;return{left:f,top:k}},tryThese:function(e){for(var d,f=0,k=arguments.length;f<k;f++){var m=arguments[f];try{d=m();break}catch(q){}}return d},arrayCompare:function(e,d){if(!e&&!d)return!0;if(!e||!d||e.length!=d.length)return!1;for(var f=0;f<e.length;f++)if(e[f]!==d[f])return!1;return!0},clearAllMarkers:function(e){for(var d in e)e.hasOwnProperty(d)&&e[d]._4e_clearMarkers(e,!0,void 0)},ltrim:function(e){return e.replace(/^\s+/,"")},rtrim:function(e){return e.replace(/\s+$/,
"")},isNumber:function(e){return/^\d+(.\d+)?$/.test(f.trim(e))},verifyInputs:function(e){for(var d=0;d<e.length;d++){var n=new k(e[d]),p=f.trim(q.valInput(n)),m=n.attr("data-verify"),n=n.attr("data-warning");if(m&&!RegExp(m).test(p))return alert(n),!1}return!0},sourceDisable:function(e,d){e.on("sourceMode",d.disable,d);e.on("wysiwygMode",d.enable,d)},resetInput:function(e){var d=e.attr("placeholder");d&&r.ie?(e.addClass("ks-editor-input-tip"),e.val(d)):r.ie||e.val("")},valInput:function(e,d){if(void 0===
d)return e.hasClass("ks-editor-input-tip")?"":e.val();e.removeClass("ks-editor-input-tip");e.val(d)},placeholder:function(e,d){e.attr("placeholder",d);r.ie&&(e.on("blur",function(){f.trim(e.val())||(e.addClass("ks-editor-input-tip"),e.val(d))}),e.on("focus",function(){e.removeClass("ks-editor-input-tip");f.trim(e.val())==d&&e.val("")}))},htmlEncode:function(e){return!e?e:(""+e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(e){var e=f.clone(e),
d;for(d in e)if(e.hasOwnProperty(d)){var k=e[d];f.isFunction(k)&&(e[d]=k())}return e},map:function(e,d){for(var f=0;f<e.length;f++)e[f]=d(e[f]);return e},ieEngine:document.documentMode||r.ie,preventFocus:function(e){r.ie?e.unselectable(void 0):e.attr("onmousedown","return false;")},injectDom:function(e){f.mix(u,e);for(var d in e)e.hasOwnProperty(d)&&function(d){k.prototype[d]=function(){var p=[].slice.call(arguments,0);p.unshift(this[0]);return(p=e[d].apply(null,p))&&(p.nodeType||f.isWindow(p))?new k(p):
f.isArray(p)&&(p.__IS_NODELIST||p[0]&&p[0].nodeType)?new k(p):p}}(d)},addRes:function(){var e=this.__res=this.__res||[];e.push.apply(e,f.makeArray(arguments))},destroyRes:function(){for(var e=this.__res||[],d=0;d<e.length;d++){var k=e[d];f.isFunction(k)?k():k.destroy?k.destroy():k.remove&&k.remove()}this.__res=[]},getQueryCmd:function(e){return"query"+("-"+e).replace(/-(\w)/g,function(d,e){return e.toUpperCase()})+"Value"}};return f.Editor.Utils=q},{requires:["./base"]});
KISSY.add("editor/core/walker",function(f,k){function u(a,b){if(this._.end)return n;var c,f=this.range,g,j=this.guard,k=this.type,p=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),n;if(!a&&!this._.guardLTR){var q=f.endContainer[0],r=q.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(q==a||"body"==m.nodeName(a))?!1:a!=r}}if(a&&!this._.guardRTL){var u=f.startContainer[0],v=0<f.startOffset&&u.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(u==a||"body"==m.nodeName(a))?!1:a!=v}}var w=a?this._.guardRTL:this._.guardLTR;g=j?function(a,b){return w(a,b)===d?d:j(a,b)}:w;this.current?c=this.current[p](d,k,g):a?(c=f.endContainer,0<f.endOffset?(c=new o(c[0].childNodes[f.endOffset-1]),g(c[0])===d&&(c=n)):c=g(c,e)===d?n:c._4e_previousSourceNode(e,k,g,void 0)):(c=f.startContainer,c=new o(c[0].childNodes[f.startOffset]),c.length?g(c[0])===d&&(c=n):c=g(f.startContainer,e)===d?n:f.startContainer._4e_nextSourceNode(e,
k,g,void 0));for(;c&&!this._.end;){this.current=c;if(!this.evaluator||this.evaluator(c[0])!==d){if(!b)return c}else if(b&&this.evaluator)return d;c=c[p](d,k,g)}this.end();return this.current=n}function r(a){for(var b,c=n;b=u.call(this,a);)c=b;return c}function q(a){this.range=a;this.guard=this.evaluator=n;this._={}}var e=!0,d=!1,n=null,p=f.UA,m=f.DOM,w=k.XHTML_DTD,o=f.Node;f.augment(q,{end:function(){this._.end=1},next:function(){return u.call(this)},previous:function(){return u.call(this,e)},checkForward:function(){return u.call(this,
d,e)!==d},checkBackward:function(){return u.call(this,e,e)!==d},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,e)},reset:function(){delete this.current;this._={}},_iterator:u});f.mix(q,{blockBoundary:function(a){return function(b){return!(b.nodeType==m.NodeType.ELEMENT_NODE&&m._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==m.nodeName(a)&&m.attr(a,"_ke_bookmark")}return function(d){var e,f;e=d.nodeType==m.NodeType.TEXT_NODE&&(f=
d.parentNode)&&c(f);e=a?e:e||c(d);return!!(b^e)}},whitespaces:function(a){return function(b){b=b.nodeType==m.NodeType.TEXT_NODE&&!f.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=q.whitespaces();return function(c){c=b(c)||c.nodeType==m.NodeType.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,v=q.whitespaces(),j=q.bookmark(),b=function(a){var b=m.nodeName(a);return j(a)||v(a)||1==a.nodeType&&b in w.$inline&&!(b in w.$empty)};k.Utils.injectDom({_4e_getBogus:function(a){a=
new o(a);do a=a._4e_previousSourceNode();while(a&&b(a[0]));a=a&&(!p.ie?"br"==a.nodeName():3==a[0].nodeType&&x.test(a.text()))?a[0]:!1;return a}});return k.Walker=q},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(f){var k=f.Editor,f=k.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};k.baseZIndex=function(f){return(k.Config.baseZIndex||1E4)+f};return f},{requires:["./base"]});
KISSY.add("editor",function(f,k,u,r,q,e,d,n,p,m){function w(a,d){var e=a.body;J(function(){a.designMode="on";setTimeout(function(){a.designMode="off";e.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";s.attr(e,"contentEditable",c);s.attr(e,"contentEditable",b);!d&&w(a,1)})}function o(a){a.get("iframe");var b=a.get("textarea")[0],d=a.get("window")[0],e=a.get("document")[0];g.webkit&&(A.on(e,"click",function(a){var b=new y(a.target);f.inArray(b.nodeName(),
["input","select"])&&a.preventDefault()}),A.on(e,"mouseup",function(a){var b=new y(a.target);f.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(g.gecko||l||g.opera){var h;h=(new y('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);h.on("focus",function(){a.focus()});a.activateGecko=function(){g.gecko&&a.__iframeFocus&&h[0].focus()};a.on("destroy",function(){h.detach();h.remove()})}A.on(d,"focus",function(){g.gecko?w(e,c):g.opera&&
e.body.focus();a.notifySelectionChange()});if(g.gecko)A.on(e,"mousedown",function(){a.__iframeFocus||w(e,c)});if(l&&(A.on(e,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}}),"CSS1Compat"==e.compatMode)){var i={33:1,34:1};A.on(e,"keydown",function(b){b.keyCode in i&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(g.webkit)A.on(e,"mousedown",function(b){b=new y(b.target);f.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(g.gecko)A.on(e,"dragstart",function(a){var b=new y(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(a)}function x(a,b,c,d){var e="",g,i=u.debugUrl("theme/editor-iframe.css");for(g=0;g<c.length;g++)e+=f.substitute('<link href="{href}" rel="stylesheet" />',{href:c[g]});return f.substitute(D,{doctype:8===
h.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:i,style:b,data:d||"&nbsp;",script:a?'<script id="ke_active_script">'+(s.isCustomDomain()?'document.domain="'+h.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function v(a,b){function c(){h=g.document;a.__set("document",new y(h));a.__set("window",new y(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=x(a._UUID,a.get("customStyle"),a.get("customLink"),
b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(i){if(f.src=f.src,7>l){setTimeout(c,10);return}}c()}function j(a,b){var c=s.getEmptyIframeSrc()||"";c&&(c=' src="'+c+'" ');var c=new y(f.substitute(z,{iframeSrc:c})),d=a.get("textarea");d.hasAttr("tabindex")&&c.attr("tabIndex",g.webkit?-1:d.attr("tabIndex"));d.parent().prepend(c);a.set("iframe",c);a.__docReady=0;if(g.gecko&&!c.__loaded)c.on("load",function(){v(a,b)},a);else v(a,b)}var b=!0,a=a,i=f.all,c=!1,h=document,g=f.UA,l=g.ie,
s=f.DOM,C=s.NodeType,y=f.Node,A=f.Event,J=u.tryThese,D="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",z='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>';f.mix(k,{SOURCE_MODE:0,WYSIWYG_MODE:1});var I=k.WYSIWYG_MODE;f.augment(k,{createDom:function(){var a,b=this.get("textarea"),
c;b||this.set("textarea",b=i("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');a=c.one(".ks-editor-textarea-wrap");this._UUID=f.guid();this.set({toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display","none");a.append(b);r.register(this)},renderUI:function(){d.init(this);n.init(this);
p.init(this);m.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))s.on(c,"submit",b.sync,b),b.on("destroy",function(){s.detach(c,"submit",b.sync,b)});b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},_uiSetHeight:function(a){var b=
this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("rendered"),e=b.get("iframe"),f=b.get("textarea");a==I?(d&&b.execCommand("save"),b.on("docReady",c=function(){d&&b.execCommand("save");b.detach("docReady",c)}),b._setData(f.val()),b.fire("wysiwygMode")):(e&&(f.val(b._getData(1,I)),e.hide()),f.show(),b.fire("sourceMode"))},
_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();r.remove(this);A.remove([a,a.documentElement,a.body,b[0]]);f.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];
c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=f.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},queryCommandValue:function(a){return this.execCommand(u.getQueryCmd(a))},_getData:function(b,c){var d=this.htmlDataProcessor,e;c==a&&(c=this.get("mode"));e=c==I?this.get("document")[0].body.innerHTML:
d.toDataFormat(this.get("textarea").val());e=b?d.toHtml(e):d.toServer(e);e=f.trim(e);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(e)&&(e="");return e},_setData:function(a){var b,c=a;if(this.get("mode")!=I)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var d=this.get("document")[0];A.remove([d,d.documentElement,d.body,b]);a.remove()}j(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},
getDocHtml:function(){return x(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return k.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];g.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||
"",c=c+("\n"+a);this.set("customStyle",c);s.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){s.remove(s.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=s.query("link",b),c=0;c<b.length;c++)s.attr(b[c],"href")==
a&&s.remove(b[c]);b=this.get("customLink")||[];a=f.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new k.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",
{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(c){if(this.get("mode")===I){this.focus();var d,e=c.nodeName(),f=k.XHTML_DTD,g=f.$block[e],h=k.RANGE,i=(e=this.getSelection())&&e.getRanges(),j,l,m;if(i&&0!=i.length){this.execCommand("save");for(l=i.length-1;0<=l;l--)j=i[l],d=!l&&c||c.clone(b),j.insertNodeByDtd(d),m||(m=d);if(m)return j.moveToPosition(m,h.POSITION_AFTER_END),g&&(c=k.Walker.whitespaces(!0),
(c=(m=m.next(c,1))&&m[0].nodeType==C.ELEMENT_NODE&&m.nodeName())&&f.$block[c]&&f[c]["#text"]&&j.moveToElementEditablePosition(m)),e.selectRanges([j]),this.focus(),d&&1==d[0].nodeType&&d.scrollIntoView(a,!1),H.call(this),d}}},insertHtml:function(b,d){var e=this,f,g=e.get("document")[0];if(e.get("mode")===I){if(f=e.htmlDataProcessor)b=f.toDataFormat(b,d);e.focus();e.execCommand("save");if(l){f=g.selection;"Control"==f.type&&f.clear();try{f.createRange().pasteHTML(b)}catch(h){}}else try{g.execCommand("inserthtml",
c,b)}catch(i){setTimeout(function(){if(0==e.getSelection().getRanges().length){var d=new k.Range(g),f=s.first(g.body,function(a){return 1==a.nodeType&&"br"!=s.nodeName(a)});f||(f=new y(g.createElement("p")),f._4e_appendBogus(a),g.body.appendChild(f[0]));d.setStartAt(f,k.RANGE.POSITION_AFTER_START);d.select()}g.execCommand("inserthtml",c,b)},50)}setTimeout(function(){e.getSelection().scrollIntoView()},50);H.call(e)}}});k._initIFrame=function(a){var d=r.getInstance(a),e=d.get("document")[0],a=e.getElementById("ke_active_script");
s.remove(a);o(d);var f=e.body;l?(f.hideFocus=b,f.disabled=b,f.contentEditable=b,f.removeAttribute("disabled")):setTimeout(function(){g.gecko||g.opera?f.contentEditable=b:g.webkit?f.parentNode.contentEditable=b:e.designMode="on"},0);if(g.gecko||g.opera){var h=e.documentElement;A.on(h,"mousedown",function(a){if(a.target==h){g.gecko&&w(e,c);d.activateGecko()}})}setTimeout(function(){l&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.__docReady=
1;d.fire("docReady");var a=d.get("disableObjectResizing"),b=d.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",c,!a);e.execCommand("enableInlineTableEditing",c,!b)}catch(g){A.on(f,l?"resizestart":"resize",function(c){var d=new y(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var H=f.buffer(function(){this.execCommand("save")},50);return k},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
