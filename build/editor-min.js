/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 28 19:44
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(e,r,t){r=t.define(t.Controller,[t.UIBase.Box],{initializer:function(){var e;this.__commands={};this.__dialogs={};if(e=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var k=e.next();k?this.__set("elBefore",k):this.__set("render",e.parent())}}else this.__editor_created_new=1},use:function(m,k){var c=this,n=c.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"];e.isString(m)&&(m=m.split(","));for(var i=m.length-1;0<=i;i--)m[i]||
m.splice(i,1);for(i=0;i<n.length;i++){var u=n[i];e.inArray(u,m)||m.unshift(u)}e.each(m,function(c,e){m[e]&&(m[e]="editor/plugin/"+c+"/")});e.use(m,function(){var i,n=e.makeArray(arguments);n.shift();for(var o=0;o<n.length;o++)n[o]&&n[o].init(c);k&&k.call(c);(i=c.get("height"))&&c._uiSetHeight(i)});c.__CORE_PLUGINS=[];return c}},{Config:{},XHTML_DTD:r.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},
mode:{value:1},data:{getter:function(){return this._getData()},setter:function(e){return this._setData(e)}},formatData:{getter:function(){return this._getData(1)},setter:function(e){return this._setData(e)}},prefixCls:{value:"ke-"}}},"Editor");e.mix(r,e.EventTarget);return KISSY.Editor=r},{requires:["htmlparser","component","core"]});
KISSY.add("editor/plugin/clipboard/index",function(e){function r(g){this.editor=g;this._init()}function t(g){if(c.ie&&"BackCompat"!=g.get("document")[0].compatMode){var a=g.getSelection(),f;if(a.getType()==b.SELECTION_ELEMENT&&(f=a.getSelectedElement())){var j=a.getRanges()[0],h=new k(g.get("document")[0].createTextNode(""));h.insertBefore(f);j.setStartBefore(h);j.setEndAfter(f);a.selectRanges([j]);setTimeout(function(){f.parent()&&(h.remove(),a.selectElement(f))},0)}}}var m=e.Editor,k=e.Node,c=e.UA,
n=m.Range,i=m.RANGE,u=e.Event;e.augment(r,{_init:function(){var a=this.editor;u.on(a.get("document")[0].body,c.webkit?"paste":c.gecko?"paste":"beforepaste",this._paste,this);u.on(a.get("document")[0].body,"contextmenu",function(){d=1;setTimeout(function(){d=0},10)});a.addCommand("copy",new s("copy"));a.addCommand("cut",new s("cut"));a.addCommand("paste",new s("paste"))},_paste:function(){if(!d){var a=this.editor,b=a.get("document")[0];if(!b.getElementById("ke_pastebin")){var f=a.getSelection(),j=
new n(b),h=new k(c.webkit?"<body></body>":"<div></div>",null,b);h.attr("id","ke_pastebin");c.webkit&&h[0].appendChild(b.createTextNode("\u00a0"));b.body.appendChild(h[0]);h.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});h.css("left","-1000px");var p=f.createBookmarks();j.setStartAt(h,i.POSITION_AFTER_START);j.setEndAt(h,i.POSITION_BEFORE_END);j.select(!0);setTimeout(function(){h.remove();var j;h=c.webkit&&(j=h.first())&&j.hasClass("Apple-style-span")?
j:h;f.selectBookmarks(p);j=h.html();if(j=e.trim(j.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var b=a.fire("paste",{html:j,holder:h});void 0!==b&&(j=b);b=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(j)&&(b=a.htmlDataProcessor.wordFilter);a.insertHtml(j,b)}},0)}}}});var q=function(a,b){var f=a.get("document")[0],j=new k(f.body),h=!1,d=function(){h=!0};j.on(b,d);(7<c.ie?f:f.selection.createRange()).execCommand(b);j.detach(b,d);return h},x=c.ie?function(a,b){return q(a,
b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(f){return!1}},o={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},s=function(a){this.type=a};s.prototype={exec:function(a){"cut"==this.type&&t(a);(a=x(a,this.type))||alert(o[this.type]);return a}};var b=m.Selection,a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},d;m.on("contextmenu",function(b){var d=b.contextmenu,f=d.get("editor"),
j=d.menu.get("contentEl"),h={copy:0,cut:0,paste:0},p;for(p in h)h.hasOwnProperty(p)&&(h[p]=j.one(".ke-paste-"+p),h[p]||function(b){var g=(new k("<a href='#'class='ke-paste-"+b+"'>"+a[b]+"</a>")).appendTo(j);g.on("click",function(j){j.halt();d.hide();setTimeout(function(){f.execCommand(b)},30)});h[b]=g}(p))});return{init:function(a){a.docReady(function(){new r(a)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(e){function r(b,a){var d=b[a?"next":"prev"]();if(d&&d[0].nodeType==k.ELEMENT_NODE){for(var g=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemovable(t);)if(g.push(d),d=a?d.next():d.prev(),!d)return;if(b._4e_isIdentical(d,t)){for(var c=new n(a?b[0].lastChild:b[0].firstChild);g.length;)g.shift()._4e_move(b,!a,t);d._4e_moveChildren(b,!a,t);d.remove();c[0]&&c[0].nodeType==k.ELEMENT_NODE&&c._4e_mergeSiblings()}}}var t=t,m=e.Editor,k=e.DOM,c=e.UA,n=e.Node,i=m.Utils,
u={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};m.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var q=m.POSITION,x={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},o={hr:1},s=function(b){return b&&(b[0]||b)};i.injectDom({_4e_sameLevel:function(b,a){var a=s(a),d=b.parentNode;return d&&d==a.parentNode},_4e_isBlockBoundary:function(b,a){var d=e.merge(o,a);return!(!x[k.css(b,"display")]&&!d[k.nodeName(b)])},_4e_getWin:k._getWin,_4e_index:function(b,a){for(var d=b.parentNode.childNodes,g,c=-1,f=0;f<d.length;f++)if(g=d[f],!a||!(3==g.nodeType&&g.previousSibling&&3==g.previousSibling.nodeType))if(c++,g===b)return c;return-1},_4e_move:function(b,
a,d){a=s(a);d?a.insertBefore(b,a.firstChild):a.appendChild(b)},_4e_isIdentical:function(b,a){if(!a)return!1;a=s(a);if(k.nodeName(b)!=k.nodeName(a))return!1;var d=b.attributes,g=a.attributes,c=d.length,f=g.length;if(c!=f)return!1;for(var j=0;j<c;j++){var h=d[j],p=h.name;if(h.specified&&k.attr(b,p)!=k.attr(a,p))return!1}if(8>i.ieEngine)for(j=0;j<f;j++)if(h=g[j],p=h.name,h.specified&&k.attr(b,p)!=k.attr(a,p))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){for(var b=b.childNodes,a=0,d=b.length;a<
d;a++){var g=b[a],c=g.nodeType;if(!(c==k.ELEMENT_NODE&&g.getAttribute("_ke_bookmark"))&&(c==k.ELEMENT_NODE&&!k._4e_isEmptyInlineRemovable(g)||c==k.TEXT_NODE&&e.trim(g.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,a,d){a=s(a);if(b!=a)if(d)for(;d=b.lastChild;)a.insertBefore(b.removeChild(d),a.firstChild);else for(;d=b.firstChild;)a.appendChild(b.removeChild(d))},_4e_mergeSiblings:function(b){b=new n(b);u[b.nodeName()]&&(r(b,!0),r(b))},_4e_splitText:function(b,a){var d=b.ownerDocument;if(b.nodeType==
k.TEXT_NODE){if(c.ie&&a==b.nodeValue.length){var g=d.createTextNode("");k.insertAfter(g,b);return g}g=b.splitText(a);d.documentMode&&(d=d.createTextNode(""),k.insertAfter(d,g),k.remove(d));return g}},_4e_parents:function(b,a){var d=[];d.__IS_NODELIST=1;do d[a?"push":"unshift"](b);while(b=b.parentNode);return d},_4e_nextSourceNode:function(b,a,d,g){if(g&&!g.call)var c=s(g),g=function(j){return j!==c};var a=!a&&b.firstChild,f=b;if(!a){if(b.nodeType==k.ELEMENT_NODE&&g&&!1===g(b,!0))return null;a=b.nextSibling}for(;!a&&
(f=f.parentNode);){if(g&&!1===g(f,!0))return null;a=f.nextSibling}return!a||g&&!1===g(a)?null:d&&d!=a.nodeType?k._4e_nextSourceNode(a,!1,d,g):a},_4e_previousSourceNode:function(b,a,d,g){if(g&&!g.call)var c=s(g),g=function(j){return j!==c};var a=!a&&b.lastChild,f=b;if(!a){if(b.nodeType==k.ELEMENT_NODE&&g&&!1===g(b,!0))return null;a=b.previousSibling}for(;!a&&(f=f.parentNode);){if(g&&!1===g(f,!0))return null;a=f.previousSibling}return!a||g&&!1===g(a)?null:d&&a.nodeType!=d?k._4e_previousSourceNode(a,
!1,d,g):a},_4e_commonAncestor:function(b,a){a=s(a);if(b===a)return b;if(k.contains(a,b))return a;var d=b;do if(k.contains(d,a))return d;while(d=d.parentNode);return null},_4e_hasAttributes:9>i.ieEngine?function(b){for(var a=b.attributes,d=0;d<a.length;d++){var g=a[d];switch(g.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(g.specified)return!0}}return!1}:function(b){c.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4e_position:function(b,a){var d=s(a);if(b.compareDocumentPosition)return b.compareDocumentPosition(d);
if(b==d)return q.POSITION_IDENTICAL;if(b.nodeType==k.ELEMENT_NODE&&d.nodeType==k.ELEMENT_NODE){if(k.contains(b,d))return q.POSITION_CONTAINS+q.POSITION_PRECEDING;if(k.contains(d,b))return q.POSITION_IS_CONTAINED+q.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>d.sourceIndex?q.POSITION_DISCONNECTED:b.sourceIndex<d.sourceIndex?q.POSITION_PRECEDING:q.POSITION_FOLLOWING}for(var g=k._4e_address(b),d=k._4e_address(d),c=Math.min(g.length,d.length),f=0;f<=c-1;f++)if(g[f]!=d[f])return g[f]<
d[f]?q.POSITION_PRECEDING:q.POSITION_FOLLOWING;return g.length<d.length?q.POSITION_CONTAINS+q.POSITION_PRECEDING:q.POSITION_IS_CONTAINED+q.POSITION_FOLLOWING},_4e_address:function(b,a){for(var d=[],g=b.ownerDocument.documentElement,c=b;c&&c!=g;)d.unshift(k._4e_index(c,a)),c=c.parentNode;return d},_4e_remove:function(b,a){var d=b.parentNode;if(d){if(a)for(var g;g=b.firstChild;)d.insertBefore(b.removeChild(g),b);d.removeChild(b)}return b},_4e_trim:function(b){k._4e_ltrim(b);k._4e_rtrim(b)},_4e_ltrim:function(b){for(var a;a=
b.firstChild;){if(a.nodeType==k.TEXT_NODE){var d=i.ltrim(a.nodeValue),g=a.nodeValue.length;if(d)d.length<g&&(k._4e_splitText(a,g-d.length),b.removeChild(b.firstChild));else{b.removeChild(a);continue}}break}},_4e_rtrim:function(b){for(var a;a=b.lastChild;){if(a.type==k.TEXT_NODE){var d=i.rtrim(a.nodeValue),g=a.nodeValue.length;if(d)d.length<g&&(k._4e_splitText(a,d.length),b.removeChild(b.lastChild));else{b.removeChild(a);continue}}break}!c.ie&&!c.opera&&(a=b.lastChild)&&1==a.nodeType&&"br"==k.nodeName(a)&&
b.removeChild(a)},_4e_appendBogus:function(b){for(var a=b.lastChild;a&&a.nodeType==k.TEXT_NODE&&!e.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==k.TEXT_NODE||"br"!==k.nodeName(a))a=c.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),c.gecko&&a.setAttribute("type","_moz"),b.appendChild(a)},_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var a=b.ownerDocument.createElement("div");a.appendChild(b.cloneNode(!0));return a.innerHTML},
_4e_setMarker:function(b,a,d,g){var b=new n(b),c=b.data("list_marker_id")||b.data("list_marker_id",e.guid()).data("list_marker_id"),f=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");a[c]=b;f[d]=1;return b.data(d,g)},_4e_clearMarkers:function(b,a,d){var b=new n(b),g=b.data("list_marker_names"),c=b.data("list_marker_id"),f;for(f in g)g.hasOwnProperty(f)&&b.removeData(f);b.removeData("list_marker_names");d&&(b.removeData("list_marker_id"),delete a[c])},_4e_copyAttributes:function(b,
a,d){for(var a=new n(a),g=b.attributes,d=d||{},e=0;e<g.length;e++){var f=g[e],j=f.name.toLowerCase(),h;if(!(j in d))if("checked"==j&&(h=k.attr(b,j)))a.attr(j,h);else if(f.specified||c.ie&&f.value&&"value"==j)h=k.attr(b,j),null===h&&(h=f.nodeValue),a.attr(j,h)}""!==b.style.cssText&&(a[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){var b=k.nodeName(b),a=m.XHTML_DTD;return(b=!a.$nonEditable[b]&&(a[b]||a.span))&&b["#"]},_4e_getByAddress:function(b,a,d){for(var b=b.documentElement,g=0;b&&
g<a.length;g++){var c=a[g];if(d)for(var f=-1,j=0;j<b.childNodes.length;j++){var h=b.childNodes[j];if(!(!0===d&&3==h.nodeType&&h.previousSibling&&3==h.previousSibling.nodeType)&&(f++,f==c)){b=h;break}}else b=b.childNodes[c]}return b}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(e){function r(b){1>arguments.length||(this.range=b,this.forceBrBreak=m,this.enlargeBr=t,this.enforceRealBlocks=m,this._||(this._={}))}var t=!0,m=!1,k=e.Editor,c=e.UA,n=k.Walker,i=k.Range,u=k.RANGE,q=k.ElementPath,x=e.Node,o=e.DOM,s=/^[\r\n\t ]*$/;e.augment(r,{getNextParagraph:function(b){var a,d,g,k,f;if(!this._.lastNode){d=this.range.clone();d.shrink(u.SHRINK_ELEMENT,t);d.enlarge(this.forceBrBreak||!this.enlargeBr?u.ENLARGE_LIST_ITEM_CONTENTS:u.ENLARGE_BLOCK_CONTENTS);
var j=new n(d),h=n.bookmark(t,t);j.evaluator=h;this._.nextNode=j.next();j=new n(d);j.evaluator=h;j=j.previous();this._.lastNode=j._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==o.TEXT_NODE&&!e.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(h=new i(d.document),h.moveToPosition(this._.lastNode,u.POSITION_AFTER_END),h.checkEndOfBlock()&&(h=new q(h.endContainer),this._.lastNode=(h.block||h.blockLimit)._4e_nextSourceNode(t)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(d.document.createTextNode("")),o.insertAfter(this._.lastNode[0],j[0]));d=null}h=this._.nextNode;j=this._.lastNode;for(this._.nextNode=null;h;){var p=m,y=h[0].nodeType!=o.ELEMENT_NODE,C=m;if(y)h[0].nodeType==o.TEXT_NODE&&s.test(h[0].nodeValue)&&(y=m);else{var B=h.nodeName();if(h._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==B)y=t;else if(!d&&!h[0].childNodes.length&&"hr"!=B){a=h;g=h.equals(j);break}d&&(d.setEndAt(h,u.POSITION_BEFORE_START),"br"!=
B&&(this._.nextNode=h));p=t}else{if(h[0].firstChild){d||(d=new i(this.range.document),d.setStartAt(h,u.POSITION_BEFORE_START));h=new x(h[0].firstChild);continue}y=t}}y&&!d&&(d=new i(this.range.document),d.setStartAt(h,u.POSITION_BEFORE_START));g=(!p||y)&&h.equals(j);if(d&&!p)for(;!h[0].nextSibling&&!g;){B=h.parent();if(B._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){p=t;g||B.equals(j);break}h=B;y=t;g=h.equals(j);C=t}y&&d.setEndAt(h,u.POSITION_AFTER_END);h=h._4e_nextSourceNode(C,null,j);if((g=!h)||
p&&d)break}if(!a){if(!d)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new q(d.startContainer);h=a.blockLimit;p={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&p[h.nodeName()]&&d.checkStartOfBlock()&&d.checkEndOfBlock())a=h;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new x(this.range.document.createElement(b||"p")),a[0].appendChild(d.extractContents()),a._4e_trim(),d.insertNode(a),k=f=t;else if("li"!=a.nodeName()){if(!d.checkStartOfBlock()||
!d.checkEndOfBlock())a=a.clone(m),a[0].appendChild(d.extractContents()),a._4e_trim(),f=d.splitBlock(),k=!f.wasStartOfBlock,f=!f.wasEndOfBlock,d.insertNode(a)}else g||(this._.nextNode=a.equals(j)?null:d.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,j))}k&&(d=new x(a[0].previousSibling),d[0]&&d[0].nodeType==o.ELEMENT_NODE&&("br"==d.nodeName()?d._4e_remove():d[0].lastChild&&"br"==o.nodeName(d[0].lastChild)&&o._4e_remove(d[0].lastChild)));f&&(d=n.bookmark(m,t),k=new x(a[0].lastChild),k[0]&&k[0].nodeType==
o.ELEMENT_NODE&&"br"==k.nodeName()&&(c.ie||k.prev(d)||k.next(d))&&k.remove());this._.nextNode||(this._.nextNode=g||a.equals(j)?null:a._4e_nextSourceNode(t,null,j));return a}});i.prototype.createIterator=function(){return new r(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(e){function r(e){for(var q=c,r=c,o=[];e;){if(e[0].nodeType==m.ELEMENT_NODE){this.lastElement||(this.lastElement=e);var s=e.nodeName();if(!r&&(!q&&n[s]&&(q=e),i[s])){var b;if(b=!q)if(b="div"==s){a:{b=e[0].childNodes;for(var a=0,d=b.length;a<d;a++){var g=b[a];if(g.nodeType==m.ELEMENT_NODE&&k.$block[g.nodeName.toLowerCase()]){b=!0;break a}}b=!1}b=!b}b?q=e:r=e}o.push(e);if("body"==s)break}e=e.parent()}this.block=q;this.blockLimit=r;this.elements=o}var t=e.Editor,
m=e.DOM,k=t.XHTML_DTD,c=null,n={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};r.prototype={compare:function(c){var e=this.elements,c=c&&c.elements;if(!c||e.length!=c.length)return!1;for(var i=0;i<e.length;i++)if(!m.equals(e[i],c[i]))return!1;return!0},contains:function(e){for(var i=this.elements,n=0;n<i.length;n++)if(i[n].nodeName()in e)return i[n];return c},toString:function(){var c=this.elements,
e,i=[];for(e=0;e<c.length;e++)i.push(c[e].nodeName());return i.toString()}};return t.ElementPath=r},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(e){function r(o){var s;s=o.getSelection().getRanges();for(var b=s.length-1;0<b;b--)s[b].deleteContents();s=s[0];b=s.document;if(s.checkStartOfBlock()&&s.checkEndOfBlock()){var a=(new x(s.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return o.hasCommand("outdent")?(o.execCommand("save"),o.execCommand("outdent"),o.execCommand("save"),!0):!1}var d=s.splitBlock("p");if(!d)return!0;var o=d.previousBlock,a=d.nextBlock,g=
d.wasStartOfBlock,A=d.wasEndOfBlock,f;if(a)f=a.parent(),"li"==f.nodeName()&&(a._4e_breakParent(f),a._4e_move(a.next(),!0));else if(o&&(f=o.parent())&&"li"==f.nodeName())o._4e_breakParent(f),s.moveToElementEditablePosition(o.next()),o._4e_move(o.prev());if(!g&&!A){if("li"==a.nodeName()&&(f=a.first(q.invisible(!0)))&&e.inArray(f.nodeName(),["ul","ol"]))(k.ie?new i(b.createTextNode("\u00a0")):new i(b.createElement("br"))).insertBefore(f);a&&s.moveToElementEditablePosition(a)}else{var j;if(o){if("li"==o.nodeName()||
!c.test(o.nodeName()))j=o.clone()}else a&&(j=a.clone());j||(j=new i("<p>",null,b));if(f=d.elementPath)for(var d=0,h=f.elements.length;d<h;d++){var p=f.elements[d];if(p.equals(f.block)||p.equals(f.blockLimit))break;n.$removeEmpty[p.nodeName()]&&(p=p.clone(),j._4e_moveChildren(p),j.append(p))}k.ie||j._4e_appendBogus();s.insertNode(j);if(k.ie&&g&&(!A||!o[0].childNodes.length))s.moveToElementEditablePosition(A?o:j),s.select();s.moveToElementEditablePosition(g&&!A?a:j)}k.ie||(a?(j=new i(b.createElement("span")),
j.html("&nbsp;"),s.insertNode(j),j.scrollIntoView(void 0,!1),s.deleteContents()):j.scrollIntoView(void 0,!1));s.select();return!0}function t(c){var e=c.get("document")[0];u.on(e,"keydown",function(b){if(13===b.keyCode&&!b.shiftKey&&!b.ctrlKey&&!b.metaKey){c.execCommand("save");var a=c.execCommand("enterBlock");c.execCommand("save");!1!==a&&b.preventDefault()}})}var m=e.Editor,k=e.UA,c=/^h[1-6]$/,n=m.XHTML_DTD,i=e.Node,u=e.Event,q=m.Walker,x=m.ElementPath;return{init:function(c){c.addCommand("enterBlock",
{exec:r});c.docReady(function(){t(c)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(e){function r(){var c=this;c.__iframeFocus=q;u=c;i&&clearTimeout(i);i=setTimeout(function(){c.fire("focus")},100)}function t(){var c=this;c.__iframeFocus=x;u=o;i&&clearTimeout(i);i=setTimeout(function(){c.fire("blur")},100)}var m=e.Editor,k=e.DOM,c=e.Event,n={},i,u,e={refreshAll:function(){for(var c in n)if(n.hasOwnProperty(c)){var b=n[c].get("document")[0];b.designMode="off";b.designMode="on"}},currentInstance:function(){return u},getInstance:function(c){return n[c]},
add:function(e){var b=k._4e_getWin(e.get("document")[0]);c.on(b,"focus",r,e);c.on(b,"blur",t,e)},register:function(c){n[c._UUID]=c},remove:function(e){delete n[e._UUID];var b=k._4e_getWin(e.get("document")[0]);c.remove(b,"focus",r,e);c.remove(b,"blur",t,e)}},q=!0,x=!1,o=null;e.refreshAll=e.refreshAll;m.focusManager=e;m.getInstances=function(){return n};return e},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(e){return{init:function(r){function t(g){return g.replace(b,function(b,f,j){return"<"+f+j.replace(a,function(a,b){return-1==j.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function m(a){return a.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(a){return"<\!--"+d+"{C}"+encodeURIComponent(a).replace(/--/g,"%2D%2D")+"--\>"})}function k(a){return a.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(a,b){return decodeURIComponent(b)})}
var c=c,n=e.Editor,i=e.Node,u=e.UA,q=e.require("htmlparser"),x=new q.Filter,o=new q.Filter,s=new q.Filter;(function(){var a=function(a,b){return function(f,g){var c=[];(""+f).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(f,d,w){d=d.toLowerCase();"font-family"==d&&(w=w.replace(/["']/g,""));for(var z,E,e,p=0;p<a.length;p++)if(a[p]&&(f=a[p][0],z=a[p][1],E=a[p][2],e=a[p][3],d.match(f)&&(!z||w.match(z)))){d=e||d;b&&(E=E||w);"function"==typeof E&&(E=E(w,g,d));E&&E.push&&
(d=E[0],E=E[1]);"string"==typeof E&&c.push([d,E]);return}!b&&c.push([d,w])});for(var d=0;d<c.length;d++)c[d]=c[d].join(":");return c.length?c.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],c),b={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var b=a.nodeName||"";if(-1!=b.indexOf(":")&&
!/^ke/.test(b))if("v:imagedata"==b){if(b=a.getAttribute("o:href"))a.setAttribute("src",b),a.removeAttribute("o:href");if(b=a.getAttribute("o:title"))a.setAttribute("title",b),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(b){b=a(b);return!b?!1:b}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],f,g=0;g<b.length;g++)f="_ke_saved_"+b[g],a.getAttribute(f)&&a.removeAttribute(b[g]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var f=b.getAttribute("width"),b=b.getAttribute("height");f&&a.setAttribute("width",f);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!e.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,d.length)==d?(a="{C}"==a.substr(d.length,3)?a.substr(d.length+3):a.substr(d.length),new q.CData(decodeURIComponent(a))):a}};u.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(f);o.addRules(b);s.addRules(b)})();(function(){function a(b){for(var b=b.childNodes,w=b.length,z=b[w-1];z&&3==z.nodeType&&!e.trim(z.nodeValue);)z=b[--w];return z}
function b(f,w){var z=a(f);z&&((w||!u.ie)&&1==z.nodeType&&"br"==z.nodeName?f.removeChild(z):3==z.nodeType&&d.test(z.nodeValue)&&f.removeChild(z))}function f(b){var w=a(b);return!w||1==w.nodeType&&"br"==w.nodeName||"form"==b.nodeName&&"input"==w.nodeName}function j(a){b(a,!0);f(a)&&(u.ie?a.appendChild(new q.Text("\u00a0")):(a.appendChild(new q.Text("&nbsp;")),a.appendChild(new q.Tag("br"))))}function c(a){b(a,!1);f(a)&&a.appendChild(new q.Text("\u00a0"))}var d=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=n.XHTML_DTD,k=e.merge(i.$block,
i.$listItem,i.$tableContent),m;for(m in k)k.hasOwnProperty(m)&&("br"in i[m]||delete k[m]);delete k.td;delete k.pre;var i={tags:{}},l={tags:{}};for(m in k)k.hasOwnProperty(m)&&(i.tags[m]=j,l.tags[m]=c);o.addRules(i);x.addRules(l);s.addRules(i)})();(function(){x.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}})})();var b=/<(a|area|img|input)\b([^>]*)>/gi,a=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,d="{ke_protected}";r.htmlDataProcessor={wordFilter:s,dataFilter:o,
htmlFilter:x,toHtml:function(a){var b=new q.BeautifyWriter;(new q.Parser(a)).parse().writeHtml(b,x);return b.getHtml()},toDataFormat:function(a,b,f){f=f||o;u.gecko&&(a=a.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));a=t(a);b=new i("<div>");b.html("a"+a);a=b.html().substr(1);a=k(a);b=new q.BeautifyWriter;(new q.Parser(a)).parse().writeHtml(b,f);a=b.getHtml();return a=m(a)},toServer:function(a){var b=new q.MinifyWriter;(new q.Parser(a)).parse().writeHtml(b,x);return b.getHtml()}}}}},
{requires:["editor"]});
KISSY.add("editor/core/meta",function(){var e={backColor:["../color/btn","./cmd"],localStorage:["../flashBridge/"],bold:["../font/ui","./cmd"],draft:["../localStorage/","../select/"],flash:["../flashCommon/baseClass","../flashCommon/utils"],fontFamily:["../font/ui","./cmd"],fontSize:["../font/ui","./cmd"],foreColor:["../color/btn","./cmd"],heading:["./cmd"],image:["../button/","../bubbleview/","../contextmenu/","../dialogLoader/"],indent:["./cmd"],insertOrderedList:["../listUtils/btn","./cmd"],insertUnorderedList:["../listUtils/btn",
"./cmd"],italic:["../font/ui","./cmd"],justifyCenter:["./cmd"],justifyLeft:["./cmd"],justifyRight:["./cmd"],link:["../bubbleview/","./utils","../dialogLoader/"],maximize:["./cmd"],multipleUpload:["../dialogLoader/"],outdent:["./cmd"],overlay:["./focus","dd"],pageBreak:["../fakeObjects/"],removeFormat:["./cmd","../button/"],resize:["dd"],smiley:["../overlay/"],sourceArea:["../button/"],strikeThrough:["../font/ui","./cmd"],table:["../dialogLoader/","../contextmenu/"],underline:["../font/ui","./cmd"],
undo:["./btn","./cmd"],video:["../flashCommon/utils","../flashCommon/baseClass"],xiamiMusic:["../flashCommon/baseClass","../flashCommon/utils"]},r,t,m={"backColor/cmd":["../color/cmd"],"bold/cmd":["../font/cmd"],"color/btn":["../button/","../overlay/","../dialogLoader/"],"color/colorPicker/dialog":["../overlay/"],"dentUtils/cmd":["../listUtils/"],"flash/dialog":["../flashCommon/utils","../overlay/","../select/"],"flashCommon/baseClass":["../contextmenu/","../bubbleview/","../dialogLoader/","./utils"],
"font/ui":["../button/","../select/"],"fontFamily/cmd":["../font/cmd"],"fontSize/cmd":["../font/cmd"],"foreColor/cmd":["../color/cmd"],"image/dialog":["../overlay/","switchable","../select/"],"indent/cmd":["../dentUtils/cmd"],"insertOrderedList/cmd":["../listUtils/cmd"],"insertUnorderedList/cmd":["../listUtils/cmd.js"],"italic/cmd":["../font/cmd"],"justifyCenter/cmd":["../justifyUtils/cmd"],"justifyLeft/cmd":["../justifyUtils/cmd"],"justifyRight/cmd":["../justifyUtils/cmd"],"link/dialog":["../overlay/",
"./utils"],"listUtils/btn":["../button/"],"listUtils/cmd":["../listUtils/"],"multipleUpload/dialog":["../progressbar/","../overlay/","../flashBridge/","../localStorage/"],"outdent/cmd":["../dentUtils/cmd"],"strikeThrough/cmd":["../font/cmd"],"table/dialog":["../overlay/","../select/"],"underline/cmd":["../font/cmd"],"undo/btn":["../button/"],"video/dialog":["../flash/dialog","../select/"],"xiamiMusic/dialog":["../flash/dialog","../select/"]},k={};for(r in e)t="editor/plugin/"+r+"/index",k[t]={requires:e[r]};
for(r in m)t="editor/plugin/"+r,k[t]={requires:m[r]};KISSY.add(k)});
KISSY.add("editor/core/range",function(e,r,t,m,k){function c(a){var b=a.nodeType!=g.TEXT_NODE&&g.nodeName(a)in f.$removeEmpty,j=a.nodeType==g.TEXT_NODE&&!e.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||j||a}function n(a){return!y(a)&&!C(a)}function i(a){var b=s;return function(f){if(C(f))return o;if(f.nodeType==g.TEXT_NODE){if(e.trim(f.nodeValue).length)return s}else if(f.nodeType==g.ELEMENT_NODE&&(f=g.nodeName(f),!v[f]))if(!a&&!A.ie&&"br"==f&&!b)b=o;else return s;return o}}
function u(a,b){var f=a.startContainer,c=a.endContainer,d=a.startOffset,h=a.endOffset,e,l=s,p=s,i=void 0,v=a.document,n;if(a.collapsed)return i;0<b&&(i=v.createDocumentFragment());a.optimizeBookmark();c[0].nodeType==g.TEXT_NODE?(p=o,c=c._4e_splitText(h)):0<c[0].childNodes.length&&(h>=c[0].childNodes.length?(c=new j(c[0].appendChild(v.createTextNode(""))),n=o):c=new j(c[0].childNodes[h]));f[0].nodeType==g.TEXT_NODE?(l=o,f._4e_splitText(d)):d?d>=f[0].childNodes.length?(f=new j(f[0].appendChild(v.createTextNode(""))),
e=o):f=new j(f[0].childNodes[d].previousSibling):(e=new j(v.createTextNode("")),f.prepend(e),f=e,e=o);var k=f._4e_parents(),G=c._4e_parents();k.each(function(a,w){k[w]=a});G.each(function(a,w){G[w]=a});for(var y,I,v=0;v<k.length&&!(y=k[v],I=G[v],!y.equals(I));v++);for(var d=i,D,C,m=v;m<k.length;m++){D=k[m];h=0<b&&!D.equals(f)?d.appendChild(D.clone()[0]):null;D=D[0].nextSibling;C=G[m];for(var q=c[0],u=C&&C[0];D&&!(u==D||q==D);)C=D.nextSibling,2==b?d.appendChild(D.cloneNode(o)):(g._4e_remove(D),1==
b&&d.appendChild(D)),D=C;h&&(d=h)}for(d=i;v<G.length;v++){D=G[v];h=0<b&&!D.equals(c)?d.appendChild(D.clone()[0]):null;if(!k[v]||!D._4e_sameLevel(k[v]))for(D=D[0].previousSibling;D;)C=D.previousSibling,2==b?d.insertBefore(D.cloneNode(o),d.firstChild):(g._4e_remove(D),1==b&&d.insertBefore(D,d.firstChild)),D=C;h&&(d=h)}if(2==b){if(l&&(y=f[0],y.nodeType==g.TEXT_NODE&&y.nextSibling&&y.nextSibling.nodeType==g.TEXT_NODE&&(y.data+=y.nextSibling.data,y.parentNode.removeChild(y.nextSibling))),p)p=c[0],p.nodeType==
g.TEXT_NODE&&p.previousSibling&&p.previousSibling.nodeType==g.TEXT_NODE&&(p.previousSibling.data+=p.data,p.parentNode.removeChild(p))}else{if(y&&I&&(!f._4e_sameLevel(y)||!c._4e_sameLevel(I)))p=y._4e_index(),e&&y._4e_sameLevel(f)&&p--,a.setStart(y.parent(),p+1);a.collapse(o)}e&&f.remove();n&&c.remove();return i}function q(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=b;this.collapsed=o;this.document=a}r.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,s=!1,b=null,a=r.RANGE,d=r.POSITION,g=e.DOM,A=e.UA,f=r.XHTML_DTD,j=e.Node,h=j.all,p={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},y=new m.whitespaces,C=new m.bookmark,B=m.whitespaces(o),l=m.bookmark(!1,
!0),v={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};e.augment(x,{toString:function(){var a=[],b=this.startContainer[0],f=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((f.id||f.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=g.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=g.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==g.ELEMENT_NODE&&p[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);q(this)},setEnd:function(a,b){a[0].nodeType==g.ELEMENT_NODE&&p[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);q(this)},setStartAt:function(b,f){switch(f){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==g.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}q(this)},setEndAt:function(b,f){switch(f){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==g.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}q(this)},cloneContents:function(){return u(this,2)},deleteContents:function(){return u(this,0)},extractContents:function(){return u(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=g.ELEMENT_NODE||a.endContainer[0].nodeType!=g.ELEMENT_NODE)return b;var f=new m(a);f.evaluator=function(a){return B(a)&&l(a)};a=f.next();f.reset();f=
f.previous();return a&&a.equals(f)?a:b},shrink:function(b,f){if(!this.collapsed){var b=b||a.SHRINK_TEXT,c=this.clone(),d=this.startContainer,j=this.endContainer,h=this.startOffset,e=this.endOffset,l=o,p,i,v=o;d&&d[0].nodeType==g.TEXT_NODE&&(h?h>=d[0].nodeValue.length?c.setStartAfter(d):(c.setStartBefore(d),l=s):c.setStartBefore(d));j&&j[0].nodeType==g.TEXT_NODE&&(e?e>=j[0].nodeValue.length?c.setEndAfter(j):(c.setEndAfter(j),v=s):c.setEndBefore(j));if(l||v)i=new m(c),i.evaluator=function(f){return f.nodeType==
(b==a.SHRINK_ELEMENT?g.ELEMENT_NODE:g.TEXT_NODE)},i.guard=function(f,c){if(b==a.SHRINK_ELEMENT&&f.nodeType==g.TEXT_NODE||c&&f==p)return s;!c&&f.nodeType==g.ELEMENT_NODE&&(p=f);return o};l&&(c=i[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(c,f?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);v&&(i.reset(),(i=i[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,f?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return l||v}},createBookmark2:function(a){var f=this.startContainer,
c=this.endContainer,d=this.startOffset,h=this.endOffset,e,l;if(!f||!c)return{start:0,end:0};if(a){if(f[0].nodeType==g.ELEMENT_NODE&&(e=new j(f[0].childNodes[d]))&&e[0]&&e[0].nodeType==g.TEXT_NODE&&0<d&&e[0].previousSibling.nodeType==g.TEXT_NODE)f=e,d=0;for(;f[0].nodeType==g.TEXT_NODE&&(l=f.prev())&&l[0].nodeType==g.TEXT_NODE;)f=l,d+=l[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==g.ELEMENT_NODE&&(e=new j(c[0].childNodes[h]))&&e[0]&&e[0].nodeType==g.TEXT_NODE&&0<h&&e[0].previousSibling.nodeType==
g.TEXT_NODE)c=e,h=0;for(;c[0].nodeType==g.TEXT_NODE&&(l=c.prev())&&l[0].nodeType==g.TEXT_NODE;)c=l,h+=l[0].nodeValue.length}}return{start:f._4e_address(a),end:this.collapsed?b:c._4e_address(a),startOffset:d,endOffset:h,normalized:a,is2:o}},createBookmark:function(f){var c,d,h,g,l=this.collapsed;c=new j("<span>",b,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");f&&(h=e.guid("ke_bm_"),c.attr("id",h+"S"));l||(d=c.clone(),d.html("&nbsp;"),f&&d.attr("id",h+"E"),g=this.clone(),
g.collapse(),g.insertNode(d));g=this.clone();g.collapse(o);g.insertNode(c);d?(this.setStartAfter(c),this.setEndBefore(d)):this.moveToPosition(c,a.POSITION_AFTER_END);return{startNode:f?h+"S":c,endNode:f?h+"E":d,serializable:f,collapsed:l}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var f=this.startContainer,c=this.startOffset,d=this.collapsed;if((!a||d)&&f[0]&&f[0].nodeType==g.TEXT_NODE){if(c)if(c>=f[0].nodeValue.length)c=f._4e_index()+1,f=f.parent();else{var j=
f._4e_splitText(c),c=f._4e_index()+1,f=f.parent();g.equals(this.startContainer,this.endContainer)?this.setEnd(j,this.endOffset-this.startOffset):g.equals(f,this.endContainer)&&(this.endOffset+=1)}else c=f._4e_index(),f=f.parent();this.setStart(f,c);if(d){this.collapse(o);return}}f=this.endContainer;c=this.endOffset;!b&&!d&&f[0]&&f[0].nodeType==g.TEXT_NODE&&(c?(c>=f[0].nodeValue.length||f._4e_splitText(c),c=f._4e_index()+1):c=f._4e_index(),f=f.parent(),this.setEnd(f,c))},insertNode:function(a){this.optimizeBookmark();
this.trim(s,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=h(this.document);if(a.is2){var f=b._4e_getByAddress(a.start,a.normalized),c=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(f,c);b?this.setEnd(b,a):this.collapse(o)}else f=(c=a.serializable)?e.one("#"+a.startNode,b):a.startNode,a=c?e.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(f),f._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,b){var f=this.startContainer,c=this.endContainer,f=f[0]==c[0]?a&&f[0].nodeType==g.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new j(f[0].childNodes[this.startOffset]):f:f._4e_commonAncestor(c);return b&&f[0].nodeType==g.TEXT_NODE?f.parent():f},enlarge:function(){function f(a,b,c,d){var j=a[b?"startContainer":"endContainer"],e,w=b?0:1,l=0,p=b?"previousSibling":
"nextSibling";e=a[b?"startOffset":"endOffset"];if(j[0].nodeType==g.TEXT_NODE){if(b){if(e)return}else if(e<j[0].nodeValue.length)return;e=j[0][p];j=j[0].parentNode}else e=j[0].childNodes[e+(b?-1:1)]||null,j=j[0];for(;j;){for(;e;)if(y(e)||C(e))e=e[p];else break;if(e){if(!l)a[b?"setStartAfter":"setEndBefore"](h(e));break}j=h(j);if("body"==j.nodeName())break;if(l||j.equals(d))c[w]=j,l=1;else a[b?"setStartBefore":"setEndAfter"](j);e=j[0][p];j=j[0].parentNode}}return function(c){switch(c){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var c=this.getCommonAncestor(),d=[];f(this,1,d,c);f(this,0,d,c);d[0]&&d[1]&&(c=d[0].contains(d[1])?d[1]:d[0],this.setStartBefore(c),this.setEndAfter(c));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var e=new x(this.document),d=new j(this.document.body);e.setStartAt(d,a.POSITION_AFTER_START);e.setEnd(this.startContainer,this.startOffset);var e=new m(e),l,p,i=m.blockBoundary(c==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:b),v=function(a){var b=i(a);b||(l=h(a));return b},y=function(a){var b=
v(a);!b&&"br"==g.nodeName(a)&&(p=h(a));return b};e.guard=v;e=e.lastBackward();l=l||d;this.setStartAt(l,"br"!=l.nodeName()&&(!e&&this.checkStartOfBlock()||e&&l.contains(e))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);e=this.clone();e.collapse();e.setEndAt(d,a.POSITION_BEFORE_END);e=new m(e);e.guard=c==a.ENLARGE_LIST_ITEM_CONTENTS?y:v;l=b;e=e.lastForward();l=l||d;this.setEndAt(l,!e&&this.checkEndOfBlock()||e&&l.contains(e)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);p&&this.setEndAfter(p)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,f=this.startOffset;if(f&&b[0].nodeType==g.TEXT_NODE&&e.trim(b[0].nodeValue.substring(0,f)).length)return s;this.trim();b=new k(this.startContainer);f=this.clone();f.collapse(o);f.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new m(f);b.evaluator=i(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,f=this.endOffset;if(b[0].nodeType==g.TEXT_NODE&&e.trim(b[0].nodeValue.substring(f)).length)return s;this.trim();
b=new k(this.endContainer);f=this.clone();f.collapse(s);f.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new m(f);b.evaluator=i(s);return b.checkForward()},checkBoundaryOfElement:function(b,f){var d=this.clone();d[f==a.START?"setStartAt":"setEndAt"](b,f==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);d=new m(d);d.evaluator=c;return d[f==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,f=this.startOffset,c=this.endOffset,
j;if(a[0].nodeType==g.ELEMENT_NODE)if(j=a[0].childNodes.length,j>f)a=h(a[0].childNodes[f]);else if(0==j)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=h(a);a=a._4e_nextSourceNode()||a}if(b[0].nodeType==g.ELEMENT_NODE)if(j=b[0].childNodes.length,j>c)b=h(b[0].childNodes[c])._4e_previousSourceNode(o);else if(0==j)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=h(b)}a._4e_position(b)&d.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(b,
f){var c=this.createBookmark(),d=h(this.document.createElement(f));this.collapse(b);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();A.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(c);return d},splitBlock:function(f){var c=new k(this.startContainer),d=new k(this.endContainer),j=c.block,h=d.block,g=b;if(!c.blockLimit.equals(d.blockLimit))return b;"br"!=f&&(j||(j=this.fixBlock(o,f),h=(new k(this.endContainer)).block),h||(h=this.fixBlock(s,
f)));f=j&&this.checkStartOfBlock();c=h&&this.checkEndOfBlock();this.deleteContents();j&&j[0]==h[0]&&(c?(g=new k(this.startContainer),this.moveToPosition(h,a.POSITION_AFTER_END),h=b):f?(g=new k(this.startContainer),this.moveToPosition(j,a.POSITION_BEFORE_START),j=b):(h=this.splitElement(j),!A.ie&&!e.inArray(j.nodeName(),["ul","ol"])&&j._4e_appendBogus()));return{previousBlock:j,nextBlock:h,wasStartOfBlock:f,wasEndOfBlock:c,elementPath:g}},splitElement:function(f){if(!this.collapsed)return b;this.setEndAt(f,
a.POSITION_BEFORE_END);var c=this.extractContents(),d=f.clone(s);d[0].appendChild(c);d.insertAfter(f);this.moveToPosition(f,a.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(b,f){for(var c=0;b;){if(b[0].nodeType==g.TEXT_NODE){this.moveToPosition(b,f?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);c=1;break}b[0].nodeType==g.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,f?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),c=1);var d=b,j=c,e=void 0;d[0].nodeType==g.ELEMENT_NODE&&
d._4e_isEditable()&&(e=d[f?"last":"first"](n));!j&&!e&&(e=d[f?"prev":"next"](n));b=e}return!!c},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==g.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,c,d,j=a.nodeName();b=f.$block[j];this.deleteContents();if(b){for(b=this.getCommonAncestor(s,o);(c=f[b.nodeName()])&&(!c||!c[j]);){var e=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(o),
b.remove()):d=b;b=e}d&&this.splitElement(d)}this.insertNode(a)}});t.injectDom({_4e_breakParent:function(a,b){var b=h(b),a=h(a),f,c=new r.Range(a[0].ownerDocument);c.setStartAfter(a);c.setEndAfter(b);f=c.extractContents();c.insertNode(a.remove());a.after(f)}});r.Range=x},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(e){function r(a){this.document=a;this._={cache:{}};if(o){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=k}}function t(a){a=new r(a);return!a||a.isInvalid?c:a}var m=e.Editor;m.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var k=!0,c=null,n=e.UA,i=e.DOM,u=e.Node,q=m.SELECTION,x=m.RANGE,o=n.ie,s=m.Walker,b=m.Range,a={img:1,hr:1,li:1,table:1,
tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};e.augment(r,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=i._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var b=this._.cache;if(b.type)return b.type;var c=q.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=d.getRangeAt(0),e=d.startContainer;
e==d.endContainer&&e.nodeType==i.ELEMENT_NODE&&1==Number(d.endOffset-d.startOffset)&&a[e.childNodes[d.startOffset].nodeName.toLowerCase()]&&(c=q.SELECTION_ELEMENT)}}else c=q.SELECTION_NONE;return b.type=c}:function(){var a=this._.cache;if(a.type)return a.type;var b=q.SELECTION_NONE;try{var c=this.getNative(),d=c.type;"Text"==d&&(b=q.SELECTION_TEXT);"Control"==d&&(b=q.SELECTION_ELEMENT);c.createRange().parentElement&&(b=q.SELECTION_TEXT)}catch(e){}return a.type=b},getRanges:o?function(){var a=function(a,
b){a=a.duplicate();a.collapse(b);for(var f=a.parentElement(),d=f.childNodes,e,g=0;g<d.length;g++){var l=d[g];if(l.nodeType==i.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(l);var l=e.compareEndPoints("StartToStart",a),v=e.compareEndPoints("EndToStart",a);e.collapse();if(0<l)break;else{if(!l||1==v&&-1==l)return{container:f,offset:g};if(!v)return{container:f,offset:g+1}}e=c}}e||(e=a.duplicate(),e.moveToElementText(f),e.collapse(!1));e.setEndPoint("StartToStart",a);e=(""+e.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<e;)e-=d[--g].nodeValue.length}catch(n){e=0}return 0===e?{container:f,offset:g}:{container:d[g],offset:-e}};return function(c){var d=this._.cache;if(d.ranges&&!c)return d.ranges;var e=this.getNative(),c=e&&e.createRange(),g=this.getType();if(!e)return[];if(g==q.SELECTION_TEXT)return e=new b(this.document),g=a(c,k),e.setStart(new u(g.container),g.offset),g=a(c),e.setEnd(new u(g.container),g.offset),d.ranges=[e];if(g==q.SELECTION_ELEMENT){d=d.ranges=[];for(g=0;g<c.length;g++){for(var i=
c.item(g),n=i.parentNode,l=0,e=new b(this.document);l<n.childNodes.length&&n.childNodes[l]!=i;l++);e.setStart(new u(n),l);e.setEnd(new u(n),l+1);d.push(e)}return d}return d.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],d=this.getNative();if(!d)return[];for(var e=0;e<d.rangeCount;e++){var g=d.getRangeAt(e),i=new b(this.document);i.setStart(new u(g.startContainer),g.startOffset);i.setEnd(new u(g.endContainer),g.endOffset);a.push(i)}return c.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case q.SELECTION_ELEMENT:return this.getSelectedElement();case q.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();k;)if(b=d.startContainer,d.startOffset==(b[0].nodeType===i.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())d.setStartAfter(b);else break;b=d.startContainer;if(b[0].nodeType!=i.ELEMENT_NODE)return b.parent();b=new u(b[0].childNodes[d.startOffset]);
if(!b[0]||b[0].nodeType!=i.ELEMENT_NODE)return d.startContainer;for(d=b[0].firstChild;d&&d.nodeType==i.ELEMENT_NODE;)b=new u(d),d=d.firstChild;return b}if(o)d=c.createRange(),d.collapse(k),b=new u(d.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=i.ELEMENT_NODE)b=b.parentNode;b&&(b=new u(b))}}return a.startElement=b},getSelectedElement:function(){var b,d=this._.cache;if(void 0!==d.selectedElement)return d.selectedElement;o&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var c;if(b)c=
new u(b);else{b=this.getRanges()[0];for(var e,g=2;g&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==i.ELEMENT_NODE&&a[c.nodeName()]&&(e=c)));g--)b.shrink(x.SHRINK_ELEMENT);c=e}return d.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(o)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(d){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),
a.addRange(b);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var d=a[c],e=this.document.createRange(),g=d.startContainer;if(d.collapsed&&(n.gecko&&1.09>n.gecko||n.opera||n.webkit)&&g[0].nodeType==i.ELEMENT_NODE&&!g[0].childNodes.length)g[0].appendChild(this.document.createTextNode(n.webkit?"\u200b":"")),d.startOffset++,
d.endOffset++;e.setStart(g[0],d.startOffset);e.setEnd(d.endContainer[0],d.endOffset);b.addRange(e)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],d=this.document,g,b=b||this.getRanges(),n=b.length,o=0;o<n;o++){c.push(g=b[o].createBookmark(a,k));var l=(a=g.serializable)?e.one("#"+g.startNode,d):g.startNode;g=a?e.one("#"+g.endNode,d):g.endNode;for(var v=o+1;v<n;v++){var w=
b[v],z=w.startContainer,m=w.endContainer;i.equals(z,l.parent())&&w.startOffset++;i.equals(z,g.parent())&&w.startOffset++;i.equals(m,l.parent())&&w.endOffset++;i.equals(m,g.parent())&&w.endOffset++}}return c},selectBookmarks:function(a){for(var c=[],d=0;d<a.length;d++){var e=new b(this.document);e.moveToBookmark(a[d]);c.push(e)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=
this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var d={table:1,tbody:1,tr:1},g=s.whitespaces(k),A=/\ufeff|\u00a0/;b.prototype.select=b.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==i.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],
this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(k),b.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,c,e;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var n=this.startContainer[0].childNodes[this.startOffset];if(n.nodeType==i.ELEMENT_NODE){(new r(this.document)).selectElement(new u(n));return}}(this.startContainer[0].nodeType==
i.ELEMENT_NODE&&this.startContainer.nodeName()in d||this.endContainer[0].nodeType==i.ELEMENT_NODE&&this.endContainer.nodeName()in d)&&this.shrink(x.SHRINK_ELEMENT,k);var o=this.createBookmark(),n=o.startNode,m;b||(m=o.endNode);o=this.document.body.createTextRange();o.moveToElementText(n[0]);o.moveStart("character",1);if(m)a=this.document.body.createTextRange(),a.moveToElementText(m[0]),o.setEndPoint("EndToEnd",a),o.moveEnd("character",-1);else{for(c=n[0].nextSibling;c&&!g(c);)c=c.nextSibling;c=!(c&&
c.nodeValue&&c.nodeValue.match(A))&&(a||!n[0].previousSibling||n[0].previousSibling&&"br"==i.nodeName(n[0].previousSibling));e=new u(this.document.createElement("span"));e.html("&#65279;");e.insertBefore(n);c&&i.insertBefore(this.document.createTextNode("\ufeff"),n[0]||n)}this.setStartBefore(n);n._4e_remove();if(b){if(c?(o.moveStart("character",-1),o.select(),this.document.selection.clear()):o.select(),e)this.moveToPosition(e,x.POSITION_BEFORE_START),e._4e_remove()}else this.setEndBefore(m),m._4e_remove(),
o.select()};r.getSelection=t;return m.Selection=r},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(e,r){function t(a){function b(a,c){var d=i.body.createTextRange();try{d.moveToPoint(a,c)}catch(f){d=u}return d}function c(){var a=i.selection.createRange();n&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&n.select();x.remove(i,"mouseup",c);x.remove(i,"mousemove",e);n=f=0}function e(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",n)?a.setEndPoint("StartToStart",n):a.setEndPoint("EndToEnd",n),a.select()}else c()}var f,
j=a.get("iframe")[0].contentWindow,i=a.get("document")[0],n;x.on(i,"mousedown contextmenu",function(a){var k=i.documentElement;if(a.target===k&&(f&&c(),!(k.scrollHeight>k.clientHeight)&&(f=1,n=b(a.pageX,a.pageY))))x.on(i,"mouseup",c),x.on(i,"mousemove",e),j.focus(),n.select()})}function m(a){function c(f){if(h){var i=a.getSelection(),k=i&&i.getType(),l=i&&e.selection;if(f&&l&&k==b.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){c(n)},50);else{var v;if(!l||!l.type||!("Control"!=
l.type&&(v=l.createRange())&&(v=v.parentElement())&&(v=v.nodeName)&&v.toLowerCase()in{input:1,textarea:1}))j=l&&i.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],k=new s(e.body),f=new s(e.documentElement);if(8>r.Utils.ieEngine)f.on("click",function(b){"html"===(new s(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var j,h,o=n;f.on("mousedown",function(){o=i});f.on("mouseup",function(){o=n});k.on("focusin",function(a){if("body"==(new s(a.target)).nodeName()&&
j){try{o&&j.select()}catch(b){}j=u}});k.on("focus",function(){h=n;c()});k.on("beforedeactivate",function(a){a.relatedTarget||(h=i,o=n)});k.on("mousedown",function(){h=i});k.on("mouseup",function(){h=n;setTimeout(function(){c(n)},0)});k.on("keydown",function(){h=i});k.on("keyup",function(){h=n;setTimeout(function(){c()},0)})}function k(a){var b=a.get("document")[0];x.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function c(a){function b(a){var c=r.XHTML_DTD;return a._4e_isBlockBoundary()&&
c.$empty[a.nodeName()]}function c(a){return j(a)&&h(a)}var e=a.get("document")[0],f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,j=r.Walker.whitespaces(n),h=r.Walker.bookmark(i,n),k=function(a){return j(a)&&8!=a.nodeType};a.on("selectionChange",function(j){var h=j.path,m=new s(a.get("document")[0].body),j=(j=j.selection)&&j.getRanges()[0],l=h.blockLimit;if(q.gecko){var v=h.block||h.blockLimit,w=v&&v.last(c);v&&v._4e_isBlockBoundary()&&
(!w||!(1==w[0].nodeType&&w._4e_isBlockBoundary()))&&"pre"!=v.nodeName()&&!v._4e_getBogus()&&v._4e_appendBogus()}if(j&&j.collapsed&&!h.block){if("body"==l.nodeName()){if((h=j.fixBlock(n,"p"))&&h[0]!=m[0].lastChild&&h._4e_outerHtml().match(f))if((l=h.next(k))&&l[0].nodeType==o.ELEMENT_NODE&&!b[l])j.moveToElementEditablePosition(l),h._4e_remove();else if((l=h.prev(k))&&l[0].nodeType==o.ELEMENT_NODE&&!b[l])j.moveToElementEditablePosition(l,l._4e_outerHtml().match(f)?i:n),h._4e_remove();j.select();a.notifySelectionChange()}h=
new r.Range(e);h.moveToElementEditablePosition(m,n);"body"!==(new r.ElementPath(h.startContainer)).blockLimit.nodeName()&&(m=(new s(e.createElement("p"))).appendTo(m),q.ie||m._4e_appendBogus())}})}var n=!0,i=!1,u=null,q=e.UA,x=e.Event,o=e.DOM,s=e.Node,b=r.SELECTION;return{init:function(a){a.docReady(function(){q.ie?(t(a),m(a)):k(a)});c(a)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(e){function r(a){return!B.attr(a,"_ke_bookmark")}function t(a,b){for(var c in a)a.hasOwnProperty(c)&&(e.isString(a[c])?a[c]=a[c].replace(O,function(a,c){return b[c]}):t(a[c],b))}function m(a,b){b&&(a=e.clone(a),t(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||N[c]?l.STYLE_BLOCK:L[c]?l.STYLE_OBJECT:l.STYLE_INLINE;this._={definition:a}}function k(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new w(a),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function c(a,b,c){var d=a.element;"*"==d&&(d="span");b=new F(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=m.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function n(a){var b=a.createBookmark(p),d=a.createIterator();d.enforceRealBlocks=p;d.enlargeBr=p;for(var e,f=a.document;e=d.getNextParagraph();){var g=c(this,f,
e),l=g,g="pre"==l.nodeName,j="pre"==e.nodeName,h=!g&&j;g&&!j?(j=e,h=j.html(),h=i(h,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),h=h.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),h=h.replace(/([ \t\n\r]+|&nbsp;)/g," "),h=h.replace(/<br\b[^>]*>/gi,"\n"),J.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(l[0]),l[0].outerHTML="<pre>"+h+"</pre>",l=new F(j.firstChild),l._4e_remove()):l.html(h)):h?l=q(u(e),l):e._4e_moveChildren(l);e[0].parentNode.replaceChild(l[0],e[0]);if(g&&(e=l,g=void 0,(g=e._4e_previousSourceNode(p,
B.ELEMENT_NODE))&&"pre"==g.nodeName()))l=i(g.html(),/\n$/,"")+"\n\n"+i(e.html(),/^\n/,""),J.ie?e[0].outerHTML="<pre>"+l+"</pre>":e.html(l),g._4e_remove()}a.moveToBookmark(b)}function i(a,b,c){var d="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(e=c);return""});return d+a.replace(b,c)+e}function u(a){var b=[];i(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function q(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var e=a[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=i(e,/^[ \t]*\n/,""),e=i(e,/\n$/,""),e=i(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
f=b.clone();f.html(e);c.appendChild(f[0])}return c}function x(a){var b=a.document;if(a.collapsed)b=c(this,b,void 0),a.insertNode(b),a.moveToPosition(b,v.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,f,g=H[d];g||(f=p,g=H.span);var l=a.createBookmark();a.enlarge(v.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),i=j.startNode,j=j.endNode,h=i,n;h&&h[0];){var k=y;if(B.equals(h,j))h=C,k=p;else{var w=h[0].nodeType,o=w==B.ELEMENT_NODE?h.nodeName():C;if(o&&h.attr("_ke_bookmark")){h=
h._4e_nextSourceNode(p);continue}if(!o||g[o]&&(h._4e_position(j)|z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(h))){var m=h.parent();if(m&&"a"==d&&m.nodeName()==d)w=c(this,b,void 0),m._4e_moveChildren(w),m[0].parentNode.replaceChild(w[0],m[0]),w._4e_mergeSiblings();else if(m&&m[0]&&((H[m.nodeName()]||H.span)[d]||f)&&(!e.parentRule||e.parentRule(m))){if(!n&&(!o||!H.$removeEmpty[o]||(h._4e_position(j)|
z.POSITION_PRECEDING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_PRECEDING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED))n=new E(b),n.setStartBefore(h);if(w==B.TEXT_NODE||w==B.ELEMENT_NODE&&!h[0].childNodes.length){m=h;for(w=null;(k=!m.next(r))&&(w=m.parent())&&g[w.nodeName()]&&(w._4e_position(i)|z.POSITION_FOLLOWING|z.POSITION_IDENTICAL|z.POSITION_IS_CONTAINED)==z.POSITION_FOLLOWING+z.POSITION_IDENTICAL+z.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(w));)m=w;n.setEndAfter(m)}}else k=
p}else k=p;h=h._4e_nextSourceNode()}if(k&&n&&!n.collapsed){for(var k=c(this,b,void 0),m=n.getCommonAncestor(),w={},o={},q,u=null,s;k&&m&&k[0]&&m[0];){if(m.nodeName()==d){for(q in e.attributes)if(e.attributes.hasOwnProperty(q)&&!o[q]&&(s=m.attr(u)))k.attr(q)==s?k.removeAttr(q):o[q]=1;for(u in e.styles)if(e.styles.hasOwnProperty(u)&&!w[u]&&(s=m.style(u)))k.style(u)==s?k.style(u,""):w[u]=1;if(!k._4e_hasAttributes()){k=C;break}}m=m.parent()}k?(k[0].appendChild(n.extractContents()),A(this,k),n.insertNode(k),
k._4e_mergeSiblings(),J.ie||k[0].normalize()):(k=new F(b.createElement("span")),k[0].appendChild(n.extractContents()),n.insertNode(k),A(this,k),k._4e_remove(!0));n=C}}i._4e_remove();j._4e_remove();a.moveToBookmark(l);a.shrink(v.SHRINK_TEXT)}}function o(b){b.enlarge(v.ENLARGE_ELEMENT);var c=b.createBookmark(),e=c.startNode;if(b.collapsed){for(var g=new K(e.parent()),l,j=0,h;j<g.elements.length&&(h=g.elements[j])&&!(h==g.block||h==g.blockLimit);j++)if(this.checkElementRemovable(h)){var i=b.checkBoundaryOfElement(h,
v.END),n=!i&&b.checkBoundaryOfElement(h,v.START);n||i?(l=h,l.match=n?"start":"end"):(h._4e_mergeSiblings(),h.nodeName()!=this.element?(i=a(this),f(h,i[h.nodeName()]||i["*"])):d(this,h))}if(l){h=e;for(j=0;;j++){i=g.elements[j];if(B.equals(i,l))break;else if(i.match)continue;else i=i.clone();i[0].appendChild(h[0]);h=i}h["start"==l.match?"insertBefore":"insertAfter"](l)}}else{var k=c.endNode,w=this,g=function(){for(var a=new K(e.parent()),b=new K(k.parent()),c=C,d=C,f=0;f<a.elements.length;f++){var g=
a.elements[f];if(g==a.block||g==a.blockLimit)break;w.checkElementRemovable(g)&&(c=g)}for(f=0;f<b.elements.length;f++){g=b.elements[f];if(g==b.block||g==b.blockLimit)break;w.checkElementRemovable(g)&&(d=g)}d&&k._4e_breakParent(d);c&&e._4e_breakParent(c)};g();for(l=new F(e[0].nextSibling);l[0]!==k[0];){j=l._4e_nextSourceNode();if(l[0]&&l[0].nodeType==B.ELEMENT_NODE&&this.checkElementRemovable(l)&&(l.nodeName()==this.element?d(this,l):(h=a(this),f(l,h[l.nodeName()]||h["*"])),j[0].nodeType==B.ELEMENT_NODE&&
j.contains(e)))g(),j=new F(e[0].nextSibling);l=j}}b.moveToBookmark(c)}function s(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function b(a,b){var c="";b!==y?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function a(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){e.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var f=c[d],g,l,j;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():a.element,l=f.attributes,j=f.styles);f=b[g]||(b[g]={});if(l){g=f.attributes=f.attributes||[];for(var h in l)l.hasOwnProperty(h)&&g.push([h.toLowerCase(),l[h]])}if(j){var f=f.styles=f.styles||[],i;for(i in j)j.hasOwnProperty(i)&&f.push([i.toLowerCase(),j[i]])}}}return b}function d(b,c){var d=b._.definition,f=a(b),l=e.merge(d.attributes,(f[c.nodeName()]||
f["*"]||{}).attributes),d=e.merge(d.styles,(f[c.nodeName()]||f["*"]||{}).styles),f=e.isEmptyObject(l)&&e.isEmptyObject(d),h;for(h in l)if(l.hasOwnProperty(h)&&!(("class"==h||b._.definition.fullMatch)&&c.attr(h)!=g(h,l[h])))f=f||!!c.hasAttr(h),c.removeAttr(h);for(var i in d)d.hasOwnProperty(i)&&!(b._.definition.fullMatch&&c.style(i)!=g(i,d[i],p))&&(f=f||!!c.style(i),c.style(i,""));j(c)}function g(a,b,c){var d=new F("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function A(b,c){for(var e=
a(b),g=c.all(b.element),l=g.length;0<=--l;)d(b,new F(g[l]));for(var j in e)if(e.hasOwnProperty(j)&&j!=b.element){g=c.all(j);for(l=g.length-1;0<=l;l--){var h=new F(g[l]);f(h,e[j])}}}function f(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],f;if(f=a.attr(e)){var g=d[c][1];(g===C||g.test&&g.test(f)||"string"==typeof g&&f==g)&&a[0].removeAttribute(e)}}if(d=b&&b.styles)for(c=0;c<d.length;c++)if(e=d[c][0],g=a.css(e)){var l=d[c][1];(l===C||l.test&&l.test(f)||"string"==typeof l&&
g==l)&&a.css(e,"")}j(a)}function j(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(p);b&&(b.nodeType==B.ELEMENT_NODE&&B._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==B.ELEMENT_NODE&&B._4e_mergeSiblings(c))}}var h=e.Editor,p=!0,y=!1,C=null,B=e.DOM,l={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},v=h.RANGE,w=h.Selection,z=h.POSITION,E=h.Range,F=e.Node,J=e.UA,K=h.ElementPath,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},H=h.XHTML_DTD,L={embed:1,hr:1,img:1,li:1,
object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},M=/\s*(?:;\s*|$)/g,O=/#\((.+?)\)/g;h.STYLE=l;m.prototype={apply:function(a){k.call(this,a,y)},remove:function(a){k.call(this,a,p)},applyToRange:function(a){return(this.applyToRange=this.type==l.STYLE_INLINE?x:this.type==l.STYLE_BLOCK?n:C).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==l.STYLE_INLINE?o:C).call(this,a)},checkElementRemovable:function(c,d){if(!c)return y;var e=this._.definition,f;if(c.nodeName()==
this.element){if(!d&&!c._4e_hasAttributes())return p;var g=e._AC;if(g)e=g;else{var g={},l=0,j=e.attributes;if(j)for(var h in j)j.hasOwnProperty(h)&&(l++,g[h]=j[h]);if(j=m.getStyleText(e))g.style||l++,g.style=j;g._length=l;e=e._AC=g}if(e._length){for(var i in e)if("_length"!=i&&e.hasOwnProperty(i)){l=c.attr(i)||"";if("style"==i)a:{g=e[i];l=b(l,y);"string"==typeof g&&(g=s(g));"string"==typeof l&&(l=s(l));j=void 0;for(j in g)if(g.hasOwnProperty(j)&&!(j in l&&(l[j]==g[j]||"inherit"==g[j]||"inherit"==
l[j]))){g=y;break a}g=p}else g=e[i]==l;if(g){if(!d)return p}else if(d)return y}if(d)return p}else return p}i=a(this);if(i=i[c.nodeName()]||i["*"]){if(!(e=i.attributes)&&!(f=i.styles))return p;if(e)for(g=0;g<e.length;g++)if(i=e[g][0],i=c.attr(i))if(l=e[g][1],l===C||"string"==typeof l&&i==l||l.test&&l.test(i))return p;if(f)for(g=0;g<f.length;g++)if(i=c.css(f[g][0]))if(e=f[g][1],e===C||"string"==typeof e&&i==e||e.test&&e.test(i))return p}return y},checkActive:function(a){switch(this.type){case l.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,p);case l.STYLE_OBJECT:case l.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==l.STYLE_INLINE&&(B.equals(d,a.block)||B.equals(d,a.blockLimit))))if((this.type!=l.STYLE_OBJECT||d.nodeName()in L)&&this.checkElementRemovable(d,p))return p}return y}};m.getStyleText=function(a){var c=a._ST;if(c)return c;var c=a.styles,d=a.attributes&&a.attributes.style||"",e="";d.length&&(d=d.replace(M,";"));for(var f in c)if(c.hasOwnProperty(f)){var g=c[f],l=(f+":"+g).replace(M,
";");"inherit"==g?e+=l:d+=l}d.length&&(d=b(d));return a._ST=d+e};h.Style=m},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(e){var r=e.Node,t=e.DOM,m=e.UA,k={debugUrl:function(c){var n=e.Config;n.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));-1==c.indexOf("?t")&&(c=-1!=c.indexOf("?")?c+"&":c+"?",c+="t="+encodeURIComponent(n.tag));return n.base+"editor/"+c},lazyRun:function(c,e,i){var k=c[e],m=c[i];c[e]=function(){k.apply(this,arguments);c[e]=c[i];return m.apply(this,arguments)}},getXY:function(c,e,i,k){i=i.defaultView||i.parentWindow;c-=t.scrollLeft(i);e-=t.scrollTop(i);k&&(k=k.defaultView||
k.parentWindow,i!=k&&i.frameElement&&(k=t.offset(i.frameElement,void 0,k),c+=k.left,e+=k.top));return{left:c,top:e}},tryThese:function(c){for(var e,i=0,k=arguments.length;i<k;i++){var m=arguments[i];try{e=m();break}catch(r){}}return e},arrayCompare:function(c,e){if(!c&&!e)return!0;if(!c||!e||c.length!=e.length)return!1;for(var i=0;i<c.length;i++)if(c[i]!==e[i])return!1;return!0},clearAllMarkers:function(c){for(var e in c)c.hasOwnProperty(e)&&c[e]._4e_clearMarkers(c,!0,void 0)},ltrim:function(c){return c.replace(/^\s+/,
"")},rtrim:function(c){return c.replace(/\s+$/,"")},isNumber:function(c){return/^\d+(.\d+)?$/.test(e.trim(c))},verifyInputs:function(c){for(var n=0;n<c.length;n++){var i=new r(c[n]),m=e.trim(k.valInput(i)),q=i.attr("data-verify"),i=i.attr("data-warning");if(q&&!RegExp(q).test(m))return alert(i),!1}return!0},sourceDisable:function(c,e){c.on("sourceMode",e.disable,e);c.on("wysiwygMode",e.enable,e)},resetInput:function(c){var e=c.attr("placeholder");e&&m.ie?(c.addClass("ke-input-tip"),c.val(e)):m.ie||
c.val("")},valInput:function(c,e){if(void 0===e)return c.hasClass("ke-input-tip")?"":c.val();c.removeClass("ke-input-tip");c.val(e)},placeholder:function(c,k){c.attr("placeholder",k);m.ie&&(c.on("blur",function(){e.trim(c.val())||(c.addClass("ke-input-tip"),c.val(k))}),c.on("focus",function(){c.removeClass("ke-input-tip");e.trim(c.val())==k&&c.val("")}))},htmlEncode:function(c){return!c?c:(""+c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(c){var c=
e.clone(c),k;for(k in c)if(c.hasOwnProperty(k)){var i=c[k];e.isFunction(i)&&(c[k]=i())}return c},map:function(c,e){for(var i=0;i<c.length;i++)c[i]=e(c[i]);return c},ieEngine:document.documentMode||m.ie,preventFocus:function(c){m.ie?c.unselectable(void 0):c.attr("onmousedown","return false;")},injectDom:function(c){e.mix(t,c);for(var k in c)c.hasOwnProperty(k)&&function(i){r.prototype[i]=function(){var k=[].slice.call(arguments,0);k.unshift(this[0]);return(k=c[i].apply(null,k))&&(k.nodeType||e.isWindow(k))?
new r(k):e.isArray(k)&&(k.__IS_NODELIST||k[0]&&k[0].nodeType)?new r(k):k}}(k)},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,e.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],k=0;k<c.length;k++){var i=c[k];e.isFunction(i)?i():(i.destroy&&i.destroy(),i.remove&&i.remove())}this.__res=[]},getQueryCmd:function(c){return"query"+("-"+c).replace(/-(\w)/g,function(c,e){return e.toUpperCase()})+"Active"}};return e.Editor.Utils=k},{requires:["./base"]});
KISSY.add("editor/core/walker",function(e,r){function t(a,b){if(this._.end)return i;var d,e=this.range,h,k=this.guard,m=this.type,r=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,e.trim(),e.collapsed))return this.end(),i;if(!a&&!this._.guardLTR){var s=e.endContainer[0],l=s.childNodes[e.endOffset];this._.guardLTR=function(a,b){return b&&(s==a||"body"==q.nodeName(a))?!1:a!=l}}if(a&&!this._.guardRTL){var v=e.startContainer[0],w=0<e.startOffset&&v.childNodes[e.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(v==a||"body"==q.nodeName(a))?!1:a!=w}}var z=a?this._.guardRTL:this._.guardLTR;h=k?function(a,b){return z(a,b)===n?n:k(a,b)}:z;this.current?d=this.current[r](n,m,h):a?(d=e.endContainer,0<e.endOffset?(d=new o(d[0].childNodes[e.endOffset-1]),h(d[0])===n&&(d=i)):d=h(d,c)===n?i:d._4e_previousSourceNode(c,m,h,void 0)):(d=e.startContainer,d=new o(d[0].childNodes[e.startOffset]),d.length?h(d[0])===n&&(d=i):d=h(e.startContainer,c)===n?i:e.startContainer._4e_nextSourceNode(c,
m,h,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==n){if(!b)return d}else if(b&&this.evaluator)return n;d=d[r](n,m,h)}this.end();return this.current=i}function m(a){for(var b,c=i;b=t.call(this,a);)c=b;return c}function k(a){this.range=a;this.guard=this.evaluator=i;this._={}}var c=!0,n=!1,i=null,u=e.UA,q=e.DOM,x=r.XHTML_DTD,o=e.Node;e.augment(k,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,c)},checkForward:function(){return t.call(this,
n,c)!==n},checkBackward:function(){return t.call(this,c,c)!==n},lastForward:function(){return m.call(this)},lastBackward:function(){return m.call(this,c)},reset:function(){delete this.current;this._={}},_iterator:t});e.mix(k,{blockBoundary:function(a){return function(b){return!(b.nodeType==q.ELEMENT_NODE&&q._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==q.nodeName(a)&&q.attr(a,"_ke_bookmark")}return function(d){var e,i;e=d.nodeType==q.TEXT_NODE&&(i=d.parentNode)&&c(i);
e=a?e:e||c(d);return!!(b^e)}},whitespaces:function(a){return function(b){b=b.nodeType==q.TEXT_NODE&&!e.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=k.whitespaces();return function(c){c=b(c)||c.nodeType==q.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var s=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,b=k.whitespaces(),a=k.bookmark(),d=function(c){var d=q.nodeName(c);return a(c)||b(c)||1==c.nodeType&&d in x.$inline&&!(d in x.$empty)};r.Utils.injectDom({_4e_getBogus:function(a){a=new o(a);do a=
a._4e_previousSourceNode();while(a&&d(a[0]));return a&&(!u.ie?"br"==a.nodeName():3==a[0].nodeType&&s.test(a.text()))?a[0]:!1}});return r.Walker=k},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(e){var r=e.Editor;r.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};r.baseZIndex=function(e){return(r.Config.baseZIndex||1E4)+e}},{requires:["./base"]});
KISSY.add("editor",function(e,r,t,m){function k(a,c){var d=a.body;h(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=x)},50)},function(){a.designMode="off";A.attr(d,"contentEditable",b);A.attr(d,"contentEditable",x);!c&&k(a,1)})}function c(a){var c=a.get("iframe"),h=a.get("textarea")[0],c=c[0].contentWindow,i=a.get("document")[0];d.webkit&&(j.on(i,"click",function(a){var b=new f(a.target);e.inArray(b.nodeName(),["input",
"select"])&&a.preventDefault()}),j.on(i,"mouseup",function(a){var b=new f(a.target);e.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(d.gecko||g||d.opera){var n;n=(new f('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(h);n.on("focus",function(){a.focus()});a.activateGecko=function(){d.gecko&&a.__iframeFocus&&n[0].focus()};a.on("destroy",function(){n.detach();n.remove()})}j.on(c,"focus",function(){d.gecko?k(i,b):d.opera&&i.body.focus();
a.notifySelectionChange()});if(d.gecko)j.on(i,"mousedown",function(){a.__iframeFocus||k(i,b)});if(g&&(j.on(i,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.fire("save");b.preventDefault()}}}),"CSS1Compat"==i.compatMode)){var o={33:1,34:1};j.on(i,"keydown",function(b){b.keyCode in o&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}if(d.webkit)j.on(i,
"mousedown",function(b){b=new f(b.target);e.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(d.gecko)j.on(i,"dragstart",function(a){var b=new f(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});m.add(a)}function n(b,c,d,f){var g="",i,h=t.debugUrl("theme/editor-iframe.css");if(d)for(i=0;i<d.length;i++)g+=e.substitute('<link href="{href}" rel="stylesheet" />',{href:d[i]});return e.substitute(p,{doctype:8===a.documentMode?
'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:h,style:c||"",data:f||"&nbsp;",script:b?'<script id="ke_active_script">'+(A.isCustomDomain()?'document.domain="'+a.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function i(a,b){a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)}function u(a,b){function c(){j=h.document;a.__set("document",new f(j));a.__set("window",
new f(h));d.detach();j.open("text/html","replace");j.write(e);j.close()}var d=a.get("iframe"),e=n(a._UUID,a.get("customStyle"),a.get("customLink"),b),i=d[0],h=i.contentWindow,j;d.__loaded=1;try{j=h.document}catch(k){if(i.src=i.src,7>g){setTimeout(c,10);return}}c()}function q(a,b){var c=new f(C),e=a.get("textarea");e.hasAttr("tabindex")&&c.attr("tabIndex",d.webkit?-1:e.attr("tabIndex"));a.get("iframeWrapEl").prepend(c);a.set("iframe",c);a.__docReady=0;if(d.gecko&&!c.__loaded)c.on("load",function(){u(a,
b)},a);else u(a,b)}var x=!0,o=o,s=e.all,b=!1,a=document,d=e.UA,g=d.ie,A=e.DOM,f=e.Node,j=e.Event,h=t.tryThese,p="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ke-editor'>{data}{script}</body></html>",y=A.getEmptyIframeSrc(),C='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true" '+(y?' src="'+y+'"':"")+"</iframe>";e.mix(r,{SOURCE_MODE:0,
WYSIWYG_MODE:1});var B=r.WYSIWYG_MODE;e.augment(r,{createDom:function(){var a,b=this.get("textarea"),c;b||this.set("textarea",b=s("<textarea></textarea>"));c=this.get("el");c.addClass(this.get("prefixCls")+"editor-wrap",o);c.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=e.guid();this.set({iframeWrapEl:a=c.one(".ke-textarea-wrap"),toolBarEl:c.one(".ke-editor-tools"),statusBarEl:c.one(".ke-editor-status")},{silent:1});
b.css("width","100%");b.css("display","none");a.append(b);m.register(this)},_uiSetHeight:function(a){var b=this.get("toolBarEl"),c=this.get("statusBarEl"),a=parseInt(a,10),a=a-((b&&b.outerHeight()||0)+(c&&c.outerHeight()||0));this.get("iframeWrapEl").css("height",a);this.get("textarea").css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("iframe"),e=b.get("textarea");a==B?(b.execCommand("save"),b.on("docReady",c=function(){b.execCommand("save");b.detach("docReady",c)}),b._setData(e.val()),
b.fire("wysiwygMode")):(e.val(b._getData(1,B)),e[0].focus(),e.show(),d.hide(),b.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("textarea");if(b.get("attachForm")&&(c=d[0].form))A.on(c,"submit",b.sync,b),b.on("destroy",function(){A.detach(c,"submit",b.sync,b)});b.on("docReady",a)},destructor:function(){var a=this.get("el"),
b=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();m.remove(this);j.remove([c,c.documentElement,c.body,d]);e.each(this.__dialogs,function(a){a.destroy&&a.destroy()});this.__commands=0;this.__editor_created_new||(b.insertBefore(a,o),b.css({width:this.get("width"),height:this.get("height")}),b.show())},addDialog:function(a,b){this.__dialogs[a]=b},showDialog:function(a,b){var c=this.__dialogs[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,
dialogName:a})},hasDialog:function(a){return!!this.__dialogs[a]},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=e.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},_getData:function(a,b){var c=this.htmlDataProcessor,d;b==o&&(b=this.get("mode"));d=b==B?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=e.trim(d);
/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(a){var b,c=a;if(this.get("mode")!=B)this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a,"p");if(this.get("iframe")){a=this.get("iframe");b=a[0].contentWindow;var d=this.get("document")[0];j.remove([d,d.documentElement,d.body,b]);a.remove()}q(this,c)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return n(0,this.get("customStyle"),this.get("customLink"),
this.get("formatData"))},getSelection:function(){return r.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("document")[0],b=A._4e_getWin(a);d.ie||b&&b.parent&&b.parent.focus();b&&b.focus();a.body.focus();this.notifySelectionChange()},blur:function(){A._4e_getWin(this.get("document")[0]).blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||"",c=c+("\n"+a);this.set("customStyle",c);A.addStyleSheet(this.get("iframe")[0].contentWindow,
c,b)},removeCustomStyle:function(a){A.remove(A.get("#"+a,this.get("iframe")[0].contentWindow))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=A.query("link",b),c=0;c<b.length;c++)A.attr(b[c],"href")==a&&A.remove(b[c]);b=this.get("customLink")||[];a=e.indexOf(a,
b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new r.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=
null;this.checkSelectionChange()},insertElement:function(a,b,c){var d=this;if(d.get("mode")===B){d.focus();var e,f=a.nodeName(),g=r.XHTML_DTD,h=g.$block[f],j=r.RANGE,k=(f=d.getSelection())&&f.getRanges(),m,n,p;if(!k||0==k.length){var q=arguments,s=q.callee;setTimeout(function(){s.apply(d,q)},30)}else{d.execCommand("save");for(n=k.length-1;0<=n;n--)m=k[n],e=!n&&a||a.clone(x),b&&b(e),m.insertNodeByDtd(e),p||(p=e);p&&(m.moveToPosition(p,j.POSITION_AFTER_END),h&&(h=r.Walker.whitespaces(!0),(h=(p=p.next(h))&&
p[0].nodeType==A.ELEMENT_NODE&&p.nodeName())&&g.$block[h]&&g[h]["#"]&&m.moveToElementEditablePosition(p)),f.selectRanges([m]),d.focus(),e&&e.scrollIntoView(o,!1),i(d),c&&c(e))}}},insertHtml:function(a,c){var d=this,e;if(d.get("mode")===B){if(e=d.htmlDataProcessor)a=e.toDataFormat(a,null,c);d.focus();d.execCommand("save");var h=d.get("document")[0];e=0;if(g){var j=h.selection;"Control"==j.type&&j.clear();try{j.createRange().pasteHTML(a)}catch(k){}}else try{h.execCommand("inserthtml",b,a)}catch(m){setTimeout(function(){if(0==
d.getSelection().getRanges().length){var c=new r.Range(h),e=A.first(h.body,function(a){return 1==a.nodeType&&"br"!=A.nodeName(a)});e||(e=new f(h.createElement("p")),e._4e_appendBogus(o),h.body.appendChild(e[0]));c.setStartAt(e,r.RANGE.POSITION_AFTER_START);c.select()}h.execCommand("inserthtml",b,a)},e=100)}setTimeout(function(){d.getSelection().scrollIntoView()},e);i(d,e)}}});r._initIFrame=function(a){var e=m.getInstance(a),h=e.get("document")[0],a=h.getElementById("ke_active_script");A.remove(a);
c(e);var i=h.body;g?(i.hideFocus=x,i.disabled=x,i.contentEditable=x,i.removeAttribute("disabled")):setTimeout(function(){d.gecko||d.opera?i.contentEditable=x:d.webkit?i.parentNode.contentEditable=x:h.designMode="on"},0);if(d.gecko||d.opera){var n=h.documentElement;j.on(n,"mousedown",function(a){if(a.target==n){d.gecko&&k(h,b);e.activateGecko()}})}setTimeout(function(){g&&setTimeout(function(){if(h){i.runtimeStyle.marginBottom="0px";i.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){e.__docReady=
1;e.fire("docReady");var a=e.get("disableObjectResizing"),c=e.get("disableInlineTableEditing");if(a||c)try{h.execCommand("enableObjectResizing",b,!a);h.execCommand("enableInlineTableEditing",b,!c)}catch(d){j.on(i,g?"resizestart":"resize",function(b){var d=new f(b.target);(a||d.nodeName()==="table"&&c)&&b.preventDefault()})}},10)};return r},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
