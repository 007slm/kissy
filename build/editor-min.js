/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 10 20:25
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(i,u,w,s){u=s.create(w.Controller,[s.Box],{initializer:function(){var i;this.__commands={};this.__dialogs={};if(i=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var t=i.next();t?this.__set("elBefore",t):this.__set("render",i.parent())}this.get("width")||this.__set("width",i.style("width")||i.css("width"));this.get("height")||this.__set("height",i.style("height")||i.css("height"))}else this.__editor_created_new=1},use:function(l,t){for(var u=
this,r=u.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],l=l.split(","),d=l.length-1;0<=d;d--)l[d]||l.splice(d,1);for(d=0;d<r.length;d++){var h=r[d];i.inArray(h,l)||l.unshift(h)}i.each(l,function(d,h){l[h]&&(l[h]="editor/plugin/"+d+"/")});i.use(l.join(","),function(){var h=i.makeArray(arguments);h.shift();for(var d=0;d<h.length;d++)h[d].init(u);t&&t.call(u)});u.__CORE_PLUGINS=[];return u}},{Config:{base:i.Config.base+"editor/"},XHTML_DTD:u.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(i){return this._setData(i)}},formatData:{getter:function(){return this._getData(1)},setter:function(i){return this._setData(i)}},prefixCls:{value:"ke-"}}},"Editor");u.DefaultRender=s.create(w.Render,[s.Box.Render],{_uiSetHeight:function(){}});i.mix(u,i.EventTarget);return KISSY.Editor=u},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(i){function u(b){this.editor=b;this._init()}function w(b){if(t.ie&&"BackCompat"!=b.get("document")[0].compatMode){var c=b.getSelection(),g;if(c.getType()==o.SELECTION_ELEMENT&&(g=c.getSelectedElement())){var a=c.getRanges()[0],e=new l(b.get("document")[0].createTextNode(""));e.insertBefore(g);a.setStartBefore(e);a.setEndAfter(g);c.selectRanges([a]);setTimeout(function(){g.parent()&&(e.remove(),c.selectElement(g))},0)}}}var s=i.Editor,l=i.Node,t=i.UA,
v=s.Range,r=s.RANGE,d=i.Event;i.augment(u,{_init:function(){var b=this.editor;d.on(b.get("document")[0].body,t.webkit?"paste":t.gecko?"paste":"beforepaste",this._paste,this);d.on(b.get("document")[0].body,"contextmenu",function(){c=1;setTimeout(function(){c=0},10)});b.addCommand("copy",new p("copy"));b.addCommand("cut",new p("cut"));b.addCommand("paste",new p("paste"))},_paste:function(){if(!c){var b=this.editor,m=b.get("document")[0];if(!m.getElementById("ke_pastebin")){var g=b.getSelection(),a=
new v(m),e=new l(t.webkit?"<body></body>":"<div></div>",null,m);e.attr("id","ke_pastebin");t.webkit&&e[0].appendChild(m.createTextNode("\u00a0"));m.body.appendChild(e[0]);e.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var j=g.createBookmarks();a.setStartAt(e,r.POSITION_AFTER_START);a.setEndAt(e,r.POSITION_BEFORE_END);a.select(!0);setTimeout(function(){e.remove();var a;e=t.webkit&&(a=e.first())&&a.hasClass("Apple-style-span")?
a:e;g.selectBookmarks(j);a=e.html();if(a=i.trim(a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var c=b.fire("paste",{html:a,holder:e});void 0!==c&&(a=c);c=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(a)&&(c=b.htmlDataProcessor.wordFilter);b.insertHtml(a,c)}},0)}}}});var h=function(b,c){var g=b.get("document")[0],a=new l(g.body),e=!1,j=function(){e=!0};a.on(c,j);(7<t.ie?g:g.selection.createRange()).execCommand(c);a.detach(c,j);return e},k=t.ie?function(b,c){return h(b,
c)}:function(b,c){try{return b.get("document")[0].execCommand(c)}catch(g){return!1}},n={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},p=function(b){this.type=b};p.prototype={exec:function(b){"cut"==this.type&&w(b);(b=k(b,this.type))||alert(n[this.type]);return b}};var o=s.Selection,b={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},c;s.on("contextmenu",function(c){var m=c.contextmenu,g=m.get("editor"),
a=m.menu.get("contentEl"),e={copy:0,cut:0,paste:0},j;for(j in e)e.hasOwnProperty(j)&&(e[j]=a.one(".ke-paste-"+j),e[j]||function(j){var c=(new l("<a href='#'class='ke-paste-"+j+"'>"+b[j]+"</a>")).appendTo(a);c.on("click",function(a){a.halt();m.hide();setTimeout(function(){g.execCommand(j)},30)});e[j]=c}(j))});return{init:function(b){b.docReady(function(){new u(b)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(i){function u(b,c){var f=b[c?"next":"prev"]();if(f&&f[0].nodeType==h.NODE_ELEMENT){for(var m=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemovable(w);)if(m.push(f),f=c?f.next():f.prev(),!f)return;if(b._4e_isIdentical(f,w)){for(var g=new v(c?b[0].lastChild:b[0].firstChild);m.length;)m.shift()._4e_move(b,!c,w);f._4e_moveChildren(b,!c,w);f.remove();g[0]&&g[0].nodeType==h.NODE_ELEMENT&&g._4e_mergeSiblings()}}}var w=w,s=i.Editor,l=i.DOM,t=i.UA,v=i.Node,r=s.Utils,
d={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};s.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};s.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var h=s.NODE,k=s.POSITION,n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},p={hr:1},o=function(b){return b&&(b[0]||b)};r.injectDom({_4e_isBlockBoundary:function(b,c){var f=i.merge(p,c);return!(!n[l.css(b,"display")]&&!f[l._4e_name(b)])},_4e_getWin:l._getWin,_4e_index:function(b,c){for(var f=b.parentNode.childNodes,m,g=-1,a=0;a<f.length;a++)if(m=f[a],!c||!(3==m.nodeType&&m.previousSibling&&3==m.previousSibling.nodeType))if(g++,m===b)return g;return-1},_4e_move:function(b,
c,f){c=o(c);f?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4e_name:function(b){var c=b.nodeName.toLowerCase();t.ie&&(b=b.scopeName)&&"HTML"!=b&&(c=b.toLowerCase()+":"+c);return c},_4e_isIdentical:function(b,c){if(!c)return!1;c=o(c);if(l._4e_name(b)!=l._4e_name(c))return!1;var f=b.attributes,m=c.attributes,g=f.length,a=m.length;if(g!=a)return!1;for(var e=0;e<g;e++){var j=f[e],q=j.name;if(j.specified&&l.attr(b,q)!=l.attr(c,q))return!1}if(8>r.ieEngine)for(e=0;e<a;e++)if(j=m[e],q=j.name,j.specified&&
l.attr(b,q)!=l.attr(c,q))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){for(var b=b.childNodes,c=0,f=b.length;c<f;c++){var m=b[c],g=m.nodeType;if(!(g==h.NODE_ELEMENT&&m.getAttribute("_ke_bookmark"))&&(g==h.NODE_ELEMENT&&!l._4e_isEmptyInlineRemovable(m)||g==h.NODE_TEXT&&i.trim(m.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,c,f){c=o(c);if(b!=c)if(f)for(;f=b.lastChild;)c.insertBefore(b.removeChild(f),c.firstChild);else for(;f=b.firstChild;)c.appendChild(b.removeChild(f))},_4e_mergeSiblings:function(b){b=
new v(b);d[b._4e_name()]&&(u(b,!0),u(b))},_4e_splitText:function(b,c){var f=b.ownerDocument;if(b.nodeType==h.NODE_TEXT){if(t.ie&&c==b.nodeValue.length){var m=f.createTextNode("");l.insertAfter(m,b);return m}m=b.splitText(c);f.documentMode&&(f=f.createTextNode(""),l.insertAfter(f,m),l.remove(f));return m}},_4e_parents:function(b,c){var f=[];f.__IS_NODELIST=1;do f[c?"push":"unshift"](b);while(b=b.parentNode);return f},_4e_nextSourceNode:function(b,c,f,m){if(m&&!m.call)var g=o(m),m=function(a){return a!==
g};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType==h.NODE_ELEMENT&&m&&!1===m(b,!0))return null;c=b.nextSibling}for(;!c&&(a=a.parentNode);){if(m&&!1===m(a,!0))return null;c=a.nextSibling}return!c||m&&!1===m(c)?null:f&&f!=c.nodeType?l._4e_nextSourceNode(c,!1,f,m):c},_4e_previousSourceNode:function(b,c,f,m){if(m&&!m.call)var g=o(m),m=function(a){return a!==g};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType==h.NODE_ELEMENT&&m&&!1===m(b,!0))return null;c=b.previousSibling}for(;!c&&(a=a.parentNode);){if(m&&
!1===m(a,!0))return null;c=a.previousSibling}return!c||m&&!1===m(c)?null:f&&c.nodeType!=f?l._4e_previousSourceNode(c,!1,f,m):c},_4e_commonAncestor:function(b,c){c=o(c);if(b===c)return b;if(l.contains(c,b))return c;var f=b;do if(l.contains(f,c))return f;while(f=f.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(b){for(var c=b.attributes,f=0;f<c.length;f++){var m=c[f];switch(m.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(m.specified)return!0}}return!1}:function(b){t.gecko&&
b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4e_position:function(b,c){var f=o(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(f);if(b==f)return k.POSITION_IDENTICAL;if(b.nodeType==h.NODE_ELEMENT&&f.nodeType==h.NODE_ELEMENT){if(l.contains(b,f))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(l.contains(f,b))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>f.sourceIndex?k.POSITION_DISCONNECTED:b.sourceIndex<f.sourceIndex?
k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var m=l._4e_address(b),f=l._4e_address(f),g=Math.min(m.length,f.length),a=0;a<=g-1;a++)if(m[a]!=f[a])return m[a]<f[a]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return m.length<f.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4e_address:function(b,c){for(var f=[],m=b.ownerDocument.documentElement,g=b;g&&g!=m;)f.unshift(l._4e_index(g,c)),g=g.parentNode;return f},_4e_remove:function(b,c){var f=b.parentNode;
if(f){if(c)for(var m;m=b.firstChild;)f.insertBefore(b.removeChild(m),b);f.removeChild(b)}return b},_4e_trim:function(b){l._4e_ltrim(b);l._4e_rtrim(b)},_4e_ltrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType==h.NODE_TEXT){var f=r.ltrim(c.nodeValue),m=c.nodeValue.length;if(f)f.length<m&&(l._4e_splitText(c,m-f.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){for(var c;c=b.lastChild;){if(c.type==h.NODE_TEXT){var f=r.rtrim(c.nodeValue),m=c.nodeValue.length;
if(f)f.length<m&&(l._4e_splitText(c,f.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!t.ie&&!t.opera&&(c=b.lastChild)&&1==c.nodeType&&"br"==l._4e_name(c)&&b.removeChild(c)},_4e_appendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType==h.NODE_TEXT&&!i.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==h.NODE_TEXT||"br"!==l._4e_name(c))c=t.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),t.gecko&&c.setAttribute("type","_moz"),b.appendChild(c)},
_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");c.appendChild(b.cloneNode(!0));return c.innerHTML},_4e_setMarker:function(b,c,f,m){var b=new v(b),g=b.data("list_marker_id")||b.data("list_marker_id",i.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[g]=b;a[f]=1;return b.data(f,m)},_4e_clearMarkers:function(b,c,f){var b=new v(b),m=b.data("list_marker_names"),
g=b.data("list_marker_id"),a;for(a in m)m.hasOwnProperty(a)&&b.removeData(a);b.removeData("list_marker_names");f&&(b.removeData("list_marker_id"),delete c[g])},_4e_copyAttributes:function(b,c,f){for(var c=new v(c),m=b.attributes,f=f||{},g=0;g<m.length;g++){var a=m[g],e=a.name.toLowerCase(),j;if(!(e in f))if("checked"==e&&(j=l.attr(b,e)))c.attr(e,j);else if(a.specified||t.ie&&a.value&&"value"==e)j=l.attr(b,e),null===j&&(j=a.nodeValue),c.attr(e,j)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},
_4e_isEditable:function(b){var b=l._4e_name(b),c=s.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(i){function u(b){1>arguments.length||(this.range=b,this.forceBrBreak=s,this.enlargeBr=w,this.enforceRealBlocks=s,this._||(this._={}))}var w=!0,s=!1,l=i.Editor,t=i.UA,v=l.Walker,r=l.Range,d=l.RANGE,h=l.NODE,k=l.ElementPath,n=i.Node,p=i.DOM,o=/^[\r\n\t ]*$/;i.augment(u,{getNextParagraph:function(b){var c,f,m,g,a;if(!this._.lastNode){f=this.range.clone();f.shrink(d.SHRINK_ELEMENT,w);f.enlarge(this.forceBrBreak||!this.enlargeBr?d.ENLARGE_LIST_ITEM_CONTENTS:
d.ENLARGE_BLOCK_CONTENTS);var e=new v(f),j=v.bookmark(w,w);e.evaluator=j;this._.nextNode=e.next();e=new v(f);e.evaluator=j;e=e.previous();this._.lastNode=e._4e_nextSourceNode(w);this._.lastNode&&this._.lastNode[0].nodeType==h.NODE_TEXT&&!i.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new r(f.document),j.moveToPosition(this._.lastNode,d.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new k(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(w)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new n(f.document.createTextNode("")),p.insertAfter(this._.lastNode[0],e[0]));f=null}j=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;j;){var q=s,x=j[0].nodeType!=h.NODE_ELEMENT,y=s;if(x)j[0].nodeType==h.NODE_TEXT&&o.test(j[0].nodeValue)&&(x=s);else{var l=j._4e_name();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==l)x=w;else if(!f&&!j[0].childNodes.length&&"hr"!=l){c=j;m=j.equals(e);break}f&&(f.setEndAt(j,d.POSITION_BEFORE_START),
"br"!=l&&(this._.nextNode=j));q=w}else{if(j[0].firstChild){f||(f=new r(this.range.document),f.setStartAt(j,d.POSITION_BEFORE_START));j=new n(j[0].firstChild);continue}x=w}}x&&!f&&(f=new r(this.range.document),f.setStartAt(j,d.POSITION_BEFORE_START));m=(!q||x)&&j.equals(e);if(f&&!q)for(;!j[0].nextSibling&&!m;){l=j.parent();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){q=w;m||l.equals(e);break}j=l;x=w;m=j.equals(e);y=w}x&&f.setEndAt(j,d.POSITION_AFTER_END);j=j._4e_nextSourceNode(y,null,e);if((m=
!j)||q&&f)break}if(!c){if(!f)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new k(f.startContainer);j=c.blockLimit;q={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&q[j._4e_name()]&&f.checkStartOfBlock()&&f.checkEndOfBlock())c=j;else if(!c||this.enforceRealBlocks&&"li"==c._4e_name())c=new n(this.range.document.createElement(b||"p")),c[0].appendChild(f.extractContents()),c._4e_trim(),f.insertNode(c),g=a=w;else if("li"!=c._4e_name()){if(!f.checkStartOfBlock()||
!f.checkEndOfBlock())c=c.clone(s),c[0].appendChild(f.extractContents()),c._4e_trim(),a=f.splitBlock(),g=!a.wasStartOfBlock,a=!a.wasEndOfBlock,f.insertNode(c)}else m||(this._.nextNode=c.equals(e)?null:f.getBoundaryNodes().endNode._4e_nextSourceNode(w,null,e))}g&&(f=new n(c[0].previousSibling),f[0]&&f[0].nodeType==h.NODE_ELEMENT&&("br"==f._4e_name()?f._4e_remove():f[0].lastChild&&"br"==p._4e_name(f[0].lastChild)&&p._4e_remove(f[0].lastChild)));a&&(f=v.bookmark(s,w),g=new n(c[0].lastChild),g[0]&&g[0].nodeType==
h.NODE_ELEMENT&&"br"==g._4e_name()&&(t.ie||g.prev(f)||g.next(f))&&g.remove());this._.nextNode||(this._.nextNode=m||c.equals(e)?null:c._4e_nextSourceNode(w,null,e));return c}});r.prototype.createIterator=function(){return new u(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(i){function u(h){for(var i=v,n=v,p=[];h;){if(h[0].nodeType==t.NODE_ELEMENT){this.lastElement||(this.lastElement=h);var o=h._4e_name();if(!n&&(!i&&r[o]&&(i=h),d[o])){var b;if(b=!i)if(b="div"==o){a:{b=h[0].childNodes;for(var c=0,f=b.length;c<f;c++){var m=b[c];if(m.nodeType==t.NODE_ELEMENT&&l.$block[m.nodeName.toLowerCase()]){b=!0;break a}}b=!1}b=!b}b?i=h:n=h}p.push(h);if("body"==o)break}h=h.parent()}this.block=i;this.blockLimit=n;this.elements=p}var w=i.Editor,
s=i.DOM,l=w.XHTML_DTD,t=w.NODE,v=null,r={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},d={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};u.prototype={compare:function(h){var d=this.elements,h=h&&h.elements;if(!h||d.length!=h.length)return!1;for(var n=0;n<d.length;n++)if(!s.equals(d[n],h[n]))return!1;return!0},contains:function(d){for(var i=this.elements,n=0;n<i.length;n++)if(i[n]._4e_name()in d)return i[n];return v},toString:function(){var d=this.elements,
i,n=[];for(i=0;i<d.length;i++)n.push(d[i]._4e_name());return n.toString()}};return w.ElementPath=u},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(i){function u(d){var p;p=d.getSelection().getRanges();for(var o=p.length-1;0<o;o--)p[o].deleteContents();p=p[0];o=p.document;if(p.checkStartOfBlock()&&p.checkEndOfBlock()){var b=(new k(p.startContainer)).block;if(b&&("li"==b._4e_name()||"li"==b.parent()._4e_name()))return d.hasCommand("outdent")?(d.execCommand("save"),d.execCommand("outdent"),d.execCommand("save"),!0):!1}var c=p.splitBlock("p");if(!c)return!0;var d=c.previousBlock,b=c.nextBlock,f=
c.wasStartOfBlock,m=c.wasEndOfBlock,g;if(b)g=b.parent(),"li"==g._4e_name()&&(b._4e_breakParent(g),b._4e_move(b.next(),!0));else if(d&&(g=d.parent())&&"li"==g._4e_name())d._4e_breakParent(g),p.moveToElementEditablePosition(d.next()),d._4e_move(d.prev());if(!f&&!m){if("li"==b._4e_name()&&(g=b.first(h.invisible(!0)))&&i.inArray(g._4e_name(),["ul","ol"]))(l.ie?new r(o.createTextNode("\u00a0")):new r(o.createElement("br"))).insertBefore(g);b&&p.moveToElementEditablePosition(b)}else{var a;if(d){if("li"==d._4e_name()||
!t.test(d._4e_name()))a=d.clone()}else b&&(a=b.clone());a||(a=new r("<p>",null,o));if(g=c.elementPath)for(var c=0,e=g.elements.length;c<e;c++){var j=g.elements[c];if(j.equals(g.block)||j.equals(g.blockLimit))break;v.$removeEmpty[j._4e_name()]&&(j=j.clone(),a._4e_moveChildren(j),a.append(j))}l.ie||a._4e_appendBogus();p.insertNode(a);if(l.ie&&f&&(!m||!d[0].childNodes.length))p.moveToElementEditablePosition(m?d:a),p.select();p.moveToElementEditablePosition(f&&!m?b:a)}l.ie||(b?(a=new r(o.createElement("span")),
a.html("&nbsp;"),p.insertNode(a),a.scrollIntoView(void 0,!1),p.deleteContents()):a.scrollIntoView(void 0,!1));p.select();return!0}function w(h){var i=h.get("document")[0];d.on(i,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){h.execCommand("save");var b=h.execCommand("enterBlock");h.execCommand("save");!1!==b&&d.preventDefault()}})}var s=i.Editor,l=i.UA,t=/^h[1-6]$/,v=s.XHTML_DTD,r=i.Node,d=i.Event,h=s.Walker,k=s.ElementPath;return{init:function(d){d.addCommand("enterBlock",
{exec:u});d.docReady(function(){w(d)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(i){function u(){var i=this;i.__iframeFocus=h;d=i;r&&clearTimeout(r);r=setTimeout(function(){i.fire("focus")},100)}function w(){var h=this;h.__iframeFocus=k;d=n;r&&clearTimeout(r);r=setTimeout(function(){h.fire("blur")},100)}var s=i.Editor,l=i.DOM,t=i.Event,v={},r,d,i={refreshAll:function(){for(var d in v)if(v.hasOwnProperty(d)){var h=v[d].get("document")[0];h.designMode="off";h.designMode="on"}},currentInstance:function(){return d},getInstance:function(d){return v[d]},
add:function(d){var h=l._4e_getWin(d.get("document")[0]);t.on(h,"focus",u,d);t.on(h,"blur",w,d)},register:function(d){v[d._UUID]=d},remove:function(d){delete v[d._UUID];var h=l._4e_getWin(d.get("document")[0]);t.remove(h,"focus",u,d);t.remove(h,"blur",w,d)}},h=!0,k=!1,n=null;i.refreshAll=i.refreshAll;s.focusManager=i;s.getInstances=function(){return v};return i},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(i){return{init:function(u){function w(c){return c.replace(o,function(c,g,a){return"<"+g+a.replace(b,function(e,b){return-1==a.indexOf("_ke_saved_"+b)?" _ke_saved_"+e+" "+e:e})+">"})}function s(b){return b.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(b){return"<\!--"+c+"{C}"+encodeURIComponent(b).replace(/--/g,"%2D%2D")+"--\>"})}function l(b){return b.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(b,c){return decodeURIComponent(c)})}
var t=t,v=i.Editor,r=i.Node,d=i.UA,h=i.require("htmlparser"),k=new h.Filter,n=new h.Filter,p=new h.Filter;(function(){var b=function(a,b){return function(j,c){var g=[];(""+j).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(j,A,d){A=A.toLowerCase();"font-family"==A&&(d=d.replace(/["']/g,""));for(var h,m,f,i=0;i<a.length;i++)if(a[i]&&(j=a[i][0],h=a[i][1],m=a[i][2],f=a[i][3],A.match(j)&&(!h||d.match(h)))){A=f||A;b&&(m=m||d);"function"==typeof m&&(m=m(d,c,A));m&&m.push&&
(A=m[0],m=m[1]);"string"==typeof m&&g.push([A,m]);return}!b&&g.push([A,d])});for(var d=0;d<g.length;d++)g[d]=g[d].join(":");return g.length?g.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],t),m={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var b=a.nodeName||"";if(-1!=b.indexOf(":")&&
!/^ke/.test(b))if("v:imagedata"==b){if(b=a.getAttribute("o:href"))a.setAttribute("src",b),a.removeAttribute("o:href");if(b=a.getAttribute("o:title"))a.setAttribute("title",b),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=b(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],j,c=0;c<b.length;c++)j="_ke_saved_"+b[c],a.getAttribute(j)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var j=b.getAttribute("width"),b=b.getAttribute("height");j&&a.setAttribute("width",j);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!i.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,c.length)==c?(a="{C}"==a.substr(c.length,3)?a.substr(c.length+3):a.substr(c.length),new h.CData(decodeURIComponent(a))):a}};d.ie&&(g.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});k.addRules(g);n.addRules(m);p.addRules(m)})();(function(){function b(a){for(var a=a.childNodes,e=a.length,j=a[e-1];j&&3==j.nodeType&&!i.trim(j.nodeValue);)j=a[--e];return j}
function c(a,e){var g=b(a);g&&((e||!d.ie)&&1==g.nodeType&&"br"==g.nodeName?a.removeChild(g):3==g.nodeType&&j.test(g.nodeValue)&&a.removeChild(g))}function g(a){var e=b(a);return!e||1==e.nodeType&&"br"==e.nodeName||"form"==a.nodeName&&"input"==e.nodeName}function a(a){c(a,!0);g(a)&&(d.ie?a.appendChild(new h.Text("\u00a0")):(a.appendChild(new h.Text("&nbsp;")),a.appendChild(new h.Tag("br"))))}function e(a){c(a,!1);g(a)&&a.appendChild(new h.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,q=v.XHTML_DTD,x=v.Utils.mix({},
q.$block,q.$listItem,q.$tableContent),l;for(l in x)x.hasOwnProperty(l)&&("br"in q[l]||delete x[l]);delete x.td;delete x.pre;var q={tags:{}},o={tags:{}};for(l in x)x.hasOwnProperty(l)&&(q.tags[l]=a,o.tags[l]=e);n.addRules(q);k.addRules(o);p.addRules(q)})();(function(){k.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}})})();var o=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}";u.htmlDataProcessor={wordFilter:p,
dataFilter:n,htmlFilter:k,toHtml:function(b){var c=new h.BeautifyWriter;(new h.Parser(b)).parse().writeHtml(c,k);return c.getHtml()},toDataFormat:function(b,c,g){g=g||n;d.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=w(b);c=new r("<div>");c.html("a"+b);b=c.html().substr(1);b=l(b);c=new h.BeautifyWriter;(new h.Parser(b)).parse().writeHtml(c,g);b=c.getHtml();return b=s(b)},toServer:function(b){var c=new h.MinifyWriter;(new h.Parser(b)).parse().writeHtml(c,
k);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(i,u,w,s,l){function t(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=o;this.collapsed=n;this.document=a}function v(a){var j=a.nodeType!=b.NODE_TEXT&&m._4e_name(a)in e.$removeEmpty,c=!i.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return j||c||a}function r(a){return!y(a)&&!B(a)}function d(e){var j=p,c=s.bookmark(n);return function(g){if(c(g))return n;if(g.nodeType==b.NODE_TEXT){if(i.trim(g.nodeValue).length)return p}else if(g.nodeType==
b.NODE_ELEMENT&&(g=m._4e_name(g),!x[g]))if(!e&&!a.ie&&"br"==g&&!j)j=n;else return p;return n}}function h(a,b){function e(a){return a&&"span"==a.nodeName&&a.getAttribute("_ke_bookmark")}return function(j){var c,g;c=j&&!j.nodeName&&(g=j.parentNode)&&e(g);c=a?c:c||e(j);return b^c}}function k(a){return function(e){e=(e=e[0]||e)&&e.nodeType==b.NODE_TEXT&&!i.trim(e.nodeValue);return a^e}}u.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,p=!1,o=null,b=u.NODE,c=u.RANGE,f=u.POSITION,m=i.DOM,g=w.getByAddress,a=i.UA,e=u.XHTML_DTD,j=i.Node,q={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};t.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+":"+this.endOffset);return a.join("<br/>")};
i.augment(t,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&m.equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,e=this.startOffset;a[0].nodeType!=b.NODE_ELEMENT&&(e?e>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;e=this.endOffset;a[0].nodeType!=b.NODE_ELEMENT&&(e?e>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),
a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a._4e_name()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b._4e_name()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,e){a[0].nodeType==b.NODE_ELEMENT&&q[a._4e_name()]&&
(a=a.parent(),e=a._4e_index());this.startContainer=a;this.startOffset=e;this.endContainer||(this.endContainer=a,this.endOffset=e);this.updateCollapsed()},setEnd:function(a,e){a[0].nodeType==b.NODE_ELEMENT&&q[a._4e_name()]&&(a=a.parent(),e=a._4e_index()+1);this.endContainer=a;this.endOffset=e;this.startContainer||(this.startContainer=a,this.startOffset=e);this.updateCollapsed()},setStartAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==
b.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;
case c.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},cloneContents:function(){return this.execContentsAction(2)},deleteContents:function(){return this.execContentsAction(0)},extractContents:function(){return this.execContentsAction(1)},execContentsAction:function(a){var e=this.startContainer,c=this.endContainer,g=this.startOffset,d=this.endOffset,h,q=p,i=p,f,x=this.document,l;if(this.collapsed)return f;0<a&&(f=x.createDocumentFragment());this.optimizeBookmark();c[0].nodeType==b.NODE_TEXT?
(i=n,c=c._4e_splitText(d)):0<c[0].childNodes.length&&(d>=c[0].childNodes.length?(c=new j(c[0].appendChild(x.createTextNode(""))),l=n):c=new j(c[0].childNodes[d]));e[0].nodeType==b.NODE_TEXT?(q=n,e._4e_splitText(g)):g?g>=e[0].childNodes.length?(e=new j(e[0].appendChild(x.createTextNode(""))),h=n):e=new j(e[0].childNodes[g].previousSibling):(h=new j(x.createTextNode("")),e.prepend(h),e=h,h=n);var k=e._4e_parents(),y=c._4e_parents();k.each(function(a,b){k[b]=a});y.each(function(a,b){y[b]=a});for(var o,
H,x=0;x<k.length&&!(o=k[x],H=y[x],!o.equals(H));x++);for(var g=f,z,I,L=x;L<k.length;L++){z=k[L];d=0<a&&!z.equals(e)?g.appendChild(z.clone()[0]):null;z=z[0].nextSibling;for(var S=c[0],t=y[L][0];z&&!(t==z||S==z);)I=z.nextSibling,2==a?g.appendChild(z.cloneNode(n)):(m._4e_remove(z),1==a&&g.appendChild(z)),z=I;d&&(g=d)}for(g=f;x<y.length;x++){z=y[x];d=0<a&&!z.equals(c)?g.appendChild(z.clone()[0]):null;if(!k[x]||z[0].parentNode!=k[x][0].parentNode)for(z=z[0].previousSibling;z;)I=z.previousSibling,2==a?
g.insertBefore(z.cloneNode(n),g.firstChild):(m._4e_remove(z),1==a&&g.insertBefore(z,g.firstChild)),z=I;d&&(g=d)}if(2==a){if(q&&(o=e[0],o.nodeType==b.NODE_TEXT&&o.nextSibling&&o.nextSibling.nodeType==b.NODE_TEXT&&(o.data+=o.nextSibling.data,o.parentNode.removeChild(o.nextSibling))),i)i=c[0],i.nodeType==b.NODE_TEXT&&i.previousSibling&&i.previousSibling.nodeType==b.NODE_TEXT&&(i.previousSibling.data+=i.data,i.parentNode.removeChild(i))}else{if(o&&H&&(!e.parent().equals(o.parent())||!c.parent().equals(H.parent())))i=
o._4e_index(),h&&o.parent().equals(h.parent())&&i--,this.setStart(o.parent(),i+1);this.collapse(n)}h&&e.remove();l&&c.remove();return f},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new t(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=
this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=b.NODE_ELEMENT||a.endContainer[0].nodeType!=b.NODE_ELEMENT)return o;var e=new u.Walker(a),c=h(n,void 0),j=k(n);a.evaluator=function(a){return j(a)&&c(a)};a=e.next();e.reset();e=e.previous();return a&&a.equals(e)?a:o},shrink:function(a,e){if(!this.collapsed){var a=a||c.SHRINK_TEXT,j=this.clone(),g=this.startContainer,d=this.endContainer,h=this.startOffset,q=this.endOffset,m=1,i=1;g&&
g[0].nodeType==b.NODE_TEXT&&(h?h>=g[0].nodeValue.length?j.setStartAfter(g):(j.setStartBefore(g),m=0):j.setStartBefore(g));d&&d[0].nodeType==b.NODE_TEXT&&(q?q>=d[0].nodeValue.length?j.setEndAfter(d):(j.setEndAfter(d),i=0):j.setEndBefore(d));j=new s(j);j.evaluator=function(e){return e.nodeType==(a==c.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)};var f;j.guard=function(e,j){e=e[0]||e;if(a==c.SHRINK_ELEMENT&&e.nodeType==b.NODE_TEXT||j&&e==f)return p;!j&&e.nodeType==b.NODE_ELEMENT&&(f=e);return n};m&&(g=
j[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(g,e?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);i&&(j.reset(),(j=j[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,e?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return!(!m&&!i)}},createBookmark2:function(a){var e=this.startContainer,c=this.endContainer,g=this.startOffset,d=this.endOffset,h,q;if(!e||!c)return{start:0,end:0};if(a){if(e[0].nodeType==b.NODE_ELEMENT&&(h=new j(e[0].childNodes[g]))&&h[0]&&h[0].nodeType==
b.NODE_TEXT&&0<g&&h[0].previousSibling.nodeType==b.NODE_TEXT)e=h,g=0;for(;e[0].nodeType==b.NODE_TEXT&&(q=e.prev())&&q[0].nodeType==b.NODE_TEXT;)e=q,g+=q[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==b.NODE_ELEMENT&&(h=new j(c[0].childNodes[d]))&&h[0]&&h[0].nodeType==b.NODE_TEXT&&0<d&&h[0].previousSibling.nodeType==b.NODE_TEXT)c=h,d=0;for(;c[0].nodeType==b.NODE_TEXT&&(q=c.prev())&&q[0].nodeType==b.NODE_TEXT;)c=q,d+=q[0].nodeValue.length}}return{start:e._4e_address(a),end:this.collapsed?
o:c._4e_address(a),startOffset:g,endOffset:d,normalized:a,is2:n}},createBookmark:function(a){var b,e,g,d,h=this.collapsed;b=new j("<span>",o,this.document);b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");a&&(g=i.guid("ke_bm_"),b.attr("id",g+"S"));h||(e=b.clone(),e.html("&nbsp;"),a&&e.attr("id",g+"E"),d=this.clone(),d.collapse(),d.insertNode(e));d=this.clone();d.collapse(n);d.insertNode(b);e?(this.setStartAfter(b),this.setEndBefore(e)):this.moveToPosition(b,c.POSITION_AFTER_END);
return{startNode:a?g+"S":b,endNode:a?g+"E":e,serializable:a,collapsed:h}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(n)},trim:function(a,e){var c=this.startContainer,j=this.startOffset,g=this.collapsed;if((!a||g)&&c[0]&&c[0].nodeType==b.NODE_TEXT){if(j)if(j>=c[0].nodeValue.length)j=c._4e_index()+1,c=c.parent();else{var d=c._4e_splitText(j),j=c._4e_index()+1,c=c.parent();m.equals(this.startContainer,this.endContainer)?this.setEnd(d,this.endOffset-this.startOffset):m.equals(c,this.endContainer)&&
(this.endOffset+=1)}else j=c._4e_index(),c=c.parent();this.setStart(c,j);if(g){this.collapse(n);return}}c=this.endContainer;j=this.endOffset;!e&&!g&&c[0]&&c[0].nodeType==b.NODE_TEXT&&(j?(j>=c.nodeValue.length||c._4e_splitText(j),j=c._4e_index()+1):j=c._4e_index(),c=c.parent(),this.setEnd(c,j))},insertNode:function(a){this.optimizeBookmark();this.trim(p,n);var b=this.startContainer;b[0].insertBefore(a[0]||a,b[0].childNodes[this.startOffset]||null);m.equals(a.parent(),this.endContainer)&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var b=g(this.document,a.start,a.normalized),e=a.startOffset,c=a.end&&g(this.document,a.end,a.normalized),a=a.endOffset;this.setStart(b,e);c?this.setEnd(c,a):this.collapse(n)}else b=(e=a.serializable)?i.one("#"+a.startNode,this.document):a.startNode,a=e?i.one("#"+a.endNode,this.document):a.endNode,this.setStartBefore(b),b._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,e){var c=this.startContainer,
g=this.endContainer,c=m.equals(c,g)?a&&c[0].nodeType==b.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new j(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(g);return e&&c[0].nodeType==b.NODE_TEXT?c.parent():c},enlarge:function(a){switch(a){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var a=this.getCommonAncestor(),g=new j(this.document.body),d,h,q,f,x,l=p,k,y;k=this.startContainer;y=this.startOffset;if(k[0].nodeType==b.NODE_TEXT){if(y&&(k=!i.trim(k[0].nodeValue.substring(0,y)).length&&
k,l=!!k),k&&!(f=k[0].previousSibling))q=k.parent()}else y&&(f=k[0].childNodes[y-1]||k[0].lastChild),f||(q=k);for(;q||f;){if(q&&!f){!x&&m.equals(q,a)&&(x=n);if(!g.contains(q))break;if(!l||"inline"!=q.css("display"))l=p,x?d=q:this.setStartBefore(q);f=q[0].previousSibling}for(;f;){k=p;if(f.nodeType==b.NODE_TEXT)y=f.nodeValue,/[^\s\ufeff]/.test(y)&&(f=o),k=/[\s\ufeff]$/.test(y);else if((0<f.offsetWidth||"br"==m._4e_name(f))&&!f.getAttribute("_ke_bookmark"))if(l&&e.$removeEmpty[f.nodeName.toLowerCase()]){y=
m.text(f);if(/[^\s\ufeff]/.test(y))f=o;else for(var u=f.all||f.getElementsByTagName("*"),r=0,v;v=u[r++];)if(!e.$removeEmpty[v.nodeName.toLowerCase()]){f=o;break}f&&(k=!!y.length)}else f=o;k&&(l?x?d=q:q&&this.setStartBefore(q):l=n);if(f){k=f.previousSibling;if(!q&&!k){q=new j(f);f=o;break}f=k}else q=o}q&&(q=q.parent())}k=this.endContainer;y=this.endOffset;q=f=o;x=l=p;if(k[0].nodeType==b.NODE_TEXT){if(k=!i.trim(k[0].nodeValue.substring(y)).length&&k,l=!(k&&k[0].nodeValue.length),k&&!(f=k[0].nextSibling))q=
k.parent()}else(f=k[0].childNodes[y])||(q=k);for(;q||f;){if(q&&!f){!x&&m.equals(q,a)&&(x=n);if(!g.contains(q))break;if(!l||"inline"!=q.css("display"))l=p,x?h=q:q&&this.setEndAfter(q);f=q[0].nextSibling}for(;f;){k=p;if(f.nodeType==b.NODE_TEXT)y=f.nodeValue,/[^\s\ufeff]/.test(y)&&(f=o),k=/^[\s\ufeff]/.test(y);else if((0<f.offsetWidth||"br"==m._4e_name(f))&&!f.getAttribute("_ke_bookmark"))if(l&&e.$removeEmpty[f.nodeName.toLowerCase()]){y=m.text(f);if(/[^\s\ufeff]/.test(y))f=o;else{u=f.all||f.getElementsByTagName("*");
for(r=0;v=u[r++];)if(!e.$removeEmpty[v.nodeName.toLowerCase()]){f=o;break}}f&&(k=!!y.length)}else f=o;k&&l&&(x?h=q:this.setEndAfter(q));if(f){k=f.nextSibling;if(!q&&!k){q=new j(f);f=o;break}f=k}else q=o}q&&(q=q.parent())}d&&h&&(a=d.contains(h)?h:d,this.setStartBefore(a),this.setEndAfter(a));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:q=new t(this.document);g=new j(this.document.body);q.setStartAt(g,c.POSITION_AFTER_START);q.setEnd(this.startContainer,this.startOffset);q=
new s(q);var B,H,z=s.blockBoundary(a==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:o),I=function(a){var b=z(a);b||(B=new j(a));return b};d=function(a){var b=I(a);!b&&"br"==m._4e_name(a)&&(H=new j(a));return b};q.guard=I;q=q.lastBackward();B=B||g;this.setStartAt(B,"br"!=B._4e_name()&&(!q&&this.checkStartOfBlock()||q&&B.contains(q))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);q=this.clone();q.collapse();q.setEndAt(g,c.POSITION_BEFORE_END);q=new s(q);q.guard=a==c.ENLARGE_LIST_ITEM_CONTENTS?d:I;B=o;q=q.lastForward();
B=B||g;this.setEndAt(B,!q&&this.checkEndOfBlock()||q&&B.contains(q)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);H&&this.setEndAfter(H)}},checkStartOfBlock:function(){var a=this.startContainer,e=this.startOffset;if(e&&a[0].nodeType==b.NODE_TEXT&&i.trim(a[0].nodeValue.substring(0,e)).length)return p;this.trim();a=new l(this.startContainer);e=this.clone();e.collapse(n);e.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new s(e);a.evaluator=d(n);return a.checkBackward()},checkEndOfBlock:function(){var a=
this.endContainer,e=this.endOffset;if(a[0].nodeType==b.NODE_TEXT&&i.trim(a[0].nodeValue.substring(e)).length)return p;this.trim();a=new l(this.endContainer);e=this.clone();e.collapse(p);e.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new s(e);a.evaluator=d(p);return a.checkForward()},checkBoundaryOfElement:function(a,e){var b=this.clone();b[e==c.START?"setStartAt":"setEndAt"](a,e==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);b=new s(b);b.evaluator=v;return b[e==c.START?"checkBackward":
"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,e=this.endContainer,c=this.startOffset,g=this.endOffset,d;if(a[0].nodeType==b.NODE_ELEMENT)if(d=a[0].childNodes.length,d>c)a=new j(a[0].childNodes[c]);else if(1>d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new j(a);a=a._4e_nextSourceNode()||a}if(e[0].nodeType==b.NODE_ELEMENT)if(d=e[0].childNodes.length,d>g)e=(new j(e[0].childNodes[g]))._4e_previousSourceNode(n);else if(1>d)e=e._4e_previousSourceNode();
else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new j(e)}a._4e_position(e)&f.POSITION_FOLLOWING&&(a=e);return{startNode:a,endNode:e}},fixBlock:function(e,b){var g=this.createBookmark(),d=new j(this.document.createElement(b));this.collapse(e);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();a.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(g);return d},splitBlock:function(e){var b=new l(this.startContainer),j=new l(this.endContainer),g=b.block,
d=j.block,q=o;if(!b.blockLimit.equals(j.blockLimit))return o;"br"!=e&&(g||(g=this.fixBlock(n,e),d=(new l(this.endContainer)).block),d||(d=this.fixBlock(p,e)));e=g&&this.checkStartOfBlock();b=d&&this.checkEndOfBlock();this.deleteContents();g&&m.equals(g,d)&&(b?(q=new l(this.startContainer),this.moveToPosition(d,c.POSITION_AFTER_END),d=o):e?(q=new l(this.startContainer),this.moveToPosition(g,c.POSITION_BEFORE_START),g=o):(d=this.splitElement(g),!a.ie&&!i.inArray(g._4e_name(),["ul","ol"])&&g._4e_appendBogus()));
return{previousBlock:g,nextBlock:d,wasStartOfBlock:e,wasEndOfBlock:b,elementPath:q}},splitElement:function(a){if(!this.collapsed)return o;this.setEndAt(a,c.POSITION_BEFORE_END);var e=this.extractContents(),b=a.clone(p);b[0].appendChild(e);b.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(a,j){var g,d=e;if(d.$empty[a._4e_name()])return p;for(;a&&a[0].nodeType==b.NODE_ELEMENT;){if(g=a._4e_isEditable())this.moveToPosition(a,j?c.POSITION_BEFORE_END:
c.POSITION_AFTER_START);else if(d.$inline[a._4e_name()])return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),n;if((a=d.$empty[a._4e_name()]?a[j?"prev":"next"](r):j?a.last(r):a.first(r))&&a[0].nodeType==b.NODE_TEXT)return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),n}return g},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==b.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var x={abbr:1,acronym:1,b:1,bdo:1,
big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},y=new s.whitespaces,B=new s.bookmark;u.Utils.injectDom({_4e_breakParent:function(a,e){var b=u.Range,e=new j(e),b=new b(a.ownerDocument);b.setStartAfter(new j(a));b.setEndAfter(e);var c=b.extractContents();b.insertNode(new j(m._4e_remove(a)));a.parentNode.insertBefore(c,a.nextSibling)}});u.Range=t},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(i){function u(a){this.document=a;this._={cache:{}};if(p){var e=this.getNative().createRange();if(!e||e.item&&e.item(0).ownerDocument!=a||e.parentElement&&e.parentElement().ownerDocument!=a)this.isInvalid=l}}function w(a){a=new u(a);return!a||a.isInvalid?t:a}var s=i.Editor;s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var l=!0,t=null,v=i.UA,r=i.DOM,d=i.Node,h=s.SELECTION,k=s.RANGE,n=s.NODE,p=v.ie,o=s.Walker,b=s.Range,c={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};i.augment(u,{getNative:!p?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=r._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!p?function(){var a=this._.cache;if(a.type)return a.type;var e=h.SELECTION_TEXT,b=this.getNative();if(b){if(1==b.rangeCount){var b=b.getRangeAt(0),
g=b.startContainer;g==b.endContainer&&g.nodeType==n.NODE_ELEMENT&&1==Number(b.endOffset-b.startOffset)&&c[g.childNodes[b.startOffset].nodeName.toLowerCase()]&&(e=h.SELECTION_ELEMENT)}}else e=h.SELECTION_NONE;return a.type=e}:function(){var a=this._.cache;if(a.type)return a.type;var e=h.SELECTION_NONE;try{var b=this.getNative(),c=b.type;"Text"==c&&(e=h.SELECTION_TEXT);"Control"==c&&(e=h.SELECTION_ELEMENT);b.createRange().parentElement&&(e=h.SELECTION_TEXT)}catch(g){}return a.type=e},getRanges:p?function(){var a=
function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),g=c.childNodes,d,h=0;h<g.length;h++){var f=g[h];if(f.nodeType==n.NODE_ELEMENT){d=a.duplicate();d.moveToElementText(f);var f=d.compareEndPoints("StartToStart",a),m=d.compareEndPoints("EndToStart",a);d.collapse();if(0<f)break;else{if(!f||1==m&&-1==f)return{container:c,offset:h};if(!m)return{container:c,offset:h+1}}d=t}}d||(d=a.duplicate(),d.moveToElementText(c),d.collapse(!1));d.setEndPoint("StartToStart",a);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=g[--h].nodeValue.length}catch(i){d=0}return 0===d?{container:c,offset:h}:{container:g[h],offset:-d}};return function(e){var c=this._.cache;if(c.ranges&&!e)return c.ranges;var g=this.getNative(),e=g&&g.createRange(),f=this.getType();if(!g)return[];if(f==h.SELECTION_TEXT)return g=new b(this.document),f=a(e,l),g.setStart(new d(f.container),f.offset),f=a(e),g.setEnd(new d(f.container),f.offset),c.ranges=[g];if(f==h.SELECTION_ELEMENT){c=c.ranges=[];for(f=0;f<e.length;f++){for(var m=
e.item(f),i=m.parentNode,k=0,g=new b(this.document);k<i.childNodes.length&&i.childNodes[k]!=m;k++);g.setStart(new d(i),k);g.setEnd(new d(i),k+1);c.push(g)}return c}return c.ranges=[]}}():function(a){var e=this._.cache;if(e.ranges&&!a)return e.ranges;var a=[],c=this.getNative();if(!c)return[];for(var g=0;g<c.rangeCount;g++){var f=c.getRangeAt(g),h=new b(this.document);h.setStart(new d(f.startContainer),f.startOffset);h.setEnd(new d(f.endContainer),f.endOffset);a.push(h)}return e.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case h.SELECTION_ELEMENT:return this.getSelectedElement();case h.SELECTION_TEXT:var g=this.getRanges()[0];if(g&&!g.collapsed){for(g.optimize();l;)if(b=g.startContainer,g.startOffset==(b[0].nodeType===n.NODE_ELEMENT?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())g.setStartAfter(b);else break;b=g.startContainer;if(b[0].nodeType!=n.NODE_ELEMENT)return b.parent();b=new d(b[0].childNodes[g.startOffset]);
if(!b[0]||b[0].nodeType!=n.NODE_ELEMENT)return g.startContainer;for(g=b[0].firstChild;g&&g.nodeType==n.NODE_ELEMENT;)b=new d(g),g=g.firstChild;return b}if(p)g=c.createRange(),g.collapse(l),b=new d(g.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=n.NODE_ELEMENT)b=b.parentNode;b&&(b=new d(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;p&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];
for(var g,f,h=2;h&&(!(g=a.getEnclosedNode())||!(g[0].nodeType==n.NODE_ELEMENT&&c[g._4e_name()]&&(f=g)));h--)a.shrink(k.SHRINK_ELEMENT);a=f}return b.selectedElement=new d(a)},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(p)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(g){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);
this.reset()},selectRanges:function(a){if(p){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var g=a[c],d=this.document.createRange(),f=g.startContainer;if(g.collapsed&&(v.gecko&&1.09>v.gecko||v.opera||v.webkit)&&f[0].nodeType==n.NODE_ELEMENT&&!f[0].childNodes.length)f[0].appendChild(this.document.createTextNode(v.webkit?"\u200b":"")),g.startOffset++,g.endOffset++;
d.setStart(f[0],g.startOffset);d.setEnd(g.endContainer[0],g.endOffset);b.addRange(d)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),g=0;g<c.length;g++)b.push(c[g].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],g=this.document,d,b=b||this.getRanges(),f=b.length,h=0;h<f;h++){c.push(d=b[h].createBookmark(a,l));var m=(a=d.serializable)?i.one("#"+d.startNode,g):d.startNode;d=a?i.one("#"+d.endNode,g):d.endNode;for(var k=h+1;k<f;k++){var n=b[k],o=n.startContainer,
p=n.endContainer;r.equals(o,m.parent())&&n.startOffset++;r.equals(o,d.parent())&&n.startOffset++;r.equals(p,m.parent())&&n.endOffset++;r.equals(p,d.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var c=[],g=0;g<a.length;g++){var d=new b(this.document);d.moveToBookmark(a[g]);c.push(d)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();p?a&&a.clear():a&&a.removeAllRanges()}});var f={table:1,tbody:1,tr:1},m=o.whitespaces(l),g=/\ufeff|\u00a0/;b.prototype.select=b.prototype.select=!p?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==n.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(l),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=w(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,c,h;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==n.NODE_ELEMENT){(new u(this.document)).selectElement(new d(i));return}}(this.startContainer[0].nodeType==n.NODE_ELEMENT&&
this.startContainer._4e_name()in f||this.endContainer[0].nodeType==n.NODE_ELEMENT&&this.endContainer._4e_name()in f)&&this.shrink(k.SHRINK_ELEMENT,l);var o=this.createBookmark(),i=o.startNode,p;b||(p=o.endNode);o=this.document.body.createTextRange();o.moveToElementText(i[0]);o.moveStart("character",1);if(p)a=this.document.body.createTextRange(),a.moveToElementText(p[0]),o.setEndPoint("EndToEnd",a),o.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!m(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(g))&&(a||!i[0].previousSibling||i[0].previousSibling&&"br"==r._4e_name(i[0].previousSibling));h=new d(this.document.createElement("span"));h.html("&#65279;");h.insertBefore(i);c&&r.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(b){if(c?(o.moveStart("character",-1),o.select(),this.document.selection.clear()):o.select(),h)this.moveToPosition(h,k.POSITION_BEFORE_START),h._4e_remove()}else this.setEndBefore(p),p._4e_remove(),o.select()};
u.getSelection=w;return s.Selection=u},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(i,u){function w(b){function c(a,b){var c=e.body.createTextRange();try{c.moveToPoint(a,b)}catch(g){c=d}return c}function f(){var a=e.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();k.remove(e,"mouseup",f);k.remove(e,"mousemove",h);j=g=0}function h(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",j)?a.setEndPoint("StartToStart",j):a.setEndPoint("EndToEnd",j),a.select()}else f()}var g,
a=b.get("iframe")[0].contentWindow,e=b.get("document")[0],j;k.on(e,"mousedown contextmenu",function(b){var d=e.documentElement;if(b.target===d&&(g&&f(),!(d.scrollHeight>d.clientHeight)&&(g=1,j=c(b.pageX,b.pageY))))k.on(e,"mouseup",f),k.on(e,"mousemove",h),a.focus(),j.select()})}function s(b){function c(g){if(e){var d=b.getSelection(),j=d&&d.getType(),h=d&&f.selection;if(g&&h&&j==p.SELECTION_NONE&&!f.queryCommandEnabled("InsertImage"))setTimeout(function(){c(v)},50);else{var i;if(!h||!h.type||!("Control"!=
h.type&&(i=h.createRange())&&(i=i.parentElement())&&(i=i.nodeName)&&i.toLowerCase()in{input:1,textarea:1}))a=h&&d.getRanges()[0],b._monitor()}}}var f=b.get("document")[0],h=new n(f.body),g=new n(f.documentElement);if(8>u.Utils.ieEngine)g.on("click",function(a){"html"===(new n(a.target))._4e_name()&&b.getSelection().getNative().createRange().select()});var a,e,j=v;g.on("mousedown",function(){j=r});g.on("mouseup",function(){j=v});h.on("focusin",function(b){if("body"==(new n(b.target))._4e_name()&&a){try{j&&
a.select()}catch(c){}a=d}});h.on("focus",function(){e=v;c()});h.on("beforedeactivate",function(a){a.relatedTarget||(e=r,j=v)});h.on("mousedown",function(){e=r});h.on("mouseup",function(){e=v;setTimeout(function(){c(v)},0)});h.on("keydown",function(){e=r});h.on("keyup",function(){e=v;setTimeout(function(){c()},0)})}function l(b){var c=b.get("document")[0];k.on(c,"mouseup keyup",function(){b._monitor()})}function t(b){function c(a){var b=u.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a._4e_name()]}
function d(b){return a(b)&&e(b)}var i=b.get("document")[0],g=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,a=u.Walker.whitespaces(v),e=u.Walker.bookmark(r,v),j=function(b){return a(b)&&8!=b.nodeType};b.on("selectionChange",function(a){var e=a.path,k=new n(b.get("document")[0].body),a=(a=a.selection)&&a.getRanges()[0],l=e.blockLimit;if(h.gecko){var p=e.block||e.blockLimit,t=p&&p.last(d);p&&p._4e_isBlockBoundary()&&
(!t||!(1==t[0].nodeType&&t._4e_isBlockBoundary()))&&"pre"!=p._4e_name()&&!p._4e_getBogus()&&p._4e_appendBogus()}if(a&&a.collapsed&&!e.block){if("body"==l._4e_name()){if((e=a.fixBlock(v,"p"))&&e[0]!=k[0].lastChild&&e._4e_outerHtml().match(g))if((l=e.next(j))&&l[0].nodeType==o.NODE_ELEMENT&&!c[l])a.moveToElementEditablePosition(l),e._4e_remove();else if((l=e.prev(j))&&l[0].nodeType==o.NODE_ELEMENT&&!c[l])a.moveToElementEditablePosition(l,l._4e_outerHtml().match(g)?r:v),e._4e_remove();a.select();b.notifySelectionChange()}e=
new u.Range(i);e.moveToElementEditablePosition(k,v);"body"!==(new u.ElementPath(e.startContainer)).blockLimit._4e_name()&&(k=(new n(i.createElement("p"))).appendTo(k),h.ie||k._4e_appendBogus())}})}var v=!0,r=!1,d=null,h=i.UA,k=i.Event,n=i.Node,p=u.SELECTION,o=u.NODE;return{init:function(b){b.docReady(function(){h.ie?(w(b),s(b)):l(b)});t(b)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(i){function u(a){return!B.attr(a,"_ke_bookmark")}function w(a,b){for(var c in a)a.hasOwnProperty(c)&&(i.isString(a[c])?a[c]=a[c].replace(R,function(a,c){return b[c]}):w(a[c],b))}function s(a,b){b&&(a=i.clone(a),w(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||M[c]?A.STYLE_BLOCK:N[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function l(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var g=new P(a),e=g.getRanges(),d=0;d<e.length;d++)c.call(this,e[d]);g.selectRanges(e)}function t(a,b,c){var g=a.element;"*"==g&&(g="span");b=new E(b.createElement(g));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=s.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function v(a){var b=a.createBookmark(j),c=a.createIterator();c.enforceRealBlocks=j;c.enlargeBr=j;for(var g,e=a.document;g=c.getNextParagraph();){var f=t(this,e,
g),i=f,f="pre"==i._4e_name,m="pre"==g._4e_name,k=!f&&m;f&&!m?(m=g,k=m.html(),k=r(k,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),k=k.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),k=k.replace(/([ \t\n\r]+|&nbsp;)/g," "),k=k.replace(/<br\b[^>]*>/gi,"\n"),D.ie?(m=m[0].ownerDocument.createElement("div"),m.appendChild(i[0]),i[0].outerHTML="<pre>"+k+"</pre>",i=new E(m.firstChild),i._4e_remove()):i.html(k)):k?i=h(d(g),i):g._4e_moveChildren(i);g[0].parentNode.replaceChild(i[0],g[0]);if(f&&(g=i,f=void 0,(f=g._4e_previousSourceNode(j,
G.NODE_ELEMENT))&&"pre"==f._4e_name()))i=r(f.html(),/\n$/,"")+"\n\n"+r(g.html(),/^\n/,""),D.ie?g[0].outerHTML="<pre>"+i+"</pre>":g.html(i),f._4e_remove()}a.moveToBookmark(b)}function r(a,b,c){var g="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(g=b);c&&(e=c);return""});return g+a.replace(b,c)+e}function d(a){var b=[];r(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function h(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),g=0;g<a.length;g++){var e=a[g],e=e.replace(/(\r\n|\r)/g,"\n"),e=r(e,/^[ \t]*\n/,""),e=r(e,/\n$/,""),e=r(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
d=b.clone();d.html(e);c.appendChild(d[0])}return c}function k(a){var b=a.document;if(a.collapsed)b=t(this,b,void 0),a.insertNode(b),a.moveToPosition(b,J.POSITION_BEFORE_END);else{var c=this.element,g=this._.definition,e,d=F[c];d||(e=j,d=F.span);var h=a.createBookmark();a.enlarge(J.ENLARGE_ELEMENT);a.trim();for(var f=a.createBookmark(),i=f.startNode,f=f.endNode,k=i,l;k&&k[0];){var n=q;if(B.equals(k,f))k=x,n=j;else{var o=k[0].nodeType,p=o==G.NODE_ELEMENT?k._4e_name():x;if(p&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(j);continue}if(!p||d[p]&&(k._4e_position(f)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(k))){var r=k.parent();if(r&&"a"==c&&r._4e_name()==c)o=t(this,b,void 0),r._4e_moveChildren(o),r[0].parentNode.replaceChild(o[0],r[0]),o._4e_mergeSiblings();else if(r&&r[0]&&((F[r._4e_name()]||F.span)[c]||e)&&(!g.parentRule||g.parentRule(r))){if(!l&&(!p||!F.$removeEmpty[p]||(k._4e_position(f)|
C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))l=new Q(b),l.setStartBefore(k);if(o==G.NODE_TEXT||o==G.NODE_ELEMENT&&!k[0].childNodes.length){r=k;for(o=null;(n=!r.next(u))&&(o=r.parent())&&d[o._4e_name()]&&(o._4e_position(i)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!g.childRule||g.childRule(o));)r=o;l.setEndAfter(r)}}else n=
j}else n=j;k=k._4e_nextSourceNode()}if(n&&l&&!l.collapsed){for(var n=t(this,b,void 0),r=l.getCommonAncestor(),o={},p={},y,v=null,s;n&&r&&n[0]&&r[0];){if(r._4e_name()==c){for(y in g.attributes)if(g.attributes.hasOwnProperty(y)&&!p[y]&&(s=r.attr(v)))n.attr(y)==s?n.removeAttr(y):p[y]=1;for(v in g.styles)if(g.styles.hasOwnProperty(v)&&!o[v]&&(s=r.style(v)))n.style(v)==s?n.style(v,""):o[v]=1;if(!n._4e_hasAttributes()){n=x;break}}r=r.parent()}n?(n[0].appendChild(l.extractContents()),m(this,n),l.insertNode(n),
n._4e_mergeSiblings(),D.ie||n[0].normalize()):(n=new E(b.createElement("span")),n[0].appendChild(l.extractContents()),l.insertNode(n),m(this,n),n._4e_remove(!0));l=x}}i._4e_remove();f._4e_remove();a.moveToBookmark(h);a.shrink(J.SHRINK_TEXT)}}function n(a){a.enlarge(J.ENLARGE_ELEMENT);var e=a.createBookmark(),d=e.startNode;if(a.collapsed){for(var j=new K(d.parent()),f,h=0,i;h<j.elements.length&&(i=j.elements[h])&&!(i==j.block||i==j.blockLimit);h++)if(this.checkElementRemovable(i)){var k=a.checkBoundaryOfElement(i,
J.END),m=!k&&a.checkBoundaryOfElement(i,J.START);m||k?(f=i,f.match=m?"start":"end"):(i._4e_mergeSiblings(),i._4e_name()!=this.element?(k=b(this),g(i,k[i._4e_name()]||k["*"])):c(this,i))}if(f.length){i=d;for(h=0;;h++){k=j.elements[h];if(B.equals(k,f))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(i[0]);i=k}i["start"==f.match?"insertBefore":"insertAfter"](f)}}else{var l=e.endNode,n=this,j=function(){for(var a=new K(d.parent()),b=new K(l.parent()),c=x,g=x,e=0;e<a.elements.length;e++){var j=
a.elements[e];if(j==a.block||j==a.blockLimit)break;n.checkElementRemovable(j)&&(c=j)}for(e=0;e<b.elements.length;e++){j=b.elements[e];if(j==b.block||j==b.blockLimit)break;n.checkElementRemovable(j)&&(g=j)}g&&l._4e_breakParent(g);c&&d._4e_breakParent(c)};j();for(f=new E(d[0].nextSibling);f[0]!==l[0];){h=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==G.NODE_ELEMENT&&this.checkElementRemovable(f)&&(f._4e_name()==this.element?c(this,f):(i=b(this),g(f,i[f._4e_name()]||i["*"])),h[0].nodeType==G.NODE_ELEMENT&&
h.contains(d)))j(),h=new E(d[0].nextSibling);f=h}}a.moveToBookmark(e)}function p(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,g){b[c]=g});return b}function o(a,b){var c="";b!==q?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){i.isArray(c)||(c=[c]);for(var g=0;g<c.length;g++){var e=c[g],d,j,f;"string"==typeof e?d=e.toLowerCase():(d=e.element?e.element.toLowerCase():a.element,j=e.attributes,f=e.styles);e=b[d]||(b[d]={});if(j){d=e.attributes=e.attributes||[];for(var h in j)j.hasOwnProperty(h)&&d.push([h.toLowerCase(),j[h]])}if(f){var e=e.styles=e.styles||[],k;for(k in f)f.hasOwnProperty(k)&&e.push([k.toLowerCase(),f[k]])}}}return b}function c(c,g){var e=c._.definition,d=b(c),h=y.mix(e.attributes,(d[g._4e_name()]||d["*"]||
{}).attributes),e=y.mix(e.styles,(d[g._4e_name()]||d["*"]||{}).styles),d=i.isEmptyObject(h)&&i.isEmptyObject(e),k;for(k in h)if(h.hasOwnProperty(k)&&!(("class"==k||c._.definition.fullMatch)&&g.attr(k)!=f(k,h[k])))d=d||!!g.hasAttr(k),g.removeAttr(k);for(var m in e)e.hasOwnProperty(m)&&!(c._.definition.fullMatch&&g.style(m)!=f(m,e[m],j))&&(d=d||!!g.style(m),g.style(m,""));a(g)}function f(a,b,c){var g=new E("<span>");g[c?"style":"attr"](a,b);return g[c?"style":"attr"](a)}function m(a,e){for(var d=b(a),
j=e.all(a.element),f=j.length;0<=--f;)c(a,new E(j[f]));for(var h in d)if(d.hasOwnProperty(h)&&h!=a.element){j=e.all(h);for(f=j.length-1;0<=f;f--){var i=new E(j[f]);g(i,d[h])}}}function g(b,c){var g,e=c&&c.attributes;if(e)for(g=0;g<e.length;g++){var d=e[g][0],j;if(j=b.attr(d)){var f=e[g][1];(f===x||f.test&&f.test(j)||"string"==typeof f&&j==f)&&b[0].removeAttribute(d)}}if(e=c&&c.styles)for(g=0;g<e.length;g++)if(d=e[g][0],f=b.css(d)){var h=e[g][1];(h===x||h.test&&h.test(j)||"string"==typeof h&&f==h)&&
b.css(d,"")}a(b)}function a(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(j);b&&(b.nodeType==G.NODE_ELEMENT&&B._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==G.NODE_ELEMENT&&B._4e_mergeSiblings(c))}}var e=i.Editor,j=!0,q=!1,x=null,y=e.Utils,B=i.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},J=e.RANGE,P=e.Selection,G=e.NODE,C=e.POSITION,Q=e.Range,E=i.Node,D=i.UA,K=e.ElementPath,M={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},F=e.XHTML_DTD,N={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},O=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;e.STYLE=A;s.prototype={apply:function(a){l.call(this,a,q)},remove:function(a){l.call(this,a,j)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?k:this.type==A.STYLE_BLOCK?v:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?n:x).call(this,a)},checkElementRemovable:function(a,c){if(!a)return q;var g=this._.definition,
e;if(a._4e_name()==this.element){if(!c&&!a._4e_hasAttributes())return j;var d=g._AC;if(d)g=d;else{var d={},f=0,h=g.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(f++,d[i]=h[i]);if(h=s.getStyleText(g))d.style||f++,d.style=h;d._length=f;g=g._AC=d}if(g._length){for(var k in g)if("_length"!=k&&g.hasOwnProperty(k)){f=a.attr(k)||"";if("style"==k)a:{d=g[k];f=o(f,q);"string"==typeof d&&(d=p(d));"string"==typeof f&&(f=p(f));h=void 0;for(h in d)if(d.hasOwnProperty(h)&&!(h in f&&(f[h]==d[h]||"inherit"==
d[h]||"inherit"==f[h]))){d=q;break a}d=j}else d=g[k]==f;if(d){if(!c)return j}else if(c)return q}if(c)return j}else return j}k=b(this);if(k=k[a._4e_name()]||k["*"]){if(!(g=k.attributes)&&!(e=k.styles))return j;if(g)for(d=0;d<g.length;d++)if(k=g[d][0],k=a.attr(k))if(f=g[d][1],f===x||"string"==typeof f&&k==f||f.test&&f.test(k))return j;if(e)for(d=0;d<e.length;d++)if(k=a.css(e[d][0]))if(g=e[d][1],g===x||"string"==typeof g&&k==g||g.test&&g.test(k))return j}return q},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,j);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var b=a.elements,c=0,g;c<b.length;c++)if(g=b[c],!(this.type==A.STYLE_INLINE&&(B.equals(g,a.block)||B.equals(g,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||g._4e_name()in N)&&this.checkElementRemovable(g,j))return j}return q}};s.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",g="";c.length&&(c=c.replace(O,";"));for(var e in b)if(b.hasOwnProperty(e)){var d=b[e],f=(e+":"+d).replace(O,
";");"inherit"==d?g+=f:c+=f}c.length&&(c=o(c));return a._ST=c+g};e.Style=s},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(i){var u=i.Editor,w=null,s=i.Node,l=i.DOM,t=i.UA,v=i.Event,r={debugUrl:function(d){d=d.replace(/-min\.(js|css)/i,".$1");i.Config.debug||(d=d.replace(/\.(js|css)/i,"-min.$1"));-1==d.indexOf("?t")&&(d=-1!=d.indexOf("?")?d+"&":d+"?",d+="t="+encodeURIComponent("20120510202538"));i.startsWith(d,"/")&&(d=d.substring(1));return u.Config.base+d},lazyRun:function(d,h,i){var l=d[h],p=d[i];d[h]=function(){l.apply(this,arguments);d[h]=d[i];return p.apply(this,arguments)}},
getXY:function(d,h,i,n){i=i.defaultView||i.parentWindow;d-=l.scrollLeft(i);h-=l.scrollTop(i);n&&(n=n.defaultView||n.parentWindow,i!=n&&i.frameElement&&(n=l.offset(i.frameElement,void 0,n),d+=n.left,h+=n.top));return{left:d,top:h}},tryThese:function(d){for(var h,i=0,l=arguments.length;i<l;i++){var p=arguments[i];try{h=p();break}catch(o){}}return h},arrayCompare:function(d,h){if(!d&&!h)return!0;if(!d||!h||d.length!=h.length)return!1;for(var i=0;i<d.length;i++)if(d[i]!==h[i])return!1;return!0},getByAddress:function(d,
h,i){for(var d=d.documentElement,l=0;d&&l<h.length;l++){var p=h[l];if(i)for(var o=-1,b=0;b<d.childNodes.length;b++){var c=d.childNodes[b];if(!(!0===i&&3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType)&&(o++,o==p)){d=c;break}}else d=d.childNodes[p]}return d?new s(d):w},clearAllMarkers:function(d){for(var h in d)d.hasOwnProperty(h)&&d[h]._4e_clearMarkers(d,!0)},ltrim:function(d){return d.replace(/^\s+/,"")},rtrim:function(d){return d.replace(/\s+$/,"")},mix:function(d){for(var h={},k=
0;k<arguments.length;k++)h=i.mix(h,arguments[k]);return h},isCustomDomain:function(){if(!t.ie)return!1;var d=document.domain,h=window.location.hostname;return d!=h&&d!="["+h+"]"},isNumber:function(d){return/^\d+(.\d+)?$/.test(i.trim(d))},verifyInputs:function(d){for(var h=0;h<d.length;h++){var k=new s(d[h]),l=i.trim(r.valInput(k)),p=k.attr("data-verify"),k=k.attr("data-warning");if(p&&!RegExp(p).test(l))return alert(k),!1}return!0},sourceDisable:function(d,h){d.on("sourceMode",h.disable,h);d.on("wysiwygMode",
h.enable,h)},resetInput:function(d){var h=d.attr("placeholder");h&&t.ie?(d.addClass("ke-input-tip"),d.val(h)):t.ie||d.val("")},valInput:function(d,h){if(void 0===h)return d.hasClass("ke-input-tip")?"":d.val();d.removeClass("ke-input-tip");d.val(h)},placeholder:function(d,h){d.attr("placeholder",h);t.ie&&(d.on("blur",function(){i.trim(d.val())||(d.addClass("ke-input-tip"),d.val(h))}),d.on("focus",function(){d.removeClass("ke-input-tip");i.trim(d.val())==h&&d.val("")}))},htmlEncode:function(d){return!d?
d:(""+d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(d){var d=i.clone(d),h;for(h in d)if(d.hasOwnProperty(h)){var k=d[h];i.isFunction(k)&&(d[h]=k())}return d},doFormUpload:function(d,h,k){function n(){var b={responseText:"",responseXML:w};b.argument=d?d.argument:w;try{var a;if((a=t.ie?o.contentWindow.document:o.contentDocument||window.frames[p].document)&&a.body)b.responseText=i.trim(l.text(a.body));b.responseXML=a&&a.XMLDocument?a.XMLDocument:
a}catch(c){}v.remove(o,"load",n);d.callback&&d.callback(b);setTimeout(function(){l._4e_remove(o)},100)}var p=i.guid("form-upload-"),o=document.createElement("iframe");o.id=p;o.name=p;o.className="ke-hidden";var b="document.open();"+(r.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";t.ie&&(o.src=t.ie?"javascript:void(function(){"+encodeURIComponent(b)+"}())":"");document.body.appendChild(o);t.ie&&(document.frames[p].name=p);var b=d.form,c={target:l.attr(b,"target"),
method:l.attr(b,"method"),encoding:l.attr(b,"encoding"),enctype:l.attr(b,"enctype"),action:l.attr(b,"action")};l.attr(b,{target:p,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});k&&l.attr(b,"action",k);var f;if(h){f=[];var h=u.Utils.normParams(h),m;for(m in h)h.hasOwnProperty(m)&&(k=document.createElement("input"),k.type="hidden",k.name=m,k.value=h[m],b.appendChild(k),f.push(k))}v.on(o,"load",n);b.submit();l.attr(b,c);if(f){h=0;for(m=f.length;h<m;h++)l._4e_remove(f[h])}return o},
map:function(d,h){for(var i=0;i<d.length;i++)d[i]=h(d[i]);return d},ieEngine:document.documentMode||t.ie,preventFocus:function(d){t.ie?d.unselectable():d.attr("onmousedown","return false;")},injectDom:function(d){i.mix(l,d);for(var h in d)d.hasOwnProperty(h)&&function(h){s.prototype[h]=function(){var l=[].slice.call(arguments,0);l.unshift(this[0]);return(l=d[h].apply(w,l))&&(l.nodeType||i.isWindow(l))?new s(l):i.isArray(l)&&(l.__IS_NODELIST||l[0]&&l[0].nodeType)?new s(l):l}}(h)},addRes:function(){var d=
this.__res=this.__res||[];d.push.apply(d,i.makeArray(arguments))},destroyRes:function(){for(var d=this.__res||[],h=0;h<d.length;h++){var k=d[h];i.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(d,i){return i.toUpperCase()})+"Active"}};return u.Utils=r},{requires:["./base"]});
KISSY.add("editor/core/walker",function(i,u){function w(b,c){if(this._.end)return r;var a,e=this.range,d,f=this.guard,h=this.type,i=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,e.trim(),e.collapsed))return this.end(),r;if(!b&&!this._.guardLTR){var l=e.endContainer[0],n=l.childNodes[e.endOffset];this._.guardLTR=function(a,b){return b&&(l==a||"body"==k._4e_name(a))?!1:a!=n}}if(b&&!this._.guardRTL){var o=e.startContainer[0],u=0<e.startOffset&&o.childNodes[e.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(o==a||"body"==k._4e_name(a))?!1:a!=u}}var s=b?this._.guardRTL:this._.guardLTR;d=f?function(a,b){return s(a,b)===v?v:f(a,b)}:s;this.current?a=this.current[i](v,h,d):b?(a=e.endContainer,0<e.endOffset?(a=new p(a[0].childNodes[e.endOffset-1]),d(a)===v&&(a=r)):a=d(a,t)===v?r:a._4e_previousSourceNode(t,h,d,void 0)):(a=e.startContainer,a=new p(a[0].childNodes[e.startOffset]),a.length?d(a)===v&&(a=r):a=d(e.startContainer,t)===v?r:e.startContainer._4e_nextSourceNode(t,
h,d,void 0));for(;a&&!this._.end;){this.current=a;if(!this.evaluator||this.evaluator(a[0])!==v){if(!c)return a}else if(c&&this.evaluator)return v;a=a[i](v,h,d)}this.end();return this.current=r}function s(b){for(var c,a=r;c=w.call(this,b);)a=c;return a}function l(b){this.range=b;this._={}}var t=!0,v=!1,r=null,d=i.UA,h=u.NODE,k=i.DOM,n=u.XHTML_DTD,p=i.Node;i.augment(l,{end:function(){this._.end=1},next:function(){return w.call(this)},previous:function(){return w.call(this,t)},checkForward:function(){return w.call(this,
v,t)!==v},checkBackward:function(){return w.call(this,t,t)!==v},lastForward:function(){return s.call(this)},lastBackward:function(){return s.call(this,t)},reset:function(){delete this.current;this._={}},_iterator:w});l.blockBoundary=function(b){return function(c){return!(c.nodeType==h.NODE_ELEMENT&&k._4e_isBlockBoundary(c,b))}};l.bookmark=function(b,c){function a(a){return"span"==k._4e_name(a)&&k.attr(a,"_ke_bookmark")}return function(e){var d,f;d=e.nodeType==h.NODE_TEXT&&(f=e.parentNode)&&a(f);d=
b?d:d||a(e);return c^d}};l.whitespaces=function(b){return function(c){c=c.nodeType==h.NODE_TEXT&&!i.trim(c.nodeValue);return b^c}};l.invisible=function(b){var c=l.whitespaces();return function(a){a=c(a)||a.nodeType==h.NODE_ELEMENT&&!a.offsetHeight;return b^a}};var o=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,b=l.whitespaces(),c=l.bookmark(),f=function(d){var g=k._4e_name(d);return c(d)||b(d)||1==d.nodeType&&g in n.$inline&&!(g in n.$empty)};u.Utils.injectDom({_4e_getBogus:function(b){b=new p(b);do b=b._4e_previousSourceNode();
while(b&&f(b[0]));return b&&(!d.ie?"br"==b._4e_name():3==b[0].nodeType&&o.test(b.text()))?b[0]:!1}});return u.Walker=l},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(i){var u=i.Editor;u.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};u.baseZIndex=function(i){return(u.Config.baseZIndex||1E4)+i}},{requires:["./base"]});
KISSY.add("editor",function(i,u,w,s){function l(c,a){var e=c.body;b(function(){c.designMode="on";setTimeout(function(){c.designMode="off";e.focus();arguments.callee.retry||(arguments.callee.retry=t)},50)},function(){c.designMode="off";n.attr(e,"contentEditable",r);n.attr(e,"contentEditable",t);!a&&l(c,1)})}var t=!0,v=i.all,r=!1,d=document,h=i.UA,k=h.ie,n=i.DOM,p=i.Node,o=i.Event,b=w.tryThese,c="document.open();"+(w.isCustomDomain()?'document.domain="'+d.domain+'";':"")+"document.close();",f='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(k?' src="javascript:void(function(){'+encodeURIComponent(c)+'}())"':"")+' allowTransparency="true"></iframe>';i.mix(u,{SOURCE_MODE:0,WYSIWYG_MODE:1});var m=u.WYSIWYG_MODE;i.augment(u,{createDom:function(){var b=this.get("textarea"),a;b||this.set("textarea",b=v("<textarea></textarea>"));a=this.get("el");a.addClass(this.get("prefixCls")+"editor-wrap",void 0);a.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=i.guid();var c=
a.one(".ke-textarea-wrap");this.__set("iframeWrapEl",c);this.__set("toolBarEl",a.one(".ke-editor-tools"));this.__set("statusBarEl",a.one(".ke-editor-status"));var d=this.get("width"),f=this.get("height");a.css("width",d);b.css("width","100%");b.css("display","none");c.append(b);c.css("height",f);b.css("height",f);a.css("height","")},_uiSetHeight:function(b){this.get("iframeWrapEl").css("height",b);this.get("textarea").css("height",b)},_uiSetMode:function(b){var a=this.get("textarea");b?(this.execCommand("save"),
this._setData(a.val()),this.execCommand("save")):(a.val(this._getData(1,m)),a[0].focus());a[b?"hide":"show"]();this.get("iframe")[b?"show":"hide"]();this.fire((b?"wysiwyg":"source")+"Mode")},renderUI:function(){function b(){a.detach("docReady",b);if(a.get("focus"))a.focus();else{var c=a.getSelection();c&&c.removeAllRanges()}}var a=this,c=a.get("textarea");s.register(a);a.get("attachForm")&&c[0].form&&a._attachForm();a.on("docReady",b)},_createIframe:function(b){var a=this,c=new p(f),d=a.get("textarea");
d.hasAttr("tabindex")&&c.attr("tabIndex",h.webkit?-1:d.attr("tabIndex"));a.get("iframeWrapEl").prepend(c);a.set("iframe",c);a.__docReady=0;if(h.gecko&&!c.__loaded)c.on("load",function(){a._setUpIFrame(b)},a);else a._setUpIFrame(b)},destructor:function(){var b=this.get("el"),a=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();u.focusManager.remove(this);o.remove([c,c.documentElement,c.body,d]);i.each(this.__dialogs,function(a){a.destroy&&a.destroy()});
this.__commands=0;this.__editor_created_new||(a.insertBefore(b,void 0),a.css({width:this.get("width"),height:this.get("height")}),a.show())},_attachForm:function(){var b=this,a=b.get("textarea"),c=new p(a[0].form);c.on("submit",b.sync,b);b.on("destroy",function(){c.detach("submit",b.sync,b)})},addDialog:function(b,a){this.__dialogs[b]=a},showDialog:function(b,a){var c=this.__dialogs[b];c.show(a);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:b})},hasDialog:function(b){return!!this.__dialogs[b]},
addCommand:function(b,a){this.__commands[b]=a},hasCommand:function(b){return this.__commands[b]},execCommand:function(b){var a=this.__commands[b],c=i.makeArray(arguments);c.shift();c.unshift(this);if(a)return a.exec.apply(a,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var b=this.get("iframe"),a=b[0].contentWindow,c=this.get("document")[0];o.remove([c,c.documentElement,c.body,a]);b.remove()}},_getData:function(b,a){var c=this.htmlDataProcessor,d;void 0==a&&(a=this.get("mode"));d=a==
m?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=b?c.toHtml(d):c.toServer(d);d=i.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(b){var a,c=b;if(this.get("mode")!=m)this.get("textarea").val(b);else{if(a=this.htmlDataProcessor)c=a.toDataFormat(b,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(b){this.get("document")[0].body.innerHTML=b},_prepareIFrameHtml:function(b,a){var c=this.get("customStyle"),f=this.get("customLink"),h="",i=u.Utils.debugUrl("/theme/editor-iframe.css");if(f)for(var k=0;k<f.length;k++)h+='<link href="'+f[k]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===d.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+i+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+h+"</head><body class='ke-editor'>"+
(a||"&nbsp;")+(b?'<script id="ke_actscript" type="text/javascript">'+(w.isCustomDomain()?'document.domain="'+d.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return u.Selection.getSelection(this.get("document")[0])},focus:function(){var b=this.get("document")[0],a=n._4e_getWin(b);h.ie||a&&a.parent&&a.parent.focus();a&&a.focus();b.body.focus();this.notifySelectionChange()},blur:function(){n._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(b){var a=this.get("customStyle")||"",a=a+("\n"+b);this.set("customStyle",a);n.addStyleSheet(this.get("iframe")[0].contentWindow,a)},addCustomLink:function(b){var a=this.get("customLink")||[],c=this.get("document")[0];a.push(b);this.set("customLink",a);a=c.createElement("link");a.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(a);a.href=b},removeCustomLink:function(b){for(var a=this.get("document")[0],a=n.query("link",a),c=
0;c<a.length;c++)a[c].href==b&&n.remove(a[c]);a=this.get("customLink")||[];b=i.indexOf(b,a);-1!=b&&a.splice(b,1)},_setUpIFrame:function(b){function a(){i=h.document;c.__set("document",new p(i));c.__set("window",new p(h));d.detach();i.open("text/html","replace");i.write(f);i.close()}var c=this,d=c.get("iframe"),f=c._prepareIFrameHtml(c._UUID,b),h=d[0].contentWindow,i;d.__loaded=1;try{i=h.document}catch(l){if(d[0].src=d[0].src,7>k){setTimeout(a,10);return}}a()},docReady:function(b){this.on("docReady",
b);this.__docReady&&b.call(this)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var c=a.getStartElement(),d=new u.ElementPath(c);if(!b.__previousPath||!b.__previousPath.compare(d))b.__previousPath=d,b.fire("selectionChange",{selection:a,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(b,a,c){var d=this;if(d.get("mode")===
m){d.focus();var f,h=b._4e_name(),i=u.XHTML_DTD,k=u.RANGE,l=u.NODE,n=i.$block[h],o=d.getSelection(),v=o&&o.getRanges(),s,w,E,D;if(!v||0==v.length){var K=arguments,M=K.callee;setTimeout(function(){M.apply(d,K)},30)}else{d.execCommand("save");for(var F=v.length-1;0<=F;F--){s=v[F];s.deleteContents();f=!F&&b||b.clone(t);a&&a(f);if(n)for(;(E=s.getCommonAncestor(r,t))&&(D=i[E._4e_name()])&&(!D||!D[h]);)E._4e_name()in i.span?s.splitElement(E):s.checkStartOfBlock()&&s.checkEndOfBlock()?(s.setStartBefore(E),
s.collapse(t),E.remove()):s.splitBlock();s.insertNode(f);w||(w=f)}w&&(h=w._4e_nextSourceNode(t),i=d.get("document")[0],D=u.XHTML_DTD,D.$inline[f._4e_name()]?(h=new p(i.createTextNode(" ")),h.insertAfter(w)):h?"br"==h._4e_name()&&D[h.parent()._4e_name()].p&&(D=new p("<p>&nbsp;</p>",null,i),h[0].parentNode.replaceChild(D[0],h[0]),h=D):(D=new p("<p>&nbsp;</p>",null,i),D.insertAfter(w),h=D),s.moveToPosition(w,k.POSITION_AFTER_END),h&&h[0].nodeType==l.NODE_ELEMENT&&s.moveToElementEditablePosition(h),o.selectRanges([s]),
d.focus(),f&&f.scrollIntoView(void 0,!1),d._saveLater(),c&&c(f))}}},insertHtml:function(b,a){var c=this,d;if(c.get("mode")===m){if(d=c.htmlDataProcessor)b=d.toDataFormat(b,null,a);c.focus();c.execCommand("save");var f=c.get("document")[0];d=0;if(k){var h=f.selection;"Control"==h.type&&h.clear();try{h.createRange().pasteHTML(b)}catch(i){}}else try{f.execCommand("inserthtml",r,b)}catch(l){setTimeout(function(){if(0==c.getSelection().getRanges().length){var a=new u.Range(f),d=n.first(f.body,function(a){return 1==
a.nodeType&&"br"!=n._4e_name(a)});d||(d=new p(f.createElement("p")),f.body.appendChild(d[0]));a.setStartAt(d,u.RANGE.POSITION_AFTER_START);a.select()}f.execCommand("inserthtml",r,b)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);c._saveLater(d)}},_saveLater:function(b){var a=this;a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)},_fixByBindIframeDoc:function(){var b=this,a=b.get("iframe"),c=b.get("textarea")[0],
a=a[0].contentWindow,d=b.get("document")[0];h.webkit&&(o.on(d,"click",function(a){var b=new p(a.target);i.inArray(b._4e_name(),["input","select"])&&a.preventDefault()}),o.on(d,"mouseup",function(a){var b=new p(a.target);i.inArray(b._4e_name(),["input","textarea"])&&a.preventDefault()}));if(h.gecko||k||h.opera){var f;f=(new p('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);f.on("focus",function(){b.focus()});b.activateGecko=function(){h.gecko&&
b.__iframeFocus&&f[0].focus()};b.on("destroy",function(){f.detach();f.remove()})}o.on(a,"focus",function(){h.gecko?l(d,r):h.opera&&d.body.focus();b.notifySelectionChange()});if(h.gecko)o.on(d,"mousedown",function(){b.__iframeFocus||l(d,r)});if(k&&(o.on(d,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.fire("save");a.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var m=
{33:1,34:1};o.on(d,"keydown",function(a){a.keyCode in m&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}if(h.webkit)o.on(d,"mousedown",function(a){a=new p(a.target);i.inArray(a._4e_name(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(a)});if(h.gecko)o.on(d,"dragstart",function(a){var b=new p(a.target);b._4e_name()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});s.add(b)}});u._initIFrame=function(b){var a=s.getInstance(b),c=a.get("document")[0],
b=c.getElementById("ke_actscript");n.remove(b);a._fixByBindIframeDoc();var d=c.body;k?(d.hideFocus=t,d.disabled=t,d.contentEditable=t,d.removeAttribute("disabled")):setTimeout(function(){h.gecko||h.opera?d.contentEditable=t:h.webkit?d.parentNode.contentEditable=t:c.designMode="on"},0);if(h.gecko||h.opera){var f=c.documentElement;o.on(f,"mousedown",function(b){if(b.target==f){h.gecko&&l(c,r);a.activateGecko()}})}setTimeout(function(){k&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";
d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.__docReady=1;a.fire("docReady");var b=a.get("disableObjectResizing"),f=a.get("disableInlineTableEditing");if(b||f)try{c.execCommand("enableObjectResizing",r,!b);c.execCommand("enableInlineTableEditing",r,!f)}catch(g){o.on(d,k?"resizestart":"resize",function(a){var c=new p(a.target);(b||c._4e_name()==="table"&&f)&&a.preventDefault()})}},10)};return u},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
