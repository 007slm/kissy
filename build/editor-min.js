/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 15 19:35
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(i,v,w,s){v=s.create(w.Controller,[s.Box],{initializer:function(){var i;this.__commands={};this.__dialogs={};if(i=this.get("textarea")){if(!this.get("render")&&!this.get("elBefore")){var t=i.next();t?this.__set("elBefore",t):this.__set("render",i.parent())}this.get("width")||this.__set("width",i.style("width")||i.css("width"));this.get("height")||this.__set("height",i.style("height")||i.css("height"))}else this.__editor_created_new=1},use:function(l,t){for(var r=
this,u=r.__CORE_PLUGINS||["htmlDataProcessor","enterKey","clipboard","selection"],l=l.split(","),d=l.length-1;0<=d;d--)l[d]||l.splice(d,1);for(d=0;d<u.length;d++){var e=u[d];i.inArray(e,l)||l.unshift(e)}i.each(l,function(e,d){l[d]&&(l[d]="editor/plugin/"+e+"/")});i.use(l.join(","),function(){var e=i.makeArray(arguments);e.shift();for(var d=0;d<e.length;d++)e[d].init(r);t&&t.call(r)});r.__CORE_PLUGINS=[];return r}},{Config:{base:i.Config.base+"editor/"},XHTML_DTD:v.DTD,ATTRS:{textarea:{},iframe:{},
window:{},document:{},iframeWrapEl:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(i){return this._setData(i)}},formatData:{getter:function(){return this._getData(1)},setter:function(i){return this._setData(i)}},prefixCls:{value:"ke-"}}},"Editor");v.DefaultRender=s.create(w.Render,[s.Box.Render],{_uiSetHeight:function(){}});i.mix(v,i.EventTarget);return KISSY.Editor=v},{requires:["htmlparser",
"component","uibase","core"]});
KISSY.add("editor/plugin/clipboard/index",function(i){function v(b){this.editor=b;this._init()}function w(b){if(t.ie&&"BackCompat"!=b.get("document")[0].compatMode){var c=b.getSelection(),f;if(c.getType()==p.SELECTION_ELEMENT&&(f=c.getSelectedElement())){var a=c.getRanges()[0],h=new l(b.get("document")[0].createTextNode(""));h.insertBefore(f);a.setStartBefore(h);a.setEndAfter(f);c.selectRanges([a]);setTimeout(function(){f.parent()&&(h.remove(),c.selectElement(f))},0)}}}var s=i.Editor,l=i.Node,t=i.UA,
r=s.Range,u=s.RANGE,d=i.Event;i.augment(v,{_init:function(){var b=this.editor;d.on(b.get("document")[0].body,t.webkit?"paste":t.gecko?"paste":"beforepaste",this._paste,this);d.on(b.get("document")[0].body,"contextmenu",function(){c=1;setTimeout(function(){c=0},10)});b.addCommand("copy",new o("copy"));b.addCommand("cut",new o("cut"));b.addCommand("paste",new o("paste"))},_paste:function(){if(!c){var b=this.editor,m=b.get("document")[0];if(!m.getElementById("ke_pastebin")){var f=b.getSelection(),a=
new r(m),h=new l(t.webkit?"<body></body>":"<div></div>",null,m);h.attr("id","ke_pastebin");t.webkit&&h[0].appendChild(m.createTextNode("\u00a0"));m.body.appendChild(h[0]);h.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});h.css("left","-1000px");var j=f.createBookmarks();a.setStartAt(h,u.POSITION_AFTER_START);a.setEndAt(h,u.POSITION_BEFORE_END);a.select(!0);setTimeout(function(){h.remove();var a;h=t.webkit&&(a=h.first())&&a.hasClass("Apple-style-span")?
a:h;f.selectBookmarks(j);a=h.html();if(a=i.trim(a.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var c=b.fire("paste",{html:a,holder:h});void 0!==c&&(a=c);c=null;/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(a)&&(c=b.htmlDataProcessor.wordFilter);b.insertHtml(a,c)}},0)}}}});var e=function(b,c){var f=b.get("document")[0],a=new l(f.body),h=!1,j=function(){h=!0};a.on(c,j);(7<t.ie?f:f.selection.createRange()).execCommand(c);a.detach(c,j);return h},k=t.ie?function(b,c){return e(b,
c)}:function(b,c){try{return b.get("document")[0].execCommand(c)}catch(f){return!1}},n={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},o=function(b){this.type=b};o.prototype={exec:function(b){"cut"==this.type&&w(b);(b=k(b,this.type))||alert(n[this.type]);return b}};var p=s.Selection,b={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},c;s.on("contextmenu",function(c){var m=c.contextmenu,f=m.get("editor"),
a=m.menu.get("contentEl"),h={copy:0,cut:0,paste:0},j;for(j in h)h.hasOwnProperty(j)&&(h[j]=a.one(".ke-paste-"+j),h[j]||function(j){var c=(new l("<a href='#'class='ke-paste-"+j+"'>"+b[j]+"</a>")).appendTo(a);c.on("click",function(a){a.halt();m.hide();setTimeout(function(){f.execCommand(j)},30)});h[j]=c}(j))});return{init:function(b){b.docReady(function(){new v(b)})}}},{requires:["editor"]});
KISSY.add("editor/core/dom",function(i){function v(b,c){var g=b[c?"next":"prev"]();if(g&&g[0].nodeType==e.NODE_ELEMENT){for(var m=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemovable(w);)if(m.push(g),g=c?g.next():g.prev(),!g)return;if(b._4e_isIdentical(g,w)){for(var f=new r(c?b[0].lastChild:b[0].firstChild);m.length;)m.shift()._4e_move(b,!c,w);g._4e_moveChildren(b,!c,w);g.remove();f[0]&&f[0].nodeType==e.NODE_ELEMENT&&f._4e_mergeSiblings()}}}var w=w,s=i.Editor,l=i.DOM,t=i.UA,r=i.Node,u=s.Utils,
d={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};s.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};s.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var e=s.NODE,k=s.POSITION,n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,
"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},o={hr:1},p=function(b){return b&&(b[0]||b)};u.injectDom({_4e_isBlockBoundary:function(b,c){var g=i.merge(o,c);return!(!n[l.css(b,"display")]&&!g[l._4e_name(b)])},_4e_getWin:l._getWin,_4e_index:function(b,c){for(var g=b.parentNode.childNodes,m,f=-1,a=0;a<g.length;a++)if(m=g[a],!c||!(3==m.nodeType&&m.previousSibling&&3==m.previousSibling.nodeType))if(f++,m===b)return f;return-1},_4e_move:function(b,
c,g){c=p(c);g?c.insertBefore(b,c.firstChild):c.appendChild(b)},_4e_name:function(b){var c=b.nodeName.toLowerCase();t.ie&&(b=b.scopeName)&&"HTML"!=b&&(c=b.toLowerCase()+":"+c);return c},_4e_isIdentical:function(b,c){if(!c)return!1;c=p(c);if(l._4e_name(b)!=l._4e_name(c))return!1;var g=b.attributes,m=c.attributes,f=g.length,a=m.length;if(f!=a)return!1;for(var h=0;h<f;h++){var j=g[h],q=j.name;if(j.specified&&l.attr(b,q)!=l.attr(c,q))return!1}if(8>u.ieEngine)for(h=0;h<a;h++)if(j=m[h],q=j.name,j.specified&&
l.attr(b,q)!=l.attr(c,q))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){for(var b=b.childNodes,c=0,g=b.length;c<g;c++){var m=b[c],f=m.nodeType;if(!(f==e.NODE_ELEMENT&&m.getAttribute("_ke_bookmark"))&&(f==e.NODE_ELEMENT&&!l._4e_isEmptyInlineRemovable(m)||f==e.NODE_TEXT&&i.trim(m.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,c,g){c=p(c);if(b!=c)if(g)for(;g=b.lastChild;)c.insertBefore(b.removeChild(g),c.firstChild);else for(;g=b.firstChild;)c.appendChild(b.removeChild(g))},_4e_mergeSiblings:function(b){b=
new r(b);d[b._4e_name()]&&(v(b,!0),v(b))},_4e_splitText:function(b,c){var g=b.ownerDocument;if(b.nodeType==e.NODE_TEXT){if(t.ie&&c==b.nodeValue.length){var m=g.createTextNode("");l.insertAfter(m,b);return m}m=b.splitText(c);g.documentMode&&(g=g.createTextNode(""),l.insertAfter(g,m),l.remove(g));return m}},_4e_parents:function(b,c){var g=[];g.__IS_NODELIST=1;do g[c?"push":"unshift"](b);while(b=b.parentNode);return g},_4e_nextSourceNode:function(b,c,g,m){if(m&&!m.call)var f=p(m),m=function(a){return a!==
f};var c=!c&&b.firstChild,a=b;if(!c){if(b.nodeType==e.NODE_ELEMENT&&m&&!1===m(b,!0))return null;c=b.nextSibling}for(;!c&&(a=a.parentNode);){if(m&&!1===m(a,!0))return null;c=a.nextSibling}return!c||m&&!1===m(c)?null:g&&g!=c.nodeType?l._4e_nextSourceNode(c,!1,g,m):c},_4e_previousSourceNode:function(b,c,g,m){if(m&&!m.call)var f=p(m),m=function(a){return a!==f};var c=!c&&b.lastChild,a=b;if(!c){if(b.nodeType==e.NODE_ELEMENT&&m&&!1===m(b,!0))return null;c=b.previousSibling}for(;!c&&(a=a.parentNode);){if(m&&
!1===m(a,!0))return null;c=a.previousSibling}return!c||m&&!1===m(c)?null:g&&c.nodeType!=g?l._4e_previousSourceNode(c,!1,g,m):c},_4e_commonAncestor:function(b,c){c=p(c);if(b===c)return b;if(l.contains(c,b))return c;var g=b;do if(l.contains(g,c))return g;while(g=g.parentNode);return null},_4e_hasAttributes:9>u.ieEngine?function(b){for(var c=b.attributes,g=0;g<c.length;g++){var m=c[g];switch(m.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(m.specified)return!0}}return!1}:function(b){t.gecko&&
b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4e_position:function(b,c){var g=p(c);if(b.compareDocumentPosition)return b.compareDocumentPosition(g);if(b==g)return k.POSITION_IDENTICAL;if(b.nodeType==e.NODE_ELEMENT&&g.nodeType==e.NODE_ELEMENT){if(l.contains(b,g))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(l.contains(g,b))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>g.sourceIndex?k.POSITION_DISCONNECTED:b.sourceIndex<g.sourceIndex?
k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var m=l._4e_address(b),g=l._4e_address(g),f=Math.min(m.length,g.length),a=0;a<=f-1;a++)if(m[a]!=g[a])return m[a]<g[a]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return m.length<g.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4e_address:function(b,c){for(var g=[],m=b.ownerDocument.documentElement,f=b;f&&f!=m;)g.unshift(l._4e_index(f,c)),f=f.parentNode;return g},_4e_remove:function(b,c){var g=b.parentNode;
if(g){if(c)for(var m;m=b.firstChild;)g.insertBefore(b.removeChild(m),b);g.removeChild(b)}return b},_4e_trim:function(b){l._4e_ltrim(b);l._4e_rtrim(b)},_4e_ltrim:function(b){for(var c;c=b.firstChild;){if(c.nodeType==e.NODE_TEXT){var g=u.ltrim(c.nodeValue),m=c.nodeValue.length;if(g)g.length<m&&(l._4e_splitText(c,m-g.length),b.removeChild(b.firstChild));else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){for(var c;c=b.lastChild;){if(c.type==e.NODE_TEXT){var g=u.rtrim(c.nodeValue),m=c.nodeValue.length;
if(g)g.length<m&&(l._4e_splitText(c,g.length),b.removeChild(b.lastChild));else{b.removeChild(c);continue}}break}!t.ie&&!t.opera&&(c=b.lastChild)&&1==c.nodeType&&"br"==l._4e_name(c)&&b.removeChild(c)},_4e_appendBogus:function(b){for(var c=b.lastChild;c&&c.nodeType==e.NODE_TEXT&&!i.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==e.NODE_TEXT||"br"!==l._4e_name(c))c=t.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),t.gecko&&c.setAttribute("type","_moz"),b.appendChild(c)},
_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");c.appendChild(b.cloneNode(!0));return c.innerHTML},_4e_setMarker:function(b,c,g,m){var b=new r(b),f=b.data("list_marker_id")||b.data("list_marker_id",i.guid()).data("list_marker_id"),a=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");c[f]=b;a[g]=1;return b.data(g,m)},_4e_clearMarkers:function(b,c,g){var b=new r(b),m=b.data("list_marker_names"),
f=b.data("list_marker_id"),a;for(a in m)m.hasOwnProperty(a)&&b.removeData(a);b.removeData("list_marker_names");g&&(b.removeData("list_marker_id"),delete c[f])},_4e_copyAttributes:function(b,c,g){for(var c=new r(c),m=b.attributes,g=g||{},f=0;f<m.length;f++){var a=m[f],h=a.name.toLowerCase(),j;if(!(h in g))if("checked"==h&&(j=l.attr(b,h)))c.attr(h,j);else if(a.specified||t.ie&&a.value&&"value"==h)j=l.attr(b,h),null===j&&(j=a.nodeValue),c.attr(h,j)}""!==b.style.cssText&&(c[0].style.cssText=b.style.cssText)},
_4e_isEditable:function(b){var b=l._4e_name(b),c=s.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(i){function v(b){1>arguments.length||(this.range=b,this.forceBrBreak=s,this.enlargeBr=w,this.enforceRealBlocks=s,this._||(this._={}))}var w=!0,s=!1,l=i.Editor,t=i.UA,r=l.Walker,u=l.Range,d=l.RANGE,e=l.NODE,k=l.ElementPath,n=i.Node,o=i.DOM,p=/^[\r\n\t ]*$/;i.augment(v,{getNextParagraph:function(b){var c,g,m,f,a;if(!this._.lastNode){g=this.range.clone();g.shrink(d.SHRINK_ELEMENT,w);g.enlarge(this.forceBrBreak||!this.enlargeBr?d.ENLARGE_LIST_ITEM_CONTENTS:
d.ENLARGE_BLOCK_CONTENTS);var h=new r(g),j=r.bookmark(w,w);h.evaluator=j;this._.nextNode=h.next();h=new r(g);h.evaluator=j;h=h.previous();this._.lastNode=h._4e_nextSourceNode(w);this._.lastNode&&this._.lastNode[0].nodeType==e.NODE_TEXT&&!i.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(j=new u(g.document),j.moveToPosition(this._.lastNode,d.POSITION_AFTER_END),j.checkEndOfBlock()&&(j=new k(j.endContainer),this._.lastNode=(j.block||j.blockLimit)._4e_nextSourceNode(w)));
this._.lastNode||(this._.lastNode=this._.docEndMarker=new n(g.document.createTextNode("")),o.insertAfter(this._.lastNode[0],h[0]));g=null}j=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;j;){var q=s,x=j[0].nodeType!=e.NODE_ELEMENT,y=s;if(x)j[0].nodeType==e.NODE_TEXT&&p.test(j[0].nodeValue)&&(x=s);else{var l=j._4e_name();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==l)x=w;else if(!g&&!j[0].childNodes.length&&"hr"!=l){c=j;m=j.equals(h);break}g&&(g.setEndAt(j,d.POSITION_BEFORE_START),
"br"!=l&&(this._.nextNode=j));q=w}else{if(j[0].firstChild){g||(g=new u(this.range.document),g.setStartAt(j,d.POSITION_BEFORE_START));j=new n(j[0].firstChild);continue}x=w}}x&&!g&&(g=new u(this.range.document),g.setStartAt(j,d.POSITION_BEFORE_START));m=(!q||x)&&j.equals(h);if(g&&!q)for(;!j[0].nextSibling&&!m;){l=j.parent();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){q=w;m||l.equals(h);break}j=l;x=w;m=j.equals(h);y=w}x&&g.setEndAt(j,d.POSITION_AFTER_END);j=j._4e_nextSourceNode(y,null,h);if((m=
!j)||q&&g)break}if(!c){if(!g)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new k(g.startContainer);j=c.blockLimit;q={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&q[j._4e_name()]&&g.checkStartOfBlock()&&g.checkEndOfBlock())c=j;else if(!c||this.enforceRealBlocks&&"li"==c._4e_name())c=new n(this.range.document.createElement(b||"p")),c[0].appendChild(g.extractContents()),c._4e_trim(),g.insertNode(c),f=a=w;else if("li"!=c._4e_name()){if(!g.checkStartOfBlock()||
!g.checkEndOfBlock())c=c.clone(s),c[0].appendChild(g.extractContents()),c._4e_trim(),a=g.splitBlock(),f=!a.wasStartOfBlock,a=!a.wasEndOfBlock,g.insertNode(c)}else m||(this._.nextNode=c.equals(h)?null:g.getBoundaryNodes().endNode._4e_nextSourceNode(w,null,h))}f&&(g=new n(c[0].previousSibling),g[0]&&g[0].nodeType==e.NODE_ELEMENT&&("br"==g._4e_name()?g._4e_remove():g[0].lastChild&&"br"==o._4e_name(g[0].lastChild)&&o._4e_remove(g[0].lastChild)));a&&(g=r.bookmark(s,w),f=new n(c[0].lastChild),f[0]&&f[0].nodeType==
e.NODE_ELEMENT&&"br"==f._4e_name()&&(t.ie||f.prev(g)||f.next(g))&&f.remove());this._.nextNode||(this._.nextNode=m||c.equals(h)?null:c._4e_nextSourceNode(w,null,h));return c}});u.prototype.createIterator=function(){return new v(this)}},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(i){function v(e){for(var i=r,n=r,o=[];e;){if(e[0].nodeType==t.NODE_ELEMENT){this.lastElement||(this.lastElement=e);var p=e._4e_name();if(!n&&(!i&&u[p]&&(i=e),d[p])){var b;if(b=!i)if(b="div"==p){a:{b=e[0].childNodes;for(var c=0,g=b.length;c<g;c++){var m=b[c];if(m.nodeType==t.NODE_ELEMENT&&l.$block[m.nodeName.toLowerCase()]){b=!0;break a}}b=!1}b=!b}b?i=e:n=e}o.push(e);if("body"==p)break}e=e.parent()}this.block=i;this.blockLimit=n;this.elements=o}var w=i.Editor,
s=i.DOM,l=w.XHTML_DTD,t=w.NODE,r=null,u={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},d={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};v.prototype={compare:function(e){var d=this.elements,e=e&&e.elements;if(!e||d.length!=e.length)return!1;for(var n=0;n<d.length;n++)if(!s.equals(d[n],e[n]))return!1;return!0},contains:function(d){for(var i=this.elements,n=0;n<i.length;n++)if(i[n]._4e_name()in d)return i[n];return r},toString:function(){var d=this.elements,
i,n=[];for(i=0;i<d.length;i++)n.push(d[i]._4e_name());return n.toString()}};return w.ElementPath=v},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/enterKey/index",function(i){function v(d){var o;o=d.getSelection().getRanges();for(var p=o.length-1;0<p;p--)o[p].deleteContents();o=o[0];p=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var b=(new k(o.startContainer)).block;if(b&&("li"==b._4e_name()||"li"==b.parent()._4e_name()))return d.hasCommand("outdent")?(d.execCommand("save"),d.execCommand("outdent"),d.execCommand("save"),!0):!1}var c=o.splitBlock("p");if(!c)return!0;var d=c.previousBlock,b=c.nextBlock,g=
c.wasStartOfBlock,m=c.wasEndOfBlock,f;if(b)f=b.parent(),"li"==f._4e_name()&&(b._4e_breakParent(f),b._4e_move(b.next(),!0));else if(d&&(f=d.parent())&&"li"==f._4e_name())d._4e_breakParent(f),o.moveToElementEditablePosition(d.next()),d._4e_move(d.prev());if(!g&&!m){if("li"==b._4e_name()&&(f=b.first(e.invisible(!0)))&&i.inArray(f._4e_name(),["ul","ol"]))(l.ie?new u(p.createTextNode("\u00a0")):new u(p.createElement("br"))).insertBefore(f);b&&o.moveToElementEditablePosition(b)}else{var a;if(d){if("li"==d._4e_name()||
!t.test(d._4e_name()))a=d.clone()}else b&&(a=b.clone());a||(a=new u("<p>",null,p));if(f=c.elementPath)for(var c=0,h=f.elements.length;c<h;c++){var j=f.elements[c];if(j.equals(f.block)||j.equals(f.blockLimit))break;r.$removeEmpty[j._4e_name()]&&(j=j.clone(),a._4e_moveChildren(j),a.append(j))}l.ie||a._4e_appendBogus();o.insertNode(a);if(l.ie&&g&&(!m||!d[0].childNodes.length))o.moveToElementEditablePosition(m?d:a),o.select();o.moveToElementEditablePosition(g&&!m?b:a)}l.ie||(b?(a=new u(p.createElement("span")),
a.html("&nbsp;"),o.insertNode(a),a.scrollIntoView(void 0,!1),o.deleteContents()):a.scrollIntoView(void 0,!1));o.select();return!0}function w(e){var i=e.get("document")[0];d.on(i,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){e.execCommand("save");var b=e.execCommand("enterBlock");e.execCommand("save");!1!==b&&d.preventDefault()}})}var s=i.Editor,l=i.UA,t=/^h[1-6]$/,r=s.XHTML_DTD,u=i.Node,d=i.Event,e=s.Walker,k=s.ElementPath;return{init:function(d){d.addCommand("enterBlock",
{exec:v});d.docReady(function(){w(d)})}}},{requires:["editor"]});
KISSY.add("editor/core/focusManager",function(i){function v(){var i=this;i.__iframeFocus=e;d=i;u&&clearTimeout(u);u=setTimeout(function(){i.fire("focus")},100)}function w(){var e=this;e.__iframeFocus=k;d=n;u&&clearTimeout(u);u=setTimeout(function(){e.fire("blur")},100)}var s=i.Editor,l=i.DOM,t=i.Event,r={},u,d,i={refreshAll:function(){for(var d in r)if(r.hasOwnProperty(d)){var e=r[d].get("document")[0];e.designMode="off";e.designMode="on"}},currentInstance:function(){return d},getInstance:function(d){return r[d]},
add:function(d){var e=l._4e_getWin(d.get("document")[0]);t.on(e,"focus",v,d);t.on(e,"blur",w,d)},register:function(d){r[d._UUID]=d},remove:function(d){delete r[d._UUID];var e=l._4e_getWin(d.get("document")[0]);t.remove(e,"focus",v,d);t.remove(e,"blur",w,d)}},e=!0,k=!1,n=null;i.refreshAll=i.refreshAll;s.focusManager=i;s.getInstances=function(){return r};return i},{requires:["./base","./dom"]});
KISSY.add("editor/plugin/htmlDataProcessor/index",function(i){return{init:function(v){function w(c){return c.replace(p,function(c,f,a){return"<"+f+a.replace(b,function(h,b){return-1==a.indexOf("_ke_saved_"+b)?" _ke_saved_"+h+" "+h:h})+">"})}function s(b){return b.replace(/<\!--(?!{ke_protected})[\s\S]+?--\>/g,function(b){return"<\!--"+c+"{C}"+encodeURIComponent(b).replace(/--/g,"%2D%2D")+"--\>"})}function l(b){return b.replace(/<\!--\{ke_protected\}\{C\}([\s\S]+?)--\>/g,function(b,c){return decodeURIComponent(c)})}
var t=t,r=i.Editor,u=i.Node,d=i.UA,e=i.require("htmlparser"),k=new e.Filter,n=new e.Filter,o=new e.Filter;(function(){var b=function(a,b){return function(j,c){var f=[];(""+j).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(j,A,d){A=A.toLowerCase();"font-family"==A&&(d=d.replace(/["']/g,""));for(var e,m,g,i=0;i<a.length;i++)if(a[i]&&(j=a[i][0],e=a[i][1],m=a[i][2],g=a[i][3],A.match(j)&&(!e||d.match(e)))){A=g||A;b&&(m=m||d);"function"==typeof m&&(m=m(d,c,A));m&&m.push&&
(A=m[0],m=m[1]);"string"==typeof m&&f.push([A,m]);return}!b&&f.push([A,d])});for(var d=0;d<f.length;d++)f[d]=f[d].join(":");return f.length?f.join(";")+";":!1}}([[/mso/i],[/w:WordDocument/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i]],t),m={tagNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren()},tags:{p:function(a){a.filterChildren()},$:function(a){var b=a.nodeName||"";if(-1!=b.indexOf(":")&&
!/^ke/.test(b))if("v:imagedata"==b){if(b=a.getAttribute("o:href"))a.setAttribute("src",b),a.removeAttribute("o:href");if(b=a.getAttribute("o:title"))a.setAttribute("title",b),a.removeAttribute("o:title");a.setTagName("img")}else a.setTagName("")}},attributes:{"class":function(a){return!a||/(^|\s+)Mso/.test(a)?!1:a},style:function(a){a=b(a);return!a?!1:a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],j,c=0;c<b.length;c++)j="_ke_saved_"+b[c],a.getAttribute(j)&&a.removeAttribute(b[c]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var j=b.getAttribute("width"),b=b.getAttribute("height");j&&a.setAttribute("width",j);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1}},attributes:{style:function(a){if(!i.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,
""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^_ks.*/,""],[/^ke:.*$/,""]],comment:function(a){return a.substr(0,c.length)==c?(a="{C}"==a.substr(c.length,3)?a.substr(c.length+3):a.substr(c.length),new e.CData(decodeURIComponent(a))):a}};d.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});k.addRules(f);n.addRules(m);o.addRules(m)})();(function(){function b(a){for(var a=a.childNodes,h=a.length,j=a[h-1];j&&3==j.nodeType&&!i.trim(j.nodeValue);)j=a[--h];return j}
function c(a,h){var f=b(a);f&&((h||!d.ie)&&1==f.nodeType&&"br"==f.nodeName?a.removeChild(f):3==f.nodeType&&j.test(f.nodeValue)&&a.removeChild(f))}function f(a){var h=b(a);return!h||1==h.nodeType&&"br"==h.nodeName||"form"==a.nodeName&&"input"==h.nodeName}function a(a){c(a,!0);f(a)&&(d.ie?a.appendChild(new e.Text("\u00a0")):(a.appendChild(new e.Text("&nbsp;")),a.appendChild(new e.Tag("br"))))}function h(a){c(a,!1);f(a)&&a.appendChild(new e.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,q=r.XHTML_DTD,x=r.Utils.mix({},
q.$block,q.$listItem,q.$tableContent),l;for(l in x)x.hasOwnProperty(l)&&("br"in q[l]||delete x[l]);delete x.td;delete x.pre;var q={tags:{}},p={tags:{}};for(l in x)x.hasOwnProperty(l)&&(q.tags[l]=a,p.tags[l]=h);n.addRules(q);k.addRules(p);o.addRules(q)})();(function(){k.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}})})();var p=/<(a|area|img|input)\b([^>]*)>/gi,b=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}";v.htmlDataProcessor={wordFilter:o,
dataFilter:n,htmlFilter:k,toHtml:function(b){var c=new e.BeautifyWriter;(new e.Parser(b)).parse().writeHtml(c,k);return c.getHtml()},toDataFormat:function(b,c,f){f=f||n;d.gecko&&(b=b.replace(/(<\!--\[if[^<]*?\])--\>([\S\s]*?)<\!--(\[endif\]--\>)/gi,"$1$2$3"));b=w(b);c=new u("<div>");c.html("a"+b);b=c.html().substr(1);b=l(b);c=new e.BeautifyWriter;(new e.Parser(b)).parse().writeHtml(c,f);b=c.getHtml();return b=s(b)},toServer:function(b){var c=new e.MinifyWriter;(new e.Parser(b)).parse().writeHtml(c,
k);return c.getHtml()}}}}},{requires:["editor"]});KISSY.add("editor/core/meta",function(){});
KISSY.add("editor/core/range",function(i,v,w,s,l){function t(a,h){var c=a.startContainer,f=a.endContainer,d=a.startOffset,e=a.endOffset,q,i=o,g=o,x=void 0,l=a.document,k;if(a.collapsed)return x;0<h&&(x=l.createDocumentFragment());a.optimizeBookmark();f[0].nodeType==b.NODE_TEXT?(g=n,f=f._4e_splitText(e)):0<f[0].childNodes.length&&(e>=f[0].childNodes.length?(f=new j(f[0].appendChild(l.createTextNode(""))),k=n):f=new j(f[0].childNodes[e]));c[0].nodeType==b.NODE_TEXT?(i=n,c._4e_splitText(d)):d?d>=c[0].childNodes.length?
(c=new j(c[0].appendChild(l.createTextNode(""))),q=n):c=new j(c[0].childNodes[d].previousSibling):(q=new j(l.createTextNode("")),c.prepend(q),c=q,q=n);var y=c._4e_parents(),p=f._4e_parents();y.each(function(a,b){y[b]=a});p.each(function(a,b){p[b]=a});for(var C,K,l=0;l<y.length&&!(C=y[l],K=p[l],!C.equals(K));l++);for(var d=x,z,L,M=l;M<y.length;M++){z=y[M];e=0<h&&!z.equals(c)?d.appendChild(z.clone()[0]):null;z=z[0].nextSibling;for(var T=f[0],U=p[M][0];z&&!(U==z||T==z);)L=z.nextSibling,2==h?d.appendChild(z.cloneNode(n)):
(m._4e_remove(z),1==h&&d.appendChild(z)),z=L;e&&(d=e)}for(d=x;l<p.length;l++){z=p[l];e=0<h&&!z.equals(f)?d.appendChild(z.clone()[0]):null;if(!y[l]||z[0].parentNode!=y[l][0].parentNode)for(z=z[0].previousSibling;z;)L=z.previousSibling,2==h?d.insertBefore(z.cloneNode(n),d.firstChild):(m._4e_remove(z),1==h&&d.insertBefore(z,d.firstChild)),z=L;e&&(d=e)}if(2==h){if(i&&(C=c[0],C.nodeType==b.NODE_TEXT&&C.nextSibling&&C.nextSibling.nodeType==b.NODE_TEXT&&(C.data+=C.nextSibling.data,C.parentNode.removeChild(C.nextSibling))),
g)g=f[0],g.nodeType==b.NODE_TEXT&&g.previousSibling&&g.previousSibling.nodeType==b.NODE_TEXT&&(g.previousSibling.data+=g.data,g.parentNode.removeChild(g))}else{if(C&&K&&(!c.parent().equals(C.parent())||!f.parent().equals(K.parent())))g=C._4e_index(),q&&C.parent().equals(q.parent())&&g--,a.setStart(C.parent(),g+1);a.collapse(n)}q&&c.remove();k&&f.remove();return x}function r(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function u(a){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=p;this.collapsed=n;this.document=a}function d(a){var c=a.nodeType!=b.NODE_TEXT&&m._4e_name(a)in h.$removeEmpty,j=!i.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return c||j||a}function e(a){return!y(a)&&!B(a)}function k(h){var c=o,j=s.bookmark(n);return function(f){if(j(f))return n;if(f.nodeType==b.NODE_TEXT){if(i.trim(f.nodeValue).length)return o}else if(f.nodeType==b.NODE_ELEMENT&&(f=m._4e_name(f),!x[f]))if(!h&&!a.ie&&"br"==
f&&!c)c=n;else return o;return n}}v.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var n=!0,o=!1,p=null,b=v.NODE,c=v.RANGE,g=v.POSITION,m=i.DOM,f=w.getByAddress,a=i.UA,h=v.XHTML_DTD,j=i.Node,q={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};i.augment(u,{toString:function(){var a=[],b=this.startContainer[0],h=this.endContainer[0];
a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((h.id||h.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,h=this.startOffset;a[0].nodeType!=b.NODE_ELEMENT&&(h?h>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;h=this.endOffset;a[0].nodeType!=b.NODE_ELEMENT&&(h?h>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),
a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a._4e_name()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b._4e_name()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,h){a[0].nodeType==b.NODE_ELEMENT&&q[a._4e_name()]&&(a=a.parent(),h=a._4e_index());this.startContainer=a;this.startOffset=
h;this.endContainer||(this.endContainer=a,this.endOffset=h);r(this)},setEnd:function(a,h){a[0].nodeType==b.NODE_ELEMENT&&q[a._4e_name()]&&(a=a.parent(),h=a._4e_index()+1);this.endContainer=a;this.endOffset=h;this.startContainer||(this.startContainer=a,this.startOffset=h);r(this)},setStartAt:function(a,h){switch(h){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);
break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}r(this)},setEndAt:function(a,h){switch(h){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==b.NODE_TEXT?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}r(this)},cloneContents:function(){return t(this,2)},deleteContents:function(){return t(this,
0)},extractContents:function(){return t(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=n},clone:function(){var a=new u(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();
if(a.startContainer[0].nodeType!=b.NODE_ELEMENT||a.endContainer[0].nodeType!=b.NODE_ELEMENT)return p;var h=new s(a),c=s.bookmark(!1,!0),j=s.whitespaces(n);h.evaluator=function(a){return j(a)&&c(a)};a=h.next();h.reset();h=h.previous();return a&&a.equals(h)?a:p},shrink:function(a,h){if(!this.collapsed){var a=a||c.SHRINK_TEXT,j=this.clone(),f=this.startContainer,d=this.endContainer,e=this.startOffset,q=this.endOffset,m=n,g,i,x=n;f&&f[0].nodeType==b.NODE_TEXT&&(e?e>=f[0].nodeValue.length?j.setStartAfter(f):
(j.setStartBefore(f),m=o):j.setStartBefore(f));d&&d[0].nodeType==b.NODE_TEXT&&(q?q>=d[0].nodeValue.length?j.setEndAfter(d):(j.setEndAfter(d),x=o):j.setEndBefore(d));if(m||x)i=new s(j),i.evaluator=function(h){return h.nodeType==(a==c.SHRINK_ELEMENT?b.NODE_ELEMENT:b.NODE_TEXT)},i.guard=function(h,j){h=h[0]||h;if(a==c.SHRINK_ELEMENT&&h.nodeType==b.NODE_TEXT||j&&h==g)return o;!j&&h.nodeType==b.NODE_ELEMENT&&(g=h);return n};m&&(j=i[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(j,h?c.POSITION_AFTER_START:
c.POSITION_BEFORE_START);x&&(i.reset(),(i=i[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,h?c.POSITION_BEFORE_END:c.POSITION_AFTER_END));return m||x}},createBookmark2:function(a){var h=this.startContainer,c=this.endContainer,f=this.startOffset,d=this.endOffset,e,q;if(!h||!c)return{start:0,end:0};if(a){if(h[0].nodeType==b.NODE_ELEMENT&&(e=new j(h[0].childNodes[f]))&&e[0]&&e[0].nodeType==b.NODE_TEXT&&0<f&&e[0].previousSibling.nodeType==b.NODE_TEXT)h=e,f=0;for(;h[0].nodeType==b.NODE_TEXT&&
(q=h.prev())&&q[0].nodeType==b.NODE_TEXT;)h=q,f+=q[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==b.NODE_ELEMENT&&(e=new j(c[0].childNodes[d]))&&e[0]&&e[0].nodeType==b.NODE_TEXT&&0<d&&e[0].previousSibling.nodeType==b.NODE_TEXT)c=e,d=0;for(;c[0].nodeType==b.NODE_TEXT&&(q=c.prev())&&q[0].nodeType==b.NODE_TEXT;)c=q,d+=q[0].nodeValue.length}}return{start:h._4e_address(a),end:this.collapsed?p:c._4e_address(a),startOffset:f,endOffset:d,normalized:a,is2:n}},createBookmark:function(a){var b,h,
f,d,e=this.collapsed;b=new j("<span>",p,this.document);b.attr("_ke_bookmark",1);b.css("display","none");b.html("&nbsp;");a&&(f=i.guid("ke_bm_"),b.attr("id",f+"S"));e||(h=b.clone(),h.html("&nbsp;"),a&&h.attr("id",f+"E"),d=this.clone(),d.collapse(),d.insertNode(h));d=this.clone();d.collapse(n);d.insertNode(b);h?(this.setStartAfter(b),this.setEndBefore(h)):this.moveToPosition(b,c.POSITION_AFTER_END);return{startNode:a?f+"S":b,endNode:a?f+"E":h,serializable:a,collapsed:e}},moveToPosition:function(a,b){this.setStartAt(a,
b);this.collapse(n)},trim:function(a,h){var c=this.startContainer,j=this.startOffset,f=this.collapsed;if((!a||f)&&c[0]&&c[0].nodeType==b.NODE_TEXT){if(j)if(j>=c[0].nodeValue.length)j=c._4e_index()+1,c=c.parent();else{var d=c._4e_splitText(j),j=c._4e_index()+1,c=c.parent();m.equals(this.startContainer,this.endContainer)?this.setEnd(d,this.endOffset-this.startOffset):m.equals(c,this.endContainer)&&(this.endOffset+=1)}else j=c._4e_index(),c=c.parent();this.setStart(c,j);if(f){this.collapse(n);return}}c=
this.endContainer;j=this.endOffset;!h&&!f&&c[0]&&c[0].nodeType==b.NODE_TEXT&&(j?(j>=c.nodeValue.length||c._4e_splitText(j),j=c._4e_index()+1):j=c._4e_index(),c=c.parent(),this.setEnd(c,j))},insertNode:function(a){this.optimizeBookmark();this.trim(o,n);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=this.document;if(a.is2){var h=f(b,a.start,a.normalized),c=
a.startOffset,b=a.end&&f(b,a.end,a.normalized),a=a.endOffset;this.setStart(h,c);b?this.setEnd(b,a):this.collapse(n)}else h=(c=a.serializable)?i.one("#"+a.startNode,b):a.startNode,a=c?i.one("#"+a.endNode,b):a.endNode,this.setStartBefore(h),h._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(n)},getCommonAncestor:function(a,h){var c=this.startContainer,f=this.endContainer,c=c[0]==f[0]?a&&c[0].nodeType==b.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new j(c[0].childNodes[this.startOffset]):
c:c._4e_commonAncestor(f);return h&&c[0].nodeType==b.NODE_TEXT?c.parent():c},enlarge:function(a){switch(a){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var a=this.getCommonAncestor(),f=new j(this.document.body),d,e,q,g,x,l=o,k,y;k=this.startContainer;y=this.startOffset;if(k[0].nodeType==b.NODE_TEXT){if(y&&(k=!i.trim(k[0].nodeValue.substring(0,y)).length&&k,l=!!k),k&&!(g=k[0].previousSibling))q=k.parent()}else y&&(g=k[0].childNodes[y-1]||k[0].lastChild),g||(q=k);for(;q||g;){if(q&&!g){!x&&m.equals(q,
a)&&(x=n);if(!f.contains(q))break;if(!l||"inline"!=q.css("display"))l=o,x?d=q:this.setStartBefore(q);g=q[0].previousSibling}for(;g;){k=o;if(g.nodeType==b.NODE_TEXT)y=g.nodeValue,/[^\s\ufeff]/.test(y)&&(g=p),k=/[\s\ufeff]$/.test(y);else if((0<g.offsetWidth||"br"==m._4e_name(g))&&!g.getAttribute("_ke_bookmark"))if(l&&h.$removeEmpty[g.nodeName.toLowerCase()]){y=m.text(g);if(/[^\s\ufeff]/.test(y))g=p;else for(var t=g.getElementsByTagName("*"),r=0,v;v=t[r++];)if(!h.$removeEmpty[v.nodeName.toLowerCase()]){g=
p;break}g&&(k=!!y.length)}else g=p;k&&(l?x?d=q:q&&this.setStartBefore(q):l=n);if(g){k=g.previousSibling;if(!q&&!k){q=new j(g);g=p;break}g=k}else q=p}q&&(q=q.parent())}k=this.endContainer;y=this.endOffset;q=g=p;x=l=o;if(k[0].nodeType==b.NODE_TEXT){if(k=!i.trim(k[0].nodeValue.substring(y)).length&&k,l=!(k&&k[0].nodeValue.length),k&&!(g=k[0].nextSibling))q=k.parent()}else(g=k[0].childNodes[y])||(q=k);for(;q||g;){if(q&&!g){!x&&m.equals(q,a)&&(x=n);if(!f.contains(q))break;if(!l||"inline"!=q.css("display"))l=
o,x?e=q:q&&this.setEndAfter(q);g=q[0].nextSibling}for(;g;){k=o;if(g.nodeType==b.NODE_TEXT)y=g.nodeValue,/[^\s\ufeff]/.test(y)&&(g=p),k=/^[\s\ufeff]/.test(y);else if((0<g.offsetWidth||"br"==m._4e_name(g))&&!g.getAttribute("_ke_bookmark"))if(l&&h.$removeEmpty[g.nodeName.toLowerCase()]){y=m.text(g);if(/[^\s\ufeff]/.test(y))g=p;else{t=g.all||g.getElementsByTagName("*");for(r=0;v=t[r++];)if(!h.$removeEmpty[v.nodeName.toLowerCase()]){g=p;break}}g&&(k=!!y.length)}else g=p;k&&l&&(x?e=q:this.setEndAfter(q));
if(g){k=g.nextSibling;if(!q&&!k){q=new j(g);g=p;break}g=k}else q=p}q&&(q=q.parent())}d&&e&&(a=d.contains(e)?e:d,this.setStartBefore(a),this.setEndAfter(a));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:q=new u(this.document);f=new j(this.document.body);q.setStartAt(f,c.POSITION_AFTER_START);q.setEnd(this.startContainer,this.startOffset);q=new s(q);var B,C,K=s.blockBoundary(a==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:p),z=function(a){var b=K(a);b||(B=new j(a));return b};d=function(a){var b=
z(a);!b&&"br"==m._4e_name(a)&&(C=new j(a));return b};q.guard=z;q=q.lastBackward();B=B||f;this.setStartAt(B,"br"!=B._4e_name()&&(!q&&this.checkStartOfBlock()||q&&B.contains(q))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);q=this.clone();q.collapse();q.setEndAt(f,c.POSITION_BEFORE_END);q=new s(q);q.guard=a==c.ENLARGE_LIST_ITEM_CONTENTS?d:z;B=p;q=q.lastForward();B=B||f;this.setEndAt(B,!q&&this.checkEndOfBlock()||q&&B.contains(q)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);C&&this.setEndAfter(C)}},
checkStartOfBlock:function(){var a=this.startContainer,h=this.startOffset;if(h&&a[0].nodeType==b.NODE_TEXT&&i.trim(a[0].nodeValue.substring(0,h)).length)return o;this.trim();a=new l(this.startContainer);h=this.clone();h.collapse(n);h.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);a=new s(h);a.evaluator=k(n);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,h=this.endOffset;if(a[0].nodeType==b.NODE_TEXT&&i.trim(a[0].nodeValue.substring(h)).length)return o;this.trim();
a=new l(this.endContainer);h=this.clone();h.collapse(o);h.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new s(h);a.evaluator=k(o);return a.checkForward()},checkBoundaryOfElement:function(a,b){var h=this.clone();h[b==c.START?"setStartAt":"setEndAt"](a,b==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);h=new s(h);h.evaluator=d;return h[b==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,h=this.endContainer,c=this.startOffset,f=this.endOffset,
d;if(a[0].nodeType==b.NODE_ELEMENT)if(d=a[0].childNodes.length,d>c)a=new j(a[0].childNodes[c]);else if(1>d)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new j(a);a=a._4e_nextSourceNode()||a}if(h[0].nodeType==b.NODE_ELEMENT)if(d=h[0].childNodes.length,d>f)h=(new j(h[0].childNodes[f]))._4e_previousSourceNode(n);else if(1>d)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=new j(h)}a._4e_position(h)&g.POSITION_FOLLOWING&&(a=h);return{startNode:a,endNode:h}},
fixBlock:function(h,b){var f=this.createBookmark(),d=new j(this.document.createElement(b));this.collapse(h);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();a.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(f);return d},splitBlock:function(h){var b=new l(this.startContainer),j=new l(this.endContainer),f=b.block,d=j.block,q=p;if(!b.blockLimit.equals(j.blockLimit))return p;"br"!=h&&(f||(f=this.fixBlock(n,h),d=(new l(this.endContainer)).block),
d||(d=this.fixBlock(o,h)));h=f&&this.checkStartOfBlock();b=d&&this.checkEndOfBlock();this.deleteContents();f&&m.equals(f,d)&&(b?(q=new l(this.startContainer),this.moveToPosition(d,c.POSITION_AFTER_END),d=p):h?(q=new l(this.startContainer),this.moveToPosition(f,c.POSITION_BEFORE_START),f=p):(d=this.splitElement(f),!a.ie&&!i.inArray(f._4e_name(),["ul","ol"])&&f._4e_appendBogus()));return{previousBlock:f,nextBlock:d,wasStartOfBlock:h,wasEndOfBlock:b,elementPath:q}},splitElement:function(a){if(!this.collapsed)return p;
this.setEndAt(a,c.POSITION_BEFORE_END);var h=this.extractContents(),b=a.clone(o);b[0].appendChild(h);b.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return b},moveToElementEditablePosition:function(a,j){var f,d=h;if(d.$empty[a._4e_name()])return o;for(;a&&a[0].nodeType==b.NODE_ELEMENT;){if(f=a._4e_isEditable())this.moveToPosition(a,j?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);else if(d.$inline[a._4e_name()])return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),
n;if((a=d.$empty[a._4e_name()]?a[j?"prev":"next"](e):j?a.last(e):a.first(e))&&a[0].nodeType==b.NODE_TEXT)return this.moveToPosition(a,j?c.POSITION_AFTER_END:c.POSITION_BEFORE_START),n}return f},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==b.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var x={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,
"var":1},y=new s.whitespaces,B=new s.bookmark;v.Utils.injectDom({_4e_breakParent:function(a,h){var b=v.Range,h=new j(h),b=new b(a.ownerDocument);b.setStartAfter(new j(a));b.setEndAfter(h);var c=b.extractContents();b.insertNode(new j(m._4e_remove(a)));a.parentNode.insertBefore(c,a.nextSibling)}});v.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(i){function v(a){this.document=a;this._={cache:{}};if(o){var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=l}}function w(a){a=new v(a);return!a||a.isInvalid?t:a}var s=i.Editor;s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var l=!0,t=null,r=i.UA,u=i.DOM,d=i.Node,e=s.SELECTION,k=s.RANGE,n=s.NODE,o=r.ie,p=s.Walker,b=s.Range,c={img:1,hr:1,li:1,
table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};i.augment(v,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=u._4e_getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var a=this._.cache;if(a.type)return a.type;var b=e.SELECTION_TEXT,j=this.getNative();if(j){if(1==j.rangeCount){var j=j.getRangeAt(0),
f=j.startContainer;f==j.endContainer&&f.nodeType==n.NODE_ELEMENT&&1==Number(j.endOffset-j.startOffset)&&c[f.childNodes[j.startOffset].nodeName.toLowerCase()]&&(b=e.SELECTION_ELEMENT)}}else b=e.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=e.SELECTION_NONE;try{var c=this.getNative(),f=c.type;"Text"==f&&(b=e.SELECTION_TEXT);"Control"==f&&(b=e.SELECTION_ELEMENT);c.createRange().parentElement&&(b=e.SELECTION_TEXT)}catch(d){}return a.type=b},getRanges:o?function(){var a=
function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),f=c.childNodes,d,g=0;g<f.length;g++){var e=f[g];if(e.nodeType==n.NODE_ELEMENT){d=a.duplicate();d.moveToElementText(e);var e=d.compareEndPoints("StartToStart",a),m=d.compareEndPoints("EndToStart",a);d.collapse();if(0<e)break;else{if(!e||1==m&&-1==e)return{container:c,offset:g};if(!m)return{container:c,offset:g+1}}d=t}}d||(d=a.duplicate(),d.moveToElementText(c),d.collapse(!1));d.setEndPoint("StartToStart",a);d=(""+d.text).replace(/\r\n|\r/g,
"\n").length;try{for(;0<d;)d-=f[--g].nodeValue.length}catch(i){d=0}return 0===d?{container:c,offset:g}:{container:f[g],offset:-d}};return function(h){var c=this._.cache;if(c.ranges&&!h)return c.ranges;var f=this.getNative(),h=f&&f.createRange(),g=this.getType();if(!f)return[];if(g==e.SELECTION_TEXT)return f=new b(this.document),g=a(h,l),f.setStart(new d(g.container),g.offset),g=a(h),f.setEnd(new d(g.container),g.offset),c.ranges=[f];if(g==e.SELECTION_ELEMENT){c=c.ranges=[];for(g=0;g<h.length;g++){for(var m=
h.item(g),i=m.parentNode,k=0,f=new b(this.document);k<i.childNodes.length&&i.childNodes[k]!=m;k++);f.setStart(new d(i),k);f.setEnd(new d(i),k+1);c.push(f)}return c}return c.ranges=[]}}():function(a){var h=this._.cache;if(h.ranges&&!a)return h.ranges;var a=[],c=this.getNative();if(!c)return[];for(var f=0;f<c.rangeCount;f++){var g=c.getRangeAt(f),e=new b(this.document);e.setStart(new d(g.startContainer),g.startOffset);e.setEnd(new d(g.endContainer),g.endOffset);a.push(e)}return h.ranges=a},getStartElement:function(){var a=
this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case e.SELECTION_ELEMENT:return this.getSelectedElement();case e.SELECTION_TEXT:var f=this.getRanges()[0];if(f&&!f.collapsed){for(f.optimize();l;)if(b=f.startContainer,f.startOffset==(b[0].nodeType===n.NODE_ELEMENT?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())f.setStartAfter(b);else break;b=f.startContainer;if(b[0].nodeType!=n.NODE_ELEMENT)return b.parent();b=new d(b[0].childNodes[f.startOffset]);
if(!b[0]||b[0].nodeType!=n.NODE_ELEMENT)return f.startContainer;for(f=b[0].firstChild;f&&f.nodeType==n.NODE_ELEMENT;)b=new d(f),f=f.firstChild;return b}if(o)f=c.createRange(),f.collapse(l),b=new d(f.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=n.NODE_ELEMENT)b=b.parentNode;b&&(b=new d(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;if(void 0!==b.selectedElement)return b.selectedElement;o&&(a=this.getNative().createRange(),a=a.item&&a.item(0));if(!a){a=this.getRanges()[0];
for(var f,g,e=2;e&&(!(f=a.getEnclosedNode())||!(f[0].nodeType==n.NODE_ELEMENT&&c[f._4e_name()]&&(g=f)));e--)a.shrink(k.SHRINK_ELEMENT);a=g}return b.selectedElement=new d(a)},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(o)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(f){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);
this.reset()},selectRanges:function(a){if(o){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var f=a[c],d=this.document.createRange(),g=f.startContainer;if(f.collapsed&&(r.gecko&&1.09>r.gecko||r.opera||r.webkit)&&g[0].nodeType==n.NODE_ELEMENT&&!g[0].childNodes.length)g[0].appendChild(this.document.createTextNode(r.webkit?"\u200b":"")),f.startOffset++,f.endOffset++;
d.setStart(g[0],f.startOffset);d.setEnd(f.endContainer[0],f.endOffset);b.addRange(d)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),f=0;f<c.length;f++)b.push(c[f].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],f=this.document,d,b=b||this.getRanges(),g=b.length,e=0;e<g;e++){c.push(d=b[e].createBookmark(a,l));var m=(a=d.serializable)?i.one("#"+d.startNode,f):d.startNode;d=a?i.one("#"+d.endNode,f):d.endNode;for(var k=e+1;k<g;k++){var n=b[k],o=n.startContainer,
p=n.endContainer;u.equals(o,m.parent())&&n.startOffset++;u.equals(o,d.parent())&&n.startOffset++;u.equals(p,m.parent())&&n.endOffset++;u.equals(p,d.parent())&&n.endOffset++}}return c},selectBookmarks:function(a){for(var c=[],f=0;f<a.length;f++){var d=new b(this.document);d.moveToBookmark(a[f]);c.push(d)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();
a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var g={table:1,tbody:1,tr:1},m=p.whitespaces(l),f=/\ufeff|\u00a0/;b.prototype.select=b.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==n.NODE_ELEMENT&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=
c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(l),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=w(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var b=this.collapsed,c,e;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==n.NODE_ELEMENT){(new v(this.document)).selectElement(new d(i));return}}(this.startContainer[0].nodeType==n.NODE_ELEMENT&&
this.startContainer._4e_name()in g||this.endContainer[0].nodeType==n.NODE_ELEMENT&&this.endContainer._4e_name()in g)&&this.shrink(k.SHRINK_ELEMENT,l);var o=this.createBookmark(),i=o.startNode,p;b||(p=o.endNode);o=this.document.body.createTextRange();o.moveToElementText(i[0]);o.moveStart("character",1);if(p)a=this.document.body.createTextRange(),a.moveToElementText(p[0]),o.setEndPoint("EndToEnd",a),o.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!m(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&
c.nodeValue.match(f))&&(a||!i[0].previousSibling||i[0].previousSibling&&"br"==u._4e_name(i[0].previousSibling));e=new d(this.document.createElement("span"));e.html("&#65279;");e.insertBefore(i);c&&u.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(b){if(c?(o.moveStart("character",-1),o.select(),this.document.selection.clear()):o.select(),e)this.moveToPosition(e,k.POSITION_BEFORE_START),e._4e_remove()}else this.setEndBefore(p),p._4e_remove(),o.select()};
v.getSelection=w;return s.Selection=v},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/plugin/selection/index",function(i,v){function w(b){function c(a,b){var c=h.body.createTextRange();try{c.moveToPoint(a,b)}catch(f){c=d}return c}function g(){var a=h.selection.createRange();j&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&j.select();k.remove(h,"mouseup",g);k.remove(h,"mousemove",e);j=f=0}function e(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",j)?a.setEndPoint("StartToStart",j):a.setEndPoint("EndToEnd",j),a.select()}else g()}var f,
a=b.get("iframe")[0].contentWindow,h=b.get("document")[0],j;k.on(h,"mousedown contextmenu",function(b){var d=h.documentElement;if(b.target===d&&(f&&g(),!(d.scrollHeight>d.clientHeight)&&(f=1,j=c(b.pageX,b.pageY))))k.on(h,"mouseup",g),k.on(h,"mousemove",e),a.focus(),j.select()})}function s(b){function c(f){if(h){var d=b.getSelection(),j=d&&d.getType(),e=d&&g.selection;if(f&&e&&j==o.SELECTION_NONE&&!g.queryCommandEnabled("InsertImage"))setTimeout(function(){c(r)},50);else{var i;if(!e||!e.type||!("Control"!=
e.type&&(i=e.createRange())&&(i=i.parentElement())&&(i=i.nodeName)&&i.toLowerCase()in{input:1,textarea:1}))a=e&&d.getRanges()[0],b._monitor()}}}var g=b.get("document")[0],e=new n(g.body),f=new n(g.documentElement);if(8>v.Utils.ieEngine)f.on("click",function(a){"html"===(new n(a.target))._4e_name()&&b.getSelection().getNative().createRange().select()});var a,h,j=r;f.on("mousedown",function(){j=u});f.on("mouseup",function(){j=r});e.on("focusin",function(b){if("body"==(new n(b.target))._4e_name()&&a){try{j&&
a.select()}catch(c){}a=d}});e.on("focus",function(){h=r;c()});e.on("beforedeactivate",function(a){a.relatedTarget||(h=u,j=r)});e.on("mousedown",function(){h=u});e.on("mouseup",function(){h=r;setTimeout(function(){c(r)},0)});e.on("keydown",function(){h=u});e.on("keyup",function(){h=r;setTimeout(function(){c()},0)})}function l(b){var c=b.get("document")[0];k.on(c,"mouseup keyup",function(){b._monitor()})}function t(b){function c(a){var b=v.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a._4e_name()]}
function d(b){return a(b)&&h(b)}var i=b.get("document")[0],f=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,a=v.Walker.whitespaces(r),h=v.Walker.bookmark(u,r),j=function(b){return a(b)&&8!=b.nodeType};b.on("selectionChange",function(a){var h=a.path,k=new n(b.get("document")[0].body),a=(a=a.selection)&&a.getRanges()[0],l=h.blockLimit;if(e.gecko){var o=h.block||h.blockLimit,t=o&&o.last(d);o&&o._4e_isBlockBoundary()&&
(!t||!(1==t[0].nodeType&&t._4e_isBlockBoundary()))&&"pre"!=o._4e_name()&&!o._4e_getBogus()&&o._4e_appendBogus()}if(a&&a.collapsed&&!h.block){if("body"==l._4e_name()){if((h=a.fixBlock(r,"p"))&&h[0]!=k[0].lastChild&&h._4e_outerHtml().match(f))if((l=h.next(j))&&l[0].nodeType==p.NODE_ELEMENT&&!c[l])a.moveToElementEditablePosition(l),h._4e_remove();else if((l=h.prev(j))&&l[0].nodeType==p.NODE_ELEMENT&&!c[l])a.moveToElementEditablePosition(l,l._4e_outerHtml().match(f)?u:r),h._4e_remove();a.select();b.notifySelectionChange()}h=
new v.Range(i);h.moveToElementEditablePosition(k,r);"body"!==(new v.ElementPath(h.startContainer)).blockLimit._4e_name()&&(k=(new n(i.createElement("p"))).appendTo(k),e.ie||k._4e_appendBogus())}})}var r=!0,u=!1,d=null,e=i.UA,k=i.Event,n=i.Node,o=v.SELECTION,p=v.NODE;return{init:function(b){b.docReady(function(){e.ie?(w(b),s(b)):l(b)});t(b)}}},{requires:["editor"]});
KISSY.add("editor/core/styles",function(i){function v(a){return!B.attr(a,"_ke_bookmark")}function w(a,b){for(var c in a)a.hasOwnProperty(c)&&(i.isString(a[c])?a[c]=a[c].replace(S,function(a,c){return b[c]}):w(a[c],b))}function s(a,b){b&&(a=i.clone(a),w(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#"==c||N[c]?A.STYLE_BLOCK:O[c]?A.STYLE_OBJECT:A.STYLE_INLINE;this._={definition:a}}function l(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var f=new Q(a),d=f.getRanges(),h=0;h<d.length;h++)c.call(this,d[h]);f.selectRanges(d)}function t(a,b,c){var f=a.element;"*"==f&&(f="span");b=new F(b.createElement(f));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=s.getStyleText(c);if(a)for(var d in a)a.hasOwnProperty(d)&&b.attr(d,a[d]);c&&(b[0].style.cssText=c);return b}function r(a){var b=a.createBookmark(j),c=a.createIterator();c.enforceRealBlocks=j;c.enlargeBr=j;for(var f,h=a.document;f=c.getNextParagraph();){var g=t(this,h,
f),i=g,g="pre"==i._4e_name,m="pre"==f._4e_name,k=!g&&m;g&&!m?(m=f,k=m.html(),k=u(k,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),k=k.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),k=k.replace(/([ \t\n\r]+|&nbsp;)/g," "),k=k.replace(/<br\b[^>]*>/gi,"\n"),E.ie?(m=m[0].ownerDocument.createElement("div"),m.appendChild(i[0]),i[0].outerHTML="<pre>"+k+"</pre>",i=new F(m.firstChild),i._4e_remove()):i.html(k)):k?i=e(d(f),i):f._4e_moveChildren(i);f[0].parentNode.replaceChild(i[0],f[0]);if(g&&(f=i,g=void 0,(g=f._4e_previousSourceNode(j,
H.NODE_ELEMENT))&&"pre"==g._4e_name()))i=u(g.html(),/\n$/,"")+"\n\n"+u(f.html(),/^\n/,""),E.ie?f[0].outerHTML="<pre>"+i+"</pre>":f.html(i),g._4e_remove()}a.moveToBookmark(b)}function u(a,b,c){var f="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(f=b);c&&(d=c);return""});return f+a.replace(b,c)+d}function d(a){var b=[];u(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function e(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),f=0;f<a.length;f++){var d=a[f],d=d.replace(/(\r\n|\r)/g,"\n"),d=u(d,/^[ \t]*\n/,""),d=u(d,/\n$/,""),d=u(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
h=b.clone();h.html(d);c.appendChild(h[0])}return c}function k(a){var b=a.document;if(a.collapsed)b=t(this,b,void 0),a.insertNode(b),a.moveToPosition(b,I.POSITION_BEFORE_END);else{var c=this.element,f=this._.definition,d,h=G[c];h||(d=j,h=G.span);var g=a.createBookmark();a.enlarge(I.ENLARGE_ELEMENT);a.trim();for(var e=a.createBookmark(),i=e.startNode,e=e.endNode,k=i,l;k&&k[0];){var n=q;if(B.equals(k,e))k=x,n=j;else{var o=k[0].nodeType,p=o==H.NODE_ELEMENT?k._4e_name():x;if(p&&k.attr("_ke_bookmark")){k=
k._4e_nextSourceNode(j);continue}if(!p||h[p]&&(k._4e_position(e)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(k))){var r=k.parent();if(r&&"a"==c&&r._4e_name()==c)o=t(this,b,void 0),r._4e_moveChildren(o),r[0].parentNode.replaceChild(o[0],r[0]),o._4e_mergeSiblings();else if(r&&r[0]&&((G[r._4e_name()]||G.span)[c]||d)&&(!f.parentRule||f.parentRule(r))){if(!l&&(!p||!G.$removeEmpty[p]||(k._4e_position(e)|
D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED))l=new R(b),l.setStartBefore(k);if(o==H.NODE_TEXT||o==H.NODE_ELEMENT&&!k[0].childNodes.length){r=k;for(o=null;(n=!r.next(v))&&(o=r.parent())&&h[o._4e_name()]&&(o._4e_position(i)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(o));)r=o;l.setEndAfter(r)}}else n=
j}else n=j;k=k._4e_nextSourceNode()}if(n&&l&&!l.collapsed){for(var n=t(this,b,void 0),r=l.getCommonAncestor(),o={},p={},u,y=null,s;n&&r&&n[0]&&r[0];){if(r._4e_name()==c){for(u in f.attributes)if(f.attributes.hasOwnProperty(u)&&!p[u]&&(s=r.attr(y)))n.attr(u)==s?n.removeAttr(u):p[u]=1;for(y in f.styles)if(f.styles.hasOwnProperty(y)&&!o[y]&&(s=r.style(y)))n.style(y)==s?n.style(y,""):o[y]=1;if(!n._4e_hasAttributes()){n=x;break}}r=r.parent()}n?(n[0].appendChild(l.extractContents()),m(this,n),l.insertNode(n),
n._4e_mergeSiblings(),E.ie||n[0].normalize()):(n=new F(b.createElement("span")),n[0].appendChild(l.extractContents()),l.insertNode(n),m(this,n),n._4e_remove(!0));l=x}}i._4e_remove();e._4e_remove();a.moveToBookmark(g);a.shrink(I.SHRINK_TEXT)}}function n(a){a.enlarge(I.ENLARGE_ELEMENT);var d=a.createBookmark(),h=d.startNode;if(a.collapsed){for(var j=new J(h.parent()),e,g=0,i;g<j.elements.length&&(i=j.elements[g])&&!(i==j.block||i==j.blockLimit);g++)if(this.checkElementRemovable(i)){var k=a.checkBoundaryOfElement(i,
I.END),m=!k&&a.checkBoundaryOfElement(i,I.START);m||k?(e=i,e.match=m?"start":"end"):(i._4e_mergeSiblings(),i._4e_name()!=this.element?(k=b(this),f(i,k[i._4e_name()]||k["*"])):c(this,i))}if(e.length){i=h;for(g=0;;g++){k=j.elements[g];if(B.equals(k,e))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(i[0]);i=k}i["start"==e.match?"insertBefore":"insertAfter"](e)}}else{var l=d.endNode,n=this,j=function(){for(var a=new J(h.parent()),b=new J(l.parent()),c=x,f=x,d=0;d<a.elements.length;d++){var e=
a.elements[d];if(e==a.block||e==a.blockLimit)break;n.checkElementRemovable(e)&&(c=e)}for(d=0;d<b.elements.length;d++){e=b.elements[d];if(e==b.block||e==b.blockLimit)break;n.checkElementRemovable(e)&&(f=e)}f&&l._4e_breakParent(f);c&&h._4e_breakParent(c)};j();for(e=new F(h[0].nextSibling);e[0]!==l[0];){g=e._4e_nextSourceNode();if(e[0]&&e[0].nodeType==H.NODE_ELEMENT&&this.checkElementRemovable(e)&&(e._4e_name()==this.element?c(this,e):(i=b(this),f(e,i[e._4e_name()]||i["*"])),g[0].nodeType==H.NODE_ELEMENT&&
g.contains(h)))j(),g=new F(h[0].nextSibling);e=g}}a.moveToBookmark(d)}function o(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,f){b[c]=f});return b}function p(a,b){var c="";b!==q?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){i.isArray(c)||(c=[c]);for(var f=0;f<c.length;f++){var d=c[f],h,e,j;"string"==typeof d?h=d.toLowerCase():(h=d.element?d.element.toLowerCase():a.element,e=d.attributes,j=d.styles);d=b[h]||(b[h]={});if(e){h=d.attributes=d.attributes||[];for(var g in e)e.hasOwnProperty(g)&&h.push([g.toLowerCase(),e[g]])}if(j){var d=d.styles=d.styles||[],k;for(k in j)j.hasOwnProperty(k)&&d.push([k.toLowerCase(),j[k]])}}}return b}function c(c,f){var d=c._.definition,h=b(c),e=y.mix(d.attributes,(h[f._4e_name()]||h["*"]||
{}).attributes),d=y.mix(d.styles,(h[f._4e_name()]||h["*"]||{}).styles),h=i.isEmptyObject(e)&&i.isEmptyObject(d),k;for(k in e)if(e.hasOwnProperty(k)&&!(("class"==k||c._.definition.fullMatch)&&f.attr(k)!=g(k,e[k])))h=h||!!f.hasAttr(k),f.removeAttr(k);for(var m in d)d.hasOwnProperty(m)&&!(c._.definition.fullMatch&&f.style(m)!=g(m,d[m],j))&&(h=h||!!f.style(m),f.style(m,""));a(f)}function g(a,b,c){var f=new F("<span>");f[c?"style":"attr"](a,b);return f[c?"style":"attr"](a)}function m(a,d){for(var h=b(a),
e=d.all(a.element),j=e.length;0<=--j;)c(a,new F(e[j]));for(var g in h)if(h.hasOwnProperty(g)&&g!=a.element){e=d.all(g);for(j=e.length-1;0<=j;j--){var i=new F(e[j]);f(i,h[g])}}}function f(b,c){var f,d=c&&c.attributes;if(d)for(f=0;f<d.length;f++){var h=d[f][0],e;if(e=b.attr(h)){var j=d[f][1];(j===x||j.test&&j.test(e)||"string"==typeof j&&e==j)&&b[0].removeAttribute(h)}}if(d=c&&c.styles)for(f=0;f<d.length;f++)if(h=d[f][0],j=b.css(h)){var g=d[f][1];(g===x||g.test&&g.test(e)||"string"==typeof g&&j==g)&&
b.css(h,"")}a(b)}function a(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(j);b&&(b.nodeType==H.NODE_ELEMENT&&B._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==H.NODE_ELEMENT&&B._4e_mergeSiblings(c))}}var h=i.Editor,j=!0,q=!1,x=null,y=h.Utils,B=i.DOM,A={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},I=h.RANGE,Q=h.Selection,H=h.NODE,D=h.POSITION,R=h.Range,F=i.Node,E=i.UA,J=h.ElementPath,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},G=h.XHTML_DTD,O={embed:1,
hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;h.STYLE=A;s.prototype={apply:function(a){l.call(this,a,q)},remove:function(a){l.call(this,a,j)},applyToRange:function(a){return(this.applyToRange=this.type==A.STYLE_INLINE?k:this.type==A.STYLE_BLOCK?r:x).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==A.STYLE_INLINE?n:x).call(this,a)},checkElementRemovable:function(a,c){if(!a)return q;var f=this._.definition,
d;if(a._4e_name()==this.element){if(!c&&!a._4e_hasAttributes())return j;var h=f._AC;if(h)f=h;else{var h={},e=0,g=f.attributes;if(g)for(var i in g)g.hasOwnProperty(i)&&(e++,h[i]=g[i]);if(g=s.getStyleText(f))h.style||e++,h.style=g;h._length=e;f=f._AC=h}if(f._length){for(var k in f)if("_length"!=k&&f.hasOwnProperty(k)){e=a.attr(k)||"";if("style"==k)a:{h=f[k];e=p(e,q);"string"==typeof h&&(h=o(h));"string"==typeof e&&(e=o(e));g=void 0;for(g in h)if(h.hasOwnProperty(g)&&!(g in e&&(e[g]==h[g]||"inherit"==
h[g]||"inherit"==e[g]))){h=q;break a}h=j}else h=f[k]==e;if(h){if(!c)return j}else if(c)return q}if(c)return j}else return j}k=b(this);if(k=k[a._4e_name()]||k["*"]){if(!(f=k.attributes)&&!(d=k.styles))return j;if(f)for(h=0;h<f.length;h++)if(k=f[h][0],k=a.attr(k))if(e=f[h][1],e===x||"string"==typeof e&&k==e||e.test&&e.test(k))return j;if(d)for(h=0;h<d.length;h++)if(k=a.css(d[h][0]))if(f=d[h][1],f===x||"string"==typeof f&&k==f||f.test&&f.test(k))return j}return q},checkActive:function(a){switch(this.type){case A.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,j);case A.STYLE_OBJECT:case A.STYLE_INLINE:for(var b=a.elements,c=0,f;c<b.length;c++)if(f=b[c],!(this.type==A.STYLE_INLINE&&(B.equals(f,a.block)||B.equals(f,a.blockLimit))))if((this.type!=A.STYLE_OBJECT||f._4e_name()in O)&&this.checkElementRemovable(f,j))return j}return q}};s.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",f="";c.length&&(c=c.replace(P,";"));for(var d in b)if(b.hasOwnProperty(d)){var h=b[d],e=(d+":"+h).replace(P,
";");"inherit"==h?f+=e:c+=e}c.length&&(c=p(c));return a._ST=c+f};h.Style=s},{requires:["./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(i){var v=i.Editor,w=null,s=i.Node,l=i.DOM,t=i.UA,r=i.Event,u={debugUrl:function(d){d=d.replace(/-min\.(js|css)/i,".$1");i.Config.debug||(d=d.replace(/\.(js|css)/i,"-min.$1"));-1==d.indexOf("?t")&&(d=-1!=d.indexOf("?")?d+"&":d+"?",d+="t="+encodeURIComponent("20120515193540"));i.startsWith(d,"/")&&(d=d.substring(1));return v.Config.base+d},lazyRun:function(d,e,i){var l=d[e],o=d[i];d[e]=function(){l.apply(this,arguments);d[e]=d[i];return o.apply(this,arguments)}},
getXY:function(d,e,i,n){i=i.defaultView||i.parentWindow;d-=l.scrollLeft(i);e-=l.scrollTop(i);n&&(n=n.defaultView||n.parentWindow,i!=n&&i.frameElement&&(n=l.offset(i.frameElement,void 0,n),d+=n.left,e+=n.top));return{left:d,top:e}},tryThese:function(d){for(var e,i=0,l=arguments.length;i<l;i++){var o=arguments[i];try{e=o();break}catch(p){}}return e},arrayCompare:function(d,e){if(!d&&!e)return!0;if(!d||!e||d.length!=e.length)return!1;for(var i=0;i<d.length;i++)if(d[i]!==e[i])return!1;return!0},getByAddress:function(d,
e,i){for(var d=d.documentElement,l=0;d&&l<e.length;l++){var o=e[l];if(i)for(var p=-1,b=0;b<d.childNodes.length;b++){var c=d.childNodes[b];if(!(!0===i&&3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType)&&(p++,p==o)){d=c;break}}else d=d.childNodes[o]}return d?new s(d):w},clearAllMarkers:function(d){for(var e in d)d.hasOwnProperty(e)&&d[e]._4e_clearMarkers(d,!0)},ltrim:function(d){return d.replace(/^\s+/,"")},rtrim:function(d){return d.replace(/\s+$/,"")},mix:function(d){for(var e={},k=
0;k<arguments.length;k++)e=i.mix(e,arguments[k]);return e},isCustomDomain:function(){if(!t.ie)return!1;var d=document.domain,e=window.location.hostname;return d!=e&&d!="["+e+"]"},isNumber:function(d){return/^\d+(.\d+)?$/.test(i.trim(d))},verifyInputs:function(d){for(var e=0;e<d.length;e++){var k=new s(d[e]),l=i.trim(u.valInput(k)),o=k.attr("data-verify"),k=k.attr("data-warning");if(o&&!RegExp(o).test(l))return alert(k),!1}return!0},sourceDisable:function(d,e){d.on("sourceMode",e.disable,e);d.on("wysiwygMode",
e.enable,e)},resetInput:function(d){var e=d.attr("placeholder");e&&t.ie?(d.addClass("ke-input-tip"),d.val(e)):t.ie||d.val("")},valInput:function(d,e){if(void 0===e)return d.hasClass("ke-input-tip")?"":d.val();d.removeClass("ke-input-tip");d.val(e)},placeholder:function(d,e){d.attr("placeholder",e);t.ie&&(d.on("blur",function(){i.trim(d.val())||(d.addClass("ke-input-tip"),d.val(e))}),d.on("focus",function(){d.removeClass("ke-input-tip");i.trim(d.val())==e&&d.val("")}))},htmlEncode:function(d){return!d?
d:(""+d).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(d){var d=i.clone(d),e;for(e in d)if(d.hasOwnProperty(e)){var k=d[e];i.isFunction(k)&&(d[e]=k())}return d},doFormUpload:function(d,e,k){function n(){var b={responseText:"",responseXML:w};b.argument=d?d.argument:w;try{var a;if((a=t.ie?p.contentWindow.document:p.contentDocument||window.frames[o].document)&&a.body)b.responseText=i.trim(l.text(a.body));b.responseXML=a&&a.XMLDocument?a.XMLDocument:
a}catch(c){}r.remove(p,"load",n);d.callback&&d.callback(b);setTimeout(function(){l._4e_remove(p)},100)}var o=i.guid("form-upload-"),p=document.createElement("iframe");p.id=o;p.name=o;p.className="ke-hidden";var b="document.open();"+(u.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";t.ie&&(p.src=t.ie?"javascript:void(function(){"+encodeURIComponent(b)+"}())":"");document.body.appendChild(p);t.ie&&(document.frames[o].name=o);var b=d.form,c={target:l.attr(b,"target"),
method:l.attr(b,"method"),encoding:l.attr(b,"encoding"),enctype:l.attr(b,"enctype"),action:l.attr(b,"action")};l.attr(b,{target:o,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});k&&l.attr(b,"action",k);var g;if(e){g=[];var e=v.Utils.normParams(e),m;for(m in e)e.hasOwnProperty(m)&&(k=document.createElement("input"),k.type="hidden",k.name=m,k.value=e[m],b.appendChild(k),g.push(k))}r.on(p,"load",n);b.submit();l.attr(b,c);if(g){e=0;for(m=g.length;e<m;e++)l._4e_remove(g[e])}return p},
map:function(d,e){for(var i=0;i<d.length;i++)d[i]=e(d[i]);return d},ieEngine:document.documentMode||t.ie,preventFocus:function(d){t.ie?d.unselectable():d.attr("onmousedown","return false;")},injectDom:function(d){i.mix(l,d);for(var e in d)d.hasOwnProperty(e)&&function(e){s.prototype[e]=function(){var l=[].slice.call(arguments,0);l.unshift(this[0]);return(l=d[e].apply(w,l))&&(l.nodeType||i.isWindow(l))?new s(l):i.isArray(l)&&(l.__IS_NODELIST||l[0]&&l[0].nodeType)?new s(l):l}}(e)},addRes:function(){var d=
this.__res=this.__res||[];d.push.apply(d,i.makeArray(arguments))},destroyRes:function(){for(var d=this.__res||[],e=0;e<d.length;e++){var k=d[e];i.isFunction(k)?k():(k.destroy&&k.destroy(),k.remove&&k.remove())}this.__res=[]},getQueryCmd:function(d){return"query"+("-"+d).replace(/-(\w)/g,function(d,i){return i.toUpperCase()})+"Active"}};return v.Utils=u},{requires:["./base"]});
KISSY.add("editor/core/walker",function(i,v){function w(b,c){if(this._.end)return u;var a,d=this.range,e,g=this.guard,i=this.type,l=b?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,d.trim(),d.collapsed))return this.end(),u;if(!b&&!this._.guardLTR){var n=d.endContainer[0],p=n.childNodes[d.endOffset];this._.guardLTR=function(a,b){return b&&(n==a||"body"==k._4e_name(a))?!1:a!=p}}if(b&&!this._.guardRTL){var v=d.startContainer[0],s=0<d.startOffset&&v.childNodes[d.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(v==a||"body"==k._4e_name(a))?!1:a!=s}}var w=b?this._.guardRTL:this._.guardLTR;e=g?function(a,b){return w(a,b)===r?r:g(a,b)}:w;this.current?a=this.current[l](r,i,e):b?(a=d.endContainer,0<d.endOffset?(a=new o(a[0].childNodes[d.endOffset-1]),e(a)===r&&(a=u)):a=e(a,t)===r?u:a._4e_previousSourceNode(t,i,e,void 0)):(a=d.startContainer,a=new o(a[0].childNodes[d.startOffset]),a.length?e(a)===r&&(a=u):a=e(d.startContainer,t)===r?u:d.startContainer._4e_nextSourceNode(t,
i,e,void 0));for(;a&&!this._.end;){this.current=a;if(!this.evaluator||this.evaluator(a[0])!==r){if(!c)return a}else if(c&&this.evaluator)return r;a=a[l](r,i,e)}this.end();return this.current=u}function s(b){for(var c,a=u;c=w.call(this,b);)a=c;return a}function l(b){this.range=b;this._={}}var t=!0,r=!1,u=null,d=i.UA,e=v.NODE,k=i.DOM,n=v.XHTML_DTD,o=i.Node;i.augment(l,{end:function(){this._.end=1},next:function(){return w.call(this)},previous:function(){return w.call(this,t)},checkForward:function(){return w.call(this,
r,t)!==r},checkBackward:function(){return w.call(this,t,t)!==r},lastForward:function(){return s.call(this)},lastBackward:function(){return s.call(this,t)},reset:function(){delete this.current;this._={}},_iterator:w});l.blockBoundary=function(b){return function(c){return!(c.nodeType==e.NODE_ELEMENT&&k._4e_isBlockBoundary(c,b))}};l.bookmark=function(b,c){function a(a){return"span"==k._4e_name(a)&&k.attr(a,"_ke_bookmark")}return function(d){var g,i;g=d.nodeType==e.NODE_TEXT&&(i=d.parentNode)&&a(i);g=
b?g:g||a(d);return!!(c^g)}};l.whitespaces=function(b){return function(c){c=c.nodeType==e.NODE_TEXT&&!i.trim(c.nodeValue);return!!(b^c)}};l.invisible=function(b){var c=l.whitespaces();return function(a){a=c(a)||a.nodeType==e.NODE_ELEMENT&&!a.offsetHeight;return!!(b^a)}};var p=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,b=l.whitespaces(),c=l.bookmark(),g=function(d){var f=k._4e_name(d);return c(d)||b(d)||1==d.nodeType&&f in n.$inline&&!(f in n.$empty)};v.Utils.injectDom({_4e_getBogus:function(b){b=new o(b);do b=
b._4e_previousSourceNode();while(b&&g(b[0]));return b&&(!d.ie?"br"==b._4e_name():3==b[0].nodeType&&p.test(b.text()))?b[0]:!1}});return v.Walker=l},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(i){var v=i.Editor;v.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};v.baseZIndex=function(i){return(v.Config.baseZIndex||1E4)+i}},{requires:["./base"]});
KISSY.add("editor",function(i,v,w,s){function l(c,a){var d=c.body;b(function(){c.designMode="on";setTimeout(function(){c.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=t)},50)},function(){c.designMode="off";n.attr(d,"contentEditable",u);n.attr(d,"contentEditable",t);!a&&l(c,1)})}var t=!0,r=i.all,u=!1,d=document,e=i.UA,k=e.ie,n=i.DOM,o=i.Node,p=i.Event,b=w.tryThese,c="document.open();"+(w.isCustomDomain()?'document.domain="'+d.domain+'";':"")+"document.close();",g='<iframe style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(k?' src="javascript:void(function(){'+encodeURIComponent(c)+'}())"':"")+' allowTransparency="true"></iframe>';i.mix(v,{SOURCE_MODE:0,WYSIWYG_MODE:1});var m=v.WYSIWYG_MODE;i.augment(v,{createDom:function(){var b=this.get("textarea"),a;b||this.set("textarea",b=r("<textarea></textarea>"));a=this.get("el");a.addClass(this.get("prefixCls")+"editor-wrap",void 0);a.html('<div class="ke-editor-tools"></div><div class="ke-textarea-wrap"></div><div class=\'ke-editor-status\'></div>');this._UUID=i.guid();var c=
a.one(".ke-textarea-wrap");this.__set("iframeWrapEl",c);this.__set("toolBarEl",a.one(".ke-editor-tools"));this.__set("statusBarEl",a.one(".ke-editor-status"));var d=this.get("width"),e=this.get("height");a.css("width",d);b.css("width","100%");b.css("display","none");c.append(b);c.css("height",e);b.css("height",e);a.css("height","")},_uiSetHeight:function(b){this.get("iframeWrapEl").css("height",b);this.get("textarea").css("height",b)},_uiSetMode:function(b){var a=this.get("textarea");b?(this.execCommand("save"),
this._setData(a.val()),this.execCommand("save")):(a.val(this._getData(1,m)),a[0].focus());a[b?"hide":"show"]();this.get("iframe")[b?"show":"hide"]();this.fire((b?"wysiwyg":"source")+"Mode")},renderUI:function(){function b(){a.detach("docReady",b);if(a.get("focus"))a.focus();else{var c=a.getSelection();c&&c.removeAllRanges()}}var a=this,c=a.get("textarea");s.register(a);a.get("attachForm")&&c[0].form&&a._attachForm();a.on("docReady",b)},_createIframe:function(b){var a=this,c=new o(g),d=a.get("textarea");
d.hasAttr("tabindex")&&c.attr("tabIndex",e.webkit?-1:d.attr("tabIndex"));a.get("iframeWrapEl").prepend(c);a.set("iframe",c);a.__docReady=0;if(e.gecko&&!c.__loaded)c.on("load",function(){a._setUpIFrame(b)},a);else a._setUpIFrame(b)},destructor:function(){var b=this.get("el"),a=this.get("textarea"),c=this.get("document")[0],d=this.get("iframe")[0].contentWindow;this.sync();v.focusManager.remove(this);p.remove([c,c.documentElement,c.body,d]);i.each(this.__dialogs,function(a){a.destroy&&a.destroy()});
this.__commands=0;this.__editor_created_new||(a.insertBefore(b,void 0),a.css({width:this.get("width"),height:this.get("height")}),a.show())},_attachForm:function(){var b=this,a=b.get("textarea"),c=new o(a[0].form);c.on("submit",b.sync,b);b.on("destroy",function(){c.detach("submit",b.sync,b)})},addDialog:function(b,a){this.__dialogs[b]=a},showDialog:function(b,a){var c=this.__dialogs[b];c.show(a);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:b})},hasDialog:function(b){return!!this.__dialogs[b]},
addCommand:function(b,a){this.__commands[b]=a},hasCommand:function(b){return this.__commands[b]},execCommand:function(b){var a=this.__commands[b],c=i.makeArray(arguments);c.shift();c.unshift(this);if(a)return a.exec.apply(a,c)},_clearIframeDocContent:function(){if(this.get("iframe")){var b=this.get("iframe"),a=b[0].contentWindow,c=this.get("document")[0];p.remove([c,c.documentElement,c.body,a]);b.remove()}},_getData:function(b,a){var c=this.htmlDataProcessor,d;void 0==a&&(a=this.get("mode"));d=a==
m?this.get("document")[0].body.innerHTML:c.toDataFormat(this.get("textarea").val());d=b?c.toHtml(d):c.toServer(d);d=i.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(b){var a,c=b;if(this.get("mode")!=m)this.get("textarea").val(b);else{if(a=this.htmlDataProcessor)c=a.toDataFormat(b,"p");this._clearIframeDocContent();this._createIframe(c)}},sync:function(){this.get("textarea").val(this._getData())},_getRawData:function(){return this.get("document")[0].body.innerHTML},
_setRawData:function(b){this.get("document")[0].body.innerHTML=b},_prepareIFrameHtml:function(b,a){var c=this.get("customStyle"),e=this.get("customLink"),g="",i=v.Utils.debugUrl("/theme/editor-iframe.css");if(e)for(var k=0;k<e.length;k++)g+='<link href="'+e[k]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(8===d.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+i+"' rel='stylesheet'/><style>"+(c||"")+"</style>"+g+"</head><body class='ke-editor'>"+
(a||"&nbsp;")+(b?'<script id="ke_actscript" type="text/javascript">'+(w.isCustomDomain()?'document.domain="'+d.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return v.Selection.getSelection(this.get("document")[0])},focus:function(){var b=this.get("document")[0],a=n._4e_getWin(b);e.ie||a&&a.parent&&a.parent.focus();a&&a.focus();b.body.focus();this.notifySelectionChange()},blur:function(){n._4e_getWin(this.get("document")[0]).blur();
this.get("document")[0].body.blur()},addCustomStyle:function(b){var a=this.get("customStyle")||"",a=a+("\n"+b);this.set("customStyle",a);n.addStyleSheet(this.get("iframe")[0].contentWindow,a)},addCustomLink:function(b){var a=this.get("customLink")||[],c=this.get("document")[0];a.push(b);this.set("customLink",a);a=c.createElement("link");a.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(a);a.href=b},removeCustomLink:function(b){for(var a=this.get("document")[0],a=n.query("link",a),c=
0;c<a.length;c++)a[c].href==b&&n.remove(a[c]);a=this.get("customLink")||[];b=i.indexOf(b,a);-1!=b&&a.splice(b,1)},_setUpIFrame:function(b){function a(){i=g.document;c.__set("document",new o(i));c.__set("window",new o(g));d.detach();i.open("text/html","replace");i.write(e);i.close()}var c=this,d=c.get("iframe"),e=c._prepareIFrameHtml(c._UUID,b),g=d[0].contentWindow,i;d.__loaded=1;try{i=g.document}catch(l){if(d[0].src=d[0].src,7>k){setTimeout(a,10);return}}a()},docReady:function(b){this.on("docReady",
b);this.__docReady&&b.call(this)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var c=a.getStartElement(),d=new v.ElementPath(c);if(!b.__previousPath||!b.__previousPath.compare(d))b.__previousPath=d,b.fire("selectionChange",{selection:a,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this._monitor()},insertElement:function(b,a,c){var d=this;if(d.get("mode")===
m){d.focus();var e,g=b._4e_name(),i=v.XHTML_DTD,k=v.RANGE,l=v.NODE,n=i.$block[g],p=d.getSelection(),r=p&&p.getRanges(),s,w,F,E;if(!r||0==r.length){var J=arguments,N=J.callee;setTimeout(function(){N.apply(d,J)},30)}else{d.execCommand("save");for(var G=r.length-1;0<=G;G--){s=r[G];s.deleteContents();e=!G&&b||b.clone(t);a&&a(e);if(n)for(;(F=s.getCommonAncestor(u,t))&&(E=i[F._4e_name()])&&(!E||!E[g]);)F._4e_name()in i.span?s.splitElement(F):s.checkStartOfBlock()&&s.checkEndOfBlock()?(s.setStartBefore(F),
s.collapse(t),F.remove()):s.splitBlock();s.insertNode(e);w||(w=e)}w&&(g=w._4e_nextSourceNode(t),i=d.get("document")[0],E=v.XHTML_DTD,E.$inline[e._4e_name()]?(g=new o(i.createTextNode(" ")),g.insertAfter(w)):g?"br"==g._4e_name()&&E[g.parent()._4e_name()].p&&(E=new o("<p>&nbsp;</p>",null,i),g[0].parentNode.replaceChild(E[0],g[0]),g=E):(E=new o("<p>&nbsp;</p>",null,i),E.insertAfter(w),g=E),s.moveToPosition(w,k.POSITION_AFTER_END),g&&g[0].nodeType==l.NODE_ELEMENT&&s.moveToElementEditablePosition(g),p.selectRanges([s]),
d.focus(),e&&e.scrollIntoView(void 0,!1),d._saveLater(),c&&c(e))}}},insertHtml:function(b,a){var c=this,d;if(c.get("mode")===m){if(d=c.htmlDataProcessor)b=d.toDataFormat(b,null,a);c.focus();c.execCommand("save");var e=c.get("document")[0];d=0;if(k){var g=e.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(b)}catch(i){}}else try{e.execCommand("inserthtml",u,b)}catch(l){setTimeout(function(){if(0==c.getSelection().getRanges().length){var a=new v.Range(e),d=n.first(e.body,function(a){return 1==
a.nodeType&&"br"!=n._4e_name(a)});d||(d=new o(e.createElement("p")),e.body.appendChild(d[0]));a.setStartAt(d,v.RANGE.POSITION_AFTER_START);a.select()}e.execCommand("inserthtml",u,b)},d=100)}setTimeout(function(){c.getSelection().scrollIntoView()},d);c._saveLater(d)}},_saveLater:function(b){var a=this;a.__saveTimer&&(clearTimeout(a.__saveTimer),a.__saveTimer=null);a.__saveTimer=setTimeout(function(){a.execCommand("save")},b||0)},_fixByBindIframeDoc:function(){var b=this,a=b.get("iframe"),c=b.get("textarea")[0],
a=a[0].contentWindow,d=b.get("document")[0];e.webkit&&(p.on(d,"click",function(a){var b=new o(a.target);i.inArray(b._4e_name(),["input","select"])&&a.preventDefault()}),p.on(d,"mouseup",function(a){var b=new o(a.target);i.inArray(b._4e_name(),["input","textarea"])&&a.preventDefault()}));if(e.gecko||k||e.opera){var g;g=(new o('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);g.on("focus",function(){b.focus()});b.activateGecko=function(){e.gecko&&
b.__iframeFocus&&g[0].focus()};b.on("destroy",function(){g.detach();g.remove()})}p.on(a,"focus",function(){e.gecko?l(d,u):e.opera&&d.body.focus();b.notifySelectionChange()});if(e.gecko)p.on(d,"mousedown",function(){b.__iframeFocus||l(d,u)});if(k&&(p.on(d,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.fire("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.fire("save");a.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var m=
{33:1,34:1};p.on(d,"keydown",function(a){a.keyCode in m&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}if(e.webkit)p.on(d,"mousedown",function(a){a=new o(a.target);i.inArray(a._4e_name(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(a)});if(e.gecko)p.on(d,"dragstart",function(a){var b=new o(a.target);b._4e_name()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});s.add(b)}});v._initIFrame=function(b){var a=s.getInstance(b),c=a.get("document")[0],
b=c.getElementById("ke_actscript");n.remove(b);a._fixByBindIframeDoc();var d=c.body;k?(d.hideFocus=t,d.disabled=t,d.contentEditable=t,d.removeAttribute("disabled")):setTimeout(function(){e.gecko||e.opera?d.contentEditable=t:e.webkit?d.parentNode.contentEditable=t:c.designMode="on"},0);if(e.gecko||e.opera){var g=c.documentElement;p.on(g,"mousedown",function(b){if(b.target==g){e.gecko&&l(c,u);a.activateGecko()}})}setTimeout(function(){k&&setTimeout(function(){if(c){d.runtimeStyle.marginBottom="0px";
d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.__docReady=1;a.fire("docReady");var b=a.get("disableObjectResizing"),e=a.get("disableInlineTableEditing");if(b||e)try{c.execCommand("enableObjectResizing",u,!b);c.execCommand("enableInlineTableEditing",u,!e)}catch(f){p.on(d,k?"resizestart":"resize",function(a){var c=new o(a.target);(b||c._4e_name()==="table"&&e)&&a.preventDefault()})}},10)};return v},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/focusManager,editor/core/meta".split(",")});
