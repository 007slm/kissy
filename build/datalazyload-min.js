/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Apr 27 12:49
*/
KISSY.add("datalazyload",function(f,d,h,o){function p(a,b){var b=b||n,c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))}function q(a,b){for(var c=[],g=0;g<a.length;g++)f.inArray(a[g],b)||c.push(a[g]);return c}function r(a,b){a.style.display=m;a.className="";var c=d.create("<div>");a.parentNode.insertBefore(c,a);d.html(c,a.value,b)}function w(a){return d.hasClass(a,s)}function i(a,b){if(!(this instanceof i))return new i(a,b);b===o&&(b=a,a=[t]);f.isArray(a)||(a=[d.get(a)||t]);this.containers=
a;this.config=f.merge(x,b);this.callbacks={els:[],fns:[]};this._init();return o}function u(a,b){var c,g,e,d;c=Math.max(a.top,b.top);g=Math.min(a.bottom,b.bottom);e=Math.max(a.left,b.left);d=Math.min(a.right,b.right);return g>=c&&d>=e}function v(a,b){var c=f.indexOf(a,b);-1!=c&&b.splice(c,1);return c}var j=f.Env.host,t=j.document,n="data-ks-lazyload",s="ks-datalazyload",m="none",x={mod:"manual",diff:"default",placeholder:m,execScript:!0};f.augment(i,{_init:function(){this._filterItems();this._initLoadEvent()},
_filterItems:function(){var a=this.containers,b,c,g,e=[],l=[];b=0;for(c=a.length;b<c;++b)g=q(d.query("img",a[b]),e),e=e.concat(f.filter(g,this._filterImg,this)),g=q(d.query("textarea",a[b]),l),l=l.concat(f.filter(g,w,this));this.images=e;this.areaes=l},_filterImg:function(a){var b=a.getAttribute(n),c=this.config.placeholder;if("manual"===this.config.mod){if(b)return c!==m&&(a.src=c),!0}else if(!b&&!this.checkElemInViewport(a))return d.attr(a,n,a.src),c!==m?a.src=c:a.removeAttribute("src"),!0},_initLoadEvent:function(){var a=
this,b=function(){a._loadItems();0===a._getItemsLength()&&a.destroy()},c=f.buffer(b,100,this);h.on(j,"scroll",c);h.on(j,"touchmove",c);h.on(j,"resize",c);f.each(a.containers,function(a){9!=a.nodeType&&(h.on(a,"scroll",c),h.on(a,"touchmove",c))});a.load=c;a._getItemsLength()&&f.ready(b)},_loadItems:function(){this._loadImgs();this._loadAreas();this._fireCallbacks()},_loadImgs:function(){this.images=f.filter(this.images,this._loadImg,this)},_loadImg:function(a){if(this.checkElemInViewport(a))p(a);else return!0},
_loadAreas:function(){this.areaes=f.filter(this.areaes,this._loadArea,this)},_loadArea:function(a){if(this.checkElemInViewport(a))r(a,this.config.execScript);else return!0},_fireCallbacks:function(){var a=this.callbacks,b=a.els,c=a.fns,g,e,d,f=[],k=[];for(g=0;(e=b[g])&&(d=c[g++]);)this.checkElemInViewport(e)?d.call(e):(f.push(e),k.push(d));a.els=f;a.fns=k},addCallback:function(a,b){var c=this.callbacks;if((a=d.get(a))&&f.isFunction(b))c.els.push(a),c.fns.push(b);this._fireCallbacks()},removeElements:function(a){if(f.isArray(a))f.each(a,
function(a){this.removeElements(a)});else{for(var b=this.callbacks,c=b.fns,d=b.els,e=[],l=[],h=0;h<d.length;h++)d[h]!=a&&(e.push(d[h]),l.push(c[h]));b.els=e;b.fns=l;v(a,this.images);v(a,this.areaes)}},_getThreshold:function(a){var b=this.config.diff,c=b,g=b,e;a!==o?(e=d.outerHeight(a),a=d.outerWidth(a)):(e=d.viewportHeight(),a=d.viewportWidth());f.isArray(b)&&(c=b[0],g=b[1]);return{left:"default"===c?2*a:a+ +c,top:"default"===g?2*e:e+ +g}},_getItemsLength:function(){return this.images.length+this.areaes.length+
this.callbacks.els.length},loadCustomLazyData:function(a,b,c){var g;"img-src"===b&&(b="img");f.isArray(a)||(a=[d.get(a)]);f.each(a,function(a){switch(b){case "img":g="IMG"===a.nodeName?[a]:d.query("img",a);f.each(g,function(a){p(a,c||n+"-custom")});break;default:d.query("textarea",a).each(function(a){d.hasClass(a,c||s+"-custom")&&r(a,!0)})}})},checkElemInViewport:function(a){var a=d.css(a,"display")===m?a.parentNode:a,b=this._getThreshold(),c=d.scrollTop(),g=d.scrollLeft(),e=d.offset(a),f=e.left,
h=e.top,e=!0,k;a:{k=a;for(var j=this.containers,i=0;i<j.length;i++)if(9!=j[i].nodeType&&j[i].contains(k)){k=j[i];break a}k=0}a={left:f,top:h,right:f+d.outerWidth(a),bottom:h+d.outerHeight(a)};b={top:c,left:g,bottom:c+b.top,right:g+b.left};k&&(e=this._getThreshold(k),c=d.offset(k),e=u({left:c.left,right:e.left,top:c.top,bottom:e.top},a));b=u(b,a);return e&&b},destroy:function(){var a=this.load;h.remove(j,"scroll",a);h.remove(j,"touchmove",a);h.remove(j,"resize",a);f.each(this.containers,function(b){9!=
b.nodeType&&(h.remove(b,"scroll",a),h.remove(b,"touchmove",a))});this.callbacks.els=[];this.callbacks.fns=[];this.images=[];this.areaes=[]}});i.loadCustomLazyData=i.prototype.loadCustomLazyData;return i},{requires:["dom","event"]});
