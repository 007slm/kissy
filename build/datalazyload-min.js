/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Apr 23 11:52
*/
KISSY.add("datalazyload",function(f,e,i,l){function j(a,b){if(!(this instanceof j))return new j(a,b);b===l&&(b=a,a=[n]);f.isArray(a)||(a=[e.get(a)||n]);this.containers=a;this.config=f.merge(p,b);this.callbacks={els:[],fns:[]};this._init();return l}function o(a,b){var c=f.indexOf(a,b);-1!=c&&b.splice(c,1);return c}var g=f.Env.host,n=g.document,p={mod:"manual",diff:"default",placeholder:"none",execScript:!0};f.augment(j,{_init:function(){this.threshold=this._getThreshold();this._filterItems();this._initLoadEvent()},
_filterItems:function(){var a=this.containers,b,c,d,m=[],k=[];b=0;for(c=a.length;b<c;++b)d=e.query("img",a[b]),m=m.concat(f.filter(d,this._filterImg,this)),d=e.query("textarea",a[b]),k=k.concat(f.filter(d,this._filterArea,this));this.images=m;this.areaes=k},_filterImg:function(a){var b=a.getAttribute("data-ks-lazyload"),c=this.threshold,d=this.config.placeholder;if("manual"===this.config.mod){if(b)return"none"!==d&&(a.src=d),!0}else if(e.offset(a).top>c&&!b)return e.attr(a,"data-ks-lazyload",a.src),
"none"!==d?a.src=d:a.removeAttribute("src"),!0},_filterArea:function(a){return e.hasClass(a,"ks-datalazyload")},_initLoadEvent:function(){var a=this,b,c=function(){a._loadItems();0===a._getItemsLength()&&(i.remove(g,"scroll",d),i.remove(g,"touchmove",d),i.remove(g,"resize",b))},d=f.buffer(c,100,this);i.on(g,"scroll",d);i.on(g,"touchmove",d);i.on(g,"resize",b=function(){a.threshold=a._getThreshold();d()});a._getItemsLength()&&f.ready(c)},_loadItems:function(){this._loadImgs();this._loadAreas();this._fireCallbacks()},
_loadImgs:function(){this.images=f.filter(this.images,this._loadImg,this)},_loadImg:function(a){if(this.checkElemInViewport(a))this._loadImgSrc(a);else return!0},_loadImgSrc:function(a,b){var b=b||"data-ks-lazyload",c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))},_loadAreas:function(){this.areaes=f.filter(this.areaes,this._loadArea,this)},_loadArea:function(a){if(this.checkElemInViewport(a))this._loadAreaData(a,this.config.execScript);else return!0},_loadAreaData:function(a,b){a.style.display=
"none";a.className="";var c=e.create("<div>");a.parentNode.insertBefore(c,a);e.html(c,a.value,b===l?!0:b)},_fireCallbacks:function(){var a=this.callbacks,b=a.els,c=a.fns,d,f,e,h=[],g=[];for(d=0;(f=b[d])&&(e=c[d++]);)this.checkElemInViewport(f)?e.call(f):(h.push(f),g.push(e));a.els=h;a.fns=g},addCallback:function(a,b){var c=this.callbacks;if((a=e.get(a))&&f.isFunction(b))c.els.push(a),c.fns.push(b);this._fireCallbacks()},removeElements:function(a){if(f.isArray(a))f.each(a,function(a){this.removeElements(a)});
else{for(var b=this.callbacks,c=b.fns,d=b.els,e=[],k=[],h=0;h<d.length;h++)d[h]!=a&&(e.push(d[h]),k.push(c[h]));b.els=e;b.fns=k;o(a,this.images);o(a,this.areaes)}},destroy:function(){this.callbacks.els=[];this.callbacks.fns=[];this.images=[];this.areaes=[]},_getThreshold:function(){var a=this.config.diff,b=e.viewportHeight();return"default"===a?2*b:b+ +a},_getItemsLength:function(){return this.images.length+this.areaes.length+this.callbacks.els.length},loadCustomLazyData:function(a,b,c){var d=this,
g;"img-src"===b&&(b="img");f.isArray(a)||(a=[e.get(a)]);f.each(a,function(a){switch(b){case "img":g="IMG"===a.nodeName?[a]:e.query("img",a);f.each(g,function(a){d._loadImgSrc(a,c||"data-ks-lazyload-custom")});break;default:e.query("textarea",a).each(function(a){e.hasClass(a,c||"ks-datalazyload-custom")&&d._loadAreaData(a)})}})},checkElemInViewport:function(a){var b="none"===e.css(a,"display"),c=e.scrollTop(),a=e.offset(b?a.parentNode:a).top;return a<this.threshold+c&&a>c}});f.mix(j,j.prototype,!0,
["loadCustomLazyData","_loadImgSrc","_loadAreaData"]);return j},{requires:["dom","event"]});
