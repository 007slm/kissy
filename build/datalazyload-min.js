/*
Copyright 2013, KISSY UI Library v1.30
MIT Licensed
build time: Jan 7 17:34
*/
KISSY.add("datalazyload",function(e,d,f,q,l){function m(a,b){a.style.display=r;a.className="";var c=d.create("<div>");a.parentNode.insertBefore(c,a);d.html(c,a.value,b)}function n(a,b){var c,g;if(!(c=a.id))c=a.id=e.guid("ks-lazyload");if(!(g=b.ksLazyloadId))g=b.ksLazyloadId=e.guid("ks-lazyload");return c+g}function i(a,b){if(!(this instanceof i))return new i(a,b);var c=a;e.isPlainObject(c)||(c=b||{},a&&(c.container=a));i.superclass.constructor.call(this,c);this._callbacks={};this._containerIsNotDocument=
9!=this.get("container").nodeType;this._filterItems();this._initLoadEvent()}function o(a,b){var c,g,h,d;c=Math.max(a.top,b.top);g=Math.min(a.bottom,b.bottom);h=Math.max(a.left,b.left);d=Math.min(a.right,b.right);return g>=c&&d>=h}var j=e.Env.host,k=j.document,r="none",p=function(a,b){var b=b||"data-ks-lazyload",c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))};i.ATTRS={diff:{value:"default"},placeholder:{value:"http://a.tbcdn.cn/kissy/1.0.0/build/imglazyload/spaceball.gif"},execScript:{value:!0},
container:{setter:function(a){a=a||k;e.isWindow(a)?a=a.document:(a=d.get(a),"body"==d.nodeName(a)&&(a=a.ownerDocument));return a},valueFn:function(){return k}},autoDestroy:{value:!0}};e.extend(i,q,{_filterItems:function(){var a=this.get("container");this._images=e.filter(d.query("img",a),this._filterImg,this);this._textareas=d.query("textarea.ks-datalazyload",a)},_filterImg:function(a){var b=this.get("placeholder");return a.getAttribute("data-ks-lazyload")?(a.src||(a.src=b),!0):l},_initLoadEvent:function(){var a=
this,b=a.get("autoDestroy"),c=function(){a._loadItems();b&&a._isLoadAllLazyElements()&&a.destroy()};a._loadFn=e.buffer(c,100,a);a.resume();a._isLoadAllLazyElements()||e.ready(c)},refresh:function(){this._loadFn()},_loadItems:function(){this._loadImgs();this._loadTextAreas();this._fireCallbacks()},_loadImgs:function(){this._images=e.filter(this._images,this._loadImg,this)},_loadImg:function(a){if(this._elementInViewport(a))p(a);else return!0;return l},_loadTextAreas:function(){this._textareas=e.filter(this._textareas,
this._loadTextArea,this)},_loadTextArea:function(a){if(this._elementInViewport(a))m(a,this.get("execScript"));else return!0;return l},_fireCallbacks:function(){var a=this,b=a._callbacks;e.each(b,function(c,g){var d=c.el,e=!1,f=c.fn;a._elementInViewport(d)&&(e=f.call(d));!1!==e&&delete b[g]})},addCallback:function(a,b){var c=this._callbacks,a=d.get(a);c[n(a,b)]={el:d.get(a),fn:b};this._loadFn()},removeCallback:function(a,b){var c=this._callbacks,a=d.get(a);delete c[n(a,b)]},getElements:function(){return{images:this._images,
textareas:this._textareas}},addElements:function(a){"string"==typeof a?a=d.query(a):e.isArray(a)||(a=[a]);var b=this._images||[],c=this._textareas||[];e.each(a,function(a){var d=a.nodeName.toLowerCase();"img"==d?e.inArray(a,b)||b.push(a):"textarea"==d&&(e.inArray(a,c)||c.push(a))});this._images=b;this._textareas=c},removeElements:function(a){"string"==typeof a?a=d.query(a):e.isArray(a)||(a=[a]);var b=[],c=[];e.each(this._images,function(c){e.inArray(c,a)||b.push(c)});e.each(this._textareas,function(b){e.inArray(b,
a)||c.push(b)});this._images=b;this._textareas=c},_getBoundingRect:function(a){var b,c,g;a!==l?(b=d.outerHeight(a),c=d.outerWidth(a),g=d.offset(a),a=g.left,g=g.top):(b=d.viewportHeight(),c=d.viewportWidth(),a=d.scrollLeft(),g=d.scrollTop());var h=this.get("diff"),f=0,i="default"===h?c:h,j=0,k="default"===h?b:h;c=a+c;b=g+b;e.isObject(h)&&(f=h.left||0,i=h.right||0,j=h.top||0,k=h.bottom||0);return{left:a-f,top:g-j,right:c+i,bottom:b+k}},_isLoadAllLazyElements:function(){return 0==this._images.length+
this._textareas.length+(e.isEmptyObject(this._callbacks)?0:1)},_elementInViewport:function(a){if(!d.contains(k,a)||!a.offsetWidth)return!1;var b=d.offset(a),c=!0,e=this.get("container"),h=this._getBoundingRect(),f=b.left,b=b.top,a={left:f,top:b,right:f+d.outerWidth(a),bottom:b+d.outerHeight(a)};if((h=o(h,a))&&this._containerIsNotDocument)c=this._getBoundingRect(e),c=o(c,a);return c&&h},pause:function(){var a=this._loadFn;if(!this._destroyed&&(f.remove(j,"scroll",a),f.remove(j,"touchmove",a),f.remove(j,
"resize",a),a.stop(),this._containerIsNotDocument)){var b=this.get("container");f.remove(b,"scroll",a);f.remove(b,"touchmove",a)}},resume:function(){var a=this._loadFn;if(!this._destroyed&&(f.on(j,"scroll",a),f.on(j,"touchmove",a),f.on(j,"resize",a),this._containerIsNotDocument)){var b=this.get("container");f.on(b,"scroll",a);f.on(b,"touchmove",a)}},destroy:function(){this.pause();this._callbacks={};this._images=[];this._textareas=[];this.fire("destroy");this._destroyed=1}});i.loadCustomLazyData=
function(a,b,c){"img-src"===b&&(b="img");var a=d.get(a),e=c||"data-ks-lazyload-custom",c=c||"ks-datalazyload-custom";"img"==b?d.query("img",a).each(function(a){p(a,e)}):d.query("textarea."+c,a).each(function(a){m(a,!0)})};return e.DataLazyload=i},{requires:["dom","event","base"]});
