/*
Copyright 2013, KISSY UI Library v1.30
MIT Licensed
build time: Jan 7 18:10
*/
KISSY.add("datalazyload",function(d,e,h,q,l){function k(a,b){a.style.display=r;a.className="";var c=e.create("<div>");a.parentNode.insertBefore(c,a);e.html(c,a.value,b)}function m(a,b){var c,f;if(!(c=a.id))c=a.id=d.guid("ks-lazyload");if(!(f=b.ksLazyloadId))f=b.ksLazyloadId=d.guid("ks-lazyload");return c+f}function i(a,b){if(!(this instanceof i))return new i(a,b);var c=a;d.isPlainObject(c)||(c=b||{},a&&(c.container=a));i.superclass.constructor.call(this,c);this._callbacks={};this._containerIsNotDocument=
9!=this.get("container").nodeType;this._filterItems();this._initLoadEvent()}function n(a,b){var c,f,d,e;c=Math.max(a.top,b.top);f=Math.min(a.bottom,b.bottom);d=Math.max(a.left,b.left);e=Math.min(a.right,b.right);return f>=c&&e>=d}var j=d.Env.host,o=j.document,r="none",p=function(a,b){var b=b||"data-ks-lazyload",c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))};i.ATTRS={diff:{value:"default"},placeholder:{value:"http://a.tbcdn.cn/kissy/1.0.0/build/imglazyload/spaceball.gif"},execScript:{value:!0},
container:{setter:function(a){a=a||o;d.isWindow(a)?a=a.document:(a=e.get(a),"body"==e.nodeName(a)&&(a=a.ownerDocument));return a},valueFn:function(){return o}},autoDestroy:{value:!0}};d.extend(i,q,{_filterItems:function(){var a=this,b=a.userConfig,c=[],f=[],g=[a.get("container")];d.isArray(b.container)&&(a._backCompact=1,g=b.container);d.each(g,function(b){c=c.concat(d.filter(e.query("img",b),a._filterImg,a));f=f.concat(e.query("textarea.ks-datalazyload",b))});a._images=c;a._textareas=f},_filterImg:function(a){var b=
this.get("placeholder");return a.getAttribute("data-ks-lazyload")?(a.src||(a.src=b),!0):l},_initLoadEvent:function(){var a=this,b=a.get("autoDestroy"),c=function(){a._loadItems();b&&a._isLoadAllLazyElements()&&a.destroy()};a._loadFn=d.buffer(c,100,a);a.resume();a._isLoadAllLazyElements()||d.ready(c)},refresh:function(){this._loadFn()},_loadItems:function(){this._loadImgs();this._loadTextAreas();this._fireCallbacks()},_loadImgs:function(){this._images=d.filter(this._images,this._loadImg,this)},_loadImg:function(a){if(this._elementInViewport(a))p(a);
else return!0;return l},_loadTextAreas:function(){this._textareas=d.filter(this._textareas,this._loadTextArea,this)},_loadTextArea:function(a){if(this._elementInViewport(a))k(a,this.get("execScript"));else return!0;return l},_fireCallbacks:function(){var a=this,b=a._callbacks;d.each(b,function(c,f){var d=c.el,e=!1,h=c.fn;a._elementInViewport(d)&&(e=h.call(d));!1!==e&&delete b[f]})},addCallback:function(a,b){var c=this._callbacks,a=e.get(a);c[m(a,b)]={el:e.get(a),fn:b};this._loadFn()},removeCallback:function(a,
b){var c=this._callbacks,a=e.get(a);delete c[m(a,b)]},getElements:function(){return{images:this._images,textareas:this._textareas}},addElements:function(a){"string"==typeof a?a=e.query(a):d.isArray(a)||(a=[a]);var b=this._images||[],c=this._textareas||[];d.each(a,function(a){var e=a.nodeName.toLowerCase();"img"==e?d.inArray(a,b)||b.push(a):"textarea"==e&&(d.inArray(a,c)||c.push(a))});this._images=b;this._textareas=c},removeElements:function(a){"string"==typeof a?a=e.query(a):d.isArray(a)||(a=[a]);
var b=[],c=[];d.each(this._images,function(c){d.inArray(c,a)||b.push(c)});d.each(this._textareas,function(b){d.inArray(b,a)||c.push(b)});this._images=b;this._textareas=c},_getBoundingRect:function(a){var b,c,f;a!==l?(b=e.outerHeight(a),c=e.outerWidth(a),f=e.offset(a),a=f.left,f=f.top):(b=e.viewportHeight(),c=e.viewportWidth(),a=e.scrollLeft(),f=e.scrollTop());var g=this.get("diff"),h=0,i="default"===g?c:g,j=0,k="default"===g?b:g;c=a+c;b=f+b;d.isObject(g)&&(h=g.left||0,i=g.right||0,j=g.top||0,k=g.bottom||
0);return{left:a-h,top:f-j,right:c+i,bottom:b+k}},_isLoadAllLazyElements:function(){return 0==this._images.length+this._textareas.length+(d.isEmptyObject(this._callbacks)?0:1)},_elementInViewport:function(a){if(!a.offsetWidth)return!1;var b=e.offset(a),c=!0,d=this.get("container"),g=this._getBoundingRect(),h=b.left,b=b.top,a={left:h,top:b,right:h+e.outerWidth(a),bottom:b+e.outerHeight(a)},g=n(g,a);!this._backCompact&&g&&this._containerIsNotDocument&&(c=this._getBoundingRect(d),c=n(c,a));return c&&
g},pause:function(){var a=this._loadFn;if(!this._destroyed&&(h.remove(j,"scroll",a),h.remove(j,"touchmove",a),h.remove(j,"resize",a),a.stop(),this._containerIsNotDocument)){var b=this.get("container");h.remove(b,"scroll",a);h.remove(b,"touchmove",a)}},resume:function(){var a=this._loadFn;if(!this._destroyed&&(h.on(j,"scroll",a),h.on(j,"touchmove",a),h.on(j,"resize",a),this._containerIsNotDocument)){var b=this.get("container");h.on(b,"scroll",a);h.on(b,"touchmove",a)}},destroy:function(){this.pause();
this._callbacks={};this._images=[];this._textareas=[];this.fire("destroy");this._destroyed=1}});i.loadCustomLazyData=function(a,b,c){"img-src"===b&&(b="img");d.isArray(a)||(a=[e.get(a)]);var f=c||"data-ks-lazyload-custom",g=c||"ks-datalazyload-custom";d.each(a,function(a){"img"==b?e.query("img",a).each(function(a){p(a,f)}):e.query("textarea."+g,a).each(function(a){k(a,!0)})})};return d.DataLazyload=i},{requires:["dom","event","base"]});
