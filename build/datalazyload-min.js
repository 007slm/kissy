/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Apr 25 15:53
*/
KISSY.add("datalazyload",function(d,e,g,o){function p(a,b){var b=b||m,c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))}function q(a,b){for(var c=[],f=0;f<a.length;f++)d.inArray(a[f],b)||c.push(a[f]);return c}function r(a,b){a.style.display=k;a.className="";var c=e.create("<div>");a.parentNode.insertBefore(c,a);e.html(c,a.value,b)}function v(a){return e.hasClass(a,s)}function j(a,b){if(!(this instanceof j))return new j(a,b);b===o&&(b=a,a=[t]);d.isArray(a)||(a=[e.get(a)||t]);this.containers=
a;this.config=d.merge(w,b);this.callbacks={els:[],fns:[]};this._init();return o}function u(a,b){var c=d.indexOf(a,b);-1!=c&&b.splice(c,1);return c}var i=d.Env.host,t=i.document,m="data-ks-lazyload",s="ks-datalazyload",k="none",w={mod:"manual",diff:"default",placeholder:k,execScript:!0};d.augment(j,{_init:function(){this._filterItems();this._initLoadEvent()},_filterItems:function(){var a=this.containers,b,c,f,h=[],n=[];b=0;for(c=a.length;b<c;++b)f=q(e.query("img",a[b]),h),h=h.concat(d.filter(f,this._filterImg,
this)),f=q(e.query("textarea",a[b]),n),n=n.concat(d.filter(f,v,this));this.images=h;this.areaes=n},_filterImg:function(a){var b=a.getAttribute(m),c=this.config.placeholder;if("manual"===this.config.mod){if(b)return c!==k&&(a.src=c),!0}else if(!b&&!this.checkElemInViewport(a))return e.attr(a,m,a.src),c!==k?a.src=c:a.removeAttribute("src"),!0},_initLoadEvent:function(){var a=this,b=function(){a._loadItems();0===a._getItemsLength()&&a.destroy()},c=d.buffer(b,100,this);g.on(i,"scroll",c);g.on(i,"touchmove",
c);g.on(i,"resize",c);d.each(a.containers,function(a){9!=a.nodeType&&(g.on(a,"scroll",c),g.on(a,"touchmove",c))});a.load=c;a._getItemsLength()&&d.ready(b)},_loadItems:function(){this._loadImgs();this._loadAreas();this._fireCallbacks()},_loadImgs:function(){this.images=d.filter(this.images,this._loadImg,this)},_loadImg:function(a){if(this.checkElemInViewport(a))p(a);else return!0},_loadAreas:function(){this.areaes=d.filter(this.areaes,this._loadArea,this)},_loadArea:function(a){if(this.checkElemInViewport(a))r(a,
this.config.execScript);else return!0},_fireCallbacks:function(){var a=this.callbacks,b=a.els,c=a.fns,f,h,d,e=[],g=[];for(f=0;(h=b[f])&&(d=c[f++]);)this.checkElemInViewport(h)?d.call(h):(e.push(h),g.push(d));a.els=e;a.fns=g},addCallback:function(a,b){var c=this.callbacks;if((a=e.get(a))&&d.isFunction(b))c.els.push(a),c.fns.push(b);this._fireCallbacks()},removeElements:function(a){if(d.isArray(a))d.each(a,function(a){this.removeElements(a)});else{for(var b=this.callbacks,c=b.fns,f=b.els,h=[],e=[],
g=0;g<f.length;g++)f[g]!=a&&(h.push(f[g]),e.push(c[g]));b.els=h;b.fns=e;u(a,this.images);u(a,this.areaes)}},_getThreshold:function(a){var b=this.config.diff,c=b,f=b,h;a!==o?(h=e.height(a),a=e.width(a)):(h=e.viewportHeight(),a=e.viewportWidth());d.isArray(b)&&(c=b[0],f=b[1]);return{left:"default"===c?2*a:a+ +c,top:"default"===f?2*h:h+ +f}},_getItemsLength:function(){return this.images.length+this.areaes.length+this.callbacks.els.length},loadCustomLazyData:function(a,b,c){var f;"img-src"===b&&(b="img");
d.isArray(a)||(a=[e.get(a)]);d.each(a,function(a){switch(b){case "img":f="IMG"===a.nodeName?[a]:e.query("img",a);d.each(f,function(a){p(a,c||m+"-custom")});break;default:e.query("textarea",a).each(function(a){e.hasClass(a,c||s+"-custom")&&r(a,!0)})}})},checkElemInViewport:function(a){var a=e.css(a,"display")===k?a.parentNode:a,b=this._getThreshold(),c=e.scrollTop(),f=e.scrollLeft(),d=e.offset(a),g=d.left,d=d.top,i=!0;a:{for(var j=this.containers,l=0;l<j.length;l++)if(9!=j[l].nodeType&&j[l].contains(a)){a=
j[l];break a}a=0}a&&(i=this._getThreshold(a),a=e.offset(a),i=d<i.top+a.top&&d>=a.top&&g<i.left+a.left&&g>=a.left);return i&&d<b.top+c&&d>=c&&g<b.left+f&&g>=f},destroy:function(){var a=this.load;g.remove(i,"scroll",a);g.remove(i,"touchmove",a);g.remove(i,"resize",a);d.each(this.containers,function(b){9!=b.nodeType&&(g.remove(b,"scroll",a),g.remove(b,"touchmove",a))});this.callbacks.els=[];this.callbacks.fns=[];this.images=[];this.areaes=[]}});j.loadCustomLazyData=j.prototype.loadCustomLazyData;return j},
{requires:["dom","event"]});
