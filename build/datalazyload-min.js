/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jan 4 19:43
*/
KISSY.add("datalazyload",function(f,g,h,s,m){function n(a,b){for(var c=[],d=0;d<a.length;d++)f.inArray(a[d],b)||c.push(a[d]);return c}function o(a,b){a.style.display=t;a.className="";var c=g.create("<div>");a.parentNode.insertBefore(c,a);g.html(c,a.value,b)}function u(a){return g.hasClass(a,p)}function i(a,b){if(!(this instanceof i))return new i(a,b);b===m&&(b=a,a=[j]);f.isArray(a)||(a=[g.get(a)||j]);b=b||{};b.containers=a;i.superclass.constructor.call(this,b);this._callbacks=[];this._init()}function q(a,
b){var c,d,e,g;c=Math.max(a.top,b.top);d=Math.min(a.bottom,b.bottom);e=Math.max(a.left,b.left);g=Math.min(a.right,b.right);return d>=c&&g>=e}var l=f.Env.host,j=l.document,p="ks-datalazyload",t="none",r=function(a,b){var b=b||"data-ks-lazyload",c=a.getAttribute(b);c&&a.src!=c&&(a.src=c,a.removeAttribute(b))};i.ATTRS={mod:{value:"manual"},diff:{value:"default"},placeholder:{},execScript:{value:!0},containers:{valueFn:function(){return[j]}},autoDestroy:{value:!0}};f.extend(i,s,{_init:function(){this._filterItems();
this._initLoadEvent()},_filterItems:function(){var a=this.get("containers"),b,c,d,e=[],k=[];b=0;for(c=a.length;b<c;++b)d=n(g.query("img",a[b]),e),e=e.concat(f.filter(d,this._filterImg,this)),d=n(g.query("textarea",a[b]),k),k=k.concat(f.filter(d,u,this));this._images=e;this._areaes=k},_filterImg:function(a){var b=a.getAttribute("data-ks-lazyload"),c=this.get("placeholder");if("manual"===this.get("mod")){if(b)return c&&(a.src=c),!0}else if(!b&&!this._checkElemInViewport(a))return g.attr(a,"data-ks-lazyload",
a.src),c?a.src=c:a.removeAttribute("src"),!0;return m},_initLoadEvent:function(){var a=this,b=a.get("autoDestroy"),c=function(){a._loadItems();b&&0===a._getItemsLength()&&a.destroy()};a._loadFn=f.buffer(c,100,this);a.resume();a._getItemsLength()&&f.ready(c)},refresh:function(){this._loadFn()},_loadItems:function(){this._loadImgs();this._loadAreas();this._fireCallbacks()},_loadImgs:function(){this._images=f.filter(this._images,this._loadImg,this)},_loadImg:function(a){if(g.contains(j,a))if(this._checkElemInViewport(a))r(a);
else return!0;return m},_loadAreas:function(){this._areaes=f.filter(this._areaes,this._loadArea,this)},_loadArea:function(a){if(g.contains(j,a))if(this._checkElemInViewport(a))o(a,this.get("execScript"));else return!0;return m},_fireCallbacks:function(){var a=this,b=a._callbacks,c=[];a._callbacks=[];f.each(b,function(b){var e=b.el,f=!1,b=b.fn;g.contains(j,e)&&a._checkElemInViewport(e)&&(f=b.call(e));!1===f&&c.push({el:e,fn:b})});a._callbacks=a._callbacks.concat(c)},addCallback:function(a,b){this._callbacks.push({el:g.get(a),
fn:b});this._loadFn()},removeCallback:function(a,b){var c=this._callbacks,d,e,a=g.get(a);for(d=c.length-1;0<=d;d--)e=c[d],e.el==a&&e.fn==b&&c.splice(d,1)},getElements:function(){return{images:this._images,textareas:this._areaes}},addElements:function(a){"string"==typeof a?a=g.query(a):f.isArray(a)||(a=[a]);var b=this._images||[],c=this._areaes||[];f.each(a,function(a){var e=a.nodeName.toLowerCase();"img"==e?f.inArray(a,b)||b.push(a):"textarea"==e&&(f.inArray(a,c)||c.push(a))});this._images=b;this._areaes=
c},removeElements:function(a){"string"==typeof a?a=g.query(a):f.isArray(a)||(a=[a]);var b=[],c=[];f.each(this._images,function(c){f.inArray(c,a)||b.push(c)});f.each(this._areaes,function(b){f.inArray(b,a)||c.push(b)});this._images=b;this._areaes=c},_getBoundingRect:function(a){var b,c,d;a!==m&&!f.isWindow(a)&&9!=a.nodeType?(b=g.outerHeight(a),c=g.outerWidth(a),d=g.offset(a),a=d.left,d=d.top):(b=g.viewportHeight(),c=g.viewportWidth(),a=g.scrollLeft(),d=g.scrollTop());var e=this.get("diff"),k=0,h="default"===
e?c:e,i=0,j="default"===e?b:e;c=a+c;b=d+b;f.isObject(e)&&(k=e.left||0,h=e.right||0,i=e.top||0,j=e.bottom||0);return{left:a-k,top:d-i,right:c+h,bottom:b+j}},_getItemsLength:function(){return this._images.length+this._areaes.length+this._callbacks.length},_checkElemInViewport:function(a){if(!g.contains(j,a))return!1;var b=g.offset(a),c=!0,d;a:{var e=this.get("containers");for(d=0;d<e.length;d++)if(9!=e[d].nodeType&&e[d].contains(a)){d=e[d];break a}d=0}var e=this._getBoundingRect(),f=b.left,b=b.top,
a={left:f,top:b,right:f+g.outerWidth(a),bottom:b+g.outerHeight(a)};d&&(c=this._getBoundingRect(d),c=q(c,a));a=q(e,a);return c&&a},pause:function(){var a=this._loadFn;h.remove(l,"scroll",a);h.remove(l,"touchmove",a);h.remove(l,"resize",a);a.stop();f.each(this.get("containers"),function(b){9!=b.nodeType&&(h.remove(b,"scroll",a),h.remove(b,"touchmove",a))})},resume:function(){var a=this._loadFn;h.on(l,"scroll",a);h.on(l,"touchmove",a);h.on(l,"resize",a);f.each(this.get("containers"),function(b){9!=b.nodeType&&
(h.on(b,"scroll",a),h.on(b,"touchmove",a))})},destroy:function(){this.pause();this._callbacks=[];this._images=[];this._areaes=[];this.fire("destroy")}});i.loadCustomLazyData=function(a,b,c){var d;"img-src"===b&&(b="img");f.isArray(a)||(a=[g.get(a)]);f.each(a,function(a){switch(b){case "img":d="IMG"===a.nodeName?[a]:g.query("img",a);f.each(d,function(a){r(a,c||"data-ks-lazyload-custom")});break;default:g.query("textarea",a).each(function(a){g.hasClass(a,c||p+"-custom")&&o(a,!0)})}})};return f.DataLazyload=
i},{requires:["dom","event","base"]});
