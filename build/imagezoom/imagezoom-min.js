/*
Copyright 2010, KISSY UI Library v1.1.0pre
MIT Licensed
build time: ${build.time}
*/
KISSY.add("imagezoom",function(j){function m(a,c){var b=this;if(!(b instanceof m))return new m(a,c);b.image=typeof a==="string"?j.get(a):a;if(b.image){b.origin=null;b.viewer=null;b.bigImage=null;b.config=j.merge(q,c);b.glass=null;b.zoomIcon=null;b.imageReady=false;b.bigImageReady=false;b.timer=null;b.image.onload=function(){if(!b.imageReady){b.imageReady=!b.imageReady;b._init()}};if(!b.imageReady&&b.image.complete&&b.getSize(b.image).height){b.imageReady=!b.imageReady;b._init()}}}var d=j.DOM,n=j.Event,
p=["top","right","bottom","left"],l=["default","glass","follow"],q={type:"default",bigImageSrc:"",bigImageSize:{height:900,width:900},position:"right",offset:10,preload:true,timeout:6E3,glassSize:{height:100,width:100},zoomIcon:true};j.augment(m,{_init:function(){var a=this,c=a.image;a._initContainer();var b=a.config,g=a.glass,e=a.zoomIcon;if(b.bigImageSrc){if(b.preload)(new Image).src=b.bigImageSrc}else b.bigImageSrc=d.attr(c,"src");n.on(a.origin,"mouseenter",function(f){g&&d.removeClass(g,"hidden");
e&&d.addClass(e,"hidden");if(a.viewer)d.removeClass(a.viewer,"hidden");else{a._createZoom(f);a.fire("firstHover")}a.timer=setTimeout(function(){a.bigImageReady||a.showMsg()},a.config.timeout)});n.on(a.origin,"mouseleave",function(){g&&d.addClass(g,"hidden");e&&d.removeClass(e,"hidden");a.viewer&&d.addClass(a.viewer,"hidden");a.timer&&clearTimeout(a.timer)});n.on(a,"firstHover",function(){})},_initContainer:function(){var a=this.config,c,b=this.image;if(d.parent(b).nodeName.toLowerCase()==="a")b=d.parent(b);
c=d.create("<div>");d.addClass(c,"ks-imagezoom-magnifier");d.parent(b).insertBefore(c,b);c.appendChild(b);this.origin=c;if(l[1]==a.type){b=d.create("<div>");d.addClass(b,"ks-imagezoom-glass");d.addClass(b,"hidden");d.css(b,"height",a.glassSize.height+"px");d.css(b,"width",a.glassSize.width+"px");c.appendChild(b);this.glass=b}if(a.zoomIcon){a=d.create("<div>");d.addClass(a,"ks-imagezoom-icon");c.appendChild(a);this.zoomIcon=a}},_createZoom:function(a){var c=this,b=c.config,g;g=d.create("<div>");d.addClass(g,
"ks-imagezoom-viewer");d.addClass(g,"ks-imagezoom-viewer-bk");var e=d.create("<img>");d.attr(e,"src",b.bigImageSrc);g.appendChild(e);l[2]==b.type?c.origin.appendChild(g):d.get("body").appendChild(g);c.bigImage=e;c.viewer=g;c._updateViewer(a,false);c._zoom();c.bigImage.onload=function(){if(!c.bigImageReady){c.bigImageReady=!c.bigImageReady;c._updateViewer(a,true)}};if(!c.bigImageReady&&c.bigImage.complete&&c.getSize(c.bigImage).height){c.bigImageReady=!c.bigImageReady;c._updateViewer(a,true)}},_zoom:function(){var a=
this,c=a.config,b=a.glass,g=a.viewer;n.on(a.origin,"mousemove",function(e){e=a.getGlassOffset(e);if(b){d.css(b,"left",e.left+"px");d.css(b,"top",e.top+"px")}var f=a.getSize(a.image),h=a.getSize(a.bigImage),i=0,k=0,o=Math.round(e.left*h.width/f.width);f=Math.round(e.top*h.height/f.height);if(l[2]==c.type){k=a.getSize(b);i=k.width/2;k=k.height/2}g.scrollLeft=o+i;g.scrollTop=f+k;if(l[2]==c.type){d.css(g,"left",e.left+"px");d.css(g,"top",e.top+"px")}})},_updateViewer:function(a,c){if(c){this.timer&&clearTimeout(this.timer);
this.hideMsg()}var b=this.image,g=this.viewer,e=this.config,f=d.offset(b),h=this.getSize(this.glass),i;if(l[2]==e.type){c=this.getMousePoint(a);e=c.y-f.top;i=c.x-f.left-h.width/2;f=e-h.height/2;c=h.height;h=h.width}else{var k;b=this.getSize(b);var o=this.origin;i=parseInt(d.css(g,"borderTopWidth"));a=parseInt(d.css(g,"borderLeftWidth"));k=c?this.getSize(this.bigImage):e.bigImageSize;c=Math.round(k.height*h.height/b.height);h=Math.round(k.width*h.width/b.width);if(p[0]==e.position){(a=parseInt(d.css(o,
"marginTop")))||(a=0);i=f.top-c-i-e.offset+a;f=f.left}else if(p[2]==e.position){i=b.height+f.top+e.offset;f=f.left}else if(p[3]==e.position){(b=parseInt(d.css(o,"marginLeft")))||(b=0);i=f.top;f=f.left-h-a-e.offset+b}else{i=f.top;f=f.left+b.width+e.offset}}d.css(g,"height",c+"px");d.css(g,"width",h+"px");d.offset(g,{left:f,top:i})},getGlassOffset:function(a){var c=this.image,b={left:0,top:0},g=d.offset(c);a=this.getMousePoint(a);var e=this.getSize(this.glass),f=this.getSize(c);b.left=a.x-g.left-e.width/
2;var h=c=0;if(l[2]==this.config.type){c=e.width/2;h=e.height/2}if(b.left<-c)b.left=0;else if(b.left>f.width-e.width+c)b.left=f.width-e.width;b.top=a.y-g.top-e.height/2;if(b.top<-h)b.top=0;else if(b.top>f.height-e.height+h)b.top=f.height-e.height;return b},getSize:function(a){if(!a)return this.config.glassSize;return{width:a.clientWidth,height:a.clientHeight}},getMousePoint:function(a){return{x:a.pageX,y:a.pageY}},showMsg:function(){var a=j.get("b",this.viewer);if(!a){a=d.create("<b>");this.viewer.appendChild(a);
d.removeClass(this.viewer,"ks-imagezoom-viewer-bk")}d.html(a,"\u037c\u01ac\ufffd\u0772\ufffd\ufffd\ufffd\ufffd\ufffd")},hideMsg:function(){var a=j.get("b",this.viewer);d.html(a,"");d.addClass(this.viewer,"ks-imagezoom-viewer-bk")}},j.EventTarget);j.ImageZoom=m});
