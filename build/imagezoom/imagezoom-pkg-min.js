/*
Copyright 2010, KISSY UI Library v1.1.3
MIT Licensed
build time: Sep 13 10:15
*/
KISSY.add("imagezoom",function(f){function g(a,b){var c=this,d;if(!(c instanceof g))return new g(a,b);if(c.image=a=f.get(a)){b=f.merge(p,b);if(!b.bigImageSrc)if((d=e.attr(a,"data-src"))&&q.test(d))b.bigImageSrc=d;if(b.preload)(new Image).src=b.bigImageSrc;m(a,function(){c.on("afterInit",function(){c.imgSize=f.merge(e.offset(a),j(a));b.lensIcon&&c._renderIcon()});g.superclass.constructor.call(c,a,b)})}}function m(a,b){a.complete?b():h.on(a,"load",b)}function l(a){a&&e.addClass(a,n)}function o(a){a&&
e.removeClass(a,n)}function j(a){return{width:a.clientWidth,height:a.clientHeight}}var e=f.DOM,h=f.Event,n="ks-hidden",q=/^.+\.(jpg|png|gif)$/i,k=Math.round,p={bigImageSrc:"",bigImageSize:[900,900],preload:true,timeout:120,timeoutMsg:"\u56fe\u7247\u6682\u4e0d\u53ef\u7528",lensSize:[200,200],lensIcon:true,containerCls:"ks-imagezoom-viewer",triggerType:"mouse",align:{node:"",x:"r",y:"t",inner:[false,true],offset:10}};f.extend(g,f.Overlay);f.ImageZoom=g;f.augment(g,{_extraContent:function(){var a=this,
b,c=a.config,d;a._renderLens();b=e.create("<img>",{src:c.bigImageSrc});a.body.appendChild(b);a.bigImage=b;a.viewer=a.overlay;if(!b.complete){d=f.later(function(){b.complete||a._showTimeoutMsg();d.cancel()},c.timeout*1E3);m(b,function(){d&&d.cancel();a._setViewerRegion()})}a._setViewerRegion()},_renderLens:function(){var a=e.create("<div>",{"class":"ks-imagezoom-lens"}),b=this.config,c=this.imgSize;document.body.appendChild(a);e.width(a,b.lensSize[0]);e.height(a,b.lensSize[1]);e.offset(a,{left:c.left+
c.width/2-b.lensSize[0]/2,top:c.top+c.height/2-b.lensSize[1]/2});this.lens=a;l(a)},_renderIcon:function(){var a=this.imgSize,b=e.create("<div>",{"class":"ks-imagezoom-icon"});document.body.appendChild(b);var c=j(b);e.offset(b,{left:a.left+a.width-c.width,top:a.top+a.height-c.height});this.lensIcon=b},_setViewerRegion:function(){var a=this.config,b=this.imgSize,c=a.lensSize,d=this.bigImage;d=d?{width:a.bigImageSize[0],height:a.bigImageSize[1]}:j(d);a=k(d.height*c[1]/b.height);b=k(d.width*c[0]/b.width);
g.superclass.setSize.call(this,b,a)},_triggerMouse:function(){var a=this,b;h.on(a.trigger,"mouseenter",function(){b=f.later(function(){a.show();b.cancel()},300)});h.on(a.trigger,"mouseleave",function(){b&&b.cancel()})},_onMouseMove:function(a){var b=this.imgSize;if(a.pageX>b.left&&a.pageX<b.left+b.width&&a.pageY>b.top&&a.pageY<b.top+b.height){var c=this.config,d=this.viewer,i=this.lens;b=this.imgSize;c=c.lensSize;a={left:a.pageX-c[0]/2,top:a.pageY-c[1]/2};if(a.left<=b.left)a.left=b.left;else if(a.left>=
b.width+b.left-c[0])a.left=b.width+b.left-c[0];if(a.top<=b.top)a.top=b.top;else if(a.top>=b.height+b.top-c[1])a.top=b.height+b.top-c[1];i&&e.offset(i,a);i=j(this.bigImage);d.scrollLeft=k((a.left-b.left)*i.width/b.width);d.scrollTop=k((a.top-b.top)*i.height/b.height)}else this.hide()},_showTimeoutMsg:function(){var a=this.config,b=this.viewer,c=f.get("p",b);if(!c){c=e.create("<p>");b.appendChild(c)}e.html(c,a.timeoutMsg)},show:function(){g.superclass.show.call(this);o(this.lens);l(this.lensIcon);h.on(document.body,
"mousemove",this._onMouseMove,this)},hide:function(){g.superclass.hide.call(this);l(this.lens);o(this.lensIcon);h.remove(document.body,"mousemove",this._onMouseMove,this)}})},{host:"overlay"});
