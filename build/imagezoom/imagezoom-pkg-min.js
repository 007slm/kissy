/*
Copyright 2010, KISSY UI Library v1.1.4
MIT Licensed
build time: Sep 16 16:33
*/
KISSY.add("imagezoom",function(i,p){function n(a,b){var c=this,d;if(!(c instanceof n))return new n(a,b);if(c.image=a=i.get(a)){c.config=b=i.merge(x,b);if(!b.bigImageSrc)if((d=e.attr(a,"data-ks-imagezoom"))&&t.test(d))b.bigImageSrc=d;b.offset=i.makeArray(b.offset);if(b.preload)(new Image).src=b.bigImageSrc;u(a,function(){c._init()})}}function u(a,b){a.complete?b():l.on(a,"load",b)}function v(a){return{width:a.clientWidth,height:a.clientHeight}}function q(a){return e.create(y,{"class":a,style:"position:absolute"})}
function w(a,b,c){e.width(a,b);e.height(a,c)}var m=document,e=i.DOM,l=i.Event,y="<div>",t=/^.+\.(jpg|png|gif)$/i,o=Math.round,k=["top","right","bottom","left","inner"],x={type:"standard",bigImageSrc:"",bigImageSize:[800,800],position:"right",offset:10,preload:true,timeout:120,timeoutMsg:"\u56fe\u7247\u6682\u4e0d\u53ef\u7528",zoomSize:["auto","auto"],lensIcon:true,zoomCls:""};i.augment(n,i.EventTarget,{_init:function(){this._renderUI();this._bindUI()},_renderUI:function(){var a=this.config,b=this.image;
this._imgRegion=i.merge(e.offset(b),v(b));a.lensIcon&&this._renderIcon()},_renderIcon:function(){var a=this._imgRegion,b=q("ks-imagezoom-icon");m.body.appendChild(b);e.offset(b,{left:a.left+a.width-e.width(b),top:a.top+a.height-e.height(b)});this.lensIcon=b},_bindUI:function(){var a=this,b;l.on(a.image,"mouseenter",function(){b=i.later(function(){var c=a.config.bigImageSrc;if(a.viewer){if(a._cacheBigImageSrc&&a._cacheBigImageSrc!==c){e.attr(a.bigImage,"src",c);a._cacheBigImageSrc=c;a._updateViewerOnLoad()}}else a._createViewer();
a.show()},100)});l.on(a.image,"mouseleave",function(){if(b){b.cancel();b=p}})},_createViewer:function(){var a=this.config,b;this._renderLens();b=q("ks-imagezoom-viewer "+a.zoomCls);a=e.create("<img>",{src:a.bigImageSrc});b.appendChild(a);m.body.appendChild(b);this.bigImage=a;this.viewer=b;this._setViewerRegion();this._updateViewerOnLoad()},_updateViewerOnLoad:function(){var a=this,b=a.config,c,d=a.bigImage;if(!d.complete){c=i.later(function(){d.complete||a._showTimeoutMsg();c=p},b.timeout*1E3);u(d,
function(){if(c){c.cancel();c=p}a._setViewerRegion()})}},_renderLens:function(){var a=q("ks-imagezoom-lens");e.hide(a);m.body.appendChild(a);this.lens=a},_setViewerRegion:function(){var a=this.config,b=this.viewer,c=this._imgRegion,d=a.zoomSize,g,f,h;this._bigImageSize=f=(h=this.bigImage)?{width:a.bigImageSize[0],height:a.bigImageSize[1]}:v(h);h=d[0];if(h==="auto")h=c.width;d=d[1];if(d==="auto")d=c.height;g=o(h*c.width/f.width);f=o(d*c.height/f.height);this._lensSize=[g,f];w(this.lens,g,f);e.offset(this.lens,
{left:c.left+(c.width-g)/2,top:c.top+(c.height-f)/2});g=c.left+(a.offset[0]||0);f=c.top+(a.offset[1]||0);switch(a.position){case k[0]:f-=d;break;case k[1]:g+=c.width;break;case k[2]:f+=c.height;break;case k[3]:g-=h;break;case k[4]:h=c.width;d=c.height;e.css(b,"cursor","move");break}e.offset(b,{left:g,top:f});w(b,h,d)},_onMouseMove:function(a){var b=this.viewer,c=this.lens,d=this._imgRegion,g=d.left,f=d.top,h=d.width;d=d.height;var j=this._lensSize,r=j[0],s=j[1];if(a.pageX>g&&a.pageX<g+h&&a.pageY>
f&&a.pageY<f+d){j=a.pageX-r/2;a=a.pageY-s/2;if(j<=g)j=g;else if(j>=h+g-r)j=h+g-r;if(a<=f)a=f;else if(a>=d+f-s)a=d+f-s;c&&e.offset(c,{left:j,top:a});b.scrollLeft=o((j-g)*this._bigImageSize.width/h);b.scrollTop=o((a-f)*this._bigImageSize.height/d)}else this.hide()},_showTimeoutMsg:function(){var a=this.config,b=this.viewer,c=i.get("p",b);if(!c){c=e.create("<p>");b.appendChild(c)}e.html(c,a.timeoutMsg)},show:function(){e.show(this.config.position!==k[4]?[this.lens,this.viewer]:this.viewer);e.hide(this.lensIcon);
l.on(m.body,"mousemove",this._onMouseMove,this)},hide:function(){e.hide([this.lens,this.viewer]);e.show(this.lensIcon);l.remove(m.body,"mousemove",this._onMouseMove,this)},set:function(a,b){if(a==="bigImageSrc")if(b&&t.test(b)){this._cacheBigImageSrc=this.config.bigImageSrc;this.config.bigImageSrc=b}}});i.ImageZoom=n});
