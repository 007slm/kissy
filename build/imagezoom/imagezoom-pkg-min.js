/*
Copyright 2010, KISSY UI Library v1.1.4
MIT Licensed
build time: Sep 13 17:31
*/
KISSY.add("imagezoom",function(h,n){function o(a,b){var c=this,d;if(!(c instanceof o))return new o(a,b);if(c.image=a=h.get(a)){c.config=b=h.merge(u,b);if(!b.bigImageSrc)if((d=e.attr(a,"data-ks-imagezoom"))&&v.test(d))b.bigImageSrc=d;b.offset=h.makeArray(b.offset);if(b.preload)(new Image).src=b.bigImageSrc;t(a,function(){c._init()})}}function t(a,b){a.complete?b():l.on(a,"load",b)}function q(a){return{width:a.clientWidth,height:a.clientHeight}}function r(a){return e.create(w,{"class":a,style:"position:absolute"})}
var m=document,e=h.DOM,l=h.Event,w="<div>",v=/^.+\.(jpg|png|gif)$/i,p=Math.round,u={type:"standard",bigImageSrc:"",bigImageSize:[900,900],offset:10,preload:true,timeout:120,timeoutMsg:"\u56fe\u7247\u6682\u4e0d\u53ef\u7528",lensSize:[200,200],lensIcon:true};h.augment(o,h.EventTarget,{_init:function(){this._renderUI();this._bindUI()},_renderUI:function(){var a=this.config,b=this.image;this.imgRegion=h.merge(e.offset(b),q(b));this._renderLens();a.lensIcon&&this._renderIcon()},_renderLens:function(){var a=
this.config,b=r("ks-imagezoom-lens");e.width(b,a.lensSize[0]);e.height(b,a.lensSize[1]);e.hide(b);m.body.appendChild(b);this.lens=b},_renderIcon:function(){var a=this.imgRegion,b=r("ks-imagezoom-icon");m.body.appendChild(b);e.offset(b,{left:a.left+a.width-e.width(b),top:a.top+a.height-e.height(b)});this.lensIcon=b},_bindUI:function(){var a=this,b;l.on(a.image,"mouseenter",function(){b=h.later(function(){a.viewer||a._createViewer();a.show()},100)});l.on(a.image,"mouseleave",function(){if(b){b.cancel();
b=n}})},_createViewer:function(){var a=this,b=a.config,c,d,f;c=r("ks-imagezoom-viewer");d=e.create("<img>",{src:b.bigImageSrc});c.appendChild(d);m.body.appendChild(c);a.bigImage=d;a.viewer=c;if(!d.complete){f=h.later(function(){d.complete||a._showTimeoutMsg();f=n},b.timeout*1E3);t(d,function(){if(f){f.cancel();f=n}a._setViewerRegion()})}a._setViewerRegion()},_setViewerRegion:function(){var a=this.config,b=this.viewer,c=this.imgRegion,d=a.lensSize,f,i,j,g=this.bigImage,k;k=g?{width:a.bigImageSize[0],
height:a.bigImageSize[1]}:q(g);j=p(k.height*d[1]/c.height);d=p(k.width*d[0]/c.width);if(g){f=c.left+c.width+(a.offset[0]||0);i=c.top+(a.offset[1]||0)}if(d){e.width(b,d);e.height(b,j)}f!==n&&e.offset(b,{left:f,top:i})},_onMouseMove:function(a){var b=this.viewer,c=this.lens,d=this.imgRegion,f=d.left,i=d.top,j=d.width;d=d.height;var g=this.config.lensSize,k=g[0],s=g[1];if(a.pageX>f&&a.pageX<f+j&&a.pageY>i&&a.pageY<i+d){g=a.pageX-k/2;a=a.pageY-s/2;if(g<=f)g=f;else if(g>=j+f-k)g=j+f-k;if(a<=i)a=i;else if(a>=
d+i-s)a=d+i-s;c&&e.offset(c,{left:g,top:a});c=q(this.bigImage);b.scrollLeft=p((g-f)*c.width/j);b.scrollTop=p((a-i)*c.height/d)}else this.hide()},_showTimeoutMsg:function(){var a=this.config,b=this.viewer,c=h.get("p",b);if(!c){c=e.create("<p>");b.appendChild(c)}e.html(c,a.timeoutMsg)},show:function(){e.show([this.lens,this.viewer]);e.hide(this.lensIcon);l.on(m.body,"mousemove",this._onMouseMove,this)},hide:function(){e.hide([this.lens,this.viewer]);e.show(this.lensIcon);l.remove(m.body,"mousemove",
this._onMouseMove,this)}});h.ImageZoom=o});
