/*
Copyright 2010, KISSY UI Library v1.1.5
MIT Licensed
build time: Sep 30 18:00
*/
KISSY.add("imagezoom",function(i,o){function p(a,b){var c=this,d;if(!(c instanceof p))return new p(a,b);if(c.image=a=i.get(a)){c.config=b=i.merge(A,b);if(!b.bigImageSrc)if((d=f.attr(a,"data-ks-imagezoom"))&&x.test(d))b.bigImageSrc=d;b.offset=i.makeArray(b.offset);if(b.preload)(new Image).src=b.bigImageSrc;c._isInner=b.position===q[4];!a.complete&&c._startLoading();l.on(a,y,function(){c._finishLoading()});r(a,function(){c._imgRegion||c._init()})}}function r(a,b){(a&&a.complete&&a.clientWidth?true:
false)?b():l.on(a,y,b)}function s(a){return f.create(B,{"class":a,style:"position:absolute;top:0;left:0"})}function k(a,b,c){i.each(i.makeArray(a),function(d){f.width(d,b);f.height(d,c)})}function t(a,b){var c=f.create(C,{SRC:a,style:"position:absolute;top:0;left:0"});b&&b.appendChild(c);return c}var n=document,f=i.DOM,l=i.Event,B="<div>",C="<img>",x=/^.+\.(?:jpg|png|gif)$/i,m=Math.round,y="load",q=["top","right","bottom","left","inner"],A={type:"standard",bigImageSrc:"",bigImageSize:[800,800],position:"right",
offset:10,preload:true,timeoutMsg:"\u56fe\u7247\u6682\u4e0d\u53ef\u7528",zoomSize:["auto","auto"],lensIcon:true,zoomCls:""};i.augment(p,i.EventTarget,{_init:function(){this._renderUI();this._bindUI()},_renderUI:function(){var a=this.config,b=this.image;this._imgRegion=i.merge(f.offset(b),{width:b.clientWidth,height:b.clientHeight});this._bigImageSize={width:a.bigImageSize[0],height:a.bigImageSize[1]};a.lensIcon&&this._renderIcon()},_renderIcon:function(){var a=this._imgRegion,b;b=s("ks-imagezoom-icon");n.body.appendChild(b);f.offset(b,
{left:a.left+a.width-f.width(b),top:a.top+a.height-f.height(b)});this.lensIcon=b},_bindUI:function(){var a=this,b;l.on(a.image,"mouseenter",function(){l.on(n.body,"mousemove",a._getEv,a);b=i.later(function(){var c=a.config.bigImageSrc,d=a.bigImage;if(a.viewer){if(a._cacheBigImageSrc&&a._cacheBigImageSrc!==c){a._partical=true;f.attr(d,"src",c);a._cacheBigImageSrc=c;a._isInner&&f.attr(a._bigImageCopy,"src",f.attr(a.image,"src"))}}else a._createViewer();a.show()},300)});l.on(a.image,"mouseleave",function(){l.remove(n.body,
"mousemove",a._getEv);if(b){b.cancel();b=o}})},_getEv:function(a){this._ev=a},_createViewer:function(){var a=this,b=a.config,c,d,g,e=a._bigImageSize;c=s("ks-imagezoom-viewer "+b.zoomCls);if(a._isInner){g=t(f.attr(a.image,"src"),c);k(g,e.width,e.height);a._bigImageCopy=g}else a._renderLens();if(b.bigImageSrc){d=t(b.bigImageSrc,c);a.bigImage=d}n.body.appendChild(c);a.viewer=c;a._setViewerRegion();r(d,function(){if(!a._isInner){a._bigImageSize={width:d.clientWidth,height:d.clientHeight};a._setViewerRegion()}})},
_renderLens:function(){var a=s("ks-imagezoom-lens");f.hide(a);n.body.appendChild(a);this.lens=a},_setViewerRegion:function(){var a=this.config,b=this.viewer,c=this._imgRegion,d=a.zoomSize,g,e,h;e=this._bigImageSize;h=d[0];if(h==="auto")h=c.width;d=d[1];if(d==="auto")d=c.height;g=m(h*c.width/e.width);e=m(d*c.height/e.height);this._lensSize=[g,e];if(!this._isInner){k(this.lens,g,e);f.offset(this.lens,{left:m(c.left+(c.width-g)/2),top:m(c.top+(c.height-e)/2)})}if(!this._partical){g=c.left+(a.offset[0]||
0);e=c.top+(a.offset[1]||0);switch(a.position){case q[0]:e-=d;break;case q[1]:g+=c.width;break;case q[2]:e+=c.height;break;case q[3]:g-=h;break;case q[4]:h=c.width;d=c.height;f.css(b,"cursor","move")}f.offset(b,{left:g,top:e});k(b,h,d)}},_onMouseMove:function(){var a=this.lens,b=this._ev,c=this._imgRegion,d=c.left,g=c.top,e=c.width;c=c.height;var h=this._bigImageSize;if(b.pageX>d&&b.pageX<d+e&&b.pageY>g&&b.pageY<g+c){if(!(this._isInner&&this._animTimer)){b=this._getLensOffset();!this._isInner&&a&&
f.offset(a,b);f.css([this._bigImageCopy,this.bigImage],{marginLeft:-m((b.left-d)*h.width/e),marginTop:-m((b.top-g)*h.height/c)})}}else this.hide()},_getLensOffset:function(){var a=this._imgRegion,b=this._ev,c=a.left,d=a.top,g=a.width;a=a.height;var e=this._lensSize,h=e[0];e=e[1];var j=b.pageX-h/2;b=b.pageY-e/2;if(j<=c)j=c;else if(j>=g+c-h)j=g+c-h;if(b<=d)b=d;else if(b>=a+d-e)b=a+d-e;return{left:j,top:b}},_anim:function(a,b){var c=this,d,g=1;d=c._ev;var e=c._imgRegion,h=e.width,j=e.height,u=[c.bigImage,
c._bigImageCopy],D=d.pageX-e.left,E=d.pageY-e.top,z=c._bigImageSize;c._animTimer&&c._animTimer.cancel();k(u,h,j);c._animTimer=i.later(d=function(){var v=h+(z.width-h)/b*g,w=j+(z.height-j)/b*g;k(u,v,w);f.css(u,{marginLeft:Math.max(Math.min(m(h/2-D*v/h),0),h-v),marginTop:Math.max(Math.min(m(j/2-E*w/j),0),j-w)});if(++g>b){c._animTimer.cancel();c._animTimer=o}},a*1E3/b,true);d()},show:function(){var a=this.lens,b=this.viewer;f.hide(this.lensIcon);if(this._isInner){f.show(b);this._anim(0.5,30)}else{f.show([a,
b]);this._onMouseMove()}l.on(n.body,"mousemove",this._onMouseMove,this)},hide:function(){f.hide([this.lens,this.viewer]);f.show(this.lensIcon);l.remove(n.body,"mousemove",this._onMouseMove,this)},set:function(a,b){if(a==="bigImageSrc")if(b&&x.test(b)){this._cacheBigImageSrc=this.config.bigImageSrc;this.config.bigImageSrc=b}},_startLoading:function(){f.addClass(this.viewer,"ks-imagezoom-loading")},_finishLoading:function(){f.removeClass(this.viewer,"ks-imagezoom-loading")},changeImageSrc:function(a){f.attr(this.image,
"src",a);this._startLoading()}});i.ImageZoom=p});KISSY.add("autorender",function(i){i.ImageZoom.autoRender=function(o,p){o="."+(o||"KS_Widget");i.query(o,p).each(function(r){var s=r.getAttribute("data-widget-type"),k;if(s==="ImageZoom")try{if(k=r.getAttribute("data-widget-config"))k=k.replace(/'/g,'"');new i[s](r,i.JSON.parse(k))}catch(t){}})}},{host:"imagezoom"});
