/*
Copyright 2011, KISSY UI Library v1.1.8dev
MIT Licensed
build time: ${build.time}
*/
KISSY.add("imagezoom",function(h,m){function k(a,b){if(!(this instanceof k))return new k(a,b);if(this.image=a=h.get(a)){k.superclass.constructor.call(this,b);this._init()}}function n(a,b){C(a)&&b();s.on(a,"load",b)}function o(a){return{width:a.clientWidth,height:a.clientHeight}}function l(a){return e.create('<div class="'+a+y)}function p(a,b,c){h.each(h.makeArray(a),function(d){e.width(d,b);e.height(d,c)})}function C(a){return a&&a.complete&&a.clientWidth?true:false}function z(a,b){a=e.create('<img src="'+
a+y);b&&b.appendChild(a);return a}function w(a){a=h.makeArray(a);if(a.length===1)a[1]=a[0];return a}var t=document,e=h.DOM,s=h.Event,A=/^.+\.(?:jpg|png|gif)$/i,q=Math.round,B=Math.min,r=["top","right","bottom","left","inner"],y='" style="position:absolute;top:0;left:0">';h.extend(k,h.Base);k.ATTRS={type:{value:"standard"},bigImageSrc:{value:"",setter:function(a){var b=this.get("bigImageSrc");if(a&&A.test(a)&&a!==b){this._cacheBigImageSrc=b;return a}return this.get("bigImageSrc")},getter:function(a){var b;
if(!a)if((b=e.attr(this.image,"data-ks-imagezoom"))&&A.test(b))a=b;return a}},bigImageSize:{value:[800,800],setter:function(a){return w(a)}},position:{value:"right"},alignTo:{value:m},offset:{value:[10,0],setter:function(a){return w(a)}},preload:{value:true},zoomSize:{value:["auto","auto"],setter:function(a){return w(a)},getter:function(a){if(this._imgRegion){if(a[0]==="auto")a[0]=this._imgRegion.width;if(a[1]==="auto")a[1]=this._imgRegion.height}return a}},lensIcon:{value:true},zoomCls:{value:""},
hasZoom:{value:true,setter:function(a){return!!a}}};h.augment(k,{_init:function(){var a=this,b,c=a.image;if((b=a.get("bigImageSrc"))&&a.get("preload"))(new Image).src=b;a._isInner=a.get("position")===r[4];a._getAlignTo();b=a.get("bigImageSize");a._bigImageSize={width:b[0],height:b[1]};a.get("hasZoom")&&!c.complete&&a._startLoading();a._firstInit=true;n(c,function(){if(a.get("hasZoom")){a._finishLoading();a._ready()}})},_getAlignTo:function(){var a;if(!this._isInner&&(a=this.get("alignTo")))if(a=a===
"parent"?this.image.offsetParent:h.get(a))this._alignToRegion=h.merge(e.offset(a),o(a))},_ready:function(){var a=this.image;this._imgRegion=h.merge(e.offset(a),o(a));this.get("lensIcon")&&this._renderIcon();if(this._firstInit){this._bindUI();this._onAttrChanges()}this._firstInit=false},_renderIcon:function(){var a=this._alignToRegion||this._imgRegion,b=this.lensIcon;if(!b){b=l("ks-imagezoom-icon");t.body.appendChild(b);this.lensIcon=b}e.offset(b,{left:a.left+a.width-e.width(b),top:a.top+a.height-
e.height(b)})},_bindUI:function(){var a=this,b;s.on(a.image,"mouseenter",function(c){if(a.get("hasZoom"))b=h.later(function(){a._setEv(c);a.viewer||a._createViewer();a.show()},50)});s.on(a.image,"mouseleave",function(){if(b){b.cancel();b=m}})},_onAttrChanges:function(){var a=this;a.on("afterHasZoomChange",function(b){e[b.newVal?"show":"hide"](a.lensIcon)})},_setEv:function(a){this._ev=a},_createViewer:function(){var a=this,b,c,d,g=a._bigImageSize,f=a.get("bigImageSrc");b=l("ks-imagezoom-viewer "+
a.get("zoomCls"));if(a._isInner){d=z(e.attr(a.image,"src"),b);p(d,g.width,g.height);a._bigImageCopy=d}else a._renderLens();if(f){c=z(f,b);!c.complete&&a._startBigLoading();a.bigImage=c}t.body.appendChild(b);a.viewer=b;a._setViewerRegion();n(c,function(){a._finishBigLoading();if(!a._isInner)a._bigImageSize=o(c);a._setViewerRegion();a._isInner||a._onMouseMove()})},_renderLens:function(){var a=l("ks-imagezoom-lens");e.hide(a);t.body.appendChild(a);this.lens=a},_setViewerRegion:function(){var a=this.viewer,
b=this._imgRegion,c=this._alignToRegion||b,d=this.get("zoomSize"),g=this.get("offset"),f=c.left+g[0];g=c.top+g[1];var i;this._setLensSize(i=d[0],d=d[1]);switch(this.get("position")){case r[0]:g-=d;break;case r[1]:f+=c.width;break;case r[2]:g+=c.height;break;case r[3]:f-=i;break;case r[4]:i=b.width;d=b.height;break}e.offset(a,{left:f,top:g});p(a,i,d)},_setLensSize:function(a,b){var c=this._imgRegion,d=this._bigImageSize;a=B(q(a*c.width/d.width),c.width);b=B(q(b*c.height/d.height),c.height);this._lensSize=
[a,b];this._isInner||p(this.lens,a,b)},_onMouseMove:function(a){var b=this.lens,c=this._imgRegion,d=c.left,g=c.top,f=c.width;c=c.height;var i=this._bigImageSize;if(a)this._setEv(a);else a=this._ev;if(a.pageX>d&&a.pageX<d+f&&a.pageY>g&&a.pageY<g+c){if(!(this._isInner&&this._animTimer)){a=this._getLensOffset();!this._isInner&&b&&e.offset(b,a);e.css([this._bigImageCopy,this.bigImage],{left:-q((a.left-d)*i.width/f),top:-q((a.top-g)*i.height/c)})}}else this.hide()},_getLensOffset:function(){var a=this._imgRegion,
b=this._ev,c=a.left,d=a.top,g=a.width;a=a.height;var f=this._lensSize,i=f[0];f=f[1];var j=b.pageX-i/2;b=b.pageY-f/2;if(j<=c)j=c;else if(j>=g+c-i)j=g+c-i;if(b<=d)b=d;else if(b>=a+d-f)b=a+d-f;return{left:j,top:b}},_anim:function(a,b){var c=this,d,g=1,f=c._imgRegion;d=f.left;var i=f.top,j=f.width,u=f.height,x=[c.bigImage,c._bigImageCopy],v=c._bigImageSize;f=c._getLensOffset();var D=-q((f.left-d)*v.width/j),E=-q((f.top-i)*v.height/u);c._animTimer&&c._animTimer.cancel();p(x,j,u);c._animTimer=h.later(d=
function(){p(x,j+(v.width-j)/b*g,u+(v.height-u)/b*g);e.css(x,{left:D/b*g,top:E/b*g});if(++g>b){c._animTimer.cancel();c._animTimer=m}},a*1E3/b,true);d()},show:function(){var a=this.lens,b=this.viewer;e.hide(this.lensIcon);if(this._isInner){e.show(b);this._anim(0.4,42)}else{e.show([a,b]);this._onMouseMove()}this._checkRefresh();this._checkBigImageSrc();s.on(t.body,"mousemove",this._onMouseMove,this);this.fire("show")},_checkRefresh:function(){if(this._refresh){this._setViewerRegion();this._refresh=
false}},_checkBigImageSrc:function(){var a=this.get("bigImageSrc");if(this._cacheBigImageSrc&&this._cacheBigImageSrc!==a){e.attr(this.bigImage,"src",a);this._cacheBigImageSrc=a;this._isInner&&e.attr(this._bigImageCopy,"src",e.attr(this.image,"src"));!this.bigImage.complete&&this._startBigLoading()}},hide:function(){e.hide([this.lens,this.viewer]);e.show(this.lensIcon);s.remove(t.body,"mousemove",this._onMouseMove,this);this.fire("hide")},_startLoading:function(){},_finishLoading:function(){},_startBigLoading:function(){e.addClass(this.viewer,
"ks-imagezoom-loading")},_finishBigLoading:function(){e.removeClass(this.viewer,"ks-imagezoom-loading")},changeImageSrc:function(a){e.attr(this.image,"src",a);this._startLoading()},refreshRegion:function(){this._getAlignTo();this._ready();this._refresh=true}});h.ImageZoom=k},{requires:["core"]});
KISSY.add("autorender",function(h){h.ImageZoom.autoRender=function(m,k){m="."+(m||"KS_Widget");h.query(m,k).each(function(n){var o=n.getAttribute("data-widget-type"),l;if(o==="ImageZoom")try{if(l=n.getAttribute("data-widget-config"))l=l.replace(/'/g,'"');new h[o](n,h.JSON.parse(l))}catch(p){}})}},{host:"imagezoom"});
