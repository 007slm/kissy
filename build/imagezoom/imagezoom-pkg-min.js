/*
Copyright 2010, KISSY UI Library v1.1.5
MIT Licensed
build time: Nov 2 13:10
*/
KISSY.add("imagezoom",function(i,n){function o(a,b){var c=this,d;if(!(c instanceof o))return new o(a,b);if(c.image=a=i.get(a)){c.config=b=i.merge(C,b);if(!b.bigImageSrc)if((d=e.attr(a,"data-ks-imagezoom"))&&y.test(d))b.bigImageSrc=d;b.offset=i.makeArray(b.offset);if(b.preload)(new Image).src=b.bigImageSrc;c._isInner=b.position===p[4];if(!c._isInner&&b.alignTo)if(d=b.alignTo===D?a.offsetParent:i.get(b.alignTo))c._alignToRegion=i.merge(e.offset(d),q(d));c._bigImageSize={width:b.bigImageSize[0],height:b.bigImageSize[1]};
b.hasZoom&&!a.complete&&c._startLoading();c._firstInit=true;r(a,function(){if(b.hasZoom){c._init();c._finishLoading()}})}}function r(a,b){(a&&a.complete&&a.clientWidth?true:false)&&b();l.on(a,E,b)}function q(a){return{width:a.clientWidth,height:a.clientHeight}}function k(a){return e.create(F,{"class":a,style:"position:absolute;top:0;left:0"})}function s(a,b,c){i.each(i.makeArray(a),function(d){e.width(d,b);e.height(d,c)})}function z(a,b){var c=e.create('<img src="'+a+'" style="position:absolute;top:0;left:0" >');
b&&b.appendChild(c);return c}var m=document,e=i.DOM,l=i.Event,F="<div>",y=/^.+\.(?:jpg|png|gif)$/i,t=Math.round,u=Math.min,A=Math.max,E="load",p=["top","right","bottom","left","inner"],D="parent",C={type:"standard",bigImageSrc:"",bigImageSize:[800,800],position:"right",offset:10,preload:true,zoomSize:["auto","auto"],lensIcon:true,hasZoom:true,zoomCls:""};i.augment(o,i.EventTarget,{_init:function(){this._renderUI();this._firstInit&&this._bindUI();this._firstInit=false},_renderUI:function(){var a=this.config,
b=this.image;this._imgRegion=i.merge(e.offset(b),q(b));a.lensIcon&&this._renderIcon()},_renderIcon:function(){var a=this._alignToRegion||this._imgRegion,b=this.lensIcon;if(!b){b=k("ks-imagezoom-icon");m.body.appendChild(b);this.lensIcon=b}e.offset(b,{left:a.left+a.width-e.width(b),top:a.top+a.height-e.height(b)})},_bindUI:function(){var a=this,b,c=a.config;l.on(a.image,"mouseenter",function(d){if(c.hasZoom){a._setEv(d);l.on(m.body,"mousemove",a._setEv,a);b=i.later(function(){a.viewer||a._createViewer();
a.show()},300)}});l.on(a.image,"mouseleave",function(){if(c.hasZoom){l.remove(m.body,"mousemove",a._setEv);if(b){b.cancel();b=n}}})},_setEv:function(a){this._ev=a},_createViewer:function(){var a=this,b=a.config,c,d,g,f=a._bigImageSize;c=k("ks-imagezoom-viewer "+b.zoomCls);if(a._isInner){g=z(e.attr(a.image,"src"),c);s(g,f.width,f.height);a._bigImageCopy=g}else a._renderLens();if(b.bigImageSrc){d=z(b.bigImageSrc,c);a.bigImage=d}m.body.appendChild(c);a.viewer=c;a._setViewerRegion();r(d,function(){if(!a._isInner)a._bigImageSize=
q(d);a._setViewerRegion();a._isInner||a._onMouseMove()})},_renderLens:function(){var a=k("ks-imagezoom-lens");e.hide(a);m.body.appendChild(a);this.lens=a},_setViewerRegion:function(){var a=this.config,b=this.viewer,c=this._imgRegion,d=this._alignToRegion||c,g=a.zoomSize,f,h,j;h=this._bigImageSize;j=g[0];if(j==="auto")j=c.width;g=g[1];if(g==="auto")g=c.height;f=u(t(j*c.width/h.width),c.width);h=u(t(g*c.height/h.height),c.height);this._lensSize=[f,h];this._isInner||s(this.lens,f,h);f=d.left+(a.offset[0]||
0);h=d.top+(a.offset[1]||0);switch(a.position){case p[0]:h-=g;break;case p[1]:f+=d.width;break;case p[2]:h+=d.height;break;case p[3]:f-=j;break;case p[4]:j=c.width;g=c.height}e.offset(b,{left:f,top:h});s(b,j,g)},_onMouseMove:function(){var a=this.lens,b=this._ev,c=this._imgRegion,d=c.left,g=c.top,f=c.width;c=c.height;var h=this._bigImageSize;if(b.pageX>d&&b.pageX<d+f&&b.pageY>g&&b.pageY<g+c){if(!(this._isInner&&this._animTimer)){b=this._getLensOffset();!this._isInner&&a&&e.offset(a,b);e.css([this._bigImageCopy,
this.bigImage],{marginLeft:-t((b.left-d)*h.width/f),marginTop:-t((b.top-g)*h.height/c)})}}else this.hide()},_getLensOffset:function(){var a=this._imgRegion,b=this._ev,c=a.left,d=a.top,g=a.width;a=a.height;var f=this._lensSize,h=f[0];f=f[1];var j=b.pageX-h/2;b=b.pageY-f/2;if(j<=c)j=c;else if(j>=g+c-h)j=g+c-h;if(b<=d)b=d;else if(b>=a+d-f)b=a+d-f;return{left:j,top:b}},_anim:function(a,b){var c=this,d,g=1;d=c._ev;var f=c._imgRegion,h=f.width,j=f.height,v=[c.bigImage,c._bigImageCopy],G=d.pageX-f.left,
H=d.pageY-f.top,B=c._bigImageSize;c._animTimer&&c._animTimer.cancel();s(v,h,j);c._animTimer=i.later(d=function(){var w=h+(B.width-h)/b*g,x=j+(B.height-j)/b*g;s(v,w,x);e.css(v,{marginLeft:A(u(t(h/2-G*w/h),0),h-w),marginTop:A(u(t(j/2-H*x/j),0),j-x)});if(++g>b){c._animTimer.cancel();c._animTimer=n}},a*1E3/b,true);d()},show:function(){var a=this.lens,b=this.viewer,c=this.config.bigImageSrc;e.hide(this.lensIcon);if(this._isInner){e.show(b);this._anim(0.5,30)}else{e.show([a,b]);this._onMouseMove()}if(this._cacheBigImageSrc&&
this._cacheBigImageSrc!==c){e.attr(this.bigImage,"src",c);this._cacheBigImageSrc=c;this._isInner&&e.attr(this._bigImageCopy,"src",e.attr(this.image,"src"))}l.on(m.body,"mousemove",this._onMouseMove,this)},hide:function(){e.hide([this.lens,this.viewer]);e.show(this.lensIcon);l.remove(m.body,"mousemove",this._onMouseMove,this)},set:function(a,b){var c=this.config;if(a==="bigImageSrc"){if(b&&y.test(b)){this._cacheBigImageSrc=c.bigImageSrc;c.bigImageSrc=b}}else if(a==="hasZoom"){b=!!b;c.hasZoom=b;e[b?
"show":"hide"](this.lensIcon)}},_startLoading:function(){e.addClass(this.viewer,"ks-imagezoom-loading")},_finishLoading:function(){e.removeClass(this.viewer,"ks-imagezoom-loading")},changeImageSrc:function(a){e.attr(this.image,"src",a);this._startLoading()}});i.ImageZoom=o});
KISSY.add("autorender",function(i){i.ImageZoom.autoRender=function(n,o){n="."+(n||"KS_Widget");i.query(n,o).each(function(r){var q=r.getAttribute("data-widget-type"),k;if(q==="ImageZoom")try{if(k=r.getAttribute("data-widget-config"))k=k.replace(/'/g,'"');new i[q](r,i.JSON.parse(k))}catch(s){}})}},{host:"imagezoom"});
