/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Aug 31 20:37
*/
KISSY.add("waterfall/async",function(h,k,n,l,p){function j(){j.superclass.constructor.apply(this,arguments)}function q(){if(!this.__loading){var a=this.get("container"),b=Number.MAX_VALUE,c=this.get("curColHeights");h.each(c,function(d){if(b>d)b=d});b=c.length?a.offset().top+b:a.offset().top;this.get("diff")+i(window).scrollTop()+i(window).height()>b&&o.call(this)}}function m(){this.__scrollTimer&&this.__scrollTimer.cancel();this.__scrollTimer=h.later(q,r,false,this)}function o(){this.__loading=true;
var a=this.get("container"),b=this;n(h.mix({data:{from:a.all(".ks-waterfall").length},success:function(c){c.end&&i(window).detach("scroll",m,b);b.__loading=false;c=c.data;var d=l(b.get("itemTpl")),f=[];h.each(c,function(g){g=d.render(g);f.push(i(g))});b.addItems(f)}},b.get("remote")))}var i=k.all,r=50;j.ATTRS={remote:{},diff:{getter:function(a){return a||0}},itemTpl:{}};h.extend(j,p,{_init:function(){j.superclass._init.apply(this,arguments);i(window).on("scroll",m,this);o.call(this)},destroy:function(){j.superclass.destroy.apply(this,
arguments);i(window).detach("scroll",m,this)}});return j},{requires:["node","ajax","template","./base"]});
KISSY.add("waterfall/base",function(h,k,n){function l(){l.superclass.constructor.apply(this,arguments);this._init()}function p(a,b,c,d){var f=h.makeArray(a),g={},e;if(f.length>0)e=setTimeout(function(){var s=+new Date;do{var t=f.shift();b.call(c,t)}while(f.length>0&&+new Date-s<50);if(f.length>0)e=setTimeout(arguments.callee,25);else d&&d.call(c,a)},25);else d&&d.call(c,a);g.stop=function(){if(e){clearTimeout(e);f=[]}};return g}function j(){var a=this;if(this._resizer){this._resizer.stop();this._resizer=
0}this.get("container");m.call(this);this._resizer=this.adjust(function(){a._resizer=0})}function q(){this.__resizeTimer&&this.__resizeTimer.cancel();this.__resizeTimer=h.later(j,r,false,this)}function m(){var a=this.get("container"),b=this.get("container").width(),c=this._containerRegion;if(!c||b!==c.width){c=Math.max(parseInt(b/this.get("colWidth")),this.get("minColCount"));var d=this.get("curColHeights");d.length=c;h.each(d,function(f,g){d[g]=0});this._containerRegion=h.mix({width:b},a.offset())}}
function o(a){a=i(a);for(var b=this.get("curColHeights"),c=this.get("container"),d=b.length,f=0,g=Number.MAX_VALUE,e=0;e<d;e++)if(b[e]<g){g=b[e];f=e}d||(g=0);e=this._containerRegion;a.css({position:"absolute",left:f*Math.max(e.width/d,this.get("colWidth"))+e.left,top:g+e.top});c.contains(a)||c.append(a);b[f]+=a.height();return a}var i=k.all,r=50;l.ATTRS={container:{setter:function(a){return i(a)}},curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{}};
h.extend(l,n,{_init:function(){m.call(this);i(window).on("resize",q,this)},adjust:function(a){var b=this.get("container").all(".ks-waterfall");return p(b,o,this,a)},addItems:function(a,b){if(!this._resizer)return p(a,this.addItem,this,b)},addItem:function(a){this.get("curColHeights");this.get("container");a=o.call(this,a);var b=this.get("effect");b.effect&&a[b.effect](b.duration,undefined,b.easing)},destroy:function(){i(window).detach("resize",q,this)}});return l},{requires:["node","base"]});
KISSY.add("waterfall",function(h,k,n){k.Async=n;return k},{requires:["waterfall/base","waterfall/async"]});
