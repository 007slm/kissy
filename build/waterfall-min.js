/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Sep 3 10:34
*/
KISSY.add("waterfall/base",function(e,q,s){function h(){h.superclass.constructor.apply(this,arguments);this._init()}function t(a,c,b,f){var k={},r,g;k.stop=function(){r&&(clearTimeout(r),g=[],a.each(function(a){a.stop()}))};k.start=function(){g=[].concat(e.makeArray(a));0<g.length?function(){var k=+new Date;do{var n=g.shift();c.call(b,n)}while(0<g.length&&50>+new Date-k);0<g.length?r=setTimeout(arguments.callee,25):f&&f.call(b,a)}():f&&f.call(b,a)};return k}function u(){var a=this._containerRegion||
{};a&&this.get("container").width()===a.width||this.adjust()}function p(){var a=this.get("container").width(),c=this.get("curColHeights");c.length=Math.max(Math.floor(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};e.each(c,function(a,f){c[f]=0});this.set("colItems",[])}function j(a,c,b,f){function k(){d[i]+=g.outerHeight(!0);var b=a.get("colItems");b[i]=b[i]||[];b[i].push(g);g.attr("data-waterfall-col",i);b=g[0].className.replace(/\s*ks-waterfall-col-(?:first|last|\d+)/g,
"");b+=" ks-waterfall-col-"+i;0==i?b+=" ks-waterfall-col-first":i==d.length-1&&(b+=" ks-waterfall-col-last");g[0].className=b;f&&f()}var r=a.get("effect"),g=m(b),o=a.get("align"),n,d=a.get("curColHeights"),b=a.get("container"),e=a.get("colWidth"),l=d.length,i=0,h=a._containerRegion;n=Number.MAX_VALUE;if(l){if(g.hasClass("ks-waterfall-fixed-left"))i=0;else if(g.hasClass("ks-waterfall-fixed-right"))i=0<l?l-1:0;else for(var j=0;j<l;j++)d[j]<n&&(n=d[j],i=j);n="left"===o?0:Math.max(h.width-l*a.get("colWidth"),
0);"center"===o&&(n/=2);"justify"===o&&1<l&&(n=0<i?Math.max((h.width-e)/(l-1)-e,0)*i:0);o={left:i*e+n,top:d[i]};c?(g.css(o),r&&r.effect&&g.css("visibility","hidden"),b.append(g),k()):(c=a.get("adjustEffect"))?g.animate(o,c.duration,c.easing,k):(g.css(o),k());return g}}function v(a){var a=j(this,!0,a),c=this.get("effect");c&&c.effect&&(a.hide(),a.css("visibility",""),a[c.effect](c.duration,0,c.easing))}var m=q.all,d=e.Env.host;h.ATTRS={container:{setter:function(a){return m(a)}},curColHeights:{value:[]},
align:{value:"center"},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},colItems:{value:[]},adjustEffect:{}};e.extend(h,s,{isAdjusting:function(){return!!this._adjuster},isAdding:function(){return!!this._adder},_init:function(){u.call(this);this.__onResize=e.buffer(u,50,this);m(d).on("resize",this.__onResize)},adjustItem:function(a,c){function b(){i--;0>=i&&(f._adjuster=0,c.callback&&c.callback.call(f))}var f=this,c=c||{};if(!f.isAdjusting()){var k=a.outerHeight(!0),d;
c.process&&(d=c.process.call(f));void 0===d&&(d=a.outerHeight(!0));var g=d-k,e=f.get("curColHeights"),h=parseInt(a.attr("data-waterfall-col")),j=f.get("colItems")[h],k=[];d=Math.max.apply(Math,e);for(var m=0;m<j.length&&j[m][0]!==a[0];m++);for(m++;m<j.length;)k.push(j[m]),m++;e[h]+=g;e=Math.max.apply(Math,e);e!=d&&f.get("container").height(e);var l=c.effect,i=k.length;if(!i)return c.callback&&c.callback.call(f);void 0===l&&(l=f.get("adjustEffect"));f._adjuster=t(k,function(a){l?a.animate({top:parseInt(a.css("top"))+
g},l.duration,l.easing,b):(a.css("top",parseInt(a.css("top"))+g),b())});f._adjuster.start();return f._adjuster}},removeItem:function(a,c){var c=c||{},b=this,f=c.callback;b.adjustItem(a,e.mix(c,{process:function(){a.remove();return 0},callback:function(){for(var c=parseInt(a.attr("data-waterfall-col")),c=b.get("colItems")[c],d=0;d<c.length;d++)if(c[d][0]==a[0]){c.splice(d,1);break}f&&f()}}))},adjust:function(a){function c(){e--;0>=e&&(b.get("container").height(Math.max.apply(Math,b.get("curColHeights"))),
b._adjuster=0,a&&a.call(b),b.fire("adjustComplete",{items:d}))}var b=this,d=b.get("container").all(".ks-waterfall");b.isAdjusting()&&(b._adjuster.stop(),b._adjuster=0);p.call(b);var e=d.length;if(!e)return a&&a.call(b);b._adjuster=t(d,function(a){j(b,false,a,c)});b._adjuster.start();return b._adjuster},addItems:function(a,c){var b=this;b._adder=t(a,v,b,function(){b.get("container").height(Math.max.apply(Math,b.get("curColHeights")));b._adder=0;c&&c.call(b);b.fire("addComplete",{items:a})});b._adder.start();
return b._adder},destroy:function(){m(d).detach("resize",this.__onResize)}});return h},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(e,q,s){function h(){h.superclass.constructor.apply(this,arguments)}function t(){if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var e=this.get("container").offset().top,h=this.get("diff"),d=this.get("curColHeights");d.length&&(e+=Math.min.apply(Math,d));h+p(j).scrollTop()+p(j).height()>=e&&u.call(this)}}function u(){function e(a,b){d.__loading=0;d.addItems(a,b)}function h(){d.end()}var d=this;d.get("container");d.__loading=1;var a=d.get("load");
a&&a(e,h)}var p=q.all,j=e.Env.host;h.ATTRS={diff:{value:0}};e.extend(h,s,{_init:function(){h.superclass._init.apply(this,arguments);this.__onScroll=e.buffer(t,50,this);this.__onScroll();this.start()},start:function(){this.__started||(p(j).on("scroll",this.__onScroll),this.__started=1)},end:function(){p(j).detach("scroll",this.__onScroll)},pause:function(){this.end()},resume:function(){this.start()},destroy:function(){h.superclass.destroy.apply(this,arguments);p(j).detach("scroll",this.__onScroll);
this.__started=0}});return h},{requires:["node","./base"]});KISSY.add("waterfall",function(e,q,s){q.Loader=s;return q},{requires:["waterfall/base","waterfall/loader"]});
