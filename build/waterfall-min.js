/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Mar 6 16:05
*/
KISSY.add("waterfall/base",function(i,r,t){function j(){j.superclass.constructor.apply(this,arguments);this._init()}function s(a,b,c,e){var d=[].concat(i.makeArray(a)),f={},g;if(d.length>0)g=setTimeout(function(){var l=+new Date;do{var h=d.shift();b.call(c,h)}while(d.length>0&&+new Date-l<50);if(d.length>0)g=setTimeout(arguments.callee,25);else e&&e.call(c,a)},25);else e&&i.later(e,0,false,c,[a]);f.stop=function(){if(g){clearTimeout(g);d=[]}};return f}function u(){var a=this._containerRegion;a&&this.get("container").width()===
a.width||this.adjust()}function o(){var a=this.get("container").width(),b=this.get("curColHeights");b.length=Math.max(parseInt(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};i.each(b,function(c,e){b[e]=0});this.set("colItems",[])}function p(a){var b=this.get("effect");a=n(a);for(var c=this.get("curColHeights"),e=this.get("container"),d=c.length,f=0,g=this._containerRegion,l=Number.MAX_VALUE,h=0;h<d;h++)if(c[h]<l){l=c[h];f=h}d||(l=0);d=Math.max(g.width-d*this.get("colWidth"),
0)/2;a.css({left:f*this.get("colWidth")+d,top:l});if(!e.contains(a)){b&&b.effect=="fadeIn"&&a.css("opacity",0);e.append(a)}c[f]+=a.outerHeight(true);b=this.get("colItems");b[f]=b[f]||[];b[f].push(a);a.attr("data-waterfall-col",f);return a}function m(a){this.get("curColHeights");this.get("container");var b=p.call(this,a);a=this.get("effect");!a.effect||a.effect!=="fadeIn"||b.animate({opacity:1},{duration:a.duration,easing:a.easing,complete:function(){b.css("opacity","")}})}var n=r.all,k=i.Env.host;
j.ATTRS={container:{setter:function(a){return n(a)}},curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},colItems:{value:[]}};i.extend(j,t,{isAdjusting:function(){return!!this._adjuster},_init:function(){u.call(this);this.__onResize=i.buffer(u,50,this);n(k).on("resize",this.__onResize)},adjustItem:function(a,b){var c=this;if(!c.isAdjusting()){var e=a.outerHeight(true),d=false;if(b.process)d=b.process.call(c);var f=(d?0:a.outerHeight(true))-e,g=c.get("curColHeights"),
l=parseInt(a.attr("data-waterfall-col")),h=c.get("colItems")[l];e=[];d=Math.max.apply(Math,g);for(var q=0;q<h.length;q++)if(h[q][0]===a[0])break;for(q++;q<h.length;){e.push(h[q]);q++}g[l]+=f;g=Math.max.apply(Math,g);g!=d&&c.get("container").height(g);return c._adjuster=s(e,function(v){v.css("top",parseInt(v.css("top"))+f)},null,function(){c._adjuster=0;b&&b.callback&&b.callback.call(c)})}},removeItem:function(a,b){var c=this;c.adjustItem(a,{process:function(){a.remove();return true},callback:function(){var e=
parseInt(a.attr("data-waterfall-col"));e=c.get("colItems")[e];for(var d=0;d<e.length;d++)if(e[d][0]==a[0]){e.splice(d,1);break}b&&b.callback&&b.callback.call(c)}})},adjust:function(a){var b=this,c=b.get("container").all(".ks-waterfall");b.isAdjusting()&&b._adjuster.stop();o.call(b);return b._adjuster=s(c,m,b,function(){b.get("container").height(Math.max.apply(Math,b.get("curColHeights")));b._adjuster=0;a&&a.call(b);c.length&&b.fire("adjustComplete",{items:c})})},addItems:function(a,b){var c=this;
c._adder=s(a,m,c,function(){c.get("container").height(Math.max.apply(Math,c.get("curColHeights")));c._adder=0;b&&b.call(c);a.length&&c.fire("addComplete",{items:a})});return c._adder},destroy:function(){n(k).detach("resize",this.__onResize)}});return j},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(i,r,t){function j(){j.superclass.constructor.apply(this,arguments)}function s(){if(!this.__pause)if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var m=this.get("container").offset().top,n=this.get("diff"),k=this.get("curColHeights");if(k.length)m+=Math.min.apply(Math,k);n+o(p).scrollTop()+o(p).height()>m&&u.call(this)}}function u(){function m(b){k.__loading=0;k.addItems(b)}function n(){k.end()}var k=this;this.get("container");k.__loading=1;var a=
k.get("load");a&&a(m,n)}var o=r.all,p=i.Env.host;j.ATTRS={diff:{getter:function(m){return m||0}}};i.extend(j,t,{_init:function(){j.superclass._init.apply(this,arguments);this.__onScroll=i.buffer(s,50,this);o(p).on("scroll",this.__onScroll);s.call(this)},end:function(){o(p).detach("scroll",this.__onScroll)},pause:function(){this.__pause=1},resume:function(){this.__pause=0},destroy:function(){j.superclass.destroy.apply(this,arguments);o(p).detach("scroll",this.__onScroll)}});return j},{requires:["node",
"./base"]});KISSY.add("waterfall",function(i,r,t){r.Loader=t;return r},{requires:["waterfall/base","waterfall/loader"]});
