/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: May 2 10:13
*/
KISSY.add("waterfall/base",function(g,o,r){function e(){e.superclass.constructor.apply(this,arguments);this._init()}function p(a,c,b,f){var j=[].concat(g.makeArray(a)),h={},e;0<j.length?e=setTimeout(function(){var h=+new Date;do{var l=j.shift();c.call(b,l)}while(0<j.length&&50>+new Date-h);0<j.length?e=setTimeout(arguments.callee,25):f&&f.call(b,a)},25):f&&g.later(f,0,!1,b,[a]);h.stop=function(){e&&(clearTimeout(e),j=[],a.each(function(a){a.stop()}))};return h}function t(){var a=this._containerRegion;
a&&this.get("container").width()===a.width||this.adjust()}function n(){var a=this.get("container").width(),c=this.get("curColHeights");c.length=Math.max(parseInt(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};g.each(c,function(a,f){c[f]=0});this.set("colItems",[])}function k(a,c,b,f){for(var j=a.get("effect"),b=m(b),h=a.get("curColHeights"),e=a.get("container"),s=h.length,l=0,g=a._containerRegion,i=Number.MAX_VALUE,d=0;d<s;d++)h[d]<i&&(i=h[d],l=d);s||(i=0);s=Math.max(g.width-
s*a.get("colWidth"),0)/2;i={left:l*a.get("colWidth")+s,top:i};c?(b.css(i),j&&j.effect&&b.css("visibility","hidden"),e.append(b),f&&f()):(c=a.get("adjustEffect"))?b.animate(i,c.duration,c.easing,f):(b.css(i),f&&f());h[l]+=b.outerHeight(!0);a=a.get("colItems");a[l]=a[l]||[];a[l].push(b);b.attr("data-waterfall-col",l);return b}function q(a){var a=k(this,!0,a),c=this.get("effect");c&&c.effect&&(a.hide(),a.css("visibility",""),a[c.effect](c.duration,0,c.easing))}var m=o.all,d=g.Env.host;e.ATTRS={container:{setter:function(a){return m(a)}},
curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},colItems:{value:[]},adjustEffect:{}};g.extend(e,r,{isAdjusting:function(){return!!this._adjuster},_init:function(){t.call(this);this.__onResize=g.buffer(t,50,this);m(d).on("resize",this.__onResize)},adjustItem:function(a,c){function b(){m--;0>=m&&(f._adjuster=0,c&&c.callback&&c.callback.call(f))}var f=this;if(!f.isAdjusting()){var j=a.outerHeight(!0),h;c.process&&(h=c.process.call(f));void 0===h&&
(h=a.outerHeight(!0));var e=h-j,d=f.get("curColHeights"),g=parseInt(a.attr("data-waterfall-col")),q=f.get("colItems")[g],j=[];h=Math.max.apply(Math,d);for(var i=0;i<q.length&&q[i][0]!==a[0];i++);for(i++;i<q.length;)j.push(q[i]),i++;d[g]+=e;d=Math.max.apply(Math,d);d!=h&&f.get("container").height(d);var k=c.effect,m=j.length;void 0===k&&(k=f.get("adjustEffect"));return!m?b():f._adjuster=p(j,function(a){k?a.animate({top:parseInt(a.css("top"))+e},k.duration,k.easing,b):(a.css("top",parseInt(a.css("top"))+
e),b())})}},removeItem:function(a,c){var c=c||{},b=this,f=c.callback;b.adjustItem(a,g.mix(c,{process:function(){a.remove();return 0},callback:function(){for(var c=parseInt(a.attr("data-waterfall-col")),c=b.get("colItems")[c],d=0;d<c.length;d++)if(c[d][0]==a[0]){c.splice(d,1);break}f&&f()}}))},adjust:function(a){function c(){e--;0>=e&&(b.get("container").height(Math.max.apply(Math,b.get("curColHeights"))),b._adjuster=0,a&&a.call(b),d.length&&b.fire("adjustComplete",{items:d}))}var b=this,d=b.get("container").all(".ks-waterfall");
b.isAdjusting()&&(b._adjuster.stop(),b._adjuster=0);n.call(b);var e=d.length;return!e?c():b._adjuster=p(d,function(a){k(b,false,a,c)})},addItems:function(a,c){var b=this;b._adder=p(a,q,b,function(){b.get("container").height(Math.max.apply(Math,b.get("curColHeights")));b._adder=0;c&&c.call(b);a.length&&b.fire("addComplete",{items:a})});return b._adder},destroy:function(){m(d).detach("resize",this.__onResize)}});return e},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(g,o,r){function e(){e.superclass.constructor.apply(this,arguments)}function p(){if(!this.__pause&&!this.__loading)if(this.isAdjusting())this.__onScroll();else{var e=this.get("container").offset().top,g=this.get("diff"),d=this.get("curColHeights");d.length&&(e+=Math.min.apply(Math,d));g+n(k).scrollTop()+n(k).height()>e&&t.call(this)}}function t(){function e(a){d.__loading=0;d.addItems(a)}function g(){d.end()}var d=this;this.get("container");d.__loading=1;var a=
d.get("load");a&&a(e,g)}var n=o.all,k=g.Env.host;e.ATTRS={diff:{getter:function(e){return e||0}}};g.extend(e,r,{_init:function(){e.superclass._init.apply(this,arguments);this.__onScroll=g.buffer(p,50,this);n(k).on("scroll",this.__onScroll);p.call(this)},end:function(){n(k).detach("scroll",this.__onScroll)},pause:function(){this.__pause=1},resume:function(){this.__pause=0},destroy:function(){e.superclass.destroy.apply(this,arguments);n(k).detach("scroll",this.__onScroll)}});return e},{requires:["node",
"./base"]});KISSY.add("waterfall",function(g,o,r){o.Loader=r;return o},{requires:["waterfall/base","waterfall/loader"]});
