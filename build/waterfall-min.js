/*
Copyright 2012, KISSY UI Library v1.30dev
MIT Licensed
build time: Feb 13 14:41
*/
KISSY.add("waterfall/base",function(k,p,s){function j(){j.superclass.constructor.apply(this,arguments);this._init()}function q(a,b,c,e){var d=[].concat(k.makeArray(a)),f={},g;if(d.length>0)g=setTimeout(function(){var l=+new Date;do{var i=d.shift();b.call(c,i)}while(d.length>0&&+new Date-l<50);if(d.length>0)g=setTimeout(arguments.callee,25);else e&&e.call(c,a)},25);else e&&k.later(e,0,false,c,[a]);f.stop=function(){if(g){clearTimeout(g);d=[]}};return f}function t(){var a=this._containerRegion;a&&this.get("container").width()===
a.width||this.adjust()}function n(){var a=this.get("container").width(),b=this.get("curColHeights");b.length=Math.max(parseInt(a/this.get("colWidth")),this.get("minColCount"));this._containerRegion={width:a};k.each(b,function(c,e){b[e]=0});this.set("colItems",[])}function m(a){var b=this.get("effect");a=h(a);for(var c=this.get("curColHeights"),e=this.get("container"),d=c.length,f=0,g=this._containerRegion,l=Number.MAX_VALUE,i=0;i<d;i++)if(c[i]<l){l=c[i];f=i}d||(l=0);d=Math.max(g.width-d*this.get("colWidth"),
0)/2;a.css({left:f*this.get("colWidth")+d,top:l});if(!e.contains(a)){b&&b.effect=="fadeIn"&&a.css("opacity",0);e.append(a)}c[f]+=a.outerHeight(true);b=this.get("colItems");b[f]=b[f]||[];b[f].push(a);a.attr("data-waterfall-col",f);return a}function r(a){this.get("curColHeights");this.get("container");var b=m.call(this,a);a=this.get("effect");!a.effect||a.effect!=="fadeIn"||b.animate({opacity:1},{duration:a.duration,easing:a.easing,complete:function(){b.css("opacity","")}})}var h=p.all;j.ATTRS={container:{setter:function(a){return h(a)}},
curColHeights:{value:[]},minColCount:{value:1},effect:{value:{effect:"fadeIn",duration:1}},colWidth:{},colItems:{value:[]}};k.extend(j,s,{isAdjusting:function(){return!!this._adjuster},_init:function(){t.call(this);this.__onResize=k.buffer(t,50,this);h(window).on("resize",this.__onResize)},adjustItem:function(a,b){var c=this;if(!c.isAdjusting()){var e=a.outerHeight(true),d=false;if(b.process)d=b.process.call(c);var f=(d?0:a.outerHeight(true))-e,g=c.get("curColHeights"),l=parseInt(a.attr("data-waterfall-col")),
i=c.get("colItems")[l];e=[];d=Math.max.apply(Math,g);for(var o=0;o<i.length;o++)if(i[o][0]===a[0])break;for(o++;o<i.length;){e.push(i[o]);o++}g[l]+=f;g=Math.max.apply(Math,g);g!=d&&c.get("container").height(g);return c._adjuster=q(e,function(u){u.css("top",parseInt(u.css("top"))+f)},null,function(){c._adjuster=0;b&&b.callback&&b.callback.call(c)})}},removeItem:function(a,b){var c=this;c.adjustItem(a,{process:function(){a.remove();return true},callback:function(){var e=parseInt(a.attr("data-waterfall-col"));
e=c.get("colItems")[e];for(var d=0;d<e.length;d++)if(e[d][0]==a[0]){e.splice(d,1);break}b&&b.callback&&b.callback.call(c)}})},adjust:function(a){var b=this,c=b.get("container").all(".ks-waterfall");b.isAdjusting()&&b._adjuster.stop();n.call(b);return b._adjuster=q(c,r,b,function(){b.get("container").height(Math.max.apply(Math,b.get("curColHeights")));b._adjuster=0;a&&a.call(b);c.length&&b.fire("adjustComplete",{items:c})})},addItems:function(a,b){var c=this;c._adder=q(a,r,c,function(){c.get("container").height(Math.max.apply(Math,
c.get("curColHeights")));c._adder=0;b&&b.call(c);a.length&&c.fire("addComplete",{items:a})});return c._adder},destroy:function(){h(window).detach("resize",this.__onResize)}});return j},{requires:["node","base"]});
KISSY.add("waterfall/loader",function(k,p,s){function j(){j.superclass.constructor.apply(this,arguments)}function q(){if(!this.__pause)if(!this.__loading)if(this.isAdjusting())this.__onScroll();else{var m=this.get("container").offset().top,r=this.get("diff"),h=this.get("curColHeights");if(h.length)m+=Math.min.apply(Math,h);r+n(window).scrollTop()+n(window).height()>m&&t.call(this)}}function t(){function m(b){h.__loading=0;h.addItems(b)}function r(){h.end()}var h=this;this.get("container");h.__loading=
1;var a=h.get("load");a&&a(m,r)}var n=p.all;j.ATTRS={diff:{getter:function(m){return m||0}}};k.extend(j,s,{_init:function(){j.superclass._init.apply(this,arguments);this.__onScroll=k.buffer(q,50,this);n(window).on("scroll",this.__onScroll);q.call(this)},end:function(){n(window).detach("scroll",this.__onScroll)},pause:function(){this.__pause=1},resume:function(){this.__pause=0},destroy:function(){j.superclass.destroy.apply(this,arguments);n(window).detach("scroll",this.__onScroll)}});return j},{requires:["node",
"./base"]});KISSY.add("waterfall",function(k,p,s){p.Loader=s;return p},{requires:["waterfall/base","waterfall/loader"]});
